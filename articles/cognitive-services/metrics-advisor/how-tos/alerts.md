---
title: Metrics Advisor アラートを構成する
titleSuffix: Azure Cognitive Services
description: 電子メール、Web、Azure DevOps のフックを使用して Metrics Advisor アラートを構成する方法。
services: cognitive-services
author: mrbullwinkle
manager: nitinme
ms.service: cognitive-services
ms.subservice: metrics-advisor
ms.topic: conceptual
ms.date: 09/14/2020
ms.author: mbullwin
ms.openlocfilehash: 30d8fdf99da7a4854db0985bed6256ecd6f7a366
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/30/2021
ms.locfileid: "93420922"
---
# <a name="how-to-configure-alerts-and-get-notifications-using-a-hook"></a>方法: フックを使用してアラートを構成し、通知を取得する

Metrics Advisor によって異常が検出されると、フックを使用し、アラート設定に基づいてアラート通知がトリガーされます。 アラート設定は、複数の検出構成で使用でき、さまざまなパラメーターを使用して警告ルールをカスタマイズできます。

## <a name="create-a-hook"></a>フックを作成する

Metrics Advisor では、3 つの異なる種類のフック (email hook、Web hook、Azure DevOps) がサポートされており、 特定のシナリオに適したものを選択できます。       

### <a name="email-hook"></a>email hook

> [!Note]
> Metrics Advisor リソース管理者は、異常アラートを送信する前に、電子メールの設定を構成し、SMTP 関連の情報を Metrics Advisor に入力する必要があります。 リソース グループ管理者またはサブスクリプション管理者は、Metrics Advisor リソースの [アクセス制御] タブで、少なくとも 1 つの "*Cognitive Services Metrics Advisor 管理者*" ロールを割り当てる必要があります。 [電子メール設定の構成の詳細をご確認ください](../faq.md#how-to-set-up-email-settings-and-enable-alerting-by-email)。

email hook を作成するには、次のパラメーターを使用できます。 

email hook は、 **[メールの送信先]** セクションで指定された電子メール アドレスに送信される異常アラートのチャネルです。 2 種類のアラート電子メール ("*データ フィードを使用できません*" アラートと、1 つまたは複数の異常を含む "*インシデント レポート*") が送信されます。 

|パラメーター |説明  |
|---------|---------|
| 名前 | email hook の名前 |
| 電子メールの送信先| アラートの送信先の電子メール アドレス|
| 外部リンク | オプションのフィールド。トラブルシューティングに関する説明など、カスタマイズされたリダイレクトを有効にします。 |
| カスタマイズされた異常アラートのタイトル | タイトル テンプレートでは、`${severity}`、`${alertSettingName}`、`${datafeedName}`、`${metricName}`、`${detectConfigName}`、`${timestamp}`、`${topDimension}`、`${incidentCount}`、`${anomalyCount}` がサポートされています

**[OK]** をクリックすると、email hook が作成されます。 これを任意のアラート設定で使用すると、異常アラートを受け取ることができます。 

### <a name="web-hook"></a>Web hook

> [!Note]
> * **POST** 要求メソッドを使用します。
> * 要求本文は、次のようになります。  
    `{"timestamp":"2019-09-11T00:00:00Z","alertSettingGuid":"49635104-1234-4c1c-b94a-744fc920a9eb"}`
> * Web hook を作成または変更する場合、空の要求本文を使用して、テストとして API を呼び出します。 この API は、200 HTTP コードを返す必要があります。

Web hook は、Metrics Advisor サービスから使用できるすべての情報のエントリ ポイントであり、アラートがトリガーされたときにユーザー指定の API を呼び出します。 Web hook を介してすべてのアラートを送信できます。

Web hook を作成するには、次の情報を追加する必要があります。

|パラメーター |説明  |
|---------|---------|
|エンドポイント     | アラートがトリガーされたときに呼び出される API アドレス。        |
|ユーザー名/パスワード | API アドレスの認証用。 認証が不要な場合は、これを空白のままにします。         |
|ヘッダー     | API 呼び出しのカスタム ヘッダー。        |

:::image type="content" source="../media/alerts/create-web-hook.png" alt-text="Web hook の作成ウィンドウ。":::

Web hook を介して通知をプッシュする場合、次の API を使用してアラートの詳細を取得できます。 プッシュ先の API サービスで、*timestamp* と *alertSettingGuid* を設定し、次のクエリを使用します。 
- `query_alert_result_anomalies`
- `query_alert_result_incidents`

### <a name="azure-devops"></a>Azure DevOps

Metrics Advisor では、異常が検出されたときに問題またはバグを追跡するために、Azure DevOps で作業項目を自動的に作成することもできます。 Azure DevOps hook を介してすべてのアラートを送信できます。

Azure DevOps hook を作成するには、次の情報を追加する必要があります

|パラメーター |説明  |
|---------|---------|
| 名前 | フックの名前 |
| 組織 | DevOps が属している組織 |
| Project | DevOps 内の特定のプロジェクト。 |
| Access Token |  DevOps の認証用トークン。 | 

> [!Note]
> Metrics Advisor で異常アラートに基づいて作業項目を作成する場合は、書き込みアクセス許可を付与する必要があります。 フックを作成した後、それらを任意のアラート設定で使用できます。 フックは、 **[hook settings]\(フックの設定\)** ページで管理します。

## <a name="add-or-edit-alert-settings"></a>アラート設定の追加または編集

メトリックの詳細ページに移動して、メトリックの詳細ページの左下隅にある **[アラート設定]** セクションを見つけます。 ここには、選択した検出構成に適用されるすべてのアラート設定が一覧表示されます。 新しい検出構成を作成した時点では、アラート設定はなく、アラートは送信されません。  
アラート設定を変更するには、 **[追加]** 、 **[編集]** 、 **[削除]** アイコンを使用します。

:::image type="content" source="../media/alerts/alert-setting.png" alt-text="[アラートの設定] メニュー項目。":::

**[追加]** または **[編集]** ボタンをクリックして、アラート設定を追加または編集するウィンドウを表示します。

:::image type="content" source="../media/alerts/edit-alert.png" alt-text="アラート設定の追加または編集":::

**アラート設定名**: このアラート設定の名前。 これは、アラート電子メールのタイトルに表示されます。

**フック**: アラートの送信先となるフックの一覧。

上記のスクリーンショットでマークされているセクションは、1 つの検出構成の設定です。 さまざまな検出構成に対してさまざまなアラート設定を設定できます。 このウィンドウの 3 番目のドロップダウン リストを使用して、ターゲット構成を選択します。 

### <a name="filter-settings"></a>フィルターの設定 

1 つの検出構成のフィルター設定を次に示します。

**[アラート対象]** には、異常をフィルター処理するための 4 つのオプションがあります。

* **すべての系列の異常**: すべての異常がアラートに含まれます。         
* **系列グループの異常**: 系列をディメンション値でフィルター処理します。 いくつかのディメンションに特定の値を設定します。 系列が指定された値と一致する場合のみ、異常がアラートに含まれます。       
* **お気に入りの系列の異常**: お気に入りとしてマークされた系列のみがアラートに含まれます。        |
* **すべての系列の上位 N 個の異常**: このフィルターは、値が上位 N 個に含まれている系列のみに関心がある場合に使用します。いくつかのタイムスタンプを調べて、これらのタイムスタンプの系列の値が上位 N 個に含まれているかどうかを確認します。"上位 n" のカウントが指定された数より大きい場合、異常はアラートに含まれます。        |

**[Filter anomaly options]\(異常のフィルター処理オプション\)** は追加のフィルターで、次のオプションがあります。

- **[重大度]** : 異常の重大度が指定された範囲内にある場合のみ、異常が含まれます。
- **[再通知]** : アラートでトリガーされたときに、次の N 個のポイント (期間) 内の異常に対してアラートを一時的に停止します。
    - **再通知の種類**: **[系列]** に設定すると、トリガーされた異常によって、その系列のみが再通知されます。 **[メトリック]** の場合、1 つのトリガーされた異常によって、このメトリック内のすべての系列が再通知されます。
    - **再通知回数**: 再通知するポイント (期間) の数。
    - **連続しない場合にリセット**: 選択した場合、トリガーされた異常によって、次の n 個の連続した異常のみが再通知されます。 次のデータ ポイントのいずれかが異常でない場合、そのポイントから再通知がリセットされます。選択しない場合、連続するデータ ポイントが異常ではない場合でも、1 つのトリガーされた異常によって、次の n 個のポイント (期間) が再通知されます。
- **値** (省略可能): 値でフィルター処理します。 条件を満たすポイント値のみ、異常が含まれます。 別のメトリックの対応する値を使用する場合、2 つのメトリックのディメンション名が一致している必要があります。

フィルターで除外されなかった異常は、アラートで送信されます。

### <a name="add-cross-metric-settings"></a>クロスメトリック設定を追加する

[アラート設定] ページで **[+ Add cross-metric settings]\(+ クロスメトリック設定の追加\)** をクリックして、別のセクションを追加します。

**[演算子]** セレクターは、各セクションの論理的な関係で、アラートを送信するかどうかを決定します。


|演算子  |説明  |
|---------|---------|
|AND     | 系列が各アラート セクションと一致し、すべてのデータ ポイントが異常である場合にのみアラートを送信します。 メトリックのディメンション名が異なる場合、アラートはトリガーされません。         |
|OR     | 1 つ以上のセクションに異常がある場合にアラートを送信します。         |

:::image type="content" source="../media/alerts/alert-setting-operator.png" alt-text="複数のアラート設定セクションの演算子":::

## <a name="next-steps"></a>次のステップ

- [フィードバックを使用して異常検出を調整する](anomaly-feedback.md)
- [インシデントを診断する](diagnose-incident.md)
- [メトリックを構成して検出構成を微調整する](configure-metrics.md)