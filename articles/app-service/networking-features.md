---
title: ネットワーク デプロイ機能 - Azure App Service | Microsoft Docs
description: App Service の各種ネットワーク機能の使用方法
author: ccompy
manager: stefsch
editor: ''
services: app-service\web
documentationcenter: ''
ms.assetid: 5c61eed1-1ad1-4191-9f71-906d610ee5b7
ms.service: app-service-web
ms.workload: web
ms.tgt_pltfrm: na
ms.devlang: multiple
ms.topic: article
ms.date: 05/28/2019
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: db29d0761084e32d601dc9c6d94082cd09bc5d18
ms.sourcegitcommit: cf438e4b4e351b64fd0320bf17cc02489e61406a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/08/2019
ms.locfileid: "67655461"
---
# <a name="app-service-networking-features"></a>App Service のネットワーク機能

Azure App Service のアプリケーションは、複数の方法でデプロイできます。 既定では、App Service でホストされているアプリはインターネットから直接アクセス可能になっており、到達先はインターネット上でホストされているエンドポイントに限定されています。 しかし、多くのお客様のアプリケーションでは、送受信のネットワーク トラフィックを制御する必要があります。 このようなニーズに応えるため、App Service にはさまざまな機能が用意されています。 ここで課題となるのは、特定の問題を解決するにあたってどの機能を使用すればよいか把握することです。 このドキュメントでは、いくつかのサンプル ユース ケースに基づいて、お客様が使用すべき機能を判断できるよう説明していきます。

Azure App Service のデプロイの種類は、主に 2 つあります。 1 つはマルチテナント パブリック サービスであり、Free、Shared、Basic、Standard、Premium、および PremiumV2 の各価格レベルの App Service プランがホストされます。 もう 1 つはシングル テナント型の App Service Environment (ASE) であり、Isolated 価格レベルの App Service プランが Azure Virtual Network (VNet) 内で直接ホストされます。 使用する機能は、ご利用の環境がマルチテナント サービスと ASE のどちらであるかによって異なります。 

## <a name="multi-tenant-app-service-networking-features"></a>マルチテナント型 App Service のネットワーク機能 

Azure App Service は分散システムです。 受信した HTTP/HTTPS 要求を処理するロールは、フロントエンドと呼ばれます。 お客様のワークロードをホストするロールは、worker と呼ばれます。 App Service デプロイのロールはすべて、マルチテナント ネットワーク内に存在します。 同じ App Service スケール ユニット内に異なるユーザーが多数存在しているので、App Service ネットワークを、お使いのネットワークに直接接続することはできません。 ネットワークを接続する代わりに、アプリケーション通信のさまざまな側面を処理する機能が必要になります。 アプリに対する要求を処理する機能を、アプリから呼び出しを実行する際の問題解決に使用することはできません。 同様に、アプリからの呼び出しの問題を解決する機能は、アプリに対する呼び出しの問題解決には使用できません。  

| 受信時の機能 | 送信時の機能 |
|---------------------|-------------------|
| アプリに割り当てられたアドレス | ハイブリッド接続と |
| アクセス制限 | ゲートウェイが必要な VNet 統合 |
| サービス エンドポイント | VNet 統合 (プレビュー) |

特に記載のない限り、これらの機能はすべて併用可能です。 機能を組み合わせることで、さまざまな問題を解決できます。

## <a name="use-case-and-features"></a>ユース ケースと機能

どのようなユース ケースでも、問題解決の手段はいくつか存在します。  時として、使用に適した機能はユース ケース以外の理由から決まるものです。 以下の受信のユース ケースでは、App Service のネットワーク機能を使用して、アプリで受信するトラフィックの制御についての問題を解決する方法の案を示します。 
 
| 受信のユース ケース | 機能 |
|---------------------|-------------------|
| アプリの IP ベース SSL のニーズをサポートする | アプリに割り当てられたアドレス |
| アプリ専用の非共有受信アドレス | アプリに割り当てられたアドレス |
| アプリへのアクセスを明確に定義された一連のアドレスからのみに制限する | アクセス制限 |
| アプリを VNet 内の複数のプライベート IP で公開する | ILB ASE </br> Application Gateway とサービス エンドポイントの併用 |
| アプリへのアクセスを VNet 内のリソースからのみに制限する | サービス エンドポイント </br> ILB ASE |
| アプリを VNet 内の 1 つのプライベート IP で公開する | ILB ASE </br> Application Gateway 上の受信用プライベート IP とサービス エンドポイントの併用 |
| WAF によりアプリを保護する | Application Gateway + ILB ASE </br> Application Gateway とサービス エンドポイントの併用 </br> Azure Front Door とアクセス制限の併用 |
| アプリへのトラフィックの負荷を複数のリージョンに分散させる | Azure Front Door とアクセス制限の併用 | 
| 同一リージョン内でトラフィックの負荷を分散させる | Application Gateway とサービス エンドポイントの併用 | 

以下の送信のユース ケースでは、App Service のネットワーク機能を使用して、アプリの送信アクセスに関するニーズを解決する方法の案を示します。 

| 送信のユース ケース | 機能 |
|---------------------|-------------------|
| 同一リージョン内にある Azure Virtual Network のリソースにアクセスする | VNet 統合 </br> ASE |
| 異なるリージョン内にある Azure Virtual Network のリソースにアクセスする | ゲートウェイが必要な VNet 統合 </br> ASE と VNet ピアリング |
| サービス エンドポイントによって保護されているリソースにアクセスする | VNet 統合 </br> ASE |
| Azure に接続されていないプライベート ネットワーク内にあるリソースにアクセスする | ハイブリッド接続と |
| 複数の ExpressRoute 回線を越えてリソースにアクセスする | VNet 統合 (現時点では RFC 1918 アドレスのみに制限) </br> ASE | 


### <a name="default-networking-behavior"></a>既定のネットワークの動作

Azure App Service スケール ユニットでは、デプロイごとに多数のお客様をサポートしています。 Free と Shared の各価格レベルのプランでは、お客様のワークロードはマルチテナント worker 上でホストされます。 Basic 以上のプランでは、1 つの App Service プラン (ASP) 専用となるお客様のワークロードがホストされます。 たとえば、App Service プランが Standard の場合、このプラン内のアプリはすべて同一の worker 上で実行されます。 worker をスケールアウトした場合、その ASP 内にあるアプリはすべて、お使いの ASP 内にある各インスタンスの新規 worker 上にレプリケートされます。 PremiumV2 で使用される worker は、他のプラン用の worker とは異なります。 App Service デプロイごとに、その App Service デプロイ内のアプリに対するすべての受信トラフィックに使用される IP アドレスが 1 つ設定されます。 一方、送信呼び出しの実行には、4 から 11 個程度のアドレスが使用されます。 これらのアドレスは、該当する App Service デプロイ内にあるすべてのアプリで共有されます。 送信アドレスは、worker のタイプによって異なります。 つまり、Free、Shared、Basic、Standard、および Premium の各 ASP で使用されるアドレスは、PremiumV2 ASP からの送信呼び出しに使用されるアドレスとは異なるということです。 アプリで使用されている受信アドレスと送信アドレスは、そのアプリのプロパティで確認できます。 IP ACL との依存関係をロックダウンする必要がある場合は、possibleOutboundAddresses を使用してください。 

![アプリのプロパティ](media/networking-features/app-properties.png)

App Service には、サービスの管理に使用されるエンドポイントがいくつも存在します。  これらのアドレスは別のドキュメントで公開されており、AppServiceManagement IP サービス タグにも表示されています。 AppServiceManagement タグは、こうしたトラフィックを許可する必要がある App Service Environment (ASE) でのみ使用されます。 App Service の受信アドレスは、AppService IP サービス タグで追跡されます。 App Service によって使用される送信アドレスが含まれる IP サービス タグはありません。 

![App Service の送受信図](media/networking-features/default-behavior.png)

### <a name="app-assigned-address"></a>アプリに割り当てられたアドレス 

"アプリに割り当てられたアドレス" 機能は、IP ベースの SSL 機能の副産物であり、アプリに SSL を設定することでアクセスします。 この機能を使用すると、IP ベースの SSL 呼び出しを行えるだけでなく、アプリに対して、そのアプリ専用のアドレスを付与することもできます。 

![アプリに割り当てられたアドレスの図](media/networking-features/app-assigned-address.png)

アプリに割り当てられたアドレスを使用する場合でも、トラフィックは引き続き、App Service スケールユニットに対するすべての受信トラフィックを処理するフロントエンド ロールを通過します。 ただし、アプリに割り当てられたアドレスは、そのアプリのみが使用します。 この機能のユース ケースは次のとおりです。

* アプリの IP ベース SSL のニーズをサポートする
* 他と共有されない専用アドレスをアプリに設定する

アプリにアドレスを設定する方法については、[IP ベースの SSL の構成][appassignedaddress]に関するチュートリアルを参照してください。 

### <a name="access-restrictions"></a>アクセス制限 

アクセス制限機能を使用すると、送信元の IP アドレスに基づいて**受信**要求をフィルター処理できます。 このフィルター処理は、アプリが実行される worker ロールよりも上流にある、フロントエンド ロールで行われます。 フロントエンド ロールが worker よりも上流に存在することから、アクセス制限機能は、ネットワーク レベルでのアプリの保護機能と言えます。 この機能では、優先度順に評価されるアドレス ブロックの許可リストと拒否リストを作成できます。 これは、Azure のネットワークにあるネットワーク セキュリティ グループ (NSG) 機能と似ています。  この機能は、ASE とマルチテナント サービスのどちらでも使用できます。 ILB ASE で使用する場合は、プライベート アドレス ブロックからのアクセスを制限できます。

![アクセス制限](media/networking-features/access-restrictions.png)

アクセス制限機能は、アプリへの到達のために使用可能な IP アドレスを制限する必要があるシナリオで役立ちます。 この機能の主なユース ケースは次のとおりです。

* アプリへのアクセスを明確に定義された一連のアドレスからのみに制限する 
* 負荷分散サービス (Azure Front Door など) 経由の受信アクセスを制限する。 たとえば、Azure Front Door への受信トラフィックをロックダウンするには、147.243.0.0/16 と 2a01:111:2050::/44 からのトラフィックを許可するルールを作成します。 

![アクセス制限と Front Door の併用](media/networking-features/access-restrictions-afd.png)

Azure Virtual Network (VNet) 内のリソースからのみアプリに到達できるよう、アプリに対するアクセスをロックダウンする場合は、VNet 内のソースによらず、静的パブリック アドレスが必要になります。 リソースにパブリック アドレスが設定されていない場合は、代わりにサービス エンドポイント機能を使用してください。 この機能を有効化する方法については、[アクセス制限の構成][iprestrictions]に関するチュートリアルを参照してください。

### <a name="service-endpoints"></a>サービス エンドポイント

サービス エンドポイントを使用すると、アプリに対する**受信**アクセスについて、送信元アドレスが選択したサブネット セットからのものであるアクセスのみに限定できます。 この機能は、IP アクセス制限と連携して動作します。 サービス エンドポイントを設定する場合のユーザー エクスペリエンスは、IP アクセス制限の場合と同じです。 パブリック アドレスおよび VNet 内のサブネットを指定して、許可と拒否のアクセス ルール リストを作成できます。 この機能は、次のようなシナリオをサポートしています。

![service endpoints](media/networking-features/service-endpoints.png)

* アプリに Application Gateway を設定して、アプリに対する受信トラフィックをロックダウンする
* アプリに対するアクセスを VNet 内のリソースのもののみに制限する。 この対象には、VM や ASE のほか、VNet 統合を使用するアプリも含めることができます。 

![サービス エンドポイントと Application Gateway の併用](media/networking-features/service-endpoints-appgw.png)

アプリでのサービス エンドポイントの構成方法については、[サービス エンドポイントとアクセス制限の構成方法][serviceendpoints]に関するチュートリアルを参照してください。
 
### <a name="hybrid-connections"></a>ハイブリッド接続と

App Service のハイブリッド接続を使用すると、指定した TCP エンドポイントに対してアプリから**送信**呼び出しを行うことができます。 エンドポイントには、オンプレミス、VNet 内、またはポート 443 で Azure への送信トラフィックを許可する任意の環境内にあるものを指定できます。 この機能を使用するには、ハイブリッド接続マネージャー (HCM) というリレー エージェントを、Windows Server 2012 以降のホストにインストールする必要があります。 HCM は、ポート 443 で Azure Relay に到達できる必要があります。 HCM は、ポータルにある App Service ハイブリッド接続の UI からダウンロードできます。 

![ハイブリッド接続のネットワーク フロー](media/networking-features/hybrid-connections.png)

App Service のハイブリッド接続機能は、Azure Relay のハイブリッド接続機能を基に構築されています。 App Service では、アプリからの TCP ホストとポートへの送信呼び出しのみをサポートするようにこの機能を特殊化して使用しています。 こうしたホストとポートは、HCM がインストールされているホスト上でのみ解決を行えば済みます。 App Service 内にあるアプリから、ハイブリッド接続で定義されているホストとポートに対して DNS 参照を実施した場合、トラフィックは自動的にリダイレクトされ、ハイブリッド接続を経由してハイブリッド接続マネージャーから送信されます。 ハイブリッド接続の詳細については、[App Service のハイブリッド接続][hybridconn]に関するドキュメントを参照してください。

この機能の一般的な使用例は次のとおりです。

* Azure に VPN または ExpressRoute で接続されていないプライベート ネットワーク内のリソースにアクセスする
* サポート データベースを移動することなく、App Service へのオンプレミス アプリのリフト アンド シフトをサポートする  
* ハイブリッド接続ごとに単一のホストとポートへのアクセスを安全に提供する。 たいていのネットワーク機能ではネットワークへのアクセスが開放されていますが、ハイブリッド接続を使用すれば、到達可能なホストとポートを 1 つに制限できます。
* 他の送信接続方法が対応していないシナリオに対応する
* オンプレミスのリソースをアプリで容易に活用できる App Service 内においてデプロイを実行する 

この機能を使用すると、受信ファイアウォールに穴を開けることなくオンプレミス リソースにアクセスできるため、開発者から高い人気を得ています。 App Service の他の送信ネットワーク機能は、Azure Virtual Networking とのつながりが非常に強くなっています。 ハイブリッド接続には VNet 経由という依存性がないため、より幅広いネットワークのニーズ向けに使用できます。 ただし、App Service のハイブリッド接続機能では、この接続上での操作は把握されないことに注意してください。 つまり、この接続は、メインフレーム上にあるデータベースや Web サービス、任意の TCP ソケットへのアクセスに使用できるということです。 本質的には、この機能は TCP パケットをトンネリングするものです。 

ハイブリッド接続は、開発でよく利用されているだけでなく、非常に多くの運用アプリケーションでも使用されています。 Web サービスやデータベースへのアクセスには適していますが、非常に多くの接続を作成するような状況には向いていません。 

### <a name="gateway-required-vnet-integration"></a>ゲートウェイが必要な VNet 統合 

App Service の "ゲートウェイが必要な VNet 統合" 機能を使用すると、アプリから Azure 仮想ネットワーク内に対して**送信**要求を実行できます。 この機能では、アプリが実行されているホストと VNet 上にある Virtual Network ゲートウェイが、ポイント対サイト VPN により接続されます。 この機能を構成すると、アプリには、各インスタンスに割り当てられているポイント対サイト アドレスのいずれかが付与されます。 この機能では、リージョンを問わず、クラシック VNet と Resource Manager VNet の双方でリソースにアクセスできます。 

![ゲートウェイが必要な VNet 統合](media/networking-features/gw-vnet-integration.png)

この機能は、他の VNet 内にあるリソースへのアクセスに関する問題を解決するものですが、VNet 経由で他の VNet やオンプレミスに接続する際にも使用できます。 ExpressRoute で接続されている VNet には対応していませんが、サイト間 VPN で接続されているネットワークには使用できます。 App Service Environment (ASE) はもとから VNet 内に存在しているので、一般には、この機能を ASE 内のアプリで使用するのは適切ではありません。 この機能により解決できるユース ケースは次のとおりです。

* Azure 仮想ネットワーク内のプライベート IP 上にあるリソースにアクセスする 
* サイト間 VPN がある場合にオンプレミスのリソースにアクセスする 
* ピアリングされた VNet 内にあるリソースにアクセスする 

この機能が有効な場合、アプリでは、接続先の VNet で構成されている DNS サーバーが使用されます。 この機能の詳細については、[App Service の VNet 統合][vnetintegrationp2s]に関するドキュメントを参照してください。 

### <a name="vnet-integration"></a>VNet 統合

ゲートウェイが必要な VNet 統合機能は非常に有用ですが、この機能でも、ExpressRoute を越えてリソースにアクセスするという課題は解決できません。 ExpressRoute 接続を越えて到達しなければならないことに加え、サービス エンドポイントで保護されたサービスに対して、アプリから呼び出しを実行できる必要もあります。 これら両方のニーズを解決するため、別の VNet 統合機能が追加されました。 この新しい VNet 統合機能では、アプリのバックエンドを、同じリージョン内にある Resource Manager VNet のサブネットに配置できます。 この機能は、もともと VNet 内に存在する App Service Environment からは利用できません。 この機能により以下が可能になります。

* 同じリージョンにある Resource Manager VNet 内のリソースにアクセスする
* サービス エンドポイントで保護されているリソースにアクセスする 
* ExpressRoute または VPN 接続越しにアクセス可能なリソースにアクセスする

![VNet 統合](media/networking-features/vnet-integration.png)

この機能はプレビュー段階です。運用環境のワークロードには使用しないでください。 この機能の詳細については、[App Service の VNet 統合][vnetintegration]に関するドキュメントを参照してください。

## <a name="app-service-environment"></a>App Service 環境 

App Service Environment (ASE) は、VNet 内で実行されるシングル テナント デプロイ版の Azure App Service です。 ASE は、以下のようなユース ケースに対応しています。

* VNet 内にあるリソースにアクセスする
* ExpressRoute を越えてリソースにアクセスする
* VNet 内のプライベート アドレスを使用してアプリを公開する 
* 複数のサービス エンドポイントを越えてリソースにアクセスする 

ASE を使用する場合、この機能は初めから VNet 内に存在しているので、VNet 統合やサービス エンドポイントなどの機能を使用する必要はありません。 サービス エンドポイント越しに SQL や Storage などのリソースにアクセスする必要がある場合は、ASE サブネット上でサービス エンドポイントを有効化してください。 VNet 内にあるリソースにアクセスする場合、追加の構成は必要ありません。  ExpressRoute 越しにリソースにアクセスする場合は、初めから VNet 内にいるため、ASE やこの環境内のアプリについて構成を行う必要はありません。 

ILB ASE 内にあるアプリはプライベート IP アドレスで公開可能なので、WAF デバイスを容易に追加して、他のアプリの安全を保ったまま目的のアプリのみをインターネットに公開することができます。 これにより、多層アプリケーションの開発が容易になります。 

現状では、ASE 内にあるマルチテナント サービスからでは実現できないユース ケースもあります。 こうしたものの例を次に示します。

* プライベート IP アドレスでアプリを公開する
* アプリに搭載されていないネットワーク制御機能を使用して、すべての送信トラフィックを保護する 
* シングル テナント サービスでアプリをホストする 
* マルチテナント サービスで許容される数を超えてインスタンスをスケールアップする 
* プライベート CA で保護されているエンドポイントを使用して、アプリ用にプライベート CA クライアントの証明書を読み込む 
* アプリ レベルでの無効化機能を提供せずに、システムでホストされているアプリすべてに TLS 1.1 を強制的に適用する 
* 顧客と共有していない ASE 内にあるすべてのアプリに対して、専用の送信アドレスを提供する 

![VNet 内の ASE](media/networking-features/app-service-environment.png)

ASE があれば、専用のアプリを隔離したまま最適にホストできますが、管理上の課題が伴います。 運用環境で ASE を使用する前に、以下のことを検討してください。
 
 * ASE は VNet 内で実行されますが、VNet の外部と依存関係を持っています。 こうした依存関係は許容しなければなりません。 「[App Service Environment のネットワークの考慮事項][networkinfo]」を参照してください。
 * ASE には、マルチテナント サービスのような迅速なスケーラビリティはありません。 事後対応的にスケーリングを行うのではなく、スケーリングのニーズを予測する必要があります。 
 * ASE には比較的高い初期費用がかかります。 ASE を最大限に活用するために、少量の作業に ASE を利用するのではなく、多量のワークロードを配置するように計画してください。
 * ASE 内のアプリで、アクセス制限の対象を ASE 内にある一部のアプリとそれ以外のアプリで分けることはできません。
 * ASE はサブネット内にあるので、ASE で送受信するすべてのトラフィックにあらゆるネットワーク規則が適用されます。 1 つのアプリのみに受信トラフィック規則を割り当てる必要がある場合は、アクセス制限を使用してください。 

## <a name="combining-features"></a>各種機能の組み合わせ 

上述のマルチテナント サービス向け機能を組み合わせて使用することで、さらに複雑なユース ケースにも対応できます。 ここでは、最も一般的なユース ケースを 2 つ紹介しますが、これらはあくまでも例に過ぎません。 各種機能の働きを理解すれば、お使いのシステム アーキテクチャのニーズをほぼすべて解決できるでしょう。

### <a name="inject-app-into-a-vnet"></a>VNet 内にアプリを挿入する

頻繁にお問い合わせを頂く事項として、VNet 内へのアプリの配置方法があります。 VNet 内にアプリを配置すると、アプリの受信エンドポイントと送信エンドポイントが VNet 内に存在することになります。 この問題の最適な解決策は ASE ですが、各種機能を組み合わせることで、必要な機能のほとんどをマルチテナント サービス内で揃えることができます。 たとえば、以下のようにすることで、プライベートの受信アドレスと送信アドレスを設定したイントラネット専用アプリケーションをホストできます。

* プライベートの受信アドレスと送信アドレスを指定してアプリケーション ゲートウェイを作成する
* サービス エンドポイントを使用してアプリに対する受信トラフィックを保護する 
* 新しい VNet 統合を使用して、アプリのバックエンドを VNet 内に配置する 

このデプロイ形式では、インターネットへの送信トラフィックに専用アドレスを使用することはできず、またアプリからの送信トラフィックを一切ロック ダウンできません。  このデプロイ形式では、ASE を使用した場合に利用可能な機能のほとんどを利用できます。 

### <a name="create-multi-tier-applications"></a>多層アプリケーションを作成する

多層アプリケーションとは、API バックエンド アプリにアクセスできるのがフロントエンド層のみに制限されているアプリケーションのことです。 多層アプリケーションを作成する方法には、次のものがあります。

* VNet 統合を使用して、フロントエンド Web アプリのバックエンドを VNet 内のサブネットと接続する
* サービス エンドポイントを使用して、API アプリへの受信トラフィックを、フロントエンド Web アプリで使用するサブネットからのトラフィックのみに制限する

![多層アプリ](media/networking-features/multi-tier-app.png)

別個のフロントエンド アプリで VNet 統合を使用し、サブネットで API アプリからサービス エンドポイントを使用することで、複数のフロントエンド アプリで同じ API アプリを使用できます。  

<!--Links-->
[appassignedaddress]: https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-ssl
[iprestrictions]: https://docs.microsoft.com/azure/app-service/app-service-ip-restrictions
[serviceendpoints]: https://docs.microsoft.com/azure/app-service/app-service-ip-restrictions
[hybridconn]: https://docs.microsoft.com/azure/app-service/app-service-hybrid-connections
[vnetintegrationp2s]: https://docs.microsoft.com/azure/app-service/web-sites-integrate-with-vnet
[vnetintegration]: https://docs.microsoft.com/azure/app-service/web-sites-integrate-with-vnet
[networkinfo]: https://docs.microsoft.com/azure/app-service/environment/network-info
