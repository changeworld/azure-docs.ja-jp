<properties 
	pageTitle="SharePoint イントラネット ファーム ワークロードのフェーズ 5: 可用性グループの作成と SharePoint データベースの追加" 
	description="イントラネット専用 SharePoint 2013 ファームと SQL Server AlwaysOn 可用性グループを Azure インフラストラクチャ サービスにデプロイする作業の最終フェーズでは、可用性グループを作成し、SharePoint データベースを追加します。" 
	documentationCenter=""
	services="virtual-machines" 
	authors="JoeDavies-MSFT" 
	manager="timlt" 
	editor=""
	tags="azure-service-management"/>

<tags 
	ms.service="virtual-machines" 
	ms.workload="infrastructure-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="07/21/2015" 
	ms.author="josephd"/>

# SharePoint イントラネット ファーム ワークロードのフェーズ 5: 可用性グループの作成と SharePoint データベースの追加

イントラネット専用 SharePoint 2013 ファームと SQL Server AlwaysOn 可用性グループを Azure インフラストラクチャ サービスにデプロイする作業のこの最終フェーズでは、新しい AlwaysOn 可用性グループを作成し、SharePoint ファームのデータベースを追加します。

全フェーズについては、「[Deploying SharePoint with SQL Server AlwaysOn Availability Groups in Azure (Azure での SharePoint と SQL Server AlwaysOn 可用性グループのデプロイ)](virtual-machines-workload-intranet-sharepoint-overview.md)」をご覧ください。

## 可用性グループの作成とデータベースの追加

SharePoint では、初期構成の一環として複数のデータベースを作成します。次の手順を使用して、これらのデータベースを準備する必要があります。

1.	プライマリ コンピューターで、データベースの完全バックアップとトランザクション ログ バックアップを作成します。
2.	バックアップ コンピューターで、完全バックアップとログ バックアップを復元します。

データベースのバックアップと復元が完了したら、可用性グループに追加できます。SQL Server では、(少なくとも 1 回は) バックアップされ、別のコンピューターで復元されたデータベースだけをグループに追加できます。

### バックアップ フォルダーの共有

バックアップと復元を有効にするには、セカンダリ SQL Server VM からバックアップ ファイル (.bak) にアクセスできる必要があります。次の手順に従います。

1.	[domain]**\sp_farm_db** としてプライマリ SQL Server ホストにログオンします。 
2.	F:\disk に移動します。 
3.	**[バックアップ]** フォルダーを右クリックして **[共有]** をクリックし、**[特定のユーザー]** をクリックします。
4.	**[ファイルの共有]** ダイアログで、「**[domain]\sqlservice**」と入力し、**[追加]** をクリックします。
5.	**sqlservice** アカウント名の **[アクセス許可レベル]** 列をクリックし、**[読み取り/書き込み]** をクリックします。 
6.	**[共有]** をクリックし、**[完了]** をクリックします。

セカンダリ SQL Server ホストで上記の手順を実行します。ただし、手順 5. では、sqlservice アカウントに F:\バックアップ フォルダーに対する**読み取り**アクセス許可を付与します。

### データベースのバックアップと復元

可用性グループに追加する必要があるすべてのデータベースに対して、次の手順を繰り返す必要があります。SQL Server AlwaysOn 可用性グループをサポートしていない SharePoint 2013 データベースもあります。詳細については、「[サポートされている SharePoint データベース用の高可用性と障害復旧のオプション](http://technet.microsoft.com/library/jj841106.aspx)」をご覧ください。

データベースをバックアップするには、次の手順に従います。

1.	プライマリ SQL Server コンピューターのスタート画面で、「**SQL Studio**」と入力し、**[SQL Server Management Studio]** をクリックします。
2.	**[接続]** をクリックします。
3.	左ウィンドウで **[データベース]** ノードを展開します。
4.	バックアップするデータベースを右クリックし、**[タスク]** をポイントして、**[バックアップ]** をクリックします。
5.	**[バックアップ先]** セクションで、**[削除]** をクリックして、バックアップ ファイルの既定のファイル パスを削除します。
6.	**[追加]** をクリックします。**[ファイル名]** に、「**\[machineName]\backup[databaseName].bak**」と入力します。machineName はプライマリ SQL Server コンピューターの名前、databaseName はデータベースの名前です。**[OK]** をクリックし、バックアップの成功に関するメッセージが表示されたら、もう一度 **[OK]** をクリックします。
7.	左ウィンドウで、**[databaseName]** を右クリックし、**[タスク]** をポイントして、**[バックアップ]** をクリックします。
8.	**[バックアップの種類]** で **[トランザクション ログ]** を選択し、**[OK]** を 2 回クリックします。
9.	このリモート デスクトップ セッションを開いたままにしておきます。

データベースを復元には、次の手順に従います。

1.	[domainName]\sp_farm_db としてセカンダリ SQL Server コンピューターにログオンします。
2.	スタート画面で「**SQL Studio**」と入力し、**[SQL Server Management Studio]** をクリックします。
3.	**[接続]** をクリックします。
4.	左ウィンドウで、**[データベース]** を右クリックし、**[データベースの復元]** をクリックします。
5.	**[ソース]** セクションで **[デバイス]** を選択し、省略記号 (…) ボタンをクリックします。
6.	**[バックアップ デバイスの選択]** で、**[追加]** をクリックします。
7.	**[バックアップ ファイルの場所]** で、「**\[machineName]\backup**」と入力し、**Enter** キーを押します。**[databaseName].bak** を選択し、**[OK]** を 2 回クリックします。**[復元するバックアップ セット]** セクションに完全バックアップとログ バックアップが表示されます。
8.	**[ページの選択]** で **[オプション]** をクリックします。**[復元オプション]** セクションの **[復旧状態]** で、**[RESTORE WITH NORECOVERY]** を選択し、**[OK]** をクリックします。 
9.	メッセージが表示されたら、**[OK]** をクリックします。

### 可用性グループの作成

(バックアップと復元の方法で) 1 つ以上のデータベースを準備したら、可用性グループを作成します。

1.	プライマリ SQL Server コンピューターのリモート デスクトップ セッションに戻ります。
2.	**SQL Server Management Studio** の左ウィンドウで、**[AlwaysOn 高可用性]** を右クリックし、**[新しい可用性グループ ウィザード]** をクリックします。
3.	[説明] ページで **[次へ]** をクリックします。 
4.	[可用性グループ名の指定] ページで、**[可用性グループ名]** に可用性グループの名前 (例: AG1) を入力し、**[次へ]** をクリックします。
5.	[データベースの選択] ページで、SharePoint ファームのバックアップしたデータベースを選択し、**[次へ]** をクリックします。対象とするプライマリ レプリカで完全バックアップを少なくとも 1 つは作成しているので、これらのデータベースは可用性グループの前提条件を満たしています。
6.	[レプリカの指定] ページで **[レプリカの追加]** をクリックします。
7.	**[サーバーへの接続]** で、セカンダリ SQL Server コンピューターの名前を入力し、**[接続]** をクリックします。 
8.	[レプリカの指定] ページの **[可用性レプリカ]** に、セカンダリ SQL Server ホストが表示されます。両方のインスタンスについて、次のオプション値を設定します。 

初期ロール | オプション | 値 
--- | --- | ---
プライマリ | [自動フェールオーバー (上限 2)] | オン
セカンダリ | [自動フェールオーバー (上限 2)] | オン
プライマリ | [同期コミット (上限 3)] | オン
セカンダリ | [同期コミット (上限 3)] | オン
プライマリ | [読み取り可能なセカンダリ] | あり
セカンダリ | [読み取り可能なセカンダリ] | あり
		
9.	**[次へ]** をクリックします。
10.	[最初のデータの同期を選択] ページで **[結合のみ]** をクリックし、**[次へ]** をクリックします。データの同期は、プライマリ サーバーで完全バックアップとトランザクション バックアップを作成し、バックアップで復元することによって手動で実行します。**[完全]** を選択して、新しい可用性グループ ウィザードでデータの同期を自動的に実行することもできます。ただし、一部の企業で使用されている大規模なデータベースでは同期はお勧めしません。
11.	[検証] ページで **[次へ]** をクリックします。可用性グループ リスナーを構成していないため、リスナー構成が見つからないことを示す警告が表示されます。 
12.	[概要] ページで **[完了]** をクリックします。ウィザードが完了したら、**[結果]** ページを調べて、可用性グループが正常に作成されたことを確認します。正常に作成されている場合は、**[閉じる]** をクリックしてウィザードを終了します。 
13.	スタート画面で「**フェールオーバー**」と入力し、**[フェールオーバー クラスター マネージャー]** をクリックします。左ウィンドウでクラスターの名前を開き、**[ロール]** をクリックします。可用性グループの名前が付いた新しいロールが表示されます。

SharePoint データベースの SQL Server AlwaysOn 可用性グループが正常に構成されました。

## AlwaysOn 可用性グループのリスナーの構成

必要に応じて、AlwaysOn 可用性グループのリスナー構成を作成することもできます。手順については、「[チュートリアル: AlwaysOn 可用性グループのリスナー構成](https://msdn.microsoft.com/library/dn425027.aspx)」をご覧ください。リスナーを 1 つだけ作成し、内部負荷分散インスタンスの仮想 IP アドレスを使用するように構成します。

リスナーを作成したら、クラスターの最初の SQL サーバーの名前ではなく、リスナーを使用するようにすべての SharePoint 仮想マシンを構成する必要があります。名前を使用するのではなく、SQL エイリアスを使用するように SharePoint 仮想マシンを構成します。詳細と手順については、「[SQL Alias for SharePoint (SharePoint の SQL エイリアス)](http://blogs.msdn.com/b/priyo/archive/2013/09/13/sql-alias-for-sharepoint.aspx)」をご覧ください。

SharePoint と SQL Server AlwaysOn 可用性グループの追加情報については、「[SQL Server 2012 の AlwaysOn 可用性グループを SharePoint 2013 用に構成する](https://technet.microsoft.com/library/jj715261.aspx)」をご覧ください。


## その他のリソース

[Azure での SharePoint と SQL Server AlwaysOn 可用性グループのデプロイ](virtual-machines-workload-intranet-sharepoint-overview.md)

[Azure インフラストラクチャ サービスでホストされる SharePoint ファーム](virtual-machines-sharepoint-infrastructure-services.md)

[SharePoint と SQL Server AlwaysOn のインフォグラフィック](http://go.microsoft.com/fwlink/?LinkId=394788)

[SharePoint 2013 用の Microsoft Azure アーキテクチャ](https://technet.microsoft.com/library/dn635309.aspx)

[Azure インフラストラクチャ サービス実装ガイドライン](virtual-machines-infrastructure-services-implementation-guidelines.md)
 

<!---HONumber=July15_HO4-->