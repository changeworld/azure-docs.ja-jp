---
title: チュートリアル - Azure portal で Windows 仮想マシンをバックアップする
description: このチュートリアルでは、Azure portal を使用して Azure Backup により Windows 仮想マシンを保護する方法を説明します。
services: virtual-machines-windows
documentationcenter: virtual-machines
author: cynthn
manager: gwallace
editor: tysonn
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-windows
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 06/06/2019
ms.author: cynthn
ms.custom: mvc
ms.openlocfilehash: 89ed0bad2729a9e0983d4ef7f8a53faa4f5426ac
ms.sourcegitcommit: 0947111b263015136bca0e6ec5a8c570b3f700ff
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/24/2020
ms.locfileid: "79415653"
---
# <a name="tutorial-back-up-and-restore-files-for-windows-virtual-machines-in-azure"></a>チュートリアル:Azure 内の Windows 仮想マシンのファイルをバックアップおよび復元する

データは、定期的にバックアップすることで保護することができます。 Azure Backup では、geo 冗長 Recovery コンテナーに保存される復旧ポイントが作成されます。 復旧ポイントから復元するときは、VM 全体を復元するか、特定のファイルを復元することができます。 この記事では、VM が稼働する Windows サーバーおよび IIS に 1 つのファイルを復元する方法を説明します。 使用する VM をまだ作成していない場合は、[Windows クイック スタート](quick-create-portal.md)を使用して作成できます｡ このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * VM のバックアップを作成する
> * 毎日のバックアップをスケジュールする
> * バックアップからファイルを復元する

## <a name="backup-overview"></a>Backup の概要

Azure Backup サービスによってバックアップが開始されると、バックアップ拡張機能がトリガーされて特定時点のスナップショットが作成されます。 Azure Backup サービスは、[VMSnapshot 拡張機能](https://docs.microsoft.com/azure/virtual-machines/extensions/vmsnapshot-windows)を利用します。 この拡張機能は、VM の初回バックアップ中、VM が実行されている場合にインストールされます。 VM が実行されていない場合、Backup サービスは基盤となるストレージのスナップショットを取ります (VM が停止している間はアプリケーション書き込みが行われないため)。

Windows VM のスナップショットを取るとき、Backup サービスは Volume Shadow Copy Service (VSS) と連携して仮想マシンのディスクの一貫したスナップショットを取得します。 Azure Backup サービスがスナップショットを取ると、データはバックアップコンテナーに転送されます。 効率を最大に高めるために、前回のバックアップ以降に変更されたデータ ブロックが特定され、そのデータのみが転送されます。

データ転送が完了すると、スナップショットが削除され、回復ポイントが作成されます。

## <a name="create-a-backup"></a>バックアップの作成
Recovery Services コンテナーに対するバックアップを 1 日 1 回の単純なスケジュールで作成します。 

1. [Azure portal](https://portal.azure.com/) にサインインします。
1. 左側のメニューから **[仮想マシン]** を選択します。 
1. バックアップする VM を一覧から選択します。
1. その VM のブレードの **[操作]** セクションで **[バックアップ]** をクリックします。 **[バックアップの有効化]** ブレードが開きます。
1. **[Recovery Services コンテナー]** の **[新規作成]** をクリックして、新しいコンテナーの名前を入力します。 仮想マシンと同じリソース グループで、仮想マシンと同じ場所に新しいコンテナーが作成されます。
1. **[バックアップ ポリシーの選択]** で既定の **[(新規) DailyPolicy]** にしたまま、 **[バックアップの有効化]** をクリックします。
1. 最初の復旧ポイントを作成するには、 **[バックアップ]** ブレードの **[今すぐバックアップ]** をクリックします。
1. **[今すぐバックアップ]** ブレードでカレンダー アイコンをクリックし、カレンダー コントロールを使って復元ポイントの保持期間を選択してから、 **[OK]** をクリックします。
1. 対象の VM の **[バックアップ]** ブレードに、作成されている復元ポイントの数が表示されます。


    ![[回復ポイント]](./media/tutorial-backup-vms/backup-complete.png)
    
初回バックアップには約 20 分かかります。 バックアップが完了したら、このチュートリアルの次のパートに進んでください。

## <a name="recover-a-file"></a>ファイルの復元

ファイルを誤って削除または変更した場合は、ファイルの回復機能を使ってバックアップ コンテナーからファイルを復元することができます。 ファイルの回復には、VM 上で動作するスクリプトが使用され、復旧ポイントがローカル ドライブとしてマウントされます。 これらのドライブは、12 時間マウントされた状態になります。その間に復旧ポイントからファイルをコピーし、VM に復元することができます。  

この例では､IIS 用の既定の Web ページで使用されているイメージファイルを復元する方法を示します｡ 

1. ブラウザーを開いて､VM の IP アドレスに接続することで､既定の IIS ページを表示します｡

    ![既定の IIS web ページ](./media/tutorial-backup-vms/iis-working.png)

1. VM に接続します
1. VM で **ファイル エクスプ ローラー**を開き､ \inetpub\wwwroot に移動して、**iisstart.png** ファイルを削除します。
1. ローカルコンピュータでブラウザーを再表示して既定の IIS ページ上のイメージがなくなったことを確認します｡

    ![既定の IIS web ページ](./media/tutorial-backup-vms/iis-broken.png)

1. ローカル コンピューターで新しいタブを開き､[Azure portal](https://portal.azure.com) に移動します。
1. 左側のメニューで **[仮想マシン]** を選択し､一覧から VM を選択します。
1. その VM のブレードの **[操作]** セクションで **[バックアップ]** をクリックします。 **[バックアップ]** ブレードが開きます。 
1. ブレード上部のメニューで **[ファイルの回復]** を選択します。 **[ファイルの回復]** ブレードが開きます。
1. **[ステップ 1:回復ポイントを選択する]** で、ドロップダウンから復旧ポイントを選択します。
1. **[ステップ 2:ファイルを参照および回復するためのスクリプトをダウンロードする]** の **[実行可能ファイルのダウンロード]** をクリックします。 ファイルのパスワードをコピーし、安全な場所に保存します。
1. ローカル コンピュータで **ファイル エクスプローラー**を開き､**ダウンロード** フォルダに移動して､ダウンロードした .exe ファイルをコピーします｡ ファイル名には､プリフィックスとして VM 名が付けられます｡ 
1. VM (RDP 接続使用) のデスクトップに .exe ファイルを貼り付けます。 
1. VM のデスクトップに移動し､.exe ファイルをダブルクリックします｡ コマンド プロンプトが開始されます。 プログラムが復旧ポイントに、アクセス可能なファイル共有としてマウントします。 共有の作成が完了したら､**q** を入力してコマンド プロンプトを閉じます｡
1. VM で**ファイル エクスプローラー**を開き､ファイル共有に使用したドライ文字に移動します｡
1. \inetpub\wwwroot に移動し､ファイル共有から **iisstart.png** をコピーして､\inetpub\wwwroot に貼り付けます｡ たとえば､F:\inetpub\wwwroot\iisstart.png をコピーし､c:\inetpub\wwwroot に貼り付けることでファイルを回復できます｡
1. ローカル コンピューターで、既定の IIS ページを表示する VM の IP アドレスに接続したブラウザー タブを開きます。 Ctrl キーを押しながら F5 キーを押して、ブラウザー ページを最新の情報に更新します。 これで､イメージが復元されたことを確認できます｡
1. ローカル コンピューターで Azure portal のブラウザー タブに戻り、 **[ステップ 3:回復後にディスクのマウントを解除する]** の **[ディスクのマウント解除]** をクリックします。 この手順を実行するのを忘れた場合、12 時間後にマウント ポイントへの接続が自動的に解除されます。 12 時間が経過した後、新しいマウント ポイントを作成するには、新しいスクリプトをダウンロードする必要があります。





## <a name="next-steps"></a>次のステップ

このチュートリアルでは、以下の内容を学習しました。

> [!div class="checklist"]
> * VM のバックアップを作成する
> * 毎日のバックアップをスケジュールする
> * バックアップからファイルを復元する

次のチュートリアルに進み、仮想マシンの監視について学習してください。

> [!div class="nextstepaction"]
> [仮想マシンの管理](tutorial-govern-resources.md)









