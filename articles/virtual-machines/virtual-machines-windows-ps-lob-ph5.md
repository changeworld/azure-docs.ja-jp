<properties 
	pageTitle="基幹業務アプリケーションのフェーズ 5 | Microsoft Azure" 
	description="可用性グループを作成して 、アプリケーション データベースを追加します。" 
	documentationCenter=""
	services="virtual-machines-windows" 
	authors="JoeDavies-MSFT" 
	manager="timlt" 
	editor=""
	tags="azure-resource-manager"/>

<tags 
	ms.service="virtual-machines-windows" 
	ms.workload="infrastructure-services" 
	ms.tgt_pltfrm="vm-windows" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/04/2016" 
	ms.author="josephd"/>

# 基幹業務アプリケーション ワークロード フェーズ 5: 可用性グループを作成してアプリケーション データベースを追加する

高可用な基幹業務アプリケーションを Azure インフラストラクチャ サービスにデプロイする作業のこの最終フェーズでは、新しい SQL Server AlwaysOn 可用性グループを作成し、アプリケーションのデータベースを追加します。

全フェーズについては、「[Azure での高可用な基幹業務アプリケーションのデプロイ](virtual-machines-windows-lob-overview.md)」をご覧ください。

## 可用性グループの作成とデータベースの追加

基幹業務アプリケーションのデータベースのそれぞれについて、次を実行します。

1.	プライマリ SQL Server 仮想マシンで、データベースの完全バックアップとトランザクション ログ バックアップを作成します。
2.	バックアップ SQL Server 仮想マシンで、完全バックアップとログ バックアップを復元します。

データベースのバックアップと復元が完了したら、可用性グループに追加できます。SQL Server では、(少なくとも 1 回は) バックアップされ、別のコンピューターで復元されたデータベースだけをグループに追加できます。

### バックアップ フォルダーの共有

バックアップと復元を有効にするには、セカンダリ データベース サーバーからバックアップ ファイル (.bak) にアクセスできる必要があります。次の手順に従います。

1.	**[domain]\\sqladmin** としてプライマリ データベース サーバーにログオンします。 
2.	F:\\disk に移動します。 
3.	**[バックアップ]** フォルダーを右クリックして **[共有]** をクリックし、**[特定のユーザー]** をクリックします。
4.	**[ファイルの共有]** ダイアログで、「**[domain]\\sqlservice**」と入力し、**[追加]** をクリックします。
5.	**sqlservice** アカウント名の **[アクセス許可レベル]** 列をクリックし、**[読み取り/書き込み]** をクリックします。 
6.	**[共有]** をクリックし、**[完了]** をクリックします。

セカンダリ データベース サーバーで上記の手順を実行します。ただし、手順 5. では、sqlservice アカウントに F:\\Backup フォルダーに対する**読み取り**アクセス許可を付与します。

### データベースのバックアップと復元

可用性グループに追加する必要があるすべてのデータベースに対して、次の手順を繰り返す必要があります。

データベースをバックアップするには、次の手順に従います。

1.	プライマリ データベース サーバーのスタート画面で、「**SQL Studio**」と入力し、**[SQL Server Management Studio]** をクリックします。
2.	**[接続]** をクリックします。
3.	左ウィンドウで **[データベース]** ノードを展開します。
4.	バックアップするデータベースを右クリックし、**[タスク]** をポイントして、**[バックアップ]** をクリックします。
5.	**[バックアップ先]** セクションで、**[削除]** をクリックして、バックアップ ファイルの既定のファイル パスを削除します。
6.	**[追加]** をクリックします。**[ファイル名]** に、「**\\[machineName]\\backup[databaseName].bak**」と入力します。ここで、**machineName** はプライマリ SQL **Server コンピューター**の名前、**databaseName** はデータベースの名前です。**[OK]** をクリックし、バックアップの成功に関するメッセージが表示されたら、もう一度 **[OK]** をクリックします。
7.	左ウィンドウで、**[databaseName]** を右クリックし、**[タスク]** をポイントして、**[バックアップ]** をクリックします。
8.	**[バックアップの種類]** で **[トランザクション ログ]** を選択し、**[OK]** を 2 回クリックします。
9.	このリモート デスクトップ セッションを開いたままにしておきます。

データベースを復元には、次の手順に従います。

1.	[domainName]\\sp\_farm\_db としてセカンダリ データベース サーバーにログオンします。
2.	スタート画面で「**SQL Studio**」と入力し、**[SQL Server Management Studio]** をクリックします。
3.	**[接続]** をクリックします。
4.	左ウィンドウで、**[データベース]** を右クリックし、**[データベースの復元]** をクリックします。
5.	**[ソース]** セクションで **[デバイス]** を選択し、省略記号 (…) ボタンをクリックします。
6.	**[バックアップ デバイスの選択]** で、**[追加]** をクリックします。
7.	**[バックアップ ファイルの場所]** で、「**\\[machineName]\\backup**」と入力し、**Enter** キーを押します。**[databaseName].bak** を選択し、**[OK]** を 2 回クリックします。**[復元するバックアップ セット]** セクションに完全バックアップとログ バックアップが表示されます。
8.	**[ページの選択]** で **[オプション]** をクリックします。**[復元オプション]** セクションの **[復旧状態]** で、**[RESTORE WITH NORECOVERY]** を選択し、**[OK]** をクリックします。 
9.	メッセージが表示されたら、**[OK]** をクリックします。

### 可用性グループの作成

(バックアップと復元の方法で) 1 つ以上のデータベースを準備したら、可用性グループを作成します。

1.	プライマリ データベース サーバーのリモート デスクトップ セッションに戻ります。
2.	**SQL Server Management Studio** の左ウィンドウで、**[AlwaysOn 高可用性]** を右クリックし、**[新しい可用性グループ ウィザード]** をクリックします。
3.	**[説明]** ページで、**[次へ]** をクリックします。 
4.	**[可用性グループ名の指定]** ページで、**[可用性グループ名]** に可用性グループの名前 (例: AG1) を入力し、**[次へ]** をクリックします。
5.	**[データベースの選択]** ページで、バックアップしたアプリケーション データベースを選択し、**[次へ]** をクリックします。対象とするプライマリ レプリカで完全バックアップを少なくとも 1 つは作成しているので、これらのデータベースは可用性グループの前提条件を満たしています。
6.	**[レプリカの指定]** ページで **[レプリカの追加]** をクリックします。
7.	**[サーバーへの接続]** で、セカンダリ データベース サーバーの名前を入力し、**[接続]** をクリックします。 
8.	**[レプリカの指定]** ページの **[可用性レプリカ]** に、セカンダリ データベース サーバーがリストされます。両方のインスタンスについて、次のオプション値を設定します。 

初期ロール | オプション | 値 
--- | --- | ---
プライマリ | [自動フェールオーバー (上限 2)] | オン
セカンダリ | [自動フェールオーバー (上限 2)] | オン
プライマリ | [同期コミット (上限 3)] | オン
セカンダリ | [同期コミット (上限 3)] | オン
プライマリ | [読み取り可能なセカンダリ] | あり
セカンダリ | [読み取り可能なセカンダリ] | あり
		
9.	**[次へ]** をクリックします。
10.	**[最初のデータの同期を選択]** ページで **[結合のみ]** をクリックし、**[次へ]** をクリックします。データの同期は、プライマリ サーバーで完全バックアップとトランザクション バックアップを作成し、バックアップで復元することによって手動で実行します。**[完全]** を選択して、新しい可用性グループ ウィザードでデータの同期を自動的に実行することもできます。ただし、一部の企業で使用されている大規模なデータベースでは同期はお勧めしません。
11.	**[検証]** ページで **[次へ]** をクリックします。可用性グループ リスナーを構成していないため、リスナー構成が見つからないことを示す警告が表示されます。 
12.	**[概要]** ページで **[完了]** をクリックします。ウィザードが完了したら、**[結果]** ページを調べて、可用性グループが正常に作成されたことを確認します。正常に作成されている場合は、**[閉じる]** をクリックしてウィザードを終了します。 
13.	スタート画面で「**フェールオーバー**」と入力し、**[フェールオーバー クラスター マネージャー]** をクリックします。左ウィンドウでクラスターの名前を開き、**[ロール]** をクリックします。可用性グループの名前が付いた新しいロールが表示されます。

アプリケーション データベースの SQL Server AlwaysOn 可用性グループが正常に構成されました。

![](./media/virtual-machines-windows-ps-lob-ph5/workload-lobapp-phase4.png)

イントラネット ユーザーに対して、この新しいアプリケーションのロールアウトを開始する準備が整いました。

## AlwaysOn 可用性グループのリスナーの構成

必要に応じて、AlwaysOn 可用性グループのリスナー構成を作成することもできます。手順については、「[チュートリアル: AlwaysOn 可用性グループのリスナー構成](https://msdn.microsoft.com/library/dn425027.aspx)」をご覧ください。この手順では、リスナーを 1 つのみ (推奨) 作成して、内部負荷分散のインスタンスの静的 IP アドレスを使用します。

リスナーを構成したら、クラスターの最初の SQL サーバーの名前ではなく、リスナーを使用するようにすべての Web サーバー仮想マシンを構成する必要があります。新しい DNS 名と、内部負荷分散インスタンスの仮想 IP アドレスにマップするレコードを使用するのではなく、Web サーバー仮想マシンを構成して SQL エイリアスを使用します。詳細と手順については、「[SQL Alias for SharePoint (SharePoint の SQL エイリアス)](http://blogs.msdn.com/b/priyo/archive/2013/09/13/sql-alias-for-sharepoint.aspx)」をご覧ください。

## 次のステップ

- Azure で独自の IT ワークロードをデプロイする場合は、こちらの[ガイドライン](virtual-machines-linux-infrastructure-service-guidelines.md)をご覧ください。

<!---HONumber=AcomDC_0601_2016-->