---
title: Azure Lab Services のテンプレート VM で入れ子になった仮想化を有効にする (UI) | Microsoft Docs
description: 内部に複数の VM を持つテンプレート VM を作成する方法について説明します。  つまり、Azure Lab Services のテンプレート VM で入れ子になった仮想化を有効にします。
services: lab-services
author: emaher
ms.service: lab-services
ms.topic: article
ms.date: 1/23/2020
ms.author: enewman
ms.openlocfilehash: 10f8d2760474631fbcabac4d66139aedf4c7560c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "79504107"
---
# <a name="enable-nested-virtualization-on-a-template-virtual-machine-in-azure-lab-services-manually"></a>Azure Lab Services のテンプレート仮想マシンで入れ子になった仮想化を手動で有効にする

入れ子になった仮想化を使用すると、ラボのテンプレート仮想マシン内にマルチ VM 環境を作成できます。 テンプレートを公開すると、ラボ内の各ユーザーに、内部に複数の VM が設定された仮想マシンが提供されます。  入れ子になった仮想化と Azure Lab Services の詳細については、「[Azure Lab Services のテンプレート仮想マシンで入れ子になった仮想化を有効にする](how-to-enable-nested-virtualization-template-vm.md)」を参照してください。

この記事では、Windows のロールとツールを直接使用して、Azure Lab Services のテンプレート マシンで入れ子になった仮想化を設定する方法について説明します。  入れ子になった仮想化をクラスで使用できるようにするには、いくつかのことが必要です。  下記の手順では、Hyper-V を使用して Lab Services マシン テンプレートを手動で設定する方法について説明します。  手順は、Windows Server 2016 または Windows Server 2019 を対象としたものです。  

>[!IMPORTANT]
>ラボの作成時、仮想マシン サイズとして **[Large (Nested Virtualization)]\(大 (入れ子になった仮想化)\)** または **[Medium (Nested Virtualization)]\(中 (入れ子になった仮想化)\)** のサイズを選択します。  それ以外の場合、入れ子になった仮想化は機能しません。  

## <a name="enable-hyper-v-role"></a>Hyper-V ロールの有効化

次の手順は、いずれかのサーバー マネージャーを使用して、Windows Server 上で Hyper-V を有効にするための必要な操作を説明したものです。  インストールが正常に完了すると、クライアント仮想マシンの追加、変更、および削除に、Hyper-V マネージャーを使用できるようになります。

1. **サーバー マネージャー**の [ダッシュボード] ページで、 **[役割と機能の追加]** をクリックします。
2. **[開始する前に]** ページで **[次へ]** をクリックします。
3. **[インストールの種類の選択]** ページで [役割ベースまたは機能ベースのインストール] を既定の選択にしたまま、 **[次へ]** をクリックします。
4. **[対象サーバーの選択]** ページで、[サーバー プールからサーバーを選択] を選択します。   現在のサーバーが既に選択されています。  [次へ] をクリックします。
5. **[サーバーの役割の選択]** ページで **[Hyper-V]** を選択します。  
6. **役割と機能の追加ウィザード**が表示されます。  **[管理ツールを含める (存在する場合)]** を選択します。  **[機能の追加]** ボタンをクリックします。
7. **[サーバーの役割の選択]** ページで、 **[次へ]** をクリックします。
8. **[機能の選択]** ページで **[次へ]** をクリックします。
9. **[Hyper-V]** ページで、 **[次へ]** をクリックします。
10. **[仮想スイッチの作成]** ページで、既定の設定をそのまま適用して、 **[次へ]** をクリックします。
11. **[仮想マシンの移行]** ページで、既定の設定をそのまま適用して、 **[次へ]** をクリックします。
12. **[既定の保存場所]** ページで、既定の設定をそのまま適用して、 **[次へ]** をクリックします。
13. **[インストール オプションの確認]** ページで、 **[必要に応じて対象サーバーを自動的に再起動する]** を選択します。
14. **役割と機能の追加ウィザード**のポップアップが表示されたら、 **[はい]** をクリックします。
15. **[インストール]** をクリックします。
16. **[インストールの進行状況]** ページで、Hyper-V ロールが完了したことを確認します。  インストール中にコンピューターが再起動される場合があります。
17. **[閉じる]** をクリックします。

## <a name="enable-dhcp-role"></a>DHCP ロールの有効化

作成されたすべての Hyper-V クライアント仮想マシンには、NAT ネットワークの IP アドレスが必要です。  NAT ネットワークの作成は後で行います。  IP アドレスを割り当てる 1 つの方法は、ホスト (この場合はラボ仮想マシン テンプレート) を DHCP サーバーとして設定することです。  次に示すのは、DHCP ロールを有効にするための必要な手順です。

1. **サーバー マネージャー**の **[ダッシュボード]** ページで、 **[役割と機能の追加]** をクリックします。
2. **[開始する前に]** ページで **[次へ]** をクリックします。
3. **[インストールの種類の選択]** ページで **[役割ベースまたは機能ベースのインストール]** を選択し、 **[次へ]** をクリックします。
4. **[対象サーバーの選択]** ページで、サーバー プールから現在のサーバーを選択し、 **[次へ]** をクリックします。
5. **[サーバーの役割の選択]** ページで **[DHCP サーバー]** を選択します。  
6. **役割と機能の追加ウィザード**が表示されます。  **[管理ツールを含める (存在する場合)]** を選択します。  **[機能の追加]** をクリックします。

    >[!NOTE]
    >静的 IP アドレスが見つからなかったという検証エラーが表示される場合があります。  この警告は、このシナリオでは無視してかまいません。

7. **[サーバーの役割の選択]** ページで、 **[次へ]** をクリックします。
8. **[機能の選択]** ページで **[次へ]** をクリックします。
9. **[DHCP サーバー]** ページで、 **[次へ]** をクリックします。
10. **[インストール オプションの確認]** ページで、 **[インストール]** をクリックします。
11. **[インストールの進行状況]** ページで、DHCP ロールが完了したことを確認します。
12. [閉じる] をクリックします。

## <a name="enable-routing-and-remote-access-role"></a>ルーティングとリモート アクセス ロールの有効化

1. **サーバー マネージャー**の **[ダッシュボード]** ページで、 **[役割と機能の追加]** をクリックします。
2. **[開始する前に]** ページで **[次へ]** をクリックします。
3. **[インストールの種類の選択]** ページで **[役割ベースまたは機能ベースのインストール]** を選択し、 **[次へ]** をクリックします。
4. **[対象サーバーの選択]** ページで、サーバー プールから現在のサーバーを選択し、 **[次へ]** をクリックします。
5. **[サーバーの役割の選択]** ページで **[リモート アクセス]** を選択します。 **[OK]** をクリックします。
6. **[機能の選択]** ページで **[次へ]** をクリックします。
7. **[リモートアクセス]** ページで、 **[次へ]** をクリックします。
8. **[役割サービス]** ページで、 **[ルーティング]** を選択します。
9. **役割と機能の追加ウィザード**が表示されます。  **[管理ツールを含める (存在する場合)]** を選択します。  **[機能の追加]** をクリックします。
10. **[次へ]** をクリックします。
11. **[Web サーバーの役割 (IIS)]** ページで **[次へ]** をクリックします。
12. **[役割サービスの選択]** ページで、 **[次へ]** をクリックします。
13. **[インストール オプションの確認]** ページで、 **[インストール]** をクリックします。
14. **[インストールの進行状況]** ページで、リモート アクセス ロールが完了したことを確認します。  
15. **[閉じる]** をクリックします。

## <a name="create-virtual-nat-network"></a>仮想 NAT ネットワークの作成

必要なすべてのロールがインストールされたので、次に NAT ネットワークを作成します。  この作成プロセスには、スイッチの作成と、NAT ネットワーク自体の作成が含まれます。  NAT (ネットワーク アドレス変換) ネットワークでは、インターネットに接続できるように、プライベート ネットワーク上の VM のグループにパブリック IP アドレスが割り当てられます。  この例では、プライベート VM のグループは、入れ子になった VM になります。  NAT ネットワークによって、入れ子になった VM どうしが相互に通信できるようになります。 スイッチは、ネットワーク内のトラフィックの受信とルーティングを処理するネットワーク デバイスです。

### <a name="create-a-new-virtual-switch"></a>新しい仮想スイッチの作成

1. Windows 管理ツールから **Hyper-V マネージャー**を開きます。
2. 左のナビゲーション メニューで、現在のサーバーを選択します。
3. **[仮想スイッチ マネージャー…]** をクリックします (**Hyper-V マネージャー**の右側にある **[操作]** メニューから)。
4. **[仮想スイッチ マネージャー]** ポップアップで、作成するスイッチの種類として **[内部]** を選択します。  **[仮想スイッチの作成]** をクリックします。
5. 新しく作成された仮想スイッチに対して、覚えやすい名前を設定します。  この例では、'LabServicesSwitch' を使用します。  **[OK]** をクリックします。
6. 新しいネットワーク アダプターが作成されます。  これは、'vEthernet (LabServicesSwitch)' のような名前になります。  確認するために、**コントロール パネル**を開き、 **[ネットワークとインターネット]** をクリックして、 **[ネットワークの状態とタスクの表示]** をクリックします。  左側で、 **[アダプターの設定の変更]** をクリックします。

### <a name="create-a-nat-network"></a>NAT ネットワークの作成

1. Windows 管理ツールから **[ルーティングとリモート アクセス]** ツールを開きます。
2. 左側のナビゲーション ページで、ローカル サーバーを選択します。
3. **[操作]**  ->  **[ルーティングとリモート アクセスの構成と有効化]** を選択します。
4. **ルーティングとリモート アクセス サーバーのセットアップ ウィザード**が表示されたら、 **[次へ]** をクリックします。
5. **[構成]** ページで、 **[ネットワーク アドレス変換 (NAT)]** 構成を選択します。  **[次へ]** をクリックします。

    >[!WARNING]
    >[仮想プライベート ネットワーク (VPN) アクセスおよび NAT] オプションは選択しないでください。

6. **[NAT インターネット接続]** ページで、'イーサネット' を選択します。  Hyper-V マネージャーで作成した 'vEthernet (LabServicesSwitch)' 接続は選択しないでください。 **[次へ]** をクリックします。
7. ウィザードの最後のページで、 **[完了]** をクリックします。
8. **[サービスの開始]** ダイアログが表示されたら、 **[サービスの開始]** をクリックします。
9. サービスが開始されるまで待ちます。

## <a name="update-network-adapter-settings"></a>ネットワーク アダプター設定の更新

ネットワーク アダプターは、前に作成した NAT ネットワークの既定のゲートウェイ IP として使用される IP に関連付けられます。  この例では、サブネット マスク 255.255.255.0 を使用して、IP アドレス 192.168.0.1 を作成します。  仮想スイッチは、前に作成したものを使用します。

1. **コントロール パネル**を開き、 **[ネットワークとインターネット]** をクリックして、 **[ネットワークの状態とタスクの表示]** をクリックします。
2. 左側で、 **[アダプターの設定の変更]** をクリックします。  
3. **[ネットワーク接続]** ウィンドウで、'vEthernet (LabServicesSwitch)' をダブルクリックして、 **[vEthernet (LabServicesSwitch) の状態]** 詳細ダイアログを表示します。
4. **[プロパティ]** ボタンをクリックします。
5. **[インターネット プロトコル バージョン 4 (TCP/IPv4)]** 項目を選択し、 **[プロパティ]** ボタンをクリックします。
6. **[インターネット プロトコル バージョン 4 (TCP/IPv4) のプロパティ]** ダイアログで、 **[次の IP アドレスを使う]** を選択します。  IP アドレスとして、「192.168.0.1」と入力します。 サブネット マスクとして、「255.255.255.0」と入力します。  既定のゲートウェイは空白のままにします。  DNS サーバーも空白のままにします。

    >[!NOTE]
    > NAT ネットワークの範囲は、CIDR 表記では 192.168.0.0/24 です。  これにより、192.168.0.1 から 192.168.0.254 までの、使用可能な IP アドレスの範囲が作成されます。  慣例により、ゲートウェイには、サブネット範囲内の最初の IP アドレスが使用されます。

7. [OK] をクリックします。

## <a name="create-dhcp-scope"></a>DHCP スコープの作成

次の手順は、DHCP スコープを追加するための手順です。  この記事では、NAT ネットワークは CIDR 表記で 192.168.0.0/24 です。  これにより、192.168.0.1 から 192.168.0.254 までの、使用可能な IP アドレスの範囲が作成されます。  作成されるスコープは、既に作成済みの IP アドレスを除いて、使用可能なアドレスの範囲内である必要があります。

1. **管理ツール**を開き、**DHCP** 管理ツールを開きます。
2. **DHCP** ツールで、現在のサーバーのノードを展開し、 **[IPv4]** を選択します。
3. [操作] メニューの **[新しいスコープ]** を選択します
4. **新しいスコープ ウィザード**が表示されたら、**ウェルカム** ページの **[次へ]** をクリックします。
5. **[スコープ名]** ページで、「LabServicesDhcpScope」と入力するか、その他の覚えやすい名前を入力します。  **[次へ]** をクリックします。
6. **[IP アドレスの範囲]** ページで、次の値を入力します。

    - 開始 IP アドレスとして、192.168.0.100
    - 終了 IP アドレスとして、192.168.0.200
    - 長さとして、24
    - サブネット マスクとして、255.255.255.0

7. **[次へ]** をクリックします。
8. **[除外と遅延の追加]** ページで、 **[次へ]** をクリックします。
9. **[リース期間]** ページで、 **[次へ]** をクリックします。
10. **[DHCP オプションの構成]** ページで、 **[今すぐオプションを構成する]** を選択します。 **[次へ]** をクリックします。
11. **[ルーター (デフォルト ゲートウェイ)]** で
12. 192.168.0.1 を追加します (まだ追加されていない場合)。 **[次へ]** をクリックします。
13. **[ドメイン名および DNS サーバー]** ページで、DNS サーバーの IP アドレスとして、168.63.129.16 を追加します (まだ追加されていない場合)。  168.63.129.16 は、Azure の静的 DNS サーバーの IP アドレスです。 **[次へ]** をクリックします。
14. **[WINS サーバー]** ページで、 **[次へ]** をクリックします。
15. **[スコープのアクティブ化]** ページで、 **[今すぐアクティブにする]** をオンにします。  **[次へ]** をクリックします。
16. **[新しいスコープ ウィザードの完了]** ページで、 **[完了]** をクリックします。

## <a name="conclusion"></a>まとめ

これで、テンプレート コンピューターで Hyper-V 仮想マシンを作成する準備ができました。   Hyper-V 仮想マシンの作成方法については、「[Hyper-V で仮想マシンを作成する](https://docs.microsoft.com/windows-server/virtualization/hyper-v/get-started/create-a-virtual-machine-in-hyper-v)」を参照してください。  また、[Microsoft Evaluation Center](https://www.microsoft.com/evalcenter/) を参照して、使用可能なオペレーティング システムとソフトウェアを確認してください。

## <a name="next-steps"></a>次のステップ

次の手順は、すべてのラボの設定で共通です。

- [ユーザーの追加](tutorial-setup-classroom-lab.md#add-users-to-the-lab)
- [クォータを設定する](how-to-configure-student-usage.md#set-quotas-for-users)
- [スケジュールを設定する](tutorial-setup-classroom-lab.md#set-a-schedule-for-the-lab)
- [登録リンクを学生に電子メールで送る](how-to-configure-student-usage.md#send-invitations-to-users)