---
title: Azure CDN を使用した大きなファイルのダウンロードの最適化
description: この記事では、大きなファイルのダウンロードを最適化する方法について説明します。
services: cdn
documentationcenter: ''
author: asudbring
manager: danielgi
editor: ''
ms.assetid: ''
ms.service: azure-cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/01/2018
ms.author: allensu
ms.openlocfilehash: 28b3c4faf62bcd9f9495810927ece03e2dadc1fc
ms.sourcegitcommit: 8dc84e8b04390f39a3c11e9b0eaf3264861fcafc
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/13/2020
ms.locfileid: "81260532"
---
# <a name="large-file-download-optimization-with-azure-cdn"></a>Azure CDN を使用した大きなファイルのダウンロードの最適化

インターネット経由で配信されるコンテンツのファイル サイズは、機能の強化、グラフィックスの向上、リッチ メディア コンテンツの普及により、常に拡大し続けています。 この拡大は、ブロードバンドの浸透、低価格ストレージ デバイスの大容量化、高解像度ビデオの広範な増加、インターネットに接続されるデバイス (IoT) などの多くの要因によってもたらされています。 このような大きなファイルの高速で効率的な配信メカニズムは、お客様がスムーズで楽しい経験をすることを可能にするために極めて重要です。

大容量ファイルの配信には、いくつかの課題があります。 まず、アプリケーションはすべてのデータを順番にダウンロードしない場合があるため、大きなファイルのダウンロードにかかる平均時間が長くなることがあります。 場合によっては、アプリケーションはファイルの先頭部分より先に最後の部分をダウンロードすることもあります。 少量のファイルのみを要求した場合や、ダウンロードを一時停止した場合は、ダウンロードが失敗します。 また、コンテンツ配信ネットワーク (CDN) が配信元サーバーからファイル全体を取得するまで、ダウンロードが遅延することもあります。 

次に、コンテンツが表示されるまでの時間は、ユーザーのマシンとファイルの間の待ち時間によって決まります。 さらに、ネットワークの輻輳や容量の問題もスループットに影響します。 サーバーとユーザー間の距離が長くなるほど、品質低下を引き起こすパケット損失の可能性が高くなります。 スループットの制限とパケット損失の増加によって品質が低下すると、ファイル ダウンロードが完了するまでの待ち時間が長くなることがあります。 

3 つ目に、大きなファイルの多くは完全には配信されません。 ユーザーは、ダウンロードを途中で取り消したり、長い MP4 ビデオの最初の数分のみ視聴したりすることがあります。 そのため、ソフトウェアやメディアを配信する企業は、要求された部分のファイルのみを配信したいと考えます。 要求された部分だけを効率的に配信できれば、配信元サーバーからのエグレス トラフィックが少なくなります。 さらに、効率的に配信できれば、配信元サーバーのメモリや I/O 負荷も軽減されます。 


## <a name="optimize-for-delivery-of-large-files-with-azure-cdn-from-microsoft"></a>Azure CDN from Microsoft を使った大きなファイルの配信の最適化

**Azure CDN Standard from Microsoft** エンドポイントでは、ファイル サイズの制限なく、大きなファイルの配信を行うことができます。 大きなファイルを短時間で配信できるように、追加の機能が既定で有効になっています。

### <a name="object-chunking"></a>オブジェクト チャンク 

**Azure CDN Standard from Microsoft** では、オブジェクト チャンクと呼ばれる方法が採用されています。 大きなファイルが要求されると、CDN は配信元からファイルを分割して取得します。 CDN POP サーバーが完全なファイル要求またはバイト範囲を指定したファイル要求を受け取った後、CDN エッジ サーバーは、8 MB のチャンク単位で配信元にファイルを要求します。 

CDN エッジに届いたチャンクはキャッシュされ、即座にユーザーに提供されます。 その後、CDN は並列処理で次のチャンクをプリフェッチします。 このプリフェッチにより、コンテンツはチャンク 1 つ分だけ常にユーザーより先行することになるため、待ち時間が短縮されます。 この処理は、ファイル全体がダウンロードされるか (要求があった場合)、すべてのバイト範囲が利用可能になるか (要求があった場合)、クライアントが接続を終了するまで続けられます。 

バイト範囲の要求の詳細については、[RFC 7233](https://tools.ietf.org/html/rfc7233) をご覧ください。

CDN は受信したチャンクをすべてキャッシュします。 ファイル全体を CDN のキャッシュに保存する必要はありません。 ファイルまたはバイト範囲に対する後続の要求は CDN キャッシュから処理されます。 すべてのチャンクが CDN にキャッシュされていない場合、プリフェッチを使用して配信元にチャンクが要求されます。 この最適化は、配信元サーバーのバイト範囲要求をサポートする機能に依存します。配信元サーバーがバイト範囲要求をサポートしていない場合、この最適化の効果はありません。 

### <a name="conditions-for-large-file-optimization"></a>大きなファイルの最適化の条件
一般的な Web 配信の最適化を使用すると、**Azure CDN Standard from Microsoft** の大きなファイルの最適化機能が既定で有効になります。 最大ファイル サイズの上限はありません。


## <a name="optimize-for-delivery-of-large-files-with-azure-cdn-from-verizon"></a>Azure CDN from Verizon を使った大きなファイルの配信の最適化

**Azure CDN Standard from Verizon** エンドポイントおよび **Azure CDN Premium from Verizon** エンドポイントでは、ファイル サイズの制限なく、大きなファイルの配信を行うことができます。 大きなファイルを短時間で配信できるように、追加の機能が既定で有効になっています。

### <a name="complete-cache-fill"></a>Complete Cache Fill (完全キャッシュ入力)

既定の Complete Cache Fill (完全キャッシュ入力) 機能では、最初の要求が破棄された、または消失したときに、CDN がファイルをキャッシュにプルします。 

Complete Cache Fill は、サイズの大きな資産に対して最も有効的な手段です。 通常、ユーザーは大きな資産を最初から最後までダウンロードせず、 プログレッシブ ダウンロードを使用します。 既定の動作では、エッジ サーバーで配信元サーバーからの資産のバックグラウンド取得が開始されます。 その後、資産はエッジ サーバーのローカル キャッシュに入れられます。 完全なオブジェクトがキャッシュに入ると、エッジ サーバーは CDN へのキャッシュ オブジェクトのバイト範囲要求を満たすことになります。

**Azure CDN Premium from Verizon** では、ルール エンジンを通じて既定の動作を無効化できます。

### <a name="peer-cache-fill-hot-filing"></a>ピア キャッシュ入力のホットファイリング

既定のピア キャッシュ入力のホットファイリング機能には、独自の高度なアルゴリズムが採用されています。 帯域幅に基づいて追加のエッジ キャッシュ サーバーを使用し、要求メトリックを集計して、サイズが大きく、利用頻度の高いオブジェクトに対するクライアント要求を満たします。 この機能により、多数の追加要求がユーザーの配信元サーバーに送信される状況を防ぐことができます。 

### <a name="conditions-for-large-file-optimization"></a>大きなファイルの最適化の条件

一般的な Web 配信の最適化を使用すると、**Azure CDN Standard from Verizon** および **Azure CDN Premium from Verizon** の大きなファイルの最適化機能が既定で有効になります。 最大ファイル サイズの上限はありません。 


## <a name="optimize-for-delivery-of-large-files-with-azure-cdn-standard-from-akamai"></a>Azure CDN Standard from Akamai を使った大きなファイルの配信の最適化

**Azure CDN Standard from Akamai** プロファイル エンドポイントでは、大きなファイルを世界中のユーザーに大規模かつ効率的に配信する機能を提供しています。 この機能では、配信元サーバーの負荷を軽減することで、待ち時間が短縮されます。

大きなファイルの最適化機能があれば、大きなファイルをより高速に、かつ高い応答性で配信するネットワーク最適化と構成を有効にできます。 **Azure CDN Standard from Akamai** エンドポイントによる一般的な Web 配信では 1.8 GB 以下のファイルのみがキャッシュされ、150 GB までのファイルがトンネル (キャッシュではなく) されます。 大きなファイルの最適化では 150 GB までのファイルがキャッシュされます。

大きなファイルの最適化は、特定の条件が満たされた場合に有効になります。 配信元サーバーの動作や、要求されたファイルの種類とサイズなどが条件になります。 

### <a name="configure-an-akamai-cdn-endpoint-to-optimize-delivery-of-large-files"></a>大きなファイルの配信を最適化するための Akamai CDN エンドポイントの構成

**Azure CDN Standard from Akamai** エンドポイントは、Azure Portal 経由での大きなファイルの配信を最適化するように構成できます。 REST API またはクライアント SDK を使用してこれを行うこともできます。 次の手順は、Azure Portal を使用した、**Azure CDN Standard from Akamai** プロファイルのプロセスを示しています。

1. 新しいエンドポイントを追加するには、Akamai の **[CDN プロファイル]** ページで **[エンドポイント]** を選択します。

    ![新しいエンドポイント](./media/cdn-large-file-optimization/cdn-new-akamai-endpoint.png)    
 
2. **[最適化対象]** ドロップダウン リストで、 **[大容量ファイルのダウンロード]** を選択します。

    ![大きなファイルの最適化を選択](./media/cdn-large-file-optimization/cdn-large-file-select.png)


CDN エンドポイントを作成すると、特定の条件に一致するすべてのファイルに対して大きなファイルの最適化が適用されます。 次のセクションでは、この処理について詳しく説明します。

### <a name="object-chunking"></a>オブジェクト チャンク 

**Azure CDN Standard from Akamai** による大きなファイルの最適化では、オブジェクト チャンクと呼ばれる方法が採用されています。 大きなファイルが要求されると、CDN は配信元からファイルを分割して取得します。 CDN POP サーバーが完全なファイルの要求またはバイト範囲を指定したファイルの要求を受け取ると、そのファイルの種類がこの最適化でサポートされているかどうかがチェックされます。 さらに、ファイルの種類がファイル サイズの要件を満たしているかどうかもチェックされます。 ファイル サイズが 10 MB より大きい場合、CDN エッジ サーバーは、2 MB のチャンク単位で配信元にファイルを要求します。 

CDN エッジに届いたチャンクはキャッシュされ、即座にユーザーに提供されます。 その後、CDN は並列処理で次のチャンクをプリフェッチします。 このプリフェッチにより、コンテンツはチャンク 1 つ分だけ常にユーザーより先行することになるため、待ち時間が短縮されます。 この処理は、ファイル全体がダウンロードされるか (要求があった場合)、すべてのバイト範囲が利用可能になるか (要求があった場合)、クライアントが接続を終了するまで続けられます。 

バイト範囲の要求の詳細については、[RFC 7233](https://tools.ietf.org/html/rfc7233) をご覧ください。

CDN は受信したチャンクをすべてキャッシュします。 ファイル全体を CDN のキャッシュに保存する必要はありません。 ファイルまたはバイト範囲に対する後続の要求は CDN キャッシュから処理されます。 すべてのチャンクが CDN にキャッシュされていない場合、プリフェッチを使用して配信元にチャンクが要求されます。 この最適化は、配信元サーバーのバイト範囲要求をサポートする機能に依存します。配信元サーバーがバイト範囲要求をサポートしていない場合、この最適化の効果はありません。

### <a name="caching"></a>キャッシュ
大きなファイルの最適化で使用する既定のキャッシュの有効期限は、一般的な Web 配信のものと異なります。 HTTP 応答コードに基づいて、正のキャッシュと負のキャッシュを区別します。 配信元サーバーが応答の cache-control または expires ヘッダーで有効期限を指定している場合、CDN はその値を優先させます。 配信元で指定されず、ファイルがこの最適化の種類のファイルの種類とサイズの条件と一致する場合、CDN は大きいファイルの最適化に既定値を使います。 それ以外の場合は、CDN は一般的な Web 配信用の既定値を使います。


|    | 一般 Web | 大きなファイルの最適化 
--- | --- | --- 
キャッシュ: 正の値 <br> HTTP 200、203、300、 <br> 301、302、410 | 7 日 |1 日  
キャッシュ: 負の値 <br> HTTP 204、305、404、 <br> 405 | なし | 1 秒 

### <a name="deal-with-origin-failure"></a>配信元のエラーの処理

配信元の読み取りタイムアウトの長さは、一般的な Web 配信の場合は 2 秒ですが、大きなファイルの最適化では 2 分に延長されます。 このように長めに設定されたことにより、大きなファイル サイズの場合でも、接続中のタイムアウトを回避できます。

接続がタイムアウトになると、CDN は一定回数再試行した後、クライアントに「504 ゲートウェイ タイムアウト」エラーを送信します。 

### <a name="conditions-for-large-file-optimization"></a>大きなファイルの最適化の条件

次の表に、大きなファイルの最適化で満たす必要のある一連の条件を示します。

条件 | 値 
--- | --- 
サポートされるファイルの種類 | 3g2、3gp、asf、avi、bz2、dmg、exe、f4v、flv、 <br> gz、hdp、iso、jxr、m4v、mkv、mov、mp4、 <br> mpeg、mpg、mts、pkg、qt、rm、swf、tar、 <br> tgz、wdp、webm、webp、wma、wmv、zip  
ファイルの最小サイズ | 10 MB 
ファイルの最大サイズ | 150 GB 
配信元サーバーの特性 | バイト範囲要求をサポートする必要があります 

## <a name="additional-considerations"></a>その他の注意点

この最適化を利用する場合は次のような点も考慮する必要があります。

- チャンクの処理では、配信元サーバーに対して追加の要求が生成されます。 ただし、配信元から配信されるデータの総量は大幅に小さくなります。 チャンク処理により、CDN でのキャッシュ特性が改善されます。

- ファイルが分割されて配信されるため、配信元のメモリと I/O の負荷が軽減されます。

- CDN でキャッシュされるチャンクの場合、コンテンツの有効期限が切れるか、キャッシュから削除まで、配信元への追加の要求は発生しません。

- ユーザーは CDN に対して範囲要求を行うことができ、それは通常のファイルと同様に扱われます。 最適化は、バイト範囲が 10 MB ～ 150 GB の有効なファイルの種類の場合にのみ適用されます。 要求されたファイルの平均サイズが 10 MB より小さい場合は、代わりに一般的な Web 配信を使用します。

