---
title: Windows Virtual Desktop のサービス品質 (QoS) を実装する (プレビュー)
titleSuffix: Azure
description: Windows Virtual Desktop の QoS (プレビュー) を設定する方法について説明します。
author: gundarev
ms.topic: conceptual
ms.date: 11/16/2020
ms.author: denisgun
ms.openlocfilehash: b61faf74d96e2571e91f7bf9d10eac88cdbf8345
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/29/2021
ms.locfileid: "94639127"
---
# <a name="implement-quality-of-service-qos-for-windows-virtual-desktop-preview"></a>Windows Virtual Desktop のサービス品質 (QoS) を実装する (プレビュー)

> [!IMPORTANT]
> Windows Virtual Desktop のサービス品質 (QoS) ポリシーのサポートは、現在パブリック プレビューの段階にあります。
> このプレビューはサービス レベル アグリーメントなしで提供されており、運用環境のワークロードに使用することはお勧めできません。 特定の機能はサポート対象ではなく、機能が制限されることがあります。
> 詳しくは、[Microsoft Azure プレビューの追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)に関するページをご覧ください。

[RDP Shortpath](./shortpath.md) は、リモート デスクトップ クライアントとセッション ホスト間の直接 UDP ベースのトランスポートを提供します。 RDP Shortpath を使用すると、RDP データ用のサービス品質 (QoS) ポリシーを構成できます。
Windows Virtual Desktop の QoS を使用すると、ネットワークの遅延に影響を受けるリアルタイム RDP トラフィックが、トラフィックの前に重要度の低いトラフィックの前に "横入り" することができます。 このような機密性の低いトラフィックの例としては、新しいアプリをダウンロードすることが挙げられます。この場合、ダウンロード時間が少し増えることが大きな問題になることはあまりありません。 QoS は Windows グループ ポリシー オブジェクトを使用してすべてのパケットをリアルタイム ストリームで識別してマークし、ネットワークが帯域幅の専用の部分を RDP トラフィックに提供できるようにします。

大規模なユーザー グループをサポートしており、この記事で説明されている問題のいずれかが発生している場合は、QoS を実装する必要がある可能性があります。 ユーザー数が少ない小規模企業では、QoS を必要としない場合がありますが、その場合でも利便性はあります。

何らかの形式の QoS を使用しないと、次のような問題が発生する可能性があります。

* ジッター: RDP パケットが異なるレートで到着すると、ビジュアルとオーディオの異常が発生する可能性があります。
* パケット損失: パケットが脱落します。これが発生すると、再伝送に時間がかかります。
* ラウンドトリップ時間 (RTT) の遅延: RDP パケットが宛先に到達するのに長い時間がかかります。これが発生すると、リモート アプリケーションからの入力と応答の間に顕著な遅延が発生します。

これらの問題に対処するための最も簡単な方法は、データ接続のサイズをインターネットの内外の両方で拡張することです。 これにはコストがかかることが多いため、QoS を使用すると、帯域幅を追加する代わりに、使用しているリソースをより効果的に管理できます。 品質の問題に対処するには、最初に QoS を使用してから、必要な場合にのみ帯域幅を追加することをお勧めします。

QoS を有効にするには、組織全体で一貫した QoS 設定を適用する必要があります。 QoS の優先順位をサポートできないパスの部分では、RDP セッションの品質が低下する可能性があります。

## <a name="introduction-to-qos-queues"></a>QoS キューの概要

QoS を提供するには、ネットワーク デバイスにトラフィックを分類する方法が必要であり、RDP を他のネットワーク トラフィックと区別できる必要があります。

ネットワーク トラフィックがルーターに入ったときに、トラフィックはキューに配置されます。 QoS ポリシーが構成されていない場合、キューは 1 つのみであり、すべてのデータは同じ優先順位の先入れ、先出しとして扱われます。 つまり、RDP トラフィックは、ミリ秒単位の遅延が増えても問題にならないトラフィックの後ろで止まる可能性があります。

QoS を実装するときは、Cisco の優先順位付けキューや [Class-Based Weighted Fair Queueing (CBWFQ)](https://www.cisco.com/en/US/docs/ios/12_0t/12_0t5/feature/guide/cbwfq.html#wp17641) などのいくつかの輻輳管理機能のいずれかと、[重み付けランダム早期検出 (WRED)](https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/qos_conavd/configuration/15-mt/qos-conavd-15-mt-book/qos-conavd-cfg-wred.html) などの輻輳回避機能を使用して、複数のキューを定義します。

わかりやすく例えると、QoS は、データ ネットワークに仮想 "相乗りレーン" を作成します。 そのため、データの種類によっては、遅延が発生することはまったく、またはほとんどありません。 これらのレーンを作成すると、組織のユーザーにビジネス レベルのエクスペリエンスを提供しながら、それらの相対的サイズを調整し、必要な接続帯域幅をより効率的に管理できます。

## <a name="qos-implementation-checklist"></a>QoS 実装チェックリスト

大まかには、次の手順を実行して QoS を実装します。

1. [ネットワークが動作していることを確認](#make-sure-your-network-is-ready)
2. [RDP Shortpath が有効になっていることを確認](./shortpath.md): QoS ポリシーは、リバース接続トランスポートではサポートされていません
3. セッション ホストでの [DSCP マーカーの挿入を実装](#insert-dscp-markers)

QoS を実装する準備として、次のガイドラインに留意してください。

* セッション ホストへのパスが短いほどいい
* プロキシやパケット検査デバイスなど、間に障害があることは推奨されない

## <a name="make-sure-your-network-is-ready"></a>ネットワークが動作していることを確認する

QoS の実装を検討している場合は、帯域幅の要件と、その他の[ネットワーク要件](/windows-server/remote/remote-desktop-services/network-guidance?context=/azure/virtual-desktop/context/context)を確認しておく必要があります。
  
ネットワーク上のトラフィックの輻輳は、メディアの品質に大きく影響します。 帯域幅が不足していると、パフォーマンスが低下し、ユーザー エクスペリエンスが低下します。 Windows Virtual Desktop の導入と使用量が増えるにつれて、[ログ分析](./diagnostics-log-analytics.md)を使用して問題を特定し、QoS と選択的帯域幅の追加機能を使用して調整を行います。

### <a name="vpn-considerations"></a>VPN に関する考慮事項

QoS は、クライアントとセッション ホスト間のすべてのリンクに実装されている場合にのみ、期待どおりに機能します。 内部ネットワークで QoS を使用していて、ユーザーがリモートの場所からサインインした場合は、内部のマネージド ネットワーク内でのみ優先順位を付けることができます。 リモートの場所は仮想プライベート ネットワーク (VPN) を実装することによってマネージド接続を受けることができますが、VPN では本質的にパケットのオーバーヘッドが増加し、リアルタイムのトラフィックに遅延を発生させます。

複数の大陸にまたがるマネージド リンクを持つグローバルな企業では、これらのリンクの帯域幅は LAN に比べて制限されるため、QoS を強くお勧めします。

## <a name="insert-dscp-markers"></a>DSCP マーカーの挿入

セッション ホストに対し、グループ ポリシー オブジェクト (GPO) を使用して QoS を実装することで、特定の種類のトラフィックを識別する IP パケット ヘッダーに DSCP マーカーを挿入するように指示できます。 ルーターとその他のネットワーク デバイスは、これらのマーキングを認識し、トラフィックを優先度の高い個別のキューに配置するように構成できます。

DSCP マーキングは、郵便仕分けのときに、郵便を配送するための緊急度と、迅速に配送するために最適な並べ替え方法を示す切手のスタンプに例えることができます。 RDP ストリームに優先順位を付けるようにネットワークを構成すると、パケットの損失とパケットの遅延が大幅に減少します。

すべてのネットワーク デバイスで同じ分類、マーキング、および優先順位を使用すると、遅延、パケットの損失、ジッターを低減または排除することができます。 RDP の観点からすると、重要な構成手順は、パケットの分類とマーキングです。 ただし、エンドツーエンドの QoS を成功させるには、RDP 構成を基になるネットワーク構成に慎重に適合させる必要があります。
DSCP 値は、対応するように構成されたネットワークに、パケットまたはストリームを提供する優先順位を示します。

DSCP 値には 46 を使用することをお勧めします。これは、**優先転送 (EF)** DSCP クラスにマップされます。

### <a name="implement-qos-on-session-host-using-group-policy"></a>グループ ポリシーを使用したセッション ホストへの QoS の実装

グループ ポリシー内でポリシーベースのサービスの品質 (QoS) を使用して、事前に定義された DSCP 値を設定できます。

ドメインに参加しているセッション ホストの QoS ポリシーを作成するには、まず、グループ ポリシー管理がインストールされているコンピューターにサインインします。 [グループ ポリシーの管理] を開き ([スタート] をクリックし、[管理ツール] をポイントし、[グループ ポリシーの管理] を選択します)、次の手順を実行します。

1. [グループ ポリシーの管理] で、新しいポリシーを作成するコンテナーを見つけます。 たとえば、すべてのセッション ホスト コンピューターが **"セッション ホスト"** という名前の OU に配置されている場合、新しいポリシーをセッション ホスト OU に作成する必要があります。

2. 適切なコンテナーを右クリックし、 **[このドメインに GPO を作成し、このコンテナーにリンクする]** を選択します。

3. **[新しい GPO]** ダイアログ ボックスで、 **[名前]** ボックスに新しいグループ ポリシー オブジェクトの名前を入力し、 **[OK]** を選択します。

4. 新しく作成されたポリシーを右クリックし、 **[編集]** を選択します。

5. グループ ポリシー管理エディターで、 **[コンピューターの構成]** 、 **[Windows の設定]** の順に展開し、 **[ポリシーベースの QoS]** を右クリックして、 **[新規ポリシーの作成]** を選択します。

6. **[ポリシーベースの QoS]** ダイアログ ボックスの開始ページで、 **[名前]** ボックスに新しいポリシーの名前を入力します。 **[Specify DSCP Value]\(DSCP 値の指定\)** を選択し、値を「**46**」に設定します。 **[Specify Outbound Throttle Rate]\(送信スロットル レートの指定\)** をオフのままにして、 **[次へ]** を選択します。

7. 次のページで、 **[次の実行可能ファイル名を持つアプリケーションのみ]** を選択し、**svchost.exe** の名前を入力して、 **[次へ]** を選択します。 この設定によって、リモート デスクトップ サービスからの一致するトラフィックにのみ優先順位を付けるように、ポリシーに指示されます。

8. 3 番目のページで、 **[すべての発信元 IP アドレス]** と **[すべての宛先 IP アドレス]** が選択されていることを確認し、 **[次へ]** を選択します。 この 2 つの設定により、パケットを送信するコンピューター (IP アドレス) とパケットを受信するコンピューター (IP アドレス) に関係なく、パケットが管理されるようになります。

9. 4 ページ目で、 **[UDP]** を **[この QoS ポリシーを適用するプロトコルを選択してください]** ドロップダウン リストから選択します。

10. **[宛先ポート番号を指定してください]** の見出しの下で、 **[次の発信元ポート番号か範囲]** を選択します。 付随するテキストボックスに、「**3390**」と入力します。 **[完了]** を選択します。

作成した新しいポリシーは、セッション ホスト コンピューターでグループ ポリシーが更新されるまで有効にはなりません。 グループ ポリシーは定期的に更新されますが、次の手順を実行して即時に更新を適用できます。

1. グループ ポリシーを更新する各セッション ホストで、管理者としてコマンド プロンプトを開きます ( *[管理者として実行]* )。

1. コマンド プロンプトに、次のコマンドを入力します。

   ```console
   gpupdate /force
   ```

### <a name="implement-qos-on-session-host-using-powershell"></a>PowerShell を使用してセッション ホストに QoS を実装する

次の PowerShell コマンドレットを使用して、RDP Shortpath に QoS を設定できます。

```powershell
New-NetQosPolicy -Name "RDP Shortpath" -AppPathNameMatchCondition "svchost.exe" -IPProtocolMatchCondition UDP -IPSrcPortStartMatchCondition 3390 -IPSrcPortEndMatchCondition 3390 -DSCPAction 46 -NetworkProfile All
```

## <a name="related-articles"></a>関連記事

* [サービスの品質 (QoS) ポリシー](/windows-server/networking/technologies/qos/qos-policy-top)

## <a name="next-steps"></a>次のステップ

* Windows Virtual Desktop の帯域幅の要件の詳細については、[Windows Virtual Desktop のリモート デスクトップ プロトコル (RDP) 帯域幅の要件の概要](rdp-bandwidth.md)に関するトピックを参照してください。
* Windows Virtual Desktop のネットワーク接続の詳細については、「[Windows Virtual Desktop のネットワーク接続について](network-connectivity.md)」を参照してください。
