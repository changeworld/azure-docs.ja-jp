---
title: Windows Virtual Desktop のディザスター リカバリー プランを設定する - Azure
description: Windows Virtual Desktop のデプロイのために事業継続とディザスター リカバリー プランを設定する方法。
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: how-to
ms.date: 10/09/2020
ms.author: helohr
manager: femila
ms.openlocfilehash: 18089bc00e9d02087acb149511fbc2c55077c153
ms.sourcegitcommit: 56b0c7923d67f96da21653b4bb37d943c36a81d6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2021
ms.locfileid: "106446929"
---
# <a name="set-up-a-business-continuity-and-disaster-recovery-plan"></a>事業継続とディザスター リカバリー プランを設定する

組織のデータを安全な状態に保つために、事業継続とディザスター リカバリー (BCDR) 戦略を採用する必要がある場合があります。 確実な BCDR 戦略により、計画的および計画外のサービスまたは Azure の停止中にアプリとワークロードの稼働状態が保たれます。

停止中に顧客のメタデータを保持するために、Windows Virtual Desktop サービス用の BCDR が Windows Virtual Desktop によって提供されます。 リージョンが停止すると、サービス インフラストラクチャ コンポーネントはセカンダリ ロケーションにフェールオーバーされ、通常どおりに機能し続けます。 引き続きサービス関連のメタデータにアクセスでき、ユーザーは引き続き利用可能なホストに接続できます。 エンドユーザー接続は、テナント環境またはホストにアクセスできる限り、オンラインのままになります。

リージョンの停止中に確実にユーザーが引き続き接続できるようにするには、仮想マシン (VM) を別の場所にレプリケートする必要があります。 停止中に、プライマリ サイトはセカンダリ ロケーションのレプリケートされた VM にフェールオーバーされます。 ユーザーは中断されることなく、引き続きセカンダリ ロケーションからアプリにアクセスできます。 VM のレプリケーションに加え、セカンダリ ロケーションでユーザー ID にアクセスできる状態を保つ必要があります。 プロファイル コンテナーを使用している場合は、それらをレプリケートする必要もあります。 最後に、プライマリ ロケーションのデータに依存するすべてのビジネス アプリを、確実にデータの残りの部分と共にフェールオーバーできるようにします。

つまり、停止中にユーザーの接続を保つには、次のことをこの順序で行う必要があります。

- セカンダリ ロケーションに VM をレプリケートします。
- プロファイル コンテナーを使用している場合は、セカンダリ ロケーションにデータのレプリケーションを設定します。
- プライマリ ロケーションに設定したユーザー ID が、セカンダリ ロケーションで利用可能であることを確認します。
- プライマリ ロケーションのデータに依存する基幹業務アプリケーションが、セカンダリ ロケーションにフェールオーバーされていることを確認します。

## <a name="vm-replication"></a>VM レプリケーション

まず、セカンダリ ロケーションに VM をレプリケートする必要があります。 これを行うためのオプションは、VM の構成方法によって異なります。

- Azure Site Recovery を使用して、個人用とプールされたホスト プールの両方に対してすべての VM を構成できます。 この方法の場合、必要なのは、1 つのホスト プールとそれに関連するアプリ グループおよびワークスペースを設定することだけです。
- フェールオーバーの場所にあるすべてのリソースをオフにしたままで、フェールオーバー リージョンに新しいホスト プールを作成することができます。 この方法の場合、フェールオーバー リージョンに新しいアプリ グループとワークスペースを設定する必要があります。 その後、Azure Site Recovery プランを使用して、ホスト プールをオンにすることができます。
- フェールオーバー リージョン内の VM をオフにしたままで、プライマリおよびフェールオーバー リージョンの両方にビルドされた VM によって設定されるホスト プールを作成することができます。 この場合、必要なのは、1 つのホスト プールとそれに関連するアプリ グループとワークスペースを設定することだけです。 Azure Site Recovery プランを使用して、この方法でホスト プールの電源をオンにすることができます。

「[Azure から Azure へのディザスター リカバリー](../site-recovery/azure-to-azure-architecture.md)」で説明されているように、他の Azure の場所での VM のレプリケーションを管理するには、[Azure Site Recovery](../site-recovery/site-recovery-overview.md) を使用することをお勧めします。 Azure Site Recovery によって[サーバーベースとクライアントベースの両方の SKU](../site-recovery/azure-to-azure-support-matrix.md#replicated-machine-operating-systems) がサポートされるため、個人用ホスト プールには特に Azure Site Recovery を使用することをお勧めします。

Azure Site Recovery を使用する場合は、これらの VM を手動で登録する必要はありません。 セカンダリ VM の Windows Virtual Desktop エージェントによって、最も近いサービス インスタンスに接続するために最新のセキュリティ トークンが自動的に使用されます。 セカンダリ ロケーションの VM (セッション ホスト) は、自動的にホスト プールの一部になります。 エンドユーザーはプロセス中に再接続する必要がありますが、その他の手動操作はありません。

停止中に既存のユーザー接続が存在する場合は、管理者がセカンダリ リージョンへのフェールオーバーを開始する前に、現在のリージョンのユーザー接続を終了する必要があります。

Windows Virtual Desktop (クラシック) でユーザーを切断するには、このコマンドレットを実行します。

```powershell
Invoke-RdsUserSessionLogoff
```

Azure 統合バージョンの Windows Virtual Desktop でユーザーを切断するには、このコマンドレットを実行します。

```powershell
Remove-AzWvdUserSession
```

プライマリ リージョンのすべてのユーザーをサインアウトしたら、プライマリ リージョンの VM をフェールオーバーして、ユーザーがセカンダリ リージョンの VM に接続できるようにすることができます。 このプロセスのしくみの詳細については、「[Azure VM を別の Azure リージョンにレプリケートする](../site-recovery/azure-to-azure-how-to-enable-replication.md)」を参照してください。

## <a name="virtual-network"></a>仮想ネットワーク

次に、停止中のネットワーク接続について考えます。 セカンダリ リージョンに仮想ネットワーク (VNET) を設定したことを確認する必要があります。 ユーザーがオンプレミスのリソースにアクセスする必要がある場合は、それらにアクセスするようにこの VNET を構成する必要があります。 VPN、ExpressRoute、または仮想 WAN を使用して、オンプレミス接続を確立することができます。

プライマリ ネットワークの設定が維持され、ピアリングは必要とされないため、Azure Site Recovery を使用してフェールオーバー リージョンに VNET を設定することをお勧めします。

## <a name="user-identities"></a>ユーザー ID

次に、ドメイン コントローラーを確実にセカンダリ ロケーションで使用できるようにします。 

ドメイン コントローラーを使用可能な状態に保つには、次の 3 つの方法があります。

   - セカンダリ ロケーションに Active Directory ドメイン コントローラーを配置する
   - オンプレミスの Active Directory ドメイン コントローラーを使用する
   - [Azure Site Recovery](../site-recovery/site-recovery-active-directory.md) を使用して Active Directory ドメイン コントローラーをレプリケートする

## <a name="user-and-app-data"></a>ユーザーおよびアプリ データ

プロファイル コンテナーを使用している場合、次の手順はセカンダリ ロケーションにデータのレプリケーションを設定することです。 FSLogix プロファイルを格納するための次の 5 つのオプションがあります。

   - 記憶域スペース ダイレクト (S2D)
   - ネットワーク ドライブ (追加のドライブがある VM)
   - Azure Files
   - Azure NetApp Files
   - レプリケーション用のクラウド キャッシュ

詳細については、「[Windows Virtual Desktop の FSLogix プロファイル コンテナーのストレージ オプション](store-fslogix-profile.md)」を参照してください。

プロファイルのディザスター リカバリーを設定する場合は、次のオプションがあります。

   - ネイティブの Azure レプリケーションを設定します (たとえば、Azure Files Standard ストレージ アカウントのレプリケーション、Azure NetApp Files のレプリケーション、ファイル サーバーの Azure Files Sync)。
    
     >[!NOTE]
     >NetApp のレプリケーションは、最初に設定した後は自動で行われます。 Azure Site Recovery プランの場合、VM 以外のリソースをフェールオーバーして Azure Storage リソースをレプリケートするために、事前スクリプトと事後スクリプトを追加できます。

   - アプリおよびユーザー データの両方に対して、FSLogix クラウド キャッシュを設定します。
   - 確実にビジネスクリティカルなデータに常にアクセスできるようにするために、アプリ データのみのディザスター リカバリーを設定します。 この方法を使用すると、停止が終了した後にユーザー データを取得できます。

各オプションのディザスター リカバリーを設定するように FSLogix を構成する方法を見てみましょう。

### <a name="fslogix-configuration"></a>FSLogix の構成

Fslogix のレジストリ エントリを構成する場合、FSLogix エージェントで複数のプロファイルの場所をサポートできます。

レジストリ エントリを構成するには、次のようにします。

1. **レジストリ エディター** を開きます。
2. **[コンピューター]**  >  **[HKEY_LOCAL_MACHINE]**  >  **[SOFTWARE]**  >  **[FSLogix]**  >  **[プロファイル]** の順に移動します。
   
     > [!div class="mx-imgBorder"]
     > ![レジストリ エディターの [プロファイル] ウィンドウのスクリーンショット。 VHDLocation が選択されています。](media/regedit-profiles.png)

3. **[VHDLocations]** を右クリックし、 **[複数行文字列の編集]** を選択します。

     > [!div class="mx-imgBorder"]
     > ![[複数行文字列の編集] ウィンドウのスクリーンショット。 [値のデータ] に、米国中部と米国東部の場所が一覧表示されています。](media/multi-string-edit.png)

4. **[値のデータ]** フィールドに、使用する場所を入力します。
5. 終了したら、 **[OK]** を選択します。

最初の場所が使用できない場合は、FSLogix エージェントにより、2 番目の場所などに自動的にフェールオーバーされます。

メイン リージョンのセカンダリ ロケーションへのパスを使用して、FSLogix エージェントを構成することをお勧めします。 プライマリ ロケーションがシャットダウンすると、FLogix エージェントによって、VM Azure Site Recovery レプリケーションの一部としてレプリケートされます。 レプリケートされた VM の準備が整うと、エージェントによって自動的に、セカンダリ リージョンへのパスが試されます。

たとえば、プライマリ セッション ホスト VM が米国中部リージョンにあり、パフォーマンス上の理由から、プロファイル コンテナーが米国中部リージョンにあるとします。

この場合は、米国中部のストレージへのパスを使用して、FSLogix エージェントを構成します。 セッション ホスト VM は、米国西部にレプリケートするように構成します。 米国中部へのパスが失敗すると、エージェントによって、代わりに米国西部のストレージの新しいパスの作成が試みられます。

### <a name="s2d"></a>S2D

S2D によってリージョン間のレプリケーションが内部的に処理されるため、セカンダリ パスを手動で設定する必要はありません。

### <a name="network-drives-vm-with-extra-drives"></a>ネットワーク ドライブ (追加のドライブがある VM)

セッション ホスト VM のように Azure Site Recovery を使用してネットワーク ストレージ VM をレプリケートする場合、復旧時に同じパスが保持されるため、FSlogix を再構成する必要はありません。

### <a name="azure-files"></a>Azure Files

Azure Files によって、ストレージ アカウントの作成時に指定できるリージョン間の非同期レプリケーションがサポートされます。 Azure Files の非同期の性質により、既にディザスター リカバリーの目標がカバーされている場合は、追加の構成を行う必要はありません。

データ損失を最小限に抑えるために同期レプリケーションが必要な場合は、代わりに FSLogix クラウド キャッシュを使用することをお勧めします。

>[!NOTE]
>このセクションでは、Azure Files のフェールオーバー認証メカニズムについては説明しません。

### <a name="azure-netapp-files"></a>Azure NetApp Files

Azure NetApp Files の詳細については、「[Azure NetApp Files のレプリケーション ピアリングを作成する](../azure-netapp-files/cross-region-replication-create-peering.md)」を参照してください。

## <a name="app-dependencies"></a>アプリ間の依存関係

最後に、プライマリ リージョンにあるデータに依存するすべてのビジネス アプリを、確実にセカンダリ ロケーションにフェールオーバーできるようにします。 また、必ず、アプリが新しい場所で動作するのに必要な設定を構成してください。 たとえば、アプリのいずれかが SQL バックエンドに依存している場合は、セカンダリ ロケーションに確実に SQL をレプリケートしてください。 フェールオーバー プロセスの一環として、または既定の構成として、セカンダリ ロケーションを使用するようにアプリを構成する必要があります。 Azure Site Recovery プランのアプリの依存関係をモデル化できます。 詳細については、「[復旧計画について](../site-recovery/recovery-plan-overview.md)」を参照してください。

## <a name="disaster-recovery-testing"></a>ディザスター リカバリー テスト

ディザスター リカバリーを設定した後、プランをテストして動作することを確認します。

プランのテスト方法に関するいくつかの推奨事項を次に示します。

- テスト VM からインターネットにアクセスできる場合、新しい接続のために既存のセッション ホストが引き継がれますが、元のセッション ホストへの既存の接続はすべてアクティブのままになります。 テストを実行する管理者が、プランをテストする前にすべてのアクティブ ユーザーをサインアウトしていることを確認してください。 
- メンテナンス期間中は、ユーザーを中断させないように完全なディザスター リカバリー テストのみを実行する必要があります。 テストの検証環境でホスト プールを使用することもできます。 
- テストですべてのビジネスクリティカルなアプリが対象になっていることを確認してください。
- 一度に最大 100 台の VM のみをフェールオーバーすることをお勧めします。 それよりも多くの VM がある場合は、それらを数回に分けて 10 分置きにフェイルオーバーすることをお勧めします。

## <a name="next-steps"></a>次のステップ

停止に関するプランに加え、データを安全な状態に保つ方法について不明な点がある場合は、[セキュリティ ガイド](security-guide.md)を確認してください。