---
title: "VPN を使用して Azure Stack を Azure に接続する"
description: "VPN を使用して Azure Stack 内の仮想ネットワークを Azure 内の仮想ネットワークに接続する方法です。"
services: azure-stack
documentationcenter: 
author: brenduns
manager: femila
editor: 
ms.assetid: 
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 9/25/2017
ms.author: brenduns
ms.reviewer: scottnap
ms.openlocfilehash: 16cc1962eb72ac219adc8483f38cecf41a4296c1
ms.sourcegitcommit: d87b039e13a5f8df1ee9d82a727e6bc04715c341
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/21/2018
---
# <a name="connect-azure-stack-to-azure-using-vpn"></a>VPN を使用して Azure Stack を Azure に接続する

*適用対象: Azure Stack 統合システム*

この記事では、Azure Stack 内の仮想ネットワークを Azure 内の仮想ネットワークに接続するサイト間 VPN を作成する方法を示します。

### <a name="connection-diagram"></a>接続図
次の図は、作業完了後の接続構成を表しています。

![サイト間 VPN 接続構成](media/azure-stack-connect-vpn/image2.png)

### <a name="before-you-begin"></a>開始する前に
接続構成を行うには、作業開始前に次のものを用意する必要があります。

* インターネットに直接接続された Azure Stack 統合システム (マルチノード) デプロイ。 つまり、使用する外部パブリック IP アドレス範囲にパブリック インターネットから直接到達できる必要があります。
* 有効な Azure サブスクリプション。  Azure サブスクリプションをお持ちでない場合は、[ここから無料の Azure アカウント](https://azure.microsoft.com/free/?b=17.06)を作成できます。

## <a name="network-example-values-table"></a>ネットワーク例の値の表
ネットワーク例の値の表は、この記事で使用されているサンプル値を示しています。 これらの値を使用するか、この値を参考にしながら、この記事の例を確認していくこともできます。

**ネットワーク例の値の表**
|   |Azure Stack|Azure|
|---------|---------|---------|
|仮想ネットワーク名     |Azs-VNet|AzureVNet |
|仮想ネットワークのアドレス空間 |10.1.0.0/16|10.100.0.0/16|
|サブネット名     |FrontEnd|FrontEnd|
|サブネットのアドレス範囲|10.1.0.0/24 |10.100.0.0/24 |
|ゲートウェイ サブネット     |10.1.1.0/24|10.100.1.0/24|

## <a name="create-the-network-resources-in-azure"></a>Azure でネットワーク リソースを作成する

まず、Azure 用のネットワーク リソースを作成します。 次の手順は、[Azure Portal](http://portal.azure.com/) を利用してリソースを作成する方法です。

### <a name="create-the-virtual-network-and-vm-subnet"></a>仮想ネットワークと VM サブネットを作成する

1. Azure アカウントを使用して [Azure Portal](http://portal.azure.com/) にサインインします。
2. ユーザー ポータルで、**[新規]** を選択します。
3. **[Marketplace]** に移動し、**[ネットワーク]** を選択します。
4. **[仮想ネットワーク]** を選択します。
5. ネットワーク構成表にある情報を利用し、Azure の **[名前]**、**[アドレス空間]**、**[サブネット名]**、**[サブネット アドレス範囲]** の値を特定します。
6. **[リソース グループ]** については、新しいものを作成するか、既存のリソース グループがある場合は **[既存のものを使用]** を選択します。
7. **[場所]** については、VNet の場所を選択します。  例の値を使用している場合は、**[米国東部]** を選択するか、必要に応じて別の場所を使用します。
8. **[ダッシュボードにピン留めする]** をオンにします。
9. **[作成]**を選択します。

### <a name="create-the-gateway-subnet"></a>ゲートウェイ サブネットを作成する
1. ダッシュボードから、作成した仮想ネットワーク リソース (**AzureVNet**) を開きます。
2. **[設定]** セクションで **[サブネット]** を選択します。
3. **[ゲートウェイ サブネット]** を選択し、ゲートウェイ サブネットを仮想ネットワークに追加します。
4. サブネットの名前は、既定で **GatewaySubnet** に設定されます。
   ゲートウェイ サブネットは特別であり、正しく動作するにはこの特定の名前である必要があります。
5. **[アドレス範囲]** フィールドでアドレスが **10.100.1.0/24** であることを確認します。
6. **[OK]** を選択し、ゲートウェイ サブネットを作成します。

### <a name="create-the-virtual-network-gateway"></a>仮想ネットワーク ゲートウェイを作成する
1. Azure Portal で **[新規]** を選択します。  
2. **[Marketplace]** に移動し、**[ネットワーク]** を選択します。
3. ネットワーク リソースの一覧から **[仮想ネットワーク ゲートウェイ]** を選択します。
4. **[名前]** に「**Azure-GW**」と入力します。
5. 仮想ネットワークを選択するには、**[仮想ネットワーク]** を選択します。 その後、一覧から **[AzureVnet]** を選択します。
6. **[パブリック IP アドレス]** を選択します。 **[パブリック IP アドレスの選択]** セクションが開いたら、**[新規作成]** を選択します。
7. **[名前]** に「**Azure-GW-PiP**」と入力し、**[OK]** を選択します。
8. 既定では、**[VPN の種類]** に **[ルート ベース]** が選択されています。
    VPN の種類は **[ルート ベース]** のままにします。
9. **[サブスクリプション]** と **[場所]** が正しいことを確認します。 リソースをダッシュボードにピン留めできます。 **[作成]**を選択します。

### <a name="create-the-local-network-gateway-resource"></a>ローカル ネットワーク ゲートウェイ リソースを作成する

1. Azure Portal で **[新規]** を選択します。 
4. **[Marketplace]** に移動し、**[ネットワーク]** を選択します。
5. リソースの一覧から **[ローカル ネットワーク ゲートウェイ]** を選択します。
6. **[名前]** に「**Azs-GW**」と入力します。
7. **[IP アドレス]** に、前述のネットワーク構成表にあった Azure Stack 仮想ネットワーク ゲートウェイのパブリック IP アドレスを入力します。
8. **[アドレス空間]** に、Azure Stack から、**AzureVNet** 用の **10.1.0.0/24** および **10.1.1.0/24** アドレス空間を入力します。
9. **[サブスクリプション]**、**[リソース グループ]**、**[場所]** がすべて正しいことを確認し、**[作成]** を選択します。

## <a name="create-the-connection"></a>接続の作成
1. ユーザー ポータルで、**[新規]** を選択します。 
2. **[Marketplace]** に移動し、**[ネットワーク]** を選択します。
3. リソースの一覧から **[接続]** を選択します。
4. **[基本]** 設定セクションで、**[接続の種類]** として **[サイト間 (IPSec)]** を選択します。
5. **[サブスクリプション]**、**[リソース グループ]**、**[場所]** を選択し、**[OK]** を選択します。
6. **[設定]** セクションで **[仮想ネットワーク ゲートウェイ]** を選択し、**[Azure-GW]** を選択します。
7. **[ローカル ネットワーク ゲートウェイ]** を選択し、**[Azs-GW]** を選択します。
8. **[接続名]** に「**Azure-Azs**」と入力します。
9. **[共有キー (PSK)]** に「**12345**」と入力します。 別の値を選択する場合は、接続の別の端で作成した共有キーの値と一致する*必要がある*ことに注意してください。 **[OK]**を選択します。
10. **[概要]** セクションを確認し、**[OK]** を選択します。

## <a name="create-a-virtual-machine"></a>仮想マシンの作成
ここでは Azure に仮想マシンを作成し、仮想ネットワーク内の VM サブネットにそれを配置します。

1. Azure Portal で **[新規]** を選択します。
2. **[Marketplace]** に移動し、**[計算]** を選択します。
3. 仮想マシンのイメージの一覧で、**Windows Server 2016 Datacenter Eval** イメージを選択します。
4. **[基本]** セクションで、**[名前]**に「**AzureVM**」と入力します。
5. 有効なユーザー名とパスワードを入力します。 このアカウントを利用し、作成後の仮想マシンにサインインします。
6. **[サブスクリプション]**、**[リソース グループ]**、**[場所]** を指定し、**[OK]** を選択します。
7. **[サイズ]** セクションで、この場合は仮想マシンのサイズを選択し、**[選択]** を選択します。
8. **[設定]** セクションは既定値のままでかまいません。 **AzureVnet** 仮想ネットワークが選択されていること、サブネットが **10.100.0.0/24** に設定されていることを確認します。 **[OK]**を選択します。
9. **[概要]** セクションで設定を確認し、**[OK]** を選択します。

## <a name="create-the-network-resources-in-azure-stack"></a>Azure Stack でネットワーク リソースを作成する
次に、Azure Stack でネットワーク リソースを作成します。

### <a name="sign-in-as-a-user"></a>ユーザーとしてサインインする
サービス管理者は、ユーザーが使用する可能性があるプラン、オファー、サブスクリプションをテストするためにユーザーとしてサインインできます。 まだ持っていない場合は、サインインする前に[ユーザー アカウントを作成](azure-stack-add-new-user-aad.md)します。

### <a name="create-the-virtual-network-and-vm-subnet"></a>仮想ネットワークと VM サブネットを作成する
1. ユーザー アカウントを使用してユーザー ポータルにサインインします。
2. ユーザー ポータルで、**[新規]** を選択します。

    ![新しい仮想ネットワークを作成する](media/azure-stack-create-vpn-connection-one-node-tp2/image3.png)

3. **[Marketplace]** に移動し、**[ネットワーク]** を選択します。
4. **[仮想ネットワーク]** を選択します。
5. **[名前]**、**[アドレス空間]**、**[サブネット名]**、**[サブネット アドレス範囲]** には、ネットワーク構成表にある値を使用します。
6. **[サブスクリプション]** には、先に作成したサブスクリプションが表示されます。
7. **[リソース グループ]** については、リソース グループを作成することも、既存のリソース グループがある場合に **[既存のものを使用]** を選択することもできます。
8. 既定の場所を確認します。
9. **[ダッシュボードにピン留めする]** をオンにします。
10. **[作成]**を選択します。

### <a name="create-the-gateway-subnet"></a>ゲートウェイ サブネットを作成する
1. ダッシュボードで、作成した Azs-VNet 仮想ネットワーク リソースを開きます。
2. **[設定]** セクションで **[サブネット]** を選択します。
3. ゲートウェイ サブネットを仮想ネットワークに追加するには、**[ゲートウェイ サブネット]** を選択します。
   
    ![ゲートウェイ サブネットを追加する](media/azure-stack-create-vpn-connection-one-node-tp2/image4.png)

4. 既定では、サブネット名は **GatewaySubnet** に設定されます。
   ゲートウェイ サブネットは特別です。 正常に機能するために、*GatewaySubnet* という名前を使用する必要があります。
5. **[アドレス範囲]** でアドレスが **10.1.1.0/24** であることを確認します。
6. **[OK]** を選択し、ゲートウェイ サブネットを作成します。

### <a name="create-the-virtual-network-gateway"></a>仮想ネットワーク ゲートウェイを作成する
1. Azure Stack ポータルで **[新規]** を選択します。 
2. **[Marketplace]** に移動し、**[ネットワーク]** を選択します。
3. ネットワーク リソースの一覧から **[仮想ネットワーク ゲートウェイ]** を選択します。
4. **[名前]** に「**Azs-GW**」と入力します。
5. **[仮想ネットワーク]** 項目を選択し、仮想ネットワークを選択します。
   一覧から **[Azs-VNet]** を選択します。
6. **[パブリック IP アドレス]** メニュー項目を選択します。 **[パブリック IP アドレスの選択]** セクションが開いたら、**[新規作成]** を選択します。
7. **[名前]** に「**Azs-GW-PiP**」と入力し、**[OK]** を選択します。
8.  既定では、**[VPN の種類]** に **[ルート ベース]** が選択されています。
    VPN の種類は **[ルート ベース]** のままにします。
9. **[サブスクリプション]** と **[場所]** が正しいことを確認します。 リソースをダッシュボードにピン留めできます。 **[作成]**を選択します。

### <a name="create-the-local-network-gateway"></a>ローカル ネットワーク ゲートウェイを作成する
Azure Stack における*ローカル ネットワーク ゲートウェイ*の概念は、Azure デプロイにおけるものと少し異なります。

Azure デプロイでは、ローカル ネットワーク ゲートウェイは、Azure の仮想ネットワーク ゲートウェイへの接続に使用するオンプレミスの (ユーザーの位置にある) 物理デバイスを表します。 Azure Stack では、接続の両端が仮想ネットワーク ゲートウェイになります。

これをより一般化すると、ローカル ネットワーク ゲートウェイ リソースは、常に接続の反対側の端にあるリモート ゲートウェイを示します。 

### <a name="create-the-local-network-gateway-resource"></a>ローカル ネットワーク ゲートウェイ リソースを作成する
1. Azure Stack ポータルにサインインします。
2. ユーザー ポータルで、**[新規]** を選択します。
3. **[Marketplace]** に移動し、**[ネットワーク]** を選択します。
4. リソースの一覧から **[ローカル ネットワーク ゲートウェイ]** を選択します。
5. **[名前]** に「**Azure-GW**」と入力します。
6. **[IP アドレス]** に、Azure 内の仮想ネットワーク ゲートウェイのパブリック IP アドレス (**Azure GW-PiP**) を入力します。 このアドレスは先のネットワーク構成表にありました。
7. **[アドレス空間]** で、作成した Azure VNET のアドレス空間用に「**10.100.0.0/24**」および「**10.100.1.0/24**」と入力します。
8. **[サブスクリプション]**、**[リソース グループ]**、**[場所]** がすべて正しいことを確認し、**[作成]** を選択します。

### <a name="create-the-connection"></a>接続の作成
1. ユーザー ポータルで、**[新規]** を選択します。
2. **[Marketplace]** に移動し、**[ネットワーク]** を選択します。
3. リソースの一覧から **[接続]** を選択します。
4. **[基本]** 設定セクションで、**[接続の種類]** として **[サイト間 (IPsec)]** を選択します。
5. **[サブスクリプション]**、**[リソース グループ]**、**[場所]** を選択し、**[OK]** を選択します。
6. **[設定]** セクションで **[仮想ネットワーク ゲートウェイ]** を選択し、**[Azs-GW]** を選択します。
7. **[ローカル ネットワーク ゲートウェイ]** を選択し、**[Azure-GW]** を選択します。
8. **[接続名]** に「**Azs-Azure**」と入力します。
9. **[共有キー (PSK)]** に「**12345**」と入力し、**[OK]** を選択します。
10. **[概要]** セクションで、**[OK]** を選択します。

### <a name="create-a-vm"></a>VM の作成
VPN 接続で送信されるデータを検証するには、VPN トンネル経由でデータを送受信する仮想マシンを両端で作成する必要があります。 

1. Azure Portal で **[新規]** を選択します。
2. **[Marketplace]** に移動し、**[計算]** を選択します。
3. 仮想マシンのイメージの一覧で、**Windows Server 2016 Datacenter Eval** イメージを選択します。
4. **[基本]** セクションで、**[名前]**に「**AzureVM**」と入力します。
5. 有効なユーザー名とパスワードを入力します。 このアカウントを利用し、作成後の VM にサインインします。
6. **[サブスクリプション]**、**[リソース グループ]**、**[場所]** を指定し、**[OK]** を選択します。
7. **[サイズ]** セクションで、この場合、仮想マシンのサイズを選択し、**[選択]** を選択します。
8. **[設定]** セクションは既定値のままにします。 **Azs-VNet** 仮想ネットワークが選択されていることを確認します。 サブネットが **10.1.0.0/24** に設定されていることを確認します。 **[OK]** をクリックします。
9. **[概要]** セクションで設定を確認し、**[OK]** を選択します。


## <a name="test-the-connection"></a>接続をテストする
サイト間接続が確立されたので、トラフィックがこの接続を経由できることをことを検証する必要があります。 検証するには、Azure Stack で作成した仮想マシンのいずれかにサインインします。 次に、Azure で作成した仮想マシンに ping を実行します。 

トラフィックがサイト間接続を通過するように、VIP ではなく、リモート サブネットの仮想マシンのダイレクト IP (DIP) に ping を実行します。 これを実行するには、接続の反対側の DIP アドレスを探します。 後で使用するためにアドレスを保存します。

### <a name="sign-in-to-the-user-vm-in-azure-stack"></a>Azure Stack 内のユーザー VM にサインインする
1. Azure Stack ポータルにサインインします。
2. 左側のナビゲーション バーから **[Virtual Machines]** を選択します。
3. VM の一覧で、先ほど作成した **Azs-VM** を探して選択します。
4. 仮想マシンのセクションで、**[接続]**をクリックし、Azx-VM.rdp ファイルを開きます。
   
     ![[接続] ボタン](media/azure-stack-create-vpn-connection-one-node-tp2/image17.png)
5. 仮想マシンの作成時に構成したアカウントでサインインします。
6. 管理者特権の **Windows PowerShell** ウィンドウを開きます。
7. 「**ipconfig /all**」と入力します。
8. 出力で **IPv4 アドレス**を見つけ、後で使用するためにそのアドレスを保存します。 これは Azure から ping を実行するアドレスです。 この例の環境ではアドレスは **10.1.0.4** ですが、実際の環境では異なる場合があります。 このアドレスは、先ほど作成した **10.1.0.0/24** サブネット内に含まれています。
9. 仮想マシンが ping に応答することを許可するファイアウォール ルールを作成するには、次の PowerShell コマンドを実行します。

   ```powershell
   New-NetFirewallRule `
    –DisplayName “Allow ICMPv4-In” `
    –Protocol ICMPv4
   ```

### <a name="sign-in-to-the-tenant-vm-in-azure"></a>Azure 内のテナント VM にサインインする
1. Azure ポータルにサインインします。
2. 左側のナビゲーション バーで、**[Virtual Machines]** をクリックします。
3. 仮想マシンの一覧で、先ほど作成した **Azure-VM** を探して選択します。
4. 仮想マシンのセクションで、**[接続]** をクリックします。
5. 仮想マシンの作成時に構成したアカウントでサインインします。
6. 管理者特権の **Windows PowerShell** ウィンドウを開きます。
7. 「**ipconfig /all**」と入力します。
8. **10.100.0.0/24** の範囲内にある IPv4 アドレスが表示されます。 この例の環境ではアドレスは **10.100.0.4**ですが、実際の環境では異なる場合があります。
9. 仮想マシンが ping に応答することを許可するファイアウォール ルールを作成するには、次の PowerShell コマンドを実行します。

   ```powershell
   New-NetFirewallRule `
    –DisplayName “Allow ICMPv4-In” `
    –Protocol ICMPv4
   ```

10. Azure 内の仮想マシンから、トンネル経由で Azure Stack 内の仮想マシンに ping を実行します。 これを行うには、Azs-VM から記録した DIP に ping を実行します。
   この例の環境ではこのアドレスは **10.1.0.4** ですが、必ずラボでメモしたアドレスに ping を実行するようにしてください。 結果は次のスクリーンショットのようになります。
   
    ![ping 成功](media/azure-stack-create-vpn-connection-one-node-tp2/image19b.png)
11. リモート仮想マシンからの応答は、テストが成功したことを示します。 仮想マシン ウィンドウを閉じてもかまいません。 ファイル コピーなど、他の種類のデータ転送を試し、接続をテストすることもできます。

### <a name="viewing-data-transfer-statistics-through-the-gateway-connection"></a>ゲートウェイ接続を使用したデータ転送の統計情報を表示する
サイト間接続を通過したデータの量を把握したい場合、**[接続]** セクションでこの情報を確認できます。 このテストは、先ほど送信した ping が実際に VPN 接続を通過したことを検証するためのもう 1 つの手段でもあります。

1. Azure Stack 内のユーザー仮想マシンにサインインしているとき、ユーザー アカウントを利用してユーザー ポータルにサインインします。
2. **[すべてのリソース]** に移動し、**Azs-Azure** 接続を選択します。 **[接続]** が表示されます。
4. **[接続]** セクションには、**[受信データ]** と **[送信データ]** の統計情報が表示されます。 次のスクリーンショットでは大きな数値を確認できますが、これは追加のファイル転送によるものです。 ここには 0 以外の値が表示されます。
   
    ![受信データと送信データ](media/azure-stack-connect-vpn/Connection.png)

## <a name="next-steps"></a>次の手順

[Azure と Azure Stack へのアプリのデプロイ](azure-stack-solution-pipeline.md)
