---
title: Azure Stack にデプロイされた VM の保護 | Microsoft Docs
description: Azure Stack にデプロイされた仮想マシンを保護する方法に関するガイドライン。
services: azure-stack
documentationcenter: ''
author: jeffgilb
manager: femila
editor: ''
ms.assetid: 4e5833cf-4790-4146-82d6-737975fb06ba
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 12/10/2018
ms.author: jeffgilb
ms.reviewer: hector.linares
ms.openlocfilehash: ab55ed73c7364b48f3159672ebee5d934365c92c
ms.sourcegitcommit: 5b869779fb99d51c1c288bc7122429a3d22a0363
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/10/2018
ms.locfileid: "53191531"
---
# <a name="protect-virtual-machines-deployed-on-azure-stack"></a>Azure Stack にデプロイされた仮想マシンの保護

この記事は、ユーザーが Azure Stack にデプロイする仮想マシン (VM) を保護するためのプランを作成するためのガイドとして使用します。

データ損失や計画外のダウンタイムから保護するには、ユーザー アプリケーションとそのデータのバックアップと回復またはディザスター リカバリー計画を実装する必要があります。 この計画はアプリケーションごとに一意である場合がありますが、組織の包括的なビジネス継続性およびディザスター リカバリー (BC/DR) 戦略によって確立されたフレームワークに従います。 最初に、「[回復性に優れた Azure 用アプリケーションの設計](https://docs.microsoft.com/azure/architecture/resiliency)」を参照することをお勧めします。ここでは、アプリケーションの可用性と回復性の一般的なパターンとプラクティスを紹介しています。

>[!IMPORTANT]
> バックアップと回復およびディザスター リカバリー計画を継続的にテストしてください。 これを実行して次のことを確認する必要があります。
> * 計画が正常に動作する
> * 計画がその基となったニーズを現在も満たしている

## <a name="azure-stack-infrastructure-recovery"></a>Azure Stack インフラストラクチャの復旧

ユーザーは、Azure Stack のインフラストラクチャ サービスとは別に自分の VM を保護する責任があります。

Azure Stack インフラストラクチャ サービスの回復計画には、ユーザー VM、ストレージ アカウント、またはデータベースの復旧は**含まれません**。 アプリケーションとデータの復旧計画は、アプリケーション所有者が実装する必要があります。

Azure Stack クラウドが長時間オフラインになっているか、永久に回復不能な状態の場合は、次のような回復計画を立てる必要があります。

* ダウンタイムを最小限に抑える
* 重要な VM (データベース サーバーなど) を実行したままにする
* アプリケーションが引き続きユーザー要求に対応できるようにする

Azure Stack クラウドのオペレーターは、基になる Azure Stack インフラストラクチャとサービスの回復計画を作成する役割を担います。 詳細については、「[致命的なデータ損失からの復旧](https://docs.microsoft.com/azure/azure-stack/azure-stack-backup-recover-data)」をご覧ください。

## <a name="sourcetarget-combinations"></a>ソースとターゲットの組み合わせ

各 Azure Stack クラウドは、1 つのデータ センターにデプロイされます。 アプリケーションを回復できるように、別の環境が必要になります。 この回復環境には、別のデータセンターの別の Azure Stack クラウドを使用することも、Azure パブリック クラウドを使用することもできます。 データの主権とデータのプライバシーの要件によって、アプリケーションの回復環境が決まります。 アプリケーションごとに保護を有効にすると、各アプリケーションに固有の回復オプションを柔軟に選択できます。 あるサブスクリプションのアプリケーションでは、別のデータ センターにデータをバックアップできます。 別のサブスクリプションでは、Azure パブリック クラウドにデータをレプリケートできます。

各アプリケーションのバックアップと回復およびディザスター リカバリー戦略を計画して、アプリケーションごとにターゲットを決定します。 回復計画により、組織はオンプレミスで必要なストレージ容量の設定とパブリック クラウドでの使用量の見積もりを適切に行うことができます。

|  | グローバル Azure | CSP のデータ センターにデプロイされ、CSP が運用する Azure Stack | お客様のデータ センターにデプロイされ、お客様が運用する Azure Stack |
|------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| **CSP のデータ センターにデプロイされ、CSP が運用する Azure Stack** | ユーザー VM は、CSP が運用する Azure Stack にデプロイされます。<br><br>ユーザー VM はバックアップから復元されるか、Azure に直接フェールオーバーされます。 | CSP が独自のデータ センターで Azure Stack のプライマリおよびセカンダリ インスタンスを運用します。<br><br>ユーザー VM は、2 つの Azure Stack インスタンス間で復元またはフェールオーバーされます。 | CSP がプライマリ サイトで Azure Stack を運用します。<br><br>お客様のデータ センターが、復元またはフェールオーバーのターゲットになります。 |
| **お客様のデータ センターにデプロイされ、お客様が運用する Azure Stack** | ユーザー VM は、お客様が運用する Azure Stack にデプロイされます。<br><br>ユーザー VM はバックアップから復元されるか、Azure に直接フェールオーバーされます。 | お客様がプライマリ サイトで Azure Stack を運用します。<br><br>CSP のデータ センターが、復元またはフェールオーバーのターゲットになります。 | お客様が独自のデータ センターで Azure Stack のプライマリおよびセカンダリ インスタンスを運用します。<br><br>ユーザー VM は、2 つの Azure Stack インスタンス間で復元またはフェールオーバーされます。 |

![ソースとターゲットの組み合わせ](media/azure-stack-manage-vm-backup/vm_backupdataflow_01.png)

## <a name="application-recovery-objectives"></a>アプリケーションの回復目標

組織がアプリケーションごとに許容できるダウンタイムとデータ損失の量を決定する必要があります。 ダウンタイムとデータ損失を定量化することで、障害による組織への影響を最小限に抑える回復計画を作成できます。 各アプリケーションについて、以下を検討します。

 - **目標復旧時間 (RTO)**  
RTO は、インシデントの発生後に、アプリケーションを使用不可状態にすることができる最大許容時間です。 たとえば、RTO が 90 分の場合、災害発生から 90 分以内にアプリケーションを実行状態に復元できなければならないことを意味します。 RTO を短くする場合は、リージョンの障害から保護するために、2 つ目のデプロイをスタンバイ状態で継続的に実行します。
 - **目標復旧時点 (RPO)**  
RPO は、障害発生時に許容できるデータ損失の最大期間です。 たとえば、単一のデータベースにデータを格納し、他のデータベースへのレプリケーションなしで、毎時のバックアップを実行する場合、最大 1 時間のデータを失う可能性があります。

RTO と RPO はビジネス要件です。 リスク評価を実施して、アプリケーションの RTO と RPO を定義します。

もう 1 つのメトリックは、**平均復旧時間** (MTTR) です。MTTR は、障害発生後にアプリケーションの復元にかかる平均時間です。 MTTR はシステムの経験値です。 MTTR が RTO を超えると、システム障害の結果、定義されている RTO 以内にシステムを復元できなくなるため、許容できないビジネスの中断が発生します。

### <a name="backup-restore"></a>バックアップと復元

VM ベースのアプリケーションの最も一般的な保護スキームは、バックアップ ソフトウェアを使用することです。 通常、VM のバックアップには、オペレーティング システム、オペレーティング システム構成、アプリケーション バイナリ、アプリケーション データが含まれます。 ボリューム、ディスク、または VM 全体のスナップショットを作成することで、バックアップが作成されます。 Azure Stack を使用すると、ゲスト OS のコンテキスト内または Azure Stack ストレージおよびコンピューティング API からバックアップする柔軟性が得られます。 Azure Stack では、ハイパーバイザー レベルでのバックアップの作成はサポートしていません。
 
![バックアップと復元](media/azure-stack-manage-vm-backup/vm_backupdataflow_03.png)

アプリケーションを回復するには、1 つ以上の VM を同じクラウドまたは新しいクラウドに復元する必要があります。 データ センターのクラウドをターゲットにすることも、パブリック クラウドをターゲットにすることもできます。 選択するクラウドは、データのプライバシーと主権の要件に基づいて、完全に制御できます。
 
 - RTO: 時間単位で測定されたダウンタイム
 - RPO: 変動するデータ損失 (バックアップの頻度に依存)
 - デプロイ トポロジ: アクティブ/パッシブ

#### <a name="planning-your-backup-strategy"></a>バックアップ戦略の計画

バックアップ戦略を計画し、スケール要件を定義するには、まず、保護する必要がある VM インスタンスの数を定量化します。 環境内のすべてのサーバーのすべての VM をバックアップするのが一般的な戦略です。 ただし、Azure Stack では、バックアップが必須なのは一部の VM だけです。 たとえば、スケール セット内の VM は、場合によっては予告なしに追加または削除される可能性がある一時的なリソースと見なされます。 保護する必要がある永続的なデータは、データベースやオブジェクト ストアなどの別のリポジトリに格納します。

Azure Stack の VM のバックアップに関する重要な考慮事項を次に示します。

 - **カテゴリ化**
    - ユーザーが VM のバックアップを選択するモデルを検討します。
    - アプリケーションの優先順位またはビジネスへの影響に基づいて回復のサービス レベル アグリーメント (SLA) を定義します。
 - **スケール**
    - 多数の新しい VM をオンボードするときは、時間を少しずつずらしたバックアップを検討します (バックアップが必要な場合)。
    - ソリューションのリソース コンテンツを最小限にするために、バックアップ データを効率的に取り込んで送信できるバックアップ製品を評価します。
    - 環境内のすべての VM での完全バックアップの必要性を最小限に抑えるために、増分バックアップまたは差分バックアップを使用してバックアップ データを効率的に保存するバックアップ製品を評価します。
 - **Restore**
    - バックアップ製品では、仮想ディスク、既存の VM 内のアプリケーション データ、または VM リソース全体と関連する仮想ディスクを復元できます。 必要な復元スキームは、アプリケーションをどのように復元するかによって異なり、アプリケーションの回復時間に影響を及ぼします。 たとえば、VM 全体または VM のセットを復元するのではなく、テンプレートから SQL Server を再デプロイし、データベースを復元する方が簡単な場合もあります。

### <a name="replicationmanual-failover"></a>レプリケーション/手動フェールオーバー

高可用性をサポートする別の方法として、アプリケーション VM を別のクラウドにレプリケートし、手動フェールオーバーを利用します。 オペレーティング システム、アプリケーション バイナリ、アプリケーション データのレプリケーションは、VM レベルまたはゲスト OS レベルで実行できます。 フェールオーバーの管理には、アプリケーションには含まれていないその他のソフトウェアが使用されています。

この方法を使用すると、アプリケーションはあるクラウドにデプロイされ、その VM は別のクラウドにレプリケートされます。 フェールオーバーがトリガーされた場合、2 つ目のクラウドでセカンダリ VM の電源をオンにする必要があります。 シナリオによっては、フェールオーバーによって VM が作成され、その VM にディスクがアタッチされます。 特に、特定の起動シーケンスを必要とする多層アプリケーションでは、このプロセスが完了するまでに長時間がかかる可能性があります。 アプリケーションが要求への対応を開始できる状態になる前に実行する必要がある手順もあります。

![レプリケーション/手動フェールオーバー](media/azure-stack-manage-vm-backup/vm_backupdataflow_02.png)

 - RTO: 分単位で測定されたダウンタイム
 - RPO: 変動するデータ損失 (レプリケーションの頻度に依存)
 - デプロイ トポロジ: アクティブ/パッシブ スタンバイ
 
### <a name="high-availabilityautomatic-failover"></a>高可用性/自動フェールオーバー

ビジネスで許容できるダウンタイムが数秒または数分であり、データ損失を最小限に抑える必要があるアプリケーションの場合、高可用性構成を検討する必要があります。 高可用性アプリケーションは、障害から迅速かつ自動的に回復するように設計されています。 ローカル ハードウェア障害に備えて、Azure Stack インフラストラクチャでは、2 つのトップ オブ ラック スイッチを使用して物理ネットワークで高可用性を実装します。 コンピューティング レベルの障害に備えて、Azure Stack はスケール ユニット内の複数のノードを使用します。 VM レベルでは、ノードの障害によってアプリケーションが停止しないように、スケール セットを障害ドメインと組み合わせてご利用いただけます。

スケール セットと組み合わせる場合、アプリケーションは高可用性をネイティブにサポートするか、クラスタリング ソフトウェアの使用をサポートする必要があります。 たとえば、Microsoft SQL Server では、同期コミット モードを使用してデータベースの高可用性をネイティブにサポートします。 ただし、非同期レプリケーションしかサポートできない場合は、一部のデータが失われます。 クラスタリング ソフトウェアがアプリケーションの自動フェールオーバーを処理するフェールオーバー クラスターに、アプリケーションをデプロイすることもできます。

この方法を使用すると、アプリケーションは 1 つのクラウドでのみアクティブですが、ソフトウェアは複数のクラウドにデプロイされます。 他のクラウドはスタンバイ モードであり、フェールオーバーがトリガーされたときに、アプリケーションを起動する準備ができています。

 - RTO: 秒単位で測定されたダウンタイム
 - RPO: 最小限のデータ損失
 - デプロイ トポロジ: アクティブ/アクティブ スタンバイ

### <a name="fault-tolerance"></a>フォールト トレランス

Azure Stack の物理的な冗長性とインフラストラクチャ サービスの可用性によって実現されるのは、ディスク、電源、ネットワーク ポート、ノードなどのハードウェア レベルの障害/エラーからの保護に限られます。 ただし、アプリケーションの可用性を常に維持する必要があり、データを一切失うことができない場合は、アプリケーションにフォールト トレランスをネイティブに実装するか、追加のソフトウェアを使用してフォールト トレランスを有効にする必要があります。

まず、ノード レベルの障害から保護するために、アプリケーション VM がスケール セットを使用してデプロイされていることを確認する必要があります。 オフラインになるクラウドから保護するには、同じアプリケーションが別のクラウドに既にデプロイされている必要があります。これにより、アプリケーションは中断なしに引き続き要求に対応できます。 通常、このモデルはアクティブ/アクティブ デプロイと呼ばれます。

各 Azure Stack クラウドは相互に独立しているため、インフラストラクチャの観点から、クラウドは常にアクティブと見なされることに留意してください。 この場合、アプリケーションの複数のアクティブなインスタンスが、1 つ以上のアクティブなクラウドにデプロイされます。

 - RTO: ダウンタイムなし
 - RPO: データ損失なし
 - デプロイ トポロジ: アクティブ/アクティブ

### <a name="no-recovery"></a>復旧不要

環境内の一部のアプリケーションは、計画外のダウンタイムやデータ損失から保護する必要がない場合があります。 たとえば、開発やテストに使用される VM は、通常、復旧する必要はありません。 アプリケーションまたは特定の VM の保護なしで済ませるかどうかは自由に決めることができます。 Azure Stack では、基になるインフラストラクチャからの VM のバックアップやレプリケーションは提供していません。 Azure と同様に、各サブスクリプションの VM ごとに保護を選択する必要があります。

 - RTO: 回復不能
 - RPO: 完全なデータ損失

## <a name="recommended-topologies"></a>推奨されるトポロジ

Azure Stack のデプロイに関する重要な考慮事項を次に示します。

|     | 推奨 | 説明 |
|-------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| データ センターに既にデプロイされている外部バックアップ ターゲットに VM をバックアップ/復元する | 推奨 | 既存のバックアップ インフラストラクチャと運用スキルを活用します。 追加の VM インスタンスをすぐに保護できるように、バックアップ インフラストラクチャのサイズを必ず設定します。 バックアップ インフラストラクチャが、ソースに近接する場所にないことを確認します。 VM は、ソース Azure Stack、セカンダリ Azure Stack インスタンス、または Azure に復元できます。 |
| Azure Stack 専用の外部バックアップ ターゲットに VM をバックアップ/復元する | 推奨 | 新しいバックアップ インフラストラクチャを購入することも、Azure Stack 専用のバックアップ インフラストラクチャをプロビジョニングすることもできます。 バックアップ インフラストラクチャが、ソースに近接する場所にないことを確認します。 VM は、ソース Azure Stack、セカンダリ Azure Stack インスタンス、または Azure に復元できます。 |
| グローバル Azure または信頼できるサービス プロバイダーに VM を直接バックアップ/復元する | 推奨 | データのプライバシーと規制の要件を満たすことができるのであれば、グローバル Azure または信頼できるサービス プロバイダーにバックアップを保存できます。 復元時の運用エクスペリエンスの一貫性を得るために、サービス プロバイダーも Azure Stack を実行しているのが理想的です。 |
| 別の Azure Stack インスタンスに VM をレプリケート/フェールオーバーする | 推奨 | フェールオーバーの場合、アプリケーションの長時間のダウンタイムを回避できるように、2 つ目の Azure Stack クラウドを完全に稼働させる必要があります。 |
| Azure または信頼できるサービス プロバイダーに VM を直接レプリケート/フェールオーバーする | 推奨 | データのプライバシーと規制の要件を満たすことができるのであれば、グローバル Azure または信頼できるサービス プロバイダーにデータをレプリケートできます。 フェールオーバー後の運用エクスペリエンスの一貫性を得るために、サービス プロバイダーも Azure Stack を実行しているのが理想的です。 |
| アプリケーション データがある同じ Azure Stack クラウドにバックアップ ターゲットをデプロイする | 推奨されません | 同じ Azure Stack クラウド内にバックアップを保存することは避けてください。 クラウドの計画外のダウンタイムによって、プライマリ データとバックアップ データにアクセスできなくなる可能性があります。 (バックアップと復元の最適化のために) バックアップ ターゲットを仮想アプライアンスとしてデプロイする場合は、すべてのデータが外部のバックアップの場所に継続的にコピーされていることを確認する必要があります。 |
| Azure Stack ソリューションがインストールされているラックに物理バックアップ アプライアンスを配置する | サポートされていません | 現時点では、元のソリューションに含まれていない他のデバイスを、トップ オブ ラック スイッチに接続することはできません。 |

## <a name="next-steps"></a>次の手順

この記事では、Azure Stack にデプロイされたユーザー VM を保護するための一般的なガイドラインについて説明しました。 Azure サービスを使用したユーザー VM の保護については、以下を参照してください。

 - [Azure Backup を使用してファイルやアプリケーションを Azure Stack にバックアップする](https://docs.microsoft.com/azure/backup/backup-mabs-files-applications-azure-stack)
 - [Azure Backup Server による Azure Stack のサポート](https://docs.microsoft.com/azure/backup/ ) 
 - [Azure Site Recovery による Azure Stack のサポート](https://docs.microsoft.com/azure/site-recovery/)  

Azure Stack の VM を保護するパートナー製品の詳細については、「[Protecting applications and data on Azure Stack (Azure Stack でのアプリケーションとデータの保護)](https://azure.microsoft.com/blog/protecting-applications-and-data-on-azure-stack/)」をご覧ください。
