---
title: 接続アーキテクチャ - Azure Database for MySQL
description: Azure Database for MySQL サーバーの接続アーキテクチャについて説明します。
author: Bashar-MSFT
ms.author: bahusse
ms.service: mysql
ms.topic: conceptual
ms.date: 2/11/2021
ms.openlocfilehash: 0197b533f80ccb1524de2bbb9fc5c642f2626bbc
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/19/2021
ms.locfileid: "104655259"
---
# <a name="connectivity-architecture-in-azure-database-for-mysql"></a>Azure Database for MySQL の接続アーキテクチャ
この記事では、Azure Database for MySQL 接続アーキテクチャと、Azure 内外の両方のクライアントからトラフィックがどのように Azure Database for MySQL インスタンスに転送されるかについて説明します。

## <a name="connectivity-architecture"></a>接続のアーキテクチャ
Azure Database for MySQL への接続は、受信接続をクラスター内のサーバーの物理的な場所にルーティングする役割を果たすゲートウェイ経由で確立されます。 次の図に、そのトラフィック フローを示します。

:::image type="content" source="./media/concepts-connectivity-architecture/connectivity-architecture-overview-proxy.png" alt-text="接続アーキテクチャの概要":::

クライアントがデータベースに接続すると、サーバーへの接続文字列がゲートウェイ IP アドレスに解決されます。 ゲートウェイは、ポート 3306 で、この IP アドレスでリッスンします。 データベース クラスター内では、トラフィックは適切な Azure Database for MySQL に転送されます。 そのため、企業ネットワークなどからサーバーに接続するには、**クライアント側のファイアウォールを開いて送信トラフィックがゲートウェイに到達できるようにする** 必要があります。 リージョンごとに Microsoft のゲートウェイで使用されている IP アドレスの完全な一覧を次に示します。

## <a name="azure-database-for-mysql-gateway-ip-addresses"></a>Azure Database for MySQL ゲートウェイの IP アドレス

ゲートウェイ サービスは、IP アドレスの背後にあるステートレス計算ノードのグループでホストされます。クライアントでは Azure Database for MySQL サーバーに接続しようとするときに、最初にこれにアクセスします。 

進行中のサービス メンテナンスの一環として、セキュリティとパフォーマンスが最も高いエクスペリエンスを提供できるように、Microsoft では、ゲートウェイがホストされているコンピューティング ハードウェアを定期的に更新しています。 ゲートウェイのハードウェアが更新されると、最初に計算ノードの新しいリングが構築されます。 この新しいリングは、新しく作成されたすべての Azure Database for MySQL サーバーのトラフィックを処理し、トラフィックを区別するために、同じリージョン内の以前のゲートウェイ リングとは異なる IP アドレスを持ちます。 新しいリングが完全に機能すると、既存のサーバーに対応している古いゲートウェイ ハードウェアでは使用停止が計画されます。 ゲートウェイ ハードウェアを使用停止にする前に、サーバーを実行し、以前のゲートウェイ リングに接続しているお客様に、使用停止の 3 か月前に電子メールと Azure portal で通知が行われます。 次の場合、ゲートウェイの使用停止により、サーバーへの接続に影響が生じる可能性があります。 

* ゲートウェイの IP アドレスをアプリケーションの接続文字列にハードコーディングしている。 これは **推奨されません**。 アプリケーションの接続文字列で、サーバーの完全修飾ドメイン名 (FQDN) を <servername>mysql.database.azure.com の形式で使用する必要があります。 
* 送信トラフィックが新しいゲートウェイ リングに到着できるようにクライアント側のファイアウォールで新しいゲートウェイ IP アドレスを更新していない。

次の表は、すべてのデータ リージョンの Azure Database for MySQL ゲートウェイのゲートウェイ IP アドレスを一覧にまとめたものです。 各リージョンのゲートウェイ IP アドレスの最新情報は、次の表に保持されています。 次の表で、列は以下を表しています。

* **ゲートウェイ IP アドレス:** この列には、最新世代のハードウェアでホストされているゲートウェイの現在の IP アドレスが一覧表示されます。 新しいサーバーをプロビジョニングする場合は、クライアント側のファイアウォールを開いて、この列に一覧表示されている IP アドレスの送信トラフィックを許可することをお勧めします。
* **ゲートウェイ IP アドレス (使用停止予定):** この列には、現在使用停止が予定されている古い世代のハードウェアでホストされているゲートウェイの IP アドレスが一覧表示されます。 新しいサーバーをプロビジョニングする場合は、これらの IP アドレスは無視してかまいません。 既存のサーバーがある場合は、まだ使用停止が完了していないので、これらの IP アドレスに対するファイアウォールのアウトバウンド規則を引き続き保持してください。 これらの IP アドレスに対するファイアウォール規則を削除すると、接続エラーが発生する可能性があります。 代わりに、使用停止の通知を受信したらすぐに、[ゲートウェイ IP アドレス] 列に一覧表示されている新しい IP アドレスを送信ファイアウォール規則に事前に追加する必要があります。 これにより、サーバーが最新のゲートウェイ ハードウェアに移行されるときに、サーバーへの接続が中断されることはなくなります。
* **ゲートウェイ IP アドレス (使用停止済み):** この列には、使用停止になって、もう使用されなくなったゲートウェイ リングの IP アドレスが一覧表示されます。 これらの IP アドレスは、送信ファイアウォール規則から安全に削除できます。 


| **リージョン名** | **ゲートウェイ IP アドレス** |**ゲートウェイ IP アドレス (使用停止予定)** | **ゲートウェイ IP アドレス (使用停止済み)** |
|:----------------|:-------------------------|:-------------------------------------------|:------------------------------------------|
| オーストラリア中部| 20.36.105.0  | | |
| オーストラリア中部 2     | 20.36.113.0  | | |
| オーストラリア東部 | 13.75.149.87、40.79.161.1     |  | |
| オーストラリア東南部 |191.239.192.109、13.73.109.251   |  | |
| ブラジル南部 |191.233.201.8、191.233.200.16    |  | 104.41.11.5|
| カナダ中部 |40.85.224.249  | | |
| カナダ東部 | 40.86.226.166    | | |
| 米国中部 | 23.99.160.139、52.182.136.37、52.182.136.38 | 13.67.215.62 | |
| 中国東部 | 139.219.130.35    | | |
| 中国東部 2 | 40.73.82.1  | | |
| 中国北部 | 139.219.15.17    | | |
| 中国北部 2 | 40.73.50.0     | | |
| 東アジア | 191.234.2.139、52.175.33.150、13.75.33.20、13.75.33.21     | | |
| 米国東部 |40.71.8.203、40.71.83.113 |40.121.158.30|191.238.6.43 |
| 米国東部 2 | 40.70.144.38、52.167.105.38  | 52.177.185.181 | |
| フランス中部 | 40.79.137.0、40.79.129.1  | | |
| フランス南部 | 40.79.177.0     | | |
| ドイツ中部 | 51.4.144.100     | | |
| ドイツ北部 | 51.116.56.0 | |
| ドイツ北東部 | 51.5.144.179  | | |
| ドイツ中西部 | 51.116.152.0 | |
| インド中部 | 104.211.96.159     | | |
| インド南部 | 104.211.224.146  | | |
| インド西部 | 104.211.160.80    | | |
| 東日本 | 40.79.192.23、40.79.184.8 | 13.78.61.196 | |
| 西日本 | 191.238.68.11、40.74.96.6、40.74.96.7     | 104.214.148.156 | |
| 韓国中部 | 52.231.17.13   | 52.231.32.42 | |
| 韓国南部 | 52.231.145.3     | 52.231.200.86 | |
| 米国中北部 | 52.162.104.35、52.162.104.36    | 23.96.178.199 | |
| 北ヨーロッパ | 52.138.224.6、52.138.224.7  | 40.113.93.91 |191.235.193.75 |
| 南アフリカ北部  | 102.133.152.0    | | |
| 南アフリカ西部 | 102.133.24.0   | | |
| 米国中南部 |104.214.16.39、20.45.120.0  |13.66.62.124  |23.98.162.75 |
| 東南アジア | 40.78.233.2、23.98.80.12     | 104.43.15.0 | |
| スイス北部 | 51.107.56.0 ||
| スイス西部 | 51.107.152.0||
| アラブ首長国連邦中部 | 20.37.72.64  | | |
| アラブ首長国連邦北部 | 65.52.248.0    | | |
| 英国南部 | 51.140.184.11   | | |
| 英国西部 | 51.141.8.11  | | |
| 米国中西部 | 13.78.145.25     | | |
| 西ヨーロッパ |13.69.105.208、104.40.169.187 | 40.68.37.158 | 191.237.232.75 |
| 米国西部 |13.86.216.212、13.86.217.212 |104.42.238.205  | 23.99.34.75|
| 米国西部 2 | 13.66.136.192 | 13.66.226.202  | | 
||||

## <a name="connection-redirection"></a>接続のリダイレクト

Azure Database for MySQL を使うと、クライアント アプリケーションと MySQL サーバーの間のネットワーク待機時間の短縮に役立つ、**リダイレクト** という追加接続ポリシーがサポートされます。 リダイレクトを使うと、Azure Database for MySQL サーバーに対する最初の TCP セッションが確立された後、MySQL サーバーがホストされているノードのバックエンド アドレスが、サーバーからクライアントに返されます。 その後、後続のパケットはすべて、ゲートウェイをバイパスして、サーバーに直接送信されます。 パケットがサーバーに直接送信されるため、待機時間とスループットのパフォーマンスが改善されます。

この機能は、エンジンのバージョンが 5.6、5.7、8.0 の Azure Database for MySQL サーバーでサポートされています。

リダイレクトのサポートは、Microsoft によって開発され、[PECL](https://pecl.php.net/package/mysqlnd_azure) から入手できる、PHP [mysqlnd_azure](https://github.com/microsoft/mysqlnd_azure) 拡張機能で利用できます。 アプリケーションでリダイレクトを使用する方法について詳しくは、[リダイレクトの構成](./howto-redirection.md)に関する記事をご覧ください。


> [!IMPORTANT]
> PHP [mysqlnd_azure](https://github.com/microsoft/mysqlnd_azure) 拡張機能でのリダイレクトのサポートは、現在プレビュー段階です。

## <a name="frequently-asked-questions"></a>よく寄せられる質問

### <a name="what-you-need-to-know-about-this-planned-maintenance"></a>この計画メンテナンスについて知っておくべきことは何ですか?
これは DNS のみの変更であるため、クライアントに対して透過的です。 FQDN の IP アドレスが DNS サーバーで変更されている間、オペレーティング システムによって、ローカル DNS キャッシュの更新が 5 分以内に自動的に実行されます。 ローカル DNS の更新後、すべての新しい接続は新しい IP アドレスに接続されます。既存のすべての接続は、以前の IP アドレスが完全に使用停止になるまで中断されることなく、以前の IP アドレスに接続されたままになります。 以前の IP アドレスが使用停止になるまでに約 3 から 4 週間かかるため、クライアント アプリケーションには影響しません。

### <a name="what-are-we-decommissioning"></a>何が使用停止になりますか?
ゲートウェイ ノードのみが使用停止になります。 ユーザーがサーバーに接続するときに、その接続が最初に到達するのはゲートウェイ ノードであり、次にサーバーに転送されます。 以前のゲートウェイ リングは使用停止予定です (サーバーが実行されているテナント リングではありません)。詳細については、「[接続のアーキテクチャ](#connectivity-architecture)」を参照してください。

### <a name="how-can-you-validate-if-your-connections-are-going-to-old-gateway-nodes-or-new-gateway-nodes"></a>接続先が以前のゲートウェイ ノードと新しいゲートウェイ ノードのどちらであるかを検証するにはどうすればよいですか?
サーバーの FQDN に対して ping を実行します (例: ``ping xxx.mysql.database.azure.com``)。 返された IP アドレスが、上のドキュメントの「ゲートウェイ IP アドレス (使用停止予定)」の下に一覧表示されている IP のいずれかである場合は、接続が以前のゲートウェイを通過していることを意味します。 反対に、返された IP アドレスが「ゲートウェイ IP アドレス」の下に一覧表示されている IP のいずれかである場合は、接続が新しいゲートウェイを通過していることを意味します。

また、[PSPing](https://docs.microsoft.com/sysinternals/downloads/psping) または TCPPing を使用して、クライアント アプリケーションからポート 3306 でデータベース サーバーをテストし、返される IP アドレスが使用停止予定の IP アドレスのいずれかでないことを確認することもできます

### <a name="how-do-i-know-when-the-maintenance-is-over-and-will-i-get-another-notification-when-old-ip-addresses-are-decommissioned"></a>メンテナンスの終了を知る方法はありますか? また、以前の IP アドレスが使用停止になったときには別の通知が届きますか?
メンテナンス作業の開始時期をお知らせする電子メールが届きます。 メンテナンスには、すべてのリージョン内の移行する必要があるサーバーの数に応じて、最大で 1 か月かかることがあります。 FQDN を使用するか、上の表の新しい IP アドレスを使用してデータベース サーバーに接続するように、お使いのクライアントを準備してください。 

### <a name="what-do-i-do-if-my-client-applications-are-still-connecting-to-old-gateway-server-"></a>クライアント アプリケーションがまだ以前のゲートウェイ サーバーに接続されている場合はどうすればよいですか?
これは、アプリケーションが FQDN ではなく静的 IP アドレスを使用してサーバーに接続されていることを示しています。 接続文字列と接続プールの設定、AKS の設定、さらにソース コード内を確認します。

### <a name="is-there-any-impact-for-my-application-connections"></a>アプリケーション接続に影響はありますか?
このメンテナンスは DNS のみの変更であるため、クライアントに対して透過的です。 クライアントで DNS キャッシュが更新されると (オペレーティング システムによって自動的に実行されます)、すべての新しい接続は新しい IP アドレスに接続されます。既存のすべての接続は、以前の IP アドレスが完全に使用停止になる (通常は数週間後) まで引き続き正常に動作します。 この場合、再試行ロジックは必要ありませんが、アプリケーションに再試行ロジックが構成されていることを確認することをお勧めします。 データベース サーバーへの接続に FQDN を使用するか、アプリケーションの接続文字列で新しい "ゲートウェイ IP アドレス" の一覧を有効にしてください。
このメンテナンス操作では、既存の接続は削除されません。 新しい接続要求が新しいゲートウェイ リングに送られるだけです。

### <a name="can-i-request-for-a-specific-time-window-for-the-maintenance"></a>メンテナンスに対して特定の時間枠をリクエストできますか? 
移行は透過的であり、お客様の接続に影響を与えることはないため、ほとんどのユーザーには問題がないことが予想されます。 アプリケーションを事前に確認して、データベース サーバーへの接続に FQDN が使用されているか、アプリケーションの接続文字列で新しい "ゲートウェイ IP アドレス" の一覧が有効になっていることを確認します。

### <a name="i-am-using-private-link-will-my-connections-get-affected"></a>プライベート リンクを使用していますが、接続に影響はありますか?
いいえ。これはゲートウェイ ハードウェアの使用停止であり、プライベート リンクまたはプライベート IP アドレスとは関係ありません。使用停止予定 IP アドレスの下に記載されているパブリック IP アドレスのみが影響されます。



## <a name="next-steps"></a>次のステップ
* [Azure Portal を使用した Azure Database for MySQL ファイアウォール規則の作成と管理](./howto-manage-firewall-using-portal.md)
* [Azure CLI を使用した Azure Database for MySQL ファイアウォール規則の作成と管理](./howto-manage-firewall-using-cli.md)
* [Azure Database for MySQL のリダイレクトを構成する](./howto-redirection.md)