---
title: ネットワーク トラフィックをフィルター処理する - チュートリアル - Azure portal
titlesuffix: Azure Virtual Network
description: このチュートリアルでは、ネットワーク セキュリティ グループと Azure portal を使用して、サブネットに対するネットワーク トラフィックをフィルター処理する方法について説明します。
services: virtual-network
author: KumudD
Customer intent: I want to filter network traffic to virtual machines that perform similar functions, such as web servers.
ms.service: virtual-network
ms.topic: tutorial
ms.date: 03/06/2021
ms.author: kumud
ms.openlocfilehash: 746e44c85d4dd9a662556a73f1e4ab0701d31400
ms.sourcegitcommit: 5bbc00673bd5b86b1ab2b7a31a4b4b066087e8ed
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/07/2021
ms.locfileid: "102435926"
---
# <a name="tutorial-filter-network-traffic-with-a-network-security-group-using-the-azure-portal"></a>チュートリアル: Azure portal を使用してネットワーク セキュリティ グループでネットワーク トラフィックをフィルター処理する

仮想ネットワーク サブネットのインバウンド ネットワーク トラフィックとアウトバウンド ネットワーク トラフィックは、ネットワーク セキュリティ グループを使用してフィルター処理することができます。

ネットワーク セキュリティ グループには、IP アドレス、ポート、およびプロトコルでネットワーク トラフィックをフィルター処理するセキュリティ規則が含まれています。 セキュリティ規則は、サブネットに展開されたリソースに適用されます。 

このチュートリアルでは、次の作業を行う方法について説明します。

> [!div class="checklist"]
> * ネットワーク セキュリティ グループと規則を作成する
> * 仮想ネットワークを作成し、ネットワーク セキュリティ グループをサブネットに関連付ける
> * 仮想マシン (VM) をサブネットに展開する
> * トラフィック フィルターをテストする

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。

## <a name="prerequisites"></a>前提条件

- Azure サブスクリプション。

## <a name="sign-in-to-azure"></a>Azure へのサインイン

Azure Portal ( https://portal.azure.com ) にサインインします。

## <a name="create-a-virtual-network"></a>仮想ネットワークの作成

1. ポータルの左上隅にある **[リソースの作成]** を選択します。

2. 検索ボックスに、「**仮想ネットワーク**」と入力します。 検索結果から **[仮想ネットワーク]** を選択します。

3. **[仮想ネットワーク]** ページで、 **[作成]** を選択します。

4. **[仮想ネットワークの作成]** の **[基本]** タブで次の情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | **プロジェクトの詳細** |   |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[新規作成]** を選択します。  </br> 「**myResourceGroup**」と入力します。 </br> **[OK]** を選択します。 |
    | **インスタンスの詳細** |   |
    | 名前 | 「**myVNet**」と入力します。 |
    | リージョン | **[(米国) 米国東部]** を選択します。 |

5. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

6. **［作成］** を選択します

## <a name="create-application-security-groups"></a>アプリケーション セキュリティ グループを作成する

アプリケーション セキュリティ グループを使用すると、Web サーバーなど、同様の機能を持つサーバーをグループ化できます。

1. ポータルの左上隅にある **[リソースの作成]** を選択します。

2. 検索ボックスに、「**Application security group**」と入力します。 検索結果から **[アプリケーションのセキュリティ グループ]** を選択します。

3. **[Application security group]** ページで、 **[作成]** を選択します。

4. **[アプリケーションのセキュリティ グループの作成]** の **[基本]** タブで、この情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    |**プロジェクトの詳細** |  |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[myResourceGroup]** を選択します。 |
    | **インスタンスの詳細** |  |
    | 名前 | 「**myAsgWebServers**」と入力します。 |
    | リージョン | **[(米国) 米国東部]** を選択します。 | 

5. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

6. **［作成］** を選択します

7. 手順 4. を繰り返し、次の値を指定します。

    | 設定 | 値 |
    | ------- | ----- |
    |**プロジェクトの詳細** |  |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[myResourceGroup]** を選択します。 |
    | **インスタンスの詳細** |  |
    | 名前 | 「**myAsgMgmtServers**」と入力します。 |
    | リージョン | **[(米国) 米国東部]** を選択します。 |

8. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

9. **［作成］** を選択します

## <a name="create-a-network-security-group"></a>ネットワーク セキュリティ グループの作成

ネットワーク セキュリティ グループは、仮想ネットワーク内のネットワーク トラフィックをセキュリティで保護するものです。

1. ポータルの左上隅にある **[リソースの作成]** を選択します。

2. [検索] ボックスに「**ネットワーク セキュリティ グループ**」と入力します。 検索結果から **[ネットワーク セキュリティ グループ]** を選択します。

3. **ネットワーク セキュリティ グループ** ページで、 **[作成]** を選択します。

4. **[ネットワーク セキュリティ グループの作成]** の **[基本]** タブで、この情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | **プロジェクトの詳細** |   |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[myResourceGroup]** を選択します。 |
    | **インスタンスの詳細** |   |
    | 名前 | 「**myNSG**」と入力します。 |
    | 場所 | **[(米国) 米国東部]** を選択します。 | 

5. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

6. **［作成］** を選択します

## <a name="associate-network-security-group-to-subnet"></a>ネットワーク セキュリティ グループをサブネットに関連付ける

このセクションでは、先ほど作成した仮想ネットワークのサブネットにネットワーク セキュリティ グループを関連付けます。

1. ポータルの上部にある **[リソース、サービス、ドキュメントの検索]** ボックスで、「**myNsg**」と入力します。 検索結果に **myNsg** が表示されたら、それを選択します。

2. **myNSG** の概要ページで、 **[設定]** の **[サブネット]** を選択します。

3. **[設定]** ページの **[関連付け]** を選択します。

    :::image type="content" source="./media/tutorial-filter-network-traffic/associate-nsg-subnet.png" alt-text="NSG をサブネットに関連付ける。" border="true":::

3. **[サブネットの関連付け]** で **[仮想ネットワーク]** を選択し、 **[myVNet]** を選択します。 

4. **[サブネット]** を選択し、 **[default]\(既定\)** を選択して **[OK]** を選択します。

## <a name="create-security-rules"></a>セキュリティ規則を作成する

1. **[myNSG]** の **[設定]** で、 **[受信セキュリティ規則]** を選択します。

2. **[受信セキュリティ規則]** で **[+ 追加]** を選択します。

    :::image type="content" source="./media/tutorial-filter-network-traffic/add-inbound-rule.png" alt-text="インバウンド セキュリティ規則を追加する。" border="true":::

3. **myAsgWebServers** アプリケーション セキュリティ グループに、ポート 80 と 443 を許可するセキュリティ規則を作成します。 **[受信セキュリティ規則の追加]** ウィンドウで、次の情報を入力します。

    | 設定 | 値 |
    | ------- | ----- |
    | source | 既定値の **[Any]\(すべて\)** のままにします。 |
    | Source port ranges | 既定値の **(*)** のままにします。 |
    | 到着地 | **[アプリケーションのセキュリティ グループ]** を選択します。 |
    | 宛先アプリケーションのセキュリティ グループ | **[myAsgWebServers]** を選択します。 |
    | サービス | 既定値の **[Custom]\(カスタム\)** のままにします。 |
    | 宛先ポート範囲 | 「**80,443**」と入力します。 |
    | Protocol | **[TCP]** を選択します。 |
    | アクション | 既定値の **[Allow]\(許可\)** のままにします。 |
    | Priority | 既定値の **[100]** のままにします。 |
    | 名前 | 「**Allow-Web-All**」と入力します。 |

    :::image type="content" source="./media/tutorial-filter-network-traffic/inbound-security-rule.png" alt-text="インバウンド セキュリティ規則。" border="true":::

3. 手順 2 を繰り返して、次の値を指定します。

    | 設定 | 値 |
    | ------- | ----- |
    | source | 既定値の **[Any]\(すべて\)** のままにします。 |
    | Source port ranges | 既定値の **(*)** のままにします。 |
    | 到着地 | **[アプリケーションのセキュリティ グループ]** を選択します。 |
    | 宛先アプリケーションのセキュリティ グループ | **[myAsgMgmtServers]** を選択します。 |
    | サービス | 既定値の **[Custom]\(カスタム\)** のままにします。 |
    | 宛先ポート範囲 | 「**3389**」と入力します。 |
    | Protocol | **[TCP]** を選択します。 |
    | アクション | 既定値の **[Allow]\(許可\)** のままにします。 |
    | Priority | 既定値の **[110]** のままにします。 |
    | 名前 | 「**Allow-RDP-All**」と入力します。 |

    > [!CAUTION]
    > この記事では、**myAsgMgmtServers** アプリケーション セキュリティ グループに割り当てられている VM 用に、RDP (ポート 3389) がインターネットに公開されています。 
    >
    > 運用環境では、ポート 3389 をインターネットに公開せずに、VPN、プライベート ネットワーク接続、または Azure Bastion を使用して、管理する Azure リソースに接続することをお勧めします。
    >
    > Azure Bastion の詳細については、「[Azure Bastion とは](../bastion/bastion-overview.md)」を参照してください。

手順 1 から 3 を完了したら、作成した規則を確認します。 一覧は、次の例のように表示されます。

:::image type="content" source="./media/tutorial-filter-network-traffic/security-rules.png" alt-text="セキュリティ規則。" border="true":::

## <a name="create-virtual-machines"></a>仮想マシンを作成する

仮想ネットワーク内に 2 つの VM を作成します。

### <a name="create-the-first-vm"></a>最初の VM を作成する

1. ポータルの左上隅にある **[リソースの作成]** を選択します。

2. **[計算]** を選択し、 **[仮想マシン]** を選択します。

3. **[仮想マシンの作成]** の **[基本]** タブで、この情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | **プロジェクトの詳細** |  |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[myResourceGroup]** を選択します。 |
    | **インスタンスの詳細** |   |
    | 仮想マシン名 | 「**myVMWeb**」と入力します。 |
    | リージョン | **[(米国) 米国東部]** を選択します。 |
    | 可用性のオプション | 既定値の [no redundancy required]\(冗長性は必要ありません\) のままにします。 |
    | Image | **[Windows Server 2019 Datacenter - Gen1]** を選択します。 |
    | Azure Spot インスタンス | 既定値のオフのままにします。 |
    | サイズ | **[Standard_D2s_V3]** を選択します。 |
    | **管理者アカウント** |   |
    | ユーザー名 | ユーザー名を入力します。 |
    | Password | パスワードを入力します。 |
    | パスワードの確認 | パスワードを再入力します。 |
    | **受信ポートの規則** |   |
    | パブリック受信ポート | **[なし]** を選択します。 |

4. **[ネットワーク]** タブを選択します。

5. **[ネットワーク]** タブで、次の情報を入力または選択します。

    | 設定 | [値] |
    | ------- | ----- |
    | **ネットワーク インターフェイス** |   |
    | 仮想ネットワーク | **[myVNet]** を選択します。 |
    | Subnet | **[default (10.0.0.0/24)]\(既定値 (10.0.0.0/24)\)** を選択します。 |
    | パブリック IP | 新しいパブリック IP の既定値をそのまま使用します。 |
    | NIC ネットワーク セキュリティ グループ | **[なし]** を選択します。 | 

6. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

7. **［作成］** を選択します

### <a name="create-the-second-vm"></a>2 つ目の VM を作成する

手順 1. から 7. をもう一度実行します。ただし、手順 3. では、VM の名前を **myVMMgmt** にします。 VM のデプロイには数分かかります。 

VM がデプロイされるまで、次の手順に進まないでください。

## <a name="associate-network-interfaces-to-an-asg"></a>ネットワーク インターフェイスを ASG に関連付ける

ポータルで VM が作成されると、各 VM 用のネットワーク インターフェイスが作成され、そのネットワーク インターフェイスを VM に接続します。 

各 VM 用のネットワーク インターフェイスを、前に作成したアプリケーション セキュリティ グループの 1 つに追加します。

1. ポータルの上部にある **[リソース、サービス、ドキュメントの検索]** ボックスで、「**myVMWeb**」と入力します。 検索結果に **[myVMWeb]** 仮想マシンが表示されたら、それを選択します。

2. **[設定]** の **[ネットワーク]** を選択します。  

3. **[アプリケーションのセキュリティ グループ]** タブを選択し、 **[アプリケーションのセキュリティ グループを構成]** を選択します。

    :::image type="content" source="./media/tutorial-filter-network-traffic/configure-app-sec-groups.png" alt-text="アプリケーション セキュリティ グループを構成する。" border="true":::

4. **[アプリケーションのセキュリティ グループを構成]** で、 **[myAsgWebServers]** を選択します。 **[保存]** を選択します。

    :::image type="content" source="./media/tutorial-filter-network-traffic/select-asgs.png" alt-text="アプリケーション セキュリティ グループを選択する。" border="true":::

5. 手順 1. および 2. をもう一度実行し、**myVMMgmt** 仮想マシンを検索して、**myAsgMgmtServers** ASG を選択します。

## <a name="test-traffic-filters"></a>トラフィック フィルターをテストする

1. **myVMMgmt** VM に接続します。 ポータル上部の [検索] ボックスに「**myVMMgmt**」と入力します。 検索結果に **[myVMMgmt]** が表示されたら、それを選択します。 **[接続]** を選択します。

2. **[RDP ファイルのダウンロード]** を選択します。

3. ダウンロードした RDP ファイルを開き、 **[接続]** を選択します。 VM の作成時に指定したユーザー名とパスワードを入力します。

4. **[OK]** を選択します。

5. 接続処理中に証明書の警告が表示される場合があります。 警告が表示されたら、 **[はい]** または **[続行]** を選択して接続処理を続行します。

    この接続は成功します。**myAsgMgmtServers** アプリケーション セキュリティ グループへのインターネットからのインバウンド トラフィックが、ポート 3389 で許可されているためです。 
    
    **myVMMgmt** のネットワーク インターフェイスが **myAsgMgmtServers** アプリケーション セキュリティ グループに関連付けられ、接続が許可されます。

6. **myVMMgmt** で PowerShell セッションを開きます。 次の例を使用して **myVMWeb** に接続します。 

    ```powershell
    mstsc /v:myVmWeb
    ```

    **myVMMgmt** から **myVMWeb** への RDP 接続は成功します。既定では、同じネットワーク内の仮想マシンが任意のポートで相互に通信できるためです。
    
    インターネットから **myVMWeb** 仮想マシンへの RDP 接続を作成することはできません。 **myAsgWebServers** のセキュリティ規則により、インターネットからポート 3389 へのインバウンド接続は拒否されます。 既定では、インターネットからのインバウンド トラフィックはすべてのリソースに対して拒否されます。

7. **myVMWeb** 仮想マシンに Microsoft IIS をインストールするには、**myVMWeb** 仮想マシンの PowerShell セッションから次のコマンドを入力します。

    ```powershell
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    ```

8. IIS のインストールが完了したら、**myVMWeb** 仮想マシンから切断します。**myVMMgmt** 仮想マシンのリモート デスクトップ接続は保持されます。

9. **myVMMgmt** VM から切断します。

10. Azure portal の上部にある **[リソース、サービス、ドキュメントの検索]** ボックスに、お使いのコンピューターから「**myVMWeb**」と入力します。 検索結果に **[myVMWeb]** が表示されたら、それを選択します。 実際の VM の **パブリック IP アドレス** をメモします。 次の例に示すアドレスは 23.96.39.113 になっていますが、実際のアドレスは異なります。

    :::image type="content" source="./media/tutorial-filter-network-traffic/public-ip-address.png" alt-text="パブリック IP アドレス。" border="true":::
    
11. インターネットから **myVMWeb** Web サーバーにアクセスできることを確認するには、コンピューターでインターネット ブラウザーを開き、`http://<public-ip-address-from-previous-step>` にアクセスします。 

IIS のウェルカム画面が表示されます。**myAsgWebServers** アプリケーション セキュリティ グループへのインターネットからのインバウンド トラフィックが、ポート 80 で許可されているためです。 

**myVMWeb** 用に接続されているネットワーク インターフェイスが **myAsgWebServers** アプリケーション セキュリティ グループに関連付けられ、接続が許可されます。 

## <a name="clean-up-resources"></a>リソースをクリーンアップする

リソース グループとそれに含まれるすべてのリソースが不要になったら、それらを削除します。

1. ポータル上部の **[検索]** ボックスに「**myResourceGroup**」と入力します。 検索結果に **[myResourceGroup]** が表示されたら、それを選択します。
2. **[リソース グループの削除]** を選択します。
3. **[TYPE THE RESOURCE GROUP NAME:]\(リソース グループ名を入力してください:\)** に「**myResourceGroup**」と入力し、 **[削除]** を選択します。

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、次の作業を行いました。

* ネットワーク セキュリティ グループを作成し、それを仮想ネットワーク サブネットに関連付けました。 
* Web および管理用のアプリケーション セキュリティ グループを作成しました。
* 2 つの仮想マシンを作成しました。
* アプリケーション セキュリティ グループのネットワーク フィルターをテストしました。

ネットワーク セキュリティ グループについて詳しくは、[ネットワーク セキュリティ グループの概要](./network-security-groups-overview.md)と[ネットワーク セキュリティ グループの管理](manage-network-security-group.md)に関する記事を参照してください。

Azure の既定では、サブネット間でトラフィックがルーティングされます。 代わりに、たとえばファイアウォールとして機能する VM を介してサブネット間でトラフィックをルーティングすることもできます。 

ルート テーブルを作成する方法を学習するには、次のチュートリアルに進んでください。
> [!div class="nextstepaction"]
> [ルート テーブルの作成](./tutorial-create-route-table-portal.md)