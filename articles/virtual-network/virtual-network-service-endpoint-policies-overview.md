---
title: Azure 仮想ネットワーク サービス エンドポイント ポリシー | Microsoft Docs
description: サービス エンドポイント ポリシーを使用して、Azure サービス リソースへの仮想ネットワーク トラフィックをフィルター処理する方法について説明します
services: virtual-network
documentationcenter: na
author: sumeetmittal
ms.service: virtual-network
ms.devlang: NA
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/18/2018
ms.author: sumi
ms.openlocfilehash: 1aa4328a6d5367ef356ce33807289a873c93d90f
ms.sourcegitcommit: db2d402883035150f4f89d94ef79219b1604c5ba
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/07/2020
ms.locfileid: "77056701"
---
# <a name="virtual-network-service-endpoint-policies-preview"></a>仮想ネットワーク サービス エンドポイント ポリシー (プレビュー)

Virtual Network (VNet) のサービス エンドポイント ポリシーでは、サービス エンドポイント経由での Azure サービスへの仮想ネットワーク トラフィックをフィルター処理し、特定の Azure サービス リソースのみを許可することができます。 エンドポイント ポリシーでは、Azure サービスへの仮想ネットワーク トラフィックに対する詳細なアクセス制御が提供されます。

この機能は、Azure Storage のすべてのパブリック Azure リージョンで __プレビュー__ として利用できます。

プレビューに関する最新の通知については、[Azure Virtual Network の更新情報](https://azure.microsoft.com/updates/?product=virtual-network)ページをご覧ください。

> [!NOTE]  
> プレビュー期間中は、仮想ネットワーク サービス エンドポイント ポリシーに、一般公開リリースの機能と同じレベルの可用性と信頼性がない場合があります。 詳細については、[Microsoft Azure プレビューのMicrosoft Azure 追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)に関するページをご覧ください。

## <a name="key-benefits"></a>主な利点

仮想ネットワーク サービス エンドポイント ポリシーには、次の利点があります。

- __Azure サービスへの仮想ネットワーク トラフィックのセキュリティ強化__

  [ネットワーク セキュリティ グループ用の Azure サービス タグ](https://aka.ms/servicetags)を使用することで、特定の Azure サービスへの仮想ネットワーク送信トラフィックを制限できます。 しかし、これにより、その Azure サービスのすべてのリソースへのトラフィックが許可されます。 
  
  エンドポイント ポリシーを使用して、特定の Azure サービスのみへの仮想ネットワーク送信アクセスを制限できるようになりました。 これにより、仮想ネットワークでアクセスされるデータを保護するためのセキュリティ制御がさらに詳細になります。 

- __Azure サービス トラフィックをフィルター処理するスケーラブルな高可用性ポリシー__

   エンドポイント ポリシーでは、サービス エンドポイント経由の、仮想ネットワークからの Azure サービス トラフィックをフィルター処理するためのスケーラブルな高可用性ソリューションが提供されます。 仮想ネットワークでこのトラフィック用のセントラル ネットワーク アプライアンスを維持するために、追加のオーバーヘッドは必要ありません。

## <a name="configuration"></a>構成

- 特定の Azure サービス リソースへの仮想ネットワークのトラフィックを制限するエンドポイント ポリシーを構成することができます。 プレビューでは、Azure Storage 用のエンドポイント ポリシーがサポートされます。 
- エンドポイント ポリシーは仮想ネットワーク内のサブネット上で構成されます。 ポリシーにリストされているすべての Azure サービスに対して、ポリシーを適用するには、サブネット上でサービス エンドポイントを有効にする必要があります。
- エンドポイント ポリシーでは、resourceID 形式を使用して、特定の Azure サービス リソースをホワイトリストに登録することができます。 サブスクリプションまたはリソース グループ内のすべてのリソースへのアクセスを制限することができます。 また、特定のリソースへのアクセスを制限することもできます。 
- 既定では、ポリシーがエンドポイントでサブネットに接続されていない場合、サービス内のすべてのリソースにアクセスできます。 ポリシーがそのサブネット上に構成された後、そのサブネットのコンピューティング インスタンスからはポリシーに指定されているリソースのみにアクセスできます。 特定のサービスのその他のすべてのリソースへのアクセスが拒否されます。 
- サービス エンドポイントが構成されているリージョン内の Azure サービス リソースへのトラフィックをフィルター処理することができます。 他のリージョン内のサービス リソースへのアクセスは、既定で許可されます。 

  > [!NOTE]  
  > サービス エンドポイント リージョン内の Azure リソースへの仮想ネットワーク送信アクセスを完全にロックダウンするには、[サービス タグ](security-overview.md#service-tags)を使用して、サービス エンドポイント リージョンへのトラフィックのみを許可するように構成されたネットワーク セキュリティ グループ ルールも必要になります。

- サブネットには複数のポリシーを適用できます。 同じサービスのサブネットに複数のポリシーが関連付けられている場合は、これらのポリシー全体に指定されているリソースへの仮想ネットワーク トラフィックが許可されます。 どのポリシーにも指定されていない、他のすべてのサービス リソースへのアクセスは拒否されます。 

  > [!NOTE]  
  > ポリシーでは、仮想ネットワークからリストされているサービス リソースへのアクセスのみが許可されます。 ポリシーに特定のリソースを追加すると、サービスへの他のすべてのトラフィックが自動的に拒否されます。 ご利用のアプリケーションに対するすべてのサービス リソースの依存関係を、ポリシーで識別してリストできることを確認してください。

  > [!WARNING]  
  > Azure HDInsight など、仮想ネットワークにデプロイされている Azure サービスは、インフラストラクチャ要件のため、Azure Storage などのその他のサービスにアクセスします。 特定のリソースにエンドポイント ポリシーを制限すると、ご利用の仮想ネットワークにデプロイされているサービス用のこれらのインフラストラクチャ リソースへのアクセスが中断される可能性があります。 特定のサービスについては、「[制限事項](#limitations)」を参照してください。プレビュー期間中は、ご利用の仮想ネットワークにデプロイされている Azure マネージド サービスのいずれのサービス エンドポイント ポリシーもサポートされません。

- Azure Storage の場合: 
  -  ストレージ アカウントの Azure Resource Manager *resourceId* をリストして、アクセスを制御することができます。 これには、BLOB、テーブル、キュー、ファイルおよび Azure Data Lake Storage Gen2 へのトラフィックが含まれます。

     たとえば、以下のように、Azure ストレージ アカウントをエンドポイント ポリシー定義でリストすることができます。
    
     特定のストレージ アカウントを許可する場合:         
     `subscriptions/subscriptionId/resourceGroups/resourceGroup/providers/Microsoft.Storage/storageAccounts/storageAccountName`
      
     サブスクリプションとリソース グループ内のすべてのアカウントを許可する場合: `/subscriptions/subscriptionId/resourceGroups/resourceGroup`
     
     サブスクリプション内のすべてのアカウントを許可する場合: `/subscriptions/subscriptionId`
    
- エンドポイント ポリシーで指定できるのは、Azure Resource Model を使用するストレージ アカウントのみです。  

  > [!NOTE]  
  > 従来のストレージ アカウントへのアクセスは、エンドポイント ポリシーでブロックされます。

- リストされているアカウントのプライマリ ロケーションは、サブネット用の、サービス エンドポイントの geo ペア リージョン内にある必要があります。 

  > [!NOTE]  
  > ポリシーを使用して、他のリージョンからのサービス リソースを指定することができます。 Azure サービスへの仮想ネットワーク アクセスは、geo ペア リージョンでのみフィルター処理されます。 ネットワーク セキュリティ グループが Azure Storage 用の geo ペア リージョンに制限されていない場合は、仮想ネットワークから geo ペア リージョン外のすべてのストレージ アカウントにアクセスできます。

- プライマリ アカウントがリストされている場合、RA-GRS のセカンダリ アクセスが自動的に許可されます。 
- ストレージ アカウントは、仮想ネットワークと同じまたは異なるサブスクリプションにある場合、あるいは Azure Active Directory テナントにある場合があります。 

## <a name="limitations"></a>制限事項

- サービス エンドポイント ポリシーをデプロイできるのは、Azure Resource Manager デプロイ モデルを使ってデプロイされた仮想ネットワークのみとなります。
- 仮想ネットワークは、サービス エンドポイント ポリシーと同じリージョンにある必要があります。
- ポリシーにリストされている Azure サービスに対してサービス エンドポイントが構成されている場合、サービス エンドポイント ポリシーはサブネット上でのみ適用できます。
- オンプレミス ネットワークから Azure サービスへのトラフィックに対して、サービス エンドポイント ポリシーを使用することはできません。
- インフラストラクチャ要件のため Azure サービスに対して依存関係を持つ、Azure マネージド サービスでサブネットにエンドポイント ポリシーを適用しないでください。 

  > [!WARNING]  
  > Azure HDInsight など、仮想ネットワークにデプロイされている Azure サービスは、インフラストラクチャ要件のため、Azure Storage などのその他のサービスにアクセスします。 特定のリソースにエンドポイント ポリシーを制限すると、ご利用の仮想ネットワークにデプロイされている Azure サービス用のこれらのインフラストラクチャ リソースへのアクセスが中断される可能性があります。
  
  - 一部の Azure サービスは、他のコンピューティング インスタンスでサブネットにデプロイすることができます。 以下にリストされているマネージド サービスがサブネットにデプロイされている場合は、サブネットにエンドポイント ポリシーが適用されていないことを確認してください。
   
    - Azure HDInsight
    - Azure Batch (Azure Resource Manager)
    - Azure Active Directory Domain Services (Azure Resource Manager)
    - Azure Application Gateway (Azure Resource Manager)
    - Azure VPN Gateway (Azure Resource Manager)
    - Azure Firewall

  - 一部の Azure サービスは専用のサブネットにデプロイされます。 プレビュー期間中は、以下にリストされている、そのようなすべてのサービスでエンドポイント ポリシーがブロックされます。 

     - Azure App Service Environment
     - Azure Rediscache
     - Azure API Management
     - Azure SQL Managed Instance
     - Azure Active Directory Domain Services
     - Azure Application Gateway (クラシック)
     - Azure VPN Gateway (クラシック)

- Azure Storage:エンドポイント ポリシーでは従来のストレージ アカウントはサポートされていません。 既定では、ポリシーで従来のすべてのストレージ アカウントへのアクセスが拒否されます。 アプリケーションから Azure Resource Manager および従来のストレージ アカウントにアクセスする必要がある場合は、このトラフィックに対してエンドポイント ポリシーを使用しないでください。 

## <a name="nsgs-with-service-endpoint-policies"></a>サービス エンドポイント ポリシーを使用する NSG
- 既定では、NSG で、Azure サービスへの仮想ネットワークを含む、送信インターネット トラフィックが許可されます。
- すべての送信インターネット トラフィックを拒否して、特定の Azure サービスへのトラフィックのみを許可する場合は、次のようにします。 

  手順 1:"*Azure のサービス タグ*" を使用して、エンドポイント リージョン内の Azure サービスへの送信トラフィックのみを許可するように NSG を構成します。 詳細については、[NSG 用のサービス タグ](https://aka.ms/servicetags)に関するページを参照してください。
      
  たとえば、エンドポイント リージョンのみにアクセスを制限するネットワーク セキュリティ グループ ルールは、次の例のようになります。

  ```
  Allow AzureStorage.WestUS2,
  Allow AzureStorage.WestCentralUS,
  Deny all
  ```

  手順 2:特定の Azure サービス リソースのみにアクセスするサービス エンドポイント ポリシーを適用します。

  > [!WARNING]  
  > エンドポイント リージョンへの仮想ネットワークの Azure サービス アクセスを制限するようにネットワーク セキュリティ グループが構成されていない場合は、サービス エンドポイント ポリシーが適用される場合でも、他のリージョン内のサービス リソースにアクセスすることができます。

## <a name="scenarios"></a>シナリオ

- **ピアリングされているか、接続されているか、あるいは複数の仮想ネットワーク**:ピアリングされた仮想ネットワーク内のトラフィックをフィルター処理するには、これらの仮想ネットワークに個別にエンドポイント ポリシーを適用する必要があります。
- **ネットワーク アプライアンスまたは Azure Firewall でのインターネット トラフィックのフィルター処理**:ポリシーを使用してエンドポイント経由の Azure サービス トラフィックをフィルター処理し、アプライアンスまたは Azure Firewall 経由の残りのインターネットまたは Azure トラフィックをフィルター処理します。 
- **Virtual Network にデプロイされている Azure サービスでのトラフィックのフィルター処理**:プレビュー期間中は、ご利用の仮想ネットワークにデプロイされている Azure マネージド サービスのいずれのサービス エンドポイント ポリシーもサポートされません。 
 特定のサービスについては、「[制限事項](#limitations)」を参照してください。
- **オンプレミスから Azure サービスへのトラフィックのフィルター処理**:サービス エンドポイント ポリシーのみが、そのポリシーに関連付けられているサブネットからのトラフィックに適用されます。 オンプレミスから特定の Azure サービス リソースへのアクセスを許可するには、ネットワーク仮想アプライアンスまたはファイアウォールを使用してトラフィックをフィルター処理する必要があります。

## <a name="logging-and-troubleshooting"></a>ロギングおよびトラブルシューティング
サービス エンドポイント ポリシーでは、集中ログ記録を使用することはできません。 サービスの診断ログについては、[サービス エンドポイントのログ記録](virtual-network-service-endpoints-overview.md#logging-and-troubleshooting)に関するページを参照してください。

### <a name="troubleshooting-scenarios"></a>トラブルシューティングのシナリオ
- エンドポイント ポリシーにリストされていないストレージ アカウントに対するアクセスが許可される
  - ネットワーク セキュリティ グループで、他のリージョン内のインターネットまたは Azure Storage アカウントへのアクセスが許可されている可能性があります。
  - ネットワーク セキュリティ グループは、すべての送信インターネット トラフィックを拒否して、特定の Azure Storage リージョンへのトラフィックのみを許可するように構成する必要があります。 詳しくは、「ネットワーク セキュリティ グループ」をご覧ください。
- エンドポイント ポリシーにリストされているアカウントに対するアクセスが拒否される
  - ネットワーク セキュリティ グループまたはファイアウォールのフィルター処理でアクセスがブロックされている可能性があります
  - ポリシーの削除または再適用によって接続が失われる場合:
    - エンドポイント経由の仮想ネットワークからのアクセスを許可するように Azure サービスが構成されているかどうか、またはリソースの既定のポリシーが *[すべて許可]* に設定されていることを確認します。
      > [!NOTE]      
      > エンドポイント ポリシーを使用してアクセスする場合は、仮想ネットワークにサービス リソースを固定する必要はありません。 しかし、セキュリティのベスト プラクティスとして、サービス エンドポイント経由、およびオンプレミス、IP ファイアウォール経由の、Azure Virtual Network などの信頼されたネットワークにサービス リソースを固定することをお勧めします。
  
    - サービス診断でエンドポイント経由のトラフィックが表示されることを確認します。
    - ネットワーク セキュリティ グループのフロー ログにアクセスが表示されているかどうかと、ストレージ ログにサービス エンドポイント経由のアクセスが期待どおりに表示されることを確認します。
    - Azure サポートに問い合わせます。
- サービス エンドポイント ポリシーにリストされていないアカウントに対するアクセスが拒否される
  - ネットワーク セキュリティ グループまたはファイアウォールのフィルター処理で、アクセスがブロックされている可能性があります。 エンドポイント リージョンに対して、*Azure Storage* サービス タグが許可されていることを確認してください。 ポリシーの制限事項については、「[制限事項](#limitations)」を参照してください。
  たとえば、ポリシーが適用されている場合、従来のストレージ アカウントのアクセスは拒否されます。
  - エンドポイント経由の仮想ネットワークからのアクセスを許可するように Azure サービスが構成されているかどうか、またはリソースの既定のポリシーが *[すべて許可]* に設定されているかどうかを確認します。

## <a name="provisioning"></a>プロビジョニング

サービス エンドポイント ポリシーは、仮想ネットワークへの書き込みアクセス権を持つユーザーがサブネット上で構成できます。 Azure の[組み込みロール](../role-based-access-control/built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json)と、特定のアクセス許可を[カスタム ロール](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json)に割り当てる方法の詳細をご覧ください。

仮想ネットワークと Azure サービス リソースは、同じまたは異なるサブスクリプションにある場合、あるいは Azure Active Directory テナントにある場合があります。 

## <a name="pricing-and-limits"></a>料金と制限

サービス エンドポイント ポリシーの使用に追加料金はかかりません。 現時点では、Azure サービス (Azure Storage など) の現在の価格設定モデルは、サービス エンドポイントを介して適用されます。

サービス エンドポイント ポリシーでは、次の制限が適用されます。 

 |リソース | 既定の制限 |
 |---------|---------------|
 |ServiceEndpointPoliciesPerSubscription |500 |
 |ServiceEndpintPoliciesPerSubnet|100 |
 |ServiceResourcesPerServiceEndpointPolicyDefinition|200 |

## <a name="next-steps"></a>次の手順

- [仮想ネットワーク サービス エンドポイント ポリシーを構成する方法](virtual-network-service-endpoint-policies-portal.md)を学習する
- [仮想ネットワーク サービス エンドポイント](virtual-network-service-endpoints-overview.md)の詳細を確認する

