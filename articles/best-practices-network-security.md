<properties
   pageTitle="Microsoft クラウド サービスとネットワーク セキュリティ | Microsoft Azure"
   description="セキュリティで保護されたネットワーク環境を作成するために Azure で利用できる主な機能の一部を説明します。"
   services="virtual-network"
   documentationCenter="na"
   authors="tracsman"
   manager="rossort"
   editor=""/>

<tags
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="09/16/2015"
   ms.author="jonor;sivae"/>

# Microsoft クラウド サービスとネットワーク セキュリティ

Microsoft クラウド サービスでは、非常にスケール性の高いサービスとインフラストラクチャ、エンタープライズ レベルの機能、ハイブリッド接続の多くの選択肢を提供しています。顧客は、これらのサービスにインターネット経由でアクセスするか、プライベート ネットワーク接続を提供する ExpressRoute を使用してアクセスするかを選択できます。Microsoft Azure Platform により、顧客は自身のインフラストラクチャをシームレスにクラウドに拡張し、多層アーキテクチャを構築できます。Microsoft のサービスを補完するために、サード パーティは、セキュリティ サービスや仮想アプライアンスを提供することで、機能強化を実現できます。このホワイト ペーパーでは、顧客が ExpressRoute を介してアクセスした Microsoft クラウド サービスを使用するほか、Microsoft Azure Virtual Network にセキュリティで保護されたサービスを作成する際に考慮する必要がある、セキュリティとアーキテクチャの問題の概要を説明します。

## はじめに
次の論理チャートでは、Microsoft Azure Platform で利用可能な多数のセキュリティ手法の具体例を示しています。このチャートを使用すると、何が必要かを簡単に見つけることができます。使用可能な多くのオプションの説明を確認する場合は、このドキュメントを最初からお読みください。![Security Options Flowchart][0]

[例 1 - NSG を使用して単純な DMZ を構築する](#example-1-build-a-simple-dmz-with-nsgs)</br> [例 2 - ファイアウォールと NSG から成る DMZ を構築してアプリケーションを保護する](#example-2-build-a-dmz-to-protect-applications-with-a-firewall-and-nsgs)</br> [例 3 - ファイアウォール、UDR、NSG から成る DMZ を構築してネットワークを保護する](#example-3-build-a-dmz-to-protect-networks-with-a-firewall-udr-and-nsg)</br> [例 4 - サイト間の仮想アプライアンス VPN を使用してハイブリッド接続を追加する](#example-4-adding-a-hybrid-connection-with-a-site-to-site-virtual-appliance-vpn)</br> [例 5 - サイト間の Azure ゲートウェイ VPN を使用してハイブリッド接続を追加する](#example-5-adding-a-hybrid-connection-with-a-site-to-site-azure-gateway-vpn)</br> [例 6 - ExpressRoute を使用してハイブリッド接続を追加する](#example-6-adding-a-hybrid-connection-with-expressroute)</br> VNet 間接続、高可用性、サービス チェイニングの追加に関する例については、今後数か月の間にこのドキュメントに追加される予定です。

## Microsoft のコンプライアンスとインフラストラクチャの保護
Microsoft は、企業顧客が必要とするコンプライアンス イニシアチブのサポートにおいて指導的立場を獲得しました。Azure のコンプライアンス認定の一部を次に示します。![Azure Compliance Badges][1]

詳細については、[http://azure.microsoft.com/support/trust-center/compliance/](http://azure.microsoft.com/support/trust-center/compliance/) を参照してください。

Microsoft は、非常にスケール性の高いグローバル サービスの実行に必要なクラウド インフラストラクチャを保護するための包括的なアプローチを備えています。Microsoft のクラウド インフラストラクチャには、物理的なデータ センターに加え、ハードウェア、ソフトウェア、ネットワーク、管理スタッフ、運用スタッフも含まれています。

![Azure Security Features][2]

上記のアプローチでは、顧客が Microsoft のクラウドでサービスをデプロイするための安全な基盤を提供します。次の手順では、顧客がこれらのサービスを保護するためのセキュリティ アーキテクチャを設計して作成します。

## 従来のセキュリティ アーキテクチャと境界ネットワーク (DMZ)
Microsoft は、クラウド インフラストラクチャの保護に多額の投資を行っていますが、顧客も自身のクラウド サービスとリソース グループを保護する必要があります。セキュリティに対する多層アプローチにより、最大限の保護が提供されます。ネットワーク セキュリティの境界ネットワーク (DMZ) は、信頼されていないネットワークから内部のネットワーク リソースを保護します。DMZ は企業の IT ネットワーク セキュリティ アーキテクチャにおいてよく知られた概念で、インターネットと企業の保護された IT インフラストラクチャの間にある、ネットワークの境界または領域を指します。

一般的な企業ネットワークでは、複数層のセキュリティ デバイスにより、コア インフラストラクチャの境界が厳重に防備されています。各層の境界は、デバイスとポリシー適用ポイントで構成されます。デバイスには、ファイアウォール、DDoS (分散型サービス拒否) の防止、IDS/IPS (侵入検出システムまたは侵入防止システム)、VPN (仮想プライベート ネットワーク) デバイスなどがあります。ポリシーの適用は、ファイアウォール ポリシー、ACL、または特定のルーティングという形式で行われます。ネットワークにおける防御の最前線では、インターネットから着信トラフィックを直接受け取ると、このようなメカニズムを組み合わせて攻撃や有害なトラフィックをブロックすると同時に、有効な要求を通じてさらにネットワーク内に向けて送信します。このトラフィックは、DMZ 内のリソースに直接ルーティングされます。その後、そのリソースはネットワーク内のさらに深い場所にあるリソースと "対話" し、ネットワーク内でさらに深くルーティングする前に検証のために次の境界を通過します。最も外側の層が DMZ と呼ばれます。ネットワークのこの部分は、インターネットに接する部分で、通常、DMZ の内側と外側は何らかの形で保護されています。次の図では、2 つのセキュリティ境界 (DMZ とインターネット間、DMZ とバックエンド VLAN 間) を持つ企業ネットワークにおける単一のサブネット DMZ の例を示します。

![A DMZ in a Corporate network][3]

DMZ の実装に使用されるアーキテクチャは、Web ファームの前面に位置する単純なロード バランサーから、トラフィックをブロックして企業ネットワークのより深い層を保護するために各境界で異なるメカニズムを使用する複数のサブネット DMZ まで多岐にわたります。DMZ を構築する方法は、組織の具体的なニーズや関連するリスク許容度によって異なります。

顧客がワークロードをパブリック クラウドに移行する場合、重要なのは、Azure の DMZ アーキテクチャで同様の機能をサポートし、コンプライアンスとセキュリティの要件を満たすことです。このドキュメントでは、顧客が Azure でセキュリティで保護されたネットワーク環境を構築する方法に関するガイドラインを示します。DMZ に重点を置いて説明していますが、次のような質問 (ただし、これに限定されるものではありません) をはじめ、ネットワーク セキュリティの多くの側面についても包括的に説明します。

1.	Azure の DMZ はどのように構築できますか。
2.	DMZ の構築に使用できる Azure の機能を教えてください。
3.	バック エンドのワークロードはどのように保護できますか。
4.	インターネット通信はどのように Azure のワークロードに制御されていますか。
5.	Azure のデプロイからオンプレミスのネットワークを保護するにはどうすればよいですか。
6.	サード パーティ製のアプライアンスやサービスと比較して、どのような場合にネイティブの Azure セキュリティ機能を使用する必要がありますか。

次の図では、Azure が顧客に対して Azure Platform 自体でネイティブに提供するだけでなく、顧客が定義した機能も通じて提供するさまざまなセキュリティ層を示します。

![Azure Security Architecture][4]

インターネットから受信する場合は、Azure に対する大規模な攻撃を監視する Azure DDoS 保護があります。この部分を通過すると、顧客が定義したパブリック エンドポイントに到達します。このエンドポイントは、クラウド サービスを通過して仮想ネットワークに到達できるトラフィックを決定するために使用されます。ネイティブの Azure Virtual Network の分離により、その他すべてのネットワークから完全に分離されると、そのトラフィックだけが、ユーザーが構成した経路と方法を介して流れます。これらの経路と方法が次の層となります。次の層では、ネットワーク セキュリティ グループ (NSG)、ユーザー定義ルーティング (UDR)、ネットワーク仮想アプライアンスを使用して DMZ などのセキュリティ境界を構築し、保護されているネットワークにおけるアプリケーションのデプロイを保護することができます。

次のセクションでは、Azure 仮想ネットワークの概要を説明します。Azure 仮想ネットワークは顧客によって作成され、デプロイされたワークロードの接続先となります。仮想ネットワークは、Azure で顧客のデプロイを保護するための DMZ の構築に必要なすべてのネットワーク セキュリティ機能の基本です。

## Azure 仮想ネットワークの概要
インターネット トラフィックが Azure 仮想ネットワークに到達する前に、Azure Platform には固有のセキュリティ層が 2 つあります。

1.	**DDoS 保護**: 分散型サービス拒否 (DDoS) 保護は、Azure 物理ネットワークの 1 つの層で、攻撃者が複数の "ボット" ノードを使用してインターネット サービスに過剰な負荷をかけようとする、大規模なインターネットベースの攻撃から Azure Platform 自体を保護します。Azure には、すべての着信インターネット接続に対する堅牢な DDoS の防御網が用意されています。この DDoS 保護層にはユーザーが構成できる属性がないため、顧客はこの層にアクセスできません。これにより、Azure はプラットフォームとして大規模な攻撃から保護されますが、個々の顧客アプリケーションは直接保護されません。局地的な攻撃に対しては、顧客が復元層を追加で構成できます。たとえば、顧客 A がパブリック エンドポイントで大規模な DDoS 攻撃を受けた場合、Azure はそのサービスへの接続をブロックします。顧客 A は、その攻撃に関係のない別の仮想ネットワークまたはサービス エンドポイントにフェールオーバーして、サービスを復元できます。注目すべきは、そのエンドポイントで顧客 A が影響を受ける可能性はあっても、そのエンドポイント以外の他のサービスには影響がないことです。さらに、他の顧客やサービスからは、その攻撃による影響がわかりません。
2.	**サービス エンドポイント**: エンドポイントにより、クラウド サービスまたはリソース グループではパブリック (インターネット) IP アドレスとポートを公開できます。このエンドポイントでは、Azure 仮想ネットワークの内部アドレスとポートに対してトラフィックの NAT を実行します。これは、外部トラフィックが Azure 仮想ネットワークに到達するための主な経路です。サービス エンドポイントは、仮想ネットワークに渡されるトラフィックと、そのトラフィックが仮想ネットワークのどこでどのように変換されるかを決定するためにユーザーが構成できます。 

トラフィックが仮想ネットワークに到達すると、Azure 仮想ネットワークは顧客が自身のワークロードを接続するための基盤となり、そこで、基本的なネットワーク レベルのセキュリティが適用されるため、多くの機能が機能します。次の機能と特性を使用する顧客の場合、これが Azure のプライベート ネットワーク (仮想ネットワークのオーバーレイ) になります。
 
1.	**トラフィックの分離**: 仮想ネットワークは、Azure Platform でのトラフィックの分離境界となります。ある仮想ネットワーク内の VM と別の仮想ネットワーク内の VM は、両方の仮想ネットワークを同じ顧客が作成した場合でも、直接通信することはできません。これは、仮想ネットワーク内では顧客の VM と通信がプライベートであることを保証する重要な特性です。 
2.	**多層トポロジ**: 仮想ネットワークでは、顧客は、サブネットを割り当てて、ワークロードのさまざまな要素 ("層") に個別のアドレス空間を指定することで、多層トポロジを定義できます。このような論理的なグループとトポロジを使用すると、顧客は、ワークロードの種類に基づいて異なるアクセス ポリシーを定義するだけでなく、各層の間のトラフィック フローを制御することもできます。 
3.	**クロスプレミス接続**: 顧客は、Azure VPN ゲートウェイまたはサード パーティ製のネットワーク仮想アプライアンスを使用して、Azure で 1 つの仮想ネットワークと複数のオンプレミス サイトや他の仮想ネットワークとの間にクロスプレミス接続を確立できます。Azure では、標準的な IPsec/IKE プロトコルと ExpressRoute プライベート接続を使用したサイト間 (S2S) VPN をサポートしています。 
4.	**ネットワーク セキュリティ グループ** (NSG) では、顧客が必要なレベルの粒度 (ネットワーク インターフェイス、個々の VM、仮想サブネットなど) でルール (ACL) を作成できます。顧客は、仮想ネットワーク内でのワークロード間の通信を許可または拒否することで、クロスプレミス接続を介した顧客のネットワーク上のシステムからのアクセス、または直接インターネット通信を制御できます。 
5.	**ユーザー定義ルート** (UDR) と **IP 転送**により、顧客は仮想ネットワーク内の異なる層間の通信経路を定義できます。顧客は、ファイアウォール、IDS/IPS、その他の仮想アプライアンスをデプロイし、これらのセキュリティ アプライアンスを介してネットワーク トラフィックをルーティングすることで、セキュリティ境界ポリシーを適用、監査、検査することができます。
6.	Azure Marketplace の**ネットワーク仮想アプライアンス**: ファイアウォール、ロード バランサー、IDS/IPS (侵入検出/防止サービス) などのセキュリティ アプライアンスは、Azure Marketplace と VM イメージ ギャラリーで入手できます。顧客は、これらのアプライアンスを自身の仮想ネットワーク、特にセキュリティ境界 (DMZ サブネットを含む) にデプロイすることで、多層のセキュリティで保護されたネットワーク環境を実現できます。

このような機能を使用した場合に Azure で構築される DMZ アーキテクチャの一例を次に示します。

![A DMZ in an Azure Virtual Network][5]

## DMZ の特性と要件
このセクションでは、Azure における DMZ の特性と要件について説明します。既に説明したとおり、DMZ は、ネットワークのフロントエンドとして、インターネットからの通信と直接接続するように設計されています。受信パケットは、バックエンド サーバーに到達するまでに DMZ 内のセキュリティ アプライアンス (ファイアウォール、IDS、IPS など) を通過する必要があります。また、ワークロードからインターネットへのパケットも、ネットワークから発信される前に、ポリシーの適用、検査、監査を行うために DMZ 内のセキュリティ アプライアンスを通過する必要があります。さらに、DMZ を使用すると、顧客の仮想ネットワーク間やオンプレミス ネットワーク上でクロスプレミスの VPN ゲートウェイをホストすることもできます。

### DMZ の特性
上の図で Azure 仮想ネットワーク内の DMZ を見る限り、優れた DMZ の特性は次のとおりです。

- DMZ のインターネット接続 (フロントエンド)
    - DMZ サブネット自体がインターネットに接続されており、直接インターネットと通信しています。
    - パブリック IP、VIP、サービス エンドポイントは、フロントエンドのネットワークとデバイスにインターネット トラフィックを渡します。
    - インターネットからの受信トラフィックは、セキュリティ デバイスを通過してからフロントエンド ネットワーク上の他のリソースに到達します。
    - 送信セキュリティが有効になっている場合、トラフィックは、セキュリティ デバイスを通過してから、最終段階としてインターネットに渡されます。
- "保護されているネットワーク" (バックエンド): コア インフラストラクチャ向き
    - インターネットからコア インフラストラクチャへの直接的な経路はありません。
    - コア インフラストラクチャへのチャネルは、DMZ 内の NSG、ファイアウォール、VPN デバイスなどのセキュリティ デバイスを経由する必要があります。
    - DMZ 内のその他のデバイスはインターネットとコア インフラストラクチャの橋渡しをすることはできません。
    - DMZ のインターネットに面した境界と保護されているネットワークに面した境界の両方にあるセキュリティ デバイス (例: 上の図で表示されている 2 つのファイアウォール アイコン) は、実際には、インターネットの境界とバックエンドの境界に区別されたルールまたはインターフェイスを持つ 1 つの仮想アプライアンス (つまり、DMZ の両方の境界の負荷を処理する、論理的に分離された 1 つのデバイス) である可能性があります。
- その他の一般的な慣行と制約
    - DMZ のワークロードには、ビジネスに不可欠な情報を格納することはできません。
    - DMZ の構成とデプロイへのアクセスと更新は、承認された管理者のみに制限されます。

### DMZ の要件
これらの特性を有効にするために、次の一覧では、正常な DMZ を実装するための仮想ネットワークの要件に関するガイダンスを示します。

- サブネット アーキテクチャ: サブネット全体が DMZ として特化されるように仮想ネットワークを指定すると、同じ仮想ネットワーク内の他のサブネットから分離されます。これにより、DMZ とその他の内部またはプライベートのサブネット層との間のトラフィックは、ユーザー定義ルートを使用してサブネットの境界上にあるファイアウォールまたは IDS/IPS 仮想アプライアンスを通過します。
- DMZ のネットワーク セキュリティ グループ (NSG) - DMZ とインターネット間の通信を許可するために DMZ サブネット自体を開いた状態にしておく必要があります。ただし、顧客が NSG をバイパスする必要があるという意味ではありません。一般的なセキュリティの慣例に従い、デプロイや開いている特定のアプリケーション プロトコルまたはポートへのアクセスを許可するリモート アドレスの範囲をロックダウンすることにより、インターネットに公開されるネットワークの場所を最小限に抑えます。ただし、これらは必ずしもできるとは限りません。たとえば、顧客が Azure に外部 Web サイトを所有している場合、DMZ では、パブリック IP アドレスからの着信 Web 要求を許可する必要がありますが、開く必要がある Web アプリケーション ポートは TCP:80 と TCP:443 のみです。
- DMZ のルーティング テーブル - DMZ サブネット自体は、インターネットと直接通信できる必要がありますが、ファイアウォールやセキュリティ アプライアンスを介さずにバックエンド ネットワークまたはオンプレミス ネットワークと直接通信することはできないようにする必要があります。
- DMZ セキュリティ アプライアンスの構成 - DMZ と他の保護されているネットワークとの間でパケットをルーティングして検査するために、DMZ 内のセキュリティ アプライアンス (ファイアウォール、IDS、IPS デバイスなど) は、DMZ とバックエンド サブネットに個別の NIC を使用してマルチホームにすることができます。DMZ の NIC は、対応する NSG と DMZ ルーティング テーブルを使用して、インターネットと直接通信します。バックエンド サブネットに接続する NIC では、対応するバックエンド サブネットの NSG とルーティング テーブルがより限定的になります。
- DMZ セキュリティ アプライアンスの機能 - DMZ にデプロイされているセキュリティ アプライアンスは、通常、次の機能を実行します。
    - ファイアウォール - 受信要求にファイアウォール ルールまたはアクセス制御ポリシーを適用します。
    - 脅威の検出と防止 - インターネットからの悪意のある攻撃を検出して軽減します。
    - 監査とログ記録 - 監査と分析のために詳細なログを保持します。
    - リバース プロキシ - DMZ のフロントエンド デバイス (通常はファイアウォール) の宛先アドレスを実際のバックエンド サーバーのアドレスにマッピングして変換することにより、受信要求を対応するバックエンド サーバーにリダイレクトします。
    - 転送プロキシ - NAT 機能を提供し、仮想ネットワーク内からインターネットに対して開始された通信の監査も実行します。
    - ルーター - 仮想ネットワーク内で着信トラフィックとサブネット間トラフィックを転送するルーターとして動作します。
    - VPN デバイス - 顧客のオンプレミス ネットワークと Azure の仮想ネットワークとの間のクロスプレミス VPN 接続でクロスプレミスの VPN ゲートウェイとして動作します。
    - VPN サーバー - Azure の仮想ネットワークに接続している VPN クライアントを受け入れる VPN サーバーとして動作します。

>[AZURE.TIP]DMZ のセキュリティ ギアへのアクセスが許可されている個人と、アプリケーションの開発、デプロイ、操作の管理者として承認された個人を完全に区別しておいてください。これらのグループを区別すると、義務の分離も可能になり、1 人でアプリケーション セキュリティとネットワーク セキュリティの両方の制御をバイパスできなくなります。

### ネットワーク境界を構築する際の質問事項
このセクションで "Azure ネットワーク" について説明する場合、特に記載がない限り、すべてのネットワーク (ネットワーク、仮想ネットワーク、サブネット) は、サブスクリプションの管理者によって作成されたプライベートの Azure 仮想ネットワークを指しています。Azure 内の基になる物理ネットワークについては説明しません。

また、Azure 仮想ネットワークは、従来のオンプレミス ネットワークを拡張するためによく使用されます。サイト間または ExpressRoute のハイブリッド ネットワーク ソリューションと DMZ アーキテクチャを組み合わせることは可能です。これは、ネットワークのセキュリティ境界を構築する際に重要な考慮事項です。これについては、後述の質問で説明します。

したがって、DMZ と複数のセキュリティ境界を使用したネットワークを構築する場合は、次の 3 つの重要な質問を確認する必要があります。

#### 1) 境界はいくつ必要か
最初の決定ポイントでは、特定のシナリオで必要なセキュリティ境界の数を決定します。

- 境界が 1 つの場合 - 仮想ネットワークとインターネットの間のフロントエンド DMZ 上に 1 つ。
- 境界が 2 つの場合 - DMZ ネットワークのインターネット側に 1 つ、DMZ サブネットと Azure 仮想ネットワーク内のバックエンド サブネットの間にもう 1 つ。
- 境界が 3 つの場合 - DMZ のインターネット側に 1 つ、DMZ とバックエンド サブネットの間に 1 つ、バックエンド サブネットとオンプレミス ネットワークの間に 1 つ。
- 境界が N 個の場合 - セキュリティの要件によっては、特定のネットワークに適用できるセキュリティ境界の数に制限はありません。

必要な境界の数と種類は、企業のリスク許容度と、実装する特定のシナリオに応じて異なります。これは、多くの場合、リスクおよびコンプライアンス チーム、ネットワーク/プラットフォーム チーム、アプリケーション開発チームなど、組織内の複数のグループによって共同で決定されます。各実装に適切なセキュリティへの対応を確保するために、セキュリティ、関連するデータ、使用されるテクノロジに詳しい人物がこの決定について権限を持つ必要があります。

>[AZURE.TIP]特定の状況のセキュリティ要件を満たす境界の数は最小限に抑えてください。境界の数が増えると、運用とトラブルシューティングが困難になり、複数の境界ポリシーの管理に伴うオーバーヘッドも時間と共に増大します。ただし、境界の数が不足するとリスクが高まります。適切なバランスを見つけることが重要です。

![Hybrid Network with Three Security Boundaries][6]

上の図は、3 つのセキュリティ境界ネットワークの概要を示しています。ここでは、DMZ とインターネットの間、Azure のフロントエンド プライベート サブネットとバックエンド プライベート サブネットの間、Azure バックエンド サブネットとオンプレミスの企業ネットワークの間にそれぞれ境界があります。

#### 2\. 境界をどこに配置するか
境界の数が決まったら、どこでそれらを実装するかが次の決定ポイントになります。一般的に、1) インター ネット ベースの中間サービスの使用時 (例: クラウドベースの WAF。このドキュメントでは説明しません)、2) Azure のネイティブ機能またはネットワーク仮想アプライアンスの使用時、3) オンプレミス ネットワーク上の物理デバイスの使用時という 3 つの選択肢があります。

純粋に Azure ネットワークの場合、Azure のネイティブ機能 (例: Azure Load Balancer) または Azure の優れたパートナー エコシステムのネットワーク仮想アプライアンス (例: Check Point ファイアウォール) を選択できます。

Azure とオンプレミス ネットワークの間に境界が必要な場合は、セキュリティ デバイスを接続の片側 (または両側) に配置できます。したがって、セキュリティ ギアを配置する場所について決定する必要があります。

上の図では、インターネットと DMZ 間の境界およびフロントエンドとバックエンド間の境界が完全に Azure 内部に含まれており、Azure のネイティブ機能とネットワーク仮想アプライアンスのいずれかになっています。Azure (バックエンド サブネット) と企業ネットワーク間の境界上のセキュリティ デバイスは、Azure 側にある場合、オンプレミス側にある場合、さらに、両方のデバイスを組み合わせたものである場合もあります。どちらのオプションにも、真剣に検討する必要のある重要な長所と短所があります。

たとえば、オンプレミス ネットワーク側で既存の物理的なセキュリティ ギアを使用するとします。この場合の長所は、新しいギアは不要で、必要なのは新しい構成のみという点です。短所は、セキュリティ ギアで確認できるように、すべてのトラフィックを Azure からオンプレミス ネットワークに戻す必要がある点です。このため、Azure 間のトラフィックがセキュリティ ポリシー適用のためにオンプレミス ネットワークに強制的に戻される場合、大幅な遅延が発生し、アプリケーションのパフォーマンスとユーザー エクスペリエンスに影響することがあります。

#### 3\. どのように境界を実装するか
各セキュリティ境界では、機能の要件が異なる可能性があります (例: DMZ のインターネット側では IDS とファイアウォール ルールが必要ですが、DMZ とバックエンド サブネットの間には ACL のみが必要)。使用するデバイスは、シナリオとセキュリティ要件に応じて決定します。次の DMZ の例 1、2、3 では、使用できるいくつかのオプションについて説明します。Azure のネイティブ ネットワーク機能と Azure で使用できるパートナー エコシステムのデバイスを調べると、ほとんどすべてのシナリオを解決できる多種多様なオプションが見つかります。

実装に関するもう 1 つの重要な決定ポイントとして、Azure とオンプレミス ネットワークの接続方法があります。Azure 仮想ゲートウェイまたはネットワーク仮想アプライアンスを使用します。これらのオプションについては、この後の例 4、5、6 でさらに詳しく説明します。

さらに、Azure 内の VNet 間のトラフィックが必要になる場合があります。これらのシナリオについては、この後の例 7 と 8 でさらに詳しく説明します。

上記の質問に対する答えがわかっている場合は、前述の「[はじめに](#fast-start)」セクションが、特定のシナリオに最も適切な例を見つけるのに役立ちます。

## Azure 仮想ネットワークでセキュリティ境界を構築する
### 例 1 - NSG を使用して単純な DMZ を構築する
[「はじめに」に戻る](#fast-start) | [この例の詳細な構築手順][Example1]

![Inbound DMZ with NSG][7]

#### 環境の説明
この例で使用するサブスクリプションには、以下のものが含まれています。

- 2 つのクラウド サービス: "FrontEnd001" と "BackEnd001"
- 2 つのサブネット ("FrontEnd" と "BackEnd") を含む仮想ネットワーク "CorpNetwork"
- 両方のサブネットに適用されるネットワーク セキュリティ グループ
- アプリケーション Web サーバーを表す Windows サーバー ("IIS01")
- アプリケーション バックエンド サーバーを表す 2 つの Windows サーバー ("AppVM01"、"AppVM02")
- DNS サーバーを表す Windows サーバー ("DNS01")

[詳細な構築手順][Example1]に関するページでは、この例の構築についてさらに詳しく説明しています (スクリプトと ARM テンプレートの両方が用意されています)。

#### ネットワーク セキュリティ グループ (NSG) の説明
この例では、NSG グループを作成し、そこに 6 つのルールを設定します。

>[AZURE.TIP]一般的には、具体的な "Allow" ルールを作成してから、包括的な "Deny" ルールを作成してください。どのルールが先に評価されるかは、割り当てる優先度によって決まります。具体的なルールが一度適用されたトラフィックに対しては、他のルールは評価されません。NSG ルールは、(サブネットから見て) 受信方向または送信方向のどちらか一方に適用できます。

ここでは、受信トラフィックに対して次の内容のルールを作成しています。

1.	内部的な DNS トラフィック (ポート 53) を許可する。
2.	インターネットから任意の VM への RDP トラフィック (ポート 3389) を許可する。
3.	インターネットから Web サーバー (IIS01) への HTTP トラフィック (ポート 80) を許可する。
4.	IIS01 から AppVM1 への任意のトラフィック (すべてのポート) を許可する。
5.	インターネットから VNet 全体 (両方のサブネット) への任意のトラフィック (すべてのポート) を拒否する。
6.	フロントエンド サブネットからバックエンド サブネットへの任意のトラフィック (すべてのポート) を拒否する。

これらのルールが各サブネットにバインドされている状態で、インターネットから Web サーバーへの HTTP 要求が受信された場合、ルール 3 (Allow) とルール 5 (Deny) の両方が該当しますが、ルール 3 の方が優先度が高いので、ルール 3 のみが適用され、ルール 5 は作用しません。したがって、Web サーバーへの HTTP 要求は許可されます。同じトラフィックが DNS01 サーバーに到達しようとしている場合は、ルール 5 (Deny) が最初に適用されるので、トラフィックはサーバーに到達できません。フロントエンド サブネットからバックエンド サブネットへの通信は、ルール 6 (Deny) によってブロックされます (ルール 1 とルール 4 で許可されたトラフィックを除く)。これによって、フロントエンドにある Web アプリケーションのセキュリティが攻撃者によって侵害されたとしてもバックエンド ネットワークは保護されるため、バックエンドの "保護された" ネットワークに対する攻撃者のアクセスは (AppVM01 サーバー上で公開されているリソースに) 限定されます。

インターネットへ向かうトラフィックは、既定の送信ルールによって許可されています。この例では、送信トラフィックを許可していますが、送信ルールに対する変更は一切行っていません。両方向のトラフィックをロックダウンするには、ユーザー定義ルーティングが必要です。これについては、以下の「例 3」で説明します。

#### まとめ
これは、バックエンド サブネットを受信トラフィックから分離する方法としては比較的単純な例です。この例の詳細には、次のような内容が含まれています。

- PowerShell スクリプトを使用してこの DMZ を構築する方法
- ARM テンプレートを使用してこの DMZ を構築する方法
- 各 NSG コマンドの詳細な説明
- トラフィック フローの詳細なシナリオ (各層でトラフィックを許可または拒否する方法を示します)

[詳細な構築手順][Example1]に関するページを参照してください。

### 例 2 - ファイアウォールと NSG から成る DMZ を構築してアプリケーションを保護する
[「はじめに」に戻る](#fast-start) | [この例の詳細な構築手順][Example2]

![Inbound DMZ with NVA and NSG][8]

#### 環境の説明
この例で使用するサブスクリプションには、以下のものが含まれています。

- 2 つのクラウド サービス: "FrontEnd001" と "BackEnd001"
- 2 つのサブネット ("FrontEnd" と "BackEnd") を含む仮想ネットワーク "CorpNetwork"
- 両方のサブネットに適用される単一のネットワーク セキュリティ グループ
- フロントエンド サブネットに接続されたネットワーク仮想アプライアンス (この例ではファイアウォール)
- アプリケーション Web サーバーを表す Windows サーバー ("IIS01")
- アプリケーション バックエンド サーバーを表す 2 つの Windows サーバー ("AppVM01"、"AppVM02")
- DNS サーバーを表す Windows サーバー ("DNS01")

[詳細な構築手順][Example2]に関するページでは、この例の構築についてさらに詳しく説明しています (スクリプトと ARM テンプレートの両方が用意されています)。

#### ネットワーク セキュリティ グループ (NSG) の説明
この例では、NSG グループを作成し、そこに 6 つのルールを設定します。

>[AZURE.TIP]一般的には、具体的な "Allow" ルールを作成してから、包括的な "Deny" ルールを作成してください。どのルールが先に評価されるかは、割り当てる優先度によって決まります。具体的なルールが一度適用されたトラフィックに対しては、他のルールは評価されません。NSG ルールは、(サブネットから見て) 受信方向または送信方向のどちらか一方に適用できます。

ここでは、受信トラフィックに対して次の内容のルールを作成しています。

1.	内部的な DNS トラフィック (ポート 53) を許可する。
2.	インターネットから任意の VM への RDP トラフィック (ポート 3389) を許可する。
3.	NVA (ファイアウォール) へのすべてのインターネット トラフィック (すべてのポート) を許可する。
4.	IIS01 から AppVM1 への任意のトラフィック (すべてのポート) を許可する。
5.	インターネットから VNet 全体 (両方のサブネット) への任意のトラフィック (すべてのポート) を拒否する。
6.	フロントエンド サブネットからバックエンド サブネットへの任意のトラフィック (すべてのポート) を拒否する。

これらのルールが各サブネットにバインドされている状態で、インターネットからファイアウォールへの HTTP 要求が受信された場合、ルール 3 (Allow) とルール 5 (Deny) の両方が該当しますが、ルール 3 の方が優先度が高いので、ルール 3 のみが適用され、ルール 5 は作用しません。したがって、ファイアウォールへの HTTP 要求は許可されます。同じトラフィックが IIS01 サーバーに到達しようとしている場合は、そのサーバーがフロントエンド サブネット上にあったとしても、ルール 5 (Deny) が適用されるので、トラフィックはサーバーに到達できません。フロントエンド サブネットからバックエンド サブネットへの通信は、ルール 6 (Deny) によってブロックされます (ルール 1 とルール 4 で許可されたトラフィックを除く)。これによって、フロントエンドにある Web アプリケーションのセキュリティが攻撃者によって侵害されたとしてもバックエンド ネットワークは保護されるため、バックエンドの "保護された" ネットワークに対する攻撃者のアクセスは (AppVM01 サーバー上で公開されているリソースに) 限定されます。

インターネットへ向かうトラフィックは、既定の送信ルールによって許可されています。この例では、送信トラフィックを許可していますが、送信ルールに対する変更は一切行っていません。両方向のトラフィックをロックダウンするには、ユーザー定義ルーティングが必要です。これについては、以下の「例 3」で説明します。

#### ファイアウォール ルールの説明
ファイアウォールには、転送ルールを作成する必要があります。この例でルーティングするのは、インターネットからファイアウォールを介して Web サーバーに到達する受信トラフィックだけであるため、必要な転送 NAT ルールは 1 つだけです。

この転送ルールでは、HTTP のポート 80 または HTTPS のポート 443 を宛先としてファイアウォールに到達したすべての受信元アドレスを受け入れると、ファイアウォールのローカル インターフェイスから送出され、IP アドレス 10.0.1.5 の Web サーバーにリダイレクトされます。

#### まとめ
アプリケーションをファイアウォールで保護したり、バックエンド サブネットを受信トラフィックから切り離したりする方法として、これは比較的わかりやすい部類に入ります。この例の詳細には、次のような内容が含まれています。

- PowerShell スクリプトを使用してこの例の DMZ を構築する方法
- ARM テンプレートを使用してこの例を構築する方法
- 各 NSG コマンドとファイアウォール ルールの詳細な説明
- トラフィック フローの詳細なシナリオ (各層でトラフィックを許可または拒否する方法を示します)

[詳細な構築手順][Example2]に関するページを参照してください。

### 例 3 - ファイアウォール、UDR、NSG から成る DMZ を構築してネットワークを保護する
[「はじめに」に戻る](#fast-start) | [この例の詳細な構築手順][Example3]

![Bi-directional DMZ with NVA, NSG, and UDR][9]

#### 環境のセットアップ
この例で使用するサブスクリプションには、以下のものが含まれています。

- 3 つのクラウド サービス: “SecSvc001”、“FrontEnd001”、“BackEnd001”
- 3 つのサブネット ("SecNet"、"FrontEnd"、"BackEnd") を含む仮想ネットワーク "CorpNetwork"
- SecNet サブネットに接続されたネットワーク仮想アプライアンス (この例ではファイアウォール)
- アプリケーション Web サーバーを表す Windows サーバー ("IIS01")
- アプリケーション バックエンド サーバーを表す 2 つの Windows サーバー ("AppVM01"、"AppVM02")
- DNS サーバーを表す Windows サーバー ("DNS01")

[詳細な構築手順][Example3]に関するページでは、この例の構築についてさらに詳しく説明しています (スクリプトと ARM テンプレートの両方が用意されています)。

#### ユーザー定義ルーティング (UDR) の説明
既定では、次のシステム ルートが定義されています。

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.0.0/16}     VNETLocal                            Active   Default    
         {0.0.0.0/0}       Internet                             Active   Default    
         {10.0.0.0/8}      Null                                 Active   Default    
         {100.64.0.0/10}   Null                                 Active   Default    
         {172.16.0.0/12}   Null                                 Active   Default    
         {192.168.0.0/16}  Null                                 Active   Default

VNETLocal は、特定のネットワークの VNet に対して必ず定義されるアドレス プレフィックスです (つまり、具体的な VNet がそれぞれどのように定義されているかによって変わります)。その他のシステム ルートは静的ルートで、上記のように既定値となっています。

この例では、フロントエンドとバックエンドのサブネットに対して 1 つずつ、2 つのルーティング テーブルが作成されます。各サブネットに適した静的ルートをそれぞれのテーブルに読み込みます。この例では、すべてのトラフィック (0.0.0.0/0) をファイアウォール (次ホップ = 仮想アプライアンスの IP アドレス) 経由で送信する 3 つのルートが各テーブルに存在します。

1. ローカル サブネット トラフィック。次ホップは定義されず、ローカル サブネット トラフィックはファイアウォールをバイパスすることができます。
2. 仮想ネットワーク トラフィック。次ホップはファイアウォールとして定義され、ローカル VNet トラフィックの直接ルーティングを許可する既定のルールは上書きされます。
3. その他すべてのトラフィック (0/0)。次ホップはファイアウォールとして定義されます。

ルーティング テーブルは作成されると、対応するサブネットにバインドされます。フロントエンド サブネットの場合、作成後、サブネットにバインドされたルーティング テーブルは次のようになります。

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.1.0/24}     VNETLocal                            Active 
		 {10.0.0.0/16}     VirtualAppliance 10.0.0.4            Active    
         {0.0.0.0/0}       VirtualAppliance 10.0.0.4            Active

>[AZURE.NOTE]現在、UDR とハイブリッド ネットワークには制限があります。これは、今後のリリースで解決される予定です。ExpressRoute またはサイト間ネットワークを使用した DMZ を有効にする方法の例については、この後の例 3 と 4 で説明します。

#### IP 転送の説明
UDR と併用される機能に IP 転送があります。実際には自分自身宛てではないトラフィックを受信し、最終的な宛先に転送することができる仮想アプライアンス上の設定です。

たとえば、AppVM01 からのトラフィックが DNS01 サーバーに要求を行う場合、UDR ではこの要求をファイアウォールにルーティングします。IP 転送が有効になっている場合、DNS01 (10.0.2.4) 宛てのトラフィックはまずアプライアンス (10.0.0.4) で受信されて、最終的な宛先 (10.0.2.4) に転送されます。ファイアウォールで IP 転送が無効になっている場合、ルート テーブルに次ホップとしてファイアウォールが指定されていても、アプライアンスは、そのトラフィックを受け付けません。仮想アプライアンスを使用するには、忘れずにユーザー定義ルーティングと併せて IP 転送を有効にすることが重要です。

#### ネットワーク セキュリティ グループ (NSG) の説明
この例では、NSG グループを作成し、そこに単一のルールを設定します。このグループは、(SecNet を除いた) フロントエンドとバックエンドのサブネットにのみバインドします。ここで作成しているルールの内容は次のとおりです。

1.	インターネットから VNet 全体 (すべてのサブネット) への任意のトラフィック (すべてのポート) を拒否する。

この例では NSG が使用されていますが、NSG の主な役割は、手動構成のミスに対する第 2 の防御層としての機能です。ここでは、フロントエンド サブネットまたはバックエンド サブネットへのインターネットからの受信トラフィックをすべてブロックし、必ず SecNet サブネットを介してファイアウォールに (その後必要に応じてフロントエンド サブネットまたはバックエンド サブネットに) トラフィックを流すことを目指しています。加えて UDR ルールが設定されているので、万一フロントエンド サブネットまたはバックエンド サブネットにうまく到達できたトラフィックも (UDR が設定されているために) すべてファイアウォールへと送信させることができます。ファイアウォールは、そのようなトラフィックを非対称フローと見なし、その送信トラフィックは破棄されます。つまり、フロントエンド サブネットとバックエンド サブネットを保護するセキュリティは、1) FrontEnd001 と BackEnd001 のクラウド サービスのエンドポイントをすべて閉じる、2) インターネットからのトラフィックを NSG で拒否する、3) 非対称トラフィックをファイアウォールで破棄する、という 3 層構造になっています。

この例のネットワーク セキュリティ グループに存在するルールは 1 つだけである点に注目してください。セキュリティ サブネットを含め、仮想ネットワーク全体でインターネット トラフィックを拒否する、というルールが 1 つあるだけです。しかし、この NSG がバインドされるのはフロントエンド サブネットとバックエンド サブネットだけです。セキュリティ サブネットに入ってくるトラフィックに対してはルールの処理は適用されません。その結果、VNet 上の全アドレスに対するインターネット トラフィックが NSG ルールで拒否されていても、その NSG をセキュリティ サブネットにバインドしなければ、トラフィックはセキュリティ サブネットに到達します。

#### ファイアウォール ルール
ファイアウォールには、転送ルールを作成する必要があります。受信トラフィック、送信トラフィック、VNet 間トラフィックをすべてブロックまたは転送する役割を果たすファイアウォールには、多くのファイアウォール ルールが必要です。また、すべての受信トラフィックは、セキュリティ サービスのパブリック IP アドレス (の各種ポート) に到達し、そこでファイアウォールの処理が適用されます。手戻り作業をなくすために、あらかじめ論理フローを図式化したうえでサブネットとファイアウォール ルールを設定するようお勧めします。次の図では、この例で使用するファイアウォール ルールを論理的に示しています。
 
![Logical View of the Firewall Rules][10]

>[AZURE.NOTE]使用するネットワーク仮想アプライアンスによって管理ポートは異なります。ここでは、ポート 22、801、807 が使用される Barracuda NG Firewall を例に説明しています。ご使用のデバイスの管理に使用される実際のポートについては、アプライアンス製造元のマニュアルを参照してください。

#### ファイアウォール ルールの説明
セキュリティ サブネットは、ファイアウォールが唯一のリソースであるため、上の論理図では省略しています。この図にはファイアウォール ルールが示されており、実際の経路を指定するのではなく論理的にトラフィック フローを許可または拒否していることがわかります。また、RDP トラフィック用に選択した外部ポートは、他のトラフィックよりも大きな番号範囲 (8014 ～ 8026) を使用しています。また、見やすくするために、外部ポート番号は、ローカル IP アドレスの最後の 2 オクテットとある程度揃える形で選択しました (たとえば、ローカル サーバー アドレス 10.0.1.4 は外部ポート 8014 に関連付けられています)。ただし、競合さえしなければ、もっと大きなポート番号を使用してもかまいません。

この例では、7 種類のルールが必要です。そのルールについて種類ごとに説明します。

- 外部ルール (受信トラフィック用):
  1.	ファイアウォール管理ルール: ネットワーク仮想アプライアンスの管理ポート宛てのトラフィックを通過させるための App Redirect ルールです。
  2.	RDP ルール (Windows Server ごと): 個々のサーバーを RDP 経由で管理するためには、この 4 つのルール (サーバー 1 台につき 1 つ) が必要となります。使用するネットワーク仮想アプライアンスの機能によっては、これを 1 つのルールにまとめることもできます。
  3.	アプリケーション トラフィック ルール: フロントエンド Web トラフィック用とバックエンド トラフィック用 (Web サーバーからデータ層など) の 2 つのアプリケーション トラフィック ルールがあります。これらのルールの構成は、(サーバーが置かれている) ネットワーク アーキテクチャとトラフィック フロー (トラフィック フローの方向と使用ポート) によって異なります。
      - 実際のアプリケーション トラフィックは、1 つ目のルールによってアプリケーション サーバーに到達できます。ファイアウォール管理ルールと RDP ルールがセキュリティや管理を目的としているのに対し、アプリケーション ルールの目的は、外部のユーザーまたはサービスがアプリケーションにアクセスできるようにすることです。この例では、Web サーバー (ポート 80) が 1 台であるため、単一のファイアウォール アプリケーション ルールで、外部 IP 宛ての受信トラフィックを Web サーバーの内部 IP アドレスにリダイレクトすることになります。リダイレクトされたトラフィック セッションは、NAT によって内部サーバーに渡されます。
      - 2 つ目のアプリケーション トラフィック ルールはバック エンド ルールです。任意のポートを介した Web サーバーから AppVM01 サーバー (ただし、AppVM02 は不可) への通信を許可します。
- 内部ルール (VNet 間トラフィック用)
  4.	インターネットへの送信ルール: 任意のネットワークから特定のネットワークへのトラフィックの通過を許可するルールです。通常、ファイアウォールにはこのルールが、既定のルールとして (ただし無効状態で) あらかじめ設定されています。この例では、このルールを有効にする必要があります。
  5.	DNS ルール: DNS (ポート 53) のトラフィックのみに DNS サーバーへの通過を許可するルールです。この環境では、フロントエンドからバックエンドへのトラフィックの大部分がブロックされるため、このルールによって、任意のローカル サブネットからの DNS を明示的に許可しています。
  6.	サブネット間ルール: バックエンド サブネット上の任意のサーバーからフロントエンド サブネット上の任意のサーバーへの接続を許可するルールです (ただしその逆は不可)。
- フェールセーフ ルール (上記のルールに該当しないトラフィック用):
  7.	全トラフィック拒否ルール: このルールは (優先度の観点から) 必ず最後に置く必要があります。先行するいずれのルールにも該当しなかったトラフィック フローが、このルールによって破棄されます。これは既定のルールであり通常は有効になっているため、一般に変更は不要です。

>[AZURE.TIP]この例では、わかりやすくするために 2 つ目のアプリケーション トラフィック ルールで任意のポートを許可していますが、実際のシナリオでは、ポートとアドレス範囲をできるだけ具体的に指定して、このルールに対する攻撃対象領域を小さくする必要があります。

以上のルールをすべて作成したら、各ルールの優先度を再確認し、トラフィックの許可または拒否が意図したとおりになっていることを確かめてください。この例では、各ルールに優先順位が割り当てられています。

#### まとめ
これは、ネットワークを保護および分離するのに、やや複雑ですが完成度の高い方法です (例 2 ではアプリケーションの保護のみ、例 1 ではサブネットの分離のみを行いました)。この設計では、両方向のトラフィックを監視できます。また、受信アプリケーション サーバーを保護するだけでなく、このネットワーク上のすべてのサーバーにネットワーク セキュリティ ポリシーを適用します。さらに、使用されるアプライアンスに応じて、トラフィックの完全な監査と対応を実現できます。この例の詳細には、次のような内容が含まれています。

- PowerShell スクリプトを使用してこの例の DMZ を構築する方法
- ARM テンプレートを使用してこの例を構築する方法
- 各 UDR、NSG コマンド、ファイアウォール ルールの詳細な説明
- トラフィック フローの詳細なシナリオ (各層でトラフィックを許可または拒否する方法を示します)

[詳細な構築手順][Example3]に関するページを参照してください。

### 例 4 - サイト間の仮想アプライアンス VPN を使用してハイブリッド接続を追加する
[「はじめに」に戻る](#fast-start) | 詳細な構築手順は近日中に公開予定

![DMZ with NVA connected hybrid network][11]

#### 環境のセットアップ
ネットワーク仮想アプライアンス (NVA) を使用するハイブリッド ネットワークは、例 1、2、3 で説明したどの DMZ の種類にも追加できます。

上の図に示すように、オンプレミス ネットワークをネットワーク仮想アプライアンスを介して Azure 仮想ネットワークに接続する場合は、インターネット経由 (サイト間) の VPN 接続を使用します。

>[AZURE.NOTE]Azure のパブリック ピアリング オプションを有効にした状態で ExpressRoute を使用する場合は、静的ルートを作成して、ExpressRoute WAN エッジを介さずに企業のインターネット エッジの外に送出されるように NVA VPN の IP アドレスにルーティングする必要があります。これは、VPN セッションを中断する可能性の高い、ExpressRoute の Azure パブリック ピアリング オプションでは NAT が必要になるためです (一般的に、IPSec では NAT が好まれません)。

VPN が確立されると、NVA はすべてのネットワークとサブネットの中心的な "ハブ" になります。ファイアウォールの転送ルールにより、許可するトラフィック フロー、NAT を実行するトラフィック フロー、リダイレクトするトラフィック フロー、削除するトラフィック フロー (オンプレミス ネットワークと Azure の間のトラフィック フローが設計したとおりに流れる場合でも) が決まります。

トラフィック フローは、具体的な使用事例に応じてこの設計パターンで最適化されることもあれば、状態が低下することもあるため、慎重に検討する必要があります。

例 3 「ファイアウォール、UDR、NSG から成る DMZ を構築してネットワークを保護する」で構築した環境を使用した後にサイト間 VPN のハイブリッド ネットワーク接続を追加すると、次のような設計になります。

![DMZ with NVA connected using a Site-to-Site VPN][12]

上記の設計では、オンプレミスのルーター、または VPN 用のネットワーク仮想アプライアンスと互換性のあるその他のネットワーク デバイスが VPN クライアントになります。この物理デバイスの役割は、ネットワーク仮想アプライアンスで VPN 接続を開始して維持することです。

論理的な観点から、NVA にとってのネットワークは、4 つの独立した "セキュリティ ゾーン" で、NVA のルールがこれらのゾーン間のトラフィックに対する司令塔のように見えます。論理的に示すと次のようになります。

![Logical Network from NVA perspective][13]

#### まとめ
サイト間 VPN のハイブリッド ネットワーク接続を Azure 仮想ネットワークに追加すると、安全な方法でオンプレミス ネットワークを Azure に拡張できます。VPN 接続を使用している場合は、トラフィックが暗号化され、インターネット経由でルーティングされます。この例で行われたように、NVA を使用すると、セキュリティ ポリシーの適用と管理を一元化できます。この例の詳細には、次のような内容が含まれています。

- PowerShell スクリプトを使用してこの例の DMZ を構築する方法
- ARM テンプレートを使用してこの例を構築する方法
- トラフィック フローの詳細なシナリオ (この設計によるトラフィック フローを示します)

これらは、近日中に利用可能になり、このページからリンクされます。

### 例 5 - サイト間の Azure ゲートウェイ VPN を使用してハイブリッド接続を追加する
[「はじめに」に戻る](#fast-start) | 詳細な構築手順は近日中に公開予定

![DMZ with Gateway connected hybrid network][14]

#### 環境のセットアップ
Azure VPN ゲートウェイを使用するハイブリッド ネットワークは、例 1 と 2 で説明した DMZ の種類に追加できます。

上の図に示すように、オンプレミス ネットワークを Azure VPN ゲートウェイを介して Azure 仮想ネットワークに接続する場合は、インターネット経由 (サイト間) の VPN 接続を使用します。

>[AZURE.NOTE]Azure のパブリック ピアリング オプションを有効にした状態で ExpressRoute を使用する場合は、静的ルートを作成して、ExpressRoute WAN エッジを介さずに企業のインターネット エッジの外に送出されるように Azure VPN ゲートウェイの IP アドレスにルーティングする必要があります。これは、VPN セッションを中断する可能性の高い、ExpressRoute の Azure パブリック ピアリング オプションでは NAT が必要になるためです (一般的に、IPSec では NAT が好まれません)。

下図のように、このオプションを使用すると、環境には 2 つのネットワーク エッジが用意されます。1 つ目のエッジでは、Azure 内のネットワークのトラフィック フローおよび Azure とインターネット間のトラフィック フローを NVA と NSG が制御するのに対し、2 つ目のエッジは Azure VPN ゲートウェイで、オンプレミスと Azure の間で完全に切り離されて分離したネットワーク エッジです。

トラフィック フローは、具体的な使用事例に応じてこの設計パターンで最適化されることもあれば、状態が低下することもあるため、慎重に検討する必要があります。

例 1 「NSG を使用して単純な DMZ を構築する」で構築した環境を使用した後にサイト間 VPN のハイブリッド ネットワーク接続を追加すると、次のような設計になります。

![DMZ with Gateway connected using an ExpressRoute connection][15]

#### まとめ
サイト間 VPN のハイブリッド ネットワーク接続を Azure 仮想ネットワークに追加すると、安全な方法でオンプレミス ネットワークを Azure に拡張できます。ネイティブの Azure VPN ゲートウェイを使用する場合、トラフィックは IPSec によって暗号化され、インターネット経由でルーティングされます。また、Azure VPN ゲートウェイを使用すると、よりコストが低いオプションを利用できます (サード パーティ製のネットワーク仮想アプライアンスと同様に、追加のライセンス コストはありません)。ネットワーク仮想アプライアンスが使用されていない例 1 では、これが最も経済的です。この例の詳細には、次のような内容が含まれています。

- PowerShell スクリプトを使用してこの例の DMZ を構築する方法
- ARM テンプレートを使用してこの例を構築する方法
- トラフィック フローの詳細なシナリオ (この設計によるトラフィック フローを示します)

これらは、近日中に利用可能になり、このページからリンクされます。

### 例 6 - ExpressRoute を使用してハイブリッド接続を追加する
[「はじめに」に戻る](#fast-start) | 詳細な構築手順は近日中に公開予定

![DMZ with Gateway connected hybrid network][16]

#### 環境のセットアップ
ExpressRoute のプライベート ピアリング接続を使用するハイブリッド ネットワークは、例 1 または 2 で説明したいずれかの DMZ の種類に追加できます。

上の図に示すように、ExpressRoute のプライベート ピアリングでは、オンプレミス ネットワークと Azure 仮想ネットワークが直接接続されています。トラフィックは、サービス プロバイダーのネットワークと Microsoft/Azure のネットワークを通過するだけで、インターネットに到達することはありません。

>[AZURE.NOTE]Azure 仮想ゲートウェイで使用される動的ルーティングの複雑さから、ユーザー定義ルーティング (UDR) と ExpressRoute の使用には制限があります。ExpressRoute 接続の Azure ゲートウェイと通信するサブネットには、UDR を適用しないでください。また、Azure ゲートウェイを、UDR が関連付けられている他のサブネットの NextHop デバイスとすることはできません。UDR と ExpressRoute を完全に連携させる機能は、将来の Azure リリースで提供予定となっています。

</br>
>[AZURE.TIP]ExpressRoute を使用すると、企業のネットワーク トラフィックはインターネットから切り離された状態で維持されるため、セキュリティは強化され、パフォーマンスが大幅に向上し、ExpressRoute プロバイダーの SLA が考慮されます。ExpressRoute のパフォーマンスに関しては、Azure ゲートウェイでは最大 2 Gbps のスループットを実現できるのに対し、サイト間 VPN を使用する場合、Azure ゲートウェイの最大スループットは 200 Mbps になります。

下図に示すように、このオプションを使用すると、環境には 2 つのネットワーク エッジが用意されます。1 つ目のエッジでは、Azure 内のネットワークのトラフィック フローおよび Azure とインターネット間のトラフィック フローを NVA と NSG が制御するのに対し、ゲートウェイは、オンプレミスと Azure の間で完全に切り離されて分離したネットワーク エッジです。

トラフィック フローは、具体的な使用事例に応じてこの設計パターンで最適化されることもあれば、状態が低下することもあるため、慎重に検討する必要があります。

例 1 「NSG を使用して単純な DMZ を構築する」で構築した環境を使用した後に ExpressRoute のハイブリッド ネットワーク接続を追加すると、次のような設計になります。

![DMZ with Gateway connected using an ExpressRoute connection][17]

#### まとめ
ExpressRoute プライベート ピアリング ネットワーク接続を追加すると、安全で待機時間が短く、パフォーマンスの高い方法でオンプレミス ネットワークを Azure に拡張できます。また、ネイティブの Azure ゲートウェイを使用すると、この例で行われたように、よりコストが低いオプションを利用できます (サード パーティ製のネットワーク仮想アプライアンスと同様に、追加のライセンスはありません)。この例の詳細には、次のような内容が含まれています。

- PowerShell スクリプトを使用してこの例の DMZ を構築する方法
- ARM テンプレートを使用してこの例を構築する方法
- トラフィック フローの詳細なシナリオ (この設計によるトラフィック フローを示します)

これらは、近日中に利用可能になり、このページからリンクされます。

## 参照
### 役に立つ Web サイトとドキュメント
- ARM を使用した Azure へのアクセス: 
- PowerShell を使用した Azure へのアクセス: [https://azure.microsoft.com/ja-jp/documentation/articles/powershell-install-configure/](./powershell-install-configure.md)
- 仮想ネットワークのドキュメント:[https://azure.microsoft.com/documentation/services/virtual-network/](https://azure.microsoft.com/documentation/services/virtual-network/)
- ネットワーク セキュリティ グループのドキュメント: [https://azure.microsoft.com/documentation/articles/virtual-networks-nsg/](./virtual-network/virtual-networks-nsg.md)
- ユーザー定義ルーティングのドキュメント: [https://azure.microsoft.com/documentation/articles/virtual-networks-udr-overview/](./virtual-network/virtual-networks-udr-overview.md)
- Azure の仮想ゲートウェイ: [https://azure.microsoft.com/documentation/services/vpn-gateway/](https://azure.microsoft.com/documentation/services/vpn-gateway/)
- サイト間 VPN: [https://azure.microsoft.com/documentation/articles/vpn-gateway-site-to-site-create/](./virtual-network/vpn-gateway-site-to-site-create.md)
- ExpressRoute のドキュメント (「使用開始」および「方法」をご確認ください): [https://azure.microsoft.com/documentation/services/expressroute/](https://azure.microsoft.com/documentation/services/expressroute/)

<!--Image References-->
[0]: ./media/best-practices-network-security/flowchart.png "Security Options Flowchart"
[1]: ./media/best-practices-network-security/compliancebadges.png "Azure Compliance Badges"
[2]: ./media/best-practices-network-security/azuresecurityfeatures.png "Azure Security Features"
[3]: ./media/best-practices-network-security/dmzcorporate.png "A DMZ in a Corporate network"
[4]: ./media/best-practices-network-security/azuresecurityarchitecture.png "Azure Security Architecture"
[5]: ./media/best-practices-network-security/dmzazure.png "A DMZ in an Azure Virtual Network"
[6]: ./media/best-practices-network-security/dmzhybrid.png "Hybrid Network with Three Security Boundaries"
[7]: ./media/best-practices-network-security/example1design.png "Inbound DMZ with NSG"
[8]: ./media/best-practices-network-security/example2design.png "Inbound DMZ with NVA and NSG"
[9]: ./media/best-practices-network-security/example3design.png "Bi-directional DMZ with NVA, NSG, and UDR"
[10]: ./media/best-practices-network-security/example3firewalllogical.png "Logical View of the Firewall Rules"
[11]: ./media/best-practices-network-security/example4designoptions.png "DMZ with NVA Connected Hybrid Network"
[12]: ./media/best-practices-network-security/example4designs2s.png "DMZ with NVA Connected Using a Site-to-Site VPN"
[13]: ./media/best-practices-network-security/example4networklogical.png "Logical Network from NVA Perspective"
[14]: ./media/best-practices-network-security/example5designoptions.png "DMZ with Azure Gateway Connected Site-to-Site Hybrid Network"
[15]: ./media/best-practices-network-security/example5designs2s.png "DMZ with Azure Gateway Using Site-to-Site VPN"
[16]: ./media/best-practices-network-security/example6designoptions.png "DMZ with Azure Gateway Connected ExpressRoute Hybrid Network"
[17]: ./media/best-practices-network-security/example6designexpressroute.png "DMZ with Azure Gateway Using an ExpressRoute Connection"

<!--Link References-->
[Example1]: ./virtual-network/virtual-networks-dmz-nsg-asm.md
[Example2]: ./virtual-network/virtual-networks-dmz-nsg-fw-asm.md
[Example3]: ./virtual-network/virtual-networks-dmz-nsg-fw-udr-asm.md
[Example4]: ./virtual-network/virtual-networks-hybrid-s2s-nva-asm.md
[Example5]: ./virtual-network/virtual-networks-hybrid-s2s-agw-asm.md
[Example6]: ./virtual-network/virtual-networks-hybrid-expressroute-asm.md
[Example7]: ./virtual-network/virtual-networks-vnet2vnet-direct-asm.md
[Example8]: ./virtual-network/virtual-networks-vnet2vnet-transit-asm.md

<!---HONumber=Oct15_HO3-->