---
title: Azure SignalR Service のパフォーマンス ガイド
description: Azure SignalR Service のパフォーマンスとベンチマークの概要。 容量を計画するときに考慮する必要がある主要メトリック。
author: sffamily
ms.service: signalr
ms.topic: conceptual
ms.date: 11/13/2019
ms.author: zhshang
ms.openlocfilehash: 68cad32be177fa20794399157fca89e87c2f8f59
ms.sourcegitcommit: 28688c6ec606ddb7ae97f4d0ac0ec8e0cd622889
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/18/2019
ms.locfileid: "74157673"
---
# <a name="performance-guide-for-azure-signalr-service"></a>Azure SignalR Service のパフォーマンス ガイド

Azure SignalR Service を使用する主要な利点の 1 つは、SignalR アプリケーションのスケーリングの容易さです。 大規模なシナリオでは、パフォーマンスが重要な要素です。 

このガイドでは、SignalR アプリケーションのパフォーマンスに影響を及ぼす要素を紹介します。 さまざまなユースケース シナリオでの標準的なパフォーマンスについて説明します。 最後に、パフォーマンス レポートの生成に使用できる環境とツールを紹介します。

## <a name="term-definitions"></a>用語の定義

"*インバウンド*": Azure SignalR Service への受信メッセージ。

"*アウトバウンド*": Azure SignalR Service からの送信メッセージ。

"*帯域幅*": 1 秒あたりの全メッセージの合計サイズ。

"*既定モード*": Azure SignalR Service インスタンスが作成されたときの既定の動作モード。 Azure SignalR Service がクライアント接続を受け付ける前に、アプリ サーバーとそれの接続が確立されている必要があります。

"*サーバーレス モード*": Azure SignalR Service がクライアント接続のみを受け付けるモード。 サーバー接続は許可されません。

## <a name="overview"></a>概要

Azure SignalR Service には、さまざまなパフォーマンス キャパシティに対する 7 つの Standard レベルが定義されています。 このガイドでは、次の疑問にお答えします。

-   各レベルの標準的な Azure SignalR Service パフォーマンスはどの程度か

-   目的とするメッセージ スループット要件を Azure SignalR Service で満たせるか (例: 毎秒 100,000 件のメッセージ送信)

-   特定のシナリオにおいて、どのレベルが自分に合っているか。 または、適切なレベルを選ぶにはどうすればよいか

-   自分にはどのようなアプリ サーバー (VM サイズ) が適しているか。 それらをいくつデプロイすべきか

こうした疑問に答えるために、このガイドではまず、パフォーマンスに影響する要素を大まかに説明します。 その後、**エコー**、**ブロードキャスト**、**グループへの送信**、**接続への送信** (ピアツーピア チャット) という代表的なユース ケースについて、各レベルの最大インバウンドおよびアウトバウンド メッセージ数を示します。

このガイドですべてのシナリオ (さまざまなユース ケース、メッセージ サイズ、メッセージの送信パターンなどを含む) をカバーすることはできません。 しかし、役に立ついくつかの手法が得られます。

- インバウンドまたはアウトバウンド メッセージのおおよその要件を評価する。
- パフォーマンス表をチェックして適切なレベルを見つける。

## <a name="performance-insight"></a>パフォーマンスの分析情報

このセクションでは、パフォーマンス評価手法について説明してから、パフォーマンスに影響するすべての要素を列挙します。 最終的には、パフォーマンス要件を評価するうえで役立つ手法をお伝えします。

### <a name="methodology"></a>手法

"*スループット*" と "*待ち時間*" は、パフォーマンス チェックの 2 つの代表的な要素です。 Azure SignalR Service では、各 SKU レベルに独自のスループット スロットリング ポリシーがあります。 このポリシーで定義される "*最大許容スループット (インバウンドおよびアウトバウンド帯域幅)* " は、99% のメッセージでの待ち時間が 1 秒未満であるときに達成される最大スループットです。

待ち時間とは、接続でメッセージを送信してから、Azure SignalR Service からの応答メッセージを受信するまでの時間です。 **echo** を例に見てみましょう。 すべてのクライアント接続では、メッセージにタイム スタンプが追加されます。 クライアントには、アプリ サーバーのハブから元のメッセージが返されます。 したがって、伝達の遅延はクライアント接続ごとに簡単に計算されます。 **ブロードキャスト**、**グループへの送信**、**接続への送信**におけるすべてのメッセージには、タイム スタンプが追加されます。

数千のコンカレント クライアント接続をシミュレートするために、複数の VM が Azure の仮想プライベート ネットワークに作成されます。 これらの VM はすべて、同じ Azure SignalR Service インスタンスに接続します。

Azure SignalR Service の既定モードでは、クライアント VM と同じ仮想プライベート ネットワークにアプリ サーバー VM がデプロイされます。 リージョン間の待ち時間を排除するために、すべてのクライアント VM とアプリ サーバー VM は、同じリージョンの同じネットワークにデプロイされます。

### <a name="performance-factors"></a>パフォーマンスの要素

理論上、Azure SignalR Service のキャパシティは、計算リソースによって制限されます。CPU、メモリ、およびネットワークです。 たとえば、Azure SignalR Service への接続数が増えると、そのサービスで使用されるメモリが増えます。 メッセージ トラフィックが大きくなると (各メッセージが 2,048 バイトを超えるなど)、Azure SignalR Service のトラフィック処理に費やされる CPU サイクルが増えます。 一方、Azure のネットワーク帯域幅によっても、最大トラフィックに制限が課されます。

パフォーマンスに影響する要素としては、他にもトランスポートの種類があります。 [WebSocket](https://en.wikipedia.org/wiki/WebSocket)、[Server-Sent-Event](https://en.wikipedia.org/wiki/Server-sent_events)、[Long-Polling](https://en.wikipedia.org/wiki/Push_technology) の 3 種類です。 

WebSocket は、単一の TCP 接続における双方向かつ全二重の通信プロトコルです。 Server-Sent-Event は、サーバーからクライアントにメッセージをプッシュする一方向のプロトコルです。 Long-Polling では、クライアントが HTTP 要求を通じてサーバーから情報を定期的にポーリングする必要があります。 同じ条件下の同じ API では、WebSocket のパフォーマンスが最も高く、Server-Sent-Event がそれより遅く、Long-Polling が最も低速です。 Azure SignalR Service では、既定で WebSocket が推奨されます。

メッセージ ルーティングのコストによっても、パフォーマンスが制限されます。 Azure SignalR Service は、メッセージ ルーターの役割を果たしており、これによって一連のクライアントまたはサーバーから他のクライアントまたはサーバーにメッセージがルーティングされます。 シナリオや API が異なれば、必要なルーティング ポリシーも異なります。 

**エコー**では、クライアントがそれ自体にメッセージを送信するため、ルーティングの宛先もそれ自体です。 ルーティング コストは、このパターンが最も低くなります。 一方、**ブロードキャスト**と**グループへの送信**、**接続への送信**の場合、内部の分散データ構造を通じて、Azure SignalR Service によってターゲット接続が検索される必要があります。 この処理が加わることで、CPU、メモリ、ネットワーク帯域幅の使用量が増加します。 結果的に、パフォーマンスは低下します。

既定モードでは、アプリ サーバーも、特定のシナリオにおいてボトルネックになる可能性があります。 Azure SignalR SDK は、ハートビート シグナルを通じてすべてのクライアントとのライブ接続を維持しながら、ハブを呼び出す必要があります。

サーバーレス モードでは、クライアントが HTTP POST でメッセージを送信します。これは WebSocket ほど効率的ではありません。

さらなる要素はプロトコルです (JSON と [MessagePack](https://msgpack.org/index.html))。 MessagePack の方がサイズが小さく、配信速度も JSON より高速です。 ただし、MessagePack でパフォーマンスが改善されない場合もあります。 Azure SignalR Service は、クライアントからサーバーまたはその反対のメッセージの転送中、メッセージ ペイロードをデコードしないため、そのパフォーマンスがプロトコルの影響を受けることはありません。

まとめると、インバウンドとアウトバウンドのキャパシティは、次の要素の影響を受けます。

-   SKU レベル (CPU やメモリ)

-   接続の数

-   メッセージ サイズ

-   メッセージ送信速度

-   トランスポートの種類 (WebSocket、Server-Sent-Event、Long-Polling)

-   ユースケース シナリオ (ルーティング コスト)

-   アプリ サーバーとサービス接続 (サーバー モードの場合)


### <a name="finding-a-proper-sku"></a>適切な SKU を見つける

インバウンド/アウトバウンドのキャパシティを評価したり、特定のユース ケースに適したレベルを見つけたりするには、どうすればよいのでしょうか。

アプリ サーバーは十分に高性能で、パフォーマンスのボトルネックにならないと仮定しましょう。 このとき、各レベルについて、インバウンドとアウトバウンドの最大帯域幅をチェックします。

#### <a name="quick-evaluation"></a>簡単な評価

まず、いくつかの既定の設定を仮定して評価を単純化しましょう。 

- トランスポートの種類は WebSocket である。
- メッセージ サイズは 2,048 バイトである。
- メッセージは 1 秒おきに送信される。
- Azure SignalR Service が既定モードである。

レベルには、それぞれ固有の最大インバウンド帯域幅と最大アウトバウンド帯域幅があります。 インバウンドまたはアウトバウンド接続がその制限を超えると、滑らかなユーザー エクスペリエンスは保証されません。

**エコー**では、ルーティング コストが最も少ないので、最大インバウンド帯域幅が得られます。 **ブロードキャスト**では、最大アウトバウンド メッセージ帯域幅が定義されます。

次の 2 つの表で強調されている値を "*超えない*" ようにしてください。

|       エコー                        | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|-----------------------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections                       | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| **インバウンド帯域幅** | **2 MBps**    | **4 MBps**    | **10 MBps**   | **20 MBps**    | **40 MBps**    | **100 MBps**   | **200 MBps**    |
| アウトバウンド帯域幅 | 2 MBps   | 4 MBps   | 10 MBps  | 20 MBps   | 40 MBps   | 100 MBps  | 200 MBps   |


|     ブロードキャスト             | Unit1 | Unit2 | Unit5  | Unit10 | Unit20 | Unit50  | Unit100 |
|---------------------------|-------|-------|--------|--------|--------|---------|---------|
| Connections               | 1,000 | 2,000 | 5,000  | 10,000 | 20,000 | 50,000  | 100,000 |
| インバウンド帯域幅  | 4 KBps   | 4 KBps   | 4 KBps    | 4 KBps    | 4 KBps    | 4 KBps     | 4 KBps    |
| **アウトバウンド帯域幅** | **4 MBps**    | **8 MBps**    | **20 MBps**    | **40 MBps**    | **80 MBps**    | **200 MBps**    | **400 MBps**   |

"*インバウンド帯域幅*" と "*アウトバウンド帯域幅*" は、1 秒あたりのメッセージ サイズの合計です。  その計算式は次のとおりです。
```
  inboundBandwidth = inboundConnections * messageSize / sendInterval
  outboundBandwidth = outboundConnections * messageSize / sendInterval
```

- *inboundConnections*: メッセージを送信する接続の数。

- *outboundConnections*: メッセージを受信する接続の数。

- *messageSize*: 1 つのメッセージのサイズ (平均値)。 1,024 バイト未満の小さなメッセージは、1,024 バイトのメッセージと同様の影響をパフォーマンスに及ぼします。

- *sendInterval*: 1 件のメッセージの送信時間。 通常はメッセージあたり 1 秒で、これは毎秒 1 件のメッセージが送信されることを意味します。 間隔が小さいほど、一定時間に送信されるメッセージの数が増えることになります。 たとえばメッセージあたり 0.5 秒であれば、毎秒 2 件のメッセージが送信されます。

- *接続*:レベルごとに Azure SignalR Service で確保されている最大しきい値。 それよりも接続数が増えると、接続スロットリングの対象となります。

#### <a name="evaluation-for-complex-use-cases"></a>複雑なユース ケースの評価

##### <a name="bigger-message-size-or-different-sending-rate"></a>より大きいメッセージ サイズまたは異なる送信速度

実際のユース ケースはもっと複雑です。 送信されるメッセージのサイズは 2,048 バイトを超えるかもしれません。また、メッセージの送信速度は、1 秒あたり 1 メッセージとは限りません。 Unit100 のブロードキャストを例に、そのパフォーマンスの評価方法を考えてみましょう。

次の表は、**ブロードキャスト**の実際のユース ケースを示します。 ただし、メッセージ サイズ、接続数、メッセージ送信速度は、前セクションで仮定したものと異なります。 問題は、メッセージ サイズ、接続数、メッセージ送信速度のうち、2 つしかわからない場合に、それらの項目をどうすれば推測できるかです。

| ブロードキャスト  | メッセージ サイズ | 1 秒あたりのインバウンド メッセージ数 | Connections | 送信間隔 |
|---|---------------------|--------------------------|-------------|-------------------------|
| 1 | 20 KB                | 1                        | 100,000     | 5 秒                      |
| 2 | 256 KB               | 1                        | 8,000       | 5 秒                      |

前の数式に基づいて、次の数式が簡単に得られます。

```
outboundConnections = outboundBandwidth * sendInterval / messageSize
```

前の表より、Unit100 の最大アウトバウンド帯域幅は 400 MB です。 メッセージ サイズが 20 KB の場合、最大アウトバウンド接続は 400 MB \* 5 / 20 KB = 100,000 となり、実際の値と一致します。

##### <a name="mixed-use-cases"></a>混在するユース ケース

実際のユース ケースでは、基本的な 4 つのユース ケース (**エコー**、**ブロードキャスト**、**グループへの送信**、**接続への送信**) が混在するのが一般的です。 キャパシティを評価するために使用する手法は、次のとおりです。

1. 混在するユース ケースを 4 つの基本的なユース ケースに分割します。
1. 前述の数式を使用して、最大インバウンドおよびアウトバウンドのメッセージ帯域幅を別々に計算します。
1. その帯域幅の計算を足し合わせて、最大インバウンド/アウトバウンド帯域幅の合計を求めます。 

そのうえで、最大インバウンド/アウトバウンド帯域幅の表から適切なレベルを選択してください。

> [!NOTE]
> 数百または数千の小さなグループへとメッセージを送信する場合や、数千のクライアントどうしが互いにメッセージを送信する場合、ルーティング コストの影響が大きくなります。 この影響を考慮に入れるようにしてください。

メッセージをクライアントに送信するユース ケースでは、アプリ サーバーがボトルネックに "*ならない*" ようにしてください。 次の「ケース スタディ」セクションでは、必要なアプリ サーバーの数および構成すべきサーバー接続の数についてのガイドラインを提供します。

## <a name="case-study"></a>ケース スタディ

以降のセクションでは、**エコー**、**ブロードキャスト**、**グループへの送信**、**接続への送信**という、WebSocket トランスポートの代表的なユース ケースを見ていきます。 このセクションでは、各シナリオについて、Azure SignalR Service の現在のインバウンドおよびアウトバウンド キャパシティを示します。 また、パフォーマンスに影響を及ぼす主な要素についても説明します。

既定モードでは、アプリ サーバーによって Azure SignalR Service とのサーバー接続が 5 つ作成されます。 アプリ サーバーでは、既定で Azure SignalR Service SDK が使用されます。 次のパフォーマンス テスト結果では、サーバー接続が 15 個 (ブロードキャストおよび大きなグループへのメッセージ送信ではそれ以上) に増やされます。

ユース ケースが異なると、アプリ サーバーの要件が異なります。 **ブロードキャスト**では、必要なアプリ サーバーは少数です。 **エコー**と**接続への送信**では、必要なアプリ サーバーの数が多くなります。

すべてのユース ケースで、既定のメッセージ サイズは 2,048 バイトであり、メッセージの送信間隔は 1 秒です。

### <a name="default-mode"></a>既定モード

既定モードには、クライアント、Web アプリ サーバー、Azure SignalR Service が関係します。 各クライアントが 1 つの接続を表します。

#### <a name="echo"></a>エコー

まず、Web アプリが Azure SignalR Service に接続します。 次に、その Web アプリに対して多数のクライアントが接続します。そこで、アクセス トークンとエンドポイントを使用して、クライアントが Azure SignalR Service にリダイレクトされます。 その後、クライアントは、Azure SignalR Service との WebSocket 接続を確立します。

すべてのクライアントは、接続の確立後、タイム スタンプが含まれているメッセージを 1 秒おきに特定のハブに送信し始めます。 そのメッセージは、ハブによって元のクライアントにエコーバックされます。 各クライアントはエコーバックされたメッセージを受信すると、待ち時間を計算します。

次の図の 5 から 8 (赤色で強調表示されたトラフィック) はループになっています。 ループが既定の期間 (5 分) 実行されて、全メッセージの待ち時間の統計が得られます。

![エコーのユース ケースのトラフィック](./media/signalr-concept-performance/echo.png)

**エコー**の動作から、最大インバウンド帯域幅が最大アウトバウンド帯域幅と等しいことが確定されます。 詳細については、次の表を参照してください。

|       エコー                        | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|-----------------------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections                       | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| 1 秒あたりのインバウンド/アウトバウンド メッセージ数 | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| インバウンド/アウトバウンド帯域幅 | 2 MBps   | 4 MBps   | 10 MBps  | 20 MBps   | 40 MBps   | 100 MBps  | 200 MBps   |

このユース ケースでは、アプリ サーバーに定義されているハブを各クライアントが呼び出します。 ハブはただ、元のクライアント側で定義されたメソッドを呼び出します。 このハブは、**エコー**の場合に最も軽量となります。

```
        public void Echo(IDictionary<string, object> data)
        {
            Clients.Client(Context.ConnectionId).SendAsync("RecordLatency", data);
        }
```

このシンプルなハブであっても、**エコー**のインバウンド メッセージの負荷が増大すると、アプリ サーバーに対するトラフィック負荷が目立つようになります。 このトラフィック負荷に対応するには、大きな SKU レベルのアプリ サーバーが多数必要です。 次の表は、各レベルのアプリ サーバー数の一覧を示します。


|    エコー          | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections      | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| アプリ サーバー数 | 2     | 2     | 2     | 3      | 3      | 10     | 20      |

> [!NOTE]
> アプリ サーバーの CPU やメモリ、クライアント接続数、メッセージ サイズ、メッセージ送信速度、SKU レベルが、**エコー**の全体的なパフォーマンスに影響を及ぼします。

#### <a name="broadcast"></a>ブロードキャスト

**ブロードキャスト**では、メッセージを受信した Web アプリがすべてのクライアントにそれをブロードキャストします。 ブロードキャストするクライアントが増えるほど、すべてのクライアントを対象にしたメッセージ トラフィックも増えます。 次の図を参照してください。

![ブロードキャストのユース ケースのトラフィック](./media/signalr-concept-performance/broadcast.png)

少数のクライアントがブロードキャストしています。 インバウンド メッセージ帯域幅は小さいものの、アウトバウンド帯域幅は非常に大きくなります。 クライアント接続またはブロードキャスト レートが増えるにつれて、アウトバウンド メッセージ帯域幅が大きくなります。

次の表は、最大クライアント接続数、インバウンド/アウトバウンド メッセージ数、帯域幅をまとめたものです。

|     ブロードキャスト             | Unit1 | Unit2 | Unit5  | Unit10 | Unit20 | Unit50  | Unit100 |
|---------------------------|-------|-------|--------|--------|--------|---------|---------|
| Connections               | 1,000 | 2,000 | 5,000  | 10,000 | 20,000 | 50,000  | 100,000 |
| 1 秒あたりのインバウンド メッセージ数  | 2     | 2     | 2      | 2      | 2      | 2       | 2       |
| 1 秒あたりのアウトバウンド メッセージ数 | 2,000 | 4,000 | 10,000 | 20,000 | 40,000 | 100,000 | 200,000 |
| インバウンド帯域幅  | 4 KBps   | 4 KBps   | 4 KBps    | 4 KBps    | 4 KBps    | 4 KBps     | 4 KBps     |
| アウトバウンド帯域幅 | 4 MBps   | 8 MBps   | 20 MBps   | 40 MBps   | 80 MBps   | 200 MBps   | 400 MBps   |

メッセージを送信するブロードキャスト クライアントは、4 つ以下です。 インバウンド メッセージの量が少ないため、**エコー**と比べて、必要なアプリ サーバーの数は少なくなります。 SLA とパフォーマンスの両方を考慮しても、アプリ サーバーは 2 つで十分です。 ただし、不均衡を避けるため、特に Unit50 と Unit100 については、既定のサーバー接続を増やす必要があります。

|   ブロードキャスト      | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections      | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| アプリ サーバー数 | 2     | 2     | 2     | 2      | 2      | 2      | 2       |

> [!NOTE]
> Azure SignalR Service へのサーバー接続で不均衡が生じるのを避けるために、各アプリ サーバーで既定のサーバー接続を 5 から 40 に増やしてください。
>
> クライアント接続数、メッセージ サイズ、メッセージ送信速度、SKU レベルが、**ブロードキャスト**の全体的なパフォーマンスに影響を及ぼします。

#### <a name="send-to-group"></a>グループへの送信

**グループへの送信**ユース ケースは、トラフィック パターンが**ブロードキャスト**と似ています。 その違いは、クライアントが特定のグループにメッセージを送信するためには、それらが Azure SignalR Service との WebSocket 接続を確立した後でグループに参加する必要がある点です。 次の図に、そのトラフィック フローを示します。

![グループへの送信ユース ケースのトラフィック](./media/signalr-concept-performance/sendtogroup.png)

グループ メンバーとグループの数が、パフォーマンスに影響を及ぼす 2 つの要素です。 分析を単純化するために、2 種類のグループを定義します。

- **小さいグループ**: 各グループの接続数は 10 です。 グループ数は (最大接続数)/10 に等しくなります。 たとえば、Unit1 で接続数が 1,000 の場合、グループ数は 100 (= 1,000/10) です。

- **大きなグループ**: グループ数は常に 10 です。 グループ メンバー数は (最大接続数)/10 に等しくなります。 たとえば、Unit1 で接続数が 1,000 の場合、各グループのメンバー数は 100 (= 1,000/10) です。

**グループへの送信**では、Azure SignalR Service へのルーティング コストが発生します。それが分散データ構造を通じてターゲット接続を探す必要があるためです。 送信接続が増えると、コストが増えます。

##### <a name="small-group"></a>小さいグループ

多数の小さなグループに対してメッセージを送信する場合、ルーティング コストが著しく大きくなります。 現在、Azure SignalR Service の実装では、Unit50 でルーティング コストの制限に達します。 CPU やメモリを増やしても効果はなく、よって Unit100 を選んでも、仕様上、それ以上の向上は見込めません。 インバウンド帯域幅をさらに増やす必要がある場合は、カスタマー サポートにお問い合わせください。

|   小さなグループへの送信     | Unit1 | Unit2 | Unit5  | Unit10 | Unit20 | Unit50 | Unit100 |
|---------------------------|-------|-------|--------|--------|--------|--------|---------|
| Connections               | 1,000 | 2,000 | 5,000  | 10,000 | 20,000 | 50,000 | 100,000
| グループ メンバー数        | 10    | 10    | 10     | 10     | 10     | 10     | 10 
| グループ数               | 100   | 200   | 500    | 1,000  | 2,000  | 5,000  | 10,000 
| 1 秒あたりのインバウンド メッセージ数  | 200   | 400   | 1,000  | 2,500  | 4,000  | 7,000  | 7,000   |
| インバウンド帯域幅  | 400 KBps  | 800 KBps  | 2 MBps     | 5 MBps     | 8 MBps     | 14 MBps    | 14 MBps     |
| 1 秒あたりのアウトバウンド メッセージ数 | 2,000 | 4,000 | 10,000 | 25,000 | 40,000 | 70,000 | 70,000  |
| アウトバウンド帯域幅 | 4 MBps    | 8 MBps    | 20 MBps    | 50 MBps     | 80 MBps    | 140 MBps   | 140 MBps    |

多数のクライアント接続がハブを呼び出しているので、アプリ サーバー数もパフォーマンスに関して非常に重要です。 次の表では、推奨されるアプリ サーバー数を示します。

|  小さなグループへの送信   | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections      | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| アプリ サーバー数 | 2     | 2     | 2     | 3      | 3      | 10     | 20      |

> [!NOTE]
> アプリ サーバーの CPU やメモリ、クライアント接続数、メッセージ サイズ、メッセージ送信速度、ルーティング コスト、SKU レベルが、**小さなグループへの送信**の全体的なパフォーマンスに影響を及ぼします。

##### <a name="big-group"></a>大きなグループ

**大きなグループへの送信**では、ルーティング コストの制限に達する前にアウトバウンド帯域幅がボトルネックになります。 次の表は、最大アウトバウンド帯域幅を一覧にしたものです。これは**ブロードキャスト**の場合とほぼ同じです。

|    大きなグループへの送信      | Unit1 | Unit2 | Unit5  | Unit10 | Unit20 | Unit50  | Unit100 |
|---------------------------|-------|-------|--------|--------|--------|---------|---------|
| Connections               | 1,000 | 2,000 | 5,000  | 10,000 | 20,000 | 50,000  | 100,000
| グループ メンバー数        | 100   | 200   | 500    | 1,000  | 2,000  | 5,000   | 10,000 
| グループ数               | 10    | 10    | 10     | 10     | 10     | 10      | 10
| 1 秒あたりのインバウンド メッセージ数  | 20    | 20    | 20     | 20     | 20     | 20      | 20      |
| インバウンド帯域幅  | 80 KBps   | 40 KBps   | 40 KBps    | 20 KBps    | 40 KBps    | 40 KBps     | 40 KBps     |
| 1 秒あたりのアウトバウンド メッセージ数 | 2,000 | 4,000 | 10,000 | 20,000 | 40,000 | 100,000 | 200,000 |
| アウトバウンド帯域幅 | 8 MBps    | 8 MBps    | 20 MBps    | 40 MBps    | 80 MBps    | 200 MBps    | 400 MBps    |

送信接続数は 40 以下です。 アプリ サーバーへの負荷は小さいので、推奨される Web アプリは少数です。

|  大きなグループへの送信  | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections      | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| アプリ サーバー数 | 2     | 2     | 2     | 2      | 2      | 2      | 2       |

> [!NOTE]
> Azure SignalR Service へのサーバー接続で不均衡が生じるのを避けるために、各アプリ サーバーで既定のサーバー接続を 5 から 40 に増やしてください。
> 
> クライアント接続数、メッセージ サイズ、メッセージ送信速度、ルーティング コスト、SKU レベルが、**大きなグループへの送信**の全体的なパフォーマンスに影響を及ぼします。

#### <a name="send-to-connection"></a>接続への送信

**接続への送信**ユース ケースでは、クライアントが Azure SignalR Service との接続を確立する際、各クライアントが特殊なハブを呼び出して、それぞれの接続 ID を取得します。 パフォーマンス ベンチマークでは、すべての接続 ID を収集してそれらをシャッフルし、それらをすべてのクライアントに送信先として再割り当てします。 クライアントは、パフォーマンス テストが完了するまで、ターゲット接続にメッセージを送信し続けます。

![クライアントへの送信ユース ケースのトラフィック](./media/signalr-concept-performance/sendtoclient.png)

**接続への送信**のルーティング コストは、**小さなグループへの送信**のコストと似ています。

接続数が増えるにつれ、ルーティング コストによって全体的なパフォーマンスが制限されます。 Unit50 で制限に達しています。 その結果、Unit100 でそれ以上の向上は見込めません。

次の表は、**接続への送信**ベンチマークを繰り返し実行した後の統計的概要です。

|   接続への送信   | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50          | Unit100         |
|------------------------------------|-------|-------|-------|--------|--------|-----------------|-----------------|
| Connections                        | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000          | 100,000         |
| 1 秒あたりのインバウンド/アウトバウンド メッセージ数 | 1,000 | 2,000 | 5,000 | 8,000  | 9,000  | 20,000 | 20,000 |
| インバウンド/アウトバウンド帯域幅 | 2 MBps    | 4 MBps    | 10 MBps   | 16 MBps    | 18 MBps    | 40 MBps       | 40 MBps       |

このユース ケースでは、アプリ サーバー側に高い負荷がかかります。 推奨されるアプリ サーバー数については、次の表を参照してください。

|  接続への送信  | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections      | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| アプリ サーバー数 | 2     | 2     | 2     | 3      | 3      | 10     | 20      |

> [!NOTE]
> アプリ サーバーの CPU やメモリ、クライアント接続数、メッセージ サイズ、メッセージ送信速度、ルーティング コスト、SKU レベルが、**接続への送信**の全体的なパフォーマンスに影響を及ぼします。

#### <a name="aspnet-signalr-echo-broadcast-and-send-to-small-group"></a>ASP.NET SignalR のエコー、ブロードキャスト、小さなグループへの送信

Azure SignalR Service が提供するパフォーマンス キャパシティは、ASP.NET SignalR と同じです。 

ASP.NET SignalR に関して、パフォーマンス テストでは、[Standard サービス プラン S3](https://azure.microsoft.com/pricing/details/app-service/windows/) の Azure Web アプリを使用しています。

次の表は、ASP.NET SignalR の**エコー**で推奨される Web アプリ数を示しています。

|   エコー           | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections      | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| アプリ サーバー数 | 2     | 2     | 4     | 4      | 8      | 32      | 40       |

次の表は、ASP.NET SignalR の**ブロードキャスト**で推奨される Web アプリ数を示しています。

|  ブロードキャスト       | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections      | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| アプリ サーバー数 | 2     | 2     | 2     | 2      | 2      | 2      | 2       |

次の表は、ASP.NET SignalR の**小さなグループへの送信**で推奨される Web アプリ数を示しています。

|  小さなグループへの送信     | Unit1 | Unit2 | Unit5 | Unit10 | Unit20 | Unit50 | Unit100 |
|------------------|-------|-------|-------|--------|--------|--------|---------|
| Connections      | 1,000 | 2,000 | 5,000 | 10,000 | 20,000 | 50,000 | 100,000 |
| アプリ サーバー数 | 2     | 2     | 4     | 4      | 8      | 32      | 40       |

### <a name="serverless-mode"></a>サーバーレス モード

サーバーレス モードには、クライアントと Azure SignalR Service が関係します。 各クライアントが 1 つの接続を表します。 クライアントは、REST API を通じて別のクライアントにメッセージを送信するか、またはすべてにメッセージをブロードキャストします。

REST API を使用して高密度のメッセージを送信することは、WebSocket の使用ほど効率的ではありません。 毎回、新しい HTTP 接続を作成しなければならず、サーバーレス モードでは、それが余分なコストとなります。

#### <a name="broadcast-through-rest-api"></a>REST API を使用してブロードキャストする
すべてのクライアントが Azure SignalR Service との WebSocket 接続を確立します。 その後、一部のクライアントが REST API を通じてブロードキャストを開始します。 メッセージの送信 (インバウンド) は、すべて HTTP POST を通じて行われます。これは WebSocket と比べて効率的でありません。

|   REST API を使用してブロードキャストする     | Unit1 | Unit2 | Unit5  | Unit10 | Unit20 | Unit50  | Unit100 |
|---------------------------|-------|-------|--------|--------|--------|---------|---------|
| Connections               | 1,000 | 2,000 | 5,000  | 10,000 | 20,000 | 50,000  | 100,000 |
| 1 秒あたりのインバウンド メッセージ数  | 2     | 2     | 2      | 2      | 2      | 2       | 2       |
| 1 秒あたりのアウトバウンド メッセージ数 | 2,000 | 4,000 | 10,000 | 20,000 | 40,000 | 100,000 | 200,000 |
| インバウンド帯域幅  | 4 KBps    | 4 KBps    | 4 KBps     | 4 KBps     | 4 KBps     | 4 KBps      | 4 KBps      |
| アウトバウンド帯域幅 | 4 MBps    | 8 MBps    | 20 MBps    | 40 MBps    | 80 MBps    | 200 MBps    | 400 MBps    |

#### <a name="send-to-user-through-rest-api"></a>REST API を通じてユーザーに送信する
ベンチマークでは、すべてのクライアントにユーザー名を割り当てたうえで、Azure SignalR Service への接続を開始します。 クライアントは、Azure SignalR Service との WebSocket 接続を確立した後、HTTP POST を通じて他のクライアントにメッセージを送信し始めます。

|   REST API を通じてユーザーに送信する | Unit1 | Unit2 | Unit5  | Unit10 | Unit20 | Unit50  | Unit100 |
|---------------------------|-------|-------|--------|--------|--------|---------|---------|
| Connections               | 1,000 | 2,000 | 5,000  | 10,000 | 20,000 | 50,000  | 100,000 |
| 1 秒あたりのインバウンド メッセージ数  | 300   | 600   | 900    | 1,300  | 2,000  | 10,000  | 18,000  |
| 1 秒あたりのアウトバウンド メッセージ数 | 300   | 600   | 900    | 1,300  | 2,000  | 10,000  | 18,000 |
| インバウンド帯域幅  | 600 KBps  | 1.2 MBps  | 1.8 MBps   | 2.6 MBps   | 4 MBps     | 10 MBps     | 36 MBps    |
| アウトバウンド帯域幅 | 600 KBps  | 1.2 MBps  | 1.8 MBps   | 2.6 MBps   | 4 MBps     | 10 MBps     | 36 MBps    |

## <a name="performance-test-environments"></a>パフォーマンス テスト環境

以上に挙げたすべてのユース ケースは、Azure 環境でパフォーマンス テストを実施しました。 使用したクライアント VM は多くて 50 個、アプリ サーバー VM は多くて 20 個です。 次に、いくつかの詳しい情報を記載します。

- クライアント VM サイズ: StandardDS2V2 (vCPU × 2、メモリ 7 GB)

- アプリ サーバー VM サイズ: StandardF4sV2 (vCPU × 4、メモリ 8 GB)

- Azure SignalR SDK サーバー接続数: 15

## <a name="performance-tools"></a>パフォーマンス ツール

Azure SignalR Service のパフォーマンス ツールは、[GitHub](https://github.com/Azure/azure-signalr-bench/) にあります。

## <a name="next-steps"></a>次の手順

この記事では、代表的なユースケース シナリオにおける Azure SignalR Service のパフォーマンスの概要を紹介しました。

サービスの内部とそのスケーリングについて詳しくは、次のガイドを参照してください。

* [Azure SignalR Service の内部](signalr-concept-internals.md)
* [Azure SignalR Service のスケーリング](signalr-howto-scale-multi-instances.md)
