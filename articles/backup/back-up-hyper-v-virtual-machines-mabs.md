---
title: MABS で Hyper-V 仮想マシンをバックアップする
description: この記事では、Microsoft Azure Backup Server (MABS) を使用した仮想マシンのバックアップと回復の手順について説明します。
ms.topic: conceptual
ms.date: 07/18/2019
ms.openlocfilehash: 69e415b5aef179c2b64bb04e933593010c8b47d3
ms.sourcegitcommit: 6e87ddc3cc961945c2269b4c0c6edd39ea6a5414
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/18/2020
ms.locfileid: "77444062"
---
# <a name="back-up-hyper-v-virtual-machines-with-azure-backup-server"></a>Azure Backup Server を使用して Hyper-V 仮想マシンをバックアップする

この記事では、Microsoft Azure Backup Server (MABS) を使用して Hyper-V 仮想マシンをバックアップする方法について説明します。

## <a name="supported-scenarios"></a>サポートされるシナリオ

MABS では、次のシナリオで Hyper-V ホスト サーバー上で実行されている仮想マシンをバックアップできます。

- **ローカル ストレージまたは直接ストレージを持つ仮想マシン** - ローカル ストレージまたは直接接続ストレージを持つ Hyper-V ホスト スタンドアロン サーバー上でホストされている仮想マシンをバックアップします。 たとえば、ハード ドライブ、ストレージ エリア ネットワーク (SAN) デバイス、ネットワーク接続ストレージ (NAS) デバイスなどです。 MABS 保護エージェントはすべてのホストにインストールする必要があります。

- **CSV ストレージを持つクラスター内の仮想マシン** - クラスターの共有ボリューム (CSV) ストレージを持つ Hyper-V クラスター上でホストされている仮想マシンをバックアップします。 MABS 保護エージェントは、各クラスター ノードにインストールされます。

## <a name="host-versus-guest-backup"></a>ホスト バックアップとゲスト バックアップ

MABS では、Hyper-V VM のホスト レベルまたはゲスト レベルのバックアップを実行できます。 ホスト レベルでは、MABS 保護エージェントは Hyper-V ホスト サーバーまたはクラスターにインストールされ、そのホスト上で実行されている VM とデータ ファイル全体が保護されます。   ゲスト レベルでは、エージェントが各仮想マシンにインストールされ、そのコンピューター上のワークロードが保護されます。

どちらの方法にも長所と短所があります。

- ホスト レベルのバックアップは、ゲスト マシンで実行されている OS の種類に関係なく機能し、各 VM に MABS 保護エージェントをインストールする必要がないため、柔軟性があります。 ホスト レベルのバックアップをデプロイすると、仮想マシン全体、またはファイルとフォルダー (項目レベルの回復) を回復できます。

- ゲストレベルのバックアップは、仮想マシン上で実行されている特定のワークロードを保護する場合に役立ちます。 ホストレベルでは、VM または特定のファイル全体を回復できますが、特定のアプリケーションのコンテキストでの回復機能はありません。 たとえば、バックアップした VM から特定の SharePoint 項目を回復するには、その VM のゲストレベルのバックアップを実行する必要があります。 パススルー ディスクの格納データを保護する場合は、ゲストレベルのバックアップを使用します。 パススルーでは、仮想マシンがストレージ デバイスに直接アクセスすることが許可され、仮想ボリューム データは VHD ファイル内に格納されません。

## <a name="how-the-backup-process-works"></a>バックアップ プロセスのしくみ

MABS は次のように VSS でバックアップを行います。 この説明の手順は、わかりやすくするために番号が付けられています。

1. MABS ブロックベースの同期エンジンによって、保護された仮想マシンの最初のコピーが作成され、仮想マシンのコピーが完全であり、整合性があることが確認されます。

2. 最初のコピーが作成され、検証された後、MABS では Hyper-V VSS ライターを使用してバックアップがキャプチャされます。 VSS ライターは、データの整合性がある、MABS サーバーと同期された一連のディスク ブロックを提供します。 この方法には、MABS サーバーによる "完全バックアップ" の利点があると同時に、ネットワーク経由で転送する必要があるバックアップ データを最小限に抑えることができます。

3. Hyper-V を実行しているサーバー上の MABS 保護エージェントでは、既存の Hyper-V API が使用され、保護されている仮想マシンが VSS もサポートしているかどうかが判断されます。

   - 仮想マシンがオンライン バックアップの要件に準拠し、Hyper-V 統合サービス コンポーネントがインストールされている場合、Hyper-V VSS ライターでは仮想マシン上のすべての VSS 対応プロセスに VSS 要求が再帰的に転送されます。 この操作は、MABS 保護エージェントが仮想マシンにインストールされていない場合に発生します。 再帰的 VSS 要求により、Hyper-V VSS ライターでは、データを損失することなく VSS スナップショットがキャプチャされるように、ディスク書き込み操作を確実に同期させることができます。

     Hyper-V 統合サービス コンポーネントでは、仮想マシン上のボリューム シャドウ コピー サービス (VSS) で Hyper-V VSS ライターが呼び出され、それらのアプリケーション データの整合性のある状態が確保されます。

   - 仮想マシンがオンライン バックアップの要件に準拠していない場合、MABS では Hyper-V API が自動的に使用され、データ ファイルをキャプチャする前に仮想マシンが一時停止されます。

4. 仮想マシンの最初のベースライン コピーが MABS サーバーと同期された後、仮想マシンのリソースに加えられたすべての変更は新しい回復ポイントにキャプチャされます。 回復ポイントは、特定の時点における仮想マシンの整合性のある状態を表します。 回復ポイントのキャプチャは、1 日に少なくとも 1 回実行できます。 新しい回復ポイントが作成されると、MABS ではブロックレベルのレプリケーションを Hyper-V VSS ライターが組み合わせて使用され、最後の回復ポイントが作成された後に Hyper-V を実行するサーバー上で変更されたブロックが判断されます。 これらのデータ ブロックは MABS サーバーに転送され、保護されたデータのレプリカに適用されます。

5. MABS サーバーでは、回復データをホストするボリューム上で VSS が使用されるので、複数のシャドウコピーを使用できます。 これらの各シャドウ コピーを使用して個別に回復できます。 VSS 回復ポイントは MABS サーバーに保存されます。 Hyper-V を実行しているサーバー上に作成される一時コピーは、MABS 同期の間のみ保存されます。

>[!NOTE]
>
>Windows Server 2016 以降、Hyper-V 仮想ハード ディスクには、回復性がある変更追跡 (RCT) と呼ばれる変更追跡が組み込まれています。 MABS は RCT (Hyper-V のネイティブの変更追跡機能) を使用しているため、VM のクラッシュなどのシナリオで時間のかかる一貫性チェックの必要性が少なくなります。 RCT には、VSS スナップショットベースのバックアップによって提供される変更追跡よりも優れた回復性があります。 MABS V3 は、一貫性チェック中に変更されたデータのみを転送することで、ネットワークとストレージの消費をさらに最適化します。

## <a name="backup-prerequisites"></a>バックアップの前提条件

MABS で Hyper-V 仮想マシンをバックアップするための前提条件を次に示します。

|前提条件|詳細|
|------------|-------|
|MABS の前提条件|- 仮想マシンの項目レベルの回復を実行する (ファイル、フォルダー、ボリュームを回復する) 場合は、MABS サーバーに Hyper-V ロールをインストールする必要があります。  項目レベルではなく仮想マシンを回復するだけの場合、ロールは必要ありません。<br />- 1 台の MABS サーバー上でそれぞれ 100 GB の仮想マシンを 800 台まで保護できます。また、より大きなクラスターをサポートする複数の MABS サーバーを許可できます。<br />- MABS では、仮想マシンのバックアップ パフォーマンスを向上させるために、増分バックアップからページ ファイルが除外されます。<br />- MABS では、MABS サーバーと同じドメイン内、または子ドメインや信頼されたドメイン内の Hyper-V サーバーまたはクラスターをバックアップできます。 ワークグループまたは信頼されていないドメインで Hyper-V をバックアップする場合は、認証を設定する必要があります。 単一の Hyper-V サーバーの場合は、NTLM 認証または証明書認証を使用できます。 クラスターの場合は、証明書認証のみを使用できます。<br />- ホストレベルのバックアップを使用してパススルー ディスク上の仮想マシン データをバックアップすることはサポートされていません。 このシナリオでは、ホストレベルのバックアップを使用して VHD ファイルをバックアップし、ゲストレベルのバックアップを使用してホスト上では表示されない他のデータをバックアップすることをお勧めします。<br />   \- 重複除去されたボリュームに格納されている VM をバックアップできます。|
|Hyper-V VM の前提条件|- 仮想マシン上で実行されている統合コンポーネントのバージョンは、Hyper-V ホストのバージョンと同じである必要があります。 <br />- 仮想マシンの各バックアップのために、仮想ハード ディスク ファイルをホストしているボリューム上に、バックアップ時に Hyper-V が差分ディスク (AVHD) 用の十分な領域を確保できる空き領域が必要です。 この領域は、**最初のディスク サイズ \* チャーン率 \* バックアップ**期間という計算結果以上である必要があります。 クラスター上で複数のバックアップを実行している場合は、この計算を使用して各仮想マシンで AVHD に対応できる十分なストレージ容量が必要になります。<br />- Windows Server 2012 R2 を実行している Hyper-V ホスト サーバーに配置されている仮想マシンをバックアップするには、たとえ何も接続されていなくても、仮想マシンに SCSI コントローラーを指定する必要があります (Windows Server 2012 R2 のオンライン バックアップでは、Hyper-V ホストで新しい VHD を VM にマウントしてからマウントを解除します。 SCSI コントローラーのみがこれをサポートしているため、仮想マシンのオンライン バックアップに必要です。  この設定がない場合、仮想マシンをバックアップしようとするとイベント ID 10103 が発行されます)。|
|Linux の前提条件|- MABS を使用して Linux 仮想マシンをバックアップできます。 ファイル整合性のあるスナップショットのみがサポートされます。|
|CSV ストレージを使用して VM をバックアップする|- CSV ストレージの場合、Hyper-V サーバーにボリューム シャドウ コピー サービス (VSS) ハードウェア プロバイダーをインストールします。 VSS ハードウェア プロバイダーについては、記憶域ネットワーク (SAN) ベンダーにお問い合わせください。<br />- CSV クラスター内で 1 つのノードが突然シャットダウンした場合、MABS では、そのノードで実行されていた仮想マシンに対して整合性チェックが実行されます。<br />- CSV クラスター上で BitLocker ドライブ暗号化が有効な Hyper-V サーバーを再起動する必要がある場合は、Hyper-V 仮想マシンの整合性チェックを実行する必要があります。|
|SMB ストレージを使用して VM をバックアップする|- Hyper-V を実行しているサーバー上で自動マウントをオンにして、仮想マシンの保護を有効にします。<br />   - TCP Chimney Offload を無効にします。<br />- すべての Hyper-V machine$ アカウントに、特定のリモート SMB ファイル共有に対する完全なアクセス許可があることを確認します。<br />- 代替の場所への回復時にすべての仮想マシン コンポーネントのファイル パスが 260 文字未満であることを確認します。 そうでない場合、回復は成功する可能性がありますが、Hyper-V で仮想マシンをマウントできません。<br />- 以下のシナリオはサポートされていません。<br />     仮想マシンの一部のコンポーネントがローカル ボリュームにあり、一部のコンポーネントがリモート ボリュームにあるデプロイ、保管場所のファイル サーバーの IPv4 または IPv6 アドレス、およびリモートの SMB 共有を使用するコンピューターへの仮想マシンの回復。<br />- 各 SMB サーバーでファイル サーバー VSS エージェント サービスを有効にする必要があります。 **[役割と機能の追加]**  >  **[サーバーの役割の選択]**  >  **[ファイル サービスと記憶域サービス]**  >  **[ファイル サービス]**  >  **[ファイル サービス]**  >  **[ファイル サーバー VSS エージェント サービス]** で追加します。|

## <a name="back-up-virtual-machines"></a>仮想マシンをバックアップする

1. [MABS サーバー](backup-azure-microsoft-azure-backup.md)と[ストレージ](backup-mabs-add-storage.md)を設定します。 ストレージを設定するときは、次のストレージ容量のガイドラインを使用してください。
   - 仮想マシンの平均サイズ - 100 GB
   - MABS サーバーあたりの仮想マシンの数 - 800
   - 800 台の VM の合計サイズ - 80 TB
   - バックアップ ストレージに必要な領域 - 80 TB

2. Hyper-V サーバーまたは Hyper-V クラスター ノードで MABS 保護エージェントを設定します。 ゲストレベルのバックアップを実行している場合は、ゲストレベルでバックアップする VM にエージェントをインストールします。

3. MABS 管理者コンソールで、 **[保護]**  >  **[保護グループの作成]** をクリックし、**新しい保護グループの作成**ウィザードを開きます。

4. **[グループ メンバーの選択]** ページで、保護する VM を、それらが配置されている Hyper-V ホスト サーバーから選択します。 同じ保護ポリシーを持つすべての VM を 1 つの保護グループにまとめることをお勧めします。 領域を効率的に使用するには、コロケーションを有効にします。 複数のデータ ソースが 1 つのレプリカと回復ポイントのボリュームを持つように、コロケーションを使用して、同じディスクまたはテープ ストレージ上の異なる保護グループのデータを配置することができます。

5. **[データの保護方法の選択]** ページで、保護グループ名を指定します。 Azure Backup サービスを使用して Azure にデータをバックアップする場合は、 **[次を使用して短期的な保護を行う: ディスク]** を選択し、 **[オンライン保護を利用する]** を選択します。

6. **[短期的な目標値の指定]**  >  **[保有期間の範囲]** で、ディスク データを保持する期間を指定します。 **[同期頻度]** で、データの増分バックアップを実行する頻度を指定します。 または、増分バックアップの間隔を選択する代わりに、 **[回復ポイントの直前]** を有効にすることができます。 この設定を有効にすると、MABS ではスケジュールされた各回復ポイントの直前に高速完全バックアップが実行されます。

    > [!NOTE]
    >
    >アプリケーションで増分バックアップがサポートされている場合、アプリケーションのワークロードを保護していると、同期の頻度に従って回復ポイントが作成されます。 そうでない場合、MABS では増分バックアップではなく高速完全バックアップが実行され、高速バックアップのスケジュールに従って回復ポイントが作成されます。

7. **[ディスク割り当ての確認]** ページでは、保護グループに割り当てられている記憶域プールのディスク領域を確認します。

   **[合計データ サイズ]** は、バックアップするデータのサイズです。 **[Disk space to be provisioned on MABS]\(MABS にプロビジョニングするディスク領域\)** は、MABS が保護グループに推奨する領域です。 MABS では、設定に基づいて理想的なバックアップ ボリュームが選択されます。 ただし、 **[Disk allocation details]\(ディスク割り当ての詳細\)** でバックアップ ボリュームの選択を編集できます。 ワークロードの場合、ドロップダウン メニューで、優先ストレージを選択します。 編集すると、 **[利用できるディスク ストレージ]** ウィンドウの **[ストレージの合計]** と **[空きストレージ]** の値が変わります。 過小にプロビジョニングされた領域とは、今後もスムーズなバックアップを確実に行うためにボリュームに追加することを MABS から提案されるストレージの量です。

8. **[レプリカの作成方法の選択]** ページで、保護グループに含まれるデータの最初のレプリケーションの実行方法を指定します。 **[Automatically replicate over the network]\(ネットワーク経由で自動的にレプリケートする\)** を選択した場合は、オフピーク時を選択することをお勧めします。 データが大量にある場合や、ネットワークの状態が最適でない場合は、 **[手動]** を選択することを検討してください。この場合、リムーバブル メディアを使用してオフラインでデータをレプリケートする必要があります。

9. **[整合性チェック オプション]** ページで、整合性チェックを自動化する方法を選択します。 レプリカ データに不整合が生じた場合にのみ、またはスケジュールに従ってチェックを実行することができます。 自動整合性チェックを構成しない場合は、保護グループを右クリックし、 **[整合性チェックの実行]** を選択することで手動チェックをいつでも実行できます。

    保護グループを作成した後、選択した方法に従ってデータの最初のレプリケーションが行われます。 最初のレプリケーション後、各バックアップは保護グループの設定に従って実行されます。 バックアップ データを回復する必要がある場合は、次の点に注意します。

## <a name="back-up-virtual-machines-configured-for-live-migration"></a>ライブ マイグレーション用に構成された仮想マシンをバックアップする

仮想マシンがライブ マイグレーションに関係している場合、MABS 保護エージェントが Hyper-V ホストにインストールされている限り、MABS で引き続き仮想マシンが保護されます。 MABS で仮想マシンが保護される方法は、関係するライブ マイグレーションの種類によって異なります。

**クラスター内でのライブ マイグレーション** - 仮想マシンがクラスター内で移行されると、MABS によって移行が検出され、ユーザー操作なしで新しいクラスター ノードから仮想マシンがバックアップされます。 ストレージの場所は変更されないため、MABS では高速完全バックアップが継続されます。

**クラスター外でのライブ マイグレーション** - 仮想マシンがスタンドアロン サーバー間、異なるクラスター間、またはスタンドアロン サーバーとクラスター間で移行される場合、MABS によって移行が検出され、ユーザー操作なしで仮想マシンがバックアップされます。

### <a name="requirements-for-maintaining-protection"></a>保護を維持するための要件

ライブ マイグレーション中に保護を維持するための要件を次に示します。

- 仮想マシンの Hyper-V ホストは、System Center 2012 SP1 以降を実行している VMM サーバー上の System Center VMM クラウドに配置する必要があります。

- MABS 保護エージェントはすべての Hyper-V ホストにインストールする必要があります。

- MABS サーバーは VMM サーバーに接続する必要があります。 VMM クラウド内のすべての Hyper-V ホスト サーバーも MABS サーバーに接続する必要があります。 これで MABS は VMM サーバーと通信できるようになり、仮想マシンが現在実行されている Hyper-V ホスト サーバーを確認し、その Hyper-V サーバーから新しいバックアップを作成することができます。 Hyper-V サーバーへの接続を確立できない場合、MABS 保護エージェントにアクセスできないというメッセージでバックアップは失敗します。

- すべての MABS サーバー、VMM サーバー、および Hyper-V ホスト サーバーは同じドメインに属している必要があります。

### <a name="details-about-live-migration"></a>ライブ マイグレーションに関する詳細

ライブ マイグレーション中のバックアップについては、次の点に注意します。

- ライブ マイグレーションによってストレージが転送される場合、MABS によって仮想マシンの完全な整合性チェックが実行され、高速完全バックアップが続行されます。 ストレージのライブ マイグレーションが発生すると、Hyper-V では仮想ハード ディスク (VHD) または VHDX が再編成されます。その結果、MABS バックアップ データのサイズが一時的に急上昇します。

- 仮想マシン ホストで自動マウントをオンにして仮想保護を有効にし、TCP Chimney Offload を無効にします。

- MABS では、DPM-VMM ヘルパー サービスをホストするための既定のポートとしてポート 6070 が使用されます。 レジストリを変更するには:

    1. **HKLM\Software\Microsoft\Microsoft Data Protection Manager\Configuration** に移動します。
    2. 次の 32 ビットの DWORD 値を作成します。DpmVmmHelperServicePort。また、レジストリ キーの一部として新しいポート番号を書き込みます。
    3. ```<Install directory>\Azure Backup Server\DPM\DPM\VmmHelperService\VmmHelperServiceHost.exe.config``` を開き、ポート番号を 6070 から新しいポートに変更します。 例: ```<add baseAddress="net.tcp://localhost:6080/VmmHelperService/" />```
    4. DPM-VMM ヘルパー サービスを再起動し、DPM サービスを再起動します。

### <a name="set-up-protection-for-live-migration"></a>ライブ マイグレーション用の保護を設定する

ライブ マイグレーション用の保護を設定するには:

1. MABS サーバーとそのストレージを設定し、VMM クラウド内のすべての Hyper-V ホスト サーバーまたはクラスター ノードに MABS 保護エージェントをインストールします。 クラスターで SMB ストレージを使用している場合は、すべてのクラスター ノードに MABS 保護エージェントをインストールします。

2. MABS が VMM サーバーと通信できるように、VMM コンソールをクライアント コンポーネントとして MABS サーバーにインストールします。 コンソールは、VMM サーバー上で実行されているものと同じバージョンである必要があります。

3. VMM 管理サーバー上で、読み取り専用の管理者アカウントとして MABSMachineName$ アカウントを割り当てます。

4. `Set-DPMGlobalProperty` PowerShell コマンドレットを使用して、すべての Hyper-V ホスト サーバーをすべての MABS サーバーに接続します。 このコマンドレットは複数の MABS サーバー名を受け取ります。 `Set-DPMGlobalProperty -dpmservername <MABSservername> -knownvmmservers <vmmservername>` の形式で入力します。 詳細については、「[Set-DPMGlobalProperty](https://technet.microsoft.com/library/hh881752.aspx)」を参照してください。

5. VMM クラウド内の Hyper-V ホスト上で実行されているすべての仮想マシンが VMM で検出されたら、保護グループを設定し、保護する仮想マシンを追加します。 仮想マシンのモビリティ シナリオで保護するには、保護グループ レベルで自動整合性チェックを有効にする必要があります。

6. 設定が構成された後、仮想マシンをあるクラスターから別のクラスターに移行すると、すべてのバックアップは想定どおりに続行されます。 ライブ マイグレーションが有効なことは次のように確認できます。

   1. DPM-VMM ヘルパー サービスが実行されていることを確認します。 そうでない場合は開始します。

   2. Microsoft SQL Server Management Studio を開き、MABS データベース (DPMDB) をホストするインスタンスに接続します。 DPMDB で、`SELECT TOP 1000 [PropertyName] ,[PropertyValue] FROM[DPMDB].[dbo].[tbl_DLS_GlobalSetting]` のクエリを実行します。

      このクエリには `KnownVMMServer` というプロパティが含まれています。 この値は、`Set-DPMGlobalProperty` コマンドレットで指定した値と同じである必要があります。

   3. 次のクエリを実行して、特定の仮想マシンの `PhysicalPathXML` 内の *VMMIdentifier* パラメーターを検証します。 `VMName` は仮想マシンの名前に置き換えてください。

      ```sql
      select cast(PhysicalPath as XML) from tbl_IM_ProtectedObject where DataSourceId in (select datasourceid from tbl_IM_DataSource   where DataSourceName like '%<VMName>%')
      ```

   4. このクエリから返される .xml ファイルを開き、*VMMIdentifier* フィールドに値があることを確認します。

### <a name="run-manual-migration"></a>手動移行を実行する

前のセクションの手順を完了し、MABS Summary Manager ジョブが完了すると、移行は有効になります。 既定では、このジョブは午前 0 時に開始され、毎朝実行されます。 手動移行を実行する場合は、すべてが想定どおりに機能していることを確認するために、以下を実行します。

1. SQL Server Management Studio を開き、MABS データベースをホストするインスタンスに接続します。

2. クエリ `select * from tbl_SCH_ScheduleDefinition where JobDefinitionID='9B30D213-B836-4B9E-97C2-DB03C3EB39D7'` を実行します。 このクエリで **ScheduleID** が返されます。 次の手順で使用するので、この ID をメモします。

3. SQL Server Management Studio で **[SQL Server エージェント]** を展開し、次に **[ジョブ]** を展開します。 メモした **[ScheduleID]** を右クリックし、 **[ステップでジョブを開始]** を選択します。

ジョブの実行時はバックアップのパフォーマンスが影響を受けます。 展開のサイズとスケールによって、ジョブの完了までにかかる時間が決まります。

## <a name="back-up-replica-virtual-machines"></a>レプリカ仮想マシンをバックアップする

Windows Server 2012 R2 以降で MABS が実行されている場合は、レプリカ仮想マシンをバックアップできます。 これは次のいくつかの理由で役に立ちます。

**実行中のワークロードに対するバックアップの影響を軽減する** - 仮想マシンのバックアップを作成すると、スナップショットが作成されるときにオーバーヘッドが発生します。 バックアップ プロセスをセカンダリ リモート サイトにオフロードすることで、実行中のワークロードはバックアップ操作の影響を受けなくなります。 これは、バックアップ コピーがリモート サイトに保存され展開にのみ適用されます。 たとえば、バックアップを毎日作成し、データをローカルに保存して迅速な復元時間を確保しながら、長期保存のためにリモートに保存されたレプリカ仮想マシンから毎月または四半期ごとのバックアップを作成することができます。

**帯域幅を節約する** - 一般的なリモート ブランチ オフィス/本社の展開では、サイト間でバックアップ データを転送できる適切な量のプロビジョニングされた帯域幅が必要です。 データのバックアップ戦略に加え、レプリケーションとフェールオーバーの戦略を立てると、ネットワーク経由で送信される冗長データの量を減らすことができます。 プライマリではなくレプリカ仮想マシン データをバックアップすることで、バックアップ データをネットワーク経由で送信する際のオーバーヘッドを削減できます。

**ホスト バックアップを有効にする** - セカンダリ データセンターを必要とせずに、ホストされたデータセンターをレプリカ サイトとして使用できます。 この場合、ホスト SLA にはレプリカ仮想マシンの整合性のあるバックアップが必要です。

フェールオーバーが開始されるまでレプリカ仮想マシンは無効であり、VSS ではレプリカ仮想マシンのアプリケーション整合性バックアップを保証できません。 そのため、レプリカ仮想マシンのバックアップにはクラッシュ整合性のみがあります。 クラッシュ整合性を保証できない場合、バックアップは失敗します。これは次のようなさまざまな状況で発生する可能性があります。

- レプリカ仮想マシンは正常ではなく、重大な状態です。

- レプリカ仮想マシンは再同期中です ("再同期が進行中" または "再同期が必要" 状態)。

- プライマリ サイトとセカンダリ サイト間の最初のレプリケーションが、仮想マシンに対して進行中または保留中です。

- .hrl ログがレプリカ仮想マシンに適用されています。または、仮想ディスクに .hrl ログを適用する以前のアクションが失敗したか、取り消されたか、中断されました。

- レプリカ仮想マシンの移行またはフェールオーバーが進行中です

## <a name="recover-backed-up-virtual-machines"></a>バックアップされた仮想マシンを回復する

バックアップした仮想マシンを回復できる場合は、回復ウィザードを使用して仮想マシンと特定の回復ポイントを選択します。 回復ウィザードを開いて仮想マシンを回復するには、次の手順を実行します。

1. MABS 管理者コンソールで、VM の名前を入力するか、保護されている項目の一覧を展開して回復する VM を選択します。

2. **[回復ポイント]** ウィンドウのカレンダーで、任意の日付をクリックして使用できる回復ポイントを確認します。 次に、 **[パス]** ウィンドウで、回復ウィザードで使用する回復ポイントを選択します。

3. **[操作]** メニューの **[回復]** をクリックして回復ウィザードを開きます。

    選択した VM と回復ポイントが **[回復の選択の確認]** 画面に表示されます。 **[次へ]** をクリックします。

4. **[回復の種類の選択]** 画面で、データを回復する場所を選択してから **[次へ]** をクリックします。

    - **[元のインスタンスに回復する]** :元のインスタンスに回復すると、元の VHD は削除されます。 MABS によって、Hyper-V VSS ライターが使用され、VHD と他の構成ファイルが元の場所に回復されます。 回復プロセスが終了しても、仮想マシンは高可用なままです。
        リソース グループは回復のために存在している必要があります。 使用できない場合は、別の場所に回復してから仮想マシンを高可用にします。

    - **[仮想マシンとして任意のホストに回復します]** :MABS は別の場所への回復 (ALR) をサポートしています。これは、プロセッサ アーキテクチャに関係なく、保護対象の Hyper-V 仮想マシンを別の Hyper-V ホストにシームレスに回復できる機能です。 クラスター ノードに回復された Hyper-V 仮想マシンは高可用になりません。 このオプションを選択した場合、回復ウィザードには回復先と回復先のパスを識別する追加の画面が表示されます。

    - **[ネットワーク フォルダーにコピーする]** :MABS は、項目レベルの回復 (ILR) をサポートしています。これにより、ホストレベルの Hyper-V 仮想マシンのバックアップからネットワーク共有またはMABS で保護されたサーバー上のボリュームへのファイル、フォルダー、ボリューム、および仮想ハード ディスク (VHD) の項目レベルの回復を実行できます。 項目レベルの回復を実行するために、MABS 保護エージェントをゲスト内にインストールする必要はありません。 このオプションを選択した場合、回復ウィザードには回復先と回復先のパスを識別する追加の画面が表示されます。

5. **[回復オプションの指定]** で回復オプションを構成し、 **[次へ]** をクリックします。

    - 低い帯域幅で VM を回復している場合は、 **[変更]** をクリックして **[ネットワークの使用帯域幅の調整]** を有効にします。 調整オプションを有効にした後、使用できるようにする帯域幅の量と、その帯域幅を使用できる時間を指定できます。
    - ネットワークを構成した場合は、 **[ハードウェア スナップショットを使用した SAN ベースの回復を有効にする]** を選択します。
    - 回復処理が完了したらメール通知を送信する場合は、 **[Send an e-mail when the recovery completes]\(回復が完了したらメールを送信する\)** を選択し、メール アドレスを指定します。

6. [概要] 画面で、すべての詳細が正しいことを確認します。 詳細が正しくない場合、または変更する場合は、 **[戻る]** をクリックします。 設定に問題がなければ、 **[回復]** をクリックして回復プロセスを開始します。

7. **[回復状態]** 画面には、回復ジョブに関する情報が表示されます。

## <a name="next-steps"></a>次のステップ

[Azure Backup Server からのデータ復旧](https://docs.microsoft.com/azure/backup/backup-azure-alternate-dpm-server)
