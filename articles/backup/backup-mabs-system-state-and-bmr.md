---
title: Azure Backup Server でシステム状態を保護してベア メタルに回復する
description: Azure Backup Server を使用して、システム状態をバックアップし、とベア メタル回復 (BMR) 保護を提供します。
author: rayne-wiselman
manager: carmonm
keywords: ''
ms.service: backup
ms.topic: conceptual
ms.date: 05/15/2017
ms.author: raynew
ms.openlocfilehash: a21169a5d9da7c9f1baf8a7d1e7365348860fca1
ms.sourcegitcommit: c72ddb56b5657b2adeb3c4608c3d4c56e3421f2c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/24/2019
ms.locfileid: "68465028"
---
# <a name="back-up-system-state-and-restore-to-bare-metal-with-azure-backup-server"></a>Azure Backup Server を使用してシステム状態をバックアップし、ベア メタルに回復する

Azure Backup Server は、システム状態をバックアップし、ベア メタル回復 (BMR) 保護を提供します。

*   **システム状態のバックアップ**: オペレーティング システム ファイルをバックアップします。これにより、コンピューターの起動時に復旧できますが、システム ファイルとレジストリは失われます。 システム状態のバックアップには次の項目が含まれています。
    * ドメインのメンバー: ブート ファイル、COM+ クラス登録データベース、レジストリ
    * ドメイン コントローラー:Windows Server Active Directory (NTDS)、ブート ファイル、COM+ クラス登録データベース、レジストリ、システム ボリューム (SYSVOL)
    * クラスター サービスを実行しているコンピューター: クラスター サーバーのメタデータ
    * 証明書サービスを実行しているコンピューター: 証明書データ
* **ベア メタル バックアップ**: オペレーティング システム ファイルと重要なボリューム上のすべてのデータ (ユーザー データを除く) をバックアップします。 定義上、BMR バックアップには、システム状態のバックアップが含まれます。 これは、コンピューターが起動せず、すべてを復旧する必要があるときの保護を提供します。

次の表は、バックアップと復旧を実行できる項目のまとめです。 システム状態および BMR を使用して保護できるアプリのバージョンの詳細については、「[What does Azure Backup Server back up?](backup-mabs-protection-matrix.md)」(Azure Backup Server がバックアップするもの) を参照してください。

|バックアップ|問題|Azure Backup Server バックアップからの復旧|システム状態のバックアップからの復旧|BMR|
|----------|---------|---------------------------|------------------------------------|-------|
|**ファイル データ**<br /><br />通常のデータのバックアップ<br /><br />BMR/システム状態のバックアップ|ファイル データの損失|Y|N|N|
|**ファイル データ**<br /><br />ファイル データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|オペレーティング システムの損失または破損|N|Y|Y|
|**ファイル データ**<br /><br />ファイル データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|サーバーの損失 (データ ボリュームは正常)|N|N|Y|
|**ファイル データ**<br /><br />ファイル データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|サーバーの損失 (データ ボリュームも損失)|Y|いいえ|はい (BMR、この後にバックアップ ファイル データの通常回復を実行)|
|**SharePoint データ**:<br /><br />ファーム データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|サイト、リスト、リスト アイテム、ドキュメントの損失|Y|N|N|
|**SharePoint データ**:<br /><br />ファーム データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|オペレーティング システムの損失または破損|N|Y|Y|
|**SharePoint データ**:<br /><br />ファーム データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|障害復旧|N|N|N|
|Windows Server 2012 R2 Hyper-V<br /><br />HYPER-V ホストまたはゲストの Azure Backup Server のバックアップ<br /><br />BMR/ホストのシステム状態のバックアップ|VM の損失|Y|N|N|
|Hyper-V<br /><br />HYPER-V ホストまたはゲストの Azure Backup Server のバックアップ<br /><br />BMR/ホストのシステム状態のバックアップ|オペレーティング システムの損失または破損|N|Y|Y|
|Hyper-V<br /><br />HYPER-V ホストまたはゲストの Azure Backup Server のバックアップ<br /><br />BMR/ホストのシステム状態のバックアップ|HYPER-V ホストの損失 (VM は正常)|N|N|Y|
|Hyper-V<br /><br />HYPER-V ホストまたはゲストの Azure Backup Server のバックアップ<br /><br />BMR/ホストのシステム状態のバックアップ|HYPER-V ホストの損失 (VM も損失)|N|N|Y<br /><br />BMR、この後に通常の Azure Backup Server の回復を実行|
|SQL Server/Exchange<br /><br />Azure Backup Server のアプリのバックアップ<br /><br />BMR/システム状態のバックアップ|アプリ データの損失|Y|N|N|
|SQL Server/Exchange<br /><br />Azure Backup Server のアプリのバックアップ<br /><br />BMR/システム状態のバックアップ|オペレーティング システムの損失または破損|N|y|Y|
|SQL Server/Exchange<br /><br />Azure Backup Server のアプリのバックアップ<br /><br />BMR/システム状態のバックアップ|サーバーの損失 (データベース/トランザクション ログは正常)|N|N|Y|
|SQL Server/Exchange<br /><br />Azure Backup Server のアプリのバックアップ<br /><br />BMR/システム状態のバックアップ|サーバーの損失 (データベース/トランザクション ログも損失)|N|N|Y<br /><br />BMR 回復、この後に通常の Azure Backup Server の回復を実行|

## <a name="how-system-state-backup-works"></a>システム状態のバックアップのしくみ

システム状態のバックアップを実行すると、Backup Server は、Windows Server バックアップと通信し、サーバーのシステム状態のバックアップを要求します。 既定では、Backup Server および Windows Server バックアップは、使用可能な空き領域が最大であるドライブを使用します。 このドライブについての情報は、PSDataSourceConfig.xml ファイルに保存されています。 これは、Windows Server バックアップがバックアップに使用するドライブです。

Backup Server がシステム状態のバックアップに使用するドライブはカスタマイズできます。 保護されたサーバーで、C:\Program Files\Microsoft Data Protection Manager\MABS\Datasources に移動します。 PSDataSourceConfig.xml ファイルを開き、編集します。 ドライブ文字の \<FilesToProtect\> 値を変更します。 ファイルを保存して閉じます。 コンピューターのシステム状態を保護する保護グループ セットがある場合は、整合性チェックを実行します。 アラートが生成される場合は、アラートで **[保護グループの変更]** を選択し、ウィザードを完了します。 別の整合性チェックを実行します。

保護サーバーがクラスター内にある場合は、空き領域が最大のドライブとしてクラスター ドライブを選択できます。 そのドライブの所有権が別のノードに切り替わってからシステム状態バックアップが実行されると、そのドライブを使用できず、バックアップが失敗します。 このシナリオでは、PSDataSourceConfig.xml を変更してローカル ドライブを指すようにします。

次に、Windows Server バックアップは、復元フォルダーのルートに WindowsImageBackup という名前のフォルダーを作成します。 Windows Server バックアップがバックアップを作成するとき、すべてのデータがこのフォルダーに配置されます。 バックアップが完了したら、ファイルは Backup Server のコンピューターに転送されます。 次の情報をメモしておきます。

* このフォルダーとその内容は、バックアップまたは転送が完了してもクリーンアップされません。 これを考慮する最適な方法は、次回のバックアップが完了時のために領域を予約することです。
* バックアップするたびに、フォルダーが作成されます。 時刻と日付のタイムスタンプは、最後のシステム状態のバックアップの時刻です。

## <a name="bmr-backup"></a>BMR バックアップ

BMR (システム状態のバックアップを含む) では、バックアップ ジョブは Backup Server のコンピューター上の共有に直接保存されます。 保護されたサーバー上のフォルダーには保存されません。

Backup Server は、Windows Server バックアップを呼び出し、その BMR バックアップのレプリカ ボリュームを共有します。 この場合、空き容量が最大のドライブを使用することを Windows Server バックアップに通知しません。 代わりに、ジョブ用に作成された共有を使用します。

バックアップが完了したら、ファイルは Backup Server のコンピューターに転送されます。 ログは C:\Windows\Logs\WindowsServerBackup に格納されます。

## <a name="prerequisites-and-limitations"></a>前提条件と制限事項

-   BMR は、Windows Server 2003 を実行しているコンピューターまたはクライアントのオペレーティング システムを実行しているコンピューターではサポートされません。

-   別の保護グループで同じコンピューターの BMR とシステム状態を保護することはできません。

-   Backup Server のコンピューターは自身を保護して BMR を行うことはできません。

-   テープへの短時間の保護 (disk-to-tape、または D2T) は BMR ではサポートされていません。 テープへの長期保管 (disk-to-disk-to-tape、または D2D2T) はサポートされています。

-   BMR 保護では、Windows Server バックアップを保護対象のコンピューターにインストールする必要があります。

-   BMR 保護では、システム状態保護と異なり、Backup Server には保護対象コンピューターの容量要件はありません。 Windows Server バックアップは、Backup Server のコンピューターにバックアップを直接転送します。 バックアップ転送ジョブは、Backup Server の **[ジョブ]** ビューには表示されません。

-   Backup Server は、BMR 用にレプリカ ボリュームに 30 GB の領域を予約しています。 これは、[保護グループの変更] ウィザードの **[ディスク割り当て]** ページ、または Get-datasourcediskallocation PowerShell コマンドレットおよび Set-datasourcediskallocation PowerShell コマンドレットを使用して変更できます。 復旧ポイント ボリュームでは、BMR 保護で 5 日間保持するために約 6 GB が必要です。
    * 15 GB 未満にレプリカ ボリュームのサイズを減らすことができないことに注意してください。
    * Backup Server は、BMR データ ソースのサイズを計算しません。 すべてのサーバーに 30 GB を想定しています。 環境内の予想される BMR バックアップのサイズに基づいて値を変更します。 BMR バックアップのサイズは、すべての重要なボリュームの使用済み領域の合計として概算できます。 重要なボリューム = ブート ボリューム + システム ボリューム + Active Directory などのシステム状態データをホストしているボリューム。

-   システム状態保護から BMR 保護に変更する場合は、BMR 保護は、必要な領域が*復旧ポイント ボリューム*の領域より小さくなります。 ただし、ボリューム上の余分なスペースは再利用されません。 このボリューム サイズは、[保護グループの変更] ウィザードの **[ディスク割り当ての変更]** ページ、または Get-datasourcediskallocation PowerShell コマンドレットおよび Set-datasourcediskallocation PowerShell コマンドレットを使用して手動で縮小できます。

    システム状態保護から BMR 保護に変更する場合は、BMR 保護は、必要な領域が*レプリカ ボリューム*の領域より大きくなります。 このボリュームは自動的に拡張されます。 既定の領域割り当てを変更する場合は、Modify-diskallocation PowerShell コマンドレットを使用します。

-   BMR 保護からシステム状態保護に変更する場合は、必要な復旧ポイント ボリュームが大きくなります。 Backup Serverは、このボリュームを自動的に増やそうとする場合があります。 記憶域プールに十分な空き領域がない場合は、エラーが発生します。

    BMR 保護からシステム状態保護に変更する場合は、保護対象コンピューターに領域が必要です。 これは、システム状態保護はまずレプリカををローカル コンピューターに書き込み、その後 Backup Server のコンピューターに転送するためです。

## <a name="before-you-begin"></a>開始する前に

1.  **Azure Backup Server をデプロイ**します。 Backup Server が正しくデプロイされていることを確認します。 詳細については、次を参照してください。
    * [Azure Backup Server のシステム要件](https://docs.microsoft.com/system-center/dpm/install-dpm#setup-prerequisites)
    * [Backup Server の保護マトリックス](backup-mabs-protection-matrix.md)

2.  **記憶域をセットアップ**します。 Azure では、ディスク、テープ、およびクラウドにバックアップ データを格納できます。 詳細については、[データ記憶域の準備](https://docs.microsoft.com/system-center/dpm/plan-long-and-short-term-data-storage)に関するページを参照してください。

3.  **保護エージェントをセットアップ**します。 バックアップを作成するコンピューターに保護エージェントをインストールします。 詳細については、[DPM 保護エージェントのデプロイ](https://docs.microsoft.com/system-center/dpm/deploy-dpm-protection-agent)に関するページを参照してください。

## <a name="back-up-system-state-and-bare-metal"></a>システム状態とベア メタルのバックアップ
[保護グループのデプロイ](https://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)に関するページの説明に従って保護グループをセットアップします。 別のグループで同じコンピューターの BMR とシステム状態を保護することはできません。 また、BMR を選択した場合、システム状態は自動的に有効になります。


1.  Backup Server 管理者コンソールで、[新しい保護グループの作成] ウィザードを開くには、 **[保護]**  >  **[アクション]**  >  **[保護グループの作成]** の順に選択します。

2.  **[保護グループの種類の選択]** ページで、 **[サーバー]** を選択し、 **[次へ]** を選択します。

3.  **[グループ メンバーの選択]** ページで、コンピューターを展開して、**BMR** または**システム状態**のいずれかを選択します。

    別のグループで同じコンピューターの BMR とシステム状態の両方を保護することはできません。 また、BMR を選択した場合、システム状態は自動的に有効になります。 詳細については、[保護グループのデプロイ](https://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)に関するページを参照してください。

4.  **[データ保護方法の選択]** ページで、短期バックアップおよび長期バックアップを処理する方法を選択します。 短期バックアップは常にディスクへのバックアップが優先されますが、Azure Backup を使用してディスクから Azure クラウドにバックアップするオプションもあります (短期または長期)。 クラウドへの長期バックアップの代替方法は、スタンドアロン テープ デバイスまたは Backup Server に接続されているテープ ライブラリへの長期バックアップのセットアップです。

5.  **[Select Short-Term Goals]** (短期的な目標の選択) ページで、ディスクで短期的なストレージにバックアップする方法を選択します。
    1. **[リテンション期間]** では、ディスクにデータを保持する期間を選択します。 
    2. **[同期頻度]** では、ディスクへの増分バックアップを実行する頻度を選択します。 バックアップの間隔を設定しない場合は、 **[復旧ポイントの直前]** オプションのチェックボックスをオンにできます。 Backup Server は各復旧ポイントがスケジュールされる直前に、高速完全バックアップを実行します。

6.  長期保管でテープにデータを格納する場合、 **[Specify Long-Term Goals]** (長期的な目標の指定) ページで、テープにデータを保持する期間を選択します (1 ~ 99 年)。 
    1. **[バックアップの頻度]** では、テープへのバックアップを実行する頻度を選択します。 頻度は、選択したリテンション期間の範囲に基づいています。
        * リテンション期間が 1 ~ 99 年の場合は、毎日、毎週、隔週、毎月、四半期ごと、半年ごと、または毎年のバックアップを選択できます。
        * リテンション期間が 1 ~ 11 か月間の場合は、毎日、毎週、隔週、または毎月のバックアップを選択できます。
        * リテンション期間が 1 ~ 4 週間の場合は、毎日または毎週のバックアップを選択できます。

    2. **[Select Tape and Library Details]** (テープとライブラリの詳細の選択) ページでは、使用するテープとライブラリ、およびデータを圧縮して暗号化するかどうかを選択します。

7.  **[ディスク割り当ての確認]** ページでは、保護グループに割り当てられている記憶域プールのディスク領域を確認します。

    1. **合計データ サイズ**は、バックアップするデータのサイズです。
    2. **Azure Backup Server でプロビジョニングされるディスク領域**は、Backup Server が保護グループ用に推奨する領域です。 Backup Server は、設定に基づいて理想的なバックアップ ボリュームを選択します。 ただし、 **[Disk allocation 詳細]** でバックアップ ボリュームを編集できます。 
    3. ワークロードの場合、ドロップダウン メニューで、優先ストレージを選択します。 編集すると、 **[利用できるディスク ストレージ]** ウィンドウの **[ストレージの合計]** と **[空きストレージ]** の値が変わります。 過小にプロビジョニングされた領域は、スムーズなバックアップを確実に行うために、ボリュームに追加するように Backup Server が推奨するストレージの量です。

8.  **[レプリカ作成方法の選択]** ページで、最初の全データのレプリケーションを処理する方法を選択します。 ネットワーク経由でレプリケートする場合、ピーク時以外を選択することをお勧めします。 データが大量にある場合や、ネットワークの状態が最適でない場合は、リムーバブル メディアを使用してオフラインでデータをレプリケートすることを検討してください。

9. **[整合性チェック オプションの選択]** ページで、整合性チェックを自動化する方法を選択します。 整合性チェックは、レプリカ データが不整合になったときにのみ実行することや、スケジュールどおりに実行することを選択できます。 自動整合性チェックを構成しない場合は、いつでも手動でチェックを実行できます。 Backup Server 管理者コンソールの**保護**領域で保護グループを右クリックし、 **[整合性チェックの実行]** を選択します。

10. Azure Backup を使用して、クラウドにバックアップするよう選択した場合、 **[オンライン保護データの指定]** ページで、Azure にバックアップするワークロードを選択してください。

11. **[オンライン バックアップ スケジュールの指定]** ページで、Azure への増分バックアップを行う頻度を選択します。 毎日、毎週、毎月、および毎年をバックアップを実行するようにスケジュールできます。また、実行する日時を選択できます。 バックアップは、最大 1 日に 2 回実行できます。 バックアップが実行されるたびに、Backup Server のディスクに格納されたバックアップ データのコピーから Azure にデータ復旧ポイントが作成されます。

12. **[オンライン保持ポリシーの指定]** ページで、毎日、毎週、、毎月、毎年のバックアップから作成される復旧ポイントを Azure に保持する方法を選択します。

13. **[オンライン レプリケーションの選択]** ページで、最初の全データ レプリケーションの実行方法を選択します。 ネットワーク経由でのレプリケートまたはオフライン バックアップ (オフライン シード処理) を実行できます。 オフライン バックアップは、Azure Import 機能を使用します。 詳細については、「[Azure Backup でのオフライン バックアップのワークフロー](backup-azure-backup-import-export.md)」を参照してください。

14. **[概要]** ページで、設定を確認します。 **[グループの作成]** を選択した後、データの初期レプリケーションが実行されます。 データのレプリケーションが終了すると、 **[ステータス]** ページで、保護グループの状態は **[OK]** になります。 保護グループの設定に応じてバックアップが実行されます。

## <a name="recover-system-state-or-bmr"></a>システム状態または BMR の回復
BMR またはシステム状態をネットワークの場所に回復できます。 BMR をバックアップした場合には、Windows 回復環境 (WinRE) を使用して、システムを起動し、ネットワークに接続します。 次に、Windows Server バックアップを使用して、ネットワークの場所から回復します。 システム状態をバックアップした場合には、Windows Server バックアップを使用して、ネットワークの場所から回復するだけです。

### <a name="restore-bmr"></a>BMR の復元
Backup Server のコンピューターの回復を実行します。

1.  **[回復]** ウィンドウで、回復するコンピューターを検索し、 **[ベア メタル回復]** を選択します。

2.  使用可能な復旧ポイントがカレンダーに太字で示されます。 使用する復旧ポイントの日時を選択します。

3.  **[回復の種類の選択]** ページで **[ネットワーク フォルダーにコピーする]** を選択します。

4.  **[宛先の指定]** ページで、データのコピー先を選択します。 選択した宛先を十分な空き領域がある必要があることに注意してください。 新しいフォルダーを作成することをお勧めします。

5.  **[回復オプションの指定]** ページで、適用するセキュリティ設定を選択します。 次に、回復を迅速に行うために、記憶域ネットワーク (SAN) ベースのハードウェア スナップショットを使用するかどうかを選択します。 (これは、この機能を使用できる SAN があり、クローンを作成して分割し、書き込み可能にする機能がある場合のみ選択できます。 また、保護されたコンピューターおよび Backup Server のコンピューターが同じネットワークに接続されている必要があります。)

6.  通知オプションを設定します。 **[確認]** ページで **[回復]** を選択します。

共有の場所を設定します。

1.  復元場所で、バックアップのあるフォルダーに移動します。

2.  WindowsImageBackup フォルダーの 1 レベル上のフォルダーを共有にし、共有フォルダーのルートが WindowsImageBackup フォルダーになるようにします。 これを行わないと、復元でバックアップが検出されません。 Windows 回復環境 (WinRE) を使用して接続するには、正しい IP アドレスと資格情報で WinRE でアクセスできる共有が必要です。

システムの復元

1.  復元するシステムの Windows DVD を使用してイメージを復元するコンピューターを起動します。

2.  最初のページで、言語およびロケールの設定を確認します。 **[インストール]** ページで、 **[コンピューターの修復]** を選択します。

3.  **[システム回復オプション]** ページで、 **[以前に作成したシステム イメージを使用して、コンピューターを復元します]** を選択します。

4.  **[システム イメージ バックアップの選択]** ページで、 **[システム イメージを選択する]**  >  **[詳細設定]**  >  **[ネットワーク上のシステム イメージを検索する]** の順に選択します。 警告が表示されたら、 **[はい]** を選択します。 共有パスに移動して資格情報を入力し、復旧ポイントを選択します。 その復旧ポイントで使用可能な特定のバックアップをスキャンします。 使用する復旧ポイントを選択します。

5.  **[バックアップを復元する方法を選択する]** ページで、 **[ディスクをフォーマットしてパーティションに再分割する]** を選択します。 次のページで設定を確認します。 

6.  復元を開始するには、 **[完了]** を選択します。 再起動が必要です。

### <a name="restore-system-state"></a>システム状態の復元

Backup Server で回復を実行します。

1.  **[回復]** ウィンドウで、回復するコンピューターを検索し、 **[ベア メタル回復]** を選択します。

2.  使用可能な復旧ポイントがカレンダーに太字で示されます。 使用する復旧ポイントの日時を選択します。

3.  **[回復の種類の選択]** ページで **[ネットワーク フォルダーにコピーする]** を選択します。

4.  **[宛先の指定]** ページで、データのコピー先を選択します。 選択した宛先を十分な空き領域がある必要があることに注意してください。 新しいフォルダーを作成することをお勧めします。

5.  **[回復オプションの指定]** ページで、適用するセキュリティ設定を選択します。 次に、回復を迅速に行うために、SAN ベースのハードウェア スナップショットを使用するかどうかを選択します。 (これは、この機能を備えた SAN があり、クローンを作成して分割し、書き込み可能にする機能がある場合のみ選択できます。 また、保護されたコンピューターおよび Backup Server のサーバーが同じネットワークに接続されている必要があります。)

6.  通知オプションを設定します。 **[確認]** ページで **[回復]** を選択します。

Windows Server バックアップを実行します。

1.  **[アクション]**  >  **[回復]**  >  **[このサーバー]**  >  **[次へ]** の順に選択します。

2.  **[別のサーバー]** を選択し、 **[バックアップの場所の種類指定]** ページを選択し、 **[リモート共有フォルダー]** を選択します。 復旧ポイントを含むフォルダーへのパスを入力します。

3.  **[回復の種類の選択]** ページで **[システム状態]** を選択します。 

4. **[システム状態の回復先の場所を選択]** ページで **[元の場所]** を選択します。

5.  **[確認]** ページで **[回復]** を選択します。 復元後、サーバーを再起動します。

6.  また、コマンド プロンプトでもシステム状態の復元を実行できます。 これを行うには、回復するコンピューターで Windows Server バックアップを開始します。 バージョン識別子を取得するには、コマンド プロンプトに ```wbadmin get versions -backuptarget \<servername\sharename\>``` と入力します。

    バージョン識別子を使用してシステム状態の復元を開始します。 コマンド プロンプトに ```wbadmin start systemstaterecovery -version:<versionidentified> -backuptarget:<servername\sharename>``` と入力します。

    回復を開始することを確認します。 コマンド プロンプト ウィンドウでプロセスを表示できます。 復元ログが作成されます。 復元後、サーバーを再起動します。

