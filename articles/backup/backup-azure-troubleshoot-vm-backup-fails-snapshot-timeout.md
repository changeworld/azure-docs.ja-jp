<properties
   pageTitle="Azure VM のバックアップの失敗: スナップショットの状態について VM エージェントと通信できませんでした - スナップショット VM サブタスクがタイムアウトしました | Microsoft Azure"
   description="スナップショットの状態について VM エージェントと通信できませんでしたというエラーに関連する Azure VM のバックアップの失敗の症状の原因と解決策。スナップショット VM サブタスクのタイムアウト エラー"
   services="backup"
   documentationCenter=""
   authors="genlin"
   manager="jwhit"
   editor=""/>

<tags
    ms.service="backup"
    ms.workload="storage-backup-recovery"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="07/14/2016"
    ms.author="jimpark; markgal;genli"/>

# Azure VM のバックアップの失敗: スナップショットの状態について VM エージェントと通信できませんでした - スナップショット VM サブタスクがタイムアウトしました

## 概要

Azure Backup に仮想マシン (VM) を登録して、スケジュール設定すると、Azure Backup サービスは、スケジュールされた時刻に VM のバックアップ拡張機能と通信して、バックアップ ジョブを開始し、特定の時点のスナップショットを作成します。スナップショットをトリガーできず、バックアップの失敗につながる条件があります。この記事では、スナップショットのタイムアウト エラーに関連した Azure VM のバックアップの失敗に関連する問題のトラブルシューティング手順について説明します。

[AZURE.INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## 症状

サービスとしてのインフラストラクチャ (IaaS) VM に対する Microsoft Azure Backup が失敗し、Azure ポータルのジョブ エラーの詳細で次のエラー メッセージが返されます。

**スナップショットの状態について VM エージェントと通信できませんでした - スナップショット VM サブタスクがタイムアウトしました。**

## 原因
このエラーの一般的な原因には、次の 4 つがあります。

- VM がインターネットにアクセスできない。
- VM にインストールされている Microsoft Azure VM エージェントが古くなっている (Linux VM の場合)。
- バックアップ拡張機能の更新または読み込みに失敗した。
- スナップショットの状態を取得できなかったか、スナップショットを作成できなかった。

## 原因 1: VM がインターネットにアクセスできない
デプロイ要件によっては、VM がインターネットにアクセスできない場合や、設定されている制限により、Azure インフラストラクチャにアクセスできない場合があります。

バックアップ拡張機能が正常に機能するためには、Azure のパブリック IP アドレスへの接続が必要です。これは、バックアップ拡張機能が Azure Storage エンドポイント (HTTP URL) に VM のスナップショットを管理するコマンドを送信するためです。拡張機能がパブリック インターネットにアクセスできない場合は、最終的にバックアップが失敗します。

### 解決策
このシナリオでは、次のいずれかの方法を使用して問題を解決します。

- Azure データセンターの IP 範囲をホワイトリストに登録する
- フローに対する HTTP トラフィック用のパスを作成する

### Azure データセンターの IP 範囲をホワイトリストに登録するには

1. ホワイトリストに登録する [Azure データセンターの IP の一覧](https://www.microsoft.com/download/details.aspx?id=41653)を取得します。
2. New-NetRoute コマンドレットを使用して、IP アドレスのブロックを解除します。管理者特権での PowerShell ウィンドウ (管理者として実行) で、Azure VM 内でこのコマンドレットを実行します。
3. 規則をネットワーク セキュリティ グループ (NSG) に追加して IP へのアクセスを許可します (NSG を使用している場合)。

### HTTP トラフィックがフローするためのパスを作成するには

1. ネットワーク制限 (NSG など) を設定している場合は、トラフィックをルーティングするための HTTP プロキシ サーバーをデプロイします。
2. ネットワーク セキュリティ グループ (NSG) を使用している場合は、規則を追加して HTTP プロキシからインターネットへのアクセスを許可します。

[VM をバックアップできるように HTTP プロキシを設定する](backup-azure-vms-prepare.md#using-an-http-proxy-for-vm-backups)方法を確認してください。

## 原因 2: VM にインストールされている Microsoft Azure VM エージェントが古くなっている (Linux VM の場合)

### 解決策
Linux VM の場合、エージェントに関連するエラーまたは拡張機能に関連するエラーのほとんどは、古い VM エージェントに影響する問題が原因で発生します。一般的なガイドラインとして、この問題のトラブルシューティングを行うには、まず次の手順を実行します。

1. [最新の Azure VM エージェントをインストールします](https://github.com/Azure/WALinuxAgent)。
2. Azure エージェントが VM で実行されていることを確認します。これを行うには、```ps -e``` コマンドを実行します。

    このプロセスが実行されていない場合は、次のコマンドを使用してプロセスを再起動します。

    Ubuntu の場合: ```service walinuxagent start```

    その他のディストリビューションの場合: ```service waagent start
```

3. [エージェントの自動再起動を構成します](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash)。

4. 新しいテスト バックアップを実行します。エラーが解決しない場合は、さらにデバッグするために、次のフォルダーからログを収集してください。

    お客様の VM にある次のログが必要です。

    - /var/lib/waagent/*.xml
    - /var/log/waagent.log
    - /var/log/azure/*

waagent の詳細ログが必要な場合は、次の手順に従って、詳細なログ記録を有効にしてください。

1. /etc/waagent.conf ファイルで、次の行を見つけます。

    Enable verbose logging (y|n)

2. **Logs.Verbose** の値を n から y に変更します。
3. 変更を保存した後、このセクションの前の手順に従って waagent を再起動します。

## 原因 3: バックアップ拡張機能の更新または読み込みに失敗した
拡張機能を読み込むことができないと、スナップショットを作成できないため、Backup が失敗します。

### 解決策
Windows ゲストの場合:

1. iaasvmprovider サービスが有効になっていて、スタートアップの種類が自動になっていることを確認します。
2. そのように構成されていない場合は、サービスを有効にして、次のバックアップが成功するかどうかを確認します。

Linux ゲストの場合:

最新バージョンの VMSnapshot Linux (バックアップで使用される拡張機能) は 1.0.91.0 です。

バックアップ拡張機能の更新または読み込みがまだ失敗する場合は、VMSnapshot 拡張機能をインストールして強制的に再度読み込まれるようにします。次回のバックアップ時に、拡張機能が再度読み込まれます。

### 拡張機能をアンインストールするには

1. [Azure ポータル](https://portal.azure.com/)にアクセスします。
2. バックアップの問題が発生している特定の VM を見つけます。
3. **[設定]** をクリックします。
4. **[拡張機能]** をクリックします。
5. **[Vmsnapshot 拡張機能]** をクリックします。
6. **[アンインストール]** をクリックします。

これにより、次回のバックアップ時に拡張機能が再インストールされます。

## 原因 4: スナップショットの状態を取得できなかったか、スナップショットを作成できなかった
VM のバックアップは、基礎をなすストレージへのスナップショット コマンドの発行に依存します。ストレージにアクセスできないことや、スナップショット タスクの実行の遅延が原因で、バックアップが失敗することがあります。

### 解決策
次の場合にスナップショットのタスクが失敗することがあります。

| 原因 | 解決策 |
| ----- | ----- |
| VM で Microsoft SQL Server のバックアップが構成されている。既定では、VM のバックアップは Windows VM で VSS 完全バックアップとして実行されます。SQL Server ベースのサーバーを実行し、SQL Server のバックアップが構成されている VM では、スナップショットの実行の遅延が発生する場合があります。 | スナップショットの問題が原因でバックアップ エラーが発生している場合は、次のレジストリ キーを設定します。<br><br>[HKEY\_LOCAL\_MACHINE\\SOFTWARE\\MICROSOFT\\BCDRAGENT] "USEVSSCOPYBACKUP"="TRUE" |
| VM が RDP でシャットダウンされているため、VM の状態が正しく報告されない。RDP で仮想マシンをシャットダウンした場合は、ポータルでその VM の状態が正しく反映されているかどうかを確認します。 | 正しく反映されていない場合は、ポータルで VM のダッシュボードの [シャットダウン] オプションを使用して VM をシャットダウンします。 |
| 同じクラウド サービスから多数の VM が同時にバックアップするように構成されている。 | 同じクラウド サービスの VM は異なるバックアップ スケジュールに分散することをお勧めします。 |
| VM の CPU またはメモリの使用率が高くなっている。 | VM の CPU 使用率が高い (90% を超える) 場合、またはメモリ使用率が高い場合、スナップショット タスクがキューに配置され、遅延し、最終的にタイムアウトになります。このような状況では、オンデマンド バックアップを試してください。 |
|VM が DHCP からホスト/ファブリック アドレスを取得できない。|IaaS VM Backup が正しく機能するためには、ゲスト内で DHCP が有効になっている必要があります。VM が DHCP 応答 245 からホスト/ファブリック アドレスを取得できない場合は、拡張機能をダウンロードしたり実行したりできません。静的プライベート IP が必要な場合は、プラットフォームを通じて構成する必要があります。VM 内の DHCP オプションは有効のままにしておいてください。詳細については、[静的内部プライベート IP の設定](../virtual-network/virtual-networks-reserved-private-ip.md)に関する記事をご覧ください。|

<!---HONumber=AcomDC_0921_2016-->