<properties
	pageTitle="Azure における VM バックアップ インフラストラクチャの計画を立てる | Microsoft Azure"
	description="Azure における VM バックアップ インフラストラクチャの計画を立てる際の重要な考慮事項"
	services="backup"
	documentationCenter=""
	authors="Jim-Parker"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="10/29/2015"
	ms.author="trinadhk; aashishr; jimpark; markgal"/>

# Azure における VM バックアップ インフラストラクチャの計画を立てる
この記事では、仮想マシン (VM) バックアップ インフラストラクチャの計画を立てる際に考慮すべき重要な事柄について取り上げます。[必要な環境](backup-azure-vms-prepare.md)を準備したら、この手順を経て、[VM のバックアップ](backup-azure-vms.md)を開始することになります。Azure virtual machines について詳しい情報が必要な場合は、「[Virtual Machines のドキュメント](https://azure.microsoft.com/documentation/services/virtual-machines/)」を参照してください。

## Azure における仮想マシン バックアップの動作
Azure Backup サービスは、スケジュールされた時刻にバックアップ ジョブを開始し、バックアップ拡張機能をトリガーして特定時点のスナップショットを作成します。このスナップショットは Volume Shadow Copy Service (VSS) と連携して作成されるため、シャットダウンせずに、仮想マシンに使用されているディスクの一貫したスナップショットを取得することができます。

スナップショットが作成されると、データは Azure Backup サービスによってバックアップ資格情報コンテナーに転送されます。バックアップ プロセスの効率を高めるために、前回のバックアップ以降に変更されたデータ ブロックが特定され、そのデータのみが転送されます。

![Azure 仮想マシンのバックアップ アーキテクチャ](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

データ転送が完了すると、スナップショットが削除され、回復ポイントが作成されます。

### データの一貫性
業務に不可欠なデータのバックアップと復元は、その生成元となるアプリケーションの実行中にバックアップを行う必要があるため簡単ではありません。この課題に対処するために、Azure Backup は、VSS を使用してデータを正しくストレージに書き込むことにより、マイクロソフトのワークロードに対するアプリケーション整合性を確保しています。

>[AZURE.NOTE]Linux には VSS に相当するプラットフォームが存在しないため、Linux 仮想マシンに関しては、ファイル整合バックアップのみの対応となります。

Azure Backup は、Windows VM 上で VSS 完全バックアップを行います ([VSS 完全バックアップ](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)の詳細をご覧ください)。VSS コピー バックアップを有効にするには、VM に以下のレジストリ キーを設定する必要があります。

```
[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
"USEVSSCOPYBACKUP"="TRUE"
```


この表は、整合性の種類を一覧にしたものです。Azure VM のバックアップと復元で確保される状態をそれぞれ説明しています。

| 整合性 | VSS ベース | 説明と詳細 |
|-------------|-----------|---------|
| アプリケーション整合性 | あり | マイクロソフトのワークロードで最適な整合性の種類です。次の状態が確保されます。<ol><li>VM が*起動*する。<li>*破損がない*。<li>*データの損失がない*。<li> バックアップの時点で VSS を使用してアプリケーションを関連付けるので、データとそのデータを使用するアプリケーションとの間に整合性が保たれる。</ol> ほとんどの Microsoft ワークロードには、データの整合性に関連するワークロードに固有の操作を実行する VSS ライターがあります。たとえば、Microsoft SQL Server には、トランザクション ログ ファイルとデータベースへの書き込みが正常に行われることを保証する VSS ライターがあります。<br><br> Azure VM のバックアップの場合、アプリケーション整合性のある復旧ポイントを取得することは、VM のスナップショットが取得される前に、バックアップ拡張機能が VSS ワークフローを開始し、*正しく*完了できたことを意味します。これは、当然、Azure VM 内のすべてのアプリケーションの VSS ライターが起動されたことも意味します。<br><br>([VSS の基本](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx)と[詳しいしくみ](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)ついて学習してください。) |
| ファイル システム整合性 | あり - Windows ベースのコンピューターの場合 | 次の 2 つのシナリオで、復旧ポイントで*ファイル システム整合性*が保たれます。<ul><li>Azure の Linux VM のバックアップ。これは、Linux には VSS と同等のプラットフォームがないためです。<li>Azure の Windows VM のバックアップ中の VSS の障害。</li></ul> どちらの場合でも、次のことを確保することが重要です。<ol><li> VM が*起動する*。<li>*破損がない*。<li>*データの損失がない*。</ol> アプリケーションでは、復元されたデータに対する独自の "修正" メカニズムを実装する必要があります。|
| クラッシュ整合性 | いいえ | この状況は、(ソフト リセットまたはハード リセットにより) 仮想マシンが "クラッシュ" した状況に相当します。これは通常、バックアップ時に Azure 仮想マシンがシャットダウンされるときに発生します。Azure 仮想マシンのバックアップの場合、クラッシュの整合性の復旧ポイントを取得することは、Azure Backup が、オペレーティング システムの観点からもアプリケーションの観点からも、ストレージ メディア上のデータの整合性に関して何も保証しないことを意味します。バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。<br/><br/>保証はありませんが、ほとんどの場合、オペレーティング システムは起動します。通常、その後に chkdsk などのディスク検査手順が実行され、破損エラーがあれば修正されます。メモリ内にあったデータや、ディスクに完全にフラッシュされていなかったデータは、すべて失われます。通常、アプリケーションは、データのロールバックを実行する必要がある場合に独自の検証メカニズムに従います。<br><br>たとえば、データベースに存在しないエントリがトランザクション ログにある場合、データベース ソフトウェアは、データの整合性が得られる時点までロールバックします。(スパン ボリュームのように) データが複数の仮想ディスクにまたがる場合、クラッシュ整合性の復旧ポイントは、データの正確性に関して何も保証しません。|


## パフォーマンスおよびリソース使用率
オンプレミスにデプロイされるバックアップ ソフトウェアと同様、Azure における VM のバックアップも、容量とリソースの使用率を考慮する必要があります。[Azure Storage の制限](azure-subscription-service-limits.md#storage-limits)には、実行中のワークロードに対する影響を最小に抑え、パフォーマンスを最大にする VM のデプロイメントの構成が定義されています。

バックアップのパフォーマンスに影響を与える Azure Storage の制限には、主に次の 2 つがあります。

- ストレージ アカウントあたりの最大送信速度
- ストレージ アカウントあたりの合計要求レート

### ストレージ アカウントの制限
顧客のストレージ アカウントからバックアップ データがコピーされると、ストレージ アカウントの 1 秒あたりの入力/出力操作 (IOPS) および送信速度 (ストレージ スループット) メトリックスが計算されます。このとき同時に、IOPS およびスループットを消費する仮想マシンも実行されています。この目標は、バックアップおよび仮想マシンのトラフィック合計が、ストレージ アカウントの制限を超過しないことです。

### ディスクの数
バックアップは負荷の高い処理です。可能な限りバックアップを早く完了するために、使用可能なリソースをできるだけ多く消費しようとします。ただし、すべての I/O 操作には 1 秒あたり 60 MB の*単一 BLOB のターゲット スループット*の制限があります。バックアップ プロセスを高速化するために、VM の各ディスクは*並列*でバックアップされます。つまり、VM にディスクが 4 つある場合、Azure Backup は 4 つのディスクをすべて並行して更新します。したがって、顧客のストレージ アカウントから送信されるバックアップ トラフィックを決定する最も重要な唯一の要因は、ストレージ アカウントからバックアップされる**ディスクの数**になります。

### バックアップ スケジュール
パフォーマンスに影響を与えるもう 1 つの要因は、**バックアップ スケジュール**です。すべての VM が同時にバックアップされるように構成した場合、Azure Backup は、できるだけ多くのディスクをバックアップしようとするので、*並列*でバックアップされるディスクの数は増えます。したがって、ストレージ アカウントからバックアップされるトラフィックを減らすには、それぞれの VM が重複せずにバックアップされるように 1 日の異なる時間にバックアップするのが 1 つの方法です。

## 容量計画
これらの要素をすべてまとめると、ストレージ アカウントの用途は正確に計画する必要があることを意味します。ディスクに対する影響およびバックアップ スケジュールの選択肢を確認するには、[VM のバックアップ容量計画に関する Excel スプレッドシート](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33)をダウンロードしてください。

### バックアップのスループット
バックアップ対象の各ディスクは、Azure Backup がディスク上のブロックを読み込み、変更されたデータのみを格納します (増分バックアップ)。この表は、Azure Backup に見込まれる平均スループット値を示しています。これを使用すると、特定のサイズのディスクをバックアップするために要する時間を見積もることができます。

| バックアップ操作 | 最適なスループット |
| ---------------- | ---------- |
| 初回バックアップ | 160 Mbps |
| 増分バックアップ (DR) | 640 Mbps <br><br> このスループットは、ディスクにバックアップ対象の分散したチャーンが多数ある場合に、大幅に減ります。 |

### VM のバックアップの合計時間
VM のバックアップには、データの読み取りやコピーに多くのバックアップ時間が費やされますが、他にも必要な合計時間に影響を与える操作があります。

- [バックアップ拡張機能のインストールまたは更新](backup-azure-vms.md#offline-vms)の所要時間。
- スナップショットの時間。スナップショットをトリガーするのにかかった時間です。スナップショットは、スケジュールされたバックアップ時刻の近くでトリガーされます。
- キューの待機時間。バックアップ サービスは複数の顧客のバックアップを処理するため、スナップショットから Azure Backup コンテナーへのバックアップ データのコピーは直ちに開始されない場合があります。負荷のピーク時には、処理するバックアップ数に応じて、待機時間が最大 8 時間まで延長される可能性があります。ただし、毎日のバックアップ ポリシーでは、VM バックアップの合計時間は 24 時間未満になります。

## データの暗号化

Azure Backup では、データはバックアップ プロセスの一部として暗号化されません。ただし、VM 内でデータを暗号化し、保護されたデータをシームレスにバックアップできます ([暗号化データのバックアップ](backup-azure-vms-encryption.md)の詳細をご覧ください)。


## 保護するインスタンスの計算方法
Azure Backup を使用してバックアップされている Azure 仮想マシンは、[Azure Backup の価格](http://azure.microsoft.com/pricing/details/backup/)の対象になります。保護するインスタンスの計算は、仮想マシンの*実際*のサイズ (“リソース ディスク” を除く、仮想マシン上の全データの合計) に基づきます。

仮想マシンに接続されている各データ ディスクでサポートされている最大サイズ*ではなく*、データ ディスクに格納されている実際のデータに基づいて課金されます。同様に、バックアップ ストレージの課金は、Azure Backup で格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。

たとえば、最大サイズが各 1 TB のデータ ディスクが 2 台追加で搭載されている A2 標準サイズの仮想マシンがあります。次の表は、これらの各ディスクに格納されている実際のデータを示しています。

|ディスクの種類|最大サイズ|実際のデータ量|
|---------|--------|------|
| オペレーティング システム ディスク | 1023 GB | 17 GB |
| ローカル ディスク / リソース ディスク | 135 GB | 5 GB (バックアップに含まれない) |
| データ ディスク 1 |	1023 GB | 30 GB |
| データ ディスク 2 | 1023 GB | 0 GB |

この場合の仮想マシンの*実際*のサイズは、17 GB + 30 GB + 0 GB = 47 GB です。これが毎月の課金の基になる保護するインスタンス サイズになります。仮想マシンのデータ量が大きくなると、課金に使用される保護するインスタンス サイズも変化します。

課金は、最初のバックアップが正常に完了するまでは開始されません。この時点では、ストレージと保護するインスタンスの両方に対する課金が開始されます。仮想マシンの *Azure Backup で格納されているバックアップ データ*がある限り、課金は継続します。バックアップ データを保持している場合は、保護の停止操作を行っても課金は停止されません。

保護が停止され、*さらに*バックアップ データが削除されている場合のみ、指定した仮想マシンの課金が停止されます。アクティブなバックアップ ジョブがない場合 (保護が停止されている場合) は、最後にバックアップに成功した時点の仮想マシンのサイズは、毎月の課金の基になる保護するインスタンス サイズになります。

## 疑問がある場合
ご不明な点がある場合や今後搭載を希望する機能がある場合は、[フィードバックをお送りください](http://aka.ms/azurebackup_feedback)。

## 次のステップ

- [仮想マシンのバックアップ](backup-azure-vms.md)
- [仮想マシンのバックアップを管理する](backup-azure-manage-vms.md)
- [仮想マシンの復元](backup-azure-restore-vms.md)
- [VM のバックアップに関する問題のトラブルシューティング](backup-azure-vms-troubleshoot.md)

<!---HONumber=AcomDC_1217_2015-->