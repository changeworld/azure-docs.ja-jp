---
title: Azure Database for PostgreSQL (フレキシブル サーバー) でのバックアップと復元
description: Azure Database for PostgreSQL - フレキシブル サーバーでのバックアップと復元の概念について説明します
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: d0e79e42c7c004638336ada23de663bbe74b7e48
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/29/2021
ms.locfileid: "92532647"
---
# <a name="backup-and-restore-in-azure-database-for-postgresql---flexible-server"></a>Azure Database for PostgreSQL (フレキシブル サーバー) でのバックアップと復元

> [!IMPORTANT]
> Azure Database for PostgreSQL - フレキシブル サーバーはプレビュー段階です

バックアップは、あらゆるビジネス継続性戦略の重要な部分を形成します。 これは、不慮の破損や削除からデータを保護するのに役立ちます。 Azure Database for PostgreSQL - フレキシブル サーバーでは、サーバーが自動的にバックアップされ、バックアップは最大 35 日間保持されます。 復元時には、保持期間内で復元する日付と時刻を指定できます。 復元と復旧にかかる全体的な時間は、データベース ファイルのサイズと実行する復旧の量によって異なります。 

### <a name="backup-process-in-flexible-server"></a>フレキシブル サーバーでのバックアップ プロセス
最初のスナップショット バックアップは、フレキシブル サーバーの作成直後にスケジュールされます。 それ以降は、データ ファイルのスナップショット バックアップが毎日実行されます。 バックアップは、リージョン内のゾーン冗長ストレージに格納されます。 トランザクション ログ (先書きログ - WAL) も継続的にアーカイブされるため、最後にコミットされたトランザクションに復元することができます。 これらのデータとログのバックアップを使用すると、サーバーを、バックアップの構成済みリテンション期間内の任意の時点に復元できます。 すべてのバックアップが、AES 256 ビット暗号化を使用して暗号化されます。

データベースが高可用性で構成されている場合は、毎日のスナップショットがプライマリから実行され、継続的なログ バックアップがスタンバイから実行されます。

> [!IMPORTANT]
>停止したサーバーではバックアップは実行されません。 ただし、データベースが 7 日後に自動的に開始されるかユーザーによって開始されると、バックアップが再開されます。

バックアップは、フレキシブル サーバー内での復元操作にのみ使用できます。 フレキシブル サーバーにデータをエクスポートまたはインポートする場合は、[ダンプと復元](../howto-migrate-using-dump-and-restore.md)手法を使用します。


### <a name="backup-retention"></a>バックアップ保有期間

バックアップは、サーバーのバックアップ保持期間の設定に基づいて保持されます。 7 日間から 35 日間までの保持期間を選択できます。 既定の保持期間は 7 日に設定されています。 サーバーの作成時に保持期間を設定することも、後で更新することもできます。 停止したサーバーでもバックアップは保持されます。

バックアップの保持期間によって、現在からどのくらい遡ってポイントインタイム リストアを取得できるかが管理されます。ポイントインタイム リストアは使用可能なバックアップに基づいているためです。 バックアップの保有期間は、復元の観点から回復期間として扱うこともできます。 バックアップの保持期間内の特定の時点に復旧するために必要なすべてのバックアップは、バックアップ ストレージに保持されます。 たとえば、バックアップの保持期間が 7 日間に設定されている場合、回復期間は過去 7 日間と見なされます。 このシナリオでは、過去 7 日間のサーバーを復元および復旧するために必要なすべてのデータとログが保持されます。 


### <a name="backup-storage-cost"></a>バックアップ ストレージのコスト

フレキシブル サーバーを使用すると、プロビジョニングされているサーバー ストレージの最大 100% までが、バックアップ ストレージとして追加コストなしで提供されます。 バックアップ ストレージを追加で使用した場合は、1 か月ごとに GB 単位で請求されます。 たとえば、サーバーを 250 GiB のストレージでプロビジョニングした場合は、250 GiB のバックアップ ストレージ容量を追加料金なしで利用できます。 毎日のバックアップ使用量が 25 GiB の場合は、最大 10 日間の無料バックアップ ストレージを使用できます。 250 GiB を超えるバックアップ ストレージの使用は、[価格モデル](https://azure.microsoft.com/pricing/details/postgresql/)に従って課金されます。

Azure portal で "[使用されたバックアップ ストレージ](../concepts-monitoring.md)" メトリックを使用して、サーバーによって使用されるバックアップ ストレージを監視できます。 このバックアップ ストレージの使用量のメトリックは、サーバーに設定されているバックアップ保持間に基づいて保持されているすべてのデータベースのバックアップとログ バックアップによって使用されるストレージの合計を表します。  サーバーで大量のトランザクション アクティビティが発生すると、データベースの合計サイズに関係なく、バックアップ ストレージの使用量が増加する可能性があります。

バックアップ ストレージ コストを制御する主な方法は、適切なバックアップ保有期間を設定し、目的の回復目標を達成するための適切なバックアップ冗長オプションを選択することです。

> [!IMPORTANT]
> 現在、geo 冗長バックアップは、フレキシブル サーバーではサポートされていません。

## <a name="point-in-time-restore-overview"></a>ポイントインタイム リストアの概要

フレキシブル サーバーでは、ポイントインタイム リストアを実行すると、ソース サーバーと同じリージョンに、フレキシブル サーバーのバックアップから新しいサーバーが作成されます。 価格レベル、コンピューティング世代、仮想コア数、ストレージ サイズ、バックアップの保持期間、およびバックアップ冗長オプションについては、ソース サーバーの構成を使用して作成されます。 また、VNET やファイアウォールの設定などのタグと設定は、ソース サーバーから継承されます。 

 > [!IMPORTANT]
> ゾーン冗長の高可用性を使用して構成されたフレキシブル サーバーを復元する場合、復元されたサーバーは、高可用性なしで、プライマリ サーバーと同じリージョンに構成されます。 

 ### <a name="restore-process"></a>復元プロセス

物理データベース ファイルは、最初にスナップショット バックアップからサーバーのデータの場所に復元されます。 目的の時点より前に作成された適切なバックアップが自動的に選択され、復元されます。 その後、WAL ファイルを使用して復旧プロセスが開始されて、データベースを一貫性のある状態にします。 

 たとえば、バックアップが毎晩、午後 11 時に実行されているとします。 復元ポイントが 2020 年 8 月 15 日午前 10 時の場合は、2020 年 8 月 14 日の日次バックアップが復元されます。 データベースは、2020 年 8 月 25 日午前 10 時までは、8 月 24 日午後 11 時から 8 月 25 日午前 10 時までのトランザクション ログのバックアップを使用して復旧されます。 

 データベース サーバーを復元するには、[こちらの手順](./how-to-restore-server-portal.md)を参照してください。

> [!IMPORTANT]
> フレキシブル サーバーでの復元操作では、新しいデータベース サーバーが作成され、既存のデータベース サーバーは上書きされません。

ポイントインタイム リストアは複数のシナリオで役に立ちます。 たとえば、ユーザーが誤ってデータを削除したとき、重要なテーブルやデータベースを削除したとき、またはアプリケーションの不具合が原因で、適切なデータが不適切なデータで誤って上書きされた場合などです。 トランザクション ログの継続的バックアップによって、最後のトランザクションに復元できるようになります。

最も早い復元ポイントとカスタム復元ポイントのどちらかを選択できます。

-   **最も早い復元ポイント**:これは、保持期間に応じて、復元可能な最も早い時刻になります。 最も古いバックアップ時刻が自動選択され、ポータルに表示されます。 これは、特定の時点から開始する調査またはテストを行う場合に便利です。

-   **カスタム復元ポイント**:このオプションを使用すると、このフレキシブル サーバーに定義されている保持期間内の特定の時点を選択できます。 既定では、UTC の最新の時刻が自動選択され、テスト目的で最後にコミットされたトランザクションに復元する場合に便利です。 必要に応じて、他の日付と時刻を選択することもできます。 

復旧の推定所要時間は、データベースのサイズ、処理するトランザクション ログの量、ネットワーク帯域幅、同じリージョン内で同時に復旧するデータベースの合計数など、複数の要因によって異なります。 全体的な復旧時間は、通常は数分から数時間かかります。


> [!IMPORTANT]
> 削除したサーバーは、復元 **できません**。 サーバーを削除すると、そのサーバーに属するデータベースもすべて削除され、復元できなくなります。 管理者は、デプロイ後の誤削除や予期せぬ変更からサーバーのリソースを保護するために、[管理ロック](../../azure-resource-manager/management/lock-resources.md)を利用できます。

## <a name="perform-post-restore-tasks"></a>復元後のタスクの実行

データベースを復元した後、次のタスクを実行して、ユーザーとアプリケーションを元に戻して実行することができます。

-   元のサーバーを新しいサーバーで置き換える場合は、クライアントとクライアント アプリケーションを新しいサーバーにリダイレクトする。

-   ユーザーが接続できるように、適切なサーバー レベルのファイアウォールと VNet ルールが適用されていることを確認します。 これらのルールは配信元のサーバーからはコピーされません。
  
-   復元されたサーバーのコンピューティングは、必要に応じてスケールアップ/スケールダウンできます。

-   適切なログインとデータベース レベルのアクセス許可が適切に指定されていることを確認する。

-   必要に応じて、アラートを構成する。
  
-  高可用性で構成されたデータベースを復元した場合、および復元されたサーバーを高可用性で構成する場合は、[こちらの手順](./how-to-manage-high-availability-portal.md)に従うことができます。


## <a name="next-steps"></a>次のステップ

-   [ビジネス継続性](./concepts-business-continuity.md)について確認する
-   [ゾーン冗長による高可用性](./concepts-high-availability.md)について確認する
-   [復元方法](./how-to-restore-server-portal.md)を確認します