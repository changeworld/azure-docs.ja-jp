---
title: OPC Vault 証明書管理サービスを安全に実行する方法 - Azure | Microsoft Docs
description: Azure 上で OPC Vault 証明書管理サービスを安全に実行する方法について説明したうえで、考慮すべきその他のセキュリティ ガイドラインについて確認します。
author: mregen
ms.author: mregen
ms.date: 8/16/2019
ms.topic: conceptual
ms.service: industrial-iot
services: iot-industrialiot
manager: philmea
ms.openlocfilehash: 88f8188779c5fb6b3cd07c67e9f35a6b8f9ad97d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "79233387"
---
# <a name="run-the-opc-vault-certificate-management-service-securely"></a>OPC Vault 証明書管理サービスを安全に実行する

この記事では、Azure 上で OPC Vault 証明書管理サービスを安全に実行する方法について説明したうえで、考慮すべきその他のセキュリティ ガイドラインについて確認します。

## <a name="roles"></a>ロール

### <a name="trusted-and-authorized-roles"></a>信頼されたロールと承認済みロール

OPC Vault マイクロサービスでは、個別のロールからサービスのさまざまな部分にアクセスできます。

> [!IMPORTANT]
> デプロイ中に、スクリプトでは、すべてのロールのユーザーとしてデプロイ スクリプトを実行するユーザーのみを追加します。 運用環境へのデプロイでは、このロール割り当てを確認したうえで、以下のガイドラインに従って適切に再構成する必要があります。 このタスクでは、Azure Active Directory (Azure AD) エンタープライズ アプリケーション ポータル上でロールとサービスを手動で割り当てる必要があります。

### <a name="certificate-management-service-roles"></a>証明書管理サービスのロール

OPC Vault マイクロサービスでは、次のロールを定義します。

- **閲覧者**:既定では、テナント内のすべての認証済みユーザーに読み取りアクセス許可があります。 
  - アプリケーションと証明書の要求への読み取りアクセス許可です。 アプリケーションと証明書の要求の一覧を表示し、クエリを実行できます。 また、デバイス検出情報とパブリック証明書には、読み取りアクセス許可でアクセスできます。
- **ライター**:ライター ロールは、特定のタスクに対する書き込みアクセス許可を追加するためにユーザーに割り当てます。 
  - アプリケーションと証明書の要求への読み取り/書き込みアクセス許可です。 アプリケーションの登録、更新、および登録解除を行うことができます。 証明書の要求を作成して、承認された秘密キーと証明書を取得できます。 秘密キーを削除することもできます。
- **承認者**:承認者ロールは、証明書の要求を承認または拒否するためにユーザーに割り当てます。 ロールには、他のロールは含まれません。
  - ユーザーは、OPC Vault マイクロサービス API にアクセスするための承認者ロールに加え、証明書に署名できるように Azure Key Vault でのキー署名アクセス許可も保持している必要があります。
  - ライターと承認者のロールは、別のユーザーに割り当てる必要があります。
  - 承認者の主なロールは、証明書の要求の生成と拒否の承認です。
- **管理者**: 管理者ロールは、証明書グループを管理するためにユーザーに割り当てます。 ロールでは、承認者ロールはサポートされませんが、ライター ロールが含まれます。
  - 管理者は証明書グループを管理し、構成を変更できます。また、新しい証明書失効リスト (CRL) を発行して、アプリケーション証明書を失効させることができます。
  - ライター、承認者、および管理者の各ロールは、異なるユーザーに割り当てられることが理想です。 セキュリティを強化するために、承認者または管理者ロールを持つユーザーには、証明書を発行したり、発行者 CA 証明書を更新したりするために、KeyVault でのキー署名アクセス許可も必要です。
  - ロールには、マイクロサービス管理ロールに加え、以下も含まれます。ただし、限定されるわけではありません。
    - CA のセキュリティ プラクティスの実装管理の担当。
    - 証明書の生成、失効、および中断の管理。 
    - 暗号化キーのライフサイクル管理 (発行者 CA キーの更新など)。
    - CA を運用するサービスのインストール、構成、および維持。
    - サービスの日常的な操作。 
    - CA およびデータベースのバックアップと回復。

### <a name="other-role-assignments"></a>その他のロールの割り当て

サービスを実行するときは、以下のロールについても検討してください。

- 外部ルート証明機関との証明書調達契約のビジネス オーナー (たとえば、所有者が外部 CA から証明書を購入した場合、または外部 CA の下位にある CA を運用している場合)。
- 証明機関の開発と確認。
- 監査レコードの確認。
- CA のサポートや、物理上およびクラウドの設備の管理を支援するが、CA の運用を実施する際に直接の信頼を受けるわけではない担当者は、"*承認済み*" ロールに属します。 承認されたロールのユーザーが実行できる一連のタスクを文書化する必要もあります。

### <a name="review-memberships-of-trusted-and-authorized-roles-quarterly"></a>信頼済みおよび承認済みロールのメンバーシップを四半期ごとに確認する

信頼済みおよび承認済みロールのメンバーシップは、少なくとも四半期ごとに確認してください。 各ロールに属する一連のユーザー (手動プロセスの場合) またはサービス ID (自動化されたプロセスの場合) を必ず最小限に保たちます。

### <a name="role-separation-between-certificate-requester-and-approver"></a>証明書の要求者と承認者間での役割の分離

証明書の発行プロセスでは、証明書の要求元ロールと証明書の承認者ロール (ユーザーまたは自動化されたシステム) 間で、役割を分ける必要があります。 証明書の発行は、証明書の要求元が証明書の取得を承認されていることを確認する証明書の承認者ロールによって承認される必要があります。 証明書の承認者ロールを保持するユーザーは、正式に承認されたユーザーである必要があります。

### <a name="restrict-assignment-of-privileged-roles"></a>特権ロールの割り当てを制限する

管理者および承認者グループのメンバーシップの承認など、特権ロールの割り当ては、権限を持つ限られた数の担当者に制限する必要があります。 特権ロールのすべての変更は、24 時間以内にアクセスを取り消す必要があります。 最後に、特権ロールの割り当ては、四半期ごとに確認し、不要な割り当てや有効期限切れの割り当てはすべて削除します。

### <a name="privileged-roles-should-use-two-factor-authentication"></a>特権ロールでは 2 要素認証を使用する必要がある

承認者および管理者によるサービスへの対話型サインインでは、多要素認証 (2 要素認証とも呼ばれる) を使用します。

## <a name="certificate-service-operation-guidelines"></a>証明書サービス操作のガイドライン

### <a name="operational-contacts"></a>操作の連絡先

証明書サービスでは、詳細な操作上のインシデント対応の連絡先を含む、最新のセキュリティ対応プランがファイルに含まれている必要があります。

### <a name="security-updates"></a>セキュリティ更新プログラム

すべてのシステムは、継続的に監視を行い、最新のセキュリティ更新プログラムによって更新する必要があります。

> [!IMPORTANT]
> OPC Vault サービスの GitHub リポジトリは、セキュリティ パッチで継続的に更新されます。 これらの更新プログラムを監視し、定期的にサービスに適用します。

### <a name="security-monitoring"></a>セキュリティの監視

適切なセキュリティ監視をサブスクライブまたは実装します。 たとえば、中央監視ソリューション (Azure Security Center、O365 監視ソリューションなど) にサブスクライブして、セキュリティ イベントが監視ソリューションに確実に送信されるように適切な構成を行います。

> [!IMPORTANT]
> 既定では、OPC Vault サービスが、[Azure Application Insights](https://docs.microsoft.com/azure/azure-monitor/app/devops) と共に監視ソリューションとしてデプロイされます。 [Azure Security Center](https://azure.microsoft.com/services/security-center/) のようなセキュリティ ソリューションを追加することを強くお勧めします。

### <a name="assess-the-security-of-open-source-software-components"></a>オープン ソース ソフトウェア コンポーネントのセキュリティを評価する

製品またはサービス内で使用されるすべてのオープンソース コンポーネントは、中程度以上のセキュリティ脆弱性がない状態でなければなりません。

> [!IMPORTANT]
> OPC Vault サービスの GitHub リポジトリでは、継続的インテグレーションのビルド時に、すべてのコンポーネンが脆弱性についてスキャンされます。 GitHub 上のこれらの更新プログラムを注視し、定期的にサービスに適用します。

### <a name="maintain-an-inventory"></a>インベントリを維持する

すべての運用ホスト (永続仮想マシンを含む)、デバイス、すべての内部 IP アドレス範囲、VIP、およびパブリック DNS ドメイン名について、資産インベントリを保守します。 システム、デバイス IP アドレス、VIP、またはパブリック DNS ドメインを追加または削除する場合は、必ず 30 日以内にインベントリを更新する必要があります。

#### <a name="inventory-of-the-default-azure-opc-vault-microservice-production-deployment"></a>既定の Azure OPC Vault マイクロサービス運用環境デプロイのインベントリ 

Azure の場合:
- **[App Service プラン]** :サービス ホストの App Service プラン。 既定の S1。
- マイクロサービスの **App Service**:OPC Vault サービス ホスト。
- サンプル アプリケーションの **App Service**:OPC Vault サンプル アプリケーション ホスト。
- **Key Vault (Standard)** :Web サービス用のシークレットと Azure Cosmos DB キーを格納します。
- **Key Vault (Premium)** :署名サービス、コンテナーの構成、およびアプリケーションの秘密キーの格納のための、発行者 CA キーをホストします。
- **Azure Cosmos DB**:アプリケーションと証明書の要求のデータベース。 
- **Application Insights**: (省略可能) Web サービスおよびアプリケーションの監視ソリューション。
- **Azure AD アプリケーションの登録**:サンプル アプリケーション、サービス、およびエッジ モジュールの登録。

クラウド サービスの場合、使用されるすべてのホスト名、リソース グループ、リソース名、サブスクリプション ID、およびテナント ID を文書化する必要があります。 

Azure IoT Edge またはローカル IoT Edge サーバーの場合:
- **OPC Vault IoT Edge モジュール**:ファクトリ ネットワーク OPC UA Global Discovery Server をサポートします。 

IoT Edge デバイスの場合は、ホスト名と IP アドレスを文書化する必要があります。 

### <a name="document-the-certification-authorities-cas"></a>証明機関 (CA) を文書化する

CA 階層ドキュメントには、操作されているすべての CA が含まれている必要があります。 これには、サービスによって管理されていない場合でも、関連する下位 CA、親 CA、およびルート CA がすべて含まれます。 正式なドキュメントの代わりに、すべて有効期限内の CA 証明書の完全なセットを提供してもかまいません。

> [!NOTE]
> OPC Vault サンプル アプリケーションでは、文書化のために、サービス内で使用され生成されるすべての証明書のダウンロードがサポートされています。

### <a name="document-the-issued-certificates-by-all-certification-authorities-cas"></a>すべての証明機関 (CA) によって発行された証明書を文書化する

過去 12 か月間に発行されたすべての証明書の完全なセットを提供します。

> [!NOTE]
> OPC Vault サンプル アプリケーションでは、文書化のために、サービス内で使用され生成されるすべての証明書のダウンロードがサポートされています。

### <a name="document-the-standard-operating-procedure-for-securely-deleting-cryptographic-keys"></a>暗号化キーを安全に削除するための標準の操作手順を文書化する

CA の有効期間中に、ごくまれにキーの削除が発生することがあります。 KeyVault 証明書の削除権限が割り当てられているユーザーがいない、また、発行者 CA 証明書を削除するための API が公開されていないのは、このためです。 証明機関の暗号化キーを安全に削除するための手動による標準的な操作手順は、Azure portal 上で Key Vault に直接アクセスすることによってのみ利用できます。 Key Vault にある証明書グループを削除することも可能です。 確実にすぐに削除するには、[Key Vault の論理的な削除](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete)の機能を無効にします。

## <a name="certificates"></a>証明書

### <a name="certificates-must-comply-with-minimum-certificate-profile"></a>証明書は最低限の証明書プロファイルに準拠している必要がある

OPC Vault サービスは、エンド エンティティ証明書をサブスクライバーに発行するオンライン CA です。 OPC Vault マイクロサービスは、既定の実装でこれらのガイドラインに従います。

- すべての証明書には、以下に示すように、次の x.509 フィールドを含める必要があります。
  - バージョン フィールドの内容は、v3 である必要があります。 
  - serialNumber フィールドの内容には、FIPS (Federal Information Processing Standards) 140 承認済みの乱数ジェネレーターから取得される、8 バイト以上のエントロピを含める必要があります。<br>
    > [!IMPORTANT]
    > OPC Vault のシリアル番号は、既定では 20 バイトであり、オペレーティング システムの暗号化乱数ジェネレーターから取得されます。 乱数ジェネレーターは、Linux 上ではなく、Windows デバイス上で FIPS 140 承認されます。 基盤テクノロジの OpenSSL が FIPS 140 承認されていない Linux VM または Linux Docker コンテナーを使用するサービス デプロイを選択する場合、このことを考慮する必要があります。
  - issuerUniqueID および subjectUniqueID フィールドが存在してはなりません。
  - IETF RFC 5280 に従い、基本制約拡張機能によってエンドエンティティ証明書を識別する必要があります。
  - Issuing CA 証明書の場合は、pathLenConstraint フィールドを 0 に設定する必要があります。 
  - 拡張キー使用法拡張機能が必ず存在するうえで、拡張キー使用法オブジェクト識別子 (OID) の最小セットが含まれている必要があります。 anyExtendedKeyUsage OID (2.5.29.37.0) を指定することはできません。 
  - CRL 配布ポイント (CDP) 拡張機能は、発行者 CA 証明書に存在する必要があります。<br>
    > [!IMPORTANT]
    > CDP 拡張機能は、OPC Vault CA 証明書に存在します。 にもかかわらず、OPC UA デバイスではカスタム メソッドを使用して、CRL が配布されます。
  - 機関情報アクセス拡張機能がサブスクライバー証明書に存在する必要があります。<br>
    > [!IMPORTANT]
    > 機関情報アクセス拡張機能は、OPC Vault サブスクライバー証明書に存在します。 にもかかわらず、OPC UA デバイスでは、カスタム メソッドを使用して発行者 CA 情報が配布されます。
- 承認された非対称アルゴリズム、キーの長さ、ハッシュ関数およびパディング モードを使用する必要があります。
  - RSA と SHA-2 は、唯一サポートされているアルゴリズムです。
  - RSA は、暗号化、キー交換、署名に使用できます。
  - RSA 暗号化では、OAEP、RSA-KEM、または RSA-PSS パディング モードのみを使用する必要があります。
  - キーの長さは 2048 ビット以上になっている必要があります。
  - SHA-2 ファミリのハッシュ アルゴリズム (SHA256、SHA384、SHA512) を使用します。
  - 一般的な有効期間が 20 年以上の RSA ルート CA キーは、4096 ビット以上になっている必要があります。
  - RSA 発行者の CA キーは、2048 ビット以上になっている必要があります。 CA 証明書の有効期限が 2030 年より後の場合、CA キーは 4096 ビット以上になっている必要があります。
- 証明書の有効期間
  - ルート CA 証明書:ルート CA の証明書の最大有効期間が 25 年を超えないようにしてください。
  - サブ CA またはオンライン発行者 CA 証明書:オンラインでサブスクライバー証明書のみを発行する CA の場合、証明書の最大有効期間が 6 年を超えないようにする必要があります。 これらの CA の場合、新しい証明書を発行するために、関連する秘密署名キーを 3 年を超えて使用することはできません。<br>
    > [!IMPORTANT]
    > 外部ルート CA を利用せずに既定の OPC Vault マイクロサービスで生成される発行者証明書は、それぞれの要件と有効期間があるオンラインのサブ CA と同様に扱われます。 既定の有効期間は 5 年に設定され、キーの長さは 2048 以上になっています。
  - すべての非対称キーは最大でも 5 年の有効期間にする必要があり、推奨される有効期限は 1 年です。<br>
    > [!IMPORTANT]
    > 既定では、OPC Vault によって発行されたアプリケーション証明書の有効期間は 2 年であり、毎年置き換える必要があります。 
  - 証明書が更新されるたびに、新しいキーを使って更新されます。
- アプリケーション インスタンス証明書の OPC UA 固有の拡張機能
  - subjectAltName 拡張機能には、アプリの URI とホスト名が含まれます。 これらには、FQDN、IPv4、および IPv6 アドレスも含まれる場合があります。
  - keyUsage には、digitalSignature、nonRepudiation、keyEncipherment、および dataEncipherment が含まれます。
  - extendedKeyUsage には、serverAuth および clientAuth が含まれます。
  - authorityKeyIdentifier は、署名済み証明書で指定されます。

### <a name="ca-keys-and-certificates-must-meet-minimum-requirements"></a>CA のキーと証明書が最小要件を満たしている必要がある

- **秘密キー**:RSA キーは、2048 ビット以上になっている必要があります。 CA 証明書の有効期限が 2030 年より後の場合、CA キーは 4096 ビット以上になっている必要があります。
- **有効期間**:オンラインでサブスクライバー証明書のみを発行する CA の場合、証明書の最大有効期間が 6 年を超えないようにする必要があります。 これらの CA の場合、新しい証明書を発行するために、関連する秘密署名キーを 3 年を超えて使用することはできません。

### <a name="ca-keys-are-protected-using-hardware-security-modules"></a>CA キーはハードウェア セキュリティ モジュールを使用して保護される

OpcVault では Azure Key Vault の Premium を使用し、キーは FIPS 140-2 レベル 2 ハードウェア セキュリティ モジュール (HSM) によって保護されます。 

HSM であれソフトウェアであれ、Key Vault によって使用される暗号化モジュールは、FIPS 検証されます。 HSM で保護されて作成またはインポートされたキーは、HSM 内で処理され、FIPS 140-2 レベル 2 について検証されます。 ソフトウェアで保護された状態で作成またはインポートされたキーは、暗号化モジュール内で処理され、FIPS 140-2 レベル 1 について検証されます。

## <a name="operational-practices"></a>運用プラクティス

### <a name="document-and-maintain-standard-operational-pki-practices-for-certificate-enrollment"></a>証明書の登録に関する標準的な運用 PKI プラクティスを文書化して維持する

以下を含む、CA での証明書の発行方法に関する標準的な運用手順 (SOP) を文書化し、維持します。 
- サブスクライバーを識別および認証する方法。 
- 証明書の要求を処理および検証する方法 (該当する場合は、証明書の更新とキー更新の要求を処理する方法も含まれます)。 
- 発行された証明書をサブスクライバーに配布する方法。 

OPC Vault マイクロサービス SOP については、「[OPC Vault のアーキテクチャ](overview-opc-vault-architecture.md)」および「[OPC Vault 証明書サービスを管理する方法](howto-opc-vault-manage.md)」に説明されています。 プラクティスでは、「OPC Unified Architecture Specification Part 12:Discovery and Global Services」(OPC Unified Architecture 仕様のパート 12: 探索とグローバル サービス) に従います。


### <a name="document-and-maintain-standard-operational-pki-practices-for-certificate-revocation"></a>証明書の失効に関する標準的な運用 PKI プラクティスを文書化して維持する

証明書の失効処理については、「[OPC Vault のアーキテクチャ](overview-opc-vault-architecture.md)」および「[OPC Vault 証明書サービスを管理する方法](howto-opc-vault-manage.md)」に説明されています。
    
### <a name="document-ca-key-generation-ceremony"></a>CA キーの生成処理を文書化する 

Azure Key Vault ではストレージがセキュリティ保護されているため、OPC Vault マイクロサービスでの発行者 CA キーの生成は簡略化されています。 詳細については、「[OPC Vault 証明書サービスを管理する方法](howto-opc-vault-manage.md)」を参照してください。

しかし、外部ルート証明機関を使用している場合、CA キーの生成処理は、次の要件に従う必要があります。

CA キーの生成処理は、少なくとも次の項目を含む、文書化されたスクリプトに対して実行する必要があります。 
- ロールと参加者の責任の定義。
- CA キーの生成処理の実行承認。
- 処理に必要な暗号化ハードウェアおよびアクティブ化のマテリアル。
- ハードウェアの準備 (資産/構成情報の更新とサインオフを含む)。
- オペレーティング システムのインストール。
- CA キーの生成処理中に行われる具体的な手順は次のとおりです。 
  - CA アプリケーションのインストールと構成。
  - CA キーの生成。
  - CA キーのバックアップ。
  - CA 証明書の署名。
  - サービスの保護された HSM への署名されたキーのインポート。
  - CA システムのシャットダウン。
  - ストレージ対応のマテリアルの準備。


## <a name="next-steps"></a>次のステップ

ここでは、OPC Vault を安全に管理する方法を学習しました。以下に進むことができます。

> [!div class="nextstepaction"]
> [OPC UA デバイスを OPC Vault で保護する](howto-opc-vault-secure.md)
