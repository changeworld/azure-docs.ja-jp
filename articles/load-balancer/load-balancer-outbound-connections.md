---
title: Azure の送信接続
titlesuffix: Azure Load Balancer
description: この記事では、Azure によって、パブリック インターネット サービスと VM がどのように通信するかを説明します。
services: load-balancer
documentationcenter: na
author: asudbring
ms.service: load-balancer
ms.custom: seodec18
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/02/2019
ms.author: allensu
ms.openlocfilehash: 6623b3e679faaa73f18c0f6b376de101113bcbdb
ms.sourcegitcommit: 9a699d7408023d3736961745c753ca3cec708f23
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/16/2019
ms.locfileid: "68274552"
---
# <a name="outbound-connections-in-azure"></a>Azure の送信接続

Azure では、いくつかの異なるメカニズムを通じて顧客デプロイの送信接続を提供します。 この記事では、どのようなシナリオがあり、それらがいつ適用されるかについて説明するほか、それらのシナリオのしくみと管理方法について説明します。

>[!NOTE] 
>この記事は、Resource Manager デプロイメントのみを対象とします。 Azure のすべてのクラシック デプロイメント シナリオについては、「[送信接続 (クラシック)](load-balancer-outbound-connections-classic.md)」をご覧ください。

Azure のデプロイは、パブリック IP アドレス空間で Azure 外部のエンドポイントと通信できます。 インスタンスがパブリック IP アドレス空間の宛先への送信フローを開始すると、Azure によってプライベート IP アドレスがパブリック IP アドレスに動的にマッピングされます。 このマッピングが作成されると、この送信フローの戻りトラフィックも、フローの送信元であるプライベート IP アドレスに到達できます。

Azure は送信元ネットワーク アドレス変換 (SNAT) を使用してこの機能を実行します。 複数のプライベート IP アドレスが単一のパブリック IP アドレスでマスカレードされている場合、Azure では[ポート アドレス変換 (PAT)](#pat) を使用してプライベート IP アドレスがマスカレードされます。 エフェメラル ポートが PAT に使用され、プール サイズに基づいて[事前に割り当て](#preallocatedports)られます。

[送信シナリオ](#scenarios)は複数あります。 必要に応じて、これらのシナリオを組み合わせることができます。 これらを注意深く確認して、実際のデプロイメント モデルとアプリケーション シナリオに適用される際の機能、制約、パターンを把握してください。 また、[これらのシナリオを管理する](#snatexhaust)ためのガイダンスを確認してください。

>[!IMPORTANT] 
>Standard Load Balancer および Standard パブリック IP では、アウトバウンド接続に新しい機能とさまざまな動作が導入されています。  これらは Basic SKU と同じではありません。  Standard SKU を操作するときにアウトバウンド接続が必要な場合は、Standard パブリック IP アドレスまたは Standard パブリック Load Balancer で明示的に定義する必要があります。  これには、内部 Standard Load Balancer を使用する場合のアウトバウンド接続の作成が含まれます。  Standard パブリック Load Balancer では常にアウトバウンド規則を使用することをお勧めします。  [シナリオ 3](#defaultsnat) は、Standard SKU では利用できません。  つまり、内部 Standard Load Balancer が使用されているときに、アウトバウンド接続が必要な場合、バックエンド プール内の VM に対してアウトバウンド接続を作成する手順を行う必要があります。  アウトバウンド接続のコンテキストでは、単一スタンドアロン VM、可用性セット内のすべての VM、VMSS のすべてのインスタンスがグループとして動作します。 つまり、可用性セット内の単一 VM が Standard SKU に関連付けられている場合、この可用性セット内のすべての VM インスタンスが、Standard SKU に関連付けられている場合と同じ規則に従って動作するようになります。個々のインスタンスが直接関連付けられていない場合でも同様です。  このドキュメント全体をよく読み、全体的な概念を理解し、SKU 間の違いについて [Standard Load Balancer](load-balancer-standard-overview.md) を確認し、[アウトバウンド規則](load-balancer-outbound-rules-overview.md)を確認してください。  アウトバウンド規則を使用することで、アウトバウンド接続のすべての側面を細かく制御できます。

## <a name="scenarios"></a>シナリオの概要

[Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview) を使用している場合、Azure Load Balancer と関連するリソースは明示的に定義されます。  現在 Azure には、Azure Resource Manager リソースの送信接続を実現するのに 3 つの異なる方法があります。 

| SKU | シナリオ | Method | IP プロトコル | 説明 |
| --- | --- | --- | --- | --- |
| Standard、Basic | [1.インスタンス レベル パブリック IP アドレスを含む VM (ロード バランサーあり、またはなし)](#ilpip) | SNAT (ポート マスカレードは不使用) | TCP、UDP、ICMP、ESP | インスタンスの NIC の IP 構成に割り当てられたパブリック IP が Azure によって使用されます。 インスタンスには、使用可能なすべてのエフェメラル ポートがあります。 Standard Load Balancer を使用する場合は、[アウトバウンド規則](load-balancer-outbound-rules-overview.md)を使って、アウトバウンド接続を明示的に定義する必要があります |
| Standard、Basic | [2.VM に関連付けられたパブリック ロード バランサー (インスタンスにインスタンス レベルのパブリック IP アドレスなし)](#lb) | ロード バランサー フロントエンドを使用したポート マスカレード (PAT) による SNAT | TCP、UDP |Azure によってパブリック ロード バランサー フロントエンドのパブリック IP アドレスが複数のプライベート IP アドレスと共有されます。 Azure では、フロントエンドのエフェメラル ポートが PAT に使用されます。 |
| なし、または Basic | [3.スタンドアロン VM (ロード バランサーなし、インスタンス レベルのパブリック IP アドレスなし)](#defaultsnat) | ポート マスカレード (PAT) による SNAT | TCP、UDP | Azure によって自動的に SNAT 用のパブリック IP アドレスが指定され、このパブリック IP アドレスが可用性セットの複数のプライベート IP アドレスと共有されてから、このパブリック IP アドレスのエフェメラル ポートが使用されます。 このシナリオは、前のシナリオのフォールバックです。 可視性と制御が必要は場合は推奨されません。 |

VM がパブリック IP アドレス空間で Azure の外部のエンドポイントと通信しないようにする場合、必要に応じてネットワーク セキュリティ グループ (NSG) を使用してアクセスをブロックできます。 NSG の使用の詳細については、「[送信接続の防止](#preventoutbound)」で説明します。 送信アクセスがない仮想ネットワークの設計、実装、および管理のガイダンスについては、この記事の範囲外です。

### <a name="ilpip"></a>シナリオ 1:インスタンス レベルのパブリック IP アドレスがある VM

このシナリオでは、VM にはインスタンス レベルのパブリック IP (ILPIP) が割り当てられています。 送信接続に関する限り、VM が負荷分散されているかどうかは関係ありません。 このシナリオは他のシナリオよりも優先されます。 ILPIP が使用される場合、すべての送信フローで VM によって ILPIP が使用されます。  

VM に割り当てられたパブリック IP は (1 対多ではなく) 1 対 1 の関係であり、1 対 1 のステートレス NAT として実装されます。  ポート マスカレード (PAT) は使用されず、VM は使用可能なすべてのエフェメラル ポートを備えます。

アプリケーションが多数の送信フローを開始したために SNAT ポート不足が発生した場合は、[SNAT の制約を軽減するために ILPIP](#assignilpip) を割り当てることを検討してください。 その全体像については、[SNAT 不足の管理](#snatexhaust)に関するセクションを確認してください。

### <a name="lb"></a>シナリオ 2:インスタンス レベルのパブリック IP アドレスがない負荷分散 VM

このシナリオでは、VM はパブリック Load Balancer バックエンド プールに含まれます。 VM にパブリック IP アドレスは割り当てられていません。 パブリック IP フロントエンドとバックエンド プール間にリンクを作成するには、ロード バランサー リソースをロード バランサー規則で構成する必要があります。

この規則の構成を完了しないと、[インスタンス レベルのパブリック IP アドレスがないスタンドアロン VM](#defaultsnat) のシナリオで説明される動作になります。 成功するために正常性プローブのバックエンド プールの作業リスナーを規則に含める必要はありません。

負荷分散 VM が送信フローを作成すると、Azure が、送信フローのプライベート ソース IP アドレスをパブリック ロード バランサー フロントエンドのパブリック IP アドレスに変換します。 Azure は、SNAT を使用してこの機能を実行します。 また、Azure は、[PAT](#pat) を使用して、複数のプライベート IP アドレスをパブリック IP アドレスでマスカレードします。 

ロード バランサーのパブリック IP アドレス フロントエンドのエフェメラル ポートを使用して、VM から送信される個々のフローが区別されます。 送信フローが作成されると、[事前に割り当てられたエフェメラル ポート](#preallocatedports)が SNAT によって動的に使用されます。 ここでは、SNAT で使用されるエフェメラル ポートを SNAT ポートと呼びます。

SNAT ポートは、「[SNAT と PAT の理解](#snat)」の説明のとおり事前に割り当てられます。 これは有限のリソースであり、不足する可能性があります。 これらがどのように[消費される](#pat)のかを理解することが重要です。 この消費のための設計と移行を必要に応じて行う方法については、[SNAT 不足の管理](#snatexhaust)に関するセクションを確認してください。

[複数のパブリック IP アドレスが Load Balancer Basic に関連付けられている](load-balancer-multivip-overview.md)場合、それらのパブリック IP アドレスはどれもアウトバウンド フローの候補になり、その 1 つがランダムに選択されます。  

Load Balancer Basic でアウトバウンド接続の正常性を監視するために、[Load Balancer 用の Azure Monitor ログ](load-balancer-monitor-log.md)と、SNAT ポート不足メッセージを監視するための[アラート イベント ログ](load-balancer-monitor-log.md#alert-event-log)を使用できます。

### <a name="defaultsnat"></a>シナリオ 3:インスタンス レベルのパブリック IP アドレスがないスタンドアロン VM

このシナリオでは、VM はパブリック Load Balancer プールの一部ではなく (また、内部 Standard Load Balancer プールの一部ではなく)、ILPIP アドレスが割り当てられていません。 VM が送信フローを作成すると、Azure が、送信フローのプライベート ソース IP アドレスをパブリック ソース IP アドレスに変換します。 この送信フローで使用されるパブリック IP アドレスは構成不可能であり、サブスクリプションのパブリック IP リソースの制限に対してカウントされません。 このパブリック IP アドレスはユーザーのものではなく、予約することはできません。 VM、可用性セット、または仮想マシン スケール セットを再デプロイすると、このパブリック IP アドレスは解放され、新しいパブリック IP アドレスが要求されます。 IP アドレスをホワイトリストに登録する場合は、このシナリオを使用しないでください。 代わりに、送信シナリオと、送信接続で使用されるパブリック IP アドレスを明示的に宣言する他の 2 つのシナリオのいずれかを使用します。

>[!IMPORTANT] 
>このシナリオは、内部 Basic Load Balancer が接続されている場合に __のみ__ 適用されます。 内部 Standard Load Balancer が VM に接続されている場合、シナリオ 3 は __利用できません__。  内部 Standard Load Balancer を使用することに加え、[シナリオ 1](#ilpip) または[シナリオ 2](#lb) を明示的に作成する必要があります。

Azure は、SNAT とポート マスカレード ([PAT](#pat)) を使用してこの機能を実行します。 このシナリオは、使用される IP アドレスに対するコントロールがない点を除いて、[シナリオ 2](#lb) に類似しています。 これは、シナリオ 1 および 2 がない場合のフォールバック シナリオです。 このシナリオは、送信アドレスに対するコントロールが必要な場合は推奨されません。 送信接続がアプリケーションの重要な部分である場合は、別のシナリオを選ぶ必要があります。

SNAT ポートは、「[SNAT と PAT の理解](#snat)」の説明のとおり事前に割り当てられます。  可用性セットを共有している VM の数によって、適用される事前割り当ての階層が決まります。  事前割り当て (1024 SNAT ポート) を決定する目的の場合、可用性セットのないスタンドアロン VM は、事実上 1 のプールです。 SNAT ポートは有限のリソースであり、不足する可能性があります。 これらがどのように[消費される](#pat)のかを理解することが重要です。 この消費のための設計と移行を必要に応じて行う方法については、[SNAT 不足の管理](#snatexhaust)に関するセクションを確認してください。

### <a name="combinations"></a>組み合わされた複数のシナリオ

これまでのセクションで説明したシナリオを組み合わせることで、特定の結果を実現することができます。 複数のシナリオがある場合は、次の優先順位が適用されます。[シナリオ 1](#ilpip) は、[シナリオ 2](#lb) と[シナリオ 3](#defaultsnat) に優先します。 [シナリオ 2](#lb) は[シナリオ 3](#defaultsnat) をオーバーライドします。

たとえば、アプリケーションが限られた数の宛先への送信接続に大きく依存している一方で、ロード バランサー フロントエンド経由で受信フローも受け取っている Azure Resource Manager デプロイがあります。 この場合、シナリオ 1 と 2 を組み合わせて軽減を行えます。 その他のパターンについては、[SNAT 不足の管理](#snatexhaust)に関するセクションを確認してください。

### <a name="multife"></a>送信フローの複数のフロントエンド

#### <a name="standard-load-balancer"></a>Standard Load Balancer

[複数の (パブリック) IP フロントエンド](load-balancer-multivip-overview.md)が存在する場合、Standard Load Balancer では、発信フローのすべての候補が同時に使用されます。 発信接続に対して負荷分散ルールが有効になっている場合、各フロントエンドは使用できる事前割当 SNAT ポートの数を増やします。

新しい負荷分散ルール オプションを使用して、発信接続にフロントエンド IP アドレスが使用されないようにすることができます。

```json    
      "loadBalancingRules": [
        {
          "disableOutboundSnat": false
        }
      ]
```

通常、`disableOutboundSnat` オプションは既定で _false_ になり、このルールによって負荷分散ルールのバックエンド プール内の関連付けられた VM の送信 SNAT がプログラムされることを示します。 `disableOutboundSnat` を _true_ に変更すると、Load Balancer がこの負荷分散ルールのバックエンド プール内の VM の送信接続に、関連付けられたフロントエンド IP アドレスを使用しないようにすることができます。  また、「[組み合わされた複数のシナリオ](#combinations)」で説明されているとおり、送信フローに特定の IP アドレスを指定することもできます。

#### <a name="load-balancer-basic"></a>Load Balancer Basic

[複数の (パブリック) IP フロントエンド](load-balancer-multivip-overview.md)が送信フローの候補である場合、送信フローに使用される 1 つのフロントエンドが Load Balancer Basic によって選択されます。 この選択は構成することができません。選択アルゴリズムはランダムであると考える必要があります。 「[組み合わされた複数のシナリオ](#combinations)」で説明されているとおり、送信フローに特定の IP アドレスを指定できます。

### <a name="az"></a> 可用性ゾーン

[可用性ゾーンありの Standard Load Balancer](load-balancer-standard-availability-zones.md) を使用する場合、ゾーン冗長フロントエンドでゾーン冗長発信 SNAT 接続を提供できます。また、ゾーン エラーが発生しても SNAT プログラミングは継続されます。  ゾーンのフロントエンドを使用する場合、発信 SNAT 接続の有効期間は属するゾーンと同じです。

## <a name="snat"></a>SNAT と PAT の理解

### <a name="pat"></a>ポート マスカレード SNAT (PAT)

パブリック ロード バランサー リソースが VM インスタンスに関連付けられている場合、各送信接続のソースは書き換えられます。 ソースは、仮想ネットワークのプライベート IP アドレス空間からロード バランサー フロントエンドのパブリック IP アドレスに書き換えられます。 パブリック IP アドレス空間では、フローの 5 タプル (ソース IP アドレス、ソース ポート、IP 転送プロトコル、宛先 IP アドレス、宛先ポート) は一意である必要があります。  ポート マスカレード SNAT は、TCP または UDP IP プロトコルで使用できます。

これを実現するために、プライベート ソース IP アドレスの書き換え後にエフェメラル ポート (SNAT ポート) が使用されます。これは複数のフローが単一のパブリック IP アドレスから送信されるためです。 SNAT アルゴリズムをマスカレードしているポートは、UDP 対 TCP とは異なる方法で SNAT ポートを割り当てます。

#### <a name="tcp"></a>TCP SNAT ポート

1 つの SNAT ポートは、単一の宛先 IP アドレス、ポートへのフローごとに使用されます。 同じ宛先 IP アドレス、ポート、およびプロトコルへの複数の TCP フローでは、各 TCP フローが単一の SNAT ポートを使用します。 これにより、同じパブリック IP アドレスから送信されて同じ宛先 IP アドレス、ポート、プロトコルに移動する複数のフローが、一意であることが保証されます。 

別の宛先 IP アドレス、ポート、プロトコルへの複数のフローは、宛先ごとに 1 つの SNAT ポートを共有します。 宛先 IP アドレス、ポート、プロトコルによってフローは一意になります。パブリック IP アドレス空間でフローを区別するための追加のソース ポートは必要ありません。

#### <a name="udp"></a> UDP SNAT ポート

UDP SNAT ポートは、TCP SNAT ポートではなく、別のアルゴリズムによって管理されます。  ロード バランサーは、UDP の "ポート制限された Cone NAT" と呼ばれるアルゴリズムを使用します。  1 つの SNAT ポートは、宛先 IP アドレス、ポートに関係なく、各フローに対して使用されます。

#### <a name="exhaustion"></a>ポート不足

SNAT ポート リソースがなくなると、既存のフローによって SNAT ポートが解放されない限り、送信フローは失敗します。 Load Balancer はフローが終了すると SNAT ポートを回収します。また、[4 分間のアイドル タイムアウト](#idletimeout)を使用して、アイドル フローからの SNAT ポートを回収します。

一般的に UDP SNAT ポートは、使用されるアルゴリズムの違いが原因で、TCP SNAT ポートと比べてかなり迅速に使い果たされてしまいます。 この違いを念頭に置いて、テストの設計とスケーリングを行う必要があります。

SNAT ポート不足を引き起こしやすい状態を軽減するパターンについては、[SNAT の管理](#snatexhaust)に関するセクションを確認してください。

### <a name="preallocatedports"></a>ポート マスカレード SNAT (PAT) 用のエフェメラル ポートの事前割り当て

Azure では、アルゴリズムを使用して、割り当てられる利用可能な SNAT ポートの数が決定されます。これは、ポート マスカレード SNAT ([PAT](#pat)) を使用する際のバックエンド プールのサイズに基づきます。 SNAT ポートは、特定のパブリック IP ソース アドレスについて使用可能なエフェメラル ポートです。

同じ数の SNAT ポートが UDP と TCP にそれぞれ事前に割り当てられ、IP トランスポート プロトコルに従って個別に使用されます。  ただし、SNAT ポートの使用方法は、フローが UDP または TCP のどちらかに応じて異なります。

>[!IMPORTANT]
>Standard SKU の SNAT プログラミングは、IP トランスポート プロトコルに従い、負荷分散規則から派生します。  TCP 負荷分散規則だけが存在する場合、SNAT は TCP でのみ使用できます。 TCP 負荷分散規則しかないときに、UDP の送信 SNAT が必要な場合は、同じフロントエンドから同じバックエンド プールへの UDP 負荷分散規則を作成します。  これにより、UDP の SNAT プログラミングがトリガーされます。  動作規則や正常性プローブは不要です。  Basic SKU の SNAT では、負荷分散規則で指定されたトランスポート プロトコルに関係なく、常に両方の IP トランスポート プロトコルに対して SNAT がプログラムされます。

SNAT ポートは Azure によって各 VM の NIC の IP 構成に事前に割り当てられます。 IP 構成がプールに追加されると、バックエンド プール サイズに基づいて SNAT ポートがこの IP 構成に事前割り当てされます。 送信フローが作成されると、これらのポートは (事前に割り当てられた上限に達するまで) [PAT](#pat) によって動的に消費されます。そして、フローが終了するか[アイドル タイムアウト](#idletimeout)が発生すると解放されます。

次の表は、バックエンド プール サイズのレベルに対する SNAT ポートの事前割り当てを示しています。

| プール サイズ (VM インスタンス) | IP 構成あたりの事前に割り当てられる SNAT ポート|
| --- | --- |
| 1-50 | 1,024 |
| 51-100 | 512 |
| 101-200 | 256 |
| 201-400 | 128 |
| 401-800 | 64 |
| 801-1,000 | 32 |

>[!NOTE]
> [複数フロントエンド](load-balancer-multivip-overview.md)で Standard Load Balancer を使用する場合、フロントエンド IP アドレスごとに、前の表に記載されている使用可能な SNAT ポート数を増やします。 たとえば、それぞれ個別のフロントエンド IP アドレスを使用する 2 つの負荷分散規則を持つ、50 個の VM のバックエンド プールでは、IP 構成ごとに 2048 (2x 1024) 個の SNAT ポートが使用されます。 詳細については、[複数のフロントエンド](#multife)に関するセクションを参照してください。

利用できる SNAT ポートの数が、そのままフローの数に変換されるわけではないことに注意してください。 複数の一意の送信先に単一の SNAT ポートを再利用できます。 ポートは、フローを一意にするために必要な場合にのみ消費されます。 設計と軽減策のガイダンスについて、[この有限のリソースを管理する方法](#snatexhaust)に関するセクション、および [PAT](#pat) について説明しているセクションを参照してください。

パックエンド プールのサイズを変更すると、確立されたフローの一部に影響が及ぶ可能性があります。 バックエンド プール サイズが増加し、次のレベルに移行すると、1 つ大きいバックエンド プール レベルに移行する間に、事前に割り当てられた SNAT ポートの半分が回収されます。 回収された SNAT ポートに関連付けられているフローはタイムアウトになるので、再確立する必要があります。 新しいフローを試みると、事前に割り当てられたポートが使用可能な限り、フローはすぐに成功します。

バックエンド プールのサイズが減少し、1 つ小さいレベルに移行すると、使用できる SNAT ポートが増えます。 この場合、割り当てられている既存の SNAT ポートと各フローに影響はありません。

SNAT ポートの割り当ては、IP トランスポート プロトコル固有であり (TCP と UDP は別々に管理されます)、次の条件下で解放されます。

### <a name="tcp-snat-port-release"></a>TCP SNAT ポートの解放

- サーバー/クライアントのどちらかが FINACK を送信すると、SNAT ポートは 240 秒後に解放されます。
- RST が送信されると、SNAT ポートは 15 秒後に解放されます。
- アイドル タイムアウトに達すると、ポートは解放されます。

### <a name="udp-snat-port-release"></a>UDP SNAT ポートの解放

- アイドル タイムアウトに達すると、ポートは解放されます。

## <a name="problemsolving"></a> 問題の解決 

このセクションは、Azure での送信接続で発生する可能性のある SNAT の枯渇の緩和に役立つことを目的にしています。

### <a name="snatexhaust"></a> SNAT (PAT) ポート不足の管理
[PAT](#pat) に使用される[エフェメラル ポート](#preallocatedports)は、「[インスタンス レベルのパブリック IP アドレスがないスタンドアロン VM](#defaultsnat)」および「[インスタンス レベルのパブリック IP アドレスがない負荷分散 VM](#lb)」で説明されているように有限のリソースです。

同じ宛先 IP アドレスとポートに対して多数の TCP 送信接続または UDP 送信接続が開始されることがわかっている場合、送信接続エラーが出る場合、または SNAT ポート ([PAT](#pat) によって使用される事前割り当て済みの[エフェメラル ポート](#preallocatedports)) が不足しているとサポートから指摘された場合、いくつかの一般的な軽減策の選択肢があります。 これらのオプションを確認し、使用可能であり、実際のシナリオに最適な選択肢を判断してください。 それらを 1 つまたは複数組み合わせることが状況改善に役立つ場合もあります。

送信接続の動作の理解が難しい場合は、IP スタック統計 (netstat) を使用できます。 また、パケット キャプチャを使用した接続動作を観察することも効果的です。 これらのパケット キャプチャはインスタンスのゲスト OS で実行できます。また、[パケット キャプチャには Network Watcher](../network-watcher/network-watcher-packet-capture-manage-portal.md) も使用できます。

#### <a name="connectionreuse"></a>接続を再利用するようにアプリケーションを変更する 
SNAT に使用される一時ポートの需要は、アプリケーションで接続を再利用することで減らすことができます。 これには、既定で接続が再利用される HTTP/1.1 などのプロトコルが特に有効です。 また、HTTP が転送に使用されるその他のプロトコル (REST など) も活用できます。 

要求ごとに個別にアトミック TCP 接続するよりも、再利用するほうが常に効果的です。 再利用は、TCP トランザクションのパフォーマンス向上と大幅な効率化につながります。

#### <a name="connection pooling"></a>接続プーリングを使用するようにアプリケーションを変更する
アプリケーションでは接続プーリング スキームを利用できます。この場合、接続の固定セットに対して要求が内部的に分散されます (各要求で利用可能な接続が再利用されます)。 このスキームにより、使用される一時ポートの数が制限され、環境の予測可能性が高まります。 さらに、このスキームを使用すると、ある操作の応答で 1 つの接続がブロックされている際に同時に複数の操作を行えるようにして、要求のスループットを向上させることもできます。  

接続プーリングは既に、アプリケーションの開発に使用しているフレームワーク、またはアプリケーションの構成設定の中に存在している可能性があります。 接続プーリングは接続の再利用と組み合わせることができます。 同じ宛先 IP アドレスとポートに対する複数の要求で、固定された予測可能な数のポートを消費します。 これらの要求で、TCP トランザクションを非常に効率的に使用して、待ち時間とリソース使用率を減らすこともできます。 また、UDP フローの数を管理すると不足状態を回避して SNAT ポートの使用率を管理できるので、UDP トランザクションにもメリットがあります。

#### <a name="retry logic"></a>再試行の頻度を抑えるようにアプリケーションのロジックを変更する
[PAT](#pat) に使用される[事前割り当て済みのエフェメラル ポート](#preallocatedports)が不足している場合、またはアプリケーションのエラーが発生している場合、減退やバックオフ ロジックを使わず単純に再試行を繰り返すと、ポート不足が発生したり持続したりします。 エフェメラル ポートの需要は、再試行の頻度を抑えたロジックを使用することで減らすことができます。 

エフェメラル ポートには 4 分間のアイドル タイムアウトが設定されています (調整不可)。 再試行の頻度が高すぎた場合、不足が自動的に解消されることはありません。 そのため、アプリケーションがトランザクションを再試行する方法と頻度を考慮することは、設計において非常に重要です。

#### <a name="assignilpip"></a>インスタンスレベル パブリック IP を個々の VM に割り当てる
ILPIP を割り当てることで、[インスタンスレベル パブリック IP を VM に割り当てる](#ilpip)シナリオに移行します。 この VM で、VM ごとに使用されるパブリック IP のすべてのエフェメラル ポートを使用できます。 (パブリック IP のエフェメラル ポートが、それぞれのバックエンド プールに関連付けられているすべての VM で共有されるシナリオとは対照的です。)パブリック IP アドレスの追加コストや、大量の IP アドレスを個別にホワイトリスト登録することの潜在的な影響など、考慮すべきトレードオフがあります。

>[!NOTE] 
>このオプションは、worker ロールでは使用できません。

#### <a name="multifesnat"></a> 複数のフロントエンドを使用する

パブリック Standard Load Balancer を使用する場合は、[発信接続用に複数のフロントエンド IP アドレス](#multife)を割り当て、[使用可能な SNAT ポートの数を増やします](#preallocatedports)。  フロントエンドのパブリック IP への SNAT のプログラミングをトリガーするには、フロントエンド IP の構成、ルール、およびバックエンド プールを作成します。  このルールが機能する必要はなく、正常性プローブが成功する必要はありません。  (送信だけでなく) 受信にも複数のフロントエンドを使用する場合は、カスタム正常性プローブを適切に使用して信頼性を確保する必要があります。

>[!NOTE]
>ほとんどの場合、SNAT ポートの枯渇は設計に問題があることを示します。  より多くのフロントエンドを使用して SNAT ポートを追加する前に、ポートが枯渇している理由を把握してください。  後で障害につながる可能性のある問題が隠れている可能性があります。

#### <a name="scaleout"></a>スケールアウト

[事前割り当てポート](#preallocatedports)は、バックエンド プール サイズに基づいて割り当てられ、ポートの一部を再割り当てして 1 つ大きいバックエンド プール サイズ レベルに対応する必要があるときに中断を最小限に抑えるために、複数のレベルにグループ化されます。  バックエンド プールを特定のレベルの最大サイズにスケーリングすることで、特定のフロントエンドの SNAT ポート使用率を向上させることもできます。  この場合、アプリケーションが効率的にスケール アウトする必要があります。

たとえば、バックエンド プール内の 2 つの仮想マシンでは IP 構成あたり 1024 個の SNAT ポートを使用できるため、デプロイには合計 2048 個の SNAT ポートを使用できます。  デプロイを 50 個の仮想マシンに増やした場合、事前割り当てポートの数が仮想マシンごとに一定のままであっても、合計 51,200 (50 × 1024) 個の SNAT ポートをデプロイで使用できます。  デプロイをスケールアウトする場合は、レベルごとの[事前割り当てポート](#preallocatedports)の数を確認して、スケールアウトをそれぞれのレベルの最大数に必ず合わせます。  前の例で、50 個のインスタンスではなく、51 個にスケールアウトすることにした場合、次のレベルに進むと、VM ごとの SNAT ポート数と合計が減ることになります。

割り当てられたポートを再割り当てする必要がある場合に、次に大きなバックエンド プール サイズ レベルにスケールアウトすると、送信接続の一部がタイムアウトする可能性があります。  SNAT ポートの一部しか使用していない場合は、次に大きなバックエンド プール サイズにスケールアウトすることは重要ではありません。  既存のポートの半分は、次のバックエンド プール レベルに移行するたびに再割り当てされます。  これを行わない場合は、デプロイをそのレベルのサイズに合わせる必要があります。  または、必要に応じてアプリケーションが検出し、再試行できる必要があります。  TCP キープアライブは、再割り当てによって SNAT ポートが機能しなくなったときの検出に役立ちます。

### <a name="idletimeout"></a>キープアライブを使用して送信アイドル タイムアウトをリセットする

送信接続には、4 分間のアイドル タイムアウトが設けられています。 このタイムアウトは調整できません。 ただし、必要に応じて、転送 (TCP キープアライブなど) またはアプリケーション レイヤー キープアライブを使用して、アイドル フローを更新したりこのアイドル タイムアウトをリセットしたりできます。  

TCP キープアライブを使用するときは、接続の一方で有効にすれば十分です。 たとえば、フローのアイドル タイマーをリセットするときは、サーバー側でのみ有効にすれば十分であり、両側が TCP キープアライブを開始する必要はありません。  データベースのクライアント/サーバー構成など、アプリケーション レイヤーにも同様の概念があります。  サーバー側で、アプリケーション固有のキープアライブのどのようなオプションが存在するかを確認します。

## <a name="discoveroutbound"></a>VM で使用されるパブリック IP の検出
送信接続のパブリック ソース IP アドレスを判別する方法は多数あります。 OpenDNS によって提供されるサービスで、VM のパブリック IP アドレスを表示できます。 

nslookup コマンドを使用することで、名前 myip.opendns.com に関する DNS クエリを OpenDNS Resolver に送信できます。 このサービスは、クエリの送信に使用されたソース IP アドレスを返します。 VM から次のクエリを実行すると、その VM で使用されるパブリック IP が応答として返されます。

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventoutbound"></a>送信接続の防止
場合によっては、VM で送信フローを作成できるのは望ましくない場合があります。 また、送信フローで接続できる宛先や受信フローを開始できる宛先を管理するための要件がある場合もあります。 このような場合は、[ネットワーク セキュリティ グループ](../virtual-network/security-overview.md) を使用すると、VM が接続できる宛先を管理できます。 また、NSG を使用して、受信フローを開始できるパブリックの宛先を管理することもできます。

負荷分散された VM に NSG を適用するときは、[サービス タグ](../virtual-network/security-overview.md#service-tags)と[既定のセキュリティ規則](../virtual-network/security-overview.md#default-security-rules)に注意してください。 VM が Azure Load Balancer からのヘルス プローブ要求を受け取ることができるようにしておいてください。 

NSG が AZURE_LOADBALANCER 既定タグからのヘルス プローブ要求をブロックすると、VM のヘルス プローブが失敗して VM が停止しているとマークされます。 ロード バランサーはその VM への新しいフローの送信を停止します。

## <a name="limitations"></a>制限事項
- DisableOutboundSnat は、ポータルで負荷分散規則を構成するときにはオプションとして使用できません。  代わりに、REST、テンプレート、またはクライアント ツールを使用してください。
- VNet およびその他の Microsoft プラットフォーム サービスなしの Web Worker ロールにアクセスできるのは、事前 VNet サービスおよびその他のプラットフォーム サービスの動作の副作用により、内部の Standard Load Balancer が使用される場合のみです。 それぞれのサービス自体、または基になるプラットフォームは予告なく変更されることがあるため、この副作用に依存しないでください。 内部の Standard Load Balancer のみを使用する場合は、必要に応じて、明示的に送信接続を作成する必要があることを常に想定する必要があります。 この記事で説明されている[既定の SNAT](#defaultsnat) のシナリオ 3 を使用することはできません。

## <a name="next-steps"></a>次の手順

- [Standard Load Balancer](load-balancer-standard-overview.md) の詳細を確認する。
- Standard パブリック Load Balancer の[アウトバウンド規則](load-balancer-outbound-rules-overview.md)の詳細を確認する。
- [Load Balancer](load-balancer-overview.md) について詳しく学習する。
- [ネットワーク セキュリティ グループ](../virtual-network/security-overview.md)の詳細を確認する。
- Azure のその他の重要な[ネットワーク機能](../networking/networking-overview.md)について参照してください。
