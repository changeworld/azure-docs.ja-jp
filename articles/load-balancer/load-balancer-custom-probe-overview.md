---
title: お客様のサービスをスケーリングして高可用性を実現するために Azure Load Balancer 正常性プローブを使用する
titlesuffix: Azure Load Balancer
description: 正常性プローブを使用して Load Balancer の背後にあるインスタンスを監視する方法について説明します
services: load-balancer
documentationcenter: na
author: asudbring
manager: twooley
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.custom: seodec18
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/07/2019
ms.author: allensu
ms.openlocfilehash: 75009530940a0cce7adb8469ead5f55f509a1faa
ms.sourcegitcommit: 9a699d7408023d3736961745c753ca3cec708f23
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/16/2019
ms.locfileid: "68275349"
---
# <a name="load-balancer-health-probes"></a>Load Balancer の正常性プローブ

Azure Load Balancer では、負荷分散規則と共に使用するための正常性プローブが用意されています。  正常性プローブ構成とプローブ応答によって、どのバックエンド プール インスタンスが新しいフローを受信するのかが決まります。 バックエンド インスタンス上のアプリケーションの障害を検出するのに正常性プローブを使用することができます。 さらに、正常性プローブに対するカスタム応答を生成し、フロー制御用の正常性プローブを使用して、負荷または計画的ダウンタイムを管理できます。 正常性プローブが失敗した場合、Load Balancer は、それぞれの異常なインスタンスへの新しいフローの送信を停止します。

正常性プローブでは、複数のプロトコルがサポートされます。 特定のプロトコルをサポートする特定の種類の正常性プローブを利用できるどうかは、Load Balancer SKU によって異なります。  さらに、サービスの動作は Load Balancer SKU によって異なります。

| | Standard SKU | Basic SKU |
| --- | --- | --- |
| [プローブの種類](#types) | TCP、HTTP、HTTPS | TCP、HTTP |
| [プローブのダウン動作](#probedown) | すべてのプローブがダウンすると、すべての TCP フローは続行します。 | すべてのプローブがダウンすると、すべての TCP フローは終了します。 | 

> [!IMPORTANT]
> Load Balancer の正常性プローブは IP アドレス 168.63.129.16 から送信されます。プローブによってお客様のインスタンスがアップとしてマークされるには、これがブロックされていない必要があります。  詳しくは、「[プローブのソース IP アドレス](#probesource)」をご覧ください。

## <a name="types"></a>プローブの種類

正常性プローブでは、次の 3 つのプロトコルが使用されるリスナーを構成できます。

- [TCP リスナー](#tcpprobe)
- [HTTP エンドポイント](#httpprobe)
- [HTTPS エンドポイント](#httpsprobe)

使用できる正常性プローブの種類は、選択した Load Balancer SKU によって変わります。

|| TCP | HTTP | HTTPS |
| --- | --- | --- | --- |
| Standard SKU |    &#9989; |   &#9989; |   &#9989; |
| Basic SKU |   &#9989; |   &#9989; | &#10060; |

正常性プローブでは、お客様が選択するプローブの種類に関係なく、実際のサービスが提供されるポートを含め、バックエンド インスタンス上の任意のポートを監視できます。

### <a name="tcpprobe"></a> TCP プローブ

TCP プローブは、定義済みのポートに 3 ウェイ オープン TCP ハンドシェイクを実行して、接続を開始します。  TCP プローブでは、4 ウェイ クローズ TCP ハンドシェイクによって接続が終了します。

最小のプローブ間隔は 5 秒で、異常な応答の最小数は 2 です。  すべての間隔の合計期間が 120 秒を超えることはできません。

次の場合、TCP プローブは失敗します。
* タイムアウト期間中に、インスタンスで TCP リスナーがまったく応答しない場合。  プローブは、失敗したプローブ要求の数に基づいてダウンとしてマークされます。これらは、プローブがダウンとしてマークされる前に、応答なしになるように構成されています。
* プローブがインスタンスから TCP リセットを受信した場合。

#### <a name="resource-manager-template"></a>Resource Manager テンプレート

```json
    {
      "name": "tcp",
      "properties": {
        "protocol": "Tcp",
        "port": 1234,
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

### <a name="httpprobe"></a> <a name="httpsprobe"></a> HTTP / HTTPS プローブ

> [!NOTE]
> HTTPS プローブは、[Standard Load Balancer](load-balancer-standard-overview.md) でのみ使用できます。

HTTP プローブと HTTPS プローブは TCP プローブに基づいており、パスが指定された HTTP GET を発行します。 これら両方のプローブは、HTTP GET に対して相対パスをサポートします。 HTTPS プローブは、トランスポート層セキュリティ (TLS、旧称は SSL) ラッパーがある点を除き、HTTP プローブと同じです。 タイムアウト期間内にインスタンスが HTTP ステータス 200 で応答すると、正常性プローブはアップとしてマークされます。  既定では、構成された正常性プローブ ポートのチェックが、正常性プローブによって 15 秒ごとに試行されます。 最小のプローブ間隔は 5 秒です。 すべての間隔の合計期間が 120 秒を超えることはできません。

HTTP プローブまたは HTTPS プローブは、お客様が正常性プローブを表現したい場合にも役立ちます。  プローブ ポートがサービス自体に対するリスナーでもある場合は、ロード バランサーのローテーションからインスタンスを削除するお客様独自のロジックを実装します。 たとえば、CPU が 90% を超え、200 以外の HTTP ステータスが返される場合は、そのインスタンスが削除されるようにすることができます。 

Cloud Services を使用し、w3wp.exe を使う Web ロールがある場合は、Web サイトの自動監視も実現します。 Web サイトのコードで障害が発生すると、200 以外の状態がLoad Balancer プローブに返ります。

次の場合、HTTP/HTTPS プローブは失敗します。
* プローブ エンドポイントが、200 以外の HTTP 応答コード (403、404、500 など) を返す場合。 これにより、正常性プローブはすぐにダウンとしてマークされます。 
* 31 秒のタイムアウト期間内に、プローブ エンドポイントがまったく応答しない場合。 プローブが停止中としてマークされる前、すべてのタイムアウト間隔の合計に達するまで、複数のプローブ要求が応答なしになる可能性があります。
* プローブ エンドポイントが TCP リセットによって接続を閉じた場合。

#### <a name="resource-manager-templates"></a>Resource Manager テンプレート

```json
    {
      "name": "http",
      "properties": {
        "protocol": "Http",
        "port": 80,
        "requestPath": "/",
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

```json
    {
      "name": "https",
      "properties": {
        "protocol": "Https",
        "port": 443,
        "requestPath": "/",
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

### <a name="guestagent"></a>ゲスト エージェント プローブ (クラシックのみ)

既定では、クラウド サービス ロール (worker ロールと Web ロール) は、ゲスト エージェントを使用してプローブを監視します。  ゲスト エージェント プローブは最終手段の構成です。  常に、TCP または HTTP のプローブを使って明示的に正常性プローブを使用してください。 ほとんどのアプリケーション シナリオでは、ゲスト エージェント プローブは明示的に定義されたプローブほど効果的ではありません。

ゲスト エージェント プローブは、VM 内のゲスト エージェントのチェックです。 その後リッスンし、インスタンスが準備完了状態になっている場合にのみ、HTTP 200 OK で応答します (他の状態はビジー、リサイクル中、停止中です)。

詳しくは、[正常性プローブのサービス定義ファイル (csdef) の構成](https://msdn.microsoft.com/library/azure/ee758710.aspx)に関するページまたは[クラウド サービス用のパブリック ロード バランサーの作成の開始](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services)に関するページをご覧ください。

ゲスト エージェントが HTTP 200 OK で応答できない場合、Load Balancer はそのインスタンスを応答不能としてマークします。 そして、そのインスタンスへのフローの送信を停止します。 Load Balancer はインスタンスのチェックを続けます。 

ゲスト エージェントが HTTP 200 で応答すると、Load Balancer はそのインスタンスへの新しいフローの送信を再開します。

Web ロールを使う場合、Web サイト コードは通常、Azure ファブリックやゲスト エージェントでは監視されない w3wp.exe で実行されます。 w3wp.exe でのエラー (たとえば、HTTP 500 の応答) は、ゲスト エージェントに報告されません。 したがって、Load Balancer はそのインスタンスをローテーションから外しません。

<a name="health"></a>
## <a name="probehealth"></a>プローブの正常性

次の場合、TCP、HTTP、および HTTPS の正常性プローブは正常と見なされ、ロール インスタンスを正常としてマークします。

* VM の起動後に一度正常性プローブが成功している。
* ロール インスタンスを正常としてマークするのに必要な、指定された数のプローブが成功した。

> [!NOTE]
> 正常性プローブが変動する場合、ロード バランサ―は、さらに長い時間待機してから、ロール インスタンスを正常な状態に戻します。 この余分な待機時間は、ユーザーとインフラストラクチャを保護するためであり、意図的なポリシーです。

## <a name="probe-count-and-timeout"></a>プローブの数とタイムアウト

プローブの動作は、以下の要素によって変わってきます。

* インスタンスをアップとしてマークできる成功プローブの数。
* インスタンスがダウンとしてマークされる失敗プローブの数。

指定されたタイムアウトの値と間隔の値によって、インスタンスがアップとダウンのどちらとしてマークされるかが決まります。

## <a name="probedown"></a>プローブのダウン動作

### <a name="tcp-connections"></a>TCP 接続

新しい TCP 接続は、残りの正常なバックエンド インスタンスに対して成功します。

バックエンド インスタンスの正常性プローブが失敗した場合、そのバックエンド インスタンスに対する確立済みの TCP 接続は続行されます。

バックエンド プール内のすべてのインスタンスのすべてのプローブが失敗した場合、そのバックエンド プールに新しいフローは送信されません。 Standard Load Balancer は、確立済みの TCP フローが続行するのを許可します。  Basic Load Balancer は、バックエンド プールに対するすべての既存の TCP フローを終了します。
 
Load Balancer はパス スルー サービスであり (TCP 接続を終了しません)、フローは常にクライアントと VM のゲスト OS およびアプリケーションとの間で行われます。 すべてのプローブがダウンしたプールでは、フローを受信して SYN-ACK で応答する正常なバックエンド インスタンスがないため、フロントエンドが TCP 接続オープンの試行 (SYN) に応答しなくなります。

### <a name="udp-datagrams"></a>UDP データグラム

UDP データグラムは、正常なバックエンド インスタンスに配信されます。

UDP はコネクションレスであり、UDP に追跡されるフロー状態は存在しません。 いずれかのバックエンド インスタンスの正常性プローブが失敗すると、既存の UDP フローはバックエンド プール内の別の正常なインスタンスに移動できます。

バックエンド プール内のすべてのインスタンスのすべてのプローブが失敗した場合は、Basic および Standard の Load Balancer のすべての既存 UDP フローが終了します。

<a name="source"></a>
## <a name="probesource"></a>プローブのソース IP アドレス

Load Balancer は、その内部正常性モデルに対して分散プローブ サービスを使用します。 VM の各ホスト上に存在するプローブ サービスは、お客様の構成に従って正常性プローブを生成するようにオンデマンドでプログラミングできます。 正常性プローブのトラフィックは、正常性プローブを生成するプローブ サービスとお客様の VM の間で直接やり取りされます。 Load Balancer のすべての正常性プローブは、ソースとして IP アドレス 168.63.129.16 から送信されます。  RFC1918 空間ではない、VNet 内の IP アドレス空間を使用できます。  グローバルに予約された Microsoft 所有の IP アドレスを使用すると、お客様が VNet 内で使用する IP アドレス空間との IP アドレス競合の可能性が低くなります。  この IP アドレスはすべてのリージョンにおいて同一で、変更されません。また、この IP アドレスからパケットを送信できるのは内部 Azure プラットフォーム コンポーネントだけであるため、セキュリティ リスクになりません。 

AzureLoadBalancer サービス タグによって、お客様の[ネットワーク セキュリティ グループ](../virtual-network/security-overview.md)に含まれているこのソース IP アドレスが特定され、正常性プローブのトラフィックが既定で許可されます。

Load Balancer の正常性プローブだけでなく、[次の操作でもこの IP アドレスが使用されます](../virtual-network/what-is-ip-address-168-63-129-16.md)。

- VM エージェントを、プラットフォームと通信して "準備完了" 状態を通知できるようにします
- カスタム DNS サーバーを定義していないお客様にフィルター処理された名前解決を提供するため、DNS 仮想サーバーとの通信を有効にします。  このフィルター処理により、お客様はデプロイのホスト名だけを確実に解決できます。
- VM が、Azure の DHCP サービスから動的 IP アドレスを取得できるようにします。

## <a name="design"></a> 設計ガイダンス

正常性プローブは、お客様のサービスを回復性があるものにして、そのスケーリングを可能にするために使用されます。 誤った構成または不適切な設計パターンは、お客様のサービスの可用性とスケーラビリティに影響を及ぼす可能性があります。 このドキュメント全体を確認して、このプローブ応答がダウンまたはアップとしてマークされた場合にお客様のシナリオにどのような影響があるか、また、お客様のアプリケーション シナリオの可用性に対してそれがどのように影響するかについて検討してください。

お客様がご自分のアプリケーション用に正常性モデルを設計する際は、バックエンド インスタンス __と__ お客様が提供しているアプリケーション サービスの正常性を反映する、そのインスタンス上のポートをプローブする必要があります。  アプリケーション ポートとプローブ ポートが同一である必要はありません。  一部のシナリオでは、プローブ ポートが、お客様のアプリケーションのサービスを提供するポートと異なることが望ましい場合もあります。  

場合によっては、お客様のアプリケーションの正常性を検出するためだけではなく、お客様のインスタンスが新しいフローを受信すべきかどうかを Load Balancer に直接伝えるために正常性プローブ応答を生成することが、お客様のアプリケーションの役に立つ可能性があります。  お客様のアプリケーションで正常性プローブの失敗によってバックプレッシャを作成してインスタンスへの新しいフローの送信を調整したり、お客様のアプリケーションのメンテナンスを準備してお客様のシナリオのドレインを開始したりするために、プローブ応答を操作できます。  Standard Load Balancer を使用している場合、[プローブのダウン](#probedown)信号では常に、アイドル タイムアウトまたは接続の終了まで TCP フローが継続されます。 

UDP の負荷分散では、バックエンド インスタンスからカスタム正常性プローブ シグナルを生成し、対応するリスナーがターゲットの TCP、HTTP、または HTTPS の正常性プローブを使用して、お客様の UDP アプリケーションの正常性を反映する必要があります。

[Standard Load Balancer](load-balancer-standard-overview.md) による [HA ポート負荷分散規則](load-balancer-ha-ports-overview.md)を使用すると、すべてのポートが負荷分散されて、1 つの正常性プローブ応答がインスタンス全体の状態を反映する必要があります。

お客様の VNet 内にある別のインスタンスへの正常性プローブを受信するインスタンスによる正常性プローブの変換またはプロキシは行わないでください。この構成では、お客様のシナリオで障害が連鎖的に発生する可能性があります。  次のシナリオを検討してください。スケーラビリティと冗長性をアプライアンスに提供する Load Balancer リソースのバックエンド プールに一連のサードパーティ アプライアンスがデプロイされています。また、アプライアンスの背後にある他の仮想マシンへのプロキシまたは変換がサードパーティ アプライアンスによって行われるポートをプローブするよう、正常性プローブが構成されています。  アプライアンスの背後にある他の仮想マシンに対して要求を変換またはプロキシするために使用している同じポートをプローブすると、アプライアンスの背後にある単一の仮想マシンからのプローブ応答によって、アプライアンス自体が停止状態としてマークされます。 この構成では、アプライアンスの背後にある単一のバックエンド インスタンスによって、アプリケーションのシナリオ全体が連鎖的に失敗する可能性があります。  トリガーとなり得るのはプローブの断続的な失敗です。これが原因で、Load Balancer によって元の送信先 (アプライアンスのインスタンス) がダウンとしてマークされ、お客様のアプリケーションのシナリオ全体が無効になる可能性があります。 代わりにアプライアンス自体の正常性をプローブしてください。 正常性シグナルを特定するプローブの選択はネットワーク仮想アプライアンス (NVA) のシナリオで重要な考慮事項です。このようなシナリオでは、適切な正常性シグナルについてお客様のアプリケーション ベンダーと相談する必要があります。

お客様のファイアウォール ポリシーでプローブの[ソース IP](#probesource) を許可しない場合、正常性プローブはお客様のインスタンスに到達できないため失敗します。  さらに、正常性プローブが失敗するため、Load Balancer はインスタンスをダウンとしてマークします。  この誤った構成は、お客様の負荷分散アプリケーションのシナリオが失敗する原因となる可能性があります。

Load Balancer の正常性プローブによってお客様のインスタンスがアップとしてマークされるには、Azure の[ネットワーク セキュリティ グループ](../virtual-network/security-overview.md)とローカル ファイアウォールのポリシーで、この IP アドレスを許可する**必要があります**。  既定では、正常性プローブのトラフィックを許可するための[サービス タグ](../virtual-network/security-overview.md#service-tags) AzureLoadBalancer がすべてのネットワーク セキュリティ グループに含まれています。

正常性プローブの失敗をテストしたい場合、または個別のインスタンスをダウンとしてマークしたい場合は、[ネットワーク セキュリティ グループ](../virtual-network/security-overview.md)を使用し、正常性プローブ (宛先ポートまたは[ソース IP](#probesource)) を明示的にブロックしてプローブの失敗をシミュレートできます。

168.63.129.16 が含まれている Microsoft 所有の IP アドレス範囲を使用してお客様の VNet を構成しないでください。  このような構成は正常性プローブの IP アドレスと競合して、お客様のシナリオの失敗を引き起こす可能性があります。

VM に複数のインターフェイスがある場合は、プローブを受信したインターフェイスでプローブに応答することを保証する必要があります。  VM でインターフェイスごとにこのアドレスをソース ネットワーク アドレス変換することが必要な場合があります。

[TCP タイムスタンプ](https://tools.ietf.org/html/rfc1323)は有効にしないでください。  TCP タイムスタンプを有効にすると、TCP パケットが VM のゲスト OS TCP スタックによってドロップされるため、正常性プローブが失敗します。その結果 Load Balancer によって、各エンドポイントがダウンとしてマークされます。  TCP タイムスタンプは、セキュリティで強化された VM イメージにおいて既定で定期的に有効にされるので、無効にする必要があります。

## <a name="monitoring"></a>監視

公開および内部の [Standard Load Balancer](load-balancer-standard-overview.md) はいずれも、Azure Monitor を使用してエンドポイントおよびバックエンド インスタンスの正常性プローブ状態を多次元メトリックとして公開します。 これらのメトリックは、他の Azure サービスやパートナー アプリケーションによって消費される可能性があります。 

公開の Basic Load Balancer では、Azure Monitor ログ経由でバックエンド プールごとにまとめられた正常性プローブの状態が公開されます。  Azure Monitor ログは内部の Basic Load Balancer では使用できません。  [Azure Monitor ログ](load-balancer-monitor-log.md)を使って、パブリック Load Balancer のプローブの正常性状態とプローブの数を確認できます。 ログ記録と共に Power BI または Azure Operational Insights を使用することで、Load Balancer の正常性状態の統計情報を提供することができます。

## <a name="limitations"></a>制限事項

- HTTPS プローブは、クライアント証明書との相互認証をサポートしていません。
- 正常性プローブは、TCP タイムスタンプが有効な場合に失敗します。

## <a name="next-steps"></a>次の手順

- [Standard Load Balancer](load-balancer-standard-overview.md) の詳細を確認する
- [PowerShell を使用した Resource Manager でのパブリック ロード バランサーの作成の概要](load-balancer-get-started-internet-arm-ps.md)
- [正常性プローブ用の REST API](https://docs.microsoft.com/rest/api/load-balancer/loadbalancerprobes/)
- [Load Balancer の Uservoice](https://aka.ms/lbuservoice) で新しい正常性プローブ機能をリクエストする
