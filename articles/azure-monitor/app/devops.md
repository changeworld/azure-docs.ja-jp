---
title: Web アプリのパフォーマンスの監視 - Azure Application Insights
description: 開発運用サイクルへの Application Insights の組み込み
ms.topic: conceptual
ms.date: 12/21/2018
ms.openlocfilehash: 24095aade80022d1e1ebb38357971512bfc873c0
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "77669694"
---
# <a name="deep-diagnostics-for-web-apps-and-services-with-application-insights"></a>Application Insights を使用した Web アプリおよびサービスの詳細な診断
## <a name="why-do-i-need-application-insights"></a>Application Insights が必要な理由
Application Insights は、実行中の Web アプリを監視します。 これを使用することでエラーやパフォーマンスの問題が通知され、顧客がどのようにアプリを使用しているかを分析するのに役立ちます。 多くのプラットフォーム (ASP.NET、Java EE、Node.js など) で実行されるアプリで動作し、クラウドまたはオンプレミスのいずれかでホストされます。 

![Aspects of the complexity of delivering web apps](./media/devops/010.png)

最新のアプリケーションでは、実行中の監視が不可欠です。 最も重要なのは、ほとんどの顧客よりも早くエラーを検出することです。 致命的なものでなくても、速度の低下を招いたり、ユーザーに不都合をもたらしたりする可能性のあるパフォーマンスの問題を検出して修正することも必要です。 また、システムが期待どおりに動作している場合は、ユーザーがシステムを使用して何をしているのか、つまり、最新機能を使用しているか、 うまく使用できているか、などを知りたいと思うでしょう。

最新の Web アプリケーションは、新機能または機能強化をリリースし、それがユーザー環境でどの程度正常に動作しているかを確認して、その知識に基づいて次の開発の強化を計画するという、継続的デリバリーのサイクルの中で開発されます。 このサイクルで重要なのは観察のフェーズです。 Application Insights は、Web アプリケーションのパフォーマンスと使用状況を監視するためのツールを提供します。

このプロセスで最も重要なのは診断です。 アプリケーションがうまく動かないと、ビジネスの損失が発生します。 したがって、監視フレームワークの最も重要な役割は、エラーを確実に検出してすぐに通知し、問題を診断するために必要な情報を提供することです。 これこそが Application Insights の機能です。

### <a name="where-do-bugs-come-from"></a>バグはどこから発生するのか
通常、Web システムでのエラーは、構成の問題や、多くのコンポーネント間の不適切な相互作用に起因します。 したがって、ライブ サイトのインシデントに取り組む際の最初のタスクは、問題の場所を特定することになります。原因となっているコンポーネントまたはリレーションシップは何か、ということです。

1 つのコンピューター プログラムが 1 台のコンピューターで実行されるという、より単純だった頃を覚えている方もいるでしょう。 開発者は、出荷する前にコンピューター プログラムを徹底的にテストしますが、出荷してしまえば、プログラムを確認したり、それについて考えたりすることはめったにありませんでした。 ユーザーは何年もの間、未解決のバグに我慢しなければなりませんでした。 

しかし、今はまったく違います。 アプリが実行されるデバイスは多種多様で、それぞれのデバイスでまったく同じ動作を保証することは困難である場合があります。 クラウドでアプリを提供するということは、すばやくバグを修正できることを意味しますが、絶え間ない競争と頻繁な新機能の提供への期待も伴います。 

このような状況で、バグの数を確実に管理する唯一の方法は、自動化された単体テストです。 出荷のたびにすべてを手動で再テストすることは不可能でしょう。 現在では、単体テストはビルド プロセスの一部として普及しています。 複数のブラウザー バージョンでの UI テストの自動化を提供する Xamarin Test Cloud などのツールが役立ちます。 このようなテスト方法を活用することで、私たちはアプリで見つかるバグの割合を最小限に抑えることを期待できます。

一般的な Web アプリケーションには多くのライブ コンポーネントがあります。 クライアント (ブラウザーやデバイス アプリ) と Web サーバーに加え、相当量のバックエンド処理もあるでしょう。 そのバックエンドはおそらく、コンポーネントのパイプラインや、連携する構成要素の厳密ではない集合体です。 それらの多くは管理できません。なぜなら、外部に依存しているサービスだからです。

このような構成では、ライブ システム自体以外の、考えられるすべての障害の状態をテスト、あるいは予測することは困難かつ非経済的である場合があります。 

### <a name="questions-"></a>疑問 ...
私たちは Web システムを開発しているとき、次のような疑問を抱きます。

* アプリはクラッシュしていますか。 
* 正確には何が起こりましたか。 要求に失敗した場合、そうなった経緯を把握したいと考えます。 イベントのトレースが必要です。
* アプリの速度は十分ですか。 一般的な要求への応答時間はどのくらいですか。
* サーバーは負荷を処理できますか。 要求率が増加した時の応答時間は安定していますか。
* 依存するコンポーネント (アプリが呼び出す REST API、データベースなど) の応答速度はどのくらいですか。 具体的には、そのシステムが低速の場合、それは自分のコンポーネントですか。または、他のユーザーから低速な応答を受け取っていますか。
* アプリは起動していますか、停止していますか。 世界各地から閲覧できますか。 アプリが停止したら知らせてほしい…
* 根本的な原因は何ですか。 コンポーネントまたは依存関係の障害でしたか。 通信に関する問題ですか。
* 影響を受けるユーザーの数はどのくらいですか。 対処すべき問題が複数ある場合は、最も重要なのはどれですか。

## <a name="what-is-application-insights"></a>Application Insights とは何か?
![Basic workflow of Application Insights](./media/devops/020.png)

1. Application Insights では、アプリをインストルメント化し、アプリの実行時に、アプリに関するテレメトリを送信します。 Application Insights SDK をアプリに組み込むか、実行時にインストルメンテーションを適用することができます。 前者の方法は、標準のモジュールに独自のテレメトリを追加するできるため、より柔軟です。
2. テレメトリは、テレメトリが保管および処理される Application Insights ポータルに送信されます (Application Insights が Microsoft Azure で提供されている場合でも、Azure アプリだけでなく、任意の Web アプリを監視することができます)。
3. テレメトリは、イベントのグラフとテーブルの形式で表示されます。

テレメトリには 2 つの主な種類があります。 集計インスタンスと生のインスタンスです。 

* インスタンス データには、たとえば Web アプリが受信した要求のレポートが含まれています。 Application Insights ポータルの検索ツールを使用して、要求の詳細を検索して検査できます。 インスタンスには、アプリが要求に応答するために要した時間、要求された URL、クライアントのおおよその場所などのデータが含まれています。
* 集計データには、要求の割合を応答時間と比較できるように、単位時間あたりのイベントの数が含まれています。 要求の応答時間などのメトリックの平均値も含まれています。

データの主なカテゴリは次のとおりです。

* URL、応答時間、成功または失敗に関するデータを含む、アプリへの要求 (通常は HTTP 要求)。
* 依存関係 - URI、応答時間、および成功を含む、アプリケーションによって行われる REST および SQL の呼び出し。
* スタック トレースを含む例外。
* ユーザーのブラウザーから取得するページ ビュー データ。
* パフォーマンス カウンターなどのメトリックおよび自分で作成したメトリック。 
* ビジネス イベントを追跡するために使用できるカスタム イベント。
* デバッグに使用するログ トレース。

## <a name="case-study-real-madrid-fc"></a>ケース スタディ: レアル・マドリード F.C.
[レアル・マドリード フットボール クラブ](https://www.realmadrid.com/) の Web サービスは、世界各地の約 4 億 5,000 万人のファンにサービスを提供しています。 ファンは、Web ブラウザーとクラブのモバイル アプリの両方からここにアクセスします。 ファンはチケットを予約できるだけでなく、試合結果、選手、今後の試合に関する情報やビデオ クリップにもアクセスできます。 フィルターを使用して、得点数などを検索できます。 ソーシャル メディアへのリンクもあります。 ユーザー エクスペリエンスは高度にパーソナライズされており、ファンとの交流のための双方向コミュニケーションとして設計されています。

このソリューションは、[Microsoft Azure でのサービスとアプリケーションのシステム](https://www.microsoft.com/inculture/sports/real-madrid/)です。 スケーラビリティは重要な要件です。これは、トラフィックが変わりやすく、試合の前後と試合中は、トラフィック量が大幅に増える場合があるためです。

レアル・マドリードでは、システムのパフォーマンスを監視することが不可欠です。 Azure Application Insights は、システム全体の包括的なビューを提供し、信頼性の高い、高いサービス レベルを確保できます。 

クラブは、ファンに関する詳細な情報も取得します。この情報には、ファンの場所 (スペインはたった 3% です)、ファンが関心を持っている選手、過去の試合結果、今後の試合、および試合結果に対する反応が含まれます。

このテレメトリ データの大部分は、コードの追加なしで自動的に収集されます。これにより、ソリューションが単純化され、運用上の複雑さが軽減されます。  レアル・マドリードの場合、Application Insights は 1 か月あたり 38 億人のテレメトリ ポイントを処理します。

レアル・マドリードは Power BI モジュールを使用してテレメトリを表示します。

![Power BI view of Application Insights telemetry](./media/devops/080.png)

## <a name="smart-detection"></a>スマート検出
[プロアクティブ診断](../../azure-monitor/app/proactive-diagnostics.md)は最新の機能です。 特別な構成なしで、Application Insights はアプリの障害発生率の異常な増加を自動的に検出してアラートを生成します。 この機能は、偶発的なエラーの背景と、要求の数に比例して単純に増加したエラーを無視できるほどスマートです。 そのため、たとえば、依存するサービスのいずれかで障害が発生した場合や、デプロイしたばかりの新しいビルドがうまく動作していない場合、電子メールを確認してすぐにそれを把握できます (他のアプリをトリガーできるように webhook も用意されています)。

テレメトリの詳細な分析を毎日実行し、検出が困難なパフォーマンスの異常なパターンを検出するのが、この機能のもう 1 つの側面です。 たとえば、特定の地理的領域または特定のブラウザーのバージョンに関連付けられたパフォーマンスの低下を検出できます。

どちらの場合も、アラートは検出した現象を通知するだけでなく、関連する例外レポートなど、問題の診断に必要なデータも提供します。

![Email from proactive diagnostics](./media/devops/030.png)

お客様である Samtec は次のように語っています。「私たちは、先日の機能のカット オーバーの際、リソースの限界に達し、タイムアウトを発生させている小規模なデータベースに気づきました。 私たちが問題をトリアージしているとき、広告のとおり、まさにほぼリアルタイムでプロアクティブな検出アラートが生成されました。 このアラートと Azure プラットフォームのアラートによって、ほぼ瞬時に問題を修正することができました。 ダウンタイムは合計で 10 分未満でした。」

## <a name="live-metrics-stream"></a>ライブ メトリック ストリーム
最新のビルドを展開することは、気がかりな体験となる場合があります。 何らかの問題がある場合、必要に応じて取り消すことができるように、すぐに問題を把握する必要があります。 ライブ メトリック ストリームを使用すると、約 1 秒の待機時間で重要なメトリックが提供されます。

![Live metrics](./media/devops/0040.png)

また、すぐにエラーまたは例外のサンプルを検査できます。

![ライブ エラーに関するイベント](./media/devops/002-live-stream-failures.png)

## <a name="application-map"></a>アプリケーション マップ
アプリケーション マップは、アプリケーション トポロジを自動的に検出して、その上にパフォーマンス情報を配置し、分散環境全体のパフォーマンスのボトルネックと問題のあるフローを簡単に識別できるようにします。 Azure サービスのアプリケーションの依存関係を検出できます。 問題がコードに関連するか依存関係に関連するかを把握し、関連する診断操作を 1 か所から行うことで、問題をトリアージできます。 たとえば、アプリケーションは SQL 層のパフォーマンスの低下が原因で失敗している可能性があります。 アプリケーション マップを使用すると、問題をすぐに確認し、SQL Index Advisor やクエリの洞察の操作をドリルダウンすることができます。

![アプリケーション マップ](./media/devops/0050.png)

## <a name="application-insights-analytics"></a>Application Insights Analytics
[Analytics](../../azure-monitor/app/analytics.md)を使用すれば、強力な SQL に似た言語で任意のクエリを記述することができます。  さまざまなパースペクティブが接続されるため、アプリ スタック全体を診断するのが簡単で、ビジネス メトリックおよび顧客満足度とサービスのパフォーマンスを関連付ける適切な質問をすることができます。 

ポータルに格納されているすべてのテレメトリ インスタンスとメトリックの生データを照会できます。 言語には、フィルター、結合、集計などの操作が含まれています。 フィールドを計算し、統計的な分析を実行できます。 テーブルとグラフ両方の視覚エフェクトがあります。

![Analytics query and results chart](./media/devops/0025.png)

たとえば、次のことを簡単に行うことができます。

* アプリケーションの要求のパフォーマンス データを顧客層ごとに分割し、顧客満足度を把握します。
* ライブ サイトの調査中に特定のエラー コードまたはカスタム イベント名を検索します。
* 特定の顧客のアプリの使用状況をドリルダウンし、機能がどのように入手および導入されているかを把握します。
* 特定のユーザーのセッションと応答時間を追跡し、サポートおよび運用チームがすぐに顧客サポートを提供できるようにします。
* 頻繁に使用されるアプリ機能を判別し、機能の優先順位付けに関する質問に回答します。

お客様である DNN は次のように語っています。「Application Insights は、必要に応じてデータの結合、並べ替え、クエリ、およびフィルター処理を実現するための均衡の欠落部分を補ってくれました。 当社のチームが独自のアイデアと経験を活用し、強力なクエリ言語でデータを検索できることで、当社は洞察を検索して、今まで知りもしなかった問題を解決することができます。 *"...だろうか"* で終わる質問から、多くの興味深い回答が生まれます。」

## <a name="development-tools-integration"></a>開発ツールの統合
### <a name="configuring-application-insights"></a>Application Insights の構成
Visual Studio および Eclipse には、開発しているプロジェクトの正しい SDK パッケージを構成するためのツールが用意されています。 Application Insights を追加するメニュー コマンドがあります。

Log4N、NLog、System.Diagnostics.Trace などのトレース ログ記録フレームワークを使用している場合は、そのログを他のテレメトリと共に Application Insights に送信し、要求、依存関係の呼び出し、例外とそのトレースを簡単に関連付けることができます。

### <a name="search-telemetry-in-visual-studio"></a>Visual Studio でのテレメトリの検索
機能を開発およびデバッグしているとき、Web ポータルと同じ検索機能を使用して、Visual Studio で直接テレメトリを表示および検索することができます。

また、Application Insights で例外が記録されると、Visual Studio でそのデータ ポイントを確認し、関連するコードに直接移動できます。

![Visual Studio search](./media/devops/060.png)

デバッグ中は、開発用コンピューターにテレメトリを保存し、ポータルに送信することなく Visual Studio でそれを表示するオプションが用意されています。 このローカル オプションにより、デバッグと運用環境のテレメトリの混合を回避できます。

### <a name="work-items"></a>作業項目
Application Insights では、アラートが発生したときに、作業項目追跡システムに自動的に作業項目を作成できます。

## <a name="but-what-about"></a>詳細について
* [プライバシーと記憶域](../../azure-monitor/app/data-retention-privacy.md) - テレメトリは Azure のセキュリティで保護されたサーバー上に保持されます。
* パフォーマンス - 影響は非常に低いです。 テレメトリはバッチ処理されます。
* [価格](../../azure-monitor/app/pricing.md) - 無料で開始することができ、容量が少ない間は無料期間を継続できます。


## <a name="video"></a>ビデオ

> [!VIDEO https://channel9.msdn.com/events/Connect/2016/112/player]

## <a name="next-steps"></a>次のステップ
Application Insights の操作は簡単です。 主なオプションは次のとおりです。

* [IIS サーバー](../../azure-monitor/app/monitor-performance-live-website-now.md)、および [Azure App Service](../../azure-monitor/app/app-insights-overview.md) 用。
* 開発中のプロジェクトをインストルメント化します。 これは、[ASP.NET](../../azure-monitor/app/asp-net.md) または [Java](../../azure-monitor/app/java-get-started.md) アプリだけでなく、[Node.js](../../azure-monitor/app/nodejs.md) や[他の種類](../../azure-monitor/app/platforms.md)のホストでも実行できます。 
* 短いコード スニペットを追加して、 [任意の Web ページ](../../azure-monitor/app/javascript.md) をインストルメント化します。

