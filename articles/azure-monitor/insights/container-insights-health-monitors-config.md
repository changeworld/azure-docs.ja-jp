---
title: コンテナーに対する Azure Monitor の正常性モニターを構成する | Microsoft Docs
description: この記事では、コンテナーに対する Azure Monitor で正常性モニターを構成する詳細な方法について説明します。
services: azure-monitor
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ''
ms.service: azure-monitor
ms.topic: conceptual
ms.workload: infrastructure-services
ms.date: 11/12/2019
ms.author: magoedte
ms.openlocfilehash: 7d4400b563a1d0b8bf094f946a37d7ff4a17e7cf
ms.sourcegitcommit: 57eb9acf6507d746289efa317a1a5210bd32ca2c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/01/2019
ms.locfileid: "74664949"
---
# <a name="azure-monitor-for-containers-health-monitor-configuration-guide"></a>コンテナーに対する Azure Monitor の正常性モニターの構成ガイド

モニターは、コンテナーに対する Azure Monitor で正常性を測定し、エラーを検出するための主要な要素です。 この記事は、正常性を測定する方法の概念と、[正常性 (プレビュー)](container-insights-health.md) 機能を使用して Kubernetes クラスターの正常性を監視および報告する正常性モデルを構成する要素を理解するのに役立ちます。

>[!NOTE]
>現時点では、正常性機能はパブリック プレビューの段階です。
>

## <a name="monitors"></a>モニター

モニターは、管理オブジェクトの特定の側面の正常性を測定します。 モニターには、それぞれ 2 つまたは 3 つの正常性状態があります。 モニターは、特定の時点で状態内 1 つにのみ含まれます。 コンテナー化されたエージェントによって読み込まれたモニターは、正常な状態に初期化されます。 状態は、別の状態に対して指定された条件が検出された場合にのみ変化します。

特定のオブジェクトの全体的な正常性は、各モニターの正常性により決定されます。 この階層は、コンテナーに対する Azure Monitor の [Health Hierarchy]\(正常性の階層\) ウィンドウに示されています。 正常性のロールアップ方法のポリシーは、集計モニターの一部です。

## <a name="types-of-monitors"></a>モニターの種類

|監視 | 説明 | 
|--------|-------------|
| ユニット モニター |ユニット モニターは、リソースまたはアプリケーションの一部の側面を測定します。 パフォーマンス カウンターを調べて、リソースのパフォーマンスまたはその可用性を判断することなどが含まれます。 |
|集計モニター | 集計モニターは、複数のモニターをグループ化して、正常性を集計した 1 つ正常性状態を示します。 ユニット モニターは、通常、特定の集計モニターの元構成されます。 たとえば、ノード集計モニターは、ノードの CPU 使用率、メモリ使用率、およびノードの状態の状態をロール アップします。
 |

### <a name="aggregate-monitor-health-rollup-policy"></a>集計モニターの正常性ロール アップ ポリシー

各集計モニターは、正常性ロール アップ ポリシーを定義します。これは、その下にあるモニターの正常性に基づいて集計モニターの正常性を判断するために使用されるロジックです。 集計モニターに対して適用可能な正常性ロール アップ ポリシーは、次のとおりです。

#### <a name="worst-state-policy"></a>最も悪い状態のポリシー

集計モニターの状態が、正常性状態が最も悪い子モニターの状態と一致します。 これは、集計モニターによって使用される最も一般的なポリシーです。

![集計モニター ロール アップの最も悪い状態の例](./media/container-insights-health-monitoring-cfg/aggregate-monitor-rollup-worstof.png)

### <a name="percentage-policy"></a>割合ポリシー

ソース オブジェクトが、最適な状態にある、指定された割合のターゲット オブジェクトの 1 つのメンバーの最も悪い状態と一致します。 このポリシーは、ターゲット オブジェクトが正常と見なされるには、ターゲット オブジェクトの特定の割合が正常である必要がある場合に使用されます。 割合ポリシーは、モニターを状態の重大度の降順で並べ替え、集計モニターの状態は、N% の最も悪い状態として計算されます (N は構成パラメーター *StateThresholdPercentage*) によって決まります。

たとえば、コンテナー イメージのコンテナー インスタンスが 5 つあり、それぞれの状態が **重大**、**警告**、**正常**、**正常**、**正常**であるとします。  コンテナーの CPU 使用率モニターの状態は、**重大**です。これは、コンテナ―の最も悪い状態を重要度の降順で並べ替えた場合、その 90% が**重大**であるためです。

## <a name="understand-the-monitoring-configuration"></a>監視構成について

コンテナーに対する Azure Monitor には、次のように構成される主要な監視シナリオが多数含まれています。

### <a name="unit-monitors"></a>ユニット モニター

|**モニター名** | モニターの種類 | **説明** | **パラメーター** | **値** |
|-----------------|--------------|-----------------|---------------|-----------|
|ノードのメモリ使用状況 |ユニット モニター |このモニターは、cadvisor によって報告されたデータを使用して、1 分ごとにノードのメモリ使用率を評価します。 |ConsecutiveSamplesForStateTransition<br> FailIfGreaterThanPercentage<br> WarnIfGreaterThanPercentage | 3<br> 90<br> 80  ||
|ノードの CPU 使用状況 |ユニット モニター |このモニターは、cadvisor によって報告されたデータを使用して、1 分ごとに CPU のメモリ使用率をチェックします。 | ConsecutiveSamplesForStateTransition<br> FailIfGreaterThanPercentage<br> WarnIfGreaterThanPercentage | 3<br> 90<br> 80  ||
|ノードの状態 |ユニット モニター |このモニターは、Kubernetes によって報告されたノードの状態を確認します。<br> 現在、次のノード条件がチェックされています。ディスクの負荷、メモリの負荷、PID の負荷、ディスクの不足、ネットワークが使用不可、ノードの準備完了状態。<br> 上記の条件を満たしていない場合、"*ディスクの不足*" または "*ネットワークが使用不可*" が **true** の場合は、モニターが**重大**状態に変わります。<br> **[準備完了]** 状態以外で **true** になっている条件がある場合、モニターは**警告**状態に変わります。 | NodeConditionTypeForFailedState | outofdisk、networkunavailable ||
|コンテナーのメモリ使用率 |ユニット モニター |このモニターは、コンテナーのインスタンスのメモリ使用率 (RSS) を統合した正常性状態を報告します。<br> これは、各サンプルを構成パラメーター **ConsecutiveSamplesForStateTransition** によって指定し、1 つのしきい値と比較する単純な比較を実行します。<br> この状態は、コンテナー (StateThresholdPercentage) インスタンスの 90% の最も悪い状態として計算され、コンテナーの正常性状態 (つまり、重大、警告、正常) の重大度の降順で並べ替えられます。<br> コンテナー インスタンスからレコードを受信しなかった場合、コンテナー インスタンスの正常性状態は **[不明]** として報告され、並べ替えの際に **[重大]** 状態より優先順位が高くなります。<br> 個々のコンテナー インスタンスの状態は、構成で指定されたしきい値を使用して計算されます。 使用率が重大しきい値 (90%) を超えている場合は **[重大]** 状態になり、重大しきい値 (90%) は超えないが、警告しきい値 (80%) を超える場合、インスタンスは **[警告]** 状態になります。 それ以外の場合は **[正常]** 状態になります。 |ConsecutiveSamplesForStateTransition<br> FailIfLessThanPercentage<br> StateThresholdPercentage<br> WarnIfGreaterThanPercentage| 3<br> 90<br> 90<br> 80 ||
|コンテナーの CPU 使用率 |ユニット モニター |このモニターは、コンテナーのインスタンスの CPU 使用率を統合した正常性状態を報告します。<br> これは、各サンプルを構成パラメーター **ConsecutiveSamplesForStateTransition** によって指定し、1 つのしきい値と比較する単純な比較を実行します。<br> この状態は、コンテナー (StateThresholdPercentage) インスタンスの 90% の最も悪い状態として計算され、コンテナーの正常性状態 (つまり、重大、警告、正常) の重大度の降順で並べ替えられます。<br> コンテナー インスタンスからレコードを受信しなかった場合、コンテナー インスタンスの正常性状態は **[不明]** として報告され、並べ替えの際に **[重大]** 状態より優先順位が高くなります。<br> 個々のコンテナー インスタンスの状態は、構成で指定されたしきい値を使用して計算されます。 使用率が重大しきい値 (90%) を超えている場合は **[重大]** 状態になり、重大しきい値 (90%) は超えないが、警告しきい値 (80%) を超える場合、インスタンスは **[警告]** 状態になります。 それ以外の場合は **[正常]** 状態になります。 |ConsecutiveSamplesForStateTransition<br> FailIfLessThanPercentage<br> StateThresholdPercentage<br> WarnIfGreaterThanPercentage| 3<br> 90<br> 90<br> 80 ||
|システム ワークロード ポッドの準備完了 |ユニット モニター |このモニターは、特定のワークロードにおける準備完了状態のポッドの割合に基づいて状態を報告します。 ポッドの 100% 未満が **[正常]** 状態の場合、状態は **[重要]** に設定されます |ConsecutiveSamplesForStateTransition<br> FailIfLessThanPercentage |2<br> 100 ||
|Kube API ステータス |ユニット モニター |このモニターは、Kube Api サービスの状態を報告します。 Kube Api エンドポイントが使用できない場合、モニターは重大な状態になります。 この特定のモニターに限り、状態は kube サーバーの "ノード" エンドポイントに対してクエリを作成することによって決定されます。 応答コードが OK でない限り、モニターは **[重大]** 状態になります。 | 構成プロパティなし |||

### <a name="aggregate-monitors"></a>集計モニター

|**モニター名** | **説明** | **アルゴリズム** |
|-----------------|-----------------|---------------|
|ノード |このモニターは、すべてのノード モニターを集計したものです。 これは、正常性状態が最も悪い次の子モニターの状態と一致します。<br> ノードの CPU 使用状況<br> ノードのメモリ使用状況<br> ノードの状態 | 最低|
|ノード プール |このモニターは、ノードプール *agentpool* のすべてのノードの正常性状態をまとめて報告します。 これは 3 つの状態があるモニターで、ノード プール内のノードの 80% が示す最も悪い状態に基づいており、ノードの状態 (つまり、重大、警告、正常) の重要度の降順で並べ替えられています。|割合 |
|ノード (ノード プールの親) |これは、すべてのノード プールの集計モニターです。 状態は、子モニタ (クラスタ内に存在するノード プール) の最も悪い状態に基づいています。 |最低 |
|クラスター (ノードの親/<br> Kubernetes インフラストラクチャ) |これは、正常性状態が最も悪い子モニタの状態と一致する親モニター (kubernetes インフラストラクチャとノード) です。 |最低 |
|Kubernetes インフラストラクチャ |このモニターは、クラスターで管理されているインフラストラクチャ コンポーネントの正常性状態をまとめて報告します。 状態は、その子モニターの '最も悪い' 状態 (kube システムのワークロードと API サーバーの状態) として計算されます。 |最低|
|システム ワークロード |このモニターは、kube システム ワークロードの正常性状態を報告します。 このモニターは、正常性状態が最も悪いの子モニターの状態、つまり **[準備完了状態のポッド]** (モニターとワークロード内のコンテナー) と一致します。 |最低 |
|コンテナー |このモニターは、特定のワークロード内のコンテナーの全体的な正常性状態を報告します。 このモニターは、正常性状態が最も悪い子モニターの状態、つまり **[CPU 使用率]** と **[メモリ使用率]** モニターと一致します。 |最低 |

## <a name="next-steps"></a>次の手順

Kubernetes クラスターの正常性状態の表示方法については、「[クラスターの正常性を監視する](container-insights-health.md)」を参照してください。
