---
title: Azure Policy を使用して Azure Monitor for VMs を有効にする
description: この記事では、Azure Policy を使用して、複数の Azure 仮想マシンまたは仮想マシン スケール セットで Azure Monitor for VMs を有効にする方法について説明します。
ms.subservice: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/12/2020
ms.openlocfilehash: 73c18d45136eea90ad29dc1bd40c4539dddc0ee6
ms.sourcegitcommit: d57d2be09e67d7afed4b7565f9e3effdcc4a55bf
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/22/2020
ms.locfileid: "81767259"
---
# <a name="enable-azure-monitor-for-vms-by-using-azure-policy"></a>Azure Policy を使用して Azure Monitor for VMs を有効にする

この記事では、Azure Policy を使用して、Azure 仮想マシンまたは仮想マシン スケール セットで Azure Monitor for VMs を有効にする方法について説明します。 このプロセスの最後には、Log Analytics エージェントと依存関係エージェントの有効化が正常に構成され、準拠していない仮想マシンが識別されています。

すべての Azure 仮想マシンまたは仮想マシン スケール セットで Azure Monitor for VMs を検出、管理、および有効化するには、Azure Policy または Azure PowerShell のどちらかを使用できます。 Azure Policy は、新しくプロビジョニングされた VM の一貫性のあるコンプライアンスと自動的な有効化が保証されるようにサブスクリプションを効果的に制御するポリシー定義を管理できるため、これが推奨される方法です。 これらのポリシー定義は、次のことを行います。

* Log Analytics エージェントと Dependency Agent をデプロイします。
* コンプライアンスの結果を報告します。
* 準拠していない VM を修復します。

Azure PowerShell または Azure Resource Manager テンプレートを使用してこれらのタスクを実行することに関心がある場合は、[Azure PowerShell または Azure Resource Manager テンプレートを使用して Azure Monitor for VMs を有効にする方法](vminsights-enable-at-scale-powershell.md)に関する記事をご覧ください。

## <a name="prerequisites"></a>前提条件
ポリシーを使用して Azure VM および仮想マシン スケール セットを Azure Monitor for VMs にオンボードする前に、監視データの格納に使用するワークスペースで VMInsights ソリューションを有効にする必要があります。 このタスクを完了するには、Azure Monitor の **[Get started]\(使用の開始\)** ページで **[Other onboarding options]\(その他のオンボード オプション\)** タブを使用します。 **[Configure a workspace]\(ワークスペースの構成\)** を選択すると、構成するワークスペースを選択するよう求められます。

![ワークスペースの構成](media/vminsights-enable-at-scale-policy/configure-workspace.png)

また、 **[Enable using policy]\(ポリシーを使用して有効にする\)** を選択してワークスペースを構成してから、 **[ワークスペースの構成]** ツールバー ボタンを選択することもできます。  これにより、選択したワークスペースに VMInsights ソリューションがインストールされます。このソリューションにより、ポリシーを使用して有効にした VM および仮想マシン スケール セットによって送信された監視データを、ワークスペースで格納できるようになります。 

![ポリシーを使用して有効にする](media/vminsights-enable-at-scale-policy/enable-using-policy.png)

## <a name="manage-policy-coverage-feature-overview"></a>[Manage Policy Coverage] (ポリシー対象範囲の管理) 機能の概要

[Azure Monitor for VMs Policy Coverage]\(Azure Monitor for VMs のポリシー対象範囲\) を使用すると、前に説明したポリシー定義を含む **[Azure Monitor for VMs の有効化]** イニシアチブを大規模に検出、管理、および有効化することが容易になります。 この機能にアクセスするには、Azure Monitor for VMs の **[Get started]\(使用の開始\)** タブで **[Other onboarding options]\(その他のオンボード オプション\)** を選択します。 **[ポリシー対象範囲の管理]** を選択して、 **[Azure Monitor for VMs Policy Coverage]\(Azure Monitor for VMs のポリシー対象範囲\)** ページを開きます。

![Azure Monitor for VMs の [Get Started] (開始する) タブ](./media/vminsights-enable-at-scale-policy/get-started-page.png)

ここで、管理グループとサブスクリプションにわたるイニシアチブの対象範囲の確認および管理を行うことができます。 管理グループおよびサブスクリプションそれぞれに存在する VM の数と、それらのコンプライアンスの状態を把握することができます。

![Azure Monitor for VMs の [Policy Coverage] (ポリシー対象範囲) ページ](media/vminsights-enable-at-scale-policy/manage-policy-page-01.png)

この情報は、中心的な 1 つの場所から Azure Monitor for VMs のためのガバナンス シナリオを計画して実行するために役立ちます。 Azure Policy では、ポリシーまたはイニシアチブがスコープに割り当てられているときのコンプライアンス ビューが提供されるのに対して、この新しいページを使用すると、ポリシーまたはイニシアチブが割り当てられていない場所を検出し、所定の場所に割り当てることができます。 割り当て、表示、編集などのすべてのアクションが Azure Policy に直接リダイレクトされます。 **[Azure Monitor for VMs Policy Coverage]\(Azure Monitor for VMs のポリシー対象範囲\)** ページは、 **[Azure Monitor for VMs の有効化]** イニシアチブのみに対して拡張および統合されたエクスペリエンスです。

このページからは、Azure Monitor for VMs のための Log Analytics ワークスペースを構成することもできます。これにより、次が実行されます。

- Service Map ソリューションをインストールします。
- パフォーマンス グラフ、ワークブック、およびカスタム ログ クエリとアラートによって使用されるオペレーティング システムのパフォーマンス カウンターを有効にします。

![Azure Monitor for VMs のワークスペースの構成](media/vminsights-enable-at-scale-policy/manage-policy-page-02.png)

このオプションは、どのポリシー アクションにも関連していません。 これは、Azure Monitor for VMs を有効にするために必要な[前提条件](vminsights-enable-overview.md)を満たす簡単な方法を提供するために利用できます。  

### <a name="what-information-is-available-on-this-page"></a>このページで入手できる情報

次の表は、ポリシー対象範囲の ページに表示される情報の内訳とその解釈方法を示しています。

| 機能 | 説明 | 
|----------|-------------| 
| **スコープ** | 現在保有しているか、または管理グループ階層を通してドリル ダウンする機能を使用してアクセスする権限を継承した管理グループおよびサブスクリプション。|
| **ロール** | スコープに対するロール。閲覧者、所有者、共同作成者のいずれかの可能性があります。 場合によっては、サブスクリプションにはアクセスできるが、それが属する管理グループにアクセスできないことを示すために空白で表示されることがあります。 他の列の情報は、ロールに応じて異なります。 ロールは、ユーザーが表示できるデータや、ポリシーまたはイニシアチブ (所有者) の割り当てまたは編集、コンプライアンスの表示に関してユーザーが実行できるアクションを決定する上で重要です。 |
| **[Total VMs] (VM の総数)** | そのスコープの下にある VM の数。 管理グループの場合、これは、サブスクリプションまたは子管理グループの下で入れ子になっている VM の総数です。 |
| **[Assignment Coverage] (割り当て対象範囲)** | ポリシーまたはイニシアチブの対象となる VM の割合 (%)。 |
| **[Assignment Status] (割り当て状態)** | ポリシーまたはイニシアチブの割り当ての状態に関する情報。 |
| **[Compliant VMs] (準拠している VM)** | ポリシーまたはイニシアチブの下で準拠している VM の数。 **[Azure Monitor for VMs の有効化]** イニシアチブの場合、これは、Log Analytics エージェントと依存関係エージェントの両方を含む VM の数です。 場合によっては、割り当てがない、VM がない、または十分なアクセス許可がないために、空白で表示されることがあります。 情報は **[コンプライアンスの状態]** の下に表示されます。 |
| **コンプライアンス** | 全体的なコンプライアンスの数値は、準拠している個別のリソースの総数をすべての個別のリソースの総数で割った値になります。 |
| **コンプライアンスの状態** | ポリシーまたはイニシアチブの割り当てについてのコンプライアンスの状態に関する情報。|

ポリシーまたはイニシアチブを割り当てる場合、割り当てで選択されたスコープは、一覧表示されているスコープまたはそのサブセットである可能性があります。 たとえば、管理グループ (対象範囲スコープ) ではなく、サブスクリプション (ポリシー スコープ) の割り当てを作成している可能性があります。 この場合、 **[Assignment Coverage]\(割り当て対象範囲\)** の値は、ポリシーまたはイニシアチブ スコープ内の VM 数を対象範囲スコープ内の VM 数で割った値を示します。 あるいは、ご自分がポリシー スコープからいくつかの VM、リソース グループ、またはサブスクリプションを除外している可能性があります。 値が空白の場合は、ポリシーまたはイニシアチブが存在しないか、アクセス許可がないことを示します。 情報は **[割り当ての状態]** の下に表示されます。

## <a name="enable-by-using-azure-policy"></a>Azure Policy を使用して有効にする

テナントで Azure Policy を使用して Azure Monitor for VMs を有効にするには:

- スコープにイニシアチブを割り当てる: 管理グループ、サブスクリプション、またはリソース グループ。
- コンプライアンスの結果をレビューおよび修復する。

続ける前に、Azure Policy の割り当ての詳細について、[Azure Policy の概要](../../governance/policy/overview.md#assignments)および[管理グループの概要](../../governance/management-groups/overview.md)に関する記事をご覧ください。

### <a name="policies-for-azure-vms"></a>Azure VM のポリシー

次の表は、Azure VM のポリシー定義の一覧を示しています。

|名前 |説明 |Type |
|-----|------------|-----|
|Azure Monitor for VMs の有効化 |指定されたスコープ (管理グループ、サブスクリプション、またはリソース グループ) 内の仮想マシン に対して Azure Monitor を有効にします。 Log Analytics ワークスペースをパラメーターとして受け取ります。 |イニシアティブ |
|依存関係エージェントのデプロイの監査 - 一覧にない VM イメージ (OS) |VM イメージ (OS) が一覧で定義されておらず、このエージェントがインストールされていない場合は、VM を非準拠として報告します。 |ポリシー |
|Log Analytics エージェントのデプロイの監査 - 一覧にない VM イメージ (OS) |VM イメージ (OS) が一覧で定義されておらず、このエージェントがインストールされていない場合は、VM を非準拠として報告します。 |ポリシー |
|Linux VM への依存関係エージェントのデプロイ |VM イメージ (OS) が一覧で定義されており、依存関係エージェントがインストールされていない場合は、Linux VM にこのエージェントをデプロイします。 |ポリシー |
|Windows VM への依存関係エージェントのデプロイ |VM イメージ (OS) が一覧で定義されており、依存関係エージェントがインストールされていない場合は、Windows VM にこのエージェントをデプロイします。 |ポリシー |
|Linux VM への Log Analytics エージェントのデプロイ |VM イメージ (OS) が一覧で定義されており、Log Analytics エージェントがインストールされていない場合は、Linux VM にこのエージェントをデプロイします。 |ポリシー |
|Windows VM への Log Analytics エージェントのデプロイ |VM イメージ (OS) が一覧で定義されており、Log Analytics エージェントがインストールされていない場合は、Windows VM にこのエージェントをデプロイします。 |ポリシー |

### <a name="policies-for-azure-virtual-machine-scale-sets"></a>Azure 仮想マシン スケール セットのポリシー

次の表は、Azure 仮想マシン スケール セットのポリシー定義の一覧を示しています。

|名前 |説明 |Type |
|-----|------------|-----|
|仮想マシン スケール セットに対して Azure Monitor を有効にする |指定されたスコープ (管理グループ、サブスクリプション、またはリソース グループ) 内の仮想マシン スケール セットに対して Azure Monitor を有効にします。 Log Analytics ワークスペースをパラメーターとして受け取ります。 注:スケール セットのアップグレード ポリシーが [手動] に設定されている場合は、そのセット内のすべての VM でアップグレードを呼び出して、それらの VM に拡張機能を適用します。 CLI では、これは `az vmss update-instances` です。 |イニシアティブ |
|仮想マシン スケール セットにおける依存関係エージェントのデプロイの監査 - 一覧にない VM イメージ (OS) |VM イメージ (OS) が一覧で定義されておらず、このエージェントがインストールされていない場合は、仮想マシン スケール セットを非準拠として報告します。 |ポリシー |
|仮想マシン スケール セットにおける Log Analytics エージェントのデプロイの監査 - 一覧にない VM イメージ (OS) |VM イメージ (OS) が一覧で定義されておらず、このエージェントがインストールされていない場合は、仮想マシン スケール セットを非準拠として報告します。 |ポリシー |
|Linux 仮想マシン スケール セット用の依存関係エージェントのデプロイ |VM イメージ (OS) が一覧で定義されており、Linux 仮想マシン スケール セット用の依存関係エージェントがインストールされていない場合は、このエージェントをデプロイします。 |ポリシー |
|Windows 仮想マシン スケール セット用の依存関係エージェントのデプロイ |VM イメージ (OS) が一覧で定義されており、Windows 仮想マシン スケール セット用の依存関係エージェントがインストールされていない場合は、このエージェントをデプロイします。 |ポリシー |
|Linux 仮想マシン スケール セット用の Log Analytics エージェントのデプロイ |VM イメージ (OS) が一覧で定義されており、Linux 仮想マシン スケール セット用の Log Analytics エージェントがインストールされていない場合は、このエージェントをデプロイします。 |ポリシー |
|Windows 仮想マシン スケール セット用の Log Analytics エージェントのデプロイ |VM イメージ (OS) が一覧で定義されており、Windows 仮想マシン スケール セット用の Log Analytics エージェントがインストールされていない場合は、このエージェントをデプロイします。 |ポリシー |

ここではスタンドアロン ポリシー (イニシアティブには含まれません) について説明します。

|名前 |説明 |Type |
|-----|------------|-----|
|VM の Log Analytics ワークスペースの監査 - 不一致の報告 |ポリシーまたはイニシアチブの割り当てで指定された Log Analytics ワークスペースに VM がロギングされていない場合は、それらの VM を非準拠として報告します。 |ポリシー |

### <a name="assign-the-azure-monitor-initiative"></a>Azure Monitor のイニシアティブを割り当てる

**[Azure Monitor for VMs Policy Coverage]\(Azure Monitor for VMs のポリシー対象範囲\)** ページからポリシー割り当てを作成するには、次の手順を実行します。 これらの手順を完了する方法については、 [Azure portal でのポリシー割り当ての作成](../../governance/policy/assign-policy-portal.md)に関する記事を参照してください。

ポリシーまたはイニシアチブを割り当てる場合、割り当てで選択されたスコープは、ここに一覧表示されているスコープまたはそのサブセットである可能性があります。 たとえば、管理グループ (対象範囲スコープ) ではなく、サブスクリプション (ポリシー スコープ) の割り当てを作成している可能性があります。 この場合、対象範囲の割合は、ポリシーまたはイニシアチブ スコープ内の VM 数を対象範囲スコープ内の VM 数で割った値を示します。 あるいは、ご自分がポリシー スコープからいくつかの VM、リソース グループ、またはサブスクリプションを除外している可能性があります。 これが空白の場合は、ポリシーまたはイニシアチブが存在しないか、アクセス許可がないことを示します。 情報は **[割り当ての状態]** の下に表示されます。

1. [Azure portal](https://portal.azure.com) にサインインします。

2. Azure portal で、 **[モニター]** を選択します。 

3. **[分析情報]** セクションで、 **[仮想マシン]** を選択します。
 
4. **[Get started]\(使用の開始\)** タブを選択します。このページで、 **[ポリシー対象範囲の管理]** を選択します。

5. 表から管理グループまたはサブスクリプションのいずれかを選択します。 省略記号 (...) を選択して、 **[スコープ]** を選択します。この例では、スコープにより、ポリシーの割り当てが仮想マシンのグループに制限されて実施されます。

6. **[Azure Policy assignment]\(Azure Policy の割り当て\)** ページには、 **[Azure Monitor for VMs の有効化]** イニシアチブが事前に入力されています。 
    **[割り当て名]** ボックスにはイニシアチブ名が自動的に入力されますが、これは変更できます。 必要に応じて、説明を追加することもできます。 **[割り当て担当者]** ボックスは、ログインしたユーザーに基づいて自動的に入力されます。 この値は省略可能です。

7. (省略可能) スコープから 1 つまたは複数のリソースを削除するには、 **[除外]** を選択します。

8. サポートされているリージョンの **[Log Analytics ワークスペース]** ドロップダウン リストで、ワークスペースを選択します。

   > [!NOTE]
   > ワークスペースが割り当てのスコープの範囲外にある場合は、ポリシー割り当てのプリンシパル ID に "*Log Analytics 共同作成者*" アクセス許可を付与します。 これを行わないと、`The client '343de0fe-e724-46b8-b1fb-97090f7054ed' with object id '343de0fe-e724-46b8-b1fb-97090f7054ed' does not have authorization to perform action 'microsoft.operationalinsights/workspaces/read' over scope ...` のようなデプロイ エラーが表示される場合があります。アクセス権を付与するには、[マネージド ID を手動で構成する方法](../../governance/policy/how-to/remediate-resources.md#manually-configure-the-managed-identity)に関する記事をご覧ください。
   > 
   >  割り当てられるイニシアチブには *deployIfNotExists* 効果のあるポリシーが含まれているため、 **[マネージド ID]** チェック ボックスがオンになります。
    
9. **[マネージド ID の場所]** ドロップダウン リストで、適切なリージョンを選択します。

10. **[割り当て]** を選択します。

割り当てを作成すると、 **[Azure Monitor for VMs Policy Coverage]\(Azure Monitor for VMs のポリシー対象範囲\)** ページで、 **[Assignment Coverage]\(割り当て対象範囲\)** 、 **[割り当ての状態]** 、 **[Compliance VMs]\(コンプライアンス VM\)** 、および **[コンプライアンスの状態]** が更新され、変更内容が反映されます。 

次のマトリックスは、イニシアチブに関する可能性のあるコンプライアンスの各状態をマップしています。  

| コンプライアンスの状態 | 説明 | 
|------------------|-------------|
| **[Compliant] (準拠)** | スコープ内のすべての VM に Log Analytics エージェントと依存関係エージェントがデプロイされています。|
| **[Not Compliant] (非準拠)** | スコープ内の一部の VM に Log Analytics エージェントと依存関係エージェントがデプロイされておらず、修復を必要としている可能性があります。|
| **[Not Started]\(未開始\)** | 新しい割り当てが追加されました。 |
| **[Lock] (ロック)** | ユーザーに管理グループに対する十分な特権がありません。<sup>1</sup> | 
| "**空白**" | ポリシーが割り当てられていません。 | 

<sup>1</sup> 管理グループへのアクセス権がない場合、所有者にアクセス権の付与を依頼してください。 または、子管理グループまたはサブスクリプションを介して、コンプライアンスを表示し、割り当てを管理してください。 

次の表は、イニシアチブに関する可能性のある割り当ての各状態をマップしています。

| 割り当ての状態 | 説明 | 
|------------------|-------------|
| **Success** | スコープ内のすべての VM に Log Analytics エージェントと依存関係エージェントがデプロイされています。|
| **警告** | サブスクリプションが管理グループの下にありません。|
| **[Not Started]\(未開始\)** | 新しい割り当てが追加されました。 |
| **[Lock] (ロック)** | ユーザーに管理グループに対する十分な特権がありません。<sup>1</sup> | 
| "**空白**" | VM が存在しないか、またはポリシーが割り当てられていません。 | 
| **操作** | ポリシーを割り当てるか、割り当てを編集します。 | 

<sup>1</sup> 管理グループへのアクセス権がない場合、所有者にアクセス権の付与を依頼してください。 または、子管理グループまたはサブスクリプションを介して、コンプライアンスを表示し、割り当てを管理してください。

## <a name="review-and-remediate-the-compliance-results"></a>コンプライアンスの結果をレビューおよび修復する

次の例は Azure VM の場合ですが、仮想マシン スケール セットにも適用されます。 コンプライアンスの結果をレビューする方法については、[非準拠の結果の特定](../../governance/policy/assign-policy-portal.md#identify-non-compliant-resources)に関する記事をご覧ください。 **[Azure Monitor for VMs Policy Coverage]\(Azure Monitor for VMs のポリシー対象範囲\)** ページで、表から管理グループまたはサブスクリプションのいずれかを選択します。 省略記号 (...) を選択して、 **[コンプライアンスの表示]** を選択します。   

![Azure VM のポリシーへの準拠](./media/vminsights-enable-at-scale-policy/policy-view-compliance.png)

以下のシナリオでは、イニシアチブに含まれるポリシーの結果に基づいて、VM が非準拠として報告されます。

* Log Analytics エージェントも依存関係エージェントデプロイされていない。  
    このシナリオは、既存の VM を含むスコープでよくみられます。 これを緩和するには、非準拠ポリシーで[修復タスクを作成する](../../governance/policy/how-to/remediate-resources.md)ことにより、必要なエージェントをデプロイします。  
    - Linux VM への依存関係エージェントのデプロイ
    - Windows VM への依存関係エージェントのデプロイ
    - Linux VM への Log Analytics エージェントのデプロイ
    - Windows VM への Log Analytics エージェントのデプロイ

* VM イメージ (OS) が、ポリシー定義で識別されない。  
    デプロイ ポリシーの基準には、よく知られている Azure VM イメージからデプロイされた VM のみが含まれます。 VM の OS がサポートされているかどうか、ドキュメントで確認します。 サポートされていない場合は、デプロイ ポリシーを複製し、イメージが準拠するようにそれを更新または変更します。  
    - 依存関係エージェントのデプロイの監査 - 一覧にない VM イメージ (OS)
    - Log Analytics エージェントのデプロイの監査 - 一覧にない VM イメージ (OS)

* VM が、指定された Log Analytics ワークスペースにログインしていない。  
    イニシアティブ スコープ内の一部の VM が、ポリシー割り当てで指定されているもの以外の Log Analytics ワークスペースにログインしている可能性があります。 このポリシーは、非準拠のワークスペースに報告を行っている VM を識別するための手段となります。  
    - VM の Log Analytics ワークスペースの監査 - 不一致の報告

## <a name="edit-an-initiative-assignment"></a>イニシアチブの割り当てを編集する

管理グループまたはサブスクリプションにイニシアチブを割り当てた後は、いつでもそれを編集して、次のプロパティを変更できます。

- 割り当て名
- 説明
- 割り当て担当者
- Log Analytics ワークスペース
- 例外

## <a name="next-steps"></a>次のステップ

これで、仮想マシンに対する監視が有効になったので、この情報を Azure Monitor for VMs での分析に使用できます。 

- 検出されたアプリケーションの依存関係を表示するには、[Azure Monitor for VMs のマップの表示](vminsights-maps.md)に関する記事をご覧くださいい。 

- VM のパフォーマンスでのボトルネックや全体的な使用率を識別するには、[Azure VM のパフォーマンスの表示](vminsights-performance.md)に関する記事をご覧ください。 
