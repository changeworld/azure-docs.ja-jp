---
title: Azure Monitor for Key Vault (プレビュー) でキー コンテナーを監視する | Microsoft Docs
description: この記事では、Azure Monitor for Key Vault について説明します。
services: azure-monitor
ms.topic: conceptual
author: mrbullwinkle
ms.author: mbullwin
ms.date: 04/13/2019
ms.openlocfilehash: 542861afe49d03a179a9740d5a58b9d27e0d7f20
ms.sourcegitcommit: d118ad4fb2b66c759b70d4d8a18e6368760da3ad
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/02/2020
ms.locfileid: "84302494"
---
# <a name="monitoring-your-key-vault-service-with-azure-monitor-for-key-vault-preview"></a>Azure Monitor for Key Vault (プレビュー) によるキー コンテナーの監視
Azure Monitor Key Vault (プレビュー) では、Key Vault の要求、パフォーマンス、エラー、待機時間の統合ビューが用意され、キー コンテナーを包括的に監視できます。
この記事では、Azure Monitor for Key Vault (プレビュー) のエクスペリエンスをオンボードおよびカスタマイズする方法について説明します。

## <a name="introduction-to-azure-monitor-for-key-vault-preview"></a>Azure Monitor for Key Vault (プレビュー) の概要

エクスペリエンスについて見ていく前に、情報が提供および視覚化される方法を理解する必要があります。
-    **大規模な分析観点**: 要求、エラーの内訳、および操作と待機時間の概要に基づいて、パフォーマンスのスナップショット ビューを表示します。
-   **ドリルダウン分析**: 特定のキー コンテナーの詳細な分析を実行します。
-    **カスタマイズ可能**: 表示するメトリックの変更したり、制限に合わせたしきい値の変更または設定、独自のブックとして保存することができます。 ブック内のグラフは、Azure ダッシュボードにピン留めできます。

Azure Monitor for Key Vault では、ログとメトリックの組み合わせによる、グローバルな監視ソリューションが用意されています。 すべてのユーザーがメトリックベースの監視データにアクセスできますが、ログベースの視覚化を含めた場合、ユーザーは [Azure Key Vault のログ記録を有効](https://docs.microsoft.com/azure/key-vault/key-vault-logging)にする必要があります。

## <a name="configuring-your-key-vaults-for-monitoring"></a>監視用のキー コンテナーの構成

> [!NOTE]
> ログの有効化は、追加監視機能を提供する有料サービスです。

1. [操作と待機時間] タブでは、有効になっているキーコンテナーとその数を確認できます。 収集を開始するには、 **[有効にする]** ボタンを選択します。これにより、診断ログを有効にする必要があるキー コンテナーを一覧表示した別のブックが表示されます。

    ![青色の [有効にする] ボタンが表示された [操作と待機時間] タブのスクリーンショット](./media/key-vaults-insights-overview/enable-logging.png)

2. 診断ログを有効にするには、[アクション] 列の下にある **[有効にする]** リンクをクリックし、Log Analytics ワークスペースにログを送信する新しい診断設定を作成します。 すべてのログを同じワークスペースに送信することをお勧めします。

3. 診断設定が保存されると、Key Vault 分析情報の下ですべてのログベースのグラフと視覚化を表示できるようになります。 ログの作成が開始されるまでに数分から数時間かかる場合があることに注意してください。

4. Key Vault サービスの診断ログを有効にする方法の詳細については、[完全なガイド](https://docs.microsoft.com/azure/key-vault/key-vault-logging)をご覧ください。

## <a name="view-from-azure-monitor"></a>Azure Monitor から表示する

Azure Monitor では、ご利用のサブスクリプション内の複数のキー コンテナーの要求、待機時間、エラーの詳細を表示でき、パフォーマンスの問題やスロットリング シナリオを特定するのに役立ちます。

所有するすべてのサブスクリプションのストレージ アカウントの使用状況と操作を確認するには、次の手順を実行します。

1. [Azure Portal](https://portal.azure.com/) にサインインします。

2. Azure portal の左側のウィンドウで **[モニター]** を選択し、[分析情報] セクションの **[キー コンテナー (プレビュー)]** を選択します。

![複数のグラフを伴う概要エクスペリエンスのスクリーンショット](./media/key-vaults-insights-overview/overview.png)

## <a name="overview-workbook"></a>[概要] ブック

選択したサブスクリプションの [概要] ブックでは、サブスクリプション内でグループ化されているキー コンテナーの対話型キー コンテナー メトリックがテーブルに表示されます。 次のドロップダウン リストから選択するオプションに基づいて、結果をフィルター処理できます。

* [サブスクリプション] - ストレージ アカウントを持つサブスクリプションのみが表示されます。

* [キー コンテナー] - 既定では、最大 5 つのキー コンテナーのみが事前に選択されています。 スコープ セレクターですべてまたは複数のキー コンテナーを選択すると、最大 200 個のキー コンテナーが返されます。 たとえば、選択した 3 つのサブスクリプションに全部で 573 個のキー コンテナーがある場合は、200 個のコンテナーのみが表示されます。

* [時間の範囲] - 既定では、選択結果に応じて過去 24 時間の情報が表示されます。

ドロップダウン リストのカウンター タイルには、サブスクリプション内のキー コンテナーの総数がロールアップされ、選択した数が反映されます。 要求、エラー、待機時間のメトリックを報告するブックの列には、条件に基づいて色分けされたヒートマップがあります。 最も濃い色は最大値で、薄い色は最小値に基づいています。

## <a name="failures-workbook"></a>[エラー] ブック

ページの上部にある **[エラー]** を選択すると、[エラー] タブが開きます。 ここには、API ヒット数、時間の経過に伴う頻度のほか、特定の応答コードの量が表示されます。

![[エラー] ブックのスクリーンショット](./media/key-vaults-insights-overview/failures.png)

ブックの列には、条件に基づく色分け (ヒートマップ) が示され、API ヒット数のメトリックは青色の値で報告されます。 最も濃い色は最大値で、薄い色は最小値に基づいています。

ブックには、成功 (2xx 状態コード)、認証エラー (401/403 状態コード)、スロットリング (429 状態コード)、およびその他のエラー (4xx 状態コード) が表示されます。

各ステータス コードが表す意味について理解を深めるには、[Azure Key Vault の状態と応答コード](https://docs.microsoft.com/azure/key-vault/authentication-requests-and-responses)に関するドキュメントを参照することをお勧めします。

## <a name="operations--latency-workbook"></a>[操作と待機時間] ブック

ページの上部にある **[操作と待機時間]** を選択すると、 **[操作と待機時間]** タブが開きます。 このタブでは、監視対象のキー コンテナーをオンボードすることができます。 詳細な手順については、「[監視対象のキー コンテナーの構成](#configuring-your-key-vaults-for-monitoring)」のセクションをご覧ください。

ログ記録の対象として有効になっているキー コンテナーの数を確認できます。 少なくとも 1 つのコンテナーが適切に構成されていれば、各キー コンテナーの操作と状態コードを示したテーブルが表示されます。 行の詳細セクションをクリックすると、個々の操作に関する追加情報が得られます。

![操作と待機時間のグラフのスクリーンショット](./media/key-vaults-insights-overview/logs.png)

このセクションのデータが一切表示されていない場合は、Azure Key Vault のログを有効にする方法に関する上のセクションを参照するか、以下のトラブルシューティングのセクションを確認してください。

## <a name="view-from-a-key-vault-resource"></a>Key Vault リソースからのビュー

キー コンテナーから直接 Azure Monitor for Key Vault にアクセスするには、次の操作を実行します。

1. Azure portal で [キー コンテナー] を選択します。

2. 一覧からキー コンテナーを選択します。 [監視] セクションで [インサイト (プレビュー)] を選択します。

これらのビューには、Azure Monitor レベルのブックからキー コンテナーのリソース名を選択してアクセスすることもできます。

![キー コンテナー リソースからのビューのスクリーンショット](./media/key-vaults-insights-overview/key-vault-resource-view.png)

キー コンテナーの **[概要]** ブックには、複数のパフォーマンス メトリックが表示され、次の情報をすばやく評価するのに役立ちます。

- 対話型のパフォーマンス グラフ。キー コンテナーのトランザクション、待機時間、および可用性に関連する最も重要な詳細情報が示されます。

- メトリック タイルと状態タイル。サービスの可用性、キー コンテナー リソースに対するトランザクションの合計数、および全体の待機時間が明示されます。

**[エラー]** または **[操作]** の他のタブのいずれかを選択すると、それぞれのブックが開きます。

![[エラー] ビューのスクリーンショット](./media/key-vaults-insights-overview/resource-failures.png)

[エラー] ブックでは、選択された期間内のすべてのキー コンテナー要求の結果が分析され、成功 (2xx)、認証エラー (401/403)、スロットリング (429)、およびその他のエラーに分類されます。

![[操作] ビューのスクリーンショット](./media/key-vaults-insights-overview/operations.png)

[操作] ブックでは、ユーザーは、すべてのトランザクションの詳細を詳しく調べることができ、最上位レベルのタイルを使用して結果の状態でフィルター処理できます。

![[操作] ビューのスクリーンショット](./media/key-vaults-insights-overview/info.png)

ユーザーはまた、上部のテーブルで特定のトランザクションの種類に基づいてビューを詳しく調べることもできます。この上部のテーブルに従って下部のテーブルは動的に更新され、ユーザーはこのテーブルのポップアップ コンテキスト ウィンドウで操作の完全な詳細を確認できます。

>[!NOTE]
> このブックを表示するには、診断設定を有効にしている必要があることに注意してください。 診断設定の有効化の詳細については、「[Azure Key Vault のログ記録](https://docs.microsoft.com/azure/key-vault/general/logging)」をご覧ください。

## <a name="pin-and-export"></a>ピン留めとエクスポート

セクションの右上にある画びょうアイコンを選択すると、メトリックのどのセクションでも Azure ダッシュボードにピン留めできます。

複数サブスクリプションおよびキー コンテナーの [概要] または [エラー] ブックでは、画びょうアイコンの左側にあるダウンロード アイコンを選択すると、結果を Excel 形式でエクスポートできます。

![ピン留めアイコンが選択されているスクリーンショット](./media/key-vaults-insights-overview/pin.png)

## <a name="customize-azure-monitor-for-key-vault"></a>Azure Monitor for Key Vault をカスタマイズする

このセクションでは、データ分析のニーズに合わせてブックを編集してカスタマイズする一般的なシナリオについて説明します。
*  特定のサブスクリプションまたはキー コンテナーが常に選択されるようにブックのスコープを設定する
* グリッドでメトリックを変更する
* 要求のしきい値を変更する
* 色の表示を変更する

カスタマイズを開始するには、上部のツールバーの **[カスタマイズ]** ボタンを選択して編集モードを有効にします。

![[カスタマイズ] ボタンのスクリーンショット](./media/key-vaults-insights-overview/customize.png)

カスタマイズはカスタム ブックに保存されるため、発行されたブックで既定の構成が上書きされることはありません。 ブックは、リソース グループ内の、ユーザー個人の [個人用レポート] セクション、またはリソース グループにアクセスできるユーザーであればだれでもアクセスできる [共有レポート] セクションのいずれかに保存されます。 カスタム ブックを保存した後は、ブック ギャラリーに移動して起動する必要があります。

![ブック ギャラリーのスクリーンショット](./media/key-vaults-insights-overview/gallery.png)

### <a name="specifying-a-subscription-or-key-vault"></a>サブスクリプションまたはキー コンテナーの指定

複数サブスクリプションおよびキー コンテナーの [概要] または [エラー] ブックを、実行のたびに特定のサブスクリプションまたはキー コンテナーを対象とするように構成できます。次の手順を行います。

1. ポータルで **[モニター]** を選択し、左側のウィンドウで **[キー コンテナー (プレビュー)]** を選択します。
2. **[概要]** ブックで、コマンド バーから **[編集]** を選択します。
3. **[サブスクリプション]** ドロップダウン リストから、既定として使用するサブスクリプションを 1 つ以上選択します。 1 つのブックで、最大 10 個のサブスクリプションを選択できます。
4. **[キー コンテナー]** ドロップダウン リストから、既定として使用するアカウントを 1 つ以上選択します。 1 つのブックで、最大 200 個のストレージ アカウントを選択できます。
5. コマンド バーから **[名前を付けて保存]** を選択して、カスタマイズしたブックのコピーを保存した後、 **[編集完了]** をクリックして読み取りモードに戻ります。

## <a name="troubleshooting"></a>トラブルシューティング

このセクションは、Azure Monitor for Key Vault (プレビュー) を使用するときに発生する可能性があるいくつかの一般的な問題を診断し、トラブルシューティングするのに役立ちます。 以下のリストを使用して、特定の問題に関連する情報を見つけてください。

### <a name="resolving-performance-issues-or-failures"></a>パフォーマンスの問題またはエラーの解決

Azure Monitor for Key Vault (プレビュー) で発生するキー コンテナー関連の問題のトラブルシューティングについては、[Azure Key Vault のドキュメント](https://docs.microsoft.com/azure/key-vault/)をご覧ください。

### <a name="why-can-i-only-see-200-key-vaults"></a>200 個のキー コンテナーしか表示できないのはなぜですか。

選択して表示できるキー コンテナーには 200 の制限があります。 選択されているサブスクリプションの数には関係なく、選択されるキー コンテナーの数には 200 の制限があります。

### <a name="what-will-happen-when-a-pinned-item-is-clicked"></a>ピン留めされた項目をクリックするとどうなりますか。

ダッシュボードにピン留めされた項目をクリックすると、次の 2 つのいずれかが開きます。
* 分析情報が保存されている場合は、ピンの保存元の分析情報インスタンスが開きます。
* 分析情報が保存されていない場合は、新しい既定の分析情報インスタンスが開きます。

### <a name="why-dont-i-see-all-my-subscriptions-in-the-subscription-picker"></a>サブスクリプション ピッカーに自分のすべてのサブスクリプションが表示されないのはなぜですか。

選択したサブスクリプション フィルターから選択されたキー コンテナーを含むサブスクリプションのみが表示されます。このフィルターは、Azure portal ヘッダーの [ディレクトリ + サブスクリプション] で選択されています。

![サブスクリプション フィルターのスクリーンショット](./media/key-vaults-insights-overview/Subscriptions.png)

### <a name="i-am-getting-an-error-message-that-the-query-exceeds-the-maximum-number-of-workspacesregions-allowed-what-to-do-now"></a>"query exceeds the maximum number of workspaces/regions allowed"\(クエリは、許可されているワークスペース/リージョンの最大数を超えています\) というエラー メッセージが表示されます。

現時点では、25 のリージョンと 200 のワークスペースに制限されており、データを表示するには、サブスクリプションやリソース グループの数を減らす必要があります。

### <a name="i-want-to-make-changes-or-add-additional-visualizations-to-key-vault-insights-how-do-i-do-so"></a>Key Vault 分析情報に変更を加えたり、視覚化を追加したりするには、どうすればよいですか。

変更するには、[編集モード] を選択してブックを変更し、指定したサブスクリプションとリソース グループに関連付けられている新しいブックとして作業内容を保存します。

### <a name="what-is-the-time-grain-once-we-pin-any-part-of-the-workbooks"></a>ブックのある部分をピン留めした後の時間グレインはどれだけですか。

[自動] 時間グレインを使用しているので、選択されている時間範囲によって異なります。

### <a name="what-is-the-time-range-when-any-part-of-the-workbook-is-pinned"></a>ブックのある部分をピン留めしたときの時間範囲はどうなりますか。

時間範囲は、ダッシュボードの設定によって異なります。

### <a name="why-do-i-not-see-any-data-for-my-key-vault-under-the-operations--latency-sections"></a>[操作と待機時間] セクションの下に自分の Key Vault のデータが表示されないのはなぜですか。

ログベースのデータを表示するには、監視するキー コンテナーごとにログを有効にする必要があります。 これは、各キー コンテナーの診断設定で行うことができます。 指定された Log Analytics ワークスペースにデータを送信する必要があります。

### <a name="i-have-already-enabled-logs-for-my-key-vault-why-am-i-still-unable-to-see-my-data-under-operations--latency"></a>Key Vault のログを既に有効にしていますが、[操作と待機時間] の下にデータが表示されないのはなぜですか。

現時点では、診断ログは以前にさかのぼって機能しないので、キー コンテナーに対してアクションが実行された後にのみ、データが表示されるようになります。 そのため、キー コンテナーがどの程度アクティブかに応じて、これには数時間から 1 日かかることがあります。

さらに、多数のキー コンテナーとサブスクリプションを選択している場合は、クエリの制限のためにデータを表示できないことがあります。 データを表示するために、選択したサブスクリプションまたはキー コンテナーの数を減らすことが必要になる場合があります。 

### <a name="what-if-i-want-to-see-other-data-or-make-my-own-visualizations-how-can-i-make-changes-to-the-key-vault-insights"></a>他のデータを表示したり、独自の視覚化を作成したりするにはどうすればよいですか。 Key Vault 分析情報に変更を加えるにはどうすればよいですか。

編集モードを使用して既存のブックを編集し、新しい変更をすべて反映した新しいブックとして作業内容を保存できます。

## <a name="next-steps"></a>次のステップ

ブックがサポートするように設計されているシナリオ、新規レポートの作成方法と既存レポートのカスタマイズ方法などについては、「[Azure Monitor ブックを使用した対話型レポートの作成](https://docs.microsoft.com/azure/azure-monitor/platform/workbooks-overview)」で学習してください。
