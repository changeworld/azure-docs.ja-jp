---
title: "Site Recovery を使用して Azure にレプリケートされた VMware VM と物理サーバーのフェールオーバーとフェールバック | Microsoft Docs"
description: "Azure Site Recovery を使用して、VMware VM と物理サーバーを Azure にフェールオーバーする方法と、オンプレミスにフェールバックする方法について説明します。"
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 02/07/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: f074312ecee39d4b3022df64b51aadd2bb8f968c
ms.sourcegitcommit: 059dae3d8a0e716adc95ad2296843a45745a415d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/09/2018
---
# <a name="fail-over-and-fail-back-vmware-vms-and-physical-servers-replicated-to-azure"></a>Azure にレプリケートされた VMware VM と物理サーバーのフェールオーバーとフェールバック

このチュートリアルでは、VMware VM を Azure にフェールオーバーする方法について説明します。 フェールオーバーした後、オンプレミス サイトが使用可能になったときにオンプレミス サイトにフェールバックします。 このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * VMware VM のプロパティで Azure の要件に準拠していることを確認する
> * Azure へのフェールオーバーを実行する
> * フェールバック用のプロセス サーバーとマスター ターゲット サーバーを作成する
> * Azure VM をオンプレミス サイトで再保護する
> * Azure からオンプレミスにフェールオーバーする
> * オンプレミス VM を再保護して、Azure へのレプリケートを再開する

これはシリーズで 5 番目のチュートリアルです。 このチュートリアルでは、前のチュートリアルで以下のタスクがすでに完了していることを前提としています。

1. [Azure を準備する](tutorial-prepare-azure.md)
2. [オンプレミスの VMware を準備する](tutorial-prepare-on-premises-vmware.md)
3. [ディザスター リカバリーを設定する](tutorial-vmware-to-azure.md)
4. [ディザスター リカバリーのテストを実行する](tutorial-dr-drill-azure.md)

## <a name="preparing-for-failover-and-failback"></a>フェールオーバーとフェールバックを準備する

VM 上にスナップショットがないことを確認します。 再保護中は、オンプレミス VM を無効にします。
これは、レプリケーション中のデータの整合性を確保するのに役立ちます。 再保護が完了した後は、VM を有効にしないでください。 レプリケーション グループを再保護するには、同じマスター ターゲット サーバーを使用します。 異なるマスター ターゲット サーバーを使用してレプリケーション グループを再保護すると、サーバーは共通の時点を提供できません。

フェールオーバーとフェールバックには 4 つの段階があります。

1. **Azure にフェールオーバーする**: オンプレミス サイトのマシンを Azure にフェールオーバーします。
2. **Azure VM を再保護する**: Azure VM がオンプレミスの VMware VM へのレプリケートが開始されるように、Azure VM を再保護します。
3. **オンプレミスにフェールオーバーする**: フェールオーバーを実行して、Azure からフェールバックします。
4. **オンプレミス VM を再保護する**: データがフェールバックされたら、フェールバック先のオンプレミスの VM を再保護します。これにより、オンプレミスの VM は Azure へのレプリケートを開始できるようになります。

## <a name="verify-vm-properties"></a>VM のプロパティを確認する

VM のプロパティで、VM が [Azure の要件](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements)に準拠していることを確認します。

1. **[保護されているアイテム]** で、**[レプリケートされたアイテム]** をクリックし、VM をクリックします。

2. **[レプリケートされたアイテム]** ウィンドウには、VM 情報、正常性状態、および最新の使用可能な復旧ポイントの概要が表示されます。 **[プロパティ]** をクリックすると、詳細が表示されます。

3. **[コンピューティングとネットワーク]** で、Azure 名、リソース グループ、ターゲット サイズ、[可用性セット](../virtual-machines/windows/tutorial-availability-sets.md)、および[管理ディスクの設定](#managed-disk-considerations)を変更できます。

4. ネットワーク設定 (フェールオーバー後に Azure VM が配置されるネットワークやサブネット、割り当てられる IP アドレスなど) を表示および変更できます。

5. **[ディスク]** で、VM のオペレーティング システム ディスクとデータ ディスクに関する情報を確認できます。

## <a name="run-a-failover-to-azure"></a>Azure へのフェールオーバーを実行する

1. **[設定]** > **[レプリケートされたアイテム]** で、[VM] > **[フェールオーバー]** の順にクリックします。

2. **[フェールオーバー]** で、フェールオーバーする**[復旧ポイント]** を選択します。 次のいずれかのオプションを使うことができます。
   - **[最新]** (既定値): 最初に、Site Recovery に送信されるすべてのデータを処理します。 フェールオーバー後に作成された Azure VM は、フェールオーバーがトリガーされた時点で Site Recovery にレプリケートされたすべてのデータを保持しているため、RPO (目標復旧時点) を最も低くすることができます。
   - **[最後に処理があった時点]**: Site Recovery によって処理された最新の復旧ポイントに VM をフェールオーバーします。 このオプションを使用すると、未処理のデータの処理に時間がかからないため、RTO (目標復旧時間) を低くできます。
   - **[最新のアプリ整合性]**: Site Recovery によって処理されたアプリ整合性の最新の復旧ポイントに VM をフェールオーバーします。
   - **カスタム**: 復旧ポイントを指定します。

3. フェールオーバーを開始する前にそのソース仮想マシンをシャットダウンする場合は、**[フェールオーバーを開始する前にマシンをシャットダウンします]** をオンにします。 仮にシャットダウンが失敗したとしても、フェールオーバーは続行されます。 フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。

4. Azure VM に接続する準備が完了したら、フェールオーバー後に接続して確認します。

5. 確認が完了したら、フェールオーバーを**コミット**します。 これにより、利用可能なすべての復旧ポイントが削除されます。

> [!WARNING]
> **進行中のフェールオーバーをキャンセルしないでください**。フェールオーバーが開始される前に VM のレプリケーションが停止します。
> 進行中のフェールオーバーを取り消すと、フェールオーバーは停止しますが、VM は二度とレプリケートされません。

一部のシナリオでは、フェールオーバーが完了するまでに、さらに約 8 ～ 10 分の処理が必要です。 物理サーバー、VMware Linux マシン、DHCP サービスが有効でない VMware VM、storvsc、vmbus、storftt、intelide、atapi などのブート ドライバーを持たない VMware VM 、については、テスト フェールオーバーの時間がさらに長くなる場合もあります。

## <a name="create-a-process-server-in-azure"></a>Azure にプロセス サーバーを作成する

プロセス サーバーは、Azure VM からデータを受け取り、オンプレミス サイトにそのデータを送信します。 プロセス サーバーと保護された VM との間には、待ち時間が短いネットワークが必要です。

- テスト目的の Azure ExpressRoute 接続がある場合は、構成サーバーに自動的にインストールされたオンプレミス プロセス サーバーを使用できます。
- VPN 接続がある場合、または運用環境でフェールバックを実行している場合、フェールバック用に Azure ベースのプロセス サーバーとして Azure VM を設定する必要があります。
- Azure でプロセス サーバーを設定するには、[この記事](site-recovery-vmware-setup-azure-ps-resource-manager.md)の手順を実行してください。

## <a name="configure-the-master-target-server"></a>マスター ターゲット サーバーを構成する

既定で、マスター ターゲット サーバーは、オンプレミスの構成サーバー上で実行されます。 このチュートリアルでは、既定のマスターを使用しています。 マスター ターゲット サーバーは、フェールバック データを受信します。

vCenter サーバーの管理対象の ESXi ホスト上に VM がある場合、マスター ターゲット サーバーは、VM のデータストア (VMDK) へのアクセス権 (レプリケートされたデータを VM ディスクに書き込むアクセス権) を持っている必要があります。 VM データ ストアが、読み取りと書き込みアクセス権のあるマスター ターゲットのホストにマウントされていることを確認します。

vCenter サーバーの管理対象ではない ESXi 上に VM がある場合、再保護時に Site Recovery サービスによって新しい VM が作成されます。 この VM は、マスター ターゲットを作成する ESX ホスト上に作成されます。
VM のハード ディスクは、マスター ターゲット サーバーが実行されているホストからアクセスできるデータストア内に配置されている必要があります。

VM が vCenter を使用していない場合、マシンを再保護する前に、マスター ターゲット サーバーが実行されているホストの検出を完了する必要があります。 これは、物理サーバーをフェールバックする場合も同様です。 オンプレミスに VM がある場合、フェールバックを実行する前に削除するという選択肢もあります。 このようにすると、フェールバックにより、マスター ターゲット ESX ホストと同じホストに新しい VM が作成されます。 別の場所にフェールバックすると、オンプレミスのマスター ターゲット サーバーによって使用されるのと同じデータ ストアおよび同じ ESX ホストにデータは復元されます。

マスター ターゲット サーバー上で Storage vMotion を使用することはできません。 Storage vMotion を使用しても、ディスクを使用できないため、フェールバックは動作しません。 そのため、vMotion の一覧からマスター ターゲット サーバーを除外してください。

## <a name="reprotect-azure-vms"></a>Azure VM を再保護する

この手順は、オンプレミス VM を使用できず、別の場所で再保護するという前提で説明します。

1. **[設定]** > **[レプリケートされたアイテム]** で、フェールオーバーした VM を右クリックし、**[再保護]** をクリックします。
2. **[再保護]** で、**[Azure からオンプレミスへ]** が選択されていることを確認します。
3. オンプレミス マスター ターゲット サーバーとプロセス サーバーを指定します。

4. **[データストア]** で、オンプレミスのディスクの復旧先のデータストアを選択します。 このオプションは、オンプレミスの VM を削除し、新しいディスクを作成する必要がある場合に使用します。 ディスクが既に存在する場合、この設定は無視されますが、値は指定しておく必要があります。
5. マスター ターゲットのリテンション ドライブを選択します。 フェールバック ポリシーは自動的に選択されます。
6. **[OK]** をクリックして再保護を開始します。 仮想マシンを Azure からオンプレミス サイトにレプリケートするジョブが開始されます。 進行状況は **[ジョブ]** タブで追跡できます。

> [!NOTE]
> Azure VM を既存のオンプレミスの VM に復旧する場合、マスター ターゲット サーバーの ESXi ホスト上で、読み取り/書き込みアクセス権のあるオンプレミスの仮想マシンのデータストアをマウントします。


## <a name="run-a-failover-from-azure-to-on-premises"></a>Azure からオンプレミスへのフェールオーバーを実行する

オンプレミスにレプリケートする場合、フェールバック ポリシーが使用されます。 このポリシーは、Azure へのレプリケーションのためにレプリケーション ポリシーを作成するときに、自動的に作成されます。

- このポリシーは自動的に構成サーバーに関連付けられます。
- このポリシーは変更できません。
- ポリシーの値は次のとおりです。
    - RPO しきい値 = 15 分
    - 復旧ポイントのリテンション期間 = 24 時間
    - アプリケーション整合性スナップショットの頻度 = 60 分

次のようにフェールオーバーを実行します。

1. **[レプリケートされたアイテム]** ページでマシンを右クリックし、**[計画されていないフェールオーバー]** をクリックします。
2. **[フェールオーバーの確認]** で、フェールオーバーの方向が Azure からであることを確認します。

3. フェールオーバーに使用する復旧ポイントを選択します。 アプリケーションと整合性が取れた最新の復旧ポイントは最新のポイントインタイムの前に発生するため、多少のデータ損失が発生します。 フェールオーバーが実行されると、Site Recovery は Azure VM をシャットダウンし、オンプレミスの VM を起動します。 ある程度のダウンタイムが発生するため、適切な時刻に実行してください。
4. マシンを右クリックし、**[コミット]** をクリックします。 Azure VM を削除するジョブがトリガーされます。
5. 予想どおりに Azure VM がシャットダウンされたことを確認します。


## <a name="reprotect-on-premises-machines-to-azure"></a>オンプレミスのマシンを Azure で再保護する

データはオンプレミス サイトに戻りましたが、Azure へのレプリケートは実行されていません。 Azure へのレプリケートを再開するには、次の手順を実行します。

1. コンテナーで **[設定]** >**[レプリケートされたアイテム]** の順にクリックして、フェールバックされた VM を選択し、**[再保護]** をクリックします。
2. レプリケートされたデータを Azure に送信するために使用するプロセス サーバーを選択し、**[OK]** をクリックします。

再保護が完了すると、VM が Azure にレプリケートされるので、必要に応じてフェールオーバーを実行できます。
