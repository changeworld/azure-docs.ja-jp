<properties
	pageTitle="Site Recovery のしくみ | Microsoft Azure"
	description="この記事では、Site Recovery アーキテクチャの概要を説明します"
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="12/07/2015"
	ms.author="raynew"/>

# Azure Site Recovery のしくみ

## この記事の内容

この記事では、Site Recovery の基になるアーキテクチャと、それを機能させるためのコンポーネントについて説明します。この記事について質問がある場合は、[Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)に投稿してください。


## 概要

組織には、予定されたダウンタイムおよび予定外のダウンタイム時にアプリケーション、ワークロード、およびデータを利用可能な状態に維持し、できるだけ早く通常の動作状態に復旧させる方法を決定するビジネス継続性および障害復旧 (BCDR) の戦略が必要です。BCDR 戦略の大部分では、災害発生時にビジネス データを安全かつ回復可能な状態に維持し、ワークロードを継続的に利用可能な状態に保つためのソリューションが中心的な役割を果たします。

Site Recovery とは、クラウド (Azure) またはセカンダリ データセンターへのオンプレミスの物理サーバーおよび仮想マシンのレプリケーションを統制することで BCDR 戦略を支援する Azure サービスです。プライマリの場所で障害が発生した場合は、セカンダリ サイトにフェールオーバーしてアプリとワークロードの可用性を維持します。プライマリの場所が通常の動作に戻ると、その場所にフェールバックします。

Site Recovery は、さまざまなシナリオで使用され、数多くのワークロードを保護することができます。

- **VMware 仮想マシンを保護する**: オンプレミスの VMware 仮想マシンは、Azure またはセカンダリ データセンターにレプリケートすることで保護することができます。- **Hyper-V VM を保護する**: オンプレミスの Hyper-V 仮想マシンは、クラウド (Azure) またはセカンダリ データセンターにレプリケートすることで保護することができます。  
- **物理サーバーを保護する**: Windows または Linux を実行している物理マシンは、Azure またはセカンダリ データセンターにレプリケートすることで保護することができます。
- **VM の移行**: Site Recovery を使用すると、Azure IaaS VM をリージョン間で移行したり、AWS Windows インスタンスを Azure IaaS VM に移行したりできます。

サポートされているデプロイメントの全体の概要については、「[Azure Site Recovery とは?](site-recovery-overview.md)」 と 「[Azure Site Recovery で保護できるワークロード](site-recovery-workload.md)」を参照してください。

## オンプレミスの物理サーバーまたは VMware 仮想マシンと Azure との間でのレプリケーション

VMware 仮想マシンまたは Windows/Linux 物理マシンのいずれかを Azure にレプリケートすることで保護するには、何が必要かを以下に示します。

**場所** | **必要なもの** 
--- | --- 
 オンプレミスの  
 | **プロセス サーバー**: このサーバーでは、保護対象の VMware 仮想マシンまたは Windows/Linux 物理マシンからのデータを、Azure に送信する前に最適化します。また、保護されたマシンへのモビリティ サービス コンポーネントのプッシュ インストールを処理し、VMware 仮想マシンの自動検出を実行します。<br/><br/> **VMware vCenter サーバー**: VMware 仮想マシンを保護する場合は、vSphere ハイパーバイザーを管理する VMwave vCenter サーバーが必要です。<br/><br/> **ESX サーバー**: VMware 仮想マシンを保護する場合は、最新の更新プログラムが適用された ESX/ESXi バージョン 5.1 または 5.5 を実行するサーバーが必要です。<br/><br/> **マシン**: VMware を保護する場合は、VMware ツールがインストールされ実行されている VMware 仮想マシンが必要です。物理マシンを保護する場合は、サポートされている Windows または Linux オペレーティング システムがそこで実行されている必要があります。[サポートされているオペレーティング システム](site-recovery-vmware-to-azure.md/#before-you-start)を参照してください。<br/><br/> **モビリティ サービス**: 変更をキャプチャしてプロセス サーバーに送信するために、保護するマシン上にインストールします。<br/><br/>サード パーティ コンポーネント: このデプロイメントは、いくつかの[サード パーティ コンポーネント](http://download.microsoft.com/download/C/D/7/CD79E327-BF5A-4026-8FF4-9EB990F9CEE2/Third-Party_Notices.txt)に依存します。
Azure | **構成サーバー**: 保護対象のマシン、プロセス サーバー、および Azure のマスター ターゲット サーバーの間でのやり取りを調整する Standard A3 Azure VM です。レプリケーションをセットアップし、フェールオーバーが発生した場合に復旧を調整します。<br/><br/>**マスター ターゲット サーバー**: Azure ストレージ アカウントの Blob Storage に作成された接続済みの VHD を使用して、保護対象のマシンからレプリケートされたデータを保持する Azure VM です。Azure VM を VMware VM にフェールバックすることができるように、フェールバック マスター ターゲット サーバーはオンプレミスで実行されます。<br/><br/> **Site Recovery コンテナー**: 少なくとも 1 つの Azure Site Recovery コンテナー (Site Recovery サービスへのサブスクリプションでセットアップ)<br/><br/> **仮想ネットワーク**: Site Recovery サービスと同じサブスクリプションおよびリージョンに属し、構成サーバーとマスター ターゲット サーバーが置かれている Azure ネットワーク。<br/><br/> **Azure Storage**: レプリケートしたデータを格納する Azure ストレージ アカウント。Site Recovery サブスクリプションと同じリージョンの geo 冗長標準アカウントまたは Premium アカウントである必要があります。


このシナリオでは、Azure ネットワーク上の内部ポートとの通信が VPN 接続を介して発生 (Azure ExpressRoute またはサイト間 VPN を使用)、または構成およびマスター ターゲット サーバー VM に対する、Azure クラウド サービス上のマップされたパブリック エンドポイントとの通信がセキュリティで保護されたインターネット接続を介して発生します。

保護対象マシン上のモビリティ サービスは、プロセス サーバーにレプリケーション データを送信し、レプリケーション メタデータを構成サーバーに送信します。プロセス サーバーは、管理および制御情報を構成サーバーとやり取りします。レプリケーション情報がマスター ターゲット サーバーに送信され、レプリケートされたデータが最適化され、マスター ターゲット サーバーに送信されます。

## Hyper-V VM を Azure にレプリケートする (VMM を使用)

ご使用の VM が System Center VMM クラウドで管理されている Hyper-V ホストにある場合、そのような VM を Azure にレプリケートする上で必要なものを以下に示します。

**場所** | **必要なもの** 
--- | --- 
オンプレミスの  
 | **VMM サーバー**: 少なくとも 1 つの VMM プライベート クラウドでセットアップされた少なくとも 1 つの VMM サーバー。Azure Site Recovery プロバイダーは各 VMM サーバーにインストールされます。<br/><br/>**Hyper-V サーバー**: VMM クラウド内に配置された少なくとも 1 つの Hyper-V ホスト サーバー。Microsoft Recovery Services エージェントは各 Hyper-V サーバーにインストールされます。<br/><br/> **仮想マシン**: Hyper-V サーバー上で実行されている少なくとも 1 つの仮想マシン。仮想マシンには何もインストールされません。
Azure | **Site Recovery コンテナー**: 少なくとも 1 つの Azure Site Recovery コンテナー (Site Recovery サービスへのサブスクリプションでセットアップ) <br/><br/>**ストレージ アカウント**: Site Recovery サービスと同じサブスクリプションに基づいている Azure ストレージ アカウント。レプリケートされたデータは Azure Storage に格納されます。 

このシナリオでは、VMM サーバー上で実行されているプロバイダーが Site Recovery サービスを使用してインターネット経由でレプリケーションを調整および統制します。オンプレミスの Hyper-V サーバーで実行されている Recovery Services エージェントと Azure Storage との間で HTTPS 443 を介してデータがレプリケートされます。プロバイダーとエージェントの両方からの通信は、セキュリティで保護され、暗号化されます。Azure Storage 内のレプリケートされたデータも暗号化されます。

![オンプレミス VMM と Azure 間](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png)

## Hyper-V VM を Azure にレプリケートする (VMM なし)

ご使用の VM が System Center VMM サーバーによって管理されていない場合、それらを Azure にレプリケートするのに必要なものを以下に示します。

**場所** | **必要なもの**
--- | --- 
 オンプレミスの  
 | **Hyper-V サーバー**: 少なくとも 1 つの Hyper-V ホスト サーバー。Azure Site Recovery プロバイダーと Microsoft Recovery Services エージェントが各 Hyper-V サーバーにインストールされます。<br/><br/>**仮想マシン**: Hyper-V サーバー上で実行されている少なくとも 1 つの仮想マシン。仮想マシンには何もインストールされません。
Azure | **Site Recovery コンテナー**: 少なくとも 1 つの Azure Site Recovery コンテナー (Site Recovery サービスへのサブスクリプションでセットアップ) <br/><br/>**ストレージ アカウント**: Site Recovery サービスと同じサブスクリプションに基づいている Azure ストレージ アカウント。レプリケートされたデータは Azure Storage に格納されます。

このシナリオでは、Hyper-V サーバーで実行されているプロバイダーがインターネットを介し Site Recovery サービスを使用してレプリケーションを調整および統制します。オンプレミスの Hyper-V サーバーで実行されている Recovery Services エージェントと Azure Storage との間で HTTPS 443 を介してデータがレプリケートされます。プロバイダーとエージェントの両方からの通信は、セキュリティで保護され、暗号化されます。Azure Storage 内のレプリケートされたデータも暗号化されます。

![オンプレミス VMM と Azure 間](./media/site-recovery-components/arch-onprem-azure-hypervsite.png)



## Hyper-V VM をセカンダリ データセンターにレプリケートする

Hyper-V VM を保護するためにセカンダリ データセンターにレプリケートする場合に必要なものを以下に示します。このレプリケーションを実行できるのは、Hyper-V ホスト サーバーが System Center VMM クラウドで管理されている場合に限られます。

**場所** | **必要なもの** 
--- | --- 
 オンプレミスの  
 | **VMM サーバー**: プライマリ サイトの VMM サーバーとセカンダリ サイトの VMM サーバー。Azure Site Recovery Provider は各 VMM サーバーにインストールされます。<br/><br/>**Hyper-V サーバー**: プライマリサイトおよびセカンダリ サイトの VMM クラウド内に配置された少なくとも 1 つの Hyper-V ホスト サーバー。Hyper-V サーバーには何もインストールされません。<br/><br/> **仮想マシン**: Hyper-V サーバー上で実行されている少なくとも 1 つの仮想マシン。仮想マシンには何もインストールされません。
Azure | **Site Recovery コンテナー**: 少なくとも 1 つの Azure Site Recovery コンテナー (Site Recovery サービスへのサブスクリプションでセットアップ)。 

このシナリオでは、VMM サーバー上のプロバイダーが Site Recovery サービスを使用してインターネット経由でレプリケーションを調整および統制します。　オンプレミスの Hyper-V ホスト サーバーとセカンダリ Hyper-V ホスト サーバーとの間で Kerberos または証明書認証を使用してインターネット経由で、データがレプリケートされます。プロバイダーからの通信と Hyper-V ホスト サーバー間の通信は、セキュリティで保護され、暗号化されます。

![オンプレミス間](./media/site-recovery-components/arch-onprem-onprem.png)

## SAN を使用して Hyper-V VM をセカンダリ データセンターにレプリケートする

ご使用の VM が System Center VMM クラウドで管理されている Hyper-V ホストにあり、SAN ストレージが使用されている場合、2 つのデータセンター間でレプリケートするのに必要なものを以下に示します。

**場所** | **必要なもの** 
--- | --- 
 プライマリ データセンター | **SAN アレイ**: プライマリ VMM サーバーで管理されている[サポートされた SAN アレイ](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx)。SAN は、セカンダリ サイト内の別の SAN アレイとネットワーク インフラストラクチャを共有します。<br/><br/> **VMM サーバー**: 1 つ以上の VMM クラウドとレプリケーション グループがセットアップされた少なくとも 1 つの VMM サーバー。Azure Site Recovery プロバイダーは各 VMM サーバーにインストールされます<br/><br/> **Hyper-V サーバー**: レプリケーション グループに属し、仮想マシンを備えた少なくとも 1 つのHyper-V ホスト サーバー。Hyper-V ホスト サーバーには何もインストールされません。<br/><br/> **仮想マシン**: Hyper-V ホスト サーバー上で実行されている少なくとも 1 つの仮想マシン。仮想マシンには何もインストールされません。 
セカンダリ データセンター | **SAN アレイ**: セカンダリ VMM サーバーで管理された[サポートされている SAN アレイ](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx)。<br/><br/>**VMM サーバー**: 1 つ以上の VMM クラウドを備えた少なくとも 1 つの VMM サーバー。<br/><br/> **Hyper-V サーバー**: 少なくとも 1 つの Hyper-V ホスト サーバー。 
Azure | **Site Recovery コンテナー**: 少なくとも 1 つの Azure Site Recovery コンテナー (Site Recovery サービスへのサブスクリプションでセットアップ)。

このシナリオでは、VMM サーバー上のプロバイダーが Site Recovery サービスを使用してインターネット経由でレプリケーションを調整および統制します。　プライマリ ストレージ アレイとセカンダリ ストレージ アレイとの間で同期 SAN レプリケーションによって、データがレプリケートされます。

![オンプレミス間](./media/site-recovery-components/arch-onprem-onprem-san.png)



## Hyper-V 保護のライフ サイクル

次のワークフローでは、Hyper-V 仮想マシンを保護、レプリケート、およびフェールオーバーするプロセスを示します。

1. **保護の有効化**: Site Recovery コンテナーをセットアップし、VMM クラウドまたは Hyper-V サイトのレプリケーション設定を構成し、VM の保護を有効にします。**保護の有効化**と呼ばれるジョブは、開始されると、**[ジョブ]** タブで監視することができます。このジョブはまずマシンが前提条件を満たしていることを確認します。次に、構成された設定を使用して Azure へのレプリケーションをセットアップする [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx) メソッドを呼び出します。**保護の有効化**ジョブはまた、[StartReplication](https://msdn.microsoft.com/library/hh850303.aspx) メソッドを呼び出して、完全な VM レプリケーションを初期化します。
2. **初期レプリケーション**: 仮想マシンのスナップショットが取得され、仮想ハード ディスクが、Azure またはセカンダリ データセンターにすべてコピーされるまで、1 つずつレプリケートされます。この所要時間は、サイズおよびネットワーク帯域幅と、選択した初期レプリケーション方法によって異なります。初期レプリケーションの進行中にディスクの変更が発生した場合、Hyper-V レプリカ レプリケーション トラッカーは、Hyper-V レプリケーション ログ (.hrl) を該当するディスクと同じフォルダーに配置して、それらの変更を追跡します。各ディスクには関連付けられた .hrl ファイルが存在し、これらはセカンダリ ストレージに送信されます。初期レプリケーションの進行中は、スナップショットおよびログ ファイルによってディスク リソースが消費されるので注意してください。初期レプリケーションが終了すると、VM のスナップショットは削除され、ログ内の差分ディスク変更が同期およびマージされます。
3. **保護の最終処理**: 初期レプリケーションが終了すると、**保護の最終処理**ジョブによってネットワークおよびその他のレプリケーション後の設定が構成され、仮想マシンが保護されます。Azure にレプリケートする場合は、仮想マシンの設定を微調整して、いつでもフェールオーバーできるようにしておくことが必要なことがあります。この時点で、テスト フェールオーバーを実行して、すべてが想定通りに動作しているか確認できます。
4. **レプリケーション**: 初期レプリケーション後は、レプリケーションの設定および方法に従って差分の同期が実行されます。 
	- **レプリケーションの失敗**: 差分レプリケーションに失敗した場合、完全なレプリケーションが帯域幅または時間の観点からコスト高になるときは、再同期が実行されます。たとえば、.hrl ファイルがディスク サイズの 50% に達した場合、仮想マシンには再同期のマークが付けられます。再同期では、ソースとターゲットの仮想マシンのチェックサムを計算して差分のみを送信することで、送信されるデータの量が最小限に抑えられます。再同期が完了すると、差分レプリケーションが再開されます。既定では再同期は業務時間外に自動的に実行するようにスケジュールされますが、手動で仮想マシンを再同期することもできます。
	- **レプリケーション エラー**: レプリケーション エラーが発生した場合に備えて、組み込み再試行があります。認証または承認エラーなど回復できないエラーである場合、またはレプリカ マシンが無効な状態にある場合、再試行は行われません。ネットワーク エラーなどの回復可能なエラーの場合、またはディスクの空き領域またはメモリが少ない場合は、再試行が実行されます。回数を重ねるごとに再試行間隔は長くなります (1、2、4、8、10 分と長くなり、その後は 30 分ごとに行われる)。
4. **予定されたフェールオーバーまたは予定外のフェールオーバー**: 必要に応じて、予定されたフェールオーバーまたは予定外のフェールオーバーを実行します。予定されたフェールオーバーを実行する場合、データが決して失われないように、ソース側の VM はシャット ダウンされます。レプリカ VM は、作成後、コミット保留中の状態になります。SAN を使用してレプリケートする場合 (自動的にコミットされる) を除き、レプリカ VM をコミットしてフェールオーバーを完了させる必要があります。プライマリ サイトが起動され稼働状態になると、フェールバックが実行される可能性があります。Azure にレプリケートした場合、レプリケーションの反転は自動的に行われます。それ以外の場合は、レプリケーションの反転を開始してください。
 

![ワークフロー](./media/site-recovery-components/arch-hyperv-azure-workflow.png)

## VMware 仮想マシンと物理サーバーを Azure にレプリケートする

VMware 仮想マシンと物理サーバー (Windows または Linux) は、VPN サイト間接続またはインターネット経由で Azure にレプリケートすることができます。

### VPN サイト間接続 (または ExpressRoute) 経由でレプリケートする

![VMware または物理コンピューターと Azure 間 (インターネット経由)](./media/site-recovery-components/arch-onprem-azure-vmware-vpn.png)

#### インターネット経由でレプリケートする

![VMware または物理コンピューターと Azure 間 (インターネット経由)](./media/site-recovery-components/arch-onprem-azure-vmware-internet.png)

## プライマリにあるオンプレミスの物理サーバーまたは VMware 仮想マシンと、セカンダリ データセンターとの間でレプリケートする

VMware 仮想マシンまたは Windows/Linux 物理マシンのいずれかを、2 つのオンプレミスのデータセンター間でレプリケートして保護するには、何が必要かを以下に示します。

**場所** | **必要なもの** 
--- | --- 
 オンプレミスのプライマリ | **プロセス サーバー**: キャッシュ、圧縮、およびデータの最適化を処理できるように、プライマリ サイトでプロセス サーバーのコンポーネントをセットアップします。プロセス サーバーでは、保護するマシンへの統合エージェントのプッシュ インストールも処理します。<br/><br/> **VMware 保護**: VMware VM を保護する場合は、複数のハイパーバイザーを管理する VMware EXS/ESXi ハイパーバイザーまたは VMware vCenter サーバーが必要になります。<br/><br/> **物理サーバーの保護**: 物理マシンを保護する場合は、そのマシンが Windows または Linux を実行している必要があります。<br/><br/> **統合エージェント**: 保護するマシンと、マスター ターゲット サーバーとして動作するマシンにインストールします。すべての InMage コンポーネント間の通信プロバイダーとして機能します。
オンプレミスのセカンダリ | **構成サーバー**: 構成サーバーは最初にインストールするコンポーネントです。管理 Web サイトまたは vContinuum コンソールのどちらかを使用してデプロイメントを管理、構成、および監視できるようにセカンダリ サイトにインストールします。構成サーバーには、統合エージェントをリモート デプロイするためのプッシュ メカニズムも含まれています。構成サーバーはデプロイメントに 1 つだけ存在します。構成サーバーは Windows Server 2012 R2 を実行しているマシンにインストールする必要があります。<br/><br/> **vContinuum サーバー**: 構成サーバーと同じ場所 (セカンダリ サイト) にインストールします。保護対象の環境を管理および監視するためのコンソールを提供します。既定のインストールでは、vContinuum サーバーは最初のマスター ターゲット サーバーであり、統合エージェントがインストールされます。<br/><br/> **マスター ターゲット サーバー**: マスター ターゲット サーバーは、レプリケートされたデータを保持します。プロセス サーバーからデータを受信して、セカンダリ サイトにレプリカ マシンを作成し、データの保有期間ポイントを保持します。必要のあるマスター ターゲット サーバーの数は、保護するマシンの数によって異なります。プライマリ サイトにフェールバックする場合は、そこにもマスター ターゲット サーバーが必要です。 
Azure | **Site Recovery コンテナー**: 少なくとも 1 つの Azure Site Recovery コンテナー (Site Recovery サービスへのサブスクリプションでセットアップ)。コンテナーを作成した後でデプロイメントをセットアップする InMage Scout をダウンロードします。また、すべての InMage コンポーネント サーバーに対して最新の更新プログラムをインストールします。


このシナリオでは、保護対象のマシン上で実行されている統合エージェントからプロセス サーバーに差分レプリケーション変更が送信されます。プロセス サーバーは、このデータを最適化し、セカンダリ サイト上のマスター ターゲット サーバーに転送します。構成サーバーでは、レプリケーション プロセスを管理します。




## 次のステップ

[デプロイの準備をする](site-recovery-best-practices.md)。

<!---HONumber=AcomDC_1210_2015-->