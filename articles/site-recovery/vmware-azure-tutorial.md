---
title: Azure Site Recovery を使用して Azure への VMware VM のディザスター リカバリーを設定する
description: Azure Site Recovery を使用して Azure にオンプレミス VMware VM のディザスター リカバリーを設定する方法について説明します。
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 11/12/2019
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 37fdd42adf66ebcb11b357ece6ea63384630d9f4
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/25/2019
ms.locfileid: "75458938"
---
# <a name="set-up-disaster-recovery-to-azure-for-on-premises-vmware-vms"></a>Azure にオンプレミス VMware VM のディザスター リカバリーを設定する

この記事では、[Azure Site Recovery](site-recovery-overview.md) サービスを使用した Azure へのディザスター リカバリーのためにオンプレミスの VMware VM のレプリケーションを有効にする方法について説明します。

これは、オンプレミスの VMware VM を対象に Azure へのディザスター リカバリーを設定する方法について説明するシリーズの 3 番目のチュートリアルです。 前のチュートリアルでは、Azure へのディザスター リカバリー用に[オンプレミスの VMware 環境を準備](vmware-azure-tutorial-prepare-on-premises.md)しました。


このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * ソース レプリケーション設定およびオンプレミスの Site Recovery 構成サーバーを設定する。
> * レプリケーション ターゲット設定を設定する。
> * レプリケーション ポリシーを作成します。
> * VMware VM のレプリケーションを有効にする。

> [!NOTE]
> チュートリアルでは、シナリオの最も簡単なデプロイ パスを示します。 可能であれば既定のオプションを使い、すべての可能な設定とパスを示してはいません。 詳細な手順については、Site Recovery の目次のハウツー セクションにある記事を参照してください。

## <a name="before-you-start"></a>開始する前に

前のチュートリアルを完了します。
1. Azure へのオンプレミスの VMware ディザスター リカバリー用に [Azure を設定](tutorial-prepare-azure.md)していることを確認します。
2. [これらの手順](vmware-azure-tutorial-prepare-on-premises.md)に従って、Azure へのディザスター リカバリー用にオンプレミスの VMware デプロイを準備します。
3. このチュートリアルでは、1 つの VM をレプリケートする方法を示します。 複数の VMware VM をデプロイしている場合は、[Deployment Planner ツール](https://aka.ms/asr-deployment-planner)を使用する必要があります。 [こちら](site-recovery-deployment-planner.md) を参照してください。
4. このチュートリアルでは、異なるやり方で実行できるいくつかの方法を使用します。
    - このチュートリアルでは、OVA テンプレートを使用して、構成サーバー VMware VM を作成します。 何かの理由でこれを行うことができない場合は、[こちらの説明](physical-manage-configuration-server.md)に従って、構成サーバーを手動で設定してください。
    - このチュートリアルでは、Site Recovery によって自動的に MySQL がダウンロードされ、構成サーバーにインストールされます。 必要に応じて、代わりに手動で設定することもできます。 [詳細については、こちらを参照してください](vmware-azure-deploy-configuration-server.md#configure-settings)。




## <a name="select-a-protection-goal"></a>保護の目標を選択する

1. **[Recovery Services コンテナー]** で、コンテナー名を選択します。 このシナリオでは、**ContosoVMVault** を使います。
2. **[作業の開始]** で、[Site Recovery] を選択します。 次に、 **[インフラストラクチャの準備]** を選択します。
3. **[保護の目標]**  >  **[マシンのある場所]** で、 **[オンプレミス]** を選びます。
4. **[マシンをどこにレプリケートしますか]** で、 **[To Azure]\(Azure\)** を選びます。
5. **[マシンは仮想化されていますか]** で、 **[はい (VMware vSphere ハイパーバイザー の場合)]** を選びます。 **[OK]** をクリックします。



## <a name="set-up-the-source-environment"></a>ソース環境をセットアップする

ソース環境では、これらのオンプレミスの Site Recovery コンポーネントをホストするために、オンプレミスの高可用性マシンが 1 台必要です。

- **構成サーバー**: 構成サーバーは、オンプレミスと Azure の間の通信を調整し、データのレプリケーションを管理します。
- **プロセス サーバー**:プロセス サーバーはレプリケーション ゲートウェイとして機能します。 レプリケーション データを受信し、それをキャッシュ、圧縮、暗号化によって最適化して、Azure のキャッシュ ストレージ アカウントに送信します。 また、プロセス サーバーでは、レプリケートする VM へのモビリティ サービス エージェントのインストールや、オンプレミスの VMware VM の自動検出も行います。
- **マスター ターゲット サーバー**:マスター ターゲット サーバーは、Azure からのフェールバック中にレプリケーション データを処理します。


これらのコンポーネントは、"*構成サーバー*" と呼ばれる単一のオンプレミス マシンにすべて一緒にインストールされます。 VMware のディザスター リカバリーの場合、既定では、構成サーバーを高可用性 VMware VM として設定します。 そのためには、用意されている Open Virtualization Application (OVA) テンプレートをダウンロードし、そのテンプレートを VMware にインポートして VM を作成します。 

- 構成サーバーの最新バージョンはポータルで入手できます。 [Microsoft ダウンロード センター](https://aka.ms/asrconfigurationserver)から直接ダウンロードすることもできます。
- 何かの理由で OVA テンプレートを使用して VM を設定できない場合は、[こちらの説明](physical-manage-configuration-server.md)に従って、構成サーバーを手動で設定してください。
- OVF テンプレートに付属するライセンスは、180 日間有効な評価版ライセンスです。 VM 上で実行される Windows を、必要なライセンスでアクティブ化する必要があります。 


### <a name="download-the-vm-template"></a>VM テンプレートをダウンロードする

1. コンテナーで、 **[インフラストラクチャの準備]**  >  **[ソース]** の順に移動します。
2. **[ソースの準備]** で **[+ 構成サーバー]** を選びます。
3. **[サーバーの追加]** で、 **[サーバーの種類]** に **[VMware の構成サーバー]** が表示されていることを確認します。
4. 構成サーバー用の OVF テンプレートをダウンロードします。



## <a name="import-the-template-in-vmware"></a>VMware にテンプレートをインポートする


1. VMWare vSphere Client を使用して、VMware vCenter サーバーまたは vSphere ESXi ホストにサインインします。
2. **[File]\(ファイル\)** メニューの **[Deploy OVF Template]\(OVF テンプレートのデプロイ\)** を選択し、 **[Deploy OVF Template]\(OVF テンプレートのデプロイ\)** ウィザードを起動します。 

     ![OVF テンプレート](./media/vmware-azure-tutorial/vcenter-wizard.png)

3. **[Select source]\(ソースの選択\)** で、ダウンロードした OVF の場所を入力します。
4. **[Review details]\(詳細の確認\)** で、 **[Next]\(次へ\)** を選択します。
5. **[Select name and folder]\(名前とフォルダーの選択\)** および **[Select configuration]\(構成の選択\)** は、既定の設定のままにします。
6. **[Select storage]\(ストレージの選択\)** で、パフォーマンスを最大にするために、 **[Select virtual disk format]\(仮想ディスクの形式の選択\)** の **[Thick Provision Eager Zeroed]\(シック プロビジョニング Eager Zeroed\)** を選びます。
7. ウィザードの残りのページでは、既定の設定をそのまま使います。
8. **[Ready to complete]\(完了の準備完了\)** で、既定の設定で VM をセットアップするには、 **[Power on after deployment]\(デプロイ後に電源をオンにする\)**  >  **[Finish]\(完了\)** の順に選択します。

   > [!TIP]
   > 別の NIC を追加する場合は、 **[Power on after deployment]\(デプロイ後に電源をオンにする\)** をオフにする >  **[Finish]\(完了\)** を選択する、と操作します。 既定では、テンプレートには NIC が 1 つ含まれています。 デプロイ後にさらに NIC を追加することができます。

## <a name="add-an-additional-adapter"></a>さらにアダプターを追加する

構成サーバーにさらに NIC を追加する場合は、サーバーをコンテナーに登録する前に追加します。 登録後のアダプターの追加はサポートされていません。

1. vSphere Client インベントリで VM を右クリックし、 **[Edit Settings]\(設定の編集\)** を選びます。
2. **[Hardware]\(ハードウェア\)** で、 **[Add]\(追加\)**  >  **[Ethernet Adapter]\(イーサネット アダプター\)** の順に選択します。 **[次へ]** を選択します。
3. アダプターの種類およびネットワークを選びます。 
4. VM がオンになったときに仮想 NIC を接続するには、 **[Connect at power on]\(電源をオンにしたときに接続する\)** をオンにします。 **[次へ]**  >  **[完了]** の順に選択します。 **[OK]** をクリックします。


## <a name="register-the-configuration-server"></a>構成サーバーを登録する 

構成サーバーを設定した後、それをコンテナーに登録します。

1. VMWare vSphere Client のコンソールで、VM をオンにします。
2. VM が Windows Server 2016 のインストール エクスペリエンスで起動します。 使用許諾契約書に同意し、管理者パスワードを入力します。
3. インストールの完了後に、管理者として VM にサインインします。
4. 初めてサインインすると、数秒後に Azure Site Recovery 構成ツールが起動します。
5. 構成サーバーを Site Recovery に登録するために使う名前を入力します。 **[次へ]** を選択します。
6. このツールは、VM が Azure に接続できることを確認します。 接続が確立された後、 **[サインイン]** を選択して、自分の Azure サブスクリプションにサインインします。 この資格情報は、構成サーバーを登録するコンテナーにアクセスできる必要があります。 必要な[ロール](vmware-azure-deploy-configuration-server.md#azure-active-directory-permission-requirements)がこのユーザーに割り当てられていることを確認してください。
7. ツールがいくつかの構成タスクを実行した後、再起動されます。
8. 再度マシンにサインインします。 数秒後に、構成サーバーの管理ウィザードが自動的に起動します。


### <a name="configure-settings-and-add-the-vmware-server"></a>設定を構成し、VMware サーバーを追加する

構成サーバーの設定と登録を終了します。 続行する前に、構成サーバーの設定を正常に完了するためのすべての[前提条件](vmware-azure-deploy-configuration-server.md#prerequisites)が満たされていることを確認します。


1. 構成サーバー管理ウィザードで、 **[接続の設定]** を選びます。 ドロップダウンから、最初に、モビリティ サービスの検出とソース マシンへのプッシュ インストールのために組み込みプロセス サーバーが使用する NIC を選択し、次に、構成サーバーが Azure との接続に使用する NIC を選択します。 次に、 **[保存]** を選択します。 構成後、この設定を変更することはできません。
2. **[Recovery Services コンテナーを選択する]** で、Azure サブスクリプションと、関連するリソース グループおよびコンテナーを選びます。
3. **[サードパーティ製ソフトウェアのインストール]** でライセンス契約に同意します。 **[ダウンロードしてインストール]** を選択して MySQL サーバーをインストールします。 MySQL をパスに配置した場合、この手順はスキップできます。 [詳細情報](vmware-azure-deploy-configuration-server.md#configure-settings)
4. **[アプライアンス構成の検証]** で、続行する前に前提条件が検証されます。
5. **[Configure vCenter Server/vSphere ESXi server]\(vCenter Server/vSphere ESXi サーバーの構成\)** で、レプリケートする VM が存在している vCenter サーバーまたは vSphere ホストの FQDN または IP アドレスを入力します。 サーバーがリッスンするポートを入力します。 コンテナーで VMware サーバーに使うフレンドリ名を入力します。
6. VMware サーバーに接続するために構成サーバーによって使用される、ユーザー資格情報を入力します。 ユーザー名とパスワードが正しいこと、および保護する仮想マシンの管理者グループの一部であることを確認してください。 Site Recovery はこれらの資格情報を使って、レプリケーションに利用できる VMware VM を自動的に検出します。 **[追加]** 、 **[続行]** の順に選択します。
7. **[仮想マシンの資格情報の構成]** で、レプリケーションが有効になったときにモビリティ サービスを VM に自動的にインストールするために使用されるユーザー名とパスワードを入力します。
    - Windows マシンの場合、このアカウントは、レプリケートするマシンに対するローカル管理者特権を持っている必要があります。
    - Linux の場合は、ルート アカウントの詳細を指定します。
8. **[構成の確定]** を選択して、登録を完了します。
9. 登録が終了したら、Azure portal を開き、構成サーバーと VMware サーバーが、 **[Recovery Services Vault]\(Recovery Services コンテナー\)**  >  **[管理]**  >  **[Site Recovery Infrastructure]\(Site Recovery インフラストラクチャ\)**  >  **[Configuration Servers]\(構成サーバー\)** に表示されていることを確認します。


構成サーバーが登録されると、指定された設定を使用して Site Recovery が VMware サーバーに接続され、VM が検出されます。

> [!NOTE]
> アカウント名がポータルに表示されるまでに 15 分以上かかることがあります。 すぐに更新するには、 **[構成サーバー]**  > ***[<サーバー名>]*** >  **[サーバーを最新の情報に更新する]** の順に選択します。

## <a name="set-up-the-target-environment"></a>ターゲット環境をセットアップする

ターゲット リソースを選択して確認します。

1. **[インフラストラクチャの準備]**  >  **[ターゲット]** の順に選択します。 使用する Azure サブスクリプションを選択します。 リソース マネージャー モデルを使用しています。
2. Site Recovery によって、仮想ネットワークが 1 つ以上あることが確認されます。 これらは、このシリーズのチュートリアルの[最初のチュートリアル](tutorial-prepare-azure.md)で、Azure のコンポーネントをセットアップしたときには存在している必要があります。

   ![[ターゲット] タブ](./media/vmware-azure-tutorial/storage-network.png)

## <a name="create-a-replication-policy"></a>レプリケーション ポリシーを作成する

1. [Azure Portal](https://portal.azure.com)を開きます。 **[Recovery Services コンテナー]** を検索して選択します。
2. Recovery Services コンテナー (このチュートリアルでは **ContosoVMVault**) を選択します
3. レプリケーション ポリシーを作成するには、 **[Site Recovery インフラストラクチャ]**  >  **[レプリケーション ポリシー]**  >  **[+ レプリケーション ポリシー]** の順に選択します。
4. **[レプリケーション ポリシーの作成]** で、ポリシー名を入力します。 **VMwareRepPolicy** を使用しています。
5. **[RPO しきい値]** では、既定値の 60 分が使用されます。 この値で、復旧ポイントの作成頻度を指定します。 継続的なレプリケーションがこの制限を超えると、アラートが生成されます。
6. **[復旧ポイントのリテンション期間]** で、各復旧ポイントがどれだけ長く保持されるかを指定します。 このチュートリアルでは 72 時間を使用しています。 レプリケートされた VM は、リテンション期間内の任意の時点に復旧できます。
7. **[アプリ整合性スナップショットの頻度]** で、アプリケーション整合性スナップショットの作成頻度を指定します。 既定の 60 分を使用しています。 **[OK]** を選択してポリシーを作成します。

   ![レプリケーション ポリシーの作成](./media/vmware-azure-tutorial/replication-policy.png)

- このポリシーは自動的に構成サーバーに関連付けられます。
- 既定でフェールバックの照合ポリシーが自動的に作成されます。 たとえば、レプリケーション ポリシーが **rep-policy** の場合、フェールバック ポリシーは **rep-policy-failback** になります。 このポリシーは、Azure からフェールバックを開始するまで使用されません。

## <a name="enable-replication"></a>レプリケーションを有効にする

以下のようにして、VM のレプリケーションを有効にします。

1. **[アプリケーションをレプリケートする]**  >  **[ソース]** を選択します。
2. **[ソース]** で、 **[オンプレミス]** を選択し、 **[ソースの場所]** の構成サーバーを選択します。
3. **[マシンの種類]** で、 **[仮想マシン]** を選択します。
4. **[vCenter/vSphere Hypervisor]\(vCenter/vSphere ハイパーバイザー\)** で、vSphere ホストまたは vCenter サーバーを管理するホストを選択します。
5. (構成サーバー VM に既定でインストールされる) プロセス サーバーを選択します。 **[OK]** をクリックします。 各プロセス サーバーの正常性状態が、推奨される制限とその他のパラメーターに従って示されます。 正常なプロセス サーバーを選択します。 [クリティカル](vmware-physical-azure-monitor-process-server.md#process-server-alerts)であるプロセス サーバーは選択できません。 エラーを[トラブルシューティングして解決](vmware-physical-azure-troubleshoot-process-server.md)するか、**または**[スケールアウト プロセス サーバー](vmware-azure-set-up-process-server-scale.md)を設定できます。
6. **[ターゲット]** で、サブスクリプションと、フェールオーバー対象の VM を作成するリソース グループを選択します。 Resource Manager デプロイ モデルを使用しています。 
7. フェールオーバー後に作成された Azure VM が接続する Azure ネットワークとサブネットを選択します。
8. **[選択したマシン用に今すぐ構成します。]** を選択し、レプリケーションを有効にするすべての VM にネットワーク設定を適用します。 マシンごとに Azure ネットワークを選択する場合は、 **[後で構成する]** を選択します。
9. **[Virtual Machines]**  >  **[仮想マシンの選択]** で、レプリケートする各マシンを選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 **[OK]** をクリックします。 特定の仮想マシンを表示または選択できない場合は、問題の解決方法の[詳細を確認](https://aka.ms/doc-plugin-VM-not-showing)してください。
10. **[プロパティ]**  >  **[プロパティの構成]** で、モビリティ サービスをマシンに自動的にインストールするためにプロセス サーバーが使用するアカウントを選択します。
11. **[レプリケーション設定]**  >  **[レプリケーション設定の構成]** で、正しいレプリケーション ポリシーが選択されていることを確認します。
12. **[レプリケーションを有効にする]** を選択します。 VM のレプリケーションを有効にすると、Site Recovery がモビリティ サービスをインストールします。
13. **[設定]**  >  **[ジョブ]**  >  **[Site Recovery ジョブ]** の順にクリックして、**保護の有効化**ジョブの進行状況を追跡できます。 **[保護の最終処理]** ジョブが実行され、復旧ポイントの生成が完了すると、マシンはフェールオーバーできる状態になります。
14. 変更が反映されてポータルに表示されるまで 15 分以上かかる場合があります。
15. 追加する VM を監視するには、 **[構成サーバー]**  >  **[最後の使用]** で VM の最終検出時刻を確認します。 定期検出を待たずに VM を追加するには、構成サーバーを強調表示し (選択しないでください)、 **[更新]** を選択します。

## <a name="next-steps"></a>次のステップ
レプリケーションを有効にした後は、訓練を実行して、すべてが予想どおりに動作することを確認します。
> [!div class="nextstepaction"]
> [ディザスター リカバリーのテストを実行する](site-recovery-test-failover-to-azure.md)
