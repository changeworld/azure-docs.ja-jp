---
title: Azure Site Recovery を使用して Azure から Hyper-V VM をフェールバックする
description: Azure Site Recovery を使用して、Azure からオンプレミス サイトに Hyper-V VM をフェールバックする方法。
services: site-recovery
author: rajani-janaki-ram
manager: gauravd
ms.service: site-recovery
ms.topic: article
ms.date: 09/12/2019
ms.author: rajanaki
ms.openlocfilehash: 4b005ae308576db6fd26fcf079161430b266ec3f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "79236487"
---
# <a name="run-a-failback-for-hyper-v-vms"></a>Hyper-V VM のフェールバックの実行

この記事では、[Azure Site Recovery](site-recovery-overview.md) を使用して、Hyper-V VM をオンプレミス サイトから Azure にフェールオーバーした後に作成された Azure VM をフェールバックする方法について説明します。

- Azure からオンプレミス サイトへの計画フェールオーバーを実行することで、Azure から Hyper-V VM をフェールバックします。 フェールオーバーの方向が Azure からオンプレミスの場合、フェールバックと見なされます。
- Azure は高可用性環境であり、VM は常に利用可能であるため、Azure からのフェールバックは計画的なアクティビティです。 オンプレミスでワークロードの実行を再開できるよう、短いダウンタイムを計画することができます。 
- 計画フェールバックによって Azure の VM がオフになり、最新の変更がダウンロードされます。 データの損失は想定されていません。

## <a name="before-you-start"></a>開始する前に

1. 使用できる[フェールバックの種類 (元の場所への復旧と別の場所への復旧)](failover-failback-overview.md#hyper-v-reprotectionfailback) を確認してください。
2. Azure VM がマネージド ディスクではなくストレージアカウントを使用していることを確認します。 マネージド ディスクを使用してレプリケートされた Hyper-V VM のフェールバックはサポートされていません。
3. オンプレミスの Hyper-V ホスト (または、Site Recovery と共に使用している場合は System Center VMM サーバー) が実行されていて、Azure に接続されていることを確認します。 
4. VM のフェールオーバーとコミットが完了していることを確認します。 Azure から Hyper-V VM をフェールバックするために、特定の Site Recovery コンポーネントを設定する必要はありません。
5. データの同期を完了してオンプレミスの VM を開始するために必要な時間は、さまざまな要因によって異なります。 データのダウンロードを高速化するために、より多くのスレッドを使用してダウンロードを並列処理するように Microsoft Recovery Services エージェントを構成することができます。 [詳細については、こちらを参照してください](https://support.microsoft.com/help/3056159/how-to-manage-on-premises-to-azure-protection-network-bandwidth-usage)。


## <a name="fail-back-to-the-original-location"></a>元の場所にフェールバックする

Azure 内の Hyper-V VM を元のオンプレミス VM にフェールバックするには、次の手順に従って、Azure からオンプレミス サイトへの計画フェールオーバーを実行します。

1. コンテナー > **[レプリケートされたアイテム]** で、VM を選択します。 VM を右クリックして **[計画されたフェールオーバー]** を選択します。 復旧計画をフェールバックする場合は、計画名を選択して **[フェールオーバー]**  >  **[計画されたフェールオーバー]** をクリックします。
2. **[計画されたフェールオーバーの確認]** で、ソースとターゲットの場所を選択します。 フェールオーバーの方向に注意してください。 プライマリからのフェールオーバーが想定どおりに機能し、すべての仮想マシンがセカンダリの場所にある場合には、これは情報の提供のみを目的としています。
3. **[データの同期]** で、オプションを選択します。
    - **[フェールオーバーの前にデータを同期する (差分変更のみを同期する)]** - VM をシャットダウンせずに同期するため、VM のダウンタイムが最小限に抑えられます。
        - **フェーズ 1**: Azure VM のスナップショットを取得し、オンプレミスの Hyper-V ホストにコピーします。 マシンは Azure での実行を継続します。
        - **フェーズ 2**: 新しい変更が行われないように Azure VM をシャットダウンします。 差分変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの VM が起動されます。
    - **[フェールオーバー中にのみデータを同期する (すべてダウンロードする)]** : ディスクの大部分が変更されたと仮定し、チェックサムの計算には時間をかけたくないため、このオプションの方が高速です。 このオプションを選択しても、チェックサム計算は実行されません。
        - ディスクのダウンロードが実行されます。 
        - Azure を長期間 (1 か月間以上) 実行している場合、またはオンプレミスの VM を削除した場合にこのオプションを使用することをお勧めします。

4. (VMM のみ) クラウドのデータ暗号化が有効になっている場合には、 **[暗号化キー]** で、VMM サーバーへのプロバイダーのインストール中にデータ暗号化を有効にしたときに発行された証明書を選択します。
5. フェールオーバーを開始します。 フェールオーバーの進行状況は、 **[ジョブ]** タブで確認できます。
6. フェールオーバー前のデータを同期するオプションを選択した場合、初期データの同期が完了した後、Azure で仮想マシンをシャットダウンする準備ができたら、 **[ジョブ]** > [ジョブ名] > **[フェールオーバーの実行]** の順にクリックします。 次の処理が実行されます。
    - Azure マシンをシャットダウンします。
    - 最新の変更をオンプレミスの VM に転送します。
    - オンプレミスの VM を開始します。
7. オンプレミスの VM マシンにサインインして、想定どおりに使用できることを確認できるようになりました。
8. 仮想マシンは、コミット保留中の状態になります。 **[コミット]** をクリックして、フェールオーバーをコミットします。
9. フェールバックを完了するには、 **[レプリケーションの反転]** をクリックして、オンプレミス VM の Azure へのレプリケーションを再開します。



## <a name="fail-back-to-an-alternate-location"></a>別の場所にフェールバックする 

次のようにして、別の場所にフェールバックします。

1. 新しいハードウェアを設定する場合は、[サポートされているバージョンの Windows](hyper-v-azure-support-matrix.md#replicated-vms) と Hyper-V のロールをコンピューターにインストールします。
2. 元のサーバーに保存していたものと同じ名前を使用して、仮想ネットワーク スイッチを作成します。
3. **[保護された項目]**  >  **[保護グループ]**  > \<ProtectionGroupName> -> \<VirtualMachineName> で、フェールバックする VM を選択してから **[計画されたフェールオーバー]** を選択します。
4. **[計画されたフェールオーバーの確認]** で、 **[Create on-premises virtual machine if it does not exist]\(オンプレミスの仮想マシンが存在しない場合は作成する\)** を選択します。
5. **[ホスト名]** で、VM を配置する、新しい Hyper-V ホスト サーバーを選択します。
6. **[データの同期]** で、フェールオーバー前にデータを同期するオプションを選択することをお勧めします。 このオプションを指定すると、VM をシャットダウンせずに同期するため、ダウンタイムを最小限に抑えることができます。 その後、次の処理を実行します。
    - **フェーズ 1**: Azure VM のスナップショットを取得し、オンプレミスの Hyper-V ホストにコピーします。 マシンは Azure での実行を継続します。
    - **フェーズ 2**: 新しい変更が行われないように Azure VM をシャットダウンします。 変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの仮想マシンが起動します。
    
7. チェックマークをクリックして、フェールオーバー (フェールバック) を開始します。
8. 初期の同期が終了し、Azure VM をシャットダウンする準備ができたら、 **[ジョブ]**  > \<計画フェールオーバー ジョブ> > **[フェールオーバーの実行]** の順にクリックします。 これにより Azure マシンがシャットダウンされ、最新の変更がオンプレミスの VM に転送され、オンプレミスの VM が起動します。
9. オンプレミスの VM にサインインして、すべてが想定どおりに動作していることを検証できます。
10. **[コミット]** をクリックして、フェールオーバーを完了します。 コミットすることによって Azure VM とそのディスクが削除され、再びオンプレミスの VM が保護された状態になります。
10. **[レプリケーションの反転]** をクリックして、オンプレミスの VM の Azure へのレプリケーションを開始します。 Azure で VM がオフにされてからの差分変更のみがレプリケートされます。

    > [!NOTE]
    > データの同期中にフェールバック ジョブを取り消した場合、オンプレミスの VM は破損状態となります。 データの同期によって Azure VM ディスクからオンプレミスのデータ ディスクに最新のデータがコピーされるので、同期が完了するまでは、ディスク データの一貫性が保たれていない可能性があるためです。 データの同期を取り消した後でオンプレミスの VM を開始する場合、その VM は起動しないおそれがあります。 この場合は、フェールオーバーを再実行してデータの同期を完了します。


## <a name="next-steps"></a>次のステップ
オンプレミスの VM を Azure にレプリケートした後、必要に応じて [Azure への別のフェールオーバーを実行](site-recovery-failover.md)することができます。
