<properties
	pageTitle="Site Recovery のネットワーク インフラストラクチャの考慮事項 | Microsoft Azure" 
	description="この記事では、Site Recovery を使用してフェールオーバーを行うためのネットワーク設計に関する実際の考慮事項について説明します。" 
	services="site-recovery" 
	documentationCenter="" 
	authors="rayne-wiselman" 
	manager="jwhit" 
	editor=""/>

<tags 
	ms.service="site-recovery" 
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery" 
	ms.date="12/14/2015" 
	ms.author="raynew"/>

#  Site Recovery のネットワーク インフラストラクチャの考慮事項

Azure Site Recovery サービスは、Azure またはオンプレミスのセカンダリ データセンターへのレプリケーションとフェールオーバーを調整および自動化して、オンプレミスの物理サーバーおよび仮想マシンを保護および復旧することにより、堅牢なビジネス継続性と障害復旧 (BCDR) ソリューションを構築するのに役立ちます。

この記事は、System Center VMM および Azure Site Recovery を備えた BCDR ソリューションおよびインフラストラクチャの設計、実装、およびサポートを担当する仮想化チームを対象にしています。

## 概要

BCDR 戦略の目的は、ビジネス アプリケーションを稼働状態に維持すること、およびワークロードやサービスで障害が発生した場合に組織が通常の操作をすばやく再開できるように復元することにあります。障害復旧戦略を策定することは容易ではありません。不測のイベントを予測するのは本質的に難しく、広範囲に及ぶ障害に対処する適切な保護を実装するには高いコストがかかるからです。Azure Site Recovery を使用すれば、保護と、プライマリ データ センターからセカンダリ データ センター (または Azure) へのフェールオーバーとを容易に実装することができます。そのためには、最初にプライマリ データをコピー (複製) し、その後、レプリカを定期的に更新するという方法をとります。

BCDR を計画する上で重要な作業として、目標復旧時間 (RTO) と目標復旧時点 (RPO) を定義する必要があります。そうすることで、データの損失を最小限に抑え (低 RPO)、可能な限り迅速に (低 RTO で) 組織のデータをオンラインに戻すことができます。組織でのネットワーク設計は、RTO および RPO の目標実現の妨げになる可能性があります。堅牢な設計計画は、この障害を回避するのに効果があります。


保護およびフェールオーバーの実装に役立つ Azure Site Recovery サービスを使用することに決めた場合、BCDR 用のネットワーク設計においていくつかの重大な問題があります。

- **VMM 設計**: System Center VMM を使用しています。VMM と Site Recover を統合するには、ネットワーク設計をどのように行えばよいか
- **フェールオーバー後の接続**: Site Recovery を使用して、フェールオーバーを実行します。フェールオーバー完了後に、自分のアプリケーションおよびワークロードを確実に利用可能およびアクセス可能にするにはどうすればよいか

## VMM 設計

既存の VMM 設計で VMM サーバーが 1 つ使用されているか複数使用されているかに関係なく、その VMM 設計の一番上の層に Site Recovery を配置することができます。

### スタンドアロン VMM サーバー

このトポロジでは、プライマリ サイトの仮想マシンに VMM サーバーをデプロイし、Site Recovery と Hyper-V レプリカを使用して、セカンダリ サイトにこの仮想マシンをレプリケートします。VMM サーバーと、そのサポート SQL Server を同じ仮想マシンにインストールすれば、1 つの VM をインスタンス化するだけで済むので、ダウンタイムを抑えることができます。VMM サービスがリモート SQL Server を使用している場合、まず SQL Server インスタンスを復旧してから VMM サーバーを復旧する必要があります。

Hyper-V レプリカを使用して VM に VMM を 1 つデプロイするには

1. SQL Server がインストールされた VM で VMM を設定します。
2. 管理対象のホストを、この VMM サーバー上のクラウドに追加します。
3. Azure ポータルにログインし、クラウドを保護されるように構成します。
4. VMM サーバーによって保護される必要があるすべての VM についてレプリケーションを有効にします。
5. HYPER-V Manager コンソールに移動し、HYPER-V レプリカを選択し、VMM VM でレプリケーションを有効にします。
6. ASR サービスによって保護されているクラウドに VMM VM が決して追加されないようにします。これにより、Hyper-V レプリケーション設定は ASR で上書きされません。

災害が発生した場合は、次の手順を使用してワークロードを復旧できます。

1. HYPER-V マネージャーを使用して、レプリカ VMM VM を復旧サイトにフェールオーバーします。
2. VMM VM が回復すると、ユーザーはセカンダリ サイトから HYPER-V Recovery Manager にログインできます。
3. 計画外のフェールオーバーが完了すると、ユーザーはプライマリ サイトにあるすべてのリソースにアクセスできます。
4. ワークロードをフェールオーバーするには、VMM VM を手動でセカンダリ サイトにフェールオーバーする必要があります。 


### クラスター化された VMM サーバー


[クラスターに VMM をデプロイする](https://technet.microsoft.com/library/gg610675.aspx)と、可用性を向上させ、ハードウェア フェールオーバーを防止することができます。Site Recovery と一緒に VMM クラスターをデプロイする場合は、以下の点に注意してください。

VMM サーバーは、地理的に離れたサイトにまたがる拡張クラスターにデプロイする必要があります。VMM によって使用される SQL Server データベースは、セカンダリ サイト上にレプリカを配置して、SQL Server AlwaysOn 可用性グループで保護する必要があります。災害が発生した場合は、VMM サーバーとそれに対応する SQL Server が自動的に復旧サイトにフェールオーバーされます。Site Recovery を使用してワークロードをフェールオーバーすることができます。

![拡張された VMM クラスター](./media/site-recovery-network-design/ASR_NetworkDesign1.png)

## フェールオーバー後の接続

最新のアプリケーションは、ほとんどの場合、ある程度はネットワーキングに依存しています。そのため、サービスをサイト間で物理的に移動する場合は、ネットワーク上の課題があり、フェールオーバー後にアプリケーションおよびワークロードを確実にアクセス可能にするのが難しくなります。この課題に対しては、主に次の 2 つの解決策があります。

- **固定 IP アドレス**: 最初の方法は、固定 IP アドレスを維持することです。移動するサービスおよびホスティング サーバーが物理的に異なる場所で開始されても、アプリケーションはそれらに関する IP アドレス構成を新しい場所で有効にします。
- **変更される IP アドレス**: 2 つ目の方法では、回復サイトへの移行中に IP アドレスを変更する必要があります。 

### オプション 1: 固定の IP アドレス

障害復旧の観点からは、固定 IP アドレスを使用するのが最も簡単な実装方法のようです。ただし、この方法には、多くの課題が存在する可能性があるため、実際には一般的ではありません。Azure Site Recovery を使用すれば、すべてのシナリオで IP アドレスを保持することができます。この方法を採用する場合は、事前に主要なシナリオ (拡張サブネットおよびサブネットのフェールオーバー) に関する考慮事項を確認してください。

#### 拡張サブネット

拡張サブネットでは、プライマリ場所とターゲット場所の両方で同時にサブネットを使用することができます。簡単に言えば、サーバーとその IP (レイヤー 3) 構成をセカンダリ サイトに移動することができ、トラフィックはネットワークによって新しい場所に自動的にルーティングされます。これはサーバーから見れば処理は簡単ですが、多くの課題があります。



- レイヤー 2 (データ リンク層) の観点からは、拡張 VLAN を管理できるネットワーク機器が必要になります。ただし、この種の機器は現在、広く普及しています。
- 2 番目のより大きな問題として、VLAN を拡張すると、障害の可能性のあるドメインが両方のサイトに広がります (実質的に単一障害点になります)。ただし、ブロードキャスト ストームが始まっても、それを分離できなくなる可能性は低いと考えられます。この問題については、正常な実装であるという意見から「正常でない」という意見まで、入り混じっています。
- DR サイトとして Azure にフェールオーバーする場合、サブネットの拡張は不可能です。

#### サブネットのフェールオーバー

サブネットのフェールオーバーを実装すれば、サブネットを実際に拡張することなしに拡張サブネットの恩恵を得ることができます。この構成では、指定されるサブネットはいずれもサイト 1 またはサイト 2 に存在し、両方のサイトに同時に存在することはありません。フェールオーバーの発生時に IP アドレス空間を維持するには、サイトからサイトへサブネットを移動するためのルーター インフラストラクチャをプログラムによって準備することができます。フェールオーバー シナリオでは、サブネットは関連する保護された VM と一緒に移動します。この方法の主な短所は、フェールオーバー時にサブネット全体を移動する必要があるということです。これは理にかなった解決策かもしれないが、フェールオーバーの粒度に関する考慮事項に影響を与える可能性があります。

架空の企業が (Contoso) が、サブネット全体をフェールオーバーするとき、どのようにして VM を復旧場所にレプリケートすることができるのかを見てみましょう。Contoso が 2 つのオンプレミスの場所の間で VM をレプリケーションするとき、どのようにサブネットを管理できるかを確認し、さらに、Azure が障害復旧サイトとして使用される場合にサブネットのフェールオーバーがどのように動作するかについて説明します。

##### 例: 企業内でのサブネットのフェールオーバー
 
- プライマリ サイトでは、アプリケーションがサブネット 192.168.1.0/24 で実行されます。
- サブネット全体がフェールオーバーされると、サブネット内のすべての仮想マシンは、復旧サイトにフェールオーバーされ、それらの IP アドレスを保持します。
- 下図に示すように、プライマリ サイトと復旧サイト間のルート、3 つ目のサイトとプライマリ サイト間のルート、および 3 つ目のサイトと復旧サイト間のルートは、サブネット 192.168.1.0/24 に属するすべての仮想マシンが復旧サイトに移動されているという事実を反映するように適切に変更される必要があります。
- この図は以下の項目を前提としています。
	-  各データ センターは、VMM の独自のインスタンスによって処理されます。データ センター間で System Center VMM データベースのレプリケーションは行われません。
	-  各データ センターでは、仮想マシンに対して静的 IP アドレスを使用します。
	-  データ センター間の接続は、インターネット経由の VPN 接続を使用するのでなく、専用回線を使用して確立されます。

**フェールオーバー前**

![フェールオーバー前](./media/site-recovery-network-design/ASR_NetworkDesign2.png)

**フェールオーバー後**

![フェールオーバー後](./media/site-recovery-network-design/ASR_NetworkDesign3.png)


Site Recovery では、特定の仮想マシンに対して保護を有効にする場合、次のようにネットワーク リソースを割り当てます。

1. Site Recovery では、仮想マシン上のネットワーク インターフェイスごとに IP アドレスを割り当てます。これらは、各 VMM インスタンスの関連するネットワークに対して定義された静的 IP アドレス プールから取得されます。
2. 管理者が、復旧サイト上のネットワークに対して、プライマリ サイトで使用されているものと同じ IP アドレス プールを定義した場合、Site Recovery はプライマリ仮想マシンに割り当てられているものと同じ IP アドレスをレプリカの仮想マシンに割り当てます。この IP アドレスは VMM 内に保持されますが、フェールオーバー IP アドレスとして設定されません。フェールオーバー IP アドレスは、フェール オーバーの直前に設定されます。このスクリーン ショットは、レプリカ仮想マシン用のフェールオーバー TCP/IP 設定 (HYPER-V コンソールでの) を示します。これらの設定は、仮想マシンを対象にしたフェールオーバー開始の合間でレプリケートされます。

	![IP アドレスの設定](./media/site-recovery-network-design/ASR_NetworkDesign4.png)

3. 同じ IP アドレスが利用できない場合、Site Recovery はプールから別のアドレスを割り当てます。
4. 仮想マシンの保護が有効になった後、次のサンプル スクリプトを使用して、仮想マシンに割り当てられている IP アドレスを確認することができます。同じ IP アドレスであれば、フェールオーバー IP アドレスとして設定され、フェールオーバー時に VM に割り当てられます。

    $vm = Get-SCVirtualMachine -Name $na = $vm[0].VirtualNetworkAdapters $ip = Get-SCIPAddress -GrantToObjectID $na[0].id $ip.address

仮想マシンで DHCP が使用されている場合、Site Recovery によって IP アドレスの管理は行われないので注意してください。復旧サイトに対して IP アドレスを割り当てる DHCP サーバーが、プライマリ サイトの場合と同じ範囲からアドレスを割り当てることができることを確認する必要があります。

##### 例: Azure へのサブネットのフェールオーバー

Azure にフェールオーバーする場合は、さらにいくつかの制約があります。基幹業務アプリケーションをホストするオンプレミス インフラストラクチャとモバイル アプリケーションをホストする Azure を備える架空の会社 (Woodgrove Bank) を見てみましょう。


- Azure 内の Woodgrove Bank VM とオンプレミス サーバーとの間の接続は、サイト間 VPN を介して行われます。このサイト間 VPN により、Azure 内の仮想ネットワークは、Woodgrove Bank のオンプレミス ネットワークの延長として示されます。 
- Woodgrove では、Site Recovery を使用して、オンプレミスのワークロードを Azure にレプリケートする必要があります。 
- Woodgrove は、ハードコード化された IP アドレスに依存するアプリケーションおよび構成に対処する必要があります。このため、Woodgrove は、Azure へのフェールオーバーの後でもアプリケーションの IP アドレスを保持する必要があります。
- Woodgrove のオンプレミス インフラストラクチャは、VMM 2012 R2 サーバーによって管理されます。
- VMM サーバーに対しては、VLAN ベースの論理ネットワーク (アプリケーションのネットワーク) が作成されています。![論理ネットワーク](./media/site-recovery-network-design/ASR_NetworkDesign5.png)
- VM ネットワーク (アプリケーション VM ネットワーク) は、論理ネットワークを使用して作成されました。![VM ネットワーク](./media/site-recovery-network-design/ASR_NetworkDesign6.png)
- アプリケーション内の仮想マシンはすべて静的 IP プールを使用します。このため、論理ネットワークに対しても静的 IP アドレスが定義されます。 
- Woodgrove は、IP アドレス範囲 (172.16.1.0/24、172.16.2.0/24) からの IP アドレスを、Azure で実行されるリソースに割り当てます。


Woodgrove がレプリケーションをデプロイし、IP アドレスを維持するためには、以下のことが必要です。

- アプリケーションがシームレスにフェールオーバーできるように、オンプレミス ネットワークの拡張機能として使用される Azure 仮想マシン。
- Azure でサイト間接続をセットアップする場合、Azure ネットワークを使用すると、IP アドレス範囲がオンプレミスの IP アドレス範囲と異なる場合にのみ、トラフィックをオンプレミスの場所 (Azure ではローカル ネットワークと呼ぶ) にルーティングすることができます。このような制限があるのは、Azure でサブネットの拡大がサポートされていないためです。すなわち、オンプレミス上にサブネット 192.168.1.0/24 がある場合、Azure ネットワークにローカル ネットワーク 192.168.1.0/24 を追加することはできません。これは予想される状況です。その理由は、Azure が、サブネットにアクティブな VM がないこと、およびサブネットが災害復旧の目的でのみ作成されることを認識しないことにあります。Azure ネットワークからネットワーク トラフィックを正しくルーティングできるようにするには、ネットワーク内のサブネットとローカル ネットワークが競合してはなりません。 
- ここで、フェールオーバー VM が作成される、追加のネットワーク (回復ネットワーク) を Azure に作成する必要があります。

	![Azure ネットワーク](./media/site-recovery-network-design/ASR_NetworkDesign7.png)

- VM の IP アドレスが確実に保持されるようにするために、Site Recovery の VM プロパティで、同じ IP アドレスが使用されるように指定します。フェールオーバー後、Site Recover は指定した IP アドレスを VM に割り当てます。![Azure ネットワーク](./media/site-recovery-network-design/ASR_NetworkDesign8.png)


- フェールオーバーをトリガーし、回復ネットワーク内に必要な IP アドレスを使用して VM を作成する場合、VM への接続は を使用して確立することができます。この操作はスクリプト化することができます。サブネットのフェールオーバーについて前のセクションで説明したように、Azure へのフェールオーバーの場合も、192.168.1.0/24 が Azure に移動されたことを反映するためにルートを適切に変更する必要があります。![Azure ネットワーク](./media/site-recovery-network-design/ASR_NetworkDesign9.png)

### オプション 2: 変更される IP アドレス

この方法が最も一般的なようです。この場合は、フェールオーバーするすべての VM の IP アドレスが変更されます。この方法の主な短所は、ネットワーク インフラストラクチャが、IP アドレスが変更されたことを認識する必要があると共に、通常、DNS エントリをネットワーク全体で変更またはフラッシュする必要があること (同様に、ネットワーク テーブル内のキャッシュされたエントリを変更またはフラッシュする必要があること) を認識する必要があるということです。このため、DNS インフラストラクチャのセットアップ方法によってはダウンタイムが発生する可能性があります。これらの問題は、イントラネット アプリケーションの場合は低 TTL 値を使用し、インターネット ベースのアプリケーションの場合は [Azure Traffic Manager と Site Recovery](https://azure.microsoft.com/blog/2015/03/03/reduce-rto-by-using-azure-traffic-manager-with-azure-site-recovery/) を使用して軽減することができます。

#### 例: 変更される IP アドレス

プライマリ サイトまたは復旧サイトでホストされるアプリケーションにアクセスできる 3 つ目のサイトを持つ例を使用して、このシナリオを見てみましょう。

![Azure ネットワーク](./media/site-recovery-network-design/ASR_NetworkDesign10.png)

- 一部のアプリケーションについては、サブネット 192.168.1.0/24 のプライマリ サイトでホストされ、フェールオーバー後はサブネット 172.16.1.0/24 の復旧サイトでアップ状態になるように構成されています。
- VPN 接続/ネットワーク ルートは、3 つのサイトすべてが相互にアクセスできるように適切に構成されています。 
- 1 つまたは複数のアプリケーションは、フェールオーバーされた後、復旧サブネットで復元されます。この場合、サブネット全体を同時にフェールオーバーする必要はなく、VPN またはネットワーク ルートを再構成するための変更も必要もありません。
- フェールオーバーおよび DNS の更新により、アプリケーションはアクセス可能な状態に保持されます。動的更新が行われるように DNS サーバーが構成された場合、仮想マシンは、フェールオーバー後に起動すると、新しい IP アドレスを使用して自身を登録します。

	![Azure ネットワーク](./media/site-recovery-network-design/ASR_NetworkDesign11.png)

- フェールオーバー後、レプリカ仮想マシンは、プライマリ仮想マシンの IP アドレスと異なる IP アドレスを保有する場合があります。
- 仮想マシンは起動後に使用されている DNS サーバーを更新します。DNS エントリは、通常、ネットワーク全体で変更またはフラッシュする必要あります。ネットワーク テーブル内のキャッシュされたエントリも更新またはフラッシュする必要があります。したがって、これらの状態が変更が発生している間、ダウンタイムが発生するのは珍しいことではありません。これは以下の方法で軽減できます。

	- イントラネット アプリケーションに低 TTL 値を使用する。
	- イントラネット ベースのアプリケーションに対して [Azure Traffic Manger と Site Recovery]https://azure.microsoft.com/blog/2015/03/03/reduce-rto-by-using-azure-traffic-manager-with-azure-site-recovery/ を使用する。
	- タイムリーな更新を可能にするために、復旧計画で次のスクリプトを使用して DNS サーバーを更新する (動的 DNS 登録が構成されている場合、このスクリプトは必要ありません)。

    [string]$Zone, [string]$name, [string]$IP ) $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name $newrecord = $record.clone() $newrecord.RecordData[0].IPv4Address = $IP Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord

#### 例: Azure へのフェールオーバー

「障害復旧サイトとして Azure 用にセットアップされたネットワーク インフラストラクチャ」[ブログ投稿](https://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/)では、IP アドレスを維持することが要件になっていない場合に、必要な Azure ネットワーク インフラストラクチャをセットアップする方法について説明します。アプリケーションを説明することから始め、オンプレミスおよび Azure でネットワークを設定する方法についても説明します。これには、最後に、テスト フェールオーバーおよび計画されたフェールオーバーを実行するための手順が示されています。

## 次のステップ

[学習内容](site-recovery-network-mapping.md): Site Recovery がソースおよびターゲット ネットワークをマップする方法。

<!---HONumber=AcomDC_0128_2016-->