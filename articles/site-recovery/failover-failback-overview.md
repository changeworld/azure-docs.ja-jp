---
title: Azure Site Recovery でのフェールオーバーとフェールバックについて
description: Azure Site Recovery でのフェールオーバーとフェールバックについて説明します。
ms.topic: conceptual
ms.date: 12/24/2019
ms.openlocfilehash: d9b54f3c452212e12419a5ffd67b116c8660308d
ms.sourcegitcommit: 163be411e7cd9c79da3a3b38ac3e0af48d551182
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/21/2020
ms.locfileid: "77539520"
---
# <a name="about-on-premises-disaster-recovery-failoverfailback"></a>オンプレミスのディザスター リカバリーのフェールオーバーとフェールバックについて

この記事では、[Azure Site Recovery](site-recovery-overview.md) を使用して、オンプレミスのマシンの Azure へのディザスター リカバリー時におけるフェールオーバーとフェールバックの概要について説明します。

## <a name="recovery-stages"></a>復旧ステージ

Site Recovery のフェールオーバーとフェールバックには、次の 4 つのステージがあります。

- **ステージ 1:オンプレミスからのフェールオーバー**:オンプレミスのマシンに Azure へのレプリケーションを設定したら、オンプレミスのサイトがダウンしたときに、これらのマシンを Azure にフェールオーバーします。 フェールオーバー後、レプリケートされたデータから Azure VM が作成されます。
- **ステージ 2:Azure VM の再保護**:Azure で、Azure VM がオンプレミスのサイトへのレプリケートを開始できるように、Azure VM を再保護します。 再保護中は、データ一貫性を保証できるように、オンプレミス VM は無効にされます (使用可能な場合)。
- **ステージ 3:Azure からのフェールオーバー**:オンプレミスのサイトが再び正常に実行されるようになったら、別のフェールオーバーを実行します。今回は、Azure VM をオンプレミスのサイトにフェールバックします。 元の場所にフェールバックすることも、別の場所にフェールバックすることもできます。
- **ステージ 4:オンプレミスのマシンの再保護**:フェールバック後に、オンプレミスのマシンの Azure へのレプリケーションを再び有効にします。

## <a name="failover"></a>[フェールオーバー]

フェールオーバーは、事業継続とディザスター リカバリー (BCDR) 戦略の一環として実行します。

- BCDR 戦略の最初のステップとして、オンプレミスのマシンを Azure に継続的にレプリケートします。 ユーザーは、オンプレミスのソース マシンで実行されているワークロードとアプリにアクセスします。
- 必要な場合 (たとえばオンプレミスで障害が発生した場合) には、レプリケートしているマシンを Azure にフェールオーバーします。 レプリケートされたデータを使って Azure VM が作成されます。
- 事業継続のために、ユーザーは引き続き Azure VM 上のアプリにアクセスできます。

フェールオーバーは次の 2 フェーズのアクティビティです。

- **フェールオーバー**:選択した復旧ポイントを使用して Azure VM を作成して起動するフェールオーバー。
- **コミット**:フェールオーバー後、Azure で VM を確認します。
    - 次に、選択した復旧ポイントにフェールオーバーをコミットするか、別のポイントを選択してコミットします。
    - フェールオーバーをコミットしたら、復旧ポイントを変更することはできません。


## <a name="connect-to-azure-after-failover"></a>フェールオーバー後の VM への接続

RDP または SSH を使用してフェールオーバー後に作成された Azure VM に接続するには、複数の要件があります。

**[フェールオーバー]** | **場所** | **アクション**
--- | --- | ---
**Azure VM (Windows)** | フェールオーバー前のオンプレミスのマシン上 | **インターネット経由でのアクセス**:RDP を有効にします。 TCP と UDP の規則が **[パブリック]** に追加されていることを確認し、 **[Windows ファイアウォール]**  >  **[許可されたアプリ]** で、すべてのプロファイルで RDP が許可されていることを確認します。<br/><br/> **サイト間 VPN 経由でのアクセス**:マシンで RDP を有効にします。 **[Windows ファイアウォール]**  ->  **[許可されたアプリおよび機能]** で、**ドメインとプライベート** ネットワークで RDP の使用が許可されていることを確認します。<br/><br/>  オペレーティング システムの SAN ポリシーが **[OnlineAll]** に設定されていることを確認します。 [詳細については、こちらを参照してください](https://support.microsoft.com/kb/3031135)。<br/><br/> フェールオーバーを開始する際は、実行待ちの Windows Update が VM にないことを確認してください。 フェールオーバーの実行時に Windows Update が開始された場合、更新が完了するまで VM にログオンできなくなります。
**Windows で実行中の Azure VM** | フェールオーバー後の Azure VM 上 |  VM の[パブリック IP アドレスを追加](https://aka.ms/addpublicip)します。<br/><br/> フェールオーバーされる VM (およびその接続先となる Azure サブネット) は、そのネットワーク セキュリティ グループの規則で、RDP ポートへの受信接続を許可する必要があります。<br/><br/> **[ブート診断]** をオンにして、VM のスクリーンショットを確認します。 接続できない場合は、VM が実行中であることを確認したうえで、[トラブルシューティングのヒント](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx)を確認してください。
**Linux で実行中の Azure VM** | フェールオーバー前のオンプレミスのマシン上 | VM 上の Secure Shell サービスがシステム起動時に自動的に開始されるよう設定されていることを確認します。<br/><br/> ファイアウォール規則で SSH 接続が許可されていることを確認します。
**Linux で実行中の Azure VM** | フェールオーバー後の Azure VM 上 | フェールオーバーされた VM (および接続先の Azure サブネット) のネットワーク セキュリティ グループの規則で、SSH ポートへの着信接続を許可する必要があります。<br/><br/> VM の[パブリック IP アドレスを追加](https://aka.ms/addpublicip)します。<br/><br/> VM のスクリーンショットを得るために、 **[ブート診断]** をオンにします。<br/><br/>

## <a name="types-of-failover"></a>フェールオーバーの種類

Site Recovery には、さまざまなフェールオーバー オプションがあります。

**[フェールオーバー]** | **詳細** | **回復** | **Workflow**
--- | --- | --- | ---
**テスト フェールオーバー** | データの損失やダウンタイムを発生させることなく、BCDR 戦略を検証するドリルを実行するために使用します。| Azure で VM のコピーを作成します。進行中のレプリケーションや運用環境には影響しません。 | 1.復旧計画で単一の VM、または複数の VM でテスト フェールオーバーを実行します。<br/><br/> 2.テスト フェールオーバーで使用する復旧ポイントを選択します。<br/><br/> 3.フェールオーバー後に作成される Azure VM が配置される Azure ネットワークを選択します。 このネットワークは、テスト フェールオーバーにのみ使用されます。<br/><br/> 4.ドリルが想定どおりに実行されたことを確認します。 ドリル中に Azure で作成された VM は、Site Recovery によって自動的にクリーンアップされます。
**計画されたフェールオーバー (Hyper-V)**  | 通常、計画的なダウンタイムに使用されます。<br/><br/> ソース VM はシャットダウンされます。 フェールオーバーを開始する前に最新のデータが同期されます。 | 計画されたワークフローではデータ損失は生じません。 | 1.ダウンタイムのメンテナンス期間を計画し、ユーザーに通知します。<br/><br/> 2.ユーザー向けのアプリをオフラインにします。<br/><br/> 3.最新の復旧ポイントを使用して、計画されたフェールオーバーを開始します。 マシンがシャットダウンされていない場合、またはエラーが発生した場合、フェールオーバーは実行されません。<br/><br/> 4.フェールオーバー後、Azure でレプリカの Azure VM がアクティブになっていることを確認します。<br/><br/> 5.フェールオーバーをコミットして終了します。 コミット アクションにより、すべての復旧ポイントが削除されます。
**フェールオーバー (Hyper-V)** | 通常は、計画外の停止が発生した場合や、プライマリ サイトが使用できない場合に実行します。<br/><br/> 必要に応じて、VM をシャットダウンし、最終的な変更を同期してからフェールオーバーを開始します。  | アプリのデータ損失は最小限です。 | 1.BCDR プランを開始します。 <br/><br/> 2.フェールオーバーを開始します。 フェールオーバーをトリガーする前に、Site Recovery で VM をシャットダウンし、最新の変更を同期またはレプリケートするかどうかを指定します。<br/><br/> 3.次の表に示すように、複数の復旧ポイント オプションにフェールオーバーできます。<br/><br/> VM をシャットダウンするオプションを有効にしない場合、または Site Recovery でシャットダウンできない場合は、最新の復旧ポイントが使用されます。<br/>マシンをシャットダウンできない場合でも、フェールオーバーは実行されます。<br/><br/> 4.フェールオーバー後、Azure でレプリカの Azure VM がアクティブになっていることを確認します。<br/> 必要に応じて、24 時間のリテンション期間から別の復旧ポイントを選択できます。<br/><br/> 5.フェールオーバーをコミットして終了します。 コミット アクションにより、すべての使用可能な復旧ポイントが削除されます。
**フェールオーバー (VMware)** | 通常は、計画外の停止が発生した場合や、プライマリ サイトが使用できない場合に実行します。<br/><br/> 必要に応じて、フェールオーバーを開始する前に、Site Recovery で VM のシャットダウンをトリガーし、最終的な変更を同期してレプリケートするように指定します。  | アプリのデータ損失は最小限です。 | 1.BCDR プランを開始します。 <br/><br/> 2.Site Recovery からフェールオーバーを開始します。 フェールオーバーを実行する前に、Site Recovery で VM のシャットダウンをトリガーして同期するかどうかを指定します。<br/> マシンをシャットダウンできない場合でも、フェールオーバーは実行されます。<br/><br/> 3.フェールオーバー後、Azure でレプリカの Azure VM がアクティブになっていることを確認します。 <br/>必要に応じて、72 時間のリテンション期間から別の復旧ポイントを選択できます。<br/><br/> 5.フェールオーバーをコミットして終了します。 コミット アクションにより、すべての復旧ポイントが削除されます。<br/> Windows VM の場合、フェールオーバー時に Site Recovery によって VMware ツールが無効にされます。

## <a name="failover-processing"></a>フェールオーバーの処理

一部のシナリオでは、フェールオーバーで追加処理が必要です。これが完了するまで約 8 分から 10 分かかります。 以下の場合は、テスト フェールオーバーの時間が長くなることがあります。

* 9\.8 よりも前のバージョンのモビリティ サービスを実行している VMware VM。
* 物理サーバー。
* VMware Linux VM。
* 物理サーバーとして保護されている Hyper-V VM。
* DHCP サービスが有効になっていない VMware VM。
* 次のブート ドライバーがない VMware VM: storvsc、vmbus、storflt、intelide、atapi。

## <a name="recovery-point-options"></a>復旧ポイントのオプション

フェールオーバー時に、複数の復旧ポイントのオプションを選択できます。

**オプション** | **詳細**
--- | ---
**最新 (最低 RPO)** | このオプションは、最も低い目標復旧ポイント (RPO) を提供します。 これは、Site Recovery サービスに送信されたすべてのデータを最初に処理して、各 VM の復旧ポイントを作成してから、それにフェールオーバーします。 この復旧ポイントには、フェールオーバーがトリガーされたときに Site Recovery にレプリケートされたすべてのデータが含まれます。
**最後に処理があった時点**  | このオプションは、Site Recovery によって処理された最新の復旧ポイントに VM をフェールオーバーします。 特定の VM の最新の復旧ポイントを参照するには、VM 設定の **[Latest Recovery Points] (最新の回復ポイント)** を確認します。 このオプションを使用すると、未処理のデータの処理に時間がかからないため、RTO (目標復旧時間) を低くできます。
**最新のアプリ整合性** |  このオプションは、アプリ整合性復旧ポイントが有効になっている場合に、Site Recovery によって処理された最新のアプリケーション整合性復旧ポイントに VM をフェールオーバーします。 VM の設定で、最新の復旧ポイントを確認します。
**最新のマルチ VM 処理** | このオプションは、マルチ VM 整合性が有効にされている 1 台または複数の VM を含む復旧計画で使用できます。 設定が有効にされている VM は、最新の共通マルチ VM 整合性復旧ポイントにフェールオーバーされます。 計画にある他のすべての VM は、最新の処理済み復旧ポイントにフェールオーバーされます。
**最新のマルチ VM アプリ整合性** |  このオプションは、マルチ VM 整合性が有効にされている 1 台または複数の VM を含む復旧計画で使用できます。 レプリケーション グループに含まれる VM は、最新の共通マルチ VM アプリケーション整合性復旧ポイントにフェールオーバーされます。 その他の VM は、最新のアプリケーション整合性復旧ポイントにフェールオーバーされます。
**Custom** | 特定の VM を特定の時点の復旧ポイントにフェールオーバーする場合は、このオプションを使用します。 このオプションは、復旧計画では使用できません。

> [!NOTE]
> 復旧ポイントは、別の Recovery Services コンテナーに移行できません。

## <a name="reprotectionfailback"></a>再保護とフェールバック

Azure へのフェールオーバー後、レプリケートされた Azure VM は保護されていない状態になります。

- オンプレミスのサイトにフェールバックするための最初の手順として、オンプレミスへの Azure VM のレプリケートを開始する必要があります。 再保護プロセスは、フェールオーバーしたマシンの種類によって異なります。
- マシンが Azure からオンプレミスにレプリケートされると、Azure からオンプレミスのサイトへのフェールオーバーを実行できます。
- マシンがオンプレミスで再び実行されると、レプリケーションを有効にして、ディザスター リカバリーのためにそれらが Azure にレプリケートされるようにすることができます。

フェールバックは次のように機能します。

- フェールバックするには、VM に少なくとも 1 つの復旧ポイントが必要です。 復旧計画では、計画内のすべての VM に少なくとも 1 つの復旧ポイントが必要です。
- フェールバックには**最新の**復旧ポイントを使用することをお勧めします (これはクラッシュ整合ポイントです)。
    - アプリ整合性復旧ポイントのオプションがあります。 この場合、1 つの VM によって、利用可能な最新のアプリ整合性復旧ポイントに復旧されます。 レプリケーション グループを含む復旧計画の場合、それぞれのレプリケーション グループが、その共通の使用可能な復旧ポイントに復旧されます。
    - アプリ整合性の復旧ポイントは時間差を伴うことがあり、データの損失につながる場合があります。
- Azure からオンプレミスのサイトへのフェールオーバー中に、Site Recovery によって Azure VM がシャットダウンされます。 フェールオーバーをコミットすると、Azure でフェールバックされた Azure VM が Site Recovery によって削除されます。


## <a name="vmwarephysical-reprotectionfailback"></a>VMware/物理的な再保護/フェールバック

VMware マシンと物理サーバーを Azure からオンプレミスに再保護したりフェールバックしたりするには、フェールバック インフラストラクチャが必要です。また、いくつかの要件があります。

- **Azure 上の一時的なプロセス サーバー**:Azure からフェールバックするには、Azure からのレプリケーションを処理するプロセス サーバーとして機能する Azure VM を設定します。 この VM は、フェールバックの完了後に削除できます。
- **VPN 接続**:フェールバックするには、Azure ネットワークからオンプレミス サイトへの VPN 接続 (または ExpressRoute) が必要です。
- **独立したマスター ターゲット サーバー**:既定では、構成サーバーと共にオンプレミスの VMware VM にインストールされたマスター ターゲット サーバーによって、フェールバックが処理されます。 大量のトラフィックをフェールバックする必要がある場合は、その目的を果たすための独立したオンプレミスのマスター ターゲット サーバーをセットアップします。
- **フェールバック ポリシー**:ご利用のオンプレミスにもう一度レプリケートするには、フェールバック ポリシーが必要です。 このポリシーは、オンプレミスから Azure へのレプリケーション ポリシーを作成したときに自動的に作成されます。
    - このポリシーは自動的に構成サーバーに関連付けられます。
    - このポリシーを編集することはできません。
    - ポリシー値:RPO しきい値 - 15 分、復旧ポイントのリテンション期間 - 24 時間、アプリ整合性スナップショットの頻度 - 60 分。

VMware または物理的な再保護とフェールバックの詳細については、次を参照してください。
- 再保護とフェールバックの追加要件を[確認](vmware-azure-reprotect.md#before-you-begin)する。
- Azure でプロセス サーバーを[デプロイ](vmware-azure-prepare-failback.md#deploy-a-process-server-in-azure)する。
- 別のマスター ターゲット サーバーを[デプロイ](vmware-azure-prepare-failback.md#deploy-a-separate-master-target-server)する。

Azure VM をオンプレミスに再保護するときに、元の場所にフェールバックするか、別の場所にフェールバックするかを指定できます。

- **元の場所への復旧**:これにより、Azure から同じソースのオンプレミスのマシン (存在する場合) にフェールバックされます。 このシナリオでは、変更部分のみがオンプレミスにレプリケートされます。
- **別の場所への復旧**:オンプレミスのマシンが存在しない場合は、Azure から別の場所にフェールバックできます。 Azure VM からオンプレミスに再保護するときに、オンプレミスのマシンが作成されます。 Azure からオンプレミスへの完全なデータ レプリケーションが行われます。 - - フェールバックの場所に関する要件と制限事項を[確認](concepts-types-of-failback.md)します。



## <a name="hyper-v-reprotectionfailback"></a>Hyper-V の再保護とフェールバック

Azure からオンプレミスへの Hyper-V VM の再保護とフェールバックを行うには:

- フェールバックできるのは、ストレージ アカウントを使用してレプリケートする Hyper-V VM のみです。 マネージド ディスクを使用してレプリケートする Hyper-V VM のフェールバックはサポートされていません。
- オンプレミスの Hyper-V ホスト (または System Center VMM (使用されている場合)) が Azure に接続されている必要があります。
- Azure からオンプレミスへの計画されたフェールバックを実行します。
- Hyper-V VM のフェールバック用に、特定のコンポーネントを設定する必要はありません。
- 計画フェールオーバーでは、フェールバック前にデータを同期するオプションを選択できます。
    - **フェールオーバーの前にデータを同期する**:このオプションを指定すると、仮想マシンをシャットダウンせずに同期するため、仮想マシンのダウンタイムを最小限に抑えることができます。
        - フェーズ 1:Azure VM のスナップショットを取得し、オンプレミスの Hyper-V ホストにコピーします。 マシンは Azure での実行を継続します。
        - フェーズ 2:新しい変更が行われないように、Azure VM をシャットダウンします。 差分変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの VM が起動されます。
    - **フェールオーバー中にのみデータを同期する**:ほとんどのディスクが変更されていると考えられ、そのためチェックサム計算を実行しないため、このオプションの方が高速です。 ディスクのダウンロードが実行されます。 VM がしばらくの間 (1 か月以上) Azure で実行されている場合、またはオンプレミスの VM が削除されている場合は、このオプションを使用することをお勧めします。

Hyper-V の再保護とフェールバックの詳細については、[こちら](hyper-v-azure-failback.md)をご覧ください。

Azure VM をオンプレミスに再保護するときに、元の場所にフェールバックするか、別の場所にフェールバックするかを指定できます。

- **元の場所への復旧**:これにより、Azure から同じソースのオンプレミスのマシン (存在する場合) にフェールバックされます。 このシナリオでは、前の手順で説明したいずれかの同期オプションを選択します。
- **別の場所への復旧**:オンプレミスのマシンが存在しない場合は、Azure から別の場所にフェールバックできます。 Azure VM からオンプレミスに再保護するときに、オンプレミスのマシンが作成されます。 このオプションを使用する場合は、フェールオーバーの前にデータを同期するオプションを選択することをお勧めします。
- フェールバックの場所に関する要件と制限事項を[確認](hyper-v-azure-failback.md)します。


オンプレミスのサイトにフェールバックした後で、 **[レプリケーションの反転]** を有効にして、VM の Azure へのレプリケートを開始し、サイクルを完了します。




## <a name="next-steps"></a>次のステップ
- [特定の VMware VM](vmware-azure-tutorial-failover-failback.md) をフェールオーバーする。
- [特定の Hyper-V VM](hyper-v-azure-failover-failback-tutorial.md) をフェールオーバーする。
- 復旧計画を[作成する](site-recovery-create-recovery-plans.md)。
- [復旧計画の VM](site-recovery-failover.md) をフェールオーバーする。
- VMware の再保護とフェールバックを[準備](vmware-azure-failback.md)する。
- [Hyper-V VM](hyper-v-azure-failback.md) をフェールバックする。

