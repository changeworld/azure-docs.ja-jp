---
title: "Site Recovery を使用した、セカンダリ データ センターにレプリケートされた Hyper-V VM のフェールオーバーとフェールバック | Microsoft Docs"
description: "Azure Site Recovery を使用して、Hyper-V VM をセカンダリ オンプレミス サイトにフェールオーバーし、プライマリ サイトにフェールバックする方法を説明します。"
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 02/12/2018
ms.author: raynew
ms.openlocfilehash: 3740ec9917499f6a1e87905befe86598a18f68e6
ms.sourcegitcommit: d87b039e13a5f8df1ee9d82a727e6bc04715c341
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/21/2018
---
# <a name="fail-over-and-fail-back-hyper-v-vms-replicated-to-your-secondary-on-premises-site"></a>セカンダリ オンプレミス サイトにレプリケートされた Hyper-V VM のフェールオーバーとフェールバック

[Azure Site Recovery](site-recovery-overview.md) サービスは、オンプレミスのコンピュータと Azure 仮想マシン (VM) のレプリケーション、フェールオーバー、およびフェールバックの管理と調整を行います。

この記事では、System Center Virtual Machine Manager (VMM) クラウドで管理されている Hyper-V VM を、セカンダリ VMM サイトにフェールオーバーする方法について説明します。 フェールオーバーした後、オンプレミス サイトが使用可能になったときにオンプレミス サイトにフェールバックします。 この記事では、次のことについて説明します:

> [!div class="checklist"]
> * Hyper-V VM をプライマリ VMM クラウドからセカンダリ VMM クラウドにフェールオーバーする
> * セカンダリ サイトからプライマリ サイトに再保護し、フェールバックする
> * 必要に応じてプライマリからセカンダリへのレプリケーションを再度開始する

## <a name="failover-and-failback"></a>フェールオーバーとフェールバック

フェールオーバーとフェールバックには 3 つの段階があります。

1. **セカンダリ サイトへのフェールオーバー**: マシンをプライマリ サイトからセカンダリ サイトにフェールオーバーします。
2. **セカンダリ サイトからのフェールバック**: VM をセカンダリからプライマリにレプリケートし、計画されたフェールオーバーを実行してフェールバックします。
3. 計画されたフェールオーバーの後、必要に応じてプライマリからセカンダリへのレプリケーションを再度開始します。


## <a name="prerequisites"></a>前提条件

- すべてが予想どおりに動作することを確認するための[ディザスター リカバリー訓練](hyper-v-vmm-test-failover.md)を完了している必要があります。
- フェールバックを完了するには、プライマリとセカンダリ VMM サーバーが Site Recovery に接続されている必要があります。



## <a name="run-a-failover-from-primary-to-secondary"></a>プライマリからセカンダリへのフェールオーバーを実行する

Hyper-V VM の通常のフェールオーバーまたは計画されたフェールオーバーを実行できます。

- 通常のフェールオーバーは、予期しない停電時に使用します。 このフェールオーバーを実行すると、Site Recovery はセカンダリ サイトに VM を作成し、電源を投入します。 特定の復旧ポイントに対してフェールオーバーを実行します。 使用する復旧ポイントによってはデータ損失が発生する可能性があります。
- 計画されたフェールオーバーは、メンテナンスや想定された停止時に使用できます。 このオプションではデータ損失は発生しません。 計画されたフェールオーバーがトリガーされると、ソース VM がシャット ダウンされます。 同期されていないデータが同期され、フェールオーバーがトリガーされます。 
- 
この手順では、通常のフェールオーバーを実行する方法について説明します。


1. **[設定]** > **[レプリケートされたアイテム]** で、[VM] > **[フェールオーバー]** をクリックします。
2. **[フェールオーバー]** で、フェールオーバーする**[復旧ポイント]** を選択します。 次のいずれかのオプションを使うことができます。
    - **[最新]** (既定値): 最初に、Site Recovery に送信されるすべてのデータを処理します。 フェールオーバー後に作成されたレプリカ VM は、フェールオーバーがトリガーされた時点で Site Recovery にレプリケートされたすべてのデータを保持しているため、RPO (目標復旧時点) を最も低くすることができます。
    - **[Latest processed]\(最新の処理\)**: Site Recovery で処理された最新の復旧ポイントに VM をフェールオーバーします。 このオプションを使用すると、未処理のデータの処理に時間がかからないため、RTO (目標復旧時間) を低くできます。
    - **[最新のアプリ整合性]**: Site Recovery によって処理されたアプリ整合性の最新の復旧ポイントに VM をフェールオーバーします。 
3. 暗号化キーはこのシナリオには関係ありません。
4. Site Recovery でフェールオーバーをトリガーする前にそのソース VM をシャットダウンする場合は、**[フェールオーバーを開始する前にマシンをシャットダウンします]** を選択します。 Site Recovery はフェールオーバーをトリガーする前に、セカンダリ サイトに送信されていないオンプレミス データの同期を試行します。 シャットダウンが失敗した場合でも、フェールオーバーは続行されることに注意してください。 フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。
5. ここで、セカンダリ VMM クラウド内の VM を確認できます。
6. VM を確認したら、フェールオーバーを**コミット**します。 これにより、利用可能なすべての復旧ポイントが削除されます。

> [!WARNING]
> **進行中のフェールオーバーをキャンセルしないでください**。フェールオーバーが開始される前に VM のレプリケーションが停止します。 進行中のフェールオーバーをキャンセルすると、フェールオーバーは停止しますが、VM が再びレプリケートされることはありません。  


## <a name="reprotect-and-fail-back"></a>再保護とフェールバック

プライマリ サイトからセカンダリ サイトへのレプリケートを開始し、プライマリ サイトにフェールバックします。 プライマリ サイトで VM が再度実行された後で、セカンダリ サイトにもう一度レプリケートできます。  

1. **[設定]**  >  **[レプリケートされたアイテム]** で VM をクリックし、**[レプリケーションの反転]** を有効にします。 VM はプライマリ サイトにレプリケートを開始します。
2. [VM] > **[計画されたフェールオーバー]** の順にクリックします。
3. **[計画されたフェールオーバーの確認]** で、フェールオーバーの方向 (セカンダリ VMM クラウドから) を確認し、ソースとターゲットの場所を選択します。 
4. **[データの同期]** で、同期の方法を指定します。
    - **[フェールオーバーの前にデータを同期する (差分変更のみを同期する)]** - VM をシャットダウンせずに同期するため、VM のダウンタイムが最小限に抑えられます。 これは次のように動作します。
        - レプリカ VM のスナップショットを取得し、プライマリ Hyper-V ホストにコピーします。 レプリカ VM は稼働し続けます。
        - 新しい変更が行われないように、レプリカ VM をシャットダウンします。 差分変更の最終的なセットがプライマリ サイトに転送され、プライマリ サイトの VM が開始されます。
    - **[フェールオーバー中にのみデータを同期する (すべてダウンロードする)]**- セカンダリ サイトの実行期間が長い場合にこのオプションを使用します。 ディスクの複数の変更を想定してチェックサムの計算に時間を費やさないようにしているため、このオプションを選択すると高速になります。 このオプションでは、ディスク ダウンロードを実行します。 これはプライマリ VM が削除された場合にも便利です。
5. 暗号化キーはこのシナリオには関係ありません。
6. フェールオーバーを開始します。 フェールオーバーの進行状況は、 **[ジョブ]** タブで確認できます。
7. フェールオーバー前のデータ同期を選択した場合、初回のデータ同期が完了し、セカンダリ サイトのレプリカ VM をシャットダウンする準備ができた時点で、**[ジョブ]** > [planned failover job name]\(計画されたフェールオーバーのジョブ名\) > **[フェールオーバーの実行]** の順にクリックします。 これにより、セカンダリ VM がシャット ダウンされ、最新の変更がプライマリ サイトに転送され、プライマリ VM が開始されます。
8. プライマリ VMM クラウドで、VM が使用可能であることを確認します。
9. プライマリ VM は、この時点ではコミット保留中の状態です。 **[コミット]** をクリックして、フェールオーバーをコミットします。
10. プライマリ VM をセカンダリ サイトに再度レプリケーションする場合は、**[レプリケーションの反転]** を有効にします。


> [!NOTE]
> レプリケーションの反転では、レプリカ VM が停止してから発生した変更のみがレプリケートされ、差分変更のみが送信されます。

## <a name="next-steps"></a>次の手順
Hyper-V VM をセカンダリ サイトにレプリケートする手順については、[こちら](hyper-v-vmm-disaster-recovery.md)を参照してください。
