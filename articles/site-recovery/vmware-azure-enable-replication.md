---
title: Azure Site Recovery による Azure へのディザスター リカバリーのために VMware VM のレプリケーションを有効にする | Microsoft Docs
description: この記事では、Azure Site Recovery を使用して、ディザスター リカバリーのための Azure へのレプリケーションに対して VMware VM を有効にする方法について説明します。
author: Rajeswari-Mamilla
ms.service: site-recovery
ms.date: 06/28/2019
ms.topic: conceptual
ms.author: ramamill
ms.openlocfilehash: 3f4e4afb4d94a7b2e2a6b246a371cf6234577463
ms.sourcegitcommit: ac1cfe497341429cf62eb934e87f3b5f3c79948e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/01/2019
ms.locfileid: "67491728"
---
# <a name="enable-replication-to-azure-for-vmware-vms"></a>Azure への VMware VM のレプリケーションを有効にする

この記事では、Azure へのオンプレミス VMware VM のレプリケーションを有効にする方法について説明します。

## <a name="prerequisites"></a>前提条件

この記事では、以下のことを前提としています。

- [オンプレミスのソース環境の設定](vmware-azure-set-up-source.md)。
- [Azure でのターゲット環境の設定](vmware-azure-set-up-target.md)。

## <a name="before-you-start"></a>開始する前に
VMware 仮想マシンをレプリケートする場合、次の点に注意してください。

* Azure ユーザー アカウントには、新しい仮想マシンを Azure にレプリケートできるようにするための特定の[アクセス許可](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines)が必要です。
* VMware VM の検出は 15 分ごとに行われます。 検出後、VM が Azure portal に表示されるまで 15 分以上かかることがあります。 同様に、新しい vCenter サーバーまたは vSphere ホストを追加したときも、検出に 15 分以上かかることがあります。
* 仮想マシンの環境の変更 (VMware ツールのインストールなど) がポータルで更新されるまでには 15 分以上かかることがあります。
* 次のようにして VMware VM の最終検出時刻を確認できます。 **[構成サーバー]** ページにある vCenter サーバー/vSphere ホストの **[最後の使用]** フィールドを確認します。
* 定期検出を待たずにレプリケートする仮想マシンを追加するには、構成サーバーを強調表示し (クリックしないでください)、 **[更新]** を選択します。
* レプリケーションを有効にした場合、仮想マシンの準備が完了すると、プロセス サーバーで Azure Site Recovery モビリティ サービスが自動的にインストールされます。

## <a name="enable-replication"></a>レプリケーションを有効にする

このセクションの手順を実行する前に、次の点に注意してください。
* Azure Site Recovery は、すべての新しいレプリケーションについてマネージド ディスクに直接レプリケートするようになりました。 プロセス サーバーは、レプリケーション ログをターゲット リージョンのキャッシュ ストレージ アカウントに書き込みます。 これらのログは、asrseeddisk の名前付け規則を持つレプリカ マネージド ディスクの復旧ポイントを作成するために使用されます。
* マネージド ディスクへのレプリケーションに対する Powershell のサポートは、[Az.RecoveryServices モジュール バージョン 2.0.0 以降](https://www.powershellgallery.com/packages/Az.RecoveryServices/2.0.0-preview)に関するページから入手できます。 
* フェールオーバー時には、選択された復旧ポイントを使用して、ターゲット マネージド ディスクが作成されます。
* ターゲット ストレージ アカウントにレプリケートするように構成済みの VM は影響を受けません。
* 新しい仮想マシンのストレージ アカウントへのレプリケーションは、Representational State Transfer (REST) API および Powershell を使用した場合にのみ実行できます。 ストレージ アカウントにレプリケートする場合は、Azure REST API バージョン 2016-08-10 または 2018-01-10 を使用します。

以下の手順に従って、レプリケーションを有効にしてください。
1. **[手順 2:アプリケーションをレプリケートする]**  >  **[ソース]** の順にクリックします。 レプリケーションを初めて有効にした後は、コンテナーで **[+ レプリケート]** を選択して、追加の仮想マシンのレプリケーションを有効にします。
2. **[ソース]** ページで **[ソース]** をクリックし、構成サーバーを選択します。
3. **[マシンの種類]** で、 **[仮想マシン]** または **[物理マシン]** を選択します。
4. **[vCenter/vSphere Hypervisor] \(vCenter/vSphere ハイパーバイザー)** で、vSphere ホストを管理する vCenter サーバーを選択するか、ホストを選択します。 物理コンピューターをレプリケートする場合、この設定は関係ありません。
5. プロセス サーバーを選択します。 サーバーによって作成された追加のプロセスがない場合は、ドロップダウンにおいて構成サーバーの組み込みのプロセス サーバーを利用できます。 各プロセス サーバーの正常性状態が、推奨される制限とその他のパラメーターに従って示されます。 正常なプロセス サーバーを選択します。 [クリティカル](vmware-physical-azure-monitor-process-server.md#process-server-alerts)であるプロセス サーバーは選択できません。 エラーを[トラブルシューティングして解決](vmware-physical-azure-troubleshoot-process-server.md)するか、**または**[スケールアウト プロセス サーバー](vmware-azure-set-up-process-server-scale.md)を設定できます。
    ![[レプリケーションを有効にする] [ソース] ウィンドウ](media/vmware-azure-enable-replication/ps-selection.png)

> [!NOTE]
> [9.24 バージョン](service-updates-how-to.md#links-to-currently-supported-update-rollups)以降では、プロセス サーバーの正常性アラートを強化するために、追加のアラートが導入されています。 すべてのアラートが生成されるためには、Site Recovery コンポーネントを 9.24 バージョン以降にアップグレードします。

6. **[ターゲット]** で、フェールオーバー対象の仮想マシンを作成するサブスクリプションとリソース グループを選択します。 フェールオーバーされた VM に対して Azure で使用するデプロイ モデルを選択します。
2. フェールオーバー後に Azure VM が接続する Azure ネットワークとサブネットを選択します。 ネットワークは、Site Recovery サービス コンテナーと同じリージョンにある必要があります。

   保護の対象として選択したすべての仮想マシンにネットワーク設定を適用する場合は、 **[選択したマシン用に今すぐ構成します。]** を選択します。 仮想マシンごとに Azure ネットワークを選択する場合は、 **[後で構成する]** を選択します。 ネットワークがない場合は、作成する必要があります。 Azure Resource Manager を使用してネットワークを作成する場合は、 **[新規作成]** を選択します。 該当する場合は、サブネットを選択し、 **[OK]** を選択します。
   
   ![[レプリケーションを有効にする] [ターゲット] ウィンドウ](./media/vmware-azure-enable-replication/enable-rep3.png)

1. **[Virtual Machines]**  >  **[仮想マシンの選択]** で、レプリケートする各仮想マシンを選択します。 選択できるのは、レプリケーションを有効にできる仮想マシンのみです。 **[OK]** をクリックします。 特定の仮想マシンを表示または選択できない場合は、「[ソース マシンが Azure portal 内に表示されない](https://aka.ms/doc-plugin-VM-not-showing)」を参照して問題を解決してください。

    ![[レプリケーションを有効にする] [仮想マシンの選択] ウィンドウ](./media/vmware-azure-enable-replication/enable-replication5.png)

1. **[プロパティ]**  >  の **[プロパティの構成]** で、Site Recovery モビリティ サービスを仮想マシンに自動的にインストールするためにプロセス サーバーが使用するアカウントを選択します。 また、データ変更頻度パターンに基づいてレプリケートするターゲット マネージド ディスクの種類を選択します。
10. 既定では、ソース仮想マシンのすべてのディスクがレプリケートされます。 レプリケーションからディスクを除外するには、レプリケートしないディスクの **[Include]\(含める\)** チェックボックスをオフにします。 **[OK]** をクリックします。 後で追加のプロパティを設定できます。 ディスクの除外の詳細については、[こちら](vmware-azure-exclude-disk.md)をご覧ください。

    ![[レプリケーションを有効にする] [プロパティの構成] ウィンドウ](./media/vmware-azure-enable-replication/enable-replication6.png)

1. **[レプリケーションの設定]**  >  **[レプリケーション設定の構成]** で、正しいレプリケーション ポリシーが選択されていることを確認します。 レプリケーション ポリシー設定を変更するには、 **[設定]**  >  **[レプリケーション ポリシー]**  > ***(ポリシー名)*** >  **[設定の編集]** の順にクリックします。 ポリシーに適用した変更は、レプリケートしている仮想マシンと新しい仮想マシンにも適用されます。
1. 仮想マシンをレプリケーション グループにまとめる場合は、 **[マルチ VM 整合性]** を有効にします。 グループの名前を指定し、 **[OK]** を選択します。

    > [!NOTE]
    >    * レプリケーション グループの仮想マシンはまとめてレプリケートされ、フェールオーバー時にクラッシュ整合性復旧ポイントとアプリ整合性復旧ポイントを共有します。
    >    * VM と物理サーバーがワークロードをミラー化できるように、これらをまとめます。 マルチ VM 整合性を有効にすると、ワークロードのパフォーマンスに影響する場合があります。 これは、複数の仮想マシンが同じワークロードを実行していて、整合性を持たせる必要がある場合にのみ実行してください。

    ![[レプリケーションを有効にする] ウィンドウ](./media/vmware-azure-enable-replication/enable-replication7.png)
    
1. **[レプリケーションを有効にする]** を選択します。 **保護の有効化**ジョブの進行状況は、 **[設定]**  >  **[ジョブ]**  >  **[Site Recovery ジョブ]** で追跡できます。 **保護の最終処理**ジョブが実行されると、仮想マシンはフェールオーバーを実行できる状態になります。

## <a name="view-and-manage-vm-properties"></a>VM プロパティを表示して管理する

次に、ソース仮想マシンのプロパティを確認します。 Azure VM の名前は、[Azure 仮想マシンの要件](vmware-physical-azure-support-matrix.md#replicated-machines)に準拠している必要があります。

1. **[設定]**  >  **[レプリケートされたアイテム]** の順に移動し、仮想マシンを選択します。 **[要点]** ページに VM の設定と状態に関する情報が表示されます。
1. **[プロパティ]** で、VM のレプリケーションとフェールオーバーの情報を確認できます。
1. **[コンピューティングとネットワーク]**  >  **[コンピューティングのプロパティ]** で、複数の VM プロパティを変更することができます。 

    ![[コンピューティングとネットワークのプロパティ] ウィンドウ](./media/vmware-azure-enable-replication/vmproperties.png)

    * Azure VM 名:必要に応じて、Azure の要件を満たすように名前を変更します。
    * ターゲット VM のサイズまたは VM の種類:既定の VM サイズは、ターゲットとなる Azure リージョン内のディスク数、NIC 数、CPU コア数、メモリ、利用可能な VM ロール サイズを含むいくつかのパラメーターに基づいて選択されます。 Azure Site Recovery では、すべての条件を満たす最初の使用可能な VM サイズが選択されます。 必要に応じて、フェールオーバーの前にいつでも、別の VM サイズを選択することができます。 VM ディスクのサイズは、ソース ディスクのサイズにも基づいていて、フェールオーバー後にしか変更できないことに注意してください。 ディスク サイズと IOPS レートの詳細については、「[Windows 上の VM ディスクのスケーラビリティおよびパフォーマンスの目標](../virtual-machines/windows/disk-scalability-targets.md)」をご覧ください。

    *  リソース グループ: フェールオーバー後に仮想マシンが属する[リソース グループ](https://docs.microsoft.com/azure/virtual-machines/windows/infrastructure-resource-groups-guidelines)を選択できます。 この設定は、フェールオーバー前であればいつでも変更できます。 フェールオーバー後に、仮想マシンを別のリソース グループに移行すると、その仮想マシンの保護設定が解除されます。
    * 可用性セット:仮想マシンがフェールオーバー後に[可用性セット](https://docs.microsoft.com/azure/virtual-machines/windows/infrastructure-availability-sets-guidelines)に属する必要がある場合は、可用性セットを選択できます。 可用性セットを選択するときは、以下のことに注意してください。

        * 指定されたリソース グループに属している可用性セットだけが一覧表示されます。  
        * 異なる仮想ネットワーク上にある VM が同じ可用性セットに属することはできません。
        * 同じサイズの仮想マシンだけが同じ可用性セットに属することができます。
1. Azure VM に割り当てられるターゲット ネットワーク、サブネット、および IP アドレスに関する情報を追加することもできます。
2. **[ディスク]** で、レプリケートされる VM のオペレーティング システム ディスクとデータ ディスクを確認できます。

### <a name="configure-networks-and-ip-addresses"></a>ネットワークと IP アドレスを構成する

ターゲット IP アドレスを設定できます。 アドレスを指定しなかった場合、フェールオーバーされた仮想マシンでは DHCP が使用されます。 フェールオーバーで使用できないアドレスを設定した場合、フェールオーバーは機能しません。 テスト フェールオーバー ネットワークでアドレスを利用できる場合、テスト フェールオーバーに同じターゲット IP アドレスを使用できます。

ネットワーク アダプターの数は、次に示すように、ターゲット仮想マシンに指定したサイズによって決まります。

- ソース仮想マシン上のネットワーク アダプターの数が、ターゲット VM のサイズに許可されているアダプターの数以下の場合、ターゲットのアダプターの数は、ソースと同じです。
- ソース仮想マシン用のアダプターの数が、ターゲット VM のサイズに許可されている数を超える場合は、ターゲットの最大サイズが使用されます。 たとえば、ソース仮想マシンに 2 つのネットワーク アダプターがあり、ターゲット VM のサイズでは 4 つまでサポートされている場合、ターゲット仮想マシンのアダプターの数は、2 つになります。 ソース VM に 2 つのアダプターがあり、ターゲット サイズでは 1 つしかサポートされていない場合、ターゲット VM のアダプターは 1 つだけです。
- 仮想マシンにネットワーク アダプターが複数ある場合、これらのアダプターはすべて同じネットワークに接続されます。 また、一覧に表示されている最初のアダプターが、Azure 仮想マシンの*既定*のネットワーク アダプターとなります。 

### <a name="azure-hybrid-benefit"></a>Azure ハイブリッド特典

Microsoft Software Assurance のお客様は、Azure ハイブリッド特典を使用して、Azure に移行する Windows Server コンピューターのライセンス コストを節約できます。 この特典は Azure ディザスター リカバリーにも適用されます。 利用資格がある場合は、この特典を、フェールオーバー発生時に Site Recovery によって作成される仮想マシンに割り当てることができます。 そのためには、次の手順に従います。
1. レプリケートされた仮想マシンの **[コンピューティングとネットワークのプロパティ]** に移動します。
2. Azure ハイブリッド特典の利用資格がある Windows Server ライセンスを所有しているかどうかを尋ねられたら、回答します。
3. フェールオーバー発生時に作成される VM に特典を適用するために使用できる、対象のソフトウェア アシュアランス付き Windows Server ライセンスを所有していることを確認します。
4. レプリケートされた仮想マシンの設定を保存します。

Azure ハイブリッド特典の詳細については[こちら](https://aka.ms/azure-hybrid-benefit-pricing)をご覧ください。

## <a name="resolve-common-issues"></a>一般的な問題を解決

* 各ディスクは 4 TB より小さくなければなりません。
* OS ディスクは、ダイナミック ディスクではなく、ベーシック ディスクである必要があります。
* 第 2 世代/UEFI 対応仮想マシンでは、オペレーティング システム ファミリは Windows である必要があります。また、ブート ディスクは 300 GB より小さくなければなりません。

## <a name="next-steps"></a>次の手順

仮想マシンが保護された状態になったら、[フェールオーバー](site-recovery-failover.md)を試して、アプリケーションが Azure に表示されるかどうかを確認してください。

* 保護を無効にする場合は、[登録と保護の設定をクリーンアップ](site-recovery-manage-registration-and-protection.md)する方法を確認してください。
* [PowerShell を使用して仮想マシンのレプリケーションを自動化する](vmware-azure-disaster-recovery-powershell.md)方法を確認してください。
