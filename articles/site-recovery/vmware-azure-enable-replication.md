---
title: Azure Site Recovery を使用してディザスター リカバリーのために VMware VM を有効にする
description: この記事では、Azure Site Recovery サービスを使用して、ディザスター リカバリーのために VMware VM のレプリケーションを有効にする方法について説明します
author: Rajeswari-Mamilla
ms.service: site-recovery
ms.date: 04/01/2020
ms.topic: conceptual
ms.author: ramamill
ms.openlocfilehash: 6547bcf2061213cd01550367171d432900693ea5
ms.sourcegitcommit: 3c318f6c2a46e0d062a725d88cc8eb2d3fa2f96a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/02/2020
ms.locfileid: "80584147"
---
# <a name="enable-replication-to-azure-for-vmware-vms"></a>Azure への VMware VM のレプリケーションを有効にする

この記事では、オンプレミスの VMware 仮想マシン (VM) の Azure へのレプリケーションを有効にする方法について説明します。

## <a name="prerequisites"></a>前提条件

この記事では、システムが次の条件を満たしていることを前提としています。

- [オンプレミスのソース環境の設定](vmware-azure-set-up-source.md)。
- [Azure でのターゲット環境の設定](vmware-azure-set-up-target.md)。
- 開始する前に、[要件と前提条件を確認](vmware-physical-azure-support-matrix.md)してください。 重要な注意事項には、次のものがあります。
  - レプリケートするマシンの[サポート対象のオペレーティング システム](vmware-physical-azure-support-matrix.md#replicated-machines)。
  - [ストレージ/ディスク](vmware-physical-azure-support-matrix.md#storage)のサポート。
  - オンプレミスのマシンが準拠する必要がある [Azure の要件](vmware-physical-azure-support-matrix.md#azure-vm-requirements)。

### <a name="resolve-common-issues"></a>一般的な問題を解決

- 各ディスクは 4 TB より小さくなければなりません。
- オペレーティング システム ディスクは、ダイナミック ディスクではなく、ベーシック ディスクである必要があります。
- 第 2 世代 UEFI 対応仮想マシンでは、オペレーティング システム ファミリは Windows である必要があります。また、ブート ディスクは 300 GB より小さくなければなりません。

## <a name="before-you-start"></a>開始する前に

VMware 仮想マシンをレプリケートする場合、次の点に注意してください。

- Azure ユーザー アカウントには、新しい仮想マシンを Azure にレプリケートできるようにするための特定の[アクセス許可](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines)が必要です。
- VMware VM の検出は 15 分ごとに行われます。 検出後、VM が Azure portal に表示されるまで 15 分以上かかることがあります。 新しい vCenter サーバーまたは vSphere ホストを追加したときは、検出に 15 分以上かかることがあります。
- ポータルで仮想マシンの環境の変更を更新するには、15 分以上かかることがあります。 たとえば、VMware ツールのインストールなどです。
- 次のようにして VMware VM の最終検出時刻を確認できます。 **[構成サーバー]** ページにある vCenter サーバー/vSphere ホストの **[最後の使用]** フィールドを確認します。
- 定期検出を待たずにレプリケートする仮想マシンを追加するには、構成サーバーを強調表示し (クリックしないでください)、 **[更新]** を選択します。
- レプリケーションを有効にした場合、仮想マシンの準備が完了すると、プロセス サーバーによって Azure Site Recovery Mobility Service が VM に自動的にインストールされます。

## <a name="enable-replication"></a>レプリケーションを有効にする

このセクションの手順を行う前に、次の情報を確認してください。

- Azure Site Recovery は、すべての新しいレプリケーションについてマネージド ディスクに直接レプリケートするようになりました。 プロセス サーバーは、レプリケーション ログをターゲット リージョンのキャッシュ ストレージ アカウントに書き込みます。 これらのログは、`asrseeddisk` の名前付け規則を持つレプリカ マネージド ディスクの復旧ポイントを作成するために使用されます。
- マネージド ディスクへのレプリケーションの PowerShell によるサポートは、[Az.RecoveryServices モジュール バージョン 2.0.0](https://www.powershellgallery.com/packages/Az.RecoveryServices/2.0.0-preview) 以降で利用できます。
- フェールオーバー時には、選択された復旧ポイントを使用して、ターゲット マネージド ディスクが作成されます。
- ターゲット ストレージ アカウントにレプリケートするように構成済みの VM は影響を受けません。
- 新しい仮想マシンのストレージ アカウントへのレプリケーションは、Representational State Transfer (REST) API および PowerShell を使用した場合にのみ実行できます。 ストレージ アカウントにレプリケートする場合は、Azure REST API バージョン 2016-08-10 または 2018-01-10 を使用します。

レプリケーションを有効にするには、次の手順を行います。

1. **[手順 2:アプリケーションをレプリケートする]**  >  **[ソース]** の順にクリックします。 レプリケーションを初めて有効にした後は、コンテナーで **[+ レプリケート]** を選択して、追加の仮想マシンのレプリケーションを有効にします。
1. **[ソース]** ページで **[ソース]** をクリックし、構成サーバーを選択します。
1. **[マシンの種類]** で、 **[仮想マシン]** または **[物理マシン]** を選択します。
1. **[vCenter/vSphere Hypervisor] \(vCenter/vSphere ハイパーバイザー)** で、vSphere ホストを管理する vCenter サーバーを選択するか、ホストを選択します。 物理コンピューターをレプリケートする場合、この設定は関係ありません。
1. プロセス サーバーを選択します。 サーバーによって作成された追加のプロセスがない場合は、ドロップダウン メニューにおいて構成サーバーの組み込みのプロセス サーバーを利用できます。 各プロセス サーバーの正常性状態が、推奨される制限とその他のパラメーターに従って示されます。 正常なプロセス サーバーを選択します。 [クリティカル](vmware-physical-azure-monitor-process-server.md#process-server-alerts)であるプロセス サーバーは選択できません。 エラーを[トラブルシューティングして解決](vmware-physical-azure-troubleshoot-process-server.md)するか、**または**[スケールアウト プロセス サーバー](vmware-azure-set-up-process-server-scale.md)を設定できます。

   :::image type="content" source="./media/vmware-azure-enable-replication/ps-selection.png" alt-text="[レプリケーションを有効にする] [ソース] ウィンドウ":::

   > [!NOTE]
   > [バージョン 9.24](site-recovery-whats-new.md) 以降、プロセス サーバーの正常性アラートを強化する追加のアラートが導入されています。 すべてのアラートを生成するには、Site Recovery コンポーネントをバージョン 9.24 以降にアップグレードしてください。

1. **[ターゲット]** で、フェールオーバー対象の仮想マシンを作成するサブスクリプションとリソース グループを選択します。 フェールオーバーされた VM に対して Azure で使用するデプロイ モデルを選択します。
1. フェールオーバー後に Azure VM が接続する Azure ネットワークとサブネットを選択します。 ネットワークは、Site Recovery サービス コンテナーと同じリージョンにある必要があります。

   保護の対象として選択したすべての仮想マシンにネットワーク設定を適用する場合は、 **[選択したマシン用に今すぐ構成します。]** を選択します。 仮想マシンごとに Azure ネットワークを選択する場合は、 **[後で構成する]** を選択します。 ネットワークがない場合は、作成する必要があります。 Azure Resource Manager を使用してネットワークを作成する場合は、 **[新規作成]** を選択します。 該当する場合は、サブネットを選択し、 **[OK]** を選択します。

   :::image type="content" source="./media/vmware-azure-enable-replication/enable-rep3.png" alt-text="[レプリケーションを有効にする] [ターゲット] ウィンドウ":::

1. **[Virtual Machines]**  >  **[仮想マシンの選択]** で、レプリケートする各仮想マシンを選択します。 選択できるのは、レプリケーションを有効にできる仮想マシンのみです。 **[OK]** をクリックします。 特定の仮想マシンを表示または選択できない場合は、「[ソース マシンが Azure portal 内に表示されない](vmware-azure-troubleshoot-replication.md#step-3-troubleshoot-source-machines-that-arent-available-for-replication)」を参照して問題を解決してください。

   :::image type="content" source="./media/vmware-azure-enable-replication/enable-replication5.png" alt-text="[レプリケーションを有効にする] [仮想マシンの選択] ウィンドウ":::

1. **[プロパティ]**  >  **[プロパティの構成]** で、Site Recovery Mobility Service を VM に自動的にインストールするためにプロセス サーバーが使用するアカウントを選択します。 また、データ チャーン パターンに基づいてレプリケーションに使用するターゲット マネージド ディスクの種類を選択します。
1. 既定では、ソース VM のすべてのディスクがレプリケートされます。 レプリケーションからディスクを除外するには、レプリケートしないディスクの **[Include]\(含める\)** チェックボックスをオフにします。 **[OK]** をクリックします。 後で追加のプロパティを設定できます。 ディスクの除外の詳細については、[こちら](vmware-azure-exclude-disk.md)をご覧ください。

   :::image type="content" source="./media/vmware-azure-enable-replication/enable-replication6.png" alt-text="[レプリケーションを有効にする] [プロパティの構成] ウィンドウ":::

1. **[レプリケーション設定]**  >  **[レプリケーション設定の構成]** で、正しいレプリケーション ポリシーが選択されていることを確認します。 レプリケーション ポリシー設定を変更するには、 **[設定]**  >  **[レプリケーション ポリシー]**  >  _(ポリシー名)_  >  **[設定の編集]** の順にクリックします。 ポリシーに適用された変更は、レプリケートと新しい仮想マシンにも適用されます。
1. 仮想マシンをレプリケーション グループにまとめる場合は、 **[マルチ VM 整合性]** を有効にします。 グループの名前を指定し、 **[OK]** を選択します。

   > [!NOTE]
   > - レプリケーション グループの仮想マシンはまとめてレプリケートされ、フェールオーバー時にクラッシュ整合性復旧ポイントとアプリ整合性復旧ポイントを共有します。
   > - VM と物理サーバーがワークロードをミラー化できるように、これらをまとめます。 マルチ VM 整合性を有効にすると、ワークロードのパフォーマンスに影響する場合があります。 これは、複数の仮想マシンが同じワークロードを実行していて、整合性を持たせる必要がある場合にのみ実行してください。

   :::image type="content" source="./media/vmware-azure-enable-replication/enable-replication7.png" alt-text="[レプリケーションを有効にする] ウィンドウ":::

1. **[レプリケーションを有効にする]** を選択します。 **保護の有効化**ジョブの進行状況は、 **[設定]**  >  **[ジョブ]**  >  **[Site Recovery ジョブ]** で追跡できます。 **保護の最終処理**ジョブが実行されると、仮想マシンはフェールオーバーを実行できる状態になります。

## <a name="view-and-manage-vm-properties"></a>VM プロパティを表示して管理する

次に、ソース仮想マシンのプロパティを確認します。 Azure VM の名前は、[Azure 仮想マシンの要件](vmware-physical-azure-support-matrix.md#replicated-machines)に準拠している必要があります。

1. **[設定]**  >  **[レプリケートされたアイテム]** の順に移動し、仮想マシンを選択します。 **[要点]** ページに VM の設定と状態に関する情報が表示されます。
1. **[プロパティ]** で、VM のレプリケーションとフェールオーバーの情報を確認できます。
1. **[コンピューティングとネットワーク]**  >  **[コンピューティングのプロパティ]** で、複数の VM プロパティを変更することができます。

   :::image type="content" source="./media/vmware-azure-enable-replication/vmproperties.png" alt-text="[コンピューティングとネットワークのプロパティ] ウィンドウ":::

   - **Azure VM 名**:必要に応じて、Azure の要件を満たすように名前を変更します。
   - **ターゲット VM のサイズまたは VM の種類**:既定の VM サイズは、ターゲットとなる Azure リージョン内のディスク数、NIC 数、CPU コア数、メモリ、利用可能な VM ロール サイズを含むパラメーターに基づいて選択されます。 Azure Site Recovery では、すべての条件を満たす最初の使用可能な VM サイズが選択されます。 必要に応じて、フェールオーバーの前にいつでも、別の VM サイズを選択することができます。 VM ディスクのサイズは、ソース ディスクのサイズにも基づいており、フェールオーバー後にしか変更できません。 ディスク サイズと IOPS レートの詳細については、「[Windows 上の VM ディスクのスケーラビリティおよびパフォーマンスの目標](/azure/virtual-machines/windows/disk-scalability-targets)」をご覧ください。
   - **[リソース グループ]** :フェールオーバー後に仮想マシンが属する[リソース グループ](/azure/azure-resource-manager/management/overview#resource-groups)を選択できます。 この設定は、フェールオーバー前であればいつでも変更できます。 フェールオーバー後に、仮想マシンを別のリソース グループに移行すると、その仮想マシンの保護設定が解除されます。
   - **可用性セット**:仮想マシンがフェールオーバー後に[可用性セット](/azure/virtual-machines/windows/tutorial-availability-sets)に属する必要がある場合は、可用性セットを選択できます。 可用性セットを選択するときは、以下のことに注意してください。
     - 指定されたリソース グループに属している可用性セットだけが一覧表示されます。
     - 異なる仮想ネットワーク上にある VM が同じ可用性セットに属することはできません。
     - 同じサイズの仮想マシンだけが同じ可用性セットに属することができます。

1. Azure VM に割り当てられるターゲット ネットワーク、サブネット、および IP アドレスに関する情報を追加することもできます。
1. **[ディスク]** で、レプリケートされる VM のオペレーティング システム ディスクとデータ ディスクを確認できます。

### <a name="configure-networks-and-ip-addresses"></a>ネットワークと IP アドレスを構成する

ターゲット IP アドレスを設定できます。

- アドレスを指定しなかった場合、フェールオーバーされた VM では DHCP が使用されます。
- フェールオーバーで使用できないアドレスを設定した場合、フェールオーバーは機能しません。
- テスト フェールオーバー ネットワークでアドレスを利用できる場合、テスト フェールオーバーに同じターゲット IP アドレスを使用できます。

ネットワーク アダプターの数は、次に示すように、ターゲット仮想マシンに指定したサイズによって決まります。

- ソース仮想マシン上のネットワーク アダプターの数が、ターゲット VM のサイズに許可されているアダプターの数以下の場合、ターゲットのアダプターの数は、ソースと同じです。
- ソース仮想マシン用のアダプターの数が、ターゲット VM のサイズに許可されている数を超える場合は、ターゲットの最大サイズが使用されます。 たとえば、ソース仮想マシンに 2 つのネットワーク アダプターがあり、ターゲット VM のサイズでは 4 つまでサポートされている場合、ターゲット仮想マシンのアダプターの数は、2 つになります。 ソース VM に 2 つのアダプターがあり、ターゲット サイズでは 1 つしかサポートされていない場合、ターゲット VM のアダプターは 1 つだけです。
- 仮想マシンにネットワーク アダプターが複数ある場合、これらのアダプターはすべて同じネットワークに接続されます。 また、一覧に表示されている最初のアダプターが、Azure 仮想マシンの既定のネットワーク アダプターとなります。

### <a name="azure-hybrid-benefit"></a>Azure ハイブリッド特典

Microsoft Software Assurance のお客様は、Azure ハイブリッド特典を使用して、Azure に移行する Windows Server コンピューターのライセンス コストを節約できます。 この特典は Azure ディザスター リカバリーにも適用されます。 利用資格がある場合は、この特典を、フェールオーバー発生時に Site Recovery によって作成される仮想マシンに割り当てることができます。

1. レプリケートされた仮想マシンの **[コンピューティングとネットワークのプロパティ]** に移動します。
1. Azure ハイブリッド特典の利用資格がある Windows Server ライセンスを所有しているかどうかを尋ねられたら、回答します。
1. フェールオーバー発生時に作成される VM に特典を適用するために使用できる、対象のソフトウェア アシュアランス付き Windows Server ライセンスを所有していることを確認します。
1. レプリケートされた仮想マシンの設定を保存します。

Azure ハイブリッド特典の詳細については、[こちら](https://azure.microsoft.com/pricing/hybrid-benefit/)を参照してください。

## <a name="next-steps"></a>次のステップ

仮想マシンが保護された状態になったら、[フェールオーバー](site-recovery-failover.md)を試して、アプリケーションが Azure に表示されるかどうかを確認してください。

- 登録と保護の設定をクリーンアップして保護を無効にする方法については、[こちら](site-recovery-manage-registration-and-protection.md)を参照してください。
- PowerShell を使用して仮想マシンのレプリケーションを自動化する方法については、[こちら](vmware-azure-disaster-recovery-powershell.md)を参照してください。
