---
title: Azure Site Recovery を使用して AWS の VM を Azure に移行する | Microsoft Docs
description: この記事では、Azure Site Recovery を使用して、アマゾン ウェブ サービス (AWS) で実行中の VM を Azure に移行する方法を説明します。
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 02/07/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 2c351313d1d75bb7fd13a34feb3a1c61188894a8
ms.sourcegitcommit: 088a8788d69a63a8e1333ad272d4a299cb19316e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/27/2018
ms.locfileid: "29677619"
---
# <a name="migrate-amazon-web-services-aws-vms-to-azure"></a>アマゾン ウェブ サービス (AWS) VM を Azure に移行する

このチュートリアルでは、Site Recovery を使用してアマゾン ウェブ サービス (AWS) 仮想マシン (VM) を Azure VM に移行する方法について説明します。 EC2 インスタンスを Azure に移行すると、VM はオンプレミスの物理コンピューターのように扱われます。 このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * Azure リソースを準備する
> * 移行のために AWS EC2 インスタンスを準備する
> * 構成サーバーをデプロイする
> * VM のレプリケーションを有効にする
> * フェールオーバーをテストして、すべて問題なく動作していることを確認する
> * Azure へのワンタイム フェールオーバーを実行する

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/pricing/free-trial/) を作成してください。


## <a name="prepare-azure-resources"></a>Azure リソースを準備する

移行した EC2 インスタンスを使用するには、Azure でいくつかのリソースを準備する必要があります。 たとえば、ストレージ アカウント、コンテナー、仮想ネットワークなどです。

### <a name="create-a-storage-account"></a>ストレージ アカウントの作成

レプリケートされたマシンのイメージは Azure Storage に保存されます。 オンプレミスから Azure にフェールオーバーするとき、ストレージから Azure VM が作成されます。

1. [Azure Portal](https://portal.azure.com) のメニューで、**[リソースの作成]** > **[ストレージ]** > **[ストレージ アカウント]** の順にクリックします。
2. ストレージ アカウントの名前を入力します。 この一連のチュートリアルでは、**awsmigrated2017** という名前を使用します。 名前は Azure 内で一意にする必要があります。長さは 3 ～ 24 文字で、使用できるのは数字と小文字のみです。
3. **[デプロイ モデル]**、**[アカウントの種類]**、**[パフォーマンス]**、**[安全な転送が必須]** は既定値のままにします。
5. **[レプリケーション]** には既定の **[RA-GRS]** を選択します。
6. このチュートリアルで使用するサブスクリプションを選択します。
7. **[リソース グループ]** には **[新規作成]** を選択します。 この例では、**migrationRG** という名前を使用します。
8. 場所には **[西ヨーロッパ]** を選択します。
9. **[作成]** をクリックしてストレージ アカウントを作成します。

### <a name="create-a-vault"></a>コンテナーの作成

1. [Azure Portal](https://portal.azure.com) の左側のナビゲーションで **[すべてのサービス]** をクリックし、**[Recovery Services コンテナー]** を探して選択します。
2. [Recovery Services コンテナー] ページの左上にある **[+ 追加]** をクリックします。
3. **[名前]** に「*myVault*」と入力します。
4. **[サブスクリプション]** では適切なサブスクリプションを選択します。
4. **[リソース グループ]** では **[既存のものを使用]** を選択し、*[migrationRG]* を選択します。
5. *[場所]* では **[西ヨーロッパ]** を選択します。
5. ダッシュボードから新しいコンテナーにすばやくアクセスするには、**[ダッシュボードにピン留めする]** を選択します。
7. 完了したら、**[作成]** をクリックします。

新しいコンテナーは、**[ダッシュボード]** > **[すべてのリソース]** と、メインの **[Recovery Services コンテナー]** ページに表示されます。

### <a name="set-up-an-azure-network"></a>Azure ネットワークをセットアップ

移行 (フェールオーバー) 後に作成された Azure VM は、このネットワークに参加します。

1. [Azure Portal](https://portal.azure.com) で、**[リソースの作成]** > **[ネットワーク]** >
    **[仮想ネットワーク]** の順にクリックします。
3. **[名前]** に「*myMigrationNetwork*」と入力します。
4. **[アドレス空間]** は既定値のままにします。
5. **[サブスクリプション]** では適切なサブスクリプションを選択します。
6. **[リソース グループ]** で **[既存のものを使用]** を選択し、ドロップダウンから *[migrationRG]* を選択します。
7. **[場所]** には **[西ヨーロッパ]** を選択します。
8. **[サブネット]** の **[名前]** と **[IP 範囲]** は既定値のままにします。
9. **[サービス エンドポイント]** は無効なままにします。
10. 完了したら、**[作成]** をクリックします。


## <a name="prepare-the-ec2-instances"></a>EC2 インスタンスを準備する

移行する VM が 1 つまたは複数必要です。 これらの EC2 インスタンスは、64 ビット バージョンの Windows Server 2008 R2 SP1 以降、Windows Server 2012、Windows Server 2012 R2、Windows Server 2016 または Red Hat Enterprise Linux 6.7 (HVM の仮想化されたインスタンスのみ) を実行している必要があります。 サーバーには、Citrix PV または AWS PV ドライバーのみが必要です。 RedHat PV ドライバーを実行しているインスタンスはサポートされません。

モビリティ サービスは、レプリケートする各 VM にインストールする必要があります。 VM のレプリケーションを有効にすると、Site Recovery が自動的にこのサービスをインストールします。 自動的にインストールする場合は、Site Recovery で VM へのアクセスに使用するアカウントを EC2 インスタンスに準備する必要があります。

ドメイン アカウントまたはローカル アカウントを使用できます。 Linux VM の場合、アカウントは、ソース Linux サーバーの root である必要があります。 Windows VM の場合、ドメイン アカウントを使用していなければ、次のようにしてローカル マシンでのリモート ユーザー アクセス制御を無効にします。

  - レジストリで、**HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** の下に、ダブルワード エントリの **LocalAccountTokenFilterPolicy** を追加して値 1 を指定します。

Site Recovery 構成サーバーとして使用できる別の EC2 インスタンスも必要です。 このインスタンスは、Windows Server 2012 R2 を実行している必要があります。


## <a name="prepare-the-infrastructure"></a>インフラストラクチャの準備

コンテナーのポータル ページで、**[作業の開始]** セクションから **[Site Recovery]** を選択し、**[インフラストラクチャの準備]** をクリックします。

### <a name="1-protection-goal"></a>1 保護の目標

**[保護の目標]** ページで、次の値を選択します。

|    |  |
|---------|-----------|
| マシンはどこにありますか? | **オンプレミスの**|
| マシンをどこにレプリケートしますか? |**Azure へ**|
| マシンは仮想化しますか? | **非仮想化/その他**|

完了したら、**[OK]** をクリックして次のセクションに進みます。

### <a name="2-source-prepare"></a>2 ソースの準備

**[ソースの準備]** ページで、**[+ 構成サーバー]** をクリックします。

1. Windows Server 2012 R2 を実行している EC2 インスタンスを使用して構成サーバーを作成し、Recovery コンテナーに登録します。

2. 構成サーバーとして使用している EC2 インスタンス VM でプロキシを構成し、[サービス URL](site-recovery-support-matrix-to-azure.md) にアクセスできるようにします。

3. [Microsoft Azure Site Recovery 統合セットアップ](http://aka.ms/unifiedinstaller_wus) プログラムをダウンロードします。 ローカル コンピューターにダウンロードし、構成サーバーとして使用している VM にコピーすることができます。

4. **[ダウンロード]** ボタンをクリックして、コンテナーの登録キーをダウンロードします。 ダウンロードしたファイルを、構成サーバーとして使用している VM にコピーします。

5. VM で、**Microsoft Azure Site Recovery 統合セットアップ**のダウンロードしたインストーラーを右クリックし、**[管理者として実行]** を選択します。

    1. **[開始する前に]** で、**[Install the configuration server and process server]\(構成サーバーとプロセス サーバーをインストールする\)** を選択して **[次へ]** をクリックします。
    2. **[Third-Party Software License]\(サードパーティ製ソフトウェア ライセンス\)** で、**[I Accept the third party license agreement]\(サード パーティの使用許諾契約書に同意する\)** を選択します。 次に、**[次へ]** をクリックします。
    3. **[登録]** で [参照] をクリックし、コンテナーの登録キー ファイルが配置されている場所に移動し、**[次へ]** をクリックします。
    4. **[インターネット設定]** で、**[Connect to Azure Site Recovery without a proxy server]\(プロキシ サーバーを使用せずに Azure Site Recovery に接続する\)** を選択します。 次に、**[次へ]** をクリックします。
    5. **[前提条件の確認]** ページで複数の項目について確認が実行されます。 完了したら、**[次へ]** をクリックします。
    6. **[MySQL の構成]** に、必要なパスワードを入力し、**[次へ]** をクリックします。
    7. VMware マシンを保護する必要はないため、**[環境の詳細]** で **[いいえ]** を選択し、**[次へ]** をクリックします。
    8. **[インストールの場所]** で、既定値のまま **[次へ]** をクリックします。
    9. **[ネットワークの選択]** で、既定値のまま **[次へ]** をクリックします。
    10. **[概要]** で **[インストール]** をクリックします。
    11. **[インストールの進行状況]** にインストール プロセスの進行状況に関する情報が表示されます。 完了したら **[完了]** をクリックします。 再起動が必要というポップアップが表示されることがあります。この場合は **[OK]** をクリックします。 構成サーバーの接続パスフレーズに関するポップアップが表示されたら、パスフレーズをクリップボードにコピーし、どこか安全な場所に保存します。

6. VM 上で **cspsconfigtool.exe** を実行して、構成サーバーに 1 つ以上の管理アカウントを作成します。 管理アカウントに、移行する EC2 インスタンス上の管理者アクセス許可を持たせるようにします。

構成サーバーの設定が完了したら、ポータルに戻り、作成したサーバーを **[構成サーバー]** で選択し、*[OK]** をクリックして手順 3 の「ターゲットの準備」に進みます。

### <a name="3-target-prepare"></a>3 ターゲットの準備

このセクションでは、このチュートリアルの「[Azure リソースの準備](#prepare-azure-resources)」セクションで作成したリソースに関する情報を入力します。

1. **[サブスクリプション]** で「[Azure の準備](tutorial-prepare-azure.md)」チュートリアルに使用した Azure サブスクリプションを選択します。
2. デプロイ モデルとして **[Resource Manager]** を選択します。
3. Site Recovery によって、互換性のある Azure ストレージ アカウントとネットワークが 1 つ以上あるかどうかが確認されます。 このチュートリアルの「[Azure リソースの準備](#prepare-azure-resources)」セクションで作成したリソースの情報が確認されます。
4. 完了したら、 **[OK]** をクリックします。


### <a name="4-replication-settings-prepare"></a>4 レプリケーション設定の準備

レプリケーションを有効にする前に、レプリケーション ポリシーを作成する必要があります。

1. **[+ Replicate and Associate]\(レプリケートと関連付け\)** をクリックします。
2. **[名前]** に「**myReplicationPolicy**」と入力します。
3. その他の設定は既定のままにして、**[OK]** をクリックしてポリシーを作成します。 この新しいポリシーは自動的に構成サーバーに関連付けられます。

### <a name="5-deployment-planning-select"></a>5 デプロイ計画の選択

**[デプロイ計画は完了していますか?]** でドロップダウンから **[後で実行する]** を選択し、**[OK]** をクリックします。

**[インフラストラクチャの準備]** の 5 セクションすべてを設定したら、**[OK]** をクリックします。


## <a name="enable-replication"></a>レプリケーションを有効にする

移行する各 VM のレプリケーションを有効にします。 レプリケーションを有効にすると、Site Recovery がモビリティ サービスを自動的にインストールします。

1. [Azure Portal](htts://portal.azure.com)を開きます。
1. コンテナーのページの **[作業の開始]** で **[Site Recovery]** をクリックします。
2. **[For on-premises machines and Azure VMs]\(オンプレミス マシンと Azure VM\)** で **[手順 1: アプリケーションをレプリケートする]** をクリックします。 ウィザードのページに次の情報を設定し、完了したら各ページで **[OK]** をクリックします。
    - 1 ソースの構成:

    |  |  |
    |-----|-----|
    | ソース: | **オンプレミス**|
    | ソースの場所:| 構成サーバー EC2 インスタンスの名前。|
    |マシンの種類: | **物理マシン**|
    | プロセス サーバー: | ドロップダウン一覧から構成サーバーを選択します。|

    - 2 ターゲットの構成

    |  |  |
    |-----|-----|
    | ターゲット: | 既定値のままにします。|
    | サブスクリプション: | 使用しているサブスクリプションを選択します。|
    | フェールオーバー後のリソース グループ:| 「[Azure リソースの準備](#prepare-azure-resources)」セクションで作成したリソース グループを使用します。|
    | フェールオーバー後のデプロイ モデル: | **[Resource Manager]** を選択します|
    | ストレージ アカウント: | 「[Azure リソースの準備](#prepare-azure-resources)」セクションで作成したストレージ アカウントを選択します。|
    | Azure ネットワーク: | **[選択したマシン用に今すぐ構成します]** を選択します|
    | フェールオーバー後の Azure ネットワーク: | 「[Azure リソースの準備](#prepare-azure-resources)」セクションで作成したネットワークを選択します。|
    | サブネット: | ドロップダウンから **[既定値]** を選択します。|

    - 3 物理マシンの選択

        **[+ 物理マシン]** をクリックし、移行する EC2 インスタンスの **[名前]**、**[IP アドレス]**、**[OS の種類]** を入力し、**[OK]** をクリックします。

    - 4 プロパティのプロパティの構成

        ドロップダウンから構成サーバーに作成したアカウントを選択し、**[OK]** をクリックします。

    - 5 レプリケーション設定のレプリケーション設定の構成

        ドロップダウンで選択したレプリケーション ポリシーが **myReplicationPolicy** であることを確認し、**[OK]** をクリックします。

3. ウィザードが完了したら、**[レプリケーションを有効にする]** をクリックします。


**保護の有効化**ジョブの進行状況は、**[監視およびレポート]** > **[ジョブ]** > **[Site Recovery ジョブ]** で追跡できます。 **保護の最終処理** ジョブが実行されると、マシンはフェールオーバーできる状態になります。        

VM のレプリケーションを有効にすると、変更が反映されてポータルに表示されるまで 15 分以上かかる場合があります。

## <a name="run-a-test-failover"></a>テスト フェールオーバーの実行

テスト フェールオーバーを実行すると、次の処理が発生します。

1. フェールオーバーを実行するために必要なすべての条件が満たされていることを確認する前提条件チェックが実行されます。
2. Azure VM を作成できるように、フェールオーバーによってデータが処理されます。 最新の復旧ポイントを選択した場合は、データから復旧ポイントが作成されます。
3. 前の手順で処理されたデータを使用して、Azure VM が作成されます。

Portal で次のようにテスト フェールオーバーを実行します。

1. コンテナーのページで、**[保護されたアイテム]** > **[レプリケートされたアイテム]** に移動し、VM をクリックし、**[+ フェールオーバーのテスト]** をクリックします。

2. フェールオーバーで使用する復旧ポイントを選択します。
    - **[最後に処理があった時点]**: Site Recovery によって処理された最新の復旧ポイントに VM をフェールオーバーします。 タイム スタンプが表示されます。 このオプションを使用すると、データの処理に時間がかからないため、RTO (目標復旧時間) が低くなります。
    - **[Latest app-consistent]\(最新のアプリ整合性\)** : このオプションは、すべての VM を最新のアプリ整合性の復旧ポイントにフェールオーバーします。 タイム スタンプが表示されます。
    - **[カスタム]** : 任意の復旧ポイントを選択します。
3. **[テスト フェールオーバー]** で、フェールオーバー後に Azure VM が接続するターゲット Azure ネットワークを選択します。 「[Azure リソースの準備](#prepare-azure-resources)」セクションで作成したネットワークを選択します。
4. **[OK]** をクリックすると、フェールオーバーが開始されます。 VM をクリックしてそのプロパティを開くことで、進行状況を追跡できます。 または、**[監視とレポート]** > **[ジョブ]** >
    **[Site Recovery ジョブ]** のコンテナーのページで **[フェールオーバーのテスト]** ジョブをクリックします。
5. フェールオーバーの完了後、レプリカの Azure VM は、Azure Portal の **[仮想マシン]** に表示されます。 VM が適切なサイズであること、適切なネットワークに接続されていること、および実行されていることを確認します。
6. これで、Azure 内のレプリケートされた VM に接続できるはずです。
7. テスト フェールオーバー中に作成された VM を削除するには、復旧計画で **[テスト フェールオーバーのクリーンアップ]** をクリックします。 **[メモ]** を使用して、テスト フェールオーバーに関連する観察結果をすべて記録し、保存します。

一部のシナリオでは、フェールオーバーが完了するまでに、さらに約 8 ～ 10 分の処理が必要です。


## <a name="migrate-to-azure"></a>Azure への移行

EC2 インスタンスで実際のフェールオーバーを実行して Azure VM に移行します。

1. **[保護されているアイテム]** > **[レプリケートされたアイテム]** で、AWS インスタンスをクリックし、**[フェールオーバー]** をクリックします。
2. **[フェールオーバー]** で、フェールオーバーする**復旧ポイント**を選択します。 最新の復旧ポイントを選択します。
3. Site Recovery でフェールオーバーを開始する前にそのソース仮想マシンをシャットダウンする場合は、**[フェールオーバーを開始する前にマシンをシャットダウンします]** を選択します。 仮にシャットダウンが失敗したとしても、フェールオーバーは続行されます。 フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。
4. **[レプリケートされたアイテム]** に VM が表示されることを確認します。
5. 各 VM を右クリックし、**[移行の完了]** をクリックします。 これによって、移行プロセスが終了し、AWS VM のレプリケーションが停止して、その VM での Site Recovery の課金が停止します。

    ![移行の完了](./media/tutorial-migrate-aws-to-azure/complete-migration.png)

> [!WARNING]
> **進行中のフェールオーバーをキャンセルしないでください**。フェールオーバーが開始される前に VM のレプリケーションが停止します。 進行中のフェールオーバーをキャンセルすると、フェールオーバーは停止しますが、VM が再びレプリケートされることはありません。  




## <a name="next-steps"></a>次の手順

このトピックでは、AWS EC2 インスタンスを Azure VM に移行する方法について説明しました。 Azure VM の詳細については、Windows VM のチュートリアルを参照してください。

> [!div class="nextstepaction"]
> [Azure Windows 仮想マシンのチュートリアル](../virtual-machines/windows/tutorial-manage-vm.md)
