---
title: クライアント側のパフォーマンス トレースの作成
description: WPF を使用したクライアント側のパフォーマンス プロファイリングに関するベスト プラクティス
author: florianborn71
ms.author: flborn
ms.date: 12/11/2019
ms.topic: conceptual
ms.openlocfilehash: 1f4207a11f3ae3664023fccf6178b6db7cf253b9
ms.sourcegitcommit: 642a297b1c279454df792ca21fdaa9513b5c2f8b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2020
ms.locfileid: "80679237"
---
# <a name="create-client-side-performance-traces"></a>クライアント側のパフォーマンス トレースの作成

Azure Remote Rendering のパフォーマンスが期待どおりにならない理由は多数あります。 クラウド サーバーの純粋なレンダリングのパフォーマンスとは別に、特にネットワーク接続の品質はエクスペリエンスに大きな影響を与えます。 サーバーのパフォーマンスをプロファイリングするには、[サーバー側のパフォーマンス クエリ](../overview/features/performance-queries.md)に関する章を参照してください。

この章では、*パフォーマンス トレース*を使用して、潜在的なクライアント側のボトルネックを特定する方法について説明します。

## <a name="getting-started"></a>作業の開始

Windows パフォーマンス トレース機能を初めて使用する場合は、このセクションにある、作業を開始するための最も基本的な用語とアプリケーションについての説明を参照してください。

### <a name="installation"></a>インストール

ARR でのトレースを行うために使用されるアプリケーションは、すべての Windows 開発に使用できる汎用ツールです。 これらは、[Windows Performance Toolkit](https://docs.microsoft.com/windows-hardware/test/wpt/) で提供されています。 このツールキットを入手するには、[Windows アセスメント & デプロイメント キット](https://docs.microsoft.com/windows-hardware/get-started/adk-install)をダウンロードしてください。

### <a name="terminology"></a>用語

パフォーマンスのトレースに関する情報を検索するとき、必然的にさまざまな用語に遭遇することになります。 最も重要なものは次のとおりです。

* `ETW`
* `ETL`
* `WPR`
* `WPA`

**ETW** は [**E**vent **T**racing for **W**indows](https://docs.microsoft.com/windows/win32/etw/about-event-tracing) (Windows イベント トレーシング) の略です。 これは、Windows に組み込まれている効率的なカーネル レベルのトレース機能を表す、包括的な名前にすぎません。 これは "*イベント*" トレースと呼ばれます。その理由は、ETW をサポートするアプリケーションでは、パフォーマンスに関する問題の追跡に役立つ可能性があるアクションをログに記録するために、イベントが出力されるためです。 既定では、オペレーティング システムによって、ディスク アクセス、タスク切り替えなどのイベントが既に生成されています。 ARR のようなアプリケーションでは、削除されたフレームやネットワークの遅延などに関するカスタム イベントも追加で生成されます。

**ETL** は **E**vent **T**race **L**ogging (イベント トレース ログ) の略です。 これは単純にトレースが収集 (記録) されていることを意味し、そのため、トレース データを格納するファイルのファイル拡張子として一般的に使用されます。 このため、トレースを実行すると、通常は、後で \*.etl ファイルが作成されます。

**WPR** は [**W**indows **P**erformance **R**ecorder](https://docs.microsoft.com/windows-hardware/test/wpt/windows-performance-recorder) の略であり、イベント トレースの記録を開始および停止するアプリケーションの名前です。 WPR には、正確にどのイベントをログに記録するかを構成するプロファイル ファイル (\*.wprp) を指定します。 このような `wprp` ファイルは ARR SDK に付属しています。 デスクトップ PC でトレースを行う場合は、WPR を直接起動することができます。 HoloLens でトレースを行う場合、通常は Web インターフェイスを使用します。

**WPA** は [**W**indows **P**erformance **A**nalyzer](https://docs.microsoft.com/windows-hardware/test/wpt/windows-performance-analyzer) の略であり、\*.etl ファイルを開き、データを詳しく調べてパフォーマンスの問題を特定する GUI アプリケーションの名前です。 WPA を使用すると、さまざまな条件でデータを並べ替えたり、複数の方法でデータを表示したり、詳細を掘り下げて情報を関連付けることができます。

ETL トレースは、任意の Windows デバイス (ローカル PC、HoloLens、クラウド サーバーなど) で作成できますが、通常はディスクに保存され、デスクトップ PC で WPA を使用して分析されます。 ETL ファイルは、他の開発者に送信して、見てもらうことができます。 ただし、ファイルパスや IP アドレスなどの機密情報が ETL トレースでキャプチャされる可能性があることに注意してください。 ETW は、トレースの記録とトレースの分析という 2 つの方法で使用できます。 トレースを記録することは簡単であり、必要な設定は最小限です。 一方、トレースを分析するには、WPA ツールと調査する問題の両方について十分に理解している必要があります。 以下では、WPA について学習するための一般的な資料と、ARR 固有のトレースを解釈する方法のガイドラインを示します。

## <a name="recording-a-trace-on-a-local-pc"></a>ローカル PC でのトレースの記録

ARR パフォーマンスの問題を特定するには、HoloLens でトレースを直接実行することをお勧めします。これは、真のパフォーマンス特性のスナップショットを取得する唯一の方法であるためです。 ただし、明確に HoloLens のパフォーマンス制限なしでトレースを実行することを望んでいる場合、または WPA の使用方法を学習するだけで現実的なトレースが不要な場合は、次の方法を使用してください。

### <a name="wpr-configuration"></a>WPR の構成

1. *[スタート]* メニューから [Windows Performance Recorder](https://docs.microsoft.com/windows-hardware/test/wpt/windows-performance-recorder) を起動します。
1. **[More Options]\(その他のオプション\)** を展開します。
1. **[Add Profiles]\(プロファイルの追加\)** をクリックします。
1. *AzureRemoteRenderingNetworkProfiling.wprp* ファイルを選択します。 このファイルは、ARR SDK の *Tools/ETLProfiles* にあります。
   これで、プロファイルが WPR の *[Custom measurements]\(カスタムの測定\)* に表示されます。 それが有効な唯一のプロファイルであることを確認します。
1. *[First level triage]\(最優先\)* を展開します。
    * ARR ネットワーク イベントの簡易トレースをキャプチャすることだけが目的の場合は、このオプションを**無効**にします。
    * ARR ネットワーク イベントを CPU やメモリ使用量などの他のシステム特性と関連付ける必要がある場合は、このオプションを**有効**にします。
    * このオプションを有効にすると、多くの場合、トレースのサイズが数 GB になり、WPA に保存して開くのに長い時間がかかります。

その後、WPR 構成は次のようになります。

![WPR の構成](./media/wpr.png)

### <a name="recording"></a>記録

トレースの記録を開始するには、 **[Start]\(開始\)** をクリックします。 記録の開始と停止は、いつでもできます。その前にアプリケーションを閉じる必要はありません。 ご覧のように、ETW では常にシステム全体のトレースが記録されるため、どのアプリケーションをトレースするかを指定する必要はありません。 `wprp` ファイルで、どの種類のイベントを記録するかを指定します。

**[Save]\(保存\)** をクリックして記録を停止し、ETL ファイルを格納する場所を指定します。

これで、WPA で直接開いたり、他のユーザーに送信したりできる ETL ファイルが作成されました。

## <a name="recording-a-trace-on-a-hololens"></a>HoloLens でのトレースの記録

HoloLens でトレースを記録するには、デバイスを起動し、その IP アドレスをブラウザーに入力して "*デバイス ポータル*" を開きます。

![デバイス ポータル](./media/wpr-hl.png)

1. 左側で、 *[Performance]\(パフォーマンス\) > [Performanc]\(パフォーマンスのトレース\)* に移動します。
1. **[Custom profiles]\(カスタム プロファイル\)** を選択します。
1. **[Browse]\(参照\)** をクリックします。
1. *AzureRemoteRenderingNetworkProfiling.wprp* ファイルを選択します。 このファイルは、ARR SDK の *Tools/ETLProfiles* にあります。
1. **[Start Trace]\(トレースの開始\)** をクリックします。
1. これで、HoloLens でトレースが記録されます。 調査する必要があるパフォーマンスの問題を必ずトリガーしてください。 次に、 **[Stop Trace]\(トレースの停止\)** をクリックします。
1. トレースは Web ページの下部に一覧表示されます。 右側にあるディスク アイコンをクリックして、ETL ファイルをダウンロードします。

これで、WPA で直接開いたり、他のユーザーに送信したりできる ETL ファイルが作成されました。

## <a name="analyzing-traces-with-wpa"></a>WPA を使用したトレースの分析

### <a name="wpa-basics"></a>WPA の基本

Windows Performance Analyzer は、ETL ファイルを開き、トレースを検査するための標準的なツールです。 この記事では、WPA のしくみについては説明しません。 開始するには、次のリソースを参照してください。

* 最初の概要については、[入門ビデオ](https://docs.microsoft.com/windows-hardware/test/wpt/windows-performance-analyzer)をご覧ください。
* WPA 自体には、一般的な手順を説明する *[Getting Started]\(作業の開始\)* タブがあります。 使用可能なトピックを確認してください。 特に [View Data]\(データの表示\) では、特定のデータのグラフを作成する方法について簡単に説明しています。
* [この Web サイト](https://randomascii.wordpress.com/2015/09/24/etw-central/)には有用な情報が記載されていますが、初心者にとっては、そのすべてが関連する情報であるとは限りません。

### <a name="graphing-data"></a>データのグラフ化

ARR トレースの使用を開始するには、次の点を理解しておくことをお勧めします。

![パフォーマンス グラフ](./media/wpa-graph.png)

上の図は、トレース データのテーブルと、同じデータのグラフ表現を示しています。

下部にあるテーブルで、黄色 (金色) のバーと青色のバーを確認します。 これらのバーをドラッグして任意の位置に配置することができます。

**黄色のバーの左側にある列**は、すべて**キー**として解釈されます。 キーは、左上のウィンドウでツリーを構成するために使用されます。 ここでは、"Provider Name" (プロバイダー名) と "Task Name" (タスク名) という 2 つの "*キー*" 列があります。 したがって、左上のウィンドウのツリー構造は 2 レベルの深さになります。 列の順序を変更したり、キー領域の列を追加または削除したりすると、ツリー ビューの構造が変わります。

**青いバーの右側にある列**は、右上のウィンドウでの**グラフ表示**に使用されます。 ほとんどの場合、最初の列のみが使用されますが、一部のグラフ モードでは複数のデータ列が必要になります。 折れ線グラフを機能させるには、その列での "*集計モード*" を設定する必要があります。 'Avg' または 'Max' を使用します。 1 つのピクセルが複数のイベントを持つ範囲を対象としている場合、集計モードは、特定のピクセルのグラフの値を決定するために使用されます。 これを確認するには、集計を 'Sum' に設定し、ズームインとズームアウトを行います。

中央の列には特別な意味はありません。

![イベント ビュー](./media/wpa-event-view.png)

"*汎用イベント ビュー エディター*" では、表示するすべての列、集計モード、並べ替えのほか、どの列をキーとしてまたはグラフ化のために使用するかを構成できます。 上記の例では "**フィールド 2**" が有効になっており、フィールド 3 から 6 は無効になっています。 通常、フィールド 2 は ETW イベントの最初の "*カスタム データ*" フィールドであり、そのため、多少のネットワーク待機時間の値を表す ARR "FrameStatistics" イベントに使用されます。 このイベントのさらに多くの値を表示するには、他の "フィールド" 列を有効にします。

### <a name="presets"></a>プリセット

トレースを適切に分析するには、ご自身のワークフローと優先するデータ表示を理解する必要があります。 ただし、ARR 固有のイベントの概要を簡単に把握できるようにするための、Windows ソフトウェア保護プラットフォームのプロファイル ファイルとプリセット ファイルが *Tools/ETLProfiles* フォルダーに含まれています。 完全なプロファイルを読み込むには、WPA のメニュー バーから *[Profiles]\(プロファイル\) > [Apply]\(適用\)* を選択するか、 *[My Presets]\(マイ プリセット\)* パネル ( *[Window]\(ウィンドウ\) > [My Presets]\(マイ プリセット\)* ) を開いて *[Import]\(インポート\)* を選択します。 前者の場合、次の図のように、完全な WPA 構成が設定されます。 後者の場合、使用可能なさまざまなビュー構成のプリセットが作成されるだけであり、特定の ARR イベント データを確認するビューをすばやく開くことができます。

![プリセット](./media/wpa-arr-trace.png)

上の図は、さまざまな ARR 固有のイベントのほか、全体的な CPU 使用率のビューを示しています。

## <a name="next-steps"></a>次のステップ

* [サーバー側のパフォーマンス クエリ](../overview/features/performance-queries.md)
