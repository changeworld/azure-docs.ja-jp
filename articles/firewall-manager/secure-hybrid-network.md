---
title: チュートリアル:Azure Firewall Manager プレビューを使用してハブ仮想ネットワークをセキュリティで保護する
description: このチュートリアルでは、Azure portal を使用して Azure Firewall Manager で仮想ネットワークにセキュリティを確保する方法について説明します。
services: firewall-manager
author: vhorne
ms.service: firewall-manager
ms.topic: tutorial
ms.date: 02/18/2020
ms.author: victorh
ms.openlocfilehash: cdd416bdb833e4784334a6847d724a7375e2ef8d
ms.sourcegitcommit: 0947111b263015136bca0e6ec5a8c570b3f700ff
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/24/2020
ms.locfileid: "77459955"
---
# <a name="tutorial-secure-your-hub-virtual-network-using-azure-firewall-manager-preview"></a>チュートリアル:Azure Firewall Manager プレビューを使用してハブ仮想ネットワークをセキュリティで保護する 

[!INCLUDE [Preview](../../includes/firewall-manager-preview-notice.md)]

オンプレミス ネットワークを Azure 仮想ネットワークに接続してハイブリッド ネットワークを作成する場合、ご利用の Azure ネットワーク リソースへのアクセスを制御する機能が、全体的なセキュリティ プランの中で重要な役割を果たします。

Azure Firewall Manager プレビューを使用して、ハブ仮想ネットワークを作成し、プライベート IP アドレス、Azure PaaS、およびインターネットに宛てたハイブリッド ネットワーク トラフィックをセキュリティで保護することができます。 Azure Firewall Manager を使用すれば、許可するネットワーク トラフィックと拒否するネットワーク トラフィックを定義するポリシーを使って、ハイブリッド ネットワークにおけるネットワーク アクセスを制御できます。

Firewall Manager では、セキュリティ保護付き仮想ハブ アーキテクチャもサポートされます。 セキュリティ保護付き仮想ハブとハブ仮想ネットワーク アーキテクチャの種類の比較については、「[Azure Firewall Manager のアーキテクチャ オプション](vhubs-and-vnets.md)」を参照してください。

このチュートリアルでは、3 つの仮想ネットワークを作成します。

- **VNet-Hub** - ファイアウォールは、この仮想ネットワーク内に存在します。
- **VNet-Spoke** - スポーク仮想ネットワークは Azure 上のワークロードを表します。
- **VNet-Onprem** - オンプレミス仮想ネットワークはオンプレミス ネットワークを表します。 実際のデプロイでは、VPN 接続または ExpressRoute 接続のいずれかで接続できます。 わかりやすくするため、このチュートリアルでは VPN ゲートウェイ接続を使用し、Azure に配置された仮想ネットワークがオンプレミス ネットワークを表すために使用されます。

![ハイブリッド ネットワーク](media/tutorial-hybrid-portal/hybrid-network-firewall.png)

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * ファイアウォール ポリシーを作成する
> * 仮想ネットワークを作成する
> * ファイアウォールを構成してデプロイする
> * VPN ゲートウェイを作成して接続する
> * ハブとスポークの仮想ネットワークをピアリングする
> * ルートを作成する
> * 仮想マシンの作成
> * ファイアウォールをテストする


## <a name="prerequisites"></a>前提条件

ハイブリッド ネットワークでは、ハブおよびスポーク アーキテクチャ モデルを使用して、Azure VNet とオンプレミス ネットワーク間でトラフィックをルーティングします。 ハブおよびスポーク アーキテクチャには、次の要件があります。

- VNet-Hub を VNet-Spoke にピアリングする場合は、**AllowGatewayTransit** を設定します。 ハブおよびスポーク ネットワーク アーキテクチャでは、ゲートウェイ転送によってスポーク仮想ネットワークがハブ内の VPN ゲートウェイを共有でき、VPN ゲートウェイをすべてのスポーク仮想ネットワークにデプロイする必要はありません。 

   また、ゲートウェイに接続された仮想ネットワークまたはオンプレミス ネットワークへのルートは、ピアリングされた仮想ネットワークのルーティング テーブルにゲートウェイ転送を使用して自動的に伝達されます。 詳細については、「[仮想ネットワーク ピアリングの VPN ゲートウェイ転送を構成する](../vpn-gateway/vpn-gateway-peering-gateway-transit.md)」を参照してください。

- VNet-Spoke を VNet-Hub にピアリングする場合は、**UseRemoteGateways** を設定します。 **UseRemoteGateways** が設定され、リモート ピアリングに対する **AllowGatewayTransit** も設定されている場合、スポーク仮想ネットワークは転送にリモート仮想ネットワークのゲートウェイを使用します。
- スポーク サブネット トラフィックをハブ ファイアウォール経由でルーティングするには、 **[仮想ネットワーク ゲートウェイのルート伝達]** 設定が無効になったファイアウォールを指すユーザー定義ルート (UDR) が必要です。 このオプションを使用すると、スポーク サブネットへのルート配布ができなくなります。 これにより、学習されたルートと UDR との競合が防止されます。
- ハブ ゲートウェイ サブネット上の UDR を、スポーク ネットワークへの次のホップとしてファイアウォール IP アドレスを指すように構成します。 Azure Firewall サブネット上に UDR は必要ありません。BGP からルートを学習するためです。

これらのルートの作成方法については、このチュートリアルの「[ルートを作成する](#create-the-routes)」セクションをご覧ください。

>[!NOTE]
>Azure Firewall には、インターネットへの直接接続が必要です。 AzureFirewallSubnet が BGP 経由のオンプレミス ネットワークへの既定のルートを学習する場合は、インターネットへの直接接続を保持するために、**NextHopType** の値を **Internet** に設定した 0.0.0.0/0 UDR でこれを上書きする必要があります。
>
>Azure Firewall は、強制トンネリングをサポートするように構成できます。 詳細については、「[Azure Firewall 強制トンネリング](../firewall/forced-tunneling.md)」を参照してください。

>[!NOTE]
>直接ピアリングされた VNets 間のトラフィックは、UDR が既定のゲートウェイとして Azure Firewall をポイントしている場合でも、直接ルーティングされます。 このシナリオでサブネット間トラフィックをファイアウォールに送信するには、UDR に両方のサブネットのターゲットのサブネット ネットワーク プレフィックスを明示的に含める必要があります。

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。

## <a name="create-a-firewall-policy"></a>ファイアウォール ポリシーを作成する

1. Azure Portal [https://portal.azure.com](https://portal.azure.com) にサインインします。
2. Azure portal の検索バーに「**Firewall Manager**」と入力し、**Enter** キーを押します。
3. Azure Firewall Manager ページで、 **[View Azure firewall policies]\(Azure ファイアウォール ポリシーの表示\)** を選択します。

   ![ファイアウォール ポリシー](media/tutorial-hybrid-portal/firewall-manager-policy.png)

1. **[Azure ファイアウォール ポリシーの作成]** を選択します。
1. サブスクリプションを選択して [リソース グループ] の **[新規作成]** を選択し、**FW-Hybrid-Test** というリソース グループを作成します。
2. ポリシー名に「**Pol-Net01**」と入力します。
3. [リージョン] で **[米国東部]** を選択します。
4. **[次へ: 規則]** を選択します。
5. **[規則コレクションの追加]** を選択します。
6. **[名前]** に「**RCNet01**」と入力します。
7. **[規則コレクションの種類]** で、 **[ネットワーク]** を選択します。
8. **[優先度]** に「**100**」と入力します。
9. **[アクション]** で、 **[許可]** を選択します。
10. **[ルール]** の下の **[名前]** に「**AllowWeb**」と入力します。
11. **[ソース アドレス]** に「**192.168.1.0/24**」と入力します。
12. **[プロトコル]** で **[TCP]** を選択します。
13. **[宛先ポート]** に「**80**」と入力します。
14. **[送信先の種類]** で **[IP アドレス]** を選択します。
15. **[Destination]\(送信先\)** に「**10.6.0.0/16**」と入力します。
16. 次のルール行で、次の情報を入力します。
 
    名前: 「**AllowRDP**」と入力します。<br>
    送信元 IP アドレス: 「**192.168.1.0/24**」と入力します。<br>
    プロトコル: **[TCP]** を選択します。<br>
    宛先ポート: 「**3389**」と入力します。<br>
    送信先の種類: **[IP アドレス]** を選択します。<br>
    送信先: 「**10.6.0.0/16**」と入力します。

1. **[追加]** を選択します。
2. **[確認および作成]** を選択します。
3. 詳細を確認し、 **[作成]** を選択します。

## <a name="create-the-firewall-hub-virtual-network"></a>ファイアウォールのハブ仮想ネットワークを作成する

> [!NOTE]
> AzureFirewallSubnet サブネットのサイズは /26 です。 サブネットのサイズの詳細については、「[Azure Firewall に関する FAQ](../firewall/firewall-faq.md#why-does-azure-firewall-need-a-26-subnet-size)」を参照してください。

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. **[ネットワーク]** で、 **[仮想ネットワーク]** を選択します。
4. **[名前]** に「**VNet-hub**」と入力します。
5. **[アドレス空間]** に「**10.5.0.0/16**」と入力します。
6. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
7. **[リソース グループ]** で、 **[FW-Hybrid-Test]** を選択します。
8. **[場所]** で、 **[米国東部]** を選択します。
9. **[サブネット]** で、 **[名前]** に「**AzureFirewallSubnet**」と入力します。 ファイアウォールはこのサブネットに配置されます。サブネット名は AzureFirewallSubnet **でなければなりません**。
10. **[アドレス範囲]** に「**10.5.0.0/26**」と入力します。 
11. 他の既定の設定をそのまま使用し、 **[作成]** を選択します。

## <a name="create-the-spoke-virtual-network"></a>スポーク仮想ネットワークを作成する

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. **[ネットワーク]** で、 **[仮想ネットワーク]** を選択します。
4. **[名前]** に「**VNet-Spoke**」と入力します。
5. **[アドレス空間]** に「**10.6.0.0/16**」と入力します。
6. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
7. **[リソース グループ]** で、 **[FW-Hybrid-Test]** を選択します。
8. **[場所]** で、以前使用したのと同じ場所を選択します。
9. **[サブネット]** の下の **[名前]** に「**SN-Workload**」と入力します。
10. **[アドレス範囲]** に「**10.6.0.0/24**」と入力します。
11. 他の既定の設定をそのまま使用し、 **[作成]** を選択します。

## <a name="create-the-on-premises-virtual-network"></a>オンプレミス仮想ネットワークを作成する

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. **[ネットワーク]** で、 **[仮想ネットワーク]** を選択します。
4. **[名前]** に「**VNet-OnPrem**」と入力します。
5. **[アドレス空間]** に「**192.168.0.0/16**」と入力します。
6. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
7. **[リソース グループ]** で、 **[FW-Hybrid-Test]** を選択します。
8. **[場所]** で、以前使用したのと同じ場所を選択します。
9. **[サブネット]** の下の **[名前]** に「**SN-Corp**」と入力します。
10. **[アドレス範囲]** に「**192.168.1.0/24**」と入力します。
11. 他の既定の設定をそのまま使用し、 **[作成]** を選択します。

仮想ネットワークのデプロイ後、ゲートウェイに 2 つ目のサブネットを作成します。

1. **[VNet-Onprem]** ページで、 **[サブネット]** を選択します。
2. **[+サブネット]** を選択します。
3. **[名前]** に「**GatewaySubnet**」と入力します。
4. **[アドレス範囲 (CIDR ブロック)]** に「**192.168.2.0/24**」と入力します。
5. **[OK]** を選択します。

### <a name="create-a-public-ip-address"></a>パブリック IP アドレスの作成

これは、オンプレミスのゲートウェイに使用されるパブリック IP アドレスです。

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. 検索テキスト ボックスに「**パブリック IP アドレス**」と入力し、**Enter** キーを押します。
3. **[パブリック IP アドレス]** を選択し、 **[作成]** を選択します。
4. 名前として「**VNet-Onprem-GW-pip**」と入力します。
5. リソース グループとして「**FW-Hybrid-Test**」と入力します。
6. **[場所]** で、 **[米国東部]** を選択します。
7. 他の既定値をそのまま使用し、 **[作成]** を選択します。

## <a name="configure-and-deploy-the-firewall"></a>ファイアウォールを構成してデプロイする

ハブにセキュリティ ポリシーが関連付けられている場合、"*ハブ仮想ネットワーク*" と呼ばれます。

**VNet-Hub** 仮想ネットワークを "*ハブ仮想ネットワーク*" に変換し、Azure Firewall でセキュリティを確保します。

1. Azure portal の検索バーに「**Firewall Manager**」と入力し、**Enter** キーを押します。
3. Azure Firewall Manager ページの **[Add security to virtual networks]\(仮想ネットワークへのセキュリティの追加\)** で、 **[View hub virtual networks]\(ハブ仮想ネットワークの表示\)** を選択します。
4. **[Convert virtual networks]\(仮想ネットワークの変換\)** を選択します。
5. **[VNet-hub]** を選択し、 **[次へ: Azure Firewall]** を選択します。
6. **[ファイアウォール ポリシー]** で **[Pol-Net01]** を選択します。
7. **[次へ: レビューと確認]** を選択します。
8. 詳細を確認し、 **[確認]** を選択します。


   このデプロイには数分かかります。
7. デプロイが完了したら、**FW-Hybrid-Test** リソース グループに移動し、ファイアウォールを選択します。
9. **[概要]** ページの **[Firewall private IP]\(ファイアウォールのプライベート IP\)** アドレスをメモします。 後で既定のルートを作成するときにこれを使用します。

## <a name="create-and-connect-the-vpn-gateways"></a>VPN ゲートウェイを作成して接続する

ハブとオンプレミスの仮想ネットワークは、VPN ゲートウェイ経由で接続されます。

### <a name="create-a-vpn-gateway-for-the-hub-virtual-network"></a>ハブ仮想ネットワークの VPN ゲートウェイを作成する

次に、ハブ仮想ネットワークの VPN ゲートウェイを作成します。 ネットワーク間構成には、RouteBased VpnType が必要です。 選択した VPN ゲートウェイ SKU によっては、VPN ゲートウェイの作成に 45 分以上かかる場合も少なくありません。

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. 検索テキスト ボックスに「**仮想ネットワーク ゲートウェイ**」と入力し、**Enter** キーを押します。
3. **[仮想ネットワーク ゲートウェイ]** を選択し、 **[作成]** を選択します。
4. **[名前]** に「**GW-hub**」と入力します。
5. **[リージョン]** で **[(米国) 米国東部]** を選択します。
6. **[ゲートウェイの種類]** で、 **[VPN]** を選択します。
7. **[VPN の種類]** で、 **[ルート ベース]** を選択します。
8. **[SKU]** で、 **[Basic]** を選択します。
9. **[仮想ネットワーク]** で、 **[VNet-hub]** を選択します。
10. **[パブリック IP アドレス]** で **[新規作成]** を選択し、名前として「**VNet-hub-GW-pip**」と入力します。
11. 他の既定値をそのまま使用し、 **[確認および作成]** を選択します。
12. 構成を確認して、 **[作成]** を選択します。

### <a name="create-a-vpn-gateway-for-the-on-premises-virtual-network"></a>オンプレミス仮想ネットワークの VPN ゲートウェイを作成する

次に、オンプレミス仮想ネットワークの VPN ゲートウェイを作成します。 ネットワーク間構成には、RouteBased VpnType が必要です。 選択した VPN ゲートウェイ SKU によっては、VPN ゲートウェイの作成に 45 分以上かかる場合も少なくありません。

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. 検索テキスト ボックスに「**仮想ネットワーク ゲートウェイ**」と入力し、**Enter** キーを押します。
3. **[仮想ネットワーク ゲートウェイ]** を選択し、 **[作成]** を選択します。
4. **[名前]** に「**GW-Onprem**」と入力します。
5. **[リージョン]** で **[(米国) 米国東部]** を選択します。
6. **[ゲートウェイの種類]** で、 **[VPN]** を選択します。
7. **[VPN の種類]** で、 **[ルート ベース]** を選択します。
8. **[SKU]** で、 **[Basic]** を選択します。
9. **[仮想ネットワーク]** で、 **[VNet-Onprem]** を選択します。
10. **[パブリック IP アドレス]** で * *[Use existing]\(既存のものを使用\)* を選択し、名前に「**VNet-Onprem-GW-pip**」を選択します。
11. 他の既定値をそのまま使用し、 **[確認および作成]** を選択します。
12. 構成を確認して、 **[作成]** を選択します。

### <a name="create-the-vpn-connections"></a>VPN 接続を作成する

これで、ハブ ゲートウェイとオンプレミス ゲートウェイの間に VPN 接続を作成することができます。

この手順では、ハブ仮想ネットワークからオンプレミス仮想ネットワークへの接続を作成します。 この例では、参照される共有キーが表示されます。 共有キーには独自の値を使用することができます。 両方の接続の共有キーが一致することが重要です。 接続の作成完了までしばらくかかります。

1. **FW-Hybrid-Test** リソース グループを開き、**GW-hub** ゲートウェイを選択します。
2. 左側の列で、 **[接続]** を選択します。
3. **[追加]** を選択します。
4. 接続名として「**Hub-to-Onprem**」と入力します。
5. **[接続の種類]** に **[VNet 対 VNet]** を選択します。
6. **[2 番目の仮想ネットワーク ゲートウェイ]** で、 **[GW-Onprem]** を選択します。
7. **[共有キー (PSK)]** に「**AzureA1b2C3**」と入力します。
8. **[OK]** を選択します。

オンプレミスとハブとの間に仮想ネットワーク接続を作成します。 この手順は前の手順と似ていますが、VNet-Onprem から VNet-Hub への接続を作成する点が異なります。 共有キーが一致することを確認してください。 数分後に接続が確立されます。

1. **FW-Hybrid-Test** リソース グループを開き、**GW-Onprem** ゲートウェイを選択します。
2. 左側の列で、 **[接続]** を選択します。
3. **[追加]** を選択します。
4. 接続名として「**Onprem-to-Hub**」と入力します。
5. **[接続の種類]** に **[VNet 対 VNet]** を選択します。
6. **[2 番目の仮想ネットワーク ゲートウェイ]** で、 **[GW-hub]** を選択します。
7. **[共有キー (PSK)]** に「**AzureA1b2C3**」と入力します。
8. **[OK]** を選択します。


#### <a name="verify-the-connection"></a>接続を確認する

約 5 分後、両方の接続の状態が **[接続中]** になるはずです。

![ゲートウェイ接続](media/secure-hybrid-network/gateway-connections.png)

## <a name="peer-the-hub-and-spoke-virtual-networks"></a>ハブとスポークの仮想ネットワークをピアリングする

次に、ハブとスポークの仮想ネットワークをピアリングします。

1. **FW-Hybrid-Test** リソース グループを開き、**VNet-hub** 仮想ネットワークを選択します。
2. 左側の列で、 **[ピアリング]** を選択します。
3. **[追加]** を選択します。
4. **[名前]** に「**HubtoSpoke**」と入力します。
5. **[仮想ネットワーク]** で、 **[VNet-spoke]** を選択します
6. VNetSpoke から VNet-hub へのピアリングの名前として「**SpoketoHub**」と入力します。
7. **[ゲートウェイ転送を許可する]** を選択します。
8. **[OK]** を選択します。

### <a name="configure-additional-settings-for-the-spoketohub-peering"></a>SpoketoHub ピアリングの追加の設定を構成する

SpoketoHub ピアリング上で **[転送されたトラフィックを許可する]** を有効にする必要があります。

1. **FW-Hybrid-Test** リソース グループを開き、**VNet-Spoke** 仮想ネットワークを選択します。
2. 左側の列で、 **[ピアリング]** を選択します。
3. **SpoketoHub** ピアリングを選択します。
4. **[VNet-hub から VNet-Spoke への転送トラフィックを許可する]** で、 **[有効]** を選択します。
5. **[保存]** を選択します。

## <a name="create-the-routes"></a>ルートを作成する

次に、2 つのルートを作成します。

- ファイアウォール ハブ IP アドレスを介したハブ ゲートウェイ サブネットからスポーク サブネットへのルート
- ファイアウォール ハブ IP アドレスを介したスポーク サブネットからの既定ルート

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. 検索テキスト ボックスに「**ルート テーブル**」と入力し、**Enter** キーを押します。
3. **[ルート テーブル]** を選択します。
4. **［作成］** を選択します
5. 名前として「**UDR-Hub-Spoke**」と入力します。
6. リソース グループとして **[FW-Hybrid-Test]** を選択します。
8. **[場所]** で、 **[(米国) 米国東部]** を選択します。
9. **［作成］** を選択します
10. ルート テーブルが作成されたら、それを選択して、ルート テーブル ページを開きます。
11. 左側の列で、 **[ルート]** を選択します。
12. **[追加]** を選択します。
13. ルート名として「**ToSpoke**」と入力します。
14. アドレス プレフィックスとして「**10.6.0.0/16**」と入力します。
15. 次ホップの種類として **[仮想アプライアンス]** を選択します。
16. 次ホップ アドレスとして、前にメモしておいた、ファイアウォールのプライベート IP アドレスを入力します。
17. **[OK]** を選択します。

ここで、ルートをサブネットに関連付けます。

1. **[UDR-Hub-Spoke - ルート]** ページで **[サブネット]** を選択します。
2. **[関連付け]** を選択します。
4. **[仮想ネットワーク]** で **[VNet-hub]** を選択します。
5. **[サブネット]** で **[GatewaySubnet]** を選択します。
6. **[OK]** を選択します。

ここで、スポーク サブネットからの既定のルートを作成します。

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. 検索テキスト ボックスに「**ルート テーブル**」と入力し、**Enter** キーを押します。
3. **[ルート テーブル]** を選択します。
5. **［作成］** を選択します
6. 名前として「**UDR-DG**」と入力します。
7. リソース グループとして **[FW-Hybrid-Test]** を選択します。
8. **[場所]** で、 **[(米国) 米国東部]** を選択します。
4. **[仮想ネットワーク ゲートウェイのルート伝達]** で、 **[無効]** を選択します。
1. **［作成］** を選択します
2. ルート テーブルが作成されたら、それを選択して、ルート テーブル ページを開きます。
3. 左側の列で、 **[ルート]** を選択します。
4. **[追加]** を選択します。
5. ルート名として「**ToHub**」と入力します。
6. アドレス プレフィックスとして「**0.0.0.0/0**」と入力します。
7. 次ホップの種類として **[仮想アプライアンス]** を選択します。
8. 次ホップ アドレスとして、前にメモしておいた、ファイアウォールのプライベート IP アドレスを入力します。
9. **[OK]** を選択します。

ここで、ルートをサブネットに関連付けます。

1. **[UDR-DG - ルート]** ページで **[サブネット]** を選択します。
2. **[関連付け]** を選択します。
4. **[仮想ネットワーク]** で **[VNet-spoke]** を選択します。
5. **[サブネット]** で **[SN-Workload]** を選択します。
6. **[OK]** を選択します。

## <a name="create-virtual-machines"></a>仮想マシンを作成する

次に、スポーク ワークロードとオンプレミスの仮想マシンを作成し、適切なサブネットに配置します。

### <a name="create-the-workload-virtual-machine"></a>ワークロード仮想マシンを作成する

パブリック IP アドレスなしで、スポーク仮想ネットワークに仮想マシンを作成し、IIS を実行します。

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. **[人気順]** で、 **[Windows Server 2016 Datacenter]** を選択します。
3. 次の仮想マシンの値を入力します。
    - **[リソース グループ]** - **[FW-Hybrid-Test]** を選択します。
    - **[仮想マシン名]** : *VM-Spoke-01*。
    - **[リージョン]**  -  " *(米国) 米国東部*"
    - **[ユーザー名]** : *azureuser*。
    - **[パスワード]** : 自分のパスワードを入力します。

4. **[Next:Disks]\(次へ: ディスク\)** を選択します。
5. 既定値をそのまま使用し、 **[次へ: ネットワーク]** を選択します。
6. 仮想ネットワークとして **[VNet-Spoke]** を選択します。サブネットは **SN-Workload** です。
7. **[パブリック IP]** で、 **[なし]** を選択します。
8. **[パブリック受信ポート]** で **[選択したポートを許可する]** を選択し、 **[HTTP (80)]** と **[RDP (3389)]** を選択します
9. **[Next:Management]\(次へ: 管理\)** を選択します。
10. **[ブート診断]** で、 **[オフ]** を選択します。
11. **[確認および作成]** を選択し、概要ページの設定を確認して、 **[作成]** を選択します。

### <a name="install-iis"></a>IIS のインストール

1. Azure portal で Cloud Shell を開き、**PowerShell** に設定されていることを確認します。
2. 次のコマンドを実行して、IIS を仮想マシンにインストールし、必要に応じて場所を変更します。

   ```azurepowershell-interactive
   Set-AzVMExtension `
           -ResourceGroupName FW-Hybrid-Test `
           -ExtensionName IIS `
           -VMName VM-Spoke-01 `
           -Publisher Microsoft.Compute `
           -ExtensionType CustomScriptExtension `
           -TypeHandlerVersion 1.4 `
           -SettingString '{"commandToExecute":"powershell Add-WindowsFeature Web-Server; powershell      Add-Content -Path \"C:\\inetpub\\wwwroot\\Default.htm\" -Value $($env:computername)"}' `
           -Location EastUS
   ```

### <a name="create-the-on-premises-virtual-machine"></a>オンプレミス仮想マシンを作成する

これは、リモート デスクトップを使用してパブリック IP アドレスに接続する際に使用する仮想マシンです。 そこから、ファイアウォールを介してオンプレミス サーバーに接続します。

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. **[人気順]** で、 **[Windows Server 2016 Datacenter]** を選択します。
3. 次の仮想マシンの値を入力します。
    - **[リソース グループ]** - 既存のものを選択し、 **[FW-Hybrid-Test]** を選択します。
    - **[仮想マシン名]**  - *VM-Onprem*。
    - **[リージョン]**  -  " *(米国) 米国東部*"
    - **[ユーザー名]** : *azureuser*。
    - **[パスワード]** : 自分のパスワードを入力します。

4. **[Next:Disks]\(次へ: ディスク\)** を選択します。
5. 既定値をそのまま使用し、 **[Next:Networking]\(次へ: ネットワーク\)** を選択します。
6. 仮想ネットワークとして **[VNet-Onprem]** を選択し、サブネットが **SN-Corp** であることを確認します。
7. **[パブリック受信ポート]** で **[選択したポートを許可する]** を選択し、 **[RDP (3389)]** を選択します
8. **[Next:Management]\(次へ: 管理\)** を選択します。
9. **[ブート診断]** で、 **[オフ]** を選択します。
10. **[確認および作成]** を選択し、概要ページの設定を確認して、 **[作成]** を選択します。

## <a name="test-the-firewall"></a>ファイアウォールをテストする

1. まず、VM-Spoke-01 の概要ページで VM-Spoke-01 仮想マシンのプライベート IP アドレスをメモします。

2. Azure portal から、**VM-Onprem** 仮想マシンに接続します。
<!---2. Open a Windows PowerShell command prompt on **VM-Onprem**, and ping the private IP for **VM-spoke-01**.

   You should get a reply.--->
3. **VM-Onprem** 上で Web ブラウザーを開き、 http://\<VM-spoke-01 private IP\> にアクセスします。

   **VM-spoke-01** Web ページが表示されるはずです。![VM-Spoke-01 Web ページ](media/secure-hybrid-network/vm-spoke-01-web.png)

4. **VM-Onprem** 仮想マシンで、プライベート IP アドレスにある **VM-spoke-01** へのリモート デスクトップを開きます。

   接続が成功し、サインインできるはずです。

これで、ファイアウォール ルールが動作していることを確認できました。

<!---- You can ping the server on the spoke VNet.--->
- スポーク仮想ネットワーク上の Web サーバーにブラウザーでアクセスすることができます。
- スポーク仮想ネットワーク上のサーバーには、RDP を使用して接続できます。

次に、ファイアウォール ネットワーク ルール コレクションの動作を **Deny** に変更して、ファイアウォール ルールが想定どおりに動作することを確認します。

1. **FW-Hybrid-Test** リソース グループを開き、**Pol-Net01** ファイアウォール ポリシーを選択します。
2. **[設定]** で **[Rules]\(ルール\)** を選択します。
3. **[ネットワーク ルール]** の **[RCNet01]** ルール コレクションを選択し、省略記号 (...) を選択して **[編集]** を選択します。
4. **[規則コレクション アクション]** で **[拒否]** を選択します。
5. **[保存]** を選択します。

**VM-Onprem** で既存のリモート デスクトップとブラウザーをすべて閉じてから、変更したルールをテストします。 ルール コレクションの更新が完了したら、もう一度テストを実行します。 このとき、すべてが失敗するはずです。

## <a name="clean-up-resources"></a>リソースをクリーンアップする

ファイアウォール リソースは、次のチュートリアルのために残しておいてもかまいませんが、不要であれば、**FW-Hybrid-Test** リソース グループを削除して、ファイアウォール関連のすべてのリソースを削除してください。

## <a name="next-steps"></a>次のステップ

> [!div class="nextstepaction"]
> [チュートリアル:Azure Firewall Manager プレビューを使用して仮想 WAN をセキュリティで保護する](secure-cloud-network.md)