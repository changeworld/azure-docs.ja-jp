---
title: アプリケーションのローリング アップグレード - Azure SQL Database | Microsoft Docs
description: Azure SQL Database で geo レプリケーションを使用してクラウド アプリケーションのオンライン アップグレードをサポートする方法について説明します。
services: sql-database
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab
manager: craigg
ms.date: 08/23/2018
ms.openlocfilehash: f560f053b7aa7f4e90ebcc611119e1c552f6df7c
ms.sourcegitcommit: 4eeeb520acf8b2419bcc73d8fcc81a075b81663a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/19/2018
ms.locfileid: "53608053"
---
# <a name="managing-rolling-upgrades-of-cloud-applications-using-sql-database-active-geo-replication"></a>SQL Database アクティブ geo レプリケーションを使用したクラウド アプリケーションのローリング アップグレードの管理

SQL Database で[アクティブ geo レプリケーション](sql-database-auto-failover-group.md)を使用してクラウド アプリケーションのローリング アップグレードを有効にする方法について説明します。 アップグレードは中断を伴う作業であるため、ビジネス継続性の計画と設計の一部として組み込む必要があります。 この記事では、アップグレード処理を編成する 2 種類の方法を確認し、方法ごとにメリットとトレードオフを説明します。 この記事では、データ層として単一のデータベースに接続されている Web サイトで構成される単純なアプリケーションを使用します。 ここでの目的は、エンド ユーザー エクスペリエンスに大幅な影響を及ぼさずにアプリケーションをバージョン 1 からバージョン 2 にアップグレードすることです。

アップグレード方法を評価する際に、次の要因を検討する必要があります。

* アップグレード中のアプリケーションの可用性への影響。 アプリケーションの機能が制限されるか低下する期間の長さ。
* アップグレードで障害が発生した場合にロールバックする機能。
* アップグレード中に関係のない致命的なエラーが発生した場合のアプリケーションの脆弱性。
* 合計コスト。  これには、アップグレード処理で使用される一時的なコンポーネントによる冗長性の補強とコストの増加が含まれます。

## <a name="upgrading-applications-that-rely-on-database-backups-for-disaster-recovery"></a>障害復旧をデータベースのバックアップに依存するアプリケーションのアップグレード

障害復旧をデータベースの自動バックアップに依存し、geo リストアを使用しているアプリケーションは、通常、単一の Azure リージョンにデプロイします。 この場合、アップグレード処理では、アップグレードに関連するすべてのアプリケーション コンポーネントのバックアップのデプロイの作成が必要になります。 エンドユーザーの作業の中断を最小限に抑えるには、フェールオーバー プロファイルを持つ Azure Traffic Manager (ATM) を活用します。  次の図は、アップグレード処理の前の運用環境を示しています。 エンドポイント `contoso-1.azurewebsites.net` は、アップグレードが必要なアプリケーションの運用スロットを表します。 アップグレードをロールバックする機能を有効にするには、完全に同期されたアプリケーションのコピーを使用してステージング スロットを作成する必要があります。 次の手順は、アプリケーションをアップグレードする準備で必要になります。

1. アップグレード用のステージング スロットを作成します。 そのために、セカンダリ データベース (1) を作成して、同じ Azure リージョンに同一の Web サイトをデプロイします。 セカンダリ データベースを監視して、シード処理が完了したかどうかを確認します。
2. `contoso-1.azurewebsites.net` をオンライン エンドポイントとして、`contoso-2.azurewebsites.net` をオフライン エンド ポイントとして使用し、ATM のフェールオーバー プロファイルを作成します。

> [!NOTE]
> 準備の手順は運用スロットのアプリケーションに影響を与えず、アプリケーションはフル アクセス モードで動作できます。
>  

![SQL Database Go-Replication configuration. クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/Option1-1.png)

準備の手順が完了すると、アプリケーションを実際にアップグレードできるようになります。 次の図は、アップグレード処理で必要な手順を示しています。

1. 運用スロットのプライマリ データベースを読み取り専用モードに設定します (3)。 こうすると、アップグレード中は、アプリケーション (V1) の実稼働インスタンスが必ず読み取り専用のままになります。これにより、V1 と V2 のデータベース インスタンスのデータの不整合を防ぎます。  
2. 計画終了モードを使用して、セカンダリ データベースを切断します (4)。 これにより、完全に同期されたプライマリ データベースの独立したコピーが作成されます。 このデータベースがアップグレードされます。
3. プライマリ データベースで読み取り/書き込みモードを有効にして、ステージング スロットでアップグレード スクリプトを実行します (5)。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/Option1-2.png)

アップグレードが正常に完了すると、エンドユーザーをアプリケーションのステージング コピーに切り替えられるようになります。 これがアプリケーションの運用スロットになります。  これには、次の図に示すように、いくつかの手順がさらに必要になります。

1. ATM プロファイルのオンライン エンドポイントを `contoso-2.azurewebsites.net` に切り替えます。このエンドポイントは、V2 バージョンの Web サイトを表します (6)。 これが、V2 アプリケーションを備えた運用スロットになり、エンド ユーザー トラフィックがここに直接転送されます。  
2. V1 アプリケーション コンポーネントが不要になった場合は、その V1 アプリケーション コンポーネントを安全に削除できます (7)。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/Option1-3.png)

アップグレード スクリプトのエラーなどによりアップグレード処理が失敗した場合は、ステージング スロットが侵害されたと見なされます。 アプリケーションをアップグレード前の状態にロールバックするには、単純に運用スロットのアプリケーションをフル アクセスに戻します。 必要な手順は、次の図に示すとおりです。

1. データベースのコピーを読み取り/書き込みモードに設定します (8)。 これにより、運用スロットで V1 の機能が完全に復元されます。
2. 根本原因分析を実行し、ステージング スロットで侵害されたコンポーネントを削除します (9)。

この時点で、アプリケーションが完全に動作可能になり、アップグレードの手順を繰り返すことができます。

> [!NOTE]
> `contoso-1.azurewebsites.net` をアクティブなエンドポイントとして既に指しているため、ロールバックでは ATM プロファイルの変更は不要です。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/Option1-4.png)

この方法の主な**メリット**は、一連の簡単な手順を使用して単一のリージョンでアプリケーションをアップグレードできる点です。 アップグレードのコストは比較的安価になります。 主な **トレードオフ** は、アップグレード中に致命的なエラーが発生した場合、アップグレード前の状態に回復するには、別のリージョンでアプリケーションを再度デプロイし、geo リストアを使用してバックアップからデータベースを復元する必要がある点です。 この処理により、大幅なダウンタイムが生じます。

## <a name="upgrading-applications-that-rely-on-database-geo-replication-for-disaster-recovery"></a>ディザスター リカバリーをデータベースの geo レプリケーションに依存するアプリケーションのアップグレード

アプリケーションでビジネス継続性のために geo レプリケーションを活用する場合、少なくとも 2 種類のリージョンにアプリケーションをデプロイします。プライマリ リージョンにアクティブなデプロイを実行し、バックアップ リージョンにスタンバイ デプロイを実行します。 前に説明した要因に加えて、アップグレード処理で次の点を徹底する必要があります。

* アップグレード処理中は常に、致命的な障害からアプリケーションを保護する
* アプリケーションの geo 冗長コンポーネントを、アクティブ コンポーネントと同時にアップグレードする

これらの目標を達成するには、1 つのアクティブ エンドポイントと 3 つのバックアップ エンドポイントを備えたフェールオーバー プロファイルを使用して Azure Traffic Manager (ATM) を活用してください。  次の図は、アップグレード処理の前の運用環境を示しています。 Web サイトの `contoso-1.azurewebsites.net` と `contoso-dr.azurewebsites.net` は、完全な geo 冗長性を備えたアプリケーションの運用スロットを表します。 アップグレードをロールバックする機能を有効にするには、完全に同期されたアプリケーションのコピーを使用してステージング スロットを作成する必要があります。 アップグレード処理中に致命的な障害が発生した場合、アプリケーションを必ず迅速に回復できる必要があるため、ステージング スロットは geo 冗長性も必要とします。 次の手順は、アプリケーションをアップグレードする準備で必要になります。

1. アップグレード用のステージング スロットを作成します。 そのために、セカンダリ データベース (1) を作成して、同じ Azure リージョンに同一の Web サイトのコピーをデプロイします。 セカンダリ データベースを監視して、シード処理が完了したかどうかを確認します。
2. セカンダリ データベースをバックアップ リージョンに geo レプリケートすることで (これを "geo レプリケーションの連鎖" と呼びます)、ステージング スロットに geo 冗長性のあるセカンダリ データベースを作成します。 セカンダリ バックアップを監視して、シード処理が完了したかどうかを確認します (3)。
3. Web サイトのスタンバイ コピーをバックアップ リージョンに作成し、geo 冗長性のあるセカンダリにリンクします (4)。  
4. 追加のエンドポイントの `contoso-2.azurewebsites.net` と `contoso-3.azurewebsites.net` をオフライン エンドポイントとして ATM のフェールオーバー プロファイルに追加します (5)。

> [!NOTE]
> 準備の手順は運用スロットのアプリケーションに影響を与えず、アプリケーションはフル アクセス モードで動作できます。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/Option2-1.png)

準備の手順が完了すると、ステージング スロットでアップグレードの用意ができます。 次の図は、アップグレードの手順を示します。

1. 運用スロットのプライマリ データベースを読み取り専用モードに設定します (6)。 こうすると、アップグレード中は、アプリケーション (V1) の実稼働インスタンスが必ず読み取り専用のままになります。これにより、V1 と V2 のデータベース インスタンスのデータの不整合を防ぎます。  
2. 計画された終了モードを使用して、同じリージョンのセカンダリ データベースを切断します (7)。 これにより、完全に同期されたプライマリ データベースの独立したコピーが作成されます。これは、終了後に自動的にプライマリになります。 このデータベースがアップグレードされます。
3. ステージング スロットのプライマリ データベースで読み取り/書き込みモードを有効にして、アップグレード スクリプトを実行します (8)。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/Option2-2.png)

アップグレードが正常に完了すると、エンドユーザーを V2 バージョンのアプリケーションに切り替えられるようになります。 次の図に、必要な手順を示します。

1. ATM プロファイルのアクティブ エンドポイントを `contoso-2.azurewebsites.net` に切り替えます。このエンドポイントは、V2 バージョンの Web サイトを表します (9)。 これが、V2 アプリケーションを持つ運用スロットになり、エンド ユーザー トラフィックがここに転送されます。
2. V1 アプリケーションが不要になった場合は、そのV1 アプリケーションを安全に削除できます (10 および 11)。  

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/Option2-3.png)

アップグレード スクリプトのエラーなどによりアップグレード処理が失敗した場合は、ステージング スロットが侵害されたと見なされます。 アプリケーションをアップグレード前の状態にロールバックするには、フル アクセスを持つ運用スロットのアプリケーションを使用するように戻すだけです。 必要な手順は、次の図に示すとおりです。

1. 運用スロットのプライマリ データベースのコピーを読み取り/書き込みモードに設定します (12)。 これにより、運用スロットで V1 の機能が完全に復元されます。
2. 根本原因分析を実行し、ステージング スロットの侵害されたコンポーネントを削除します (13 および 14)。

この時点で、アプリケーションが完全に動作可能になり、アップグレードの手順を繰り返すことができます。

> [!NOTE]
> `contoso-1.azurewebsites.net` をアクティブなエンドポイントとして既に指しているため、ロールバックでは ATM プロファイルの変更は不要です。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/Option2-4.png)

この方法の主な **メリット** は、アップグレード中にビジネス継続性を損なうことなく、アプリケーションと geo 冗長性を持つコピーの両方を並行してアップグレードできる点です。 主な **トレードオフ** は、各アプリケーション コンポーネントが 2 倍の冗長性を必要とするため、コストが増加する点です。 また、より複雑なワークフローが必要になります。

## <a name="summary"></a>まとめ

この記事で説明している 2 種類のアップグレード方法の違いは、複雑さとコストです。ただし、両方とも、エンドユーザーの操作が読み取り専用に制限される時間を最小限に抑えることに焦点を合わせています。 この時間は、直接的にはアップグレード スクリプトの時間で決まります。 データベースのサイズ、選択したサービス レベル、Web サイトの構成、制御が容易でないその他の要因には左右されません。 その理由は、すべての準備の手順が、アップグレードの手順から切り離されていて、運用アプリケーションに影響を与えずに実行できるためです。 アップグレード スクリプトの効率性は、アップグレード中のエンド ユーザー エクスペリエンスを決定する重要な要素です。 これを改善できる最適な方法は、アップグレード スクリプトをできる限り効率的にすることに集中して取り組むことです。  

## <a name="next-steps"></a>次の手順

* ビジネス継続性の概要およびシナリオについては、 [ビジネス継続性の概要](sql-database-business-continuity.md)に関する記事を参照してください。
* Azure SQL Database 自動バックアップの詳細については、「 [SQL Database 自動バックアップ](sql-database-automated-backups.md)」を参照してください。
* 自動バックアップを使用して復旧する方法については、[自動化されたバックアップからのデータベース復元](sql-database-recovery-using-backups.md)を参照してください。
