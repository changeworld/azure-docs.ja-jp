---
title: マルチテナント SaaS アプリでシャード マルチテナント Azure SQL データベースのパフォーマンスを監視する | Microsoft Docs
description: マルチテナント SaaS アプリでシャード マルチテナント Azure SQL データベースのパフォーマンスを監視および管理する
services: sql-database
ms.service: sql-database
ms.subservice: scenario
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 01/25/2019
ms.openlocfilehash: 50fab6afe837ad409f05dbb0f3a8a44d089a894e
ms.sourcegitcommit: 7c4de3e22b8e9d71c579f31cbfcea9f22d43721a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/26/2019
ms.locfileid: "68570331"
---
# <a name="monitor-and-manage-performance-of-sharded-multi-tenant-azure-sql-database-in-a-multi-tenant-saas-app"></a>マルチテナント SaaS アプリでシャード マルチテナント Azure SQL データベースのパフォーマンスを監視および管理する

このチュートリアルでは、SaaS アプリケーションで使用されるいくつかの主要なパフォーマンス管理シナリオを説明します。 ロード ジェネレーターを使用してシャード マルチテナント データベース間のアクティビティをシミュレートすることにより、SQL Database の組み込みの監視およびアラート機能を示します。

Wingtip Tickets SaaS マルチテナント データベース アプリは、会場 (テナント) データが潜在的に複数のデータベースにわたってテナント ID で分散される、シャード マルチテナント データ モデルを使用します。 多くの SaaS アプリケーションと同様、テナントのワークロード パターンは予測不能で、かつ散発的であることが予想されます。 つまり、チケット販売は常に発生する可能性があります。 この一般的なデータベース使用パターンを利用するために、データベースをスケールアップおよびスケールダウンしてソリューションのコストを最適化できます。 このタイプのパターンでは、データベース リソース使用状況を監視して、負荷が潜在的に複数のデータベースにわたって適切かつ確実に分散されるようにすることが重要です。 また、個々のデータベースが十分なリソースを備えており、その [DTU](sql-database-purchase-models.md#dtu-based-purchasing-model) 制限に達していないことも確認する必要があります。 このチュートリアルでは、データベースを監視および管理する方法、およびワークロードの変化に応じて是正処置を実行する方法について説明します。

このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> 
> * 指定されたロード ジェネレーターを実行して、シャード マルチテナント データベースの使用をシミュレートする
> * 負荷の増加に対応しているときのデータベースを監視する
> * データベースの負荷の増加に対応してデータベースをスケールアップする
> * シングルテナント データベースにテナントをプロビジョニングする

このチュートリアルを完了するには、次の前提条件を満たしておく必要があります。

* Wingtip Tickets SaaS マルチテナント データベース アプリがデプロイされます。 5 分未満でデプロイするには、「[Deploy and explore the Wingtip Tickets SaaS Multi-tenant Database application (Wingtip Tickets SaaS マルチテナント データベース アプリケーションのデプロイと探索)](saas-multitenantdb-get-started-deploy.md)」を参照してください。
* Azure PowerShell がインストールされている。 詳しくは、「[Azure PowerShell を使ってみる](https://docs.microsoft.com/powershell/azure/get-started-azureps)」をご覧ください。

## <a name="introduction-to-saas-performance-management-patterns"></a>SaaS パフォーマンス管理パターンの概要

データベース パフォーマンスを管理するには、まずパフォーマンス データをコンパイルして分析し、その後、このデータに基づいて、アプリケーションの許容応答時間を維持できるようパラメーターを調整します。 

### <a name="performance-management-strategies"></a>パフォーマンス管理戦略

* パフォーマンスを手動で監視しなくても済むようにするには、**データベースが正常範囲から外れたときにトリガーされるアラートを設定する**ことが最も効果的です。
* データベースのコンピューティング サイズの短期的な変動に対応するには、**DTU レベルをスケールアップまたはスケールダウンできます**。 この変動が定期的に、または予測可能な間隔で発生する場合は、**データベースのスケーリングを自動的に実行されるようにスケジュールできます**。 たとえば、ワークロードが少なくなることがわかっている夜間や週末は、スケールダウンします。
* テナントのより長期的な変動や変更に対応するには、**個々のテナントを他のデータベースに移動できます**。
* "*個別の*" テナント負荷の短期的な増加に対応するには、**個々のテナントをデータベースから取り出し、それに個別のコンピューティング サイズを割り当てることができます**。 負荷が削減されたら、そのテナントをマルチテナント データベースに戻すことができます。 これが事前にわかっている場合は、テナントをあらかじめ移動しておくことことにより、データベースに常に必要なだけのリソースを確保し、マルチテナント データベース内の他のテナントへの影響を避けることができます。 たとえば、ある会場における人気イベントのにチケット販売にアクセスが殺到する、といった予測可能な要件に対しては、この管理動作をアプリケーションに組み込むことができます。

[Azure Portal](https://portal.azure.com) には、ほとんどのリソースに監視とアラートが組み込まれています。 SQL Database の場合は、データベース上で監視とアラートを使用できます。 この組み込みの監視とアラートはリソース固有であるため、リソースが少数の場合は便利ですが、リソースの数が多くなると便利とは言えません。

多くのリソースを処理する大規模なシナリオの場合は、[Azure Monitor ログ](https://azure.microsoft.com/services/log-analytics/)を使用できます。 これは、出力された診断ログと、Log Analytics ワークスペースで収集されたテレメトリに分析を提供する個別の Azure サービスです。 Azure Monitor ログは、多くのサービスからテレメトリを収集できます。また、このサービスを使用して、クエリを実行し、アラートを設定することもできます。

## <a name="get-the-wingtip-tickets-saas-multi-tenant-database-application-source-code-and-scripts"></a>Wingtip Tickets SaaS マルチテナント データベース アプリケーションのソース コードとスクリプトを入手する

Wingtip Tickets SaaS マルチテナント データベースのスクリプトとアプリケーションのソース コードは、[WingtipTicketsSaaS-MultitenantDB](https://github.com/microsoft/WingtipTicketsSaaS-MultiTenantDB) GitHub リポジトリで入手できます。 Wingtip Tickets SaaS スクリプトをダウンロードし、ブロックを解除する手順については、[一般的なガイダンス](saas-tenancy-wingtip-app-guidance-tips.md)に関する記事をご覧ください。

## <a name="provision-additional-tenants"></a>その他のテナントのプロビジョニング

大規模なパフォーマンス監視および管理がどのように機能するかを十分に理解するために、このチュートリアルではシャード マルチテナント データベース内に複数のテナントが必要です。

以前のチュートリアルでテナントのバッチを既にプロビジョニングしている場合は、「[すべてのテナント データベースの使用をシミュレート](#simulate-usage-on-all-tenant-databases)」のセクションに進んでください。

1. **PowerShell ISE** で、…\\Learning Modules\\Performance Monitoring and Management\\*Demo-PerformanceMonitoringAndManagement.ps1* を開きます。 このスクリプトを開いたまま、このチュートリアルのシナリオをいくつか実行します。
1. **$DemoScenario** = **1** ("_テナントのバッチのプロビジョニング_") を設定します
1. **F5** キーを押して、スクリプトを実行します。

このスクリプトは、17 のテナントをマルチテナント データベースに数分でデプロイします。 

*New-TenantBatch* スクリプトは、シャード マルチテナント データベース内に一意のテナント キーを持つ新しいテナントを作成し、それらをテナント名と会場の種類で初期化します。 これは、アプリが新しいテナントをプロビジョニングする方法と一致します。 

## <a name="simulate-usage-on-all-tenant-databases"></a>すべてのテナント データベースの使用をシミュレート

マルチテナント データベースに対して実行されるワークロードをシミュレートする *Demo-PerformanceMonitoringAndManagement.ps1* スクリプトが用意されています。 使用可能な負荷のシナリオの 1 つを使用して、負荷が生成されます。

| デモ | シナリオ |
|:--|:--|
| 2 | 標準強度の負荷 (約 30 DTU) を生成する |
| 3 | テナントごとにバーストがより長い負荷を生成する|
| 4 | テナントごとに DTU バーストがより高い負荷 (約 70 DTU) を生成する|
| 5 | 1 つのテナントに高強度 (約 90 DTU) を、その他のすべてのテナントに標準強度の負荷を生成する |

ロード ジェネレーターは、"*合成*" CPU のみの負荷を、すべてのテナント データベースに適用します。 ジェネレーターはテナント データベースごとにジョブを開始し、これにより負荷を生成するストアド プロシージャが定期的に呼び出されます。 負荷レベル (DTU 単位)、期間、および間隔はすべてのデータベースにわたって変動するため、予測不可能なテナント アクティビティがシミュレートされます。

1. **PowerShell ISE** で、…\\Learning Modules\\Performance Monitoring and Management\\*Demo-PerformanceMonitoringAndManagement.ps1* を開きます。 このスクリプトを開いたまま、このチュートリアルのシナリオをいくつか実行します。
1. **$DemoScenario** = **2** (_標準強度の負荷を生成する_) を設定します。
1. **F5** キーを押して、負荷をすべてのテナントに適用します。

Wingtip Tickets SaaS マルチテナント データベースは SaaS アプリであり、SaaS アプリに対する実際の負荷は通常、散発的かつ予測不可能です。 これをシミュレートするために、ロード ジェネレーターはすべてのテナントに分散されるランダムな負荷を生成します。 負荷パターンが出現するまで数分かかるため、ロード ジェネレーターを 3 ～ 5 分実行してから、負荷を監視する次のセクションに進んでください。

> [!IMPORTANT]
> ロード ジェネレーターは、新しい PowerShell ウィンドウで一連のジョブとして実行されています。 このセッションを閉じると、ロード ジェネレーターは停止します。 ロード ジェネレーターは、ジェネレーターの開始後にプロビジョニングされた新しいテナントの負荷を生成する*ジョブ呼び出し*状態のままです。 *CTRL + C* を使用して新しいジョブの呼び出しを停止し、スクリプトを終了します。 既存のテナントに対してのみロード ジェネレーターの実行が続行されます。

## <a name="monitor-resource-usage-using-the-azure-portal"></a>Azure ポータルを使用したリソース使用の監視

適用されている負荷から発生したリソース使用状況を監視するには、テナントを含むマルチテナント データベース (**tenants1**) へのポータルを開きます。

1. [Azure Portal](https://portal.azure.com) を開き、サーバー *tenants1-mt-&lt;USER&gt;* を参照します。
1. 下へスクロールしてデータベースを見つけ、 **[tenants1]** をクリックします。 このシャード マルチテナント データベースには、これまでに作成されたすべてのテナントが含まれています。

![データベースのグラフ](./media/saas-multitenantdb-performance-monitoring/multitenantdb.png)

**DTU** のグラフを観察します。

## <a name="set-performance-alerts-on-the-database"></a>データベースにパフォーマンス アラートを設定する

データベースに \>75% の使用率でトリガーされるアラートを次のように設定します。

1. [Azure Portal](https://portal.azure.com) で (*tenants1-mt-&lt;USER&gt;* サーバー上の) *tenants1* データベースを開きます。
1. **[アラート ルール]** 、 **[+ アラートの追加]** の順にクリックします。

   ![アラートの追加](media/saas-multitenantdb-performance-monitoring/add-alert.png)

1. 名前 (**高 DTU** など) を付けます。
1. 次の値を設定します。
   * **メトリック = DTU の割合**
   * **条件 = より大きい**
   * **しきい値 = 75**。
   * **期間 = 過去 30 分間**
1. *[追加する管理者の電子メール]* ボックスに電子メール アドレスを追加し、 **[OK]** をクリックします。

   ![set alert](media/saas-multitenantdb-performance-monitoring/set-alert.png)

## <a name="scale-up-a-busy-database"></a>ビジー状態のデータベースをスケールアップする

データベースの負荷レベルがそのデータベースを使い切る状態まで増え、100% の DTU 使用率に達した場合は、データベースのパフォーマンスに影響を与え、クエリ応答時間が遅くなる可能性があります。

**短期的には**、追加のリソースを提供するようにデータベースをスケールアップするか、またはテナントをマルチテナント データベースから削除する (マルチテナント データベースからスタンドアロン データベースに移動する) ことを検討してください。

**長期的**には、クエリやインデックスの使用を最適化して、データベース パフォーマンスを向上させることを検討します。 アプリケーションがパフォーマンスの問題にどの程度影響されるかによっては、100% の DTU 使用率に達する前にデータベースをスケールアップすることがベスト プラクティスになります。 アラートを使用して、事前に警告するよう設定できます。

ジェネレーターによって生成される負荷を増やすことによって、ビジー状態のデータベースをシミュレートできます。 テナントがより頻繁に、かつより長くバーストするようにして、個々のテナントの要件を変更することなくマルチテナント データベースの負荷を増やします。 データベースのスケールアップはポータルで、または PowerShell から容易に実行されます。 ここでは、ポータルを使用します。

1. *$DemoScenario* = **3** (_データベースごとにバーストがより長く、より頻繁な負荷を生成する_) を設定して、各テナントに必要なピーク負荷を変更することなくデータベースの集計負荷の強度を増やします。
1. **F5** キーを押して、負荷をすべてのテナント データベースに適用します。
1. Azure Portal で **tenants1** データベースに移動します。

上部のグラフで、増加したデータベースの DTU 使用率を監視します。 新しい高負荷が開始されるまでには数分かかりますが、すぐにデータベースが最大の使用率に達し始めることが確認され、負荷が新しいパターンに固定されるとデータベースはすぐに過負荷になります。

1. データベースをスケールアップするには、設定ブレードの **[Pricing tier (scale DTUs)] (価格レベル (スケール DTU))** をクリックします。
1. **[DTU]** の設定を **100** に調整します。 
1. **[適用]** をクリックして、データベースをスケーリングする要求を送信します。

**[tenants1]**  >  **[概要]** に戻って、監視グラフを表示します。 データベースにより多くのリソースを提供した効果を監視します (ただし、テナントが少なく、負荷がランダム化されている場合は、ある程度の時間実行するまで、必ずしも最終的な確認が簡単に得られるとは限りません)。 グラフを見るときは、上部のグラフの 100% が現在 100 DTU を表すことを念頭においていますが、下部のグラフの 100% は依然として 50 DTU です。

データベースはオンラインのままで、プロセス全体で完全に使用できます。 アプリケーション コードは常に、削除された接続を再試行するように記述すべきであり、それによりデータベースに再接続します。

## <a name="provision-a-new-tenant-in-its-own-database"></a>独自のデータベース内の新しいテナントをプロビジョニングする 

シャード マルチテナント モデルでは、マルチテナント データベース内の新しいテナントを他のテナントと共にプロビジョニングするか、または独自のデータベース内のテナントをプロビジョニングするかを選択できます。 独自のデータベース内のテナントをプロビジョニングすると、個別のデータベースに固有の分離という利点が得られるため、そのテナントのパフォーマンスを他のテナントとは独立に管理したり、そのテナントを他のテナントとは独立に復元したりできるようになります。たとえば、無料試用版または通常の顧客をマルチテナント データベースに格納し、プレミアム顧客を個別のデータベースに格納することを選択できます。  分離されたシングルテナント データベースが作成された場合は、リソース コストを最適化するために、それらのデータベースを引き続きエラスティック プールでまとめて管理できます。

独自のデータベース内の新しいテナントを既にプロビジョニングしている場合は、次のいくつかの手順をスキップしてください。

1. **PowerShell ISE** で、…\\Learning Modules\\ProvisionTenants\\*Demo-ProvisionTenants.ps1* を開きます。 
1. **$TenantName = "Salix Salsa"** および **$VenueType = "dance"** を変更します。
1. **$Scenario** = **2** (_新しいシングルテナント データベース内のテナントをプロビジョニングする_) を設定します。
1. **F5** キーを押して、スクリプトを実行します。

このスクリプトは、個別のデータベース内のこのテナントをプロビジョニングし、データベースとテナントをカタログに登録してから、そのテナントの [イベント] ページをブラウザーで開きます。 [Events Hub] (イベント ハブ) ページを更新すると、会場として "Salix Salsa" が追加されたことを確認できます。

## <a name="manage-performance-of-an-individual-database"></a>個々のデータベースのパフォーマンス管理

マルチテナント データベース内の 1 つのテナントで高負荷が持続している場合は、それがデータベース リソースを占有する傾向にあって、同じデータベース内の他のテナントに影響を与える可能性があります。 そのアクティビティがしばらく続行しそうな場合は、このテナントをデータベースから独自のシングルテナント データベースに一時的に移動できます。 これにより、そのテナントに必要な追加のリソースを提供し、それを他のテナントから完全に分離できます。

この演習では、人気のあるイベントのチケットが発売されたときに高負荷が発生する Salix Salsa の影響をシミュレートします。

1. …\\*Demo-PerformanceMonitoringAndManagement.ps1* スクリプトを開きます。
1. **$DemoScenario = 5** ("_1 つのテナントに標準負荷に加えて高負荷 (約 90 DTU) を生成_") を設定します。
1. **$SingleTenantName = Salix Salsa** を設定します。
1. **F5** を使用して、スクリプトを実行します。

ポータルに移動し、 **[salixsalsa]**  >  **[概要]** に移動して、監視グラフを表示します。 

## <a name="other-performance-management-patterns"></a>その他のパフォーマンス管理パターン

**テナントのセルフサービス スケーリング**

スケーリングは管理 API 経由で簡単に呼び出されるタスクであるため、テナント データベースをテナント接続アプリケーションにスケーリングし、それを SaaS サービスの機能として提供する機能を容易に構築できます。 たとえば、テナントによるスケールアップ/スケールダウンの自己管理が可能で、場合によっては、これが請求に直接リンクされます。

**使用パターンに合わせたスケジュールでのデータベースのスケールアップおよびスケールダウン**

集計テナントの使用が予測可能な使用パターンに従っている場合は、Azure Automation を使用して、スケジュールでデータベースをスケールアップおよびスケールダウンできます。 たとえば、平日にリソースの要件が減ることがわかっている場合は、午後 6 時過ぎにデータベースをスケールダウンし、午前 6 時前に再度スケールアップします。

## <a name="next-steps"></a>次の手順

このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * 指定されたロード ジェネレーターを実行して、シャード マルチテナント データベースの使用をシミュレートする
> * 負荷の増加に対応しているときのデータベースを監視する
> * データベースの負荷の増加に対応してデータベースをスケールアップする
> * シングルテナント データベースにテナントをプロビジョニングする

## <a name="additional-resources"></a>その他のリソース

<!--* [Additional tutorials that build upon the Wingtip Tickets SaaS Multi-tenant Database application deployment](saas-multitenantdb-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)-->
* [Azure Automation](../automation/automation-intro.md)