<properties
	pageTitle="標準 geo レプリケーションまたはアクティブ geo レプリケーションのセキュリティ構成"
	description="このトピックでは、SQL Database の標準 geo レプリケーションまたはアクティブ geo レプリケーションのシナリオを管理するためのセキュリティに関する考慮事項について説明します。"
	services="sql-database"
	documentationCenter="na"
	authors="carlrabeler"
	manager="jhubbard"
	editor="monicar" />


<tags
	ms.service="sql-database"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="data-management"
	ms.date="02/01/2016"
	ms.author="carlrab" />

# 標準 geo レプリケーションまたはアクティブ geo レプリケーションのセキュリティ構成

## 概要
このトピックでは、[標準 geo レプリケーションおよびアクティブ geo レプリケーション](sql-database-geo-replication-overview.md)を構成し、制御するための認証要件と、セカンダリ データベースへのユーザー アクセスを設定するために必要な手順について説明します。geo レプリケーションの使用方法の詳細については、「[Azure SQL Database を障害から回復する](sql-database-disaster-recovery.md)」を参照してください。

## 包含ユーザーの使用
[Azure SQL Database の V12 バージョン](sql-database-v12-whats-new.md)で、包含ユーザーがサポートされるようになりました。従来のユーザーは master データベース内のログインにマップする必要がありましたが、包含ユーザーは、データベース自体で完全に管理されます。これには 2 つ利点があります。データベースがユーザーを管理するため、geo レプリケーションのシナリオでも、ユーザーは追加の構成なしで引き続きセカンダリ データベースに接続できます。また、ログインの観点からは、この構成を使用することで、スケーラビリティとパフォーマンスを向上できる可能性があります。詳細については、「[包含データベース ユーザー - データベースの可搬性を確保する](https://msdn.microsoft.com/library/ff929188.aspx)」を参照してください。

包含ユーザーでは、同じログインを使用するデータベースが複数ある場合、ログインをサーバー レベルで管理するのではなく、そのユーザーをデータベースごとに個別に管理する必要があります (パスワードの変更など)。

>[AZURE.NOTE] プライマリとセカンダリの読み取りアクセス権を個別に変更する場合は、従来のログインとユーザーを使用する必要があります。プライマリから独立してセカンダリで包含ユーザーを管理することはできません。

## 従来のログインとユーザーの使用
(包含ユーザーではなく) 従来のログインとユーザーを使用している場合、追加の手順を実行して、セカンダリ データベース サーバー上に同じログインが存在することを確認する必要があります。次のセクションでは、関連する手順とその他の考慮事項について概要を説明します。

### オンライン セカンダリへのユーザー アクセスの設定
フェールオーバーが発生した場合にセカンダリ データベースを読み取り専用データベース (オンライン セカンダリ) または有効なデータベース コピーとして使用できるようにするには、セカンダリ データベースに適切なセキュリティ構成が設定されている必要があります。

これ以降に説明する手順は、いずれもサーバー管理者のみが正常に実行できます。各手順の詳細なアクセス許可については、後ほど詳しく説明します。

アクティブ geo レプリケーション オンライン セカンダリに対するユーザー アクセスの準備は、いつでも実行できます。これには、大きく分けて次の 3 つの手順があります。

1. プライマリ データベースにアクセスできるログインを特定する。
2. ソース サーバーでそのログインの SID を検索する。
3. ソース サーバー側と同じ SID を設定したログインをターゲット サーバーで生成する。

#### 1\.プライマリ データベースにアクセスできるログインを特定する:
このプロセスの最初の手順は、ターゲット サーバー上に複製するログインを特定することです。そのために、ソース サーバーの論理 master データベースとプライマリ データベースでそれぞれ 1 回ずつ SELECT ステートメントを実行します。

サーバー管理者または **LoginManager** サーバー ロールのメンバーのみが、次の SELECT ステートメントを使用してソース サーバーのログインを特定できます。

	SELECT [name], [sid] 
	FROM [sys].[sql_logins] 
	WHERE [type_desc] = 'SQL_Login'

また、db\_owner データベース ロールのメンバー、dbo ユーザー、またはサーバー管理者のみが、プライマリ データベース内にあるすべてのデータベース ユーザー プリンシパルを特定できます。

	SELECT [name], [sid]
	FROM [sys].[database_principals]
	WHERE [type_desc] = 'SQL_USER'

#### 2\.手順 1. で特定したログインの SID を検索する:
前のセクションで実行したクエリの出力を比較して SID を一致させることで、サーバー ログインをデータベース ユーザーに対応付けることができます。一致する SID を持つデータベース ユーザーが対応付けられたログインは、そのデータベースのユーザー プリンシパルとしてデータベースに対するユーザー アクセス権が付与されます。

次のクエリを使用すると、データベース内のすべてのユーザー プリンシパルとその SID を表示できます。このクエリを実行できるのは、db\_owner データベース ロールのメンバーまたはサーバー管理者のみです。

	SELECT [name], [sid]
	FROM [sys].[database_principals]
	WHERE [type_desc] = 'SQL_USER'

>[AZURE.NOTE] **INFORMATION\_SCHEMA** ユーザーと **sys** ユーザーの SID は *NULL* で、**ゲスト** SID は **0x00** です。データベースの作成者が **DbManager** のメンバーではなくサーバー管理者だった場合、**dbo** SID は *0x01060000000001648000000000048454* で始まることがあります。

#### 3\.ターゲット サーバーでログインを生成する:
最後の手順では、1 つ以上のターゲット サーバーにアクセスし、適切な SID を使用してログインを生成します。基本的な構文は次のとおりです。

	CREATE LOGIN [<login name>]
	WITH PASSWORD = <login password>,
	SID = <desired login SID>

>[AZURE.NOTE] セカンダリへのユーザー アクセスを許可し、プライマリへのアクセスは許可しない場合は、次の構文を使用してプライマリ サーバーでユーザー ログインを変更します。
>
>ALTER LOGIN <login name> DISABLE
>
>DISABLE を実行してもパスワードは変更されないため、必要な場合にいつでも有効にできます。

## 連続コピー リレーションシップの終了時におけるユーザー アクセスの設定
フェールオーバーが発生した場合、プライマリとセカンダリの間の連続コピー リレーションシップを停止する必要があります。このプロセスの詳細については、「[Azure SQL Database を障害から回復する](sql-database-disaster-recovery.md)」を参照してください。

標準 geo レプリケーションの場合、ユーザーはオフライン セカンダリにアクセスできないため、ユーザー アカウントへの変更は連続コピー リレーションシップの終了時に行う必要があります。

ログイン SID がターゲット サーバー上に複製されていない場合、終了後のセカンダリ データベースへのアクセスはサーバー管理者のみに制限されます。レプリケーションを開始するユーザーが DbManager の場合、そのユーザーのログイン SID がソース サーバーからレプリケートされていない限り、セカンダリにはアクセスできません。レプリケーション プロセスの期間中、この状況が継続します。

レプリケーションが終了すると、終了プロセスの一環として、[dbo] ユーザー プリンシパルは、レプリケーションを開始したユーザーのログイン SID と一致するように変更され、ユーザーのアクセス権が回復します。他のデータベース ユーザーには、この処理は適用されません。

終了の完了後にユーザー アカウントがセカンダリにアクセスできるようにするには、終了操作を開始するために使用されたユーザー アカウントおよび関連付けられているログインがターゲット サーバーとデータベース上に存在する必要があります。

フェールオーバー後に必要な手順の詳細については、「[復旧された Azure SQL データベースの最終処理を行う](sql-database-recovered-finalize.md)」を参照してください。

## 次のステップ
SQL Database の geo レプリケーションをはじめとするビジネス継続性機能の詳細については、「[ビジネス継続性の概要](sql-database-business-continuity.md)」を参照してください。

<!---HONumber=AcomDC_0413_2016-->