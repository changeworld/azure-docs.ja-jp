---
title: Azure Cosmos DB での変更フィード プロセッサ ライブラリの操作
description: Azure Cosmos DB 変更フィード プロセッサ ライブラリの使用。
author: rafats
ms.service: cosmos-db
ms.devlang: dotnet
ms.topic: conceptual
ms.date: 11/06/2018
ms.author: rafats
ms.reviewer: sngun
ms.openlocfilehash: 35577f103979bf5f767e3b9d42548ed488e365c8
ms.sourcegitcommit: 8330a262abaddaafd4acb04016b68486fba5835b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/04/2019
ms.locfileid: "54041902"
---
# <a name="using-the-azure-cosmos-db-change-feed-processor-library"></a>Azure Cosmos DB 変更フィード プロセッサ ライブラリの使用

[Azure Cosmos DB 変更フィード プロセッサ ライブラリ](sql-api-sdk-dotnet-changefeed.md)を使用すると、複数のコンシューマーにイベント処理を分散させることができます。 このライブラリで、並列で実行されている複数のパーティションと複数のスレッド全体の変更の読み取りが簡単になります。

変更フィード プロセッサ ライブラリの主な利点は、各パーティションと継続トークンを管理する必要がないことと、各コンテナーを手動でポーリングする必要がないことです。

変更フィード プロセッサ ライブラリにより、並列で実行されている複数のパーティションと複数のスレッド全体の変更の読み取りが簡単になります。 リース メカニズムを使用して、パーティション全体の変更の読み取りが自動的に管理されます。 次の図のように、変更フィード プロセッサ ライブラリを使用している 2 つのクライアントを起動すると、2 つのクライアント間で作業が分割されます。 クライアント数を増やし続けると、クライアント全体で作業が分割されます。

![Azure Cosmos DB 変更フィード プロセッサ ライブラリの使用](./media/change-feed-processor/change-feed-output.png)

左側のクライアントが最初に起動され、すべてのパーティションの監視が開始されます。次に、2 つ目のクライアントが起動され、1 つ目のクライアントは 2 つ目のクライアントにリースの一部を渡します。 これは、複数のマシンとクライアント間で作業を分散する効率的な方法です。

同じコンテナーを監視し、同じリースを使用する 2 つのサーバーレス Azure 関数がある場合、プロセッサ ライブラリがパーティションを処理する方法によっては、2 つの関数で異なるドキュメントが取得される可能性があります。

## <a name="implementing-the-change-feed-processor-library"></a>変更フィード プロセッサ ライブラリの実装

変更フィード プロセッサ ライブラリの実装には、4 つの主要なコンポーネントがあります。 

1. **監視対象コンテナー:** 監視対象コンテナーには、変更フィードの生成元となるデータが含まれています。 監視対象コンテナーに対する挿入と変更が、コンテナーの変更フィードに反映されます。

1. **リース コンテナー:** リース コンテナーは、複数の worker 間での変更フィードの処理を調整します。 個別のコンテナーを使用して、リース (パーティションごとに 1 リース) が保存されます。 このリース コンテナーは、変更フィード プロセッサ が実行される場所の近くに書き込みリージョンを持つ別のアカウントに保存すると便利です。 リース オブジェクトには次の属性があります。

   * Owner:リースを所有するホストを指定します。

   * Continuation:特定のパーティションの変更フィード内の位置 (継続トークン) を指定します。

   * Timestamp:リースの最終更新時刻。タイムスタンプを使用して、リースを期限切れと見なすかどうかを確認できます。

1. **プロセッサ ホスト:** 各ホストは、アクティブなリースを保持するホストの他のインスタンスの数に基づいて、処理するパーティションの数を決定します。

   * すべてのホスト間でワークロードのバランスを取るために、ホストは起動時にリースを取得します。 ホストは定期的にリースを更新するので、リースはアクティブな状態に維持されます。

   * ホストは、読み取りを実行するたびにリースに対して前回の継続トークンのチェックポイント処理を実行します。 コンカレンシーの安全性を確保するために、ホストはリースを更新するたびに ETag をチェックします。 他のチェックポイント戦略もサポートされています。

   * シャットダウン時に、ホストはすべてのリースを解放します。ただし、継続情報は保持されるので、後で保存済みのチェックポイントから読み取りを再開できます。

   現時点では、ホストの数がパーティション (リース) の数を超えることはできません。

1. **コンシューマー:** コンシューマー (worker) は、各ホストによって開始された Change Feed の処理を実行するスレッドです。 プロセッサ ホストごとに複数のコンシューマーを使用できます。 各コンシューマーは、割り当てられているパーティションから Change Feed を読み取り、変更と期限切れのリースをホストに通知します。

変更フィード プロセッサのこれら 4 要素の連携のしくみについて理解を深めるために、次の図の例を見てみましょう。 監視対象コレクションでは、ドキュメントを保存し、パーティション キーとして 'City' を使用します。 青色のパーティションには、"A-E" の 'City' フィールドを含むドキュメントが格納されていることがわかります (他のパーティションも同様)。 2 つのホストがあり、各ホストは 4 つのパーティションから並列で読み取る 2 つのコンシューマーを使用しています。 矢印は、コンシューマーが Change Feed の特定の場所から読み取ることを示しています。 最初のパーティションでは、濃い青はまだ読み取られていない変更を表し、薄い青は変更フィードで既に読み取られた変更を表しています。 ホストはリース コレクションを使用して "Continuation" 値を保存することで、各コンシューマーの現在の読み取り位置を追跡します。

![変更フィード プロセッサの例](./media/change-feed-processor/changefeedprocessor.png)

### <a name="change-feed-and-provisioned-throughput"></a>変更フィードとプロビジョニング済みスループット

Cosmos コンテナーとの間のデータ移動では常に RU を消費するため、消費される RU に対して課金されます。 リース コンテナーによって消費される RU に対して課金されます。

## <a name="additional-resources"></a>その他のリソース

* [Azure Cosmos DB 変更フィード プロセッサ ライブラリ](sql-api-sdk-dotnet-changefeed.md)
* [NugGet パッケージ](https://www.nuget.org/packages/Microsoft.Azure.DocumentDB.ChangeFeedProcessor/)
* [GitHub のその他のサンプル](https://github.com/Azure/azure-documentdb-dotnet/tree/master/samples/ChangeFeedProcessor)

## <a name="next-steps"></a>次の手順

以下の記事で、変更フィードに関してさらに詳しく知ることができます。

* [変更フィードの概要](change-feed.md)
* [変更フィードを読み取る方法](read-change-feed.md)
* [Azure Functions を活用した変更フィードの使用](change-feed-functions.md)
