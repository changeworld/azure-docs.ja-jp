---
title: Azure Cosmos DB でのパーティション分割と水平スケーリング
description: Azure Cosmos DB でのパーティション分割のしくみ、パーティション分割とパーティション キーを構成する方法、アプリケーションに適したパーティション キーを選ぶ方法について説明します。
author: deborahc
ms.author: dech
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 04/28/2020
ms.openlocfilehash: 19e4c61ba930bb9b127e2401174bcea3fd240dce
ms.sourcegitcommit: 58faa9fcbd62f3ac37ff0a65ab9357a01051a64f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2020
ms.locfileid: "82234218"
---
# <a name="partitioning-and-horizontal-scaling-in-azure-cosmos-db"></a>Azure Cosmos DB でのパーティション分割と水平スケーリング

この記事では、論理パーティションと物理パーティションの関係について説明します。 さらに、パーティション分割のベスト プラクティスと、Azure Cosmos DB での水平方向のスケーリングのしくみについて詳しく説明します。 [パーティション キーを選択する](partitioning-overview.md#choose-partitionkey)ためにこれらの内部的な詳細を理解する必要はありませんが、Azure Cosmos DB のしくみを明確にするためにここで説明しています。

## <a name="logical-partitions"></a>論理パーティション

論理パーティションは、同じパーティション キーを持つ一連のアイテムで構成されます。 たとえば、食物の栄養に関するデータが含まれているコンテナーでは、すべてのアイテムに `foodGroup` プロパティが含まれています。 このコンテナーのパーティション キーとして `foodGroup` プロパティを使用できます。 `Beef Products`、`Baked Products`、`Sausages and Luncheon Meats` など、`foodGroup` に特定の値を持つアイテムのグループによって、個別の論理パーティションが形成されます。 基になるデータを削除するときに、論理パーティションの削除について心配する必要はありません。

論理パーティションでは、データベース トランザクションのスコープも定義します。 論理パーティション内のアイテムは、[スナップショット分離が指定されたトランザクション](database-transactions-optimistic-concurrency.md)を使用して更新することができます。 コンテナーに新しい項目が追加されると、新しい論理パーティションがシステムによって透過的に作成されます。

コンテナー内の論理パーティションの数に制限はありません。 各論理パーティションには、最大 20 GB のデータを格納できます。 適切なパーティション キーを選択すると、可能性がある多様な値を格納できます。 たとえば、すべてのアイテムに `foodGroup` プロパティが含まれているコンテナーでは、`Beef Products` 論理パーティション内のデータを最大 20 GB まで拡張できます。 可能性がある多様な値を格納できる[パーティション キーを選択](partitioning-overview.md#choose-partitionkey)することで、コンテナーを確実にスケーリングできます。

## <a name="physical-partitions"></a>物理パーティション

Azure Cosmos コンテナーは、物理パーティションを超えてデータとスループットを分散することでスケーリングされます。 内部的には、1 つまたは複数の論理パーティションが単一の物理パーティションにマップされます。 ほとんどの小さな Cosmos コンテナーには多数の論理パーティションがありますが、必要なのは 1 つの物理パーティションだけです。 論理パーティションとは異なり、物理パーティションはシステムの内部実装であり、完全に Azure Cosmos DB によって管理されます。

Cosmos コンテナー内の物理パーティションの数は、以下によって決まります。

- プロビジョニングされたスループットの量 (個々の物理パーティションは、1 秒あたり最大 10,000 の要求ユニットのスループットを提供できます)
- データ ストレージの合計 (個々の物理パーティションには最大 50 GB のデータを格納できます)

コンテナー内の物理パーティションの合計数に制限はありません。 プロビジョニングされたスループットまたはデータ サイズが増加すると、Azure Cosmos DB によって既存のパーティションが分割され、新しい物理パーティションが自動的に作成されます。 物理パーティションの分割がアプリケーションの可用性に影響を与えることはありません。 物理パーティションが分割された後も、単一の論理パーティション内のすべてのデータは同じ物理パーティションに格納されます。 物理パーティションの分割では、物理パーティションに対する論理パーティションの新しいマッピングが作成されるだけです。

コンテナーに対してプロビジョニングされたスループットは、物理パーティション間で均等に分割されます。 スループット要求を均等に分散しないパーティション キーの仕様により、"ホット" パーティションが作成される可能性があります。 ホット パーティションによって、レート制限が発生し、プロビジョニングされたスループットを効率的に使用できなくなり、コストが高くなる場合があります。

コンテナーの物理パーティションは、Azure portal の **[メトリック] ブレード**の **[ストレージ]** セクションで確認できます。

[![物理パーティションの数の表示](./media/partition-data/view-partitions-zoomed-out.png)](./media/partition-data/view-partitions-zoomed-in.png#lightbox)

パーティション キーとして `/foodGroup` が選択されているこの例のコンテナーでは、3 つの四角形のそれぞれが物理パーティションを表しています。 この図では、**パーティション キー範囲**は物理パーティションと同じです。 選択されている物理パーティションには、3 つの論理パーティション (`Beef Products`、`Vegetable and Vegetable Products`、および `Soups, Sauces, and Gravies`) が含まれています。

スループットを 1 秒あたり 18,000 の要求ユニット (RU/秒) でプロビジョニングした場合、3 つの物理パーティションでは、それぞれがプロビジョニングされたスループットの合計の 1/3 を利用できます。 選択されている物理パーティション内では、論理パーティション キー (`Beef Products`、`Vegetable and Vegetable Products`、および `Soups, Sauces, and Gravies`) は、物理パーティションにプロビジョニングされた 6,000 RU/秒を共同で利用できます。 プロビジョニングされたスループットはコンテナーの物理パーティション全体に均等に分割されるため、[適切な論理パーティション キーの選択](partitioning-overview.md#choose-partitionkey)によって、スループットの消費が均等に分散されるパーティション キーを選択することが重要です。 論理パーティション間でスループットの消費が均等に分散されるパーティション キーを選択すると、物理パーティション間でのスループットが確実に均等に消費されます。

## <a name="replica-sets"></a>レプリカ セット

各物理パーティションは、一連のレプリカで構成されます ("[*レプリカ セット*](global-dist-under-the-hood.md)" とも呼ばれます)。 各レプリカ セットでは、Azure Cosmos データベース エンジンのインスタンスがホストされます。 レプリカ セットにより、物理パーティション内に格納されたデータの耐久性、高可用性、一貫性が確保されます。 物理パーティションを構成する各レプリカは、そのパーティションのストレージ クォータを継承します。 物理パーティションのすべてのレプリカは、物理パーティションに割り当てられたスループットを一元的にサポートします。 レプリカ セットは Azure Cosmos DB によって自動的に管理されます。

ほとんどの小さな Cosmos コンテナーでは、単一の物理パーティションのみを必要としますが、少なくとも 4 つのレプリカを保持できます。

次の図は、グローバルに分散されている物理パーティションに論理パーティションがどのようにマップされているかを示しています。

![Azure Cosmos DB パーティション分割を示す図](./media/partition-data/logical-partitions.png)

## <a name="next-steps"></a>次のステップ

* [パーティション キーの選択](partitioning-overview.md#choose-partitionkey)について確認します。
* [Azure Cosmos DB におけるスループットのプロビジョニング](request-units.md)について理解します。
* [Azure Cosmos DB の世界規模での分散](distribute-data-globally.md)について理解します。
* [Azure Cosmos コンテナーのスループットをプロビジョニングする](how-to-provision-container-throughput.md)方法を確認する。
* [Azure Cosmos データベースのスループットをプロビジョニングする](how-to-provision-database-throughput.md)方法を確認する。
