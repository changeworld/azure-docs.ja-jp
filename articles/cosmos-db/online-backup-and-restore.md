---
title: Azure Cosmos DB でのオンライン バックアップとオンデマンドのデータ復元
description: この記事では、Azure Cosmos DB での自動オンライン バックアップとオンデマンドのデータ復元が動作するしくみを説明します。
author: kanshiG
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 05/21/2019
ms.author: govindk
ms.reviewer: sngun
ms.openlocfilehash: 4ca4fa8699d9bd4b35f26983f2f7004c63da180f
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/25/2019
ms.locfileid: "75441537"
---
# <a name="online-backup-and-on-demand-data-restore-in-azure-cosmos-db"></a>Azure Cosmos DB でのオンライン バックアップとオンデマンドのデータ復元

Azure Cosmos DB では、データのバックアップが一定の間隔で自動的に取得されます。 自動バックアップは、データベース操作のパフォーマンスや可用性に影響を与えずに取得されます。 すべてのバックアップは別々のストレージ サービス内に個別に保存されます。これらのバックアップは、リージョンの障害からの回復性を確保するためにグローバルにレプリケートされます。 自動バックアップは、Azure Cosmos アカウント、データベース、またはコンテナーを誤って削除または更新した後でデータの回復が必要になったシナリオの場合に役に立ちます。

## <a name="automatic-and-online-backups"></a>自動的なオンラインのバックアップ

Azure Cosmos DB では、データだけでなく、データのバックアップについても、冗長性とリージョンの障害からの回復性が高められています。 以下の手順は、Azure Cosmos DB によるデータのバックアップ方法を示しています。

* Azure Cosmos DB によって、データベースが 4 時間毎と任意の時点で自動的にバックアップされ、最新の 2 回分のバックアップのみが保存されます。 ただし、コンテナーまたはデータベースが削除された場合、Azure Cosmos DB には、ある特定のコンテナーまたはデータベースの既存のスナップショットが 30 日間保持されます。

* Azure Cosmos DB では、これらのバックアップが Azure Blob Storage に保存される一方、実際のデータは Azure Cosmos DB 内にローカルに存在します。

*  短い待機時間を保証するために、バックアップのスナップショットは、お使いの Azure Cosmos データベース アカウントの現在の書き込みリージョン (マルチマスター構成の場合は、いずれかの書き込みリージョン) と同じリージョンの Azure BLOB ストレージに保存されます。 リージョンの障害に対する回復性を確保するために、Azure BLOB ストレージにあるバックアップ データの各スナップショットが、地理冗長ストレージ (GRS) 経由でもう一度レプリケートされます。 バックアップのレプリケート先のリージョンは、ソース リージョンと、ソース リージョンに関連付けられているリージョン ペアに基づいています。 詳細については、[Azure リージョンの geo 冗長ペアの一覧](../best-practices-availability-paired-regions.md)の記事を参照してください。 このバックアップに直接アクセスすることはできません。 Azure Cosmos DB でこのバックアップが使用されるのは、バックアップの復元が開始された場合のみです。

* バックアップは、お使いのアプリケーションのパフォーマンスや可用性に影響を与えずに取得されます。 Azure Cosmos DB では、データのバックアップがバックグラウンドで実行され、プロビジョニング済みのスループット (RU) を余計に消費することも、データベースのパフォーマンスや可用性に影響することもありません。

* 誤ってデータを削除した場合またはデータが破損した場合は、Azure Cosmos DB チームがバックアップからのデータの復元をサポートできるように、8 時間以内に [Azure サポート](https://azure.microsoft.com/support/options/)に連絡してください。

次の図は、3 つのプライマリ物理パーティションがすべて米国西部にある Azure Cosmos コンテナーを、米国西部のリモートの Azure Blob Storage アカウントにバックアップした後、米国東部にレプリケートするようすを示しています。

![GRS Azure Storage 内のすべての Cosmos DB エンティティの定期的な完全バックアップ](./media/online-backup-and-restore/automatic-backup.png)

## <a name="options-to-manage-your-own-backups"></a>独自のバックアップを管理するためのオプション

Azure Cosmos DB SQL API アカウントをお持ちの場合は、次のいずれかの方法を使用して、独自のバックアップを維持することもできます。

* [Azure Data Factory](../data-factory/connector-azure-cosmos-db.md) を使用してデータを定期的に任意のストレージに移動します。

* Azure Cosmos DB の[変更フィード](change-feed.md)を使用して、変化の増分だけでなく、完全バックアップのデータも定期的に読み取り、独自のストレージに保存します。

## <a name="backup-retention-period"></a>バックアップのリテンション期間

Azure Cosmos DB では、4 時間ごとにデータのスナップショットが取得されます。 どのような場合でも、最新の 2 つのスナップショットのみが保持されます。 ただし、コンテナーまたはデータベースが削除された場合、Azure Cosmos DB には、ある特定のコンテナーまたはデータベースの既存のスナップショットが 30 日間保持されます。

## <a name="restoring-data-from-online-backups"></a>オンライン バックアップからのデータの復元

データの誤った削除または変更は、次のいずれかのシナリオで発生することが考えられます。  

* Azure Cosmos アカウント全体が削除される

* 1 つ以上の Azure Cosmos データベースが削除される

* 1 つ以上の Azure Cosmos コンテナーが削除される

* 1 つのコンテナー内の Azure Cosmos 項目 (たとえばドキュメント) が削除または変更される。 この特定のケースは一般に "データの破損" と呼ばれます。

* 共有オファー データベース、または共有オファー データベース内のコンテナーが削除されるか破損する

Azure Cosmos DB では、上記のすべてのシナリオにおいてデータを復元できます。 復元プロセスでは常に、復元されたデータを保持するための新しい Azure Cosmos アカウントが作成されます。 新しいアカウントの名前が指定されていない場合、名前は `<Azure_Cosmos_account_original_name>-restored1` の形式になります。 復元が複数回試行された場合は、最後の桁が増分されます。 事前に作成した Azure Cosmos アカウントにデータを復元することはできません。

Azure Cosmos アカウントが削除された場合は、アカウント名が使用されていないことを条件として、同じ名前のアカウントにデータを復元できます。 このような場合、削除後にアカウントを再作成しないことをお勧めします。復元されたデータに同じ名前が使用されなくなるだけでなく、復元の基になる適切なアカウントを検出することが難しくなるからです。 

Azure Cosmos データベースが削除されたときに、データベース全体またはそのデータベース内のコンテナーのサブセットを復元することができます。 複数のデータベースにまたがるコンテナーを選択して復元することも可能です。復元されたデータはすべて、新しい Azure Cosmos アカウントに配置されます。

1 つのコンテナー内にある 1 つ以上の項目を誤って削除または変更した場合 (データの破損のケース)、どの時点まで復元するかを指定する必要があります。 このケースの最重要点は時間です。 コンテナーはライブ状態であるため、バックアップはまだ実行中です。したがって、保持期間 (既定では 8 時間) より長く待機すると、バックアップは上書きされます。 削除のケースでは、データがバックアップ サイクルによって上書きされることはないので、データは保存されません。 削除されたデータベースまたはコンテナーのバックアップは、30 日間保存されます。

データベース レベルのスループットをプロビジョニングする場合 (つまり、プロビジョニングしたスループットを一連のコンテナーで共有する場合)、このケースのバックアップと復元のプロセスは個々のコンテナー レベルではなく、データベース全体のレベルで行われます。 このようなケースでは、復元するコンテナーのサブセットを選択することはできません。

## <a name="migrating-data-to-the-original-account"></a>元のアカウントへのデータの移行

データ復元の主な目的は、誤って削除または変更したデータを復旧する方法を提供することです。 そのため、最初に、復旧したデータの内容を検査して、必要なデータが含まれているか確認することをお勧めします。 その後、データを元のプライマリ アカウントに移行する作業を行います。 復元したアカウントをライブ アカウントとして使用することは可能ですが、運用ワークロードが存在する場合のオプションとしてはお勧めしません。  

データを元の Azure Cosmos アカウントに移行するさまざまな方法を以下に示します。

* [Cosmos DB データ移行ツール](import-data.md)を使用する
* [Azure Data Factory]( ../data-factory/connector-azure-cosmos-db.md) を使用する
* Azure Cosmos DB の[変更フィード](change-feed.md)を使用する 
* カスタム コードの作成

復元したアカウントには引き続き料金が発生するため、移行が完了したらすぐに削除してください。

## <a name="next-steps"></a>次のステップ

次に、Azure Cosmos アカウントからデータを復元する方法、またはデータを Azure Cosmos アカウントに移行する方法について学習します。

* 復元の要請を行うために、Azure サポートに連絡して [Azure portal からチケットを申請](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade)する。
* [Azure Cosmos アカウントからデータを復元する方法](how-to-backup-and-restore.md)
* [Cosmos DB 変更フィードを使用](change-feed.md)してデータを Azure Cosmos DB に移動する。
* [Azure Data Factory を使用](../data-factory/connector-azure-cosmos-db.md)してデータを Azure Cosmos DB に移動する。

