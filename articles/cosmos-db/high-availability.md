---
title: Azure Cosmos DB での高可用性
description: この記事では、Azure Cosmos DB で高可用性を実現する方法について説明します
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 06/28/2019
ms.author: mjbrown
ms.reviewer: sngun
ms.openlocfilehash: 928c943e21e7d00b87ac1e506b98d47107ac4348
ms.sourcegitcommit: 79496a96e8bd064e951004d474f05e26bada6fa0
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/02/2019
ms.locfileid: "67508563"
---
# <a name="high-availability-with-azure-cosmos-db"></a>Azure Cosmos DB での高可用性

Azure Cosmos DB では、Cosmos アカウントに関連付けられているすべての Azure リージョンにデータが透過的にレプリケートされます。 Cosmos DB では、次の図のように、複数層のデータ冗長性が採用されています。

![物理的パーティション分割](./media/high-availability/cosmosdb-data-redundancy.png)

- Cosmos コンテナー内のデータは、[水平方向にパーティション分割されます](partitioning-overview.md)。

- 各リージョン内のすべてのパーティションは、すべての書き込みがレプリケートされ、レプリカの大多数によって永続的にコミットされたレプリカ セットによって保護されます。 レプリカは、最大で 10 ~ 20 個の障害ドメインに分散されます。

- すべてのリージョンで、各パーティションがレプリケートされます。 各リージョンには Cosmos コンテナーのすべてのデータ パーティションが含まれており、書き込みを受け入れて読み取りに対応できます。  

Cosmos アカウントが *N* 個の Azure リージョンに分散している場合は、すべてのデータの少なくとも *N* x 4 個のコピーが存在します。 データ アクセスの待ち時間を短くし、書き込み/読み取りスループットを Cosmos アカウントに関連付けられたリージョンにわたってスケーリングすることに加えてリージョン数 (*N*) を増やすと、可用性はさらに向上します。  

## <a name="slas-for-availability"></a>可用性に関する SLA

グローバル分散型データベースとしての Cosmos DB は、スループット、99 パーセンタイルの待ち時間、一貫性、および高可用性を含む包括的な SLA を提供します。 次の表では、単一リージョンおよび複数リージョンのアカウントについて Cosmos DB によって提供される高可用性の保証について説明します。 高可用性のために、常に、複数の書き込みリージョンが存在するように Cosmos アカウントを構成してください。

|操作の種類  | 単一リージョン |複数リージョン (単一リージョンの書き込み)|複数リージョン (複数リージョンの書き込み) |
|---------|---------|---------|-------|
|書き込み    | 99.99    |99.99   |99.999|
|読み取り     | 99.99    |99.999  |99.999|

> [!NOTE]
> 実際には、有界整合性制約、セッション、一貫性のあるプレフィックス、および最終的整合性モデルに関する実際の書き込み可用性は、公開された SLA より大幅に高くなります。 すべての整合性レベルについての実際の読み取り可用性は、公開された SLA よりもずっと高くなります。

## <a name="high-availability-with-cosmos-db-in-the-event-of-regional-outages"></a>リージョン障害が発生した場合の Cosmos DB の高可用性

リージョン障害は珍しいことではなく、Azure Cosmos DB はデータベースを常に高可用性の状態に維持します。 Cosmos アカウントの構成に応じた、障害発生中の Cosmos DB の動作の詳細を次に示します。

- Cosmos DB では、クライアントに対して書き込み操作が承認される前に、書き込み操作を受け入れるリージョン内のレプリカのクォーラムによってデータが永続的にコミットされます。

- 複数書き込みリージョンで構成された複数リージョン アカウントは、書き込みと読み取りの両方について高可用性を実現します。 リージョン間フェールオーバーは瞬間的であるため、アプリケーションからの変更は必要ありません。

- **単一書き込みリージョンで構成された複数リージョン アカウント (書き込みリージョン障害):** これらのアカウントでは、書き込みリージョンの障害発生時に読み取りの高可用性が維持されます。 ただし、書き込みの場合は、影響を受けたリージョンを別のリージョンにフェールオーバーするために、Cosmos アカウントで **"自動フェールオーバーを有効にする"** 必要があります。 フェールオーバーは、指定したリージョンの優先順位に従って実行されます。 影響を受けたリージョンがオンラインに戻ると、障害発生中に影響を受けた書き込みリージョン内に存在するレプリケートされていないデータは、[競合フィード](how-to-manage-conflicts.md#read-from-conflict-feed)によって使用可能になります。 アプリケーションは競合フィードを読み取り、そのアプリケーション固有のロジックに基づいて競合を解決した後、更新されたデータを必要に応じて Cosmos コンテナーに書き戻すことができます。 以前影響を受けた書き込みリージョンが復旧すると、自動的に読み取りリージョンとして利用可能になります。 手動フェールオーバーを呼び出し、影響を受けたリージョンを書き込みリージョンとして構成できます。 この場合も、[Azure CLI または Azure Portal](how-to-manage-database-account.md#manual-failover) を使用して手動フェールオーバーを実行できます。 手動フェールオーバーの前後や最中に、**データや可用性が損なわれることはありません**。 アプリケーションの高可用性が維持されます。 

- **単一書き込みリージョンで構成された複数リージョン アカウント (読み取りリージョン障害):** これらのアカウントでは、読み取りリージョンの障害発生時に読み取りおよび書き込みの高可用性が維持されます。 影響を受けたリージョンは自動的に書き込みリージョンから切断され、オフラインとしてマークされます。 [Cosmos DB SDK](sql-api-sdk-dotnet.md) は、読み取り呼び出しを、優先リージョンの一覧にある次の使用可能なリージョンにリダイレクトします。 優先リージョンの一覧にあるいずれのリージョンも使用可能でない場合、呼び出しは自動的に現在の書き込みリージョンに戻ります。 読み取りリージョン障害を処理するアプリケーション コードは、変更する必要はありません。 最終的に、影響を受けたリージョンがオンラインに戻ったとき、以前影響を受けた読み取りリージョンは現在の書き込みリージョンと自動的に同期され、読み取り要求に再び対応できるようになります。 それ以降の読み取りは、アプリケーション コードを変更しなくても、回復したリージョンにリダイレクトされます。 フェールオーバー中も、以前に障害が発生したリージョンの再参加中も、読み取り一貫性の保証は引き続き Cosmos DB によって遵守されます。

- 単一リージョンのアカウントは、リージョンの障害の後で可用性を失う場合があります。 常に高可用性を確認するために、Cosmos アカウントで**少なくとも 2 つのリージョン** (可能であれば、少なくとも 2 つの書き込みリージョン) を設定することを常にお勧めします。

- Azure リージョンが永久に回復不可能になるという、まれで不運な状況でも、複数リージョン Cosmos アカウントが *[厳密]* の既定の整合性レベルで構成されていれば、データ損失は発生しません。 永久に回復不可能な書き込みリージョンが発生した場合、有界整合性制約の整合性で構成された複数リージョン Cosmos アカウントでは、潜在的なデータ損失期間は整合性制約期間 (*K* または *T*) に制限されます。セッション、一貫性のあるプレフィックス、最終的整合性の各レベルの場合、潜在的なデータ損失期間は最大 5 秒に制限されます。 

## <a name="availability-zone-support"></a>可用性ゾーンのサポート

Azure Cosmos DB は、リージョンの障害発生時に、高可用性と回復性を提供する、グローバルに分散されたマルチマスター データベース サービスです。 リージョン間の回復性に加えて、Azure Cosmos データベースに関連付けるリージョンを選択するときに、**ゾーンの冗長性**を有効にできるようになりました。 

可用性ゾーンのサポートにより、Azure Cosmos DB では、特定のリージョン内でレプリカが複数のゾーンに配置され、ゾーンの障害発生時に、高可用性と回復性を提供することが保証されます。 この構成で待機時間とその他の SLA の変更はありません。 単一のゾーンの障害の発生時に、ゾーンの冗長性により、RPO = 0 で完全なデータの持続性を提供し、RTO = 0 で可用性を提供します。 

ゾーンの冗長性は、[マルチ マスター レプリケーション](how-to-multi-master.md)機能の*補足機能*です。 リージョンの回復性を実現するために、ゾーンの冗長性だけに依存することはできません。 たとえば、リージョンの障害またはリージョン全体への低待機時間アクセスの発生時には、ゾーン冗長性だけでなく、複数の書き込みリージョンを使用することをお勧めします。 

Azure Cosmos アカウントに複数リージョンの書き込みを構成すると、追加のコストを必要とせずに、ゾーン冗長性を実現できます。 それ以外の場合、ゾーン冗長性のサポートの料金に関する後述の注意事項を参照してください。 リージョンを削除し、ゾーン冗長性を有効にしてそれを戻すことによって、Azure Cosmos アカウントの既存のリージョンでゾーン冗長性を有効にできます。

この機能は、次の Azure リージョンで使用できます。

* 英国南部
* 東南アジア 
* East US
* 米国東部 2 
* 米国中部

> [!NOTE] 
> 1 つのリージョンの Azure Cosmos アカウントに対して可用性ゾーンを有効にすると、アカウントにリージョンを追加することと同等の課金が発生します。 価格の詳細については、[価格のページ](https://azure.microsoft.com/pricing/details/cosmos-db/)と[Azure Cosmos DB における複数リージョンのコスト](optimize-cost-regions.md)に関する記事を参照してください。 

次の表に、さまざまなアカウント構成の高可用性機能をまとめています。 

|KPI  |可用性ゾーンがない単一リージョン (非 AZ)  |可用性ゾーンがある単一リージョン (AZ)  |可用性ゾーンがある複数リージョン書き込み (AZ、2 リージョン) - 最も推奨される設定 |
|---------|---------|---------|---------|
|書き込み可用性 SLA     |   99.99%      |    99.99%     |  99.999%  |
|読み取り可用性 SLA   |   99.99%      |   99.99%      |  99.999%       |
|料金  |  単一リージョン課金レート |  単一リージョンの可用性ゾーンの課金レート |  複数リージョン課金レート       |
|ゾーンの障害 – データ損失   |  データ損失  |   データ損失なし |   データ損失なし  |
|ゾーンの障害 - 可用性 |  可用性の損失  | 可用性の損失なし  |  可用性の損失なし  |
|読み取り待機時間    |  リージョン間    |   リージョン間   |    低  |
|書き込み待機時間    |   リージョン間   |  リージョン間    |   低   |
|リージョンの障害 - データ損失    |   データ損失      |  データ損失       |   データ損失 <br/><br/> マルチ マスターと複数のリージョンで有界整合性制約の一貫性を使用すると、データの損失は、アカウントに構成された有界整合性制約に制限されます。 <br/><br/> 複数のリージョンで強力な一貫性を構成することで、リージョンの障害発生時のデータの損失を回避できます。 このオプションには、可用性とパフォーマンスに影響を与えるトレードオフが伴います。      |
|リージョンの障害 - 可用性  |  可用性の損失       |  可用性の損失       |  可用性の損失なし  |
|スループット    |  X RU/秒 プロビジョニング スループット      |  X RU/秒 プロビジョニング スループット       |  2X RU/秒 プロビジョニング スループット <br/><br/> この構成モードでは、2 つのリージョンがあるため、可用性ゾーンがある単一のリージョンと比較した場合に、2 倍のスループットの量が必要です。   |

> [!NOTE] 
> 可用性ゾーンのサポートを有効にするには、Azure Cosmos DB アカウントでマルチマスター/マルチ リージョン書き込みを有効にする必要があります。 

新規または既存の Azure Cosmos アカウントにリージョンを追加すると、ゾーン冗長性を有効にできます。 現在、Azure portal、PowerShell、および Azure Resource Manager テンプレートを使用した場合にのみ、ゾーン冗長性を有効にできます。 Azure Cosmos アカウントでゾーン冗長性を有効にするには、特定の場所 の`isZoneRedundant` フラグを `true` に設定する必要があります。 場所プロパティ内に、このフラグを設定できます。 たとえば、次の PowerShell スニペットでは、"東南アジア" リージョンのゾーン冗長性が有効になります。

```powershell
$locations = @( 
    @{ "locationName"="Southeast Asia"; "failoverPriority"=0; "isZoneRedundant"= "true" }, 
    @{ "locationName"="East US"; "failoverPriority"=1 } 
) 
```

Azure Cosmos アカウントを作成するときに Azure portal を使用して、可用性ゾーンを有効にすることができます。 アカウントを作成するときは、必ず **[geo 冗長性]** 、 **[マルチ リージョン書き込み]** を有効にして、可用性ゾーンがサポートされているリージョンを選択します。 

![Azure portal を使用して可用性ゾーンを有効にする](./media/high-availability/enable-availability-zones-using-portal.png) 

## <a name="building-highly-available-applications"></a>高可用性アプリケーションの構築

- 書き込みと読み込みの高可用性を確保するために、複数書き込みリージョンを持つ少なくとも 2 つのリージョンにまたがるように Cosmos アカウントを構成します。 この構成は、SLA によって裏付けられた読み取りと書き込みの両方に対して、最も高い可用性、最も短い待ち時間、および最高のスケーラビリティを提供します。 詳しくは、[複数書き込みリージョンで Cosmos アカウントを構成する](tutorial-global-distribution-sql-api.md)方法をご覧ください。

- 単一書き込みリージョンで構成されている複数リー ジョンの Cosmos アカウントでは、[Azure CLI または Azure portal を使用して自動フェールオーバーを有効にします](how-to-manage-database-account.md#automatic-failover)。 自動フェールオーバーを有効にすると、リージョンで災害が発生するたびに Cosmos DB はアカウントを自動的にフェールオーバーします。  

- Cosmos アカウントの可用性が高くても、アプリケーションが高可用性を維持するよう正しく設計できていないこともあります。 アプリケーションのエンド ツー エンドの高可用性をテストするには、アプリケーションのテストまたはディザスター リカバリー (DR) テストの一部として、[Azure CLI または Azure Portal を使用して手動フェールオーバー](how-to-manage-database-account.md#manual-failover)を定期的に呼び出します。

- グローバルに分散されるデータベース環境内では、リージョン全体にわたる停止が発生した場合の整合性レベルとデータ持続性の間には、直接的な関係があります。 ビジネス継続性計画を開発するときは、破壊的なイベントが発生してから、アプリケーションが完全に復旧するまでの最大許容時間について理解する必要があります。 アプリケーションを完全に復旧するために必要な時間は、目標復旧時間 (RTO) と呼ばれます。 さらに、破壊的なイベントの発生後、復旧中にアプリケーションが損失を許容できる新しいデータ更新の最大期間についても理解する必要があります。 損失を許容できる更新の期間は、目標復旧時点 (RPO) と呼ばれます。 Azure Cosmos DB の RPO および RTO を表示するには、「[整合性レベルとデータ持続性](consistency-levels-tradeoffs.md#rto)」を参照してください。

## <a name="next-steps"></a>次の手順

次に、次の記事を読むことができます。

* [さまざまな整合性レベルでの可用性およびパフォーマンスのトレードオフ](consistency-levels-tradeoffs.md)
* [プロビジョニング スループットのグローバルなスケーリング](scaling-throughput.md)
* [グローバル分散 - 内部のしくみ](global-dist-under-the-hood.md)
* [Azure Cosmos DB の整合性レベル](consistency-levels.md)
* [複数の書き込みリージョンで Cosmos アカウントを構成する方法](how-to-multi-master.md)
