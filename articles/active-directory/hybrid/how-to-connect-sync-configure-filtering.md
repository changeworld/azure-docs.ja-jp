---
title: 'Azure AD Connect 同期: フィルター処理の構成 | Microsoft Docs'
description: Azure AD Connect Sync でフィルター処理を構成する方法を説明します。
services: active-directory
documentationcenter: ''
author: billmath
manager: daveba
editor: ''
ms.assetid: 880facf6-1192-40e9-8181-544c0759d506
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 03/26/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 983699dfbfe3e8fa332da4810d1514a11029077f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "79230123"
---
# <a name="azure-ad-connect-sync-configure-filtering"></a>Azure AD Connect 同期: フィルター処理の構成
フィルター処理を使用することによって、オンプレミスのディレクトリからどのオブジェクトを Azure Active Directory (Azure AD) に反映するかを制御できます。 既定の構成では、構成されているフォレスト内の全ドメインの全オブジェクトが対象となります。 通常は、この構成を推奨します。 Office 365 のワークロード (Exchange Online、Skype for Business など) を使っているユーザーには、完全なグローバル アドレス一覧を表示した方が、電子メールの送信先や電話の相手を探すうえで便利です。 既定では、オンプレミス環境の Exchange または Lync と同じ利便性が得られるように構成されています。

ただし、場合によっては、既定の構成に変更を加えなければならないこともあります。 次に例をいくつか示します。

* [マルチ Azure AD ディレクトリ トポロジ](plan-connect-topologies.md#each-object-only-once-in-an-azure-ad-tenant)の使用を計画しています。 そのうえでフィルターを適用し、特定の Azure AD ディレクトリに対してどのオブジェクトを同期させるかを制御する必要があります。
* Azure または Office 365 を試験運用しており、Azure AD に存在するユーザーの一部だけが必要な場合、 小規模な試験では、完全なグローバル アドレス一覧がなくても機能を検証することができます。
* Azure AD に含める必要のない、個人用以外のアカウント (サービス アカウントなど) が多数存在します。
* コンプライアンス上の理由から、オンプレミスのユーザー アカウントは一切削除できないので 単に無効にします。 一方、Azure AD には、アクティブなアカウントだけが必要になります。

この記事では、各種フィルター処理方法の構成について説明します。

> [!IMPORTANT]
> 公式に文書化されているアクションを除き、Microsoft は Azure AD Connect Sync の変更や操作をサポートしません。 サポートされていないアクションを行うと、Azure AD Connect Sync が不整合な状態になったり、サポートされていない状態になったりする可能性があります。結果的に、Microsoft ではこのようなデプロイについてテクニカル サポートを提供できなくなります。

## <a name="basics-and-important-notes"></a>基本事項と注意事項
Azure AD Connect Sync では、いつでもフィルター処理を有効にできます。 最初に既定の構成でディレクトリ同期を実行した後、フィルター処理を構成した場合、フィルター処理により除外されるオブジェクトは、Azure AD に対する同期の対象外になります。 この変更により、以前同期されてからフィルター処理された Azure AD のオブジェクトは、すべて Azure AD から削除されます。

フィルター処理に変更を加える際は、未検証の変更が意図せずエクスポートされてしまうことのないよう、あらかじめ[タスクのスケジューリングを無効に](#disable-the-scheduled-task)しておいてください。

フィルター処理によって多くのオブジェクトが同時に削除される可能性があります。フィルター処理に変更を加えたら、必ず検証したうえで、Azure AD に変更をエクスポートするようにしてください。 構成作業を終えたら、変更内容を Azure AD にエクスポートして反映する前に[検証作業](#apply-and-verify-changes)を実行することを強くお勧めします。

意図せず多数のオブジェクトを削除してしまうことのないよう、"[誤って削除されないように保護する](how-to-connect-sync-feature-prevent-accidental-deletes.md)" 機能が既定で有効になっています。 フィルター処理で多数のオブジェクトを削除する場合 (既定では 500 個)、この記事の手順に従って、削除処理を Azure AD に反映できるようにする必要があります。

November 2015 ([1.0.9125](reference-connect-version-history.md#1091250)) より前のビルドを使用し、フィルターの構成を変更して、パスワード ハッシュ同期を使用する場合は、構成を完了した後、すべてのパスワードの完全同期をトリガーする必要があります。 パスワードの完全同期をトリガーする方法の手順については、「[すべてのパスワードの完全同期の開始](tshoot-connect-password-hash-synchronization.md#trigger-a-full-sync-of-all-passwords)」を参照してください。 ビルド 1.0.9125 以降を使用している場合、パスワードを同期する必要があるかどうかとこの特別な手順が今後必要かどうかの計算も、通常の**完全同期**処理で行われます。

フィルター処理のエラーが原因で**ユーザー** オブジェクトが Azure AD から誤って削除された場合、フィルター処理構成を削除することで Azure AD 内にユーザー オブジェクトを再生成できます。 その後、ディレクトリの同期を再実行できます。 この操作により、Azure AD 内のごみ箱からユーザーが復元されます。 ただし、その他の種類のオブジェクトについては削除を取り消すことができません。 たとえば、リソースの ACL に使用されていたセキュリティ グループをうっかり削除すると、そのグループおよび対応する ACL は復元できなくなります。

削除されるのは、Azure AD Connect の作用対象 (スコープ) として認識されていたオブジェクトだけです。 別の同期エンジンによって作成されたオブジェクトが Azure AD 内に存在していても、それらがスコープ内に存在しない場合、フィルター処理を追加しても、それらのオブジェクトは削除されません。 たとえば、当初 DirSync サーバーによって Azure AD 内のディレクトリ全体が完全にコピーされているとき、最初からフィルター処理を有効にした状態で新しい Azure AD Connect Sync サーバーをインストールした場合、DirSync によって別途作成されたオブジェクトは、Azure AD Connect によって削除されません。

新しいバージョンの Azure AD Connect のインストールまたはアップグレードを行ってもフィルター処理の構成は保持されます。 新しいバージョンにアップグレードした後は、常に構成が誤って変更されていないことを確認してから、最初の同期サイクルを実行することをお勧めします。

複数のフォレストが存在する場合、このトピックで説明するフィルター処理構成をすべてのフォレストに適用する必要があります (すべてのフォレストに同じ構成を適用する場合)。

### <a name="disable-the-scheduled-task"></a>スケジュールされたタスクを無効にする
同期サイクルを 30 分おきにトリガーする、組み込みのスケジューラを無効にするには、以下の手順に従います。

1. PowerShell プロンプトに移動します。
2. `Set-ADSyncScheduler -SyncCycleEnabled $False` を実行して、スケジューラを無効にします。
3. この記事で説明されているとおりに変更します。
4. `Set-ADSyncScheduler -SyncCycleEnabled $True` を実行して、再度スケジューラを有効にします。

**1.1.105.0 より前の Azure AD Connect のビルドを使用している場合**  
同期サイクルを 3 時間おきにトリガーする、スケジュールされたタスクを無効にするには、以下の手順に従います。

1. **[スタート]** メニューから **[タスク スケジューラ]** を起動します。
2. **[タスク スケジューラ ライブラリ]** の直下から **Azure AD Sync Scheduler** というタスクを探して右クリックし、 **[無効]** を選択します。  
   ![タスク スケジューラ](./media/how-to-connect-sync-configure-filtering/taskscheduler.png)  
3. 以上の作業が済んだら構成の変更を行い、**Synchronization Service Manager** コンソールから同期エンジンを手動で実行できます。

フィルター処理の変更がすべて完了したら、忘れずにタスクの状態を **[有効]** に戻してください。

## <a name="filtering-options"></a>フィルター処理オプション
ディレクトリ同期ツールには、次のフィルター処理構成タイプを適用できます。

* [**グループ ベース**](#group-based-filtering): 単一のグループに基づくフィルター処理は、インストール ウィザードを使用して、初回インストール時にのみ構成できます。
* [**ドメイン ベース**](#domain-based-filtering): このオプションを使用すると、どのドメインを Azure AD に同期させるかを選択できます。 また、Azure AD Connect Sync をインストールした後にオンプレミス インフラストラクチャに変更を加えた場合、同期エンジンの構成でドメインを追加または削除することができます。
* [**組織単位 (OU) ベース**](#organizational-unitbased-filtering): このオプションを使用すると、どの OU を Azure AD に同期させるかを選択できます。 選択された OU 内のすべてのオブジェクト タイプが対象となります。
* [**属性ベース**](#attribute-based-filtering): このオプションを使用すると、オブジェクトの属性値に基づいてオブジェクトをフィルター処理できます。 オブジェクトの種類ごとに異なるフィルターを使用することもできます。

フィルター処理のオプションは、同時に複数使用することができます。 たとえば、1 つの OU 内のオブジェクトのみを含めるために OU ベース フィルター処理を使用できます。 同時に、オブジェクトをさらにフィルター処理するために属性ベースのフィルター処理を使用できます。 複数のフィルター処理方法を使用した場合、それらのフィルターが "論理積" で組み合わされます。

## <a name="domain-based-filtering"></a>ドメイン ベースのフィルター処理
このセクションでは、ドメイン フィルターを構成する手順について説明します。 Azure AD Connect をインストールした後にフォレスト内のドメインを追加または削除した場合は、フィルター処理の構成も更新する必要があります。

ドメイン ベースのフィルター処理を変更する場合は、インストール ウィザードを実行して、[ドメインと OU のフィルター処理](how-to-connect-install-custom.md#domain-and-ou-filtering)を変更することをお勧めします。 インストール ウィザードは、このトピックに記載されているすべてのタスクを自動化します。

なんらかの理由でインストール ウィザードを実行できない場合にだけ、以下の手順に従う必要があります。

ドメイン ベースのフィルター処理構成は、次の手順から成ります。

1. 同期の対象とするドメインを選択します。
2. 追加または削除された各ドメインについて、実行プロファイルを調整します。
3. [変更の適用と検証](#apply-and-verify-changes)を行います。

### <a name="select-the-domains-to-be-synchronized"></a>同期するドメインを選択する
同期するドメインを選択する方法は 2 つあります。
    - 同期サービスを使用する
    - Azure AD Connect ウィザードを使用する。


#### <a name="select-the-domains-to-be-synchronized-using-the-synchronization-service"></a>同期サービスを使用して同期するドメインを選択する
ドメイン フィルターを設定するには、次の手順を実行します。

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているサーバーにサインインします。
2. **[スタート]** メニューから **[同期サービス]** を起動します。
3. **[コネクタ]** を選択し、 **[コネクタ]** の一覧から、種類が "**Active Directory Domain Services**" であるコネクタを選択します。 **[アクション]** の **[プロパティ]** を選択します。  
   ![コネクタのプロパティ](./media/how-to-connect-sync-configure-filtering/connectorproperties.png)  
4. **[ディレクトリ パーティションの構成]** をクリックします。
5. **[ディレクトリ パーティションの選択]** の一覧で、必要に応じてドメインを選択 (または選択を解除) します。 同期するパーティションのみが選択されていることを確認します。  
   ![パーティション](./media/how-to-connect-sync-configure-filtering/connectorpartitions.png)  
   オンプレミスの Active Directory インフラストラクチャに変更を加え、フォレストのドメインを追加または削除した場合は、 **[更新]** ボタンをクリックして一覧を最新の情報に更新します。 最新の情報に更新しようとすると資格情報を求められます。 Windows Server Active Directory に対する読み取りアクセス権を持った資格情報を指定します。 ダイアログ ボックスにあらかじめ設定されているユーザーでなくてもかまいません。  
   ![更新が必要](./media/how-to-connect-sync-configure-filtering/refreshneeded.png)  
6. 完了したら、 **[OK]** をクリックして **[プロパティ]** ダイアログを閉じます。 フォレストからドメインを削除した場合、ドメインが削除されたことを示すメッセージが表示され、その構成がクリーンアップされます。
7. 続けて実行プロファイルを調整します。

#### <a name="select-the-domains-to-be-synchronized-using-the-azure-ad-connect-wizard"></a>Azure AD Connect ウィザードを使用して同期するドメインを選択する
ドメイン フィルターを設定するには、次の手順を実行します。

1.  Azure AD Connect ウィザードを開始します
2.  **[構成]** をクリックします。
3.  **[同期オプションのカスタマイズ]** を選択し、 **[次へ]** をクリックします。
4.  Azure ADの資格情報を入力します。
5.  **[Connected Directories]\(接続されたディレクトリ\)** 画面で、 **[次へ]** をクリックします。
6.  **[ドメインと OU のフィルタリング] ページ**で、 **[最新の情報に更新]** をクリックします。  新しいドメインが表示され、削除されたドメインは表示されなくなります。
   ![パーティション](./media/how-to-connect-sync-configure-filtering/update2.png)  

### <a name="update-the-run-profiles"></a>実行プロファイルを更新する
ドメイン フィルターを更新した場合、実行プロファイルも更新する必要があります。

1. 前の手順で変更したコネクタが、 **[コネクタ]** の一覧で選択されていることを確認します。 **[アクション]** から **[実行プロファイルの構成]** を選択します。  
   ![コネクタ実行プロファイル 1](./media/how-to-connect-sync-configure-filtering/connectorrunprofiles1.png)  
2. 次のプロファイルを探して特定します。
    * フル インポート
    * 完全同期
    * 差分インポート
    * 差分同期
    * エクスポート
3. 各プロファイルについて、**追加対象**のドメインと**削除対象**のドメインを調整します。
    1. 5 つのプロファイルのそれぞれについて、**追加対象**のドメインごとに次の手順を実行します。
        1. 実行プロファイルを選択し、 **[新しいステップ]** をクリックします。
        2. **[ステップの構成]** ページの **[タイプ]** ドロップダウン メニューから、構成するプロファイルと同じ名前の付いたステップの種類を選択します。 続けて、 **[次へ]** をクリックします。  
        ![コネクタ実行プロファイル 2](./media/how-to-connect-sync-configure-filtering/runprofilesnewstep1.png)  
        3. **[コネクタの構成]** ページで、 **[パーティション]** ドロップダウン メニューから、ドメイン フィルターに追加したドメインの名前を選択します。  
        ![コネクタ実行プロファイル 3](./media/how-to-connect-sync-configure-filtering/runprofilesnewstep2.png)  
        4. **[実行プロファイルの構成]** ダイアログ ボックスを閉じるには、 **[完了]** をクリックします。
    2. 5 つのプロファイルのそれぞれについて、**削除対象**のドメインごとに次の手順を実行します。
        1. 実行プロファイルを選択します。
        2. **[パーティション]** 属性の **[値]** が GUID である場合は、実行ステップを選択し、 **[ステップの削除]** をクリックします。  
        ![コネクタ実行プロファイル 4](./media/how-to-connect-sync-configure-filtering/runprofilesdeletestep.png)  
    3. 変更を確認します。 同期の対象となるすべてのドメインが各実行プロファイルにステップとして表示されている必要があります。
4. **[実行プロファイルの構成]** ダイアログ ボックスを閉じるには、 **[OK]** をクリックします。
5.  構成を完了するには、**フル インポート**と**差分同期**を実行する必要があります。続きは「[変更の適用と検証](#apply-and-verify-changes)」セクションを参照してください。

## <a name="organizational-unitbased-filtering"></a>組織単位ベースのフィルター処理
OU ベースのフィルター処理を変更する場合は、インストール ウィザードを実行して、[ドメインと OU のフィルター処理](how-to-connect-install-custom.md#domain-and-ou-filtering)を変更することをお勧めします。 インストール ウィザードは、このトピックに記載されているすべてのタスクを自動化します。

なんらかの理由でインストール ウィザードを実行できない場合にだけ、以下の手順に従う必要があります。

組織単位ベースのフィルター処理を構成するには、次の手順を実行します。

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているサーバーにサインインします。
2. **[スタート]** メニューから **[同期サービス]** を起動します。
3. **[コネクタ]** を選択し、 **[コネクタ]** の一覧から、種類が "**Active Directory Domain Services**" であるコネクタを選択します。 **[アクション]** の **[プロパティ]** を選択します。  
   ![コネクタのプロパティ](./media/how-to-connect-sync-configure-filtering/connectorproperties.png)  
4. **[ディレクトリ パーティションの構成]** をクリックし、構成するドメインを選択して、 **[コンテナー]** をクリックします。
5. 資格情報を求められたら、オンプレミスの Active Directory に対する読み取りアクセス権を持った資格情報を指定します。 ダイアログ ボックスにあらかじめ設定されているユーザーでなくてもかまいません。
6. **[コンテナーの選択]** ダイアログ ボックスで、クラウド ディレクトリと同期しない OU の選択を解除し、 **[OK]** をクリックします。  
   ![[コンテナーの選択] ダイアログ ボックス内の OU](./media/how-to-connect-sync-configure-filtering/ou.png)  
   * Windows 10 コンピューターを Azure AD と正しく同期させるには、 **[コンピューター]** コンテナーを選択する必要があります。 ドメインに参加しているコンピューターが他の OU に置かれている場合、それらが選択されていることを確認してください。
   * 信頼関係のある複数のフォレストが存在する場合、 **[ForeignSecurityPrincipals]** コンテナーを選択する必要があります。 このコンテナーにより、フォレスト間のセキュリティ グループのメンバーシップが解決されます。
   * デバイスの書き戻し機能を有効にした場合は、 **[RegisteredDevices]** の OU を選択する必要があります。 別の書き戻し機能 (グループの書き戻しなど) を使用する場合は、それらの場所が選択されていることを確認してください。
   * Users、iNetOrgPersons、Groups、Contacts、Computers の置かれている OU が他にあれば選択します。 この図では、これらすべての OU が ManagedObjects OU に存在します。
   * グループ ベースのフィルター処理を使用する場合は、グループが配置される OU を含める必要があります。
   * フィルター処理の構成が完了した後で追加された新しい OU を同期するか同期しないかを構成することができます。 詳細については、次のセクションを参照してください。
7. 完了したら、 **[OK]** をクリックして **[プロパティ]** ダイアログを閉じます。
8. 構成を完了するには、**フル インポート**と**差分同期**を実行する必要があります。続きは「[変更の適用と検証](#apply-and-verify-changes)」セクションを参照してください。

### <a name="synchronize-new-ous"></a>新しい OU を同期する
フィルター処理を構成した後で作成された新しい OU は、既定では同期されます。 チェック ボックスがオンの場合、同期されることを示します。 一部のサブ OU を選択解除することもできます。 この操作を有効にするには、白地に青のチェック マークが表示された状態になるまでチェック ボックスをクリックします (既定の状態)。 その後、同期しないサブ OU を選択解除します。

すべてのサブ OU が同期される場合、ボックスには白地に青のチェック マークが表示されます。  
![すべてのボックスが選択されている OU](./media/how-to-connect-sync-configure-filtering/ousyncnewall.png)

一部のサブ OU が選択解除されている場合は、ボックスにはグレー地に白のチェック マークが表示されます。  
![一部のサブ OU が選択解除されている OU](./media/how-to-connect-sync-configure-filtering/ousyncnew.png)

この構成では、ManagedObjects の下に作成された新しい OU が同期されます。

Azure AD Connect インストール ウィザードでは、常にこの構成が作成されます。

### <a name="dont-synchronize-new-ous"></a>新しい OU を同期しない
フィルター処理の構成が完了した後で作成された新しい OU を同期しないように同期エンジンを構成できます。 この状態は、グレー地でチェック マークの表示がないボックスの UI で示されます。 この操作を有効にするには、白地でチェック マークの表示がない状態になるまでボックスをクリックします。 その後、同期するサブ OU を選択します。

![ルートが選択解除されている OU](./media/how-to-connect-sync-configure-filtering/oudonotsyncnew.png)

この構成では、ManagedObjects の下に作成された新しい OU は同期されません。

## <a name="attribute-based-filtering"></a>属性ベースのフィルター処理
以下の手順は、November 2015 ([1.0.9125](reference-connect-version-history.md#1091250)) 以降のビルドを想定しています。

> [!IMPORTANT]
>**Azure AD Connect** によって作成された既定の規則は、変更しないことをお勧めします。 規則を変更する場合は、複製してから、元の規則を無効にします。 複製した規則を変更してください。 これによって (元の規則を無効にすることによって)、その規則によって有効にしたバグ修正や機能は見つからなくなります。

属性ベースのフィルター処理は、オブジェクトをフィルター処理する手段として最も柔軟性の高い方法となります。 [宣言型のプロビジョニング](concept-azure-ad-connect-sync-declarative-provisioning.md)の強みを活かして、Azure AD に対してオブジェクトを同期させるタイミングをあらゆる角度から制御することができます。

Active Directory からメタバースへの[受信](#inbound-filtering)フィルター処理と、メタバースから Azure AD への[送信](#outbound-filtering)フィルター処理を適用できます。 維持が最も簡単な受信フィルター処理を適用することをお勧めします。 送信側のフィルター処理は、複数のフォレストからのオブジェクトを合わせたうえで評価する必要がある場合にのみ使用してください。

### <a name="inbound-filtering"></a>受信のフィルター処理
受信フィルター処理は既定の構成を使用します。既定の構成では、Azure AD に送信されるオブジェクトを同期させるためには、メタバース属性 cloudFiltered の値が未設定となっている必要があります。 この属性の値が **True** に設定されている場合、オブジェクトは同期されません。 意図的に **False** に設定することは避けてください。 他の規則から確実に値が得られるよう、この属性の値は **True** または **NULL** (未設定) にする必要があります。

受信フィルター処理では、同期の対象となるオブジェクトと対象外となるオブジェクトが**スコープ**の作用によって決定されます。 この点は、組織ごとに実際の要件に合わせて調整することになります。 スコープ モジュールには、同期規則の作用対象を判断する**グループ**と**句**があります。 グループは、1 つまたは複数の句を含みます。 複数の句は "論理積" で組み合わされ、複数のグループは "論理和" で組み合わされます。

たとえば、次のようなフィルターがあるとします。  
![スコープ](./media/how-to-connect-sync-configure-filtering/scope.png)  
これは、 **(department = IT) OR (department = Sales AND c = US)** という意味になります。

次のサンプルと手順は、ユーザー オブジェクトが例として使用されていますが、実際にはオブジェクトの種類に関係なく利用できます。

次の例では、優先順位の値は 50 から始まります。 これは既に使用されていない任意の数値であればよいですが、100 よりも小さい必要があります。

#### <a name="negative-filtering-do-not-sync-these"></a>否定のフィルター処理 (同期対象外の指定)
以下の例では、**extensionAttribute15** の値が **NoSync** であるすべてのユーザーをフィルターで除外 (同期対象外に) します。

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているサーバーにサインインします。
2. **[スタート]** メニューから、**同期規則エディター**を起動します。
3. **[受信]** が選択されていることを確認し、 **[新しい規則の追加]** をクリックします。
4. わかりやすい名前を規則に付けます ("*AD からの受信 – 同期しないユーザーのフィルター*" など)。 適切なフォレストを選択し、 **[接続されているシステム オブジェクトのタイプ]** として **[ユーザー]** を、 **[メタバース オブジェクトの種類]** として **[人]** を選択します。 **[リンクの種類]** で **[結合]** を選択します。 **[優先順位]** に、別の同期規則で現在使用されていない値 (50 など) を入力して、 **[次へ]** をクリックします。  
   ![Inbound 1 の説明](./media/how-to-connect-sync-configure-filtering/inbound1.png)  
5. **[スコープ フィルター]** で、 **[グループの追加]** 、 **[句の追加]** の順にクリックします。 **[属性]** で **[ExtensionAttribute15]** を選択します。 **[演算子]** を **EQUAL** に設定し、 **[値]** ボックスに「**NoSync**」という値を入力します。 **[次へ]** をクリックします。  
   ![Inbound 2 のスコープ](./media/how-to-connect-sync-configure-filtering/inbound2.png)  
6. **[参加]** 規則は空のままにして、 **[次へ]** をクリックします。
7. **[変換の追加]** をクリックし、 **[FlowType]** として **[Constant]** を、 **[ターゲット属性]** として **[cloudFiltered]** に選択します。 **[ソース]** テキスト ボックスに「**True**」を入力します。 **[追加]** をクリックして規則を保存します。  
   ![Inbound 3 の変換](./media/how-to-connect-sync-configure-filtering/inbound3.png)
8. 構成を完了するには、**完全同期**を実行する必要があります。続きは「[変更の適用と検証](#apply-and-verify-changes)」セクションを参照してください。

#### <a name="positive-filtering-only-sync-these"></a>肯定のフィルター処理 (同期対象の指定)
肯定のフィルター処理を式で表すことは、否定の場合と比べて難易度が上がります。同期の対象とするかどうかが不明確なオブジェクト (会議室など) も考慮しなければならないためです。 既定の規則 **[In from AD - User Join]** の既定のフィルターもオーバーライドします。 カスタム フィルターを作成するときは、重要なシステム オブジェクト、レプリケーション競合オブジェクト、特殊なメールボックス、Azure AD Connect のサービス アカウントなどが含まれていないことを確認してください。

肯定のフィルター処理オプションには、2 つの同期規則が必要となります。 1 つ目に必要なのが、同期対象のオブジェクトの範囲を正しく指定した規則 (複数可) です。 また、2 つ目に、同期対象オブジェクトとしてまだ識別されていないすべてのオブジェクトを除外する包括的な同期規則も必要です。

以下の例では、department 属性の値が **Sales**であるユーザー オブジェクトだけを同期対象としています。

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているサーバーにサインインします。
2. **[スタート]** メニューから、**同期規則エディター**を起動します。
3. **[受信]** が選択されていることを確認し、 **[新しい規則の追加]** をクリックします。
4. わかりやすい名前を規則に付けます ("*AD からの受信 – 営業部のユーザーの同期*" など)。 適切なフォレストを選択し、 **[接続されているシステム オブジェクトのタイプ]** として **[ユーザー]** を、 **[メタバース オブジェクトの種類]** として **[人]** を選択します。 **[リンクの種類]** で **[結合]** を選択します。 **[優先順位]** に、別の同期規則で現在使用されていない値 (51 など) を入力して、 **[次へ]** をクリックします。  
   ![Inbound 4 の説明](./media/how-to-connect-sync-configure-filtering/inbound4.png)  
5. **[スコープ フィルター]** で、 **[グループの追加]** 、 **[句の追加]** の順にクリックします。 **[属性]** で **[department]** を選択します。 [演算子] を **[EQUAL]** に設定し、 **[値]** ボックスに「**Sales**」という値を入力します。 **[次へ]** をクリックします。  
   ![Inbound 5 のスコープ](./media/how-to-connect-sync-configure-filtering/inbound5.png)  
6. **[参加]** 規則は空のままにして、 **[次へ]** をクリックします。
7. **[変換の追加]** をクリックし、 **[FlowType]** として **[Constant]** を、 **[ターゲット属性]** として **[cloudFiltered]** に選択します。 **[ソース]** ボックスに、「**False**」を入力します。 **[追加]** をクリックして規則を保存します。  
   ![Inbound 6 の変換](./media/how-to-connect-sync-configure-filtering/inbound6.png)  
   これは特殊なケースですが、cloudFiltered を明示的に **False** に設定します。
8. 次に、包括的な同期規則を作成する必要があります。 わかりやすい名前を規則に付けます ("*AD からの受信 – 包括的なユーザーのフィルター*" など)。 適切なフォレストを選択し、 **[接続されているシステム オブジェクトのタイプ]** として **[ユーザー]** を、 **[メタバース オブジェクトの種類]** として **[人]** を選択します。 **[リンクの種類]** で **[結合]** を選択します。 **[優先順位]** に、別の同期規則で現在使用されていない値 (99 など) を入力します。 前の同期規則より高い (優先順位の低い) 値を選択しました。 ただし、後で追加の部門の同期を開始した場合にフィルター処理の同期規則を追加できるように、多少の余地も残しています。 **[次へ]** をクリックします。  
   ![Inbound 7 の説明](./media/how-to-connect-sync-configure-filtering/inbound7.png)  
9. **[スコープ フィルター]** は空のままにして、 **[次へ]** をクリックします。 フィルターを空にした場合、すべてのオブジェクトに規則が適用されます。
10. **[参加]** 規則は空のままにして、 **[次へ]** をクリックします。
11. **[変換の追加]** をクリックし、 **[FlowType]** として **[Constant]** を、 **[ターゲット属性]** として **[cloudFiltered]** に選択します。 **[ソース]** ボックスに、「**True**」を入力します。 **[追加]** をクリックして規則を保存します。  
    ![Inbound 3 の変換](./media/how-to-connect-sync-configure-filtering/inbound3.png)  
12. 構成を完了するには、**完全同期**を実行する必要があります。続きは「[変更の適用と検証](#apply-and-verify-changes)」セクションを参照してください。

必要であれば、1 つ目のタイプの規則をさらに作成し、同期対象のオブジェクトを増やすこともできます。

### <a name="outbound-filtering"></a>送信のフィルター処理
場合によっては、オブジェクトがメタバースに参加した後にのみ、フィルター処理を実行する必要があります。 たとえば、オブジェクトを同期する必要があるかどうかを確認するには、リソース フォレストの mail 属性と、アカウント フォレストの userPrincipalName 属性を確認する必要があります。 このような場合、送信ルールに関するフィルター処理を作成します。

この例では、mail と userPrincipalName の両方の末尾が @contoso.com であるユーザーのみが同期されるようにフィルター処理を変更します。

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているサーバーにサインインします。
2. **[スタート]** メニューから、**同期規則エディター**を起動します。
3. **[規則の種類]** の **[送信]** をクリックします。
4. 使用する Connect のバージョンに応じて、**Out to AAD – User Join** と **Out to AAD - User Join SOAInAD** のいずれかの規則を選択し、 **[編集]** をクリックします。
5. ポップアップで **[はい]** を選択して規則のコピーを作成します。
6. **[説明]** ページの **[優先順位]** の値を、まだ使用していない値 (50 など) に設定します。
7. 左側のナビゲーションにある **[スコープ フィルター]** をクリックし、 **[句の追加]** をクリックします。 **[属性]** で **[mail]** を選択します。 **[演算子]** で **[ENDSWITH]** を選択します。 **[値]** に「 **\@contoso.com**」と入力し、 **[句の追加]** をクリックします。 **[属性]** で **[userPrincipalName]** を選択します。 **[演算子]** で **[ENDSWITH]** を選択します。 **[値]** に「 **\@contoso.com**」と入力します。
8. **[保存]** をクリックします。
9. 構成を完了するには、**完全同期**を実行する必要があります。続きは「[変更の適用と検証](#apply-and-verify-changes)」セクションを参照してください。

## <a name="apply-and-verify-changes"></a>変更の適用と検証
構成を変更したら、それらの変更をシステム内の既存のオブジェクトに適用する必要があります。 まだ同期エンジンに存在しないオブジェクトを処理 (さらに、同期エンジンがソース システムをもう一度読み取ってその内容を検証) しなければならないケースも考えられます。

**ドメイン**または**組織単位**のフィルター処理を使って構成を変更した場合は、**フル インポート**に続けて**差分同期**を実行する必要があります。

**属性**のフィルター処理を使って構成を変更した場合は、**完全同期**を実行する必要があります。

手順は次のとおりです。

1. **[スタート]** メニューから **[同期サービス]** を起動します。
2. **[コネクタ]** を選択します。 **[コネクタ]** の一覧から、構成変更済みのコネクタを選択します。 **[アクション]** から **[実行]** を選択します。  
   ![コネクタの実行](./media/how-to-connect-sync-configure-filtering/connectorrun.png)  
3. **[実行プロファイル]** から、前のセクションで説明した操作を選択します。 2 つのアクションを実行する必要がある場合は、1 つ目が終了した後 (選択したコネクタの **[状態]** 列が **[Idle]** になっている) に 2 つ目を実行します。

同期後、すべての変更がエクスポートの対象としてステージングされます。 実際に Azure AD に変更を加える前に、それらの変更がすべて正しいことを検証する必要があります。

1. コマンド プロンプトを起動し、`%ProgramFiles%\Microsoft Azure AD Sync\bin` に移動します。
2. `csexport "Name of Connector" %temp%\export.xml /f:x` を実行します。  
   同期サービスにコネクタの名前があることを確認できます。 Azure AD の場合は、"contoso.com - AAD" のような名前が表示されます。
3. `CSExportAnalyzer %temp%\export.xml > %temp%\export.csv` を実行します。
4. %temp% に export.csv という名前のファイルが生成されます。このファイルは、Microsoft Excel で開くことができます。 このファイルには、エクスポートの対象となるすべての変更が含まれています。
5. データまたは構成に必要な変更を加え、エクスポートの対象となる変更が希望どおりになるまで、(インポート、同期、検証の) 手順を実行します。

問題がなければ、変更を Azure AD にエクスポートします。

1. **[コネクタ]** を選択します。 **[コネクタ]** の一覧から Azure AD コネクタを選択します。 **[アクション]** から **[実行]** を選択します。
2. **[実行プロファイル]** で **[エクスポート]** を選択します。
3. 構成の変更によって削除されるオブジェクトが多数存在し、その数が、構成されているしきい値 (既定では 500 個) を超えた場合、エクスポート時にエラーが表示されます。 エラーが表示された場合は、"[誤って削除されないように保護する](how-to-connect-sync-feature-prevent-accidental-deletes.md)" 機能を一時的に無効にする必要があります。

この時点でスケジューラをもう一度有効にします。

1. **[スタート]** メニューから **[タスク スケジューラ]** を起動します。
2. **[タスク スケジューラ ライブラリ]** の直下から **Azure AD Sync Scheduler** というタスクを探して右クリックし、 **[有効]** を選択します。

## <a name="group-based-filtering"></a>グループベースのフィルター処理
グループベースのフィルター処理は、[カスタム インストール](how-to-connect-install-custom.md#sync-filtering-based-on-groups)を使用して Azure AD Connect を初めてインストールするときに構成できます。 このフィルター処理は、同期が必要なオブジェクトがごく少数であるパイロット デプロイで使用するためのものです。 グループベースのフィルター処理は、一度無効にすると再び有効にすることができません。 カスタム構成でのグループベースのフィルター処理は、*サポートされていません*。 この機能を構成できるのは、インストール ウィザードを使用する場合のみです。 パイロットが完了したら、このトピックで説明されているいずれかの他のフィルター処理オプションを使用する必要があります。 OU ベースのフィルター処理とグループ ベースのフィルター処理を組み合わせて使用する場合は、グループとそのメンバーが配置されている OU を追加する必要があります。

複数の AD フォレストを同期すると、各 AD コネクタに別のグループを指定することで、グループベースのフィルター処理を構成できます。 1 つの AD フォレストでユーザーを同期する場合、同じユーザーが他の AD フォレストで 1 つ以上の対応するオブジェクトを持つとき、ユーザー オブジェクトとそれに対応するすべてのオブジェクトがグループ ベースのフィルター処理のスコープ内にあることを確認してください。 次に例を示します。

* あるフォレストにユーザーがいます。このフォレストには、他のフォレストの対応する FSP (外部セキュリティ プリンシパル) オブジェクトがあります。 両方のオブジェクトが、グループ ベースのフィルター処理のスコープ内にある必要があります。 そうしないと、ユーザーは Azure AD と同期されません。

* あるフォレストにユーザーがいます。このフォレストには、他のフォレストの対応するリソース アカウント (リンクされたメールボックスなど) があります。 また、そのユーザーとリソース アカウントがリンクされるように Azure AD Connect を構成しました。 両方のオブジェクトが、グループ ベースのフィルター処理のスコープ内にある必要があります。 そうしないと、ユーザーは Azure AD と同期されません。

* あるフォレストにユーザーがいます。このフォレストには、他のフォレストの対応するメール連絡先があります。 また、そのユーザーとメール連絡先がリンクされるように Azure AD Connect を構成しました。 両方のオブジェクトが、グループ ベースのフィルター処理のスコープ内にある必要があります。 そうしないと、ユーザーは Azure AD と同期されません。


## <a name="next-steps"></a>次のステップ
- [Azure AD Connect Sync](how-to-connect-sync-whatis.md) の詳細を確認してください。
- [オンプレミス ID と Azure AD の統合](whatis-hybrid-identity.md)の詳細を確認してください。
