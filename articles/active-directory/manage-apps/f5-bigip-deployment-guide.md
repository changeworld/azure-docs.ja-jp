---
title: F5 を使用した Azure AD のセキュリティで保護されたハイブリッド アクセスのデプロイ ガイド | Microsoft Docs
description: セキュリティで保護されたハイブリッド アクセスのために F5 BIG-IP Virtual Edition (VE) VM を Azure IaaS にデプロイするチュートリアル
services: active-directory
author: gargi-sinha
manager: martinco
ms.service: active-directory
ms.subservice: app-mgmt
ms.topic: how-to
ms.workload: identity
ms.date: 10/12/2020
ms.author: gasinh
ms.collection: M365-identity-device-management
ms.openlocfilehash: f962bf131b87f17712186145b8c8b8e6090f7002
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/19/2021
ms.locfileid: "98730659"
---
# <a name="tutorial-to-deploy-f5-big-ip-virtual-edition-vm-in-azure-iaas-for-secure-hybrid-access"></a>セキュリティで保護されたハイブリッド アクセスのために F5 BIG-IP Virtual Edition VM を Azure IaaS にデプロイするチュートリアル

このチュートリアルでは、Azure IaaS に BIG-IP Virtual Edition (VE) をデプロイするエンドツーエンドのプロセスについて説明します。 このチュートリアルを終了すると、次のものが準備できたことになります。

- セキュリティで保護されたハイブリッド アクセス (SHA) の概念実証をモデル化するための完全に準備された BIG-IP 仮想マシン (VM)

- 新しい BIG-IP システムの更新プログラムと修正プログラムをテストするために使用するステージング インスタンス

## <a name="prerequisites"></a>前提条件

F5 BIG-IP に関する事前の経験や知識は必要ありませんが、[F5 BIG-IP の用語](https://www.f5.com/services/resources/glossary)に慣れておくことをお勧めします。 Azure で SHA のために BIG-IP をデプロイするには、次のものが必要です。

- 有料の Azure サブスクリプションまたは 12 か月間無料[試用版サブスクリプション](https://azure.microsoft.com/free/)。

- 次のいずれかの F5 BIG-IP ライセンス SKU

  - F5 BIG-IP® Best バンドル

  - F5 BIG-IP Access Policy Manager™ (APM) スタンドアロン ライセンス

  - 既存の BIG-IP F5 BIG-IP® Local Traffic Manager™ (LTM) に対する F5 BIG-IP Access Policy Manager™ (APM) アドオン ライセンス
  
  - 90 日間の BIG-IP 全機能[試用版ライセンス](https://www.f5.com/trial/big-ip-trial.php)。

- SSL (Secure Socket Layer) 経由で Web アプリケーションを公開するためのワイルドカードまたはサブジェクト代替名 (SAN) 証明書。 [Let’s encrypt](https://letsencrypt.org/) で、テスト用の 90 日間無料の証明書が提供されています。

- BIG-IP の管理インターフェイスをセキュリティで保護するための SSL 証明書。 Web アプリを公開するために使用される証明書のサブジェクトが BIG-IP の完全修飾ドメイン名 (FQDN) に対応している場合は、それを使用できます。 たとえば、*.contoso.com というサブジェクトを使用して定義されたワイルドカード証明書は、 `https://big-ip-vm.contoso.com:8443` に適しています

VM のデプロイと基本システムの構成には 30 分程度かかります。この時点で、BIG-IP プラットフォームは[ここ](f5-aad-integration.md)に記載されている SHA のシナリオのいずれかを実装する準備が整います。

シナリオをテストする場合、このチュートリアルでは、Active Directory (AD) 環境を含む Azure リソース グループに BIG-IP がデプロイされることを前提としています。 この環境は、ドメイン コントローラー (DC) および Web ホスト (IIS) VM で構成されている必要があります。 BIG-IP から特定のシナリオをサポートするために必要な各ロールへの通信経路がある場合は、これらのサーバーを BIG-IP VM とは別の場所に配置することもできます。 BIG-IP VM が VPN 接続経由で別の環境に接続されるシナリオもサポートされています。

ここに記載されている項目をテスト用に用意できない場合は、この[スクリプト](https://github.com/Rainier-MSFT/Cloud_Identity_Lab)を使用して、AD ドメイン環境全体を Azure にデプロイできます。 この[スクリプト化されたオートメーション](https://github.com/jeevanbisht/DemoSuite)を使用して、サンプル テスト アプリケーションのコレクションをプログラムで IIS Web ホストにデプロイすることもできます。

>[!NOTE]
>[Azure portal](https://portal.azure.com/#home) は絶えず進化しているため、このチュートリアルの手順の一部が Azure portal に表示される実際のレイアウトとは異なる場合があります。

## <a name="azure-deployment"></a>Azure のデプロイ

BIG-IP はさまざまなトポロジでデプロイできます。 このガイドでは、1 つのネットワーク インターフェイス (NIC) のデプロイを中心に説明します。 ただし、BIG-IP のデプロイで、高可用性、ネットワーク分離、または 1 GB を超えるスループットを実現するために複数のネットワーク インターフェイスが必要な場合は、F5 のプリコンパイルされた [Azure Resource Manager (ARM) テンプレート](https://clouddocs.f5.com/cloud/public/v1/azure/Azure_multiNIC.html)の使用を検討してください。

[Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps) から BIG-IP をデプロイするには、次のタスクを実行します。

1. VM を作成するためのアクセス許可を持つアカウントで [Azure portal](https://portal.azure.com/#home) にログインします。 たとえば、共同作成者です

2. 上部のリボンの検索ボックスで、「**marketplace**」と入力してから **Enter** キーを押します

3. マーケットプレースのフィルターに「**F5**」と入力してから **Enter** キーを押します

4. 上部のリボンから **[+ 追加]** を選択し、マーケットプレースのフィルターに「**F5**」と入力してから **Enter** キーを押します

5. **[F5 BIG-IP Virtual Edition (BYOL)]**  >  **[ソフトウェア プランの選択]**  >  **[F5 BIG-IP VE - ALL (BYOL, 2 Boot Locations)]** の順に選択します

6. **[作成]** を選択します。

![ソフトウェア プランの選択手順を示す画像](./media/f5ve-deployment-plan/software-plan.png)

7. **[基本]** メニューを順に実行し、次の設定を使用します

 |  プロジェクトの詳細     |  値     |
 |:-------|:--------|
 |サブスクリプション|BIG-IP VM デプロイのターゲット サブスクリプション|
 |Resource group | BIG-IP VM をデプロイする既存の Azure リソース グループ、または新規に作成します。 お使いの DC および IIS VM と同じリソース グループである必要があります|
 | **インスタンスの詳細**|  |
 |VM 名| Example BIG-IP-VM |
 |リージョン | BIG-IP-VM のターゲット Azure 地域 |
 |可用性のオプション| 運用環境で VM を使用する場合にのみ有効にします|
 |Image| F5 BIG-IP VE - ALL (BYOL, 2 Boot Locations)|
 |Azure Spot インスタンス| [いいえ]。ただし、必要に応じていつでも有効にすることができます |
 |サイズ| 最小限の仕様は 2 個の vCPU と 8 GB メモリ|
 |**管理者アカウント**|  |
 |認証の種類|当面はパスワードを選択します。 後でキーの組に変更できます |
 |ユーザー名|管理インターフェイスにアクセスするために BIG-IP のローカル アカウントとして作成される ID。 ユーザー名の大文字と小文字は区別されます。|
 |パスワード|強力なパスワードによるセキュリティで保護された管理者アクセス|
 |**受信ポートの規則**|  |
 |パブリック受信ポート|なし|

8. **Next:Disks\(次へ: ディスク\)** を選択し、すべて既定値のままにして、**Next:Networking\(次へ : ネットワーク\)** を選択します。

9. **[ネットワーク]** メニューで、次のように設定します。

 |ネットワーク インターフェイス|      値 |
 |:--------------|:----------------|
 |仮想ネットワーク|お使いの DC および IIS VM で使用されているものと同じ Azure VNet、または新規に作成します|
 |サブネット| お使いの DC および IIS VM と同じ Azure 内部サブネット、または新規に作成します|
 |パブリック IP |  なし|
 |NIC ネットワーク セキュリティ グループ| 前の手順で選択した Azure サブネットが既にネットワーク セキュリティ グループ (NSG) に関連付けられている場合は、[なし] を選択します。それ以外の場合は [Basic] を選択します|
 |高速ネットワーク| オフ |
 |**負荷分散**|     |
 |VM の負荷分散| いいえ|

10. **Next:Management\(次へ: 管理\)** を選択し、次のように設定します。

 |監視|    値 |
 |:---------|:-----|
 |詳細な監視| オフ|
 |ブート診断|カスタム ストレージ アカウントで有効にします。 Azure portal の [シリアル コンソール] オプションを使用して BIG-IP Secure Shell (SSH) インターフェイスに接続できるようにします。 使用可能な任意の Azure ストレージ アカウントを選択します|
 |**ID**|  |
 |システム割り当てマネージド ID|オフ|
 |Azure Active Directory|BIG-IP では、現在このオプションはサポートされていません|
 |**自動シャットダウン**|    |
 |自動シャットダウンを有効にする| テストする場合は、BIG-IP-VM を毎日シャットダウンするように設定することを検討してください|

11. **Next:Advanced\(次へ: 詳細設定\)** を選択し、すべて既定値のままにして、**Next: Tags\(次へ: タグ** を選択します。

12. **Next:Review + create\(次へ: レビューと作成\)** を選択し、BIG-IP-VM の構成を確認してから、**作成** を選択してデプロイを開始します。

13. BIG-IP VM が完全にデプロイされるまでの時間は、通常 5 分です。 完了したら、 **[リソースに移動]** を選択せずに、Azure portal の左側のメニューを展開して **[リソース グループ]** を選択し、新しい BIG-IP-VM に移動します。 VM の作成に失敗した場合は、 **[戻る]** 、 **[次へ]** の順に選択します。

## <a name="network-configuration"></a>ネットワーク構成

BIG-IP VM の初回起動時に、接続先の Azure サブネットの動的ホスト構成プロトコル (DHCP) サービスによって発行された **プライマリ** プライベート IP を使用して、その NIC がプロビジョニングされます。 この IP は、BIG-IP の TMOS (Traffic Management Operating System) によって次の通信に使用されます。

- 他のホストおよびサービスとの通信

- パブリック インターネットへの送信アクセス

- BIG-IP の Web 構成および SSH 管理インターフェイスへの受信アクセス

これらの管理インターフェイスのいずれかをインターネットに公開すると、BIG-IP の攻撃対象領域が広がります。デプロイ時に BIG-IP のプライマリ IP をパブリック IP でプロビジョニングしなかったのはこのためです。 代わりに、セカンダリ内部 IP と関連するパブリック IP がサービス公開用にプロビジョニングされます。
VM のパブリック IP とプライベート IP を 1 対 1 でマッピングすると、外部トラフィックが VM に到達できるようになります。 しかし、ファイアウォールと同じようにトラフィックを許可するには、Azure NSG ルールも必要です。

この図は、Azure での BIG-IP の単一 NIC デプロイを示しています。一般的な操作と管理用のプライマリ IP と、サービス公開用の別の仮想サーバー IP を使用して構成されています。
この配置では、NSG ルールによって、`intranet.contoso.com` 宛てのリモート トラフィックが公開されたサービスのパブリック IP アドレスにルーティングされた後、BIG-IP 仮想サーバーに転送されます。

![単一 NIC デプロイを示す画像](./media/f5ve-deployment-plan/single-nic-deployment.png)既定では、Azure VM に発行されるプライベートおよびパブリック IP は常に動的であるため、VM が再起動されるたびに変更される可能性があります。 予期しない接続の問題を回避するには、BIG-IP の管理 IP を静的なものに変更し、サービス公開用のセカンダリ IP についても同じ操作を行います。

1. BIG-IP VM のメニューから、 **[設定]**  >  **[ネットワーク]** の順に移動します

2. ネットワーク ビューで、 **[ネットワーク インターフェイス]** の右側にあるリンクを選択します

![ネットワーク構成を示す画像](./media/f5ve-deployment-plan/network-config.png)

>[!NOTE]
>VM 名はデプロイ時にランダムに生成されます。

3. 左側のウィンドウで、 **[IP 構成]** を選択してから、**ipconfig1** の行を選択します

4. **[IP 割り当て]** オプションを [静的] に設定し、必要に応じて BIG-IP VM のプライマリ IP アドレスを変更します。 その後、 **[保存]** を選択して ipconfig1 メニューを閉じます

>[!NOTE]
>このプライマリ IP を使用して BIG-IP-VM の接続と管理を行います。

5. 上部のリボンで **[+ 追加]** を選択し、セカンダリ プライベート IP の名前 (たとえば、「ipconfig2」) を指定します

6. プライベート IP アドレス設定の **[割り当て]** オプションを **[静的]** に設定します。 連続する 1 つ上または下の IP を指定すると、整合性を確保しやすくなります。

7. パブリック IP アドレスを **[関連付け]** に設定し、 **[作成]** を選択します

8. 新しいパブリック IP アドレスの名前 (たとえば、「BIG-IP-VM_ipconfig2_Public」) を指定します

9. メッセージが表示されたら、 **[SKU]** を [Standard] に設定します

10. メッセージが表示されたら、 **[階層]** を **[グローバル]** に設定します

11. **[割り当て]** オプションを **[静的]** に設定してから、 **[OK]** を 2 回選択します

これで、以下を使用して BIG-IP-VM を設定する準備ができました。

- **プライマリ プライベート IP**:Web 構成ユーティリティと SSH を使用して BIG-IP-VM を管理する場合にのみ使用されます。 これは、BIG-IP システムで公開されているバックエンド サービスに接続するための **セルフ IP** として使用されます。 また、NTP、AD、LDAP などの外部サービスにも接続します。

- **セカンダリ プライベート IP**:BIG-IP APM 仮想サーバーを作成するときに、公開されたサービスへの受信要求をリッスンするために使用されます。

- **[パブリック IP]** : セカンダリ プライベート IP に関連付けられ、パブリック インターネットからのクライアント トラフィックが公開されたサービスの BIG-IP 仮想サーバーに到達できるようになります

この例は、VM のパブリックおよびプライベート IP の間の 1 対 1 の関係を示しています。 Azure VM NIC に設定できるプライマリ IP は 1 つだけで、追加で作成された IP は常にセカンダリと呼ばれます。

>[!NOTE]
>BIG-IP サービスを公開するには、セカンダリ IP のマッピングが必要です。

![すべてのセカンダリ IP を示す画像](./media/f5ve-deployment-plan/secondary-ips.png)

BIG-IP の **アクセス ガイド付き構成** を使用して SHA を実装するには、手順 5 から 11 を繰り返して、BIG-IP APM 経由で公開する予定のすべての追加サービスに対して追加のプライベートおよびパブリック IP のペアを作成します。 BIG-IP の **詳細構成** を使用してサービスを公開する場合も、同じアプローチを使用できます。 ただし、そのシナリオでは、[Server Name Indicator (SNI)](https://support.f5.com/csp/#/article/K13452) 構成を使用してパブリック IP のオーバーヘッドを回避することもできます。 この構成では、BIG-IP 仮想サーバーで受信したすべてのクライアント トラフィックを受け入れ、それをその宛先にルーティングします。

## <a name="dns-configuration"></a>DNS の構成

クライアントが公開された SHA サービスを BIG-IP VM のパブリック IP に解決できるように DNS を構成することが重要です。

次の手順では、SHA サービスに使用されるパブリック ドメインの DNS ゾーンが Azure で管理されていることを前提としています。 ただし、DNS ゾーンがどこで管理されていても、ロケーター レコードの作成については同じ DNS の原則が適用されます。

1. まだ開いていない場合は、ポータルの左側のメニューを展開し、 **[リソース グループ]** オプションを使用して BIG-IP-VM に移動します

2. BIG-IP VM のメニューから、 **[設定]**  >  **[ネットワーク]** の順に移動します

3. BIG-IP-VM のネットワーク ビューで、[IP 構成] ドロップダウン リストから最初のセカンダリ IP を選択し、その **[NIC パブリック IP]** のリンクを選択します

![NIC パブリック IP を示すスクリーンショット](./media/f5ve-deployment-plan/networking.png)

4. 左側のウィンドウの **[設定]** セクションで、 **[構成]** を選択して、選択したセカンダリ IP のパブリック IP と DNS のプロパティ メニューを表示します

5. エイリアス レコードを選択して **[作成]** し、ドロップダウン リストからお使いの **[DNS ゾーン]** を選択します。 DNS ゾーンがまだ存在しない場合は、Azure の外部で管理することも、Azure AD で検証したドメイン サフィックス用に作成することもできます。

6. 次の詳細を使用して最初の DNS エイリアス レコードを作成します。

 | フィールド | 値 |
 |:-------|:-----------|
 |サブスクリプション| BIG-IP-VM と同じサブスクリプション|
 |[DNS ゾーン]| 公開された Web サイトで使用される検証済みのドメイン サフィックスに対して権限を持つ DNS ゾーン (たとえば、 www.contoso.com) |
 |名前 | 指定したホスト名は、選択したセカンダリ IP に関連付けられているパブリック IP に解決されます。 必ず DNS から IP へのマッピングを正しく定義してください。 ネットワーク構成セクションの最後の画像を参照してください。たとえば、intranet.contoso.com は 13.77.148.215 に解決されます|
 | TTL | 1 |
 |TTL の単位 | 時間 |

7. **[作成]** を選択して、Azure でこれらの設定をパブリック DNS に保存します。

8. **[DNS 名ラベル (オプション)** ] をそのままにして **[保存]** を選択し、[パブリック IP] メニューを閉じます。

9. 手順 1 から 6 を繰り返して、BIG-IP のガイド付き構成を使用して公開する予定のすべてのサービスに対して追加の DNS レコードを作成します。

  DNS レコードを作成したら、[DNS checker](https://dnschecker.org/) などのオンライン ツールを使用して、作成したレコードがすべてのグローバル パブリック DNS サーバーに正常に伝達されたことを確認できます。

  [GoDaddy](https://www.godaddy.com/) のような外部プロバイダーを使用して DNS ドメイン名前空間を管理する場合は、独自の DNS 管理機能を使用してレコードを作成する必要があります。

>[!NOTE]
>DNS レコードをテストしたり頻繁に切り替えたりする場合は、PC のローカル ホスト ファイルを使用することもできます。 Windows PC 上の localhosts ファイルにアクセスするには、キーボードの Win + R キーを押し、[ファイル名を指定して実行] ボックスで「**drivers**」という単語を送信します。 localhost レコードでは、他のクライアントではなくローカル PC の DNS 解決のみが提供されることに注意してください。

## <a name="client-traffic"></a>クライアント トラフィック

既定では、Azure VNet および関連するサブネットはインターネット トラフィックを受信できないプライベート ネットワークです。 BIG-IP-VM の NIC は、デプロイ時に指定した NSG に接続されている必要があります。 外部 Web トラフィックが BIG-IP-VM に到達するには、パブリック インターネットからポート 443 (HTTPS) および 80 (HTTP) へのアクセスを許可する受信 NSG ルールを定義する必要があります。

1. BIG-IP VM のメイン **[概要]** メニューから、 **[ネットワーク]** を選択します

2. **[追加]** 受信ルールを選択して、次の NSG ルールのプロパティを入力します。

 |     フィールド   |   値        |
 |:------------|:------------|
 |source| Any|
 |Source port ranges| *|
 |送信先 IP アドレス|BIG-IP-VM のすべてのセカンダリ プライベート IP のコンマ区切りリスト|
 |宛先ポート| 80,443|
 |プロトコル| TCP |
 |アクション| Allow|
 |優先度|100 ～ 4096 の範囲の使用可能な最小値|
 |名前 | わかりやすい名前 (たとえば、「`BIG-IP-VM_Web_Services_80_443`」)|

3. **[追加]** を選択して変更をコミットし、 **[ネットワーク]** メニューを閉じます。

これで、任意の場所からの HTTP および HTTPS トラフィックが BIG-IP-VM のすべてのセカンダリ インターフェイスに到達できるようになります。 ポート 80 の許可は、BIG-IP APM でユーザーを HTTP から HTTPS に自動的にリダイレクトする場合に役立ちます。 必要に応じて、このルールを編集して宛先 IP を追加または削除できます。

## <a name="manage-big-ip"></a>BIG-IP の管理

BIG-IP システムは Web 構成 UI を使用して管理します。この UI には、次の推奨される方法のいずれかを使用してアクセスできます。

- BIG-IP の内部ネットワーク内のマシンから

- BIG-IP-VM の内部ネットワークに接続された VPN クライアントから

- [Azure AD アプリケーション プロキシ](./application-proxy-add-on-premises-application.md)経由で公開する

残りの構成に進む前に、最も適切な方法を決定する必要があります。 必要に応じて、インターネットから Web 構成に直接接続できます。そのためには、パブリック IP を使用して BIG-IP のプライマリ IP アドレスを構成します。 次に、そのプライマリ IP への 8443 トラフィックを許可する NSG ルールを追加します。 ソースを必ず独自の信頼された IP に限定してください。そうしないと、だれでも接続できるようになります。

準備ができたら、BIG-IP VM の Web 構成に接続し、VM のデプロイ時に指定した資格情報でログインできることを確認します。

- 内部ネットワーク上の VM から、または VPN 経由で接続する場合は、BIG-IP のプライマリ IP と Web 構成ポートに直接接続します。 たとえば、「 `https://<BIG-IP-VM_Primary_IP:8443` 」のように入力します。 ブラウザーで接続が安全でないことを示すメッセージが表示されますが、BIG-IP が構成されるまで、このメッセージは無視してかまいません。 ブラウザーによってアクセスのブロックが要求される場合は、キャッシュをクリアして、もう一度やり直してください。

- アプリケーション プロキシ経由で Web 構成を公開した場合は、`https://big-ip-vm.contoso.com` のように、ポートを追加せずに、外部から Web 構成にアクセスするために定義された URL を使用します。 内部 URL は、`https://big-ip-vm.contoso.com:8443` のように、Web 構成ポートを使用して定義する必要があります 

また、基になる SSH 環境を介して BIG-IP システムを管理することもできます。これは通常、コマンドライン (CLI) タスクとルートレベルのアクセスに使用されます。 CLI への接続には、次のようにいくつかのオプションがあります。

- [Azure Bastion サービス](../../bastion/bastion-overview.md):任意の場所から VNet 内の任意の VM に高速かつ安全に接続できます

- JIT アプローチを使用して、PuTTY のような SSH クライアント経由で直接接続する

- シリアル コンソール:ポータルの [VM] メニューの [サポートとトラブルシューティング] セクションの下部にあります。 ファイル転送はサポートされません。

- Web 構成と同様に、インターネットから CLI に直接接続することもできます。そのためには、パブリック IP を使用して BIG-IP のプライマリ IP アドレスを構成し、SSH トラフィックを許可する NSG ルールを追加します。 この方法を使用する場合も、ソースを必ず独自の信頼された IP に限定してください。  

## <a name="big-ip-license"></a>BIG-IP ライセンス

サービスと SHA を公開できるように BIG-IP システムを構成する前に、APM モジュールを使用して BIG-IP システムをアクティブ化し、プロビジョニングする必要があります。

1. Web 構成にもう一度ログインし、 **[全般プロパティ]** ページで **[アクティブ化]** を選択します

2. **[基本登録キー]** フィールドに、F5 から提供されたキーを入力します

3. **[ライセンス認証方法]** を **[自動]** に設定したままにして、 **[次へ]** を選択します。BIG-IP によってライセンスが検証され、使用許諾契約書 (EULA) が表示されます。

4. **[同意する]** を選択し、ライセンス認証が完了するのを待ってから、 **[続行]** を選択します。

5. もう一度ログインして、[ライセンスの概要] ページの下部にある **[次へ]** を選択します。 これで、SHA に必要なさまざまな機能を提供するモジュールの一覧が BIG-IP に表示されます。 これが表示されない場合は、[メイン] タブから **[システム]**  >  **[リソースのプロビジョニング]** の順に移動します。

6. アクセス ポリシー (APM) のプロビジョニング列を確認します

![アクセスのプロビジョニングを示す画像](./media/f5ve-deployment-plan/access-provisioning.png)

7. **[送信]** を選択して、警告を受け入れます

8. BIG-IP による新しい機能の有効化が完了するまでしばらく待ちます。 完全に初期化されるまでに、これを複数回繰り返す場合があります。 

9. 準備ができたら、 **[続行]** を選択し、 **[概要]** タブで **[セットアップ ユーティリティの実行]** を選択します

>[!IMPORTANT]
>F5 のライセンスは、一度に 1 つの BIG-IP VE インスタンスでしか使用できないように制限されています。 何らかの理由で 1 つのインスタンスから別のインスタンスにライセンスを移行する必要が生じる場合があります。その場合は、アクティブなインスタンスの試用版ライセンスの使用を停止する前に、必ずそれを[失効](https://support.f5.com/csp/article/K41458656)させてください。そうしないと、ライセンスは完全に失われます。

## <a name="provision-big-ip"></a>BIG-IP のプロビジョニング

BIG-IP の Web 構成との間の管理トラフィックをセキュリティで保護することが最も重要です。 Web 構成チャネルを侵害から保護するために、デバイス管理証明書を構成します。

1. 左側のナビゲーション バーから、 **[システム]**  >  **[証明書の管理]**  >  **[トラフィック証明書の管理]**  >  **[SSL 証明書の一覧]**  >  **[インポート]** の順に移動します

2. **[インポートの種類]** ドロップダウン リストから **[PKCS 12 (IIS)]** を選択し、 **[Choose File]\(ファイルの選択\)** を選択します。 次のいくつかの手順で、BIG-IP VM に割り当てる FQDN に対応するサブジェクト名または SAN を持つ SSL Web 証明書を検索します

3. 証明書のパスワードを入力してから、 **[インポート]** を選択します

4. 左側のナビゲーション バーから、 **[システム]**  >  **[プラットフォーム]** の順に移動します

5. 完全修飾ホスト名とその環境のタイムゾーンを使用して BIG-IP-VM を構成してから、 **[更新]** を選択します

![全般プロパティを示す画像](./media/f5ve-deployment-plan/general-properties.png)

6. 左側のナビゲーション バーから、 **[システム]**  >  **[構成]**  >  **[デバイス]**  >  **[NTP]** の順に移動します

7. 信頼できる NTP ソースを指定し、 **[追加]** 、 **[更新]** の順に選択します。 例: `time.windows.com`

次に、前の手順で指定した BIG-IP の FQDN をそのプライマリ プライベート IP に解決するための DNS レコードが必要です。 レコードは、環境の内部 DNS、または BIG-IP の Web 構成に接続するために使用される PC の localhost ファイルに追加する必要があります。どちらの方法でも、Web 構成に直接接続したときにブラウザーの警告が表示されなくなります。 つまり、アプリケーション プロキシまたは別のリバース プロキシを経由しません。

## <a name="ssl-profile"></a>SSL プロファイル

リバース プロキシとしての BIG-IP システムは、透過プロキシとも呼ばれるシンプルな転送サービスか、またはクライアントとサーバー間のやり取りにアクティブに関与するフル プロキシとして機能します。
フル プロキシでは、フロントエンド TCP クライアント接続と別個のバックエンド TCP サーバー接続という 2 つの異なる接続が作成され、中間でソフト ギャップによって結合されます。 クライアントは一方の端で **仮想サーバー** とも呼ばれるプロキシ リスナーに接続し、プロキシによってバックエンド サーバーに対する個別の独立した接続が確立されます。 これは両方の側で双方向です。
このフル プロキシ モードでは、F5 BIG-IP システムでトラフィックを検査できるため、要求と応答によるやり取りも可能です。 負荷分散や Web パフォーマンスの最適化などの特定の機能に加えて、アプリケーション層セキュリティ、Web アクセラレーション、ページ ルーティング、セキュリティで保護されたリモート アクセスなどの高度なトラフィック管理サービスも、この機能に依存しています。
SSL ベースのサービスを公開する場合、クライアントとバックエンド サービス間のトラフィックの暗号化解除と暗号化のプロセスは、BIG-IP SSL プロファイルによって処理されます。

次の 2 種類のプロファイルがあります。

- **クライアント SSL**:内部サービスを SSL で公開するように BIG-IP システムを設定する最も一般的な方法は、クライアント SSL プロファイルを作成することです。 クライアント SSL プロファイルを使用すると、BIG-IP システムでは、受信クライアント要求を復号化してからダウンストリーム サービスに送信できます。 その後、送信バックエンド応答を暗号化してからクライアントに送信します。

- **サーバー SSL**:HTTPS 用に構成されたバックエンド サービスでは、サーバー SSL プロファイルを使用するように BIG-IP を構成できます。 サーバー SSL プロファイルを使用すると、BIG-IP では、クライアント要求を再暗号化してから送信先のバックエンド サービスに送信します。 サーバーから暗号化された応答が返されると、BIG-IP システムでは、構成済みのクライアント SSL プロファイルを使用して応答を復号化および再暗号化してからクライアントに送信します。

クライアントおよびサーバー SSL プロファイルの両方をプロビジョニングすると、BIG-IP が事前に構成され、すべての SHA シナリオに対応できるようになります。

1. 左側のナビゲーション バーから、 **[システム]**  >  **[証明書の管理]**  >  **[トラフィック証明書の管理]**  >  **[SSL 証明書の一覧]**  >  **[インポート]** の順に移動します

2. **[インポートの種類]** ドロップダウン リストから **[PKCS 12 (IIS)]** を選択します

3. インポートされる証明書の名前 (たとえば、「`ContosoWilcardCert`」) を入力します

4. **[Choose File]\(ファイルの選択\)** を選択して、公開されたサービスで使用する予定のドメイン サフィックスに対応するサブジェクト名を持つ SSL Web 証明書を参照します

5. インポートした証明書の **[パスワード]** を指定してから、 **[インポート]** を選択します

6. 左側のナビゲーション バーから、 **[ローカル トラフィック]**  >  **[プロファイル]**  >  **[SSL]**  >  **[クライアント]** の順に移動し、その後 	 **[作成]** を選択します

7. **[新しいクライアント SSL プロファイル]** ページで、新しいクライアント SSL プロファイルの一意の表示名を指定し、[親プロファイル] が **[clientssl]** に設定されていることを確認します

![BIG-IP の更新を示す画像](./media/f5ve-deployment-plan/client-ssl.png)

8. **[Certificate Key Chain]\(証明書のキー チェーン\)** 行の右端にあるチェック ボックスをオンにして、 **[追加]** を選択します

9. 3 つのドロップダウン リストで、パスフレーズを使用せずにインポートしたワイルドカード証明書を選択してから、 **[追加]**  >  **[完了]** の順に選択します。

![BIG-IP の contoso ワイルドカードの更新を示す画像](./media/f5ve-deployment-plan/contoso-wildcard.png)

10. 手順 6 から 9 を繰り返して、**SSL サーバー証明書プロファイル** を作成します。 上部のリボンから **[SSL]**  >  **[サーバー]**  >  **[作成]** を選択します。

11. **[新しいサーバー SSL プロファイル]** ページで、新しいサーバー SSL プロファイルの一意の表示名を指定し、[親プロファイル] が **[serverssl]** に設定されていることを確認します

12. [証明書] および [キー] 行の右端にあるチェック ボックスをオンにし、ドロップダウン リストからインポートした証明書を選択してから **[完了]** を選択します。

![BIG-IP のサーバー SSL プロファイルの更新を示す画像](./media/f5ve-deployment-plan/server-ssl-profile.png)

>[!NOTE]
>SSL 証明書を調達できなくても、あきらめないでください。統合された自己署名済みの BIG-IP サーバーおよびクライアント SSL 証明書を使用できます。 ブラウザーに証明書のエラーが表示されます。

SHA 用に BIG-IP を準備する最後の手順として、公開しているリソースと SSO で利用するディレクトリ サービスを見つけることができるようにします。 BIG-IP には名前解決のソースが 2 つあります。最初は local/.../hosts ファイルが使用されますが、レコードが見つからない場合、BIG-IP システムでは構成時に使用した任意の DNS サービスが使用されます。 hosts ファイルの方法は、FQDN を使用する APM ノードおよびプールには適用されません。

1. Web 構成で、 **[システム]**  >  **[構成]**  >  **[デバイス]**  >  **[DNS]** の順に移動します

2. **[DNS Lookup Server List]\(DNS 参照サーバーの一覧\)** で、お使いの環境の DNS サーバーの IP アドレスを入力します

3. **[追加]**  >  **[更新]** の順に選択します

別のオプションの手順として、ローカルの BIG-IP アカウントを管理するのではなく、BIG-IP のシステム管理者を AD に対して認証する [LDAP 構成](https://somoit.net/f5-big-ip/authentication-using-active-directory)を検討することもできます。

## <a name="update-big-ip"></a>BIG-IP の更新

[シナリオベースのガイダンス](f5-aad-integration.md)に記載されているすべての新機能のロックを使用できるようにするには、BIG-IP VM を更新する必要があります。 メイン ページの左上にある BIG-IP のホスト名の上にマウス ポインターを置くと、システムの TMOS バージョンを確認できます。 [F5 のダウンロード](https://downloads.f5.com/esd/productlines.jsp)から入手できる V15.x 以降を実行することをお勧めします。 [ガイダンス](https://support.f5.com/csp/article/K34745165)を使用して、メイン システム OS (TMOS) を更新します。

メイン TMOS を更新できない場合は、次の手順を使用して、少なくともガイド付き構成のみをアップグレードすることを検討してください。

1. BIG-IP Web 構成のメイン タブから、 **[アクセス]**  >  **[ガイド付き構成]** の順に移動します

2. **[ガイド付き構成]** ページで、 **[Upgrade Guided Configuration]\(ガイド付き構成のアップグレード\)** を選択します

![BIG-IP の更新方法を示す画像](./media/f5ve-deployment-plan/update-big-ip.png)

3. **[Upgrade Guided Configuration]\(ガイド付き構成のアップグレード\)** ダイアログで、 **[Choose File]\(ファイルの選択\)** を選択し、ダウンロードしたユース ケース パックをアップロードして、 **[Upload and Install]\(アップロードしてインストール\)** を選択します

4. アップグレードが完了したら、 **[続行]** を選択します。

## <a name="backup-big-ip"></a>BIG-IP のバックアップ

BIG-IP システムが完全にプロビジョニングされたら、その構成の完全バックアップを実行することをお勧めします。

1. **[システム]**  >  **[アーカイブ]**  >  **[作成]** の順に移動します

2. 一意の **[ファイル名]** を指定し、パスフレーズによる **[暗号化]** を有効にします

3. デバイスおよび SSL 証明書もバックアップするため、 **[秘密キー]** オプションを **[Include]\(含める\)** に設定します

4. **[完了]** を選択し、プロセスが完了するまで待ちます

5. バックアップ結果の状態を示す操作状態が表示されます。 **[OK]** を選択します。

6. ユーザー構成セット (UCS) のアーカイブをローカルに保存するため、バックアップのリンクを選択して **[ダウンロード]** を選択します。

オプションの手順として、[Azure スナップショット](../../virtual-machines/windows/snapshot-copy-managed-disk.md)を使用してシステム ディスク全体のバックアップを実行することもできます。これは、Web 構成のバックアップとは異なり、TMOS のバージョン間のテストや新しいシステムへのロールバックを行うための代替策になります。

```PowerShell
# Install modules
Install-module Az
Install-module AzureVMSnapshots

# Authenticate to Azure
Connect-azAccount

# Set subscription by Id
Set-AzContext -SubscriptionId ‘<Azure_Subscription_ID>’

#Create Snapshot
New-AzVmSnapshot -ResourceGroupName '<E.g.contoso-RG>' -VmName '<E.g.BIG-IP-VM>'

#List Snapshots
#Get-AzVmSnapshot -ResourceGroupName ‘<E.g.contoso-RG>'

#Get-AzVmSnapshot -ResourceGroupName ‘<E.g.contoso-RG>' -VmName '<E.g.BIG-IP-VM>' | Restore-AzVmSnapshot -RemoveOriginalDisk 

```

## <a name="restore-big-ip"></a>BIG-IP の復元

BIG-IP の復元は、バックアップと同様の手順で実行され、BIG-IP VM 間で構成を移行する場合にも使用できます。 バックアップをインポートする前に、サポートされているアップグレード パスの詳細を確認してください。

1. **[システム]**  >  **[アーカイブ]** の順に移動します

2. 復元するバックアップのリンクを選択するか、 **[アップロード]** ボタンを選択して、以前に保存されたが一覧に表示されない UCS アーカイブを参照します

3. バックアップのパスフレーズを指定し、 **[復元]** を選択します

```PowerShell
# Authenticate to Azure
Connect-azAccount

# Set subscription by Id
Set-AzContext -SubscriptionId ‘<Azure_Subscription_ID>’

#Restore Snapshot
Get-AzVmSnapshot -ResourceGroupName '<E.g.contoso-RG>' -VmName '<E.g.BIG-IP-VM>' | Restore-AzVmSnapshot

```

>[!NOTE]
>この記事の執筆時点では、AzVmSnapshot コマンドレットは日付に基づいて最新のスナップショットを復元するように制限されています。 スナップショットは、VM のリソース グループのルートに格納されます。 スナップショットの復元によって Azure VM が再起動されることに注意し、実行するタイミングを慎重に検討してください。

## <a name="additional-resources"></a>その他のリソース

-   [Reset BIG-IP VE password in Azure (Azure での BIG-IP VE パスワードのリセット)](https://clouddocs.f5.com/cloud/public/v1/shared/azure_passwordreset.html)
    -   [Reset the password without using the portal (ポータルを使用せずにパスワードをリセットする)](https://clouddocs.f5.com/cloud/public/v1/shared/azure_passwordreset.html#reset-the-password-without-using-the-portal)

-   [Change the NIC used for BIG-IP VE management (BIG-IP VE の管理に使用する NIC の変更)](https://clouddocs.f5.com/cloud/public/v1/shared/change_mgmt_nic.html)

-   [About routes in a single NIC configuration (単一 NIC 構成でのルートについて)](https://clouddocs.f5.com/cloud/public/v1/shared/routes.html)

-   [Microsoft Azure:waagent](https://clouddocs.f5.com/cloud/public/v1/azure/Azure_waagent.html)

## <a name="next-steps"></a>次の手順

[デプロイ シナリオ](f5-aad-integration.md)を選択し、実装を開始します。