<properties
	pageTitle="Azure AD Connect Sync のフィルター処理の構成 | Microsoft Azure"
	description="Azure AD Connect Sync でフィルター処理を構成する方法を説明します。"
	services="active-directory"
	documentationCenter=""
	authors="markusvi"
	manager="stevenpo"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="10/13/2015"
	ms.author="markusvi;andkjell"/>


# Azure AD Connect Sync: フィルター処理の構成

Azure AD Connect Sync では、いつでもフィルター処理を有効にできます。ディレクトリ同期の既定の構成を既に実行していて、フィルター処理を構成済みの場合、フィルター処理により除外されるオブジェクトは、Azure AD に対する同期の対象外になります。そのため、以前同期されてからフィルター処理された Azure AD のオブジェクトは、すべて Azure AD から削除されます。フィルター処理のエラーが原因でオブジェクトが誤って削除された場合、フィルター処理構成を削除し、ディレクトリの同期を再実行することで、Azure AD 内にオブジェクトを再生成できます。

> [AZURE.IMPORTANT]公式に文書化されているアクションを除き、Microsoft は Azure AD Connect Sync の変更や操作をサポートしません。そのようなアクションを実行すると、Azure AD Connect Sync の状態に一貫性が失われたり、サポート対象外の状態になったりすることがあります。その結果、Microsoft はそのようなデプロイを技術的にサポートできなくなります。

送信の属性ベースのフィルター処理の場合を除き、新しいバージョンの Azure AD Connect のインストールまたはアップグレードを行っても構成は保持されます。新しいバージョンにアップグレードした後は、常に構成が誤って変更されていないことを確認してから、最初の同期サイクルを実行することをお勧めします。


## フィルター処理オプション

> [AZURE.NOTE]このトピックでは、Active Directory ドメイン サービス コネクタの名前としてソース AD が使用されます。複数のフォレストがある場合、1 つのフォレストにつきコネクタ数は 1 つです。フォレストごとに構成を繰り返す必要があります。

ディレクトリ同期ツールには、次の 3 つのフィルター処理構成タイプが適用できます。

- [**ドメイン ベース**](#configure-domain-based filtering): このフィルター処理タイプを使用して、Azure AD Connect Sync の SourceAD コネクタのプロパティを管理できます。このフィルター処理タイプを使用すると、どのドメインを Azure AD に同期させるかを選択できます。

- [**組織単位ベースのフィルター処理を構成する**](#configure-organizational-unit–based filtering): このフィルター処理タイプを使用して、Azure AD Connect Sync の SourceAD コネクタのプロパティを管理できます。このフィルター処理タイプを使用すると、どの OU を Azure AD に同期させるかを選択できます。

- [**属性ベース**](#configure-attribute-based-filtering): 属性ベースのフィルターを指定する場合に、このフィルター処理方式を使用できます。これにより、クラウドと同期するオブジェクトを制御できます。

> [AZURE.NOTE]フィルターの構成を変更して、パスワード同期を使用する場合は、構成を完了した後、すべてのパスワードの完全同期を開始する必要があります。パスワードの完全同期をトリガーする方法の手順については、「[すべてのパスワードの完全同期の開始](active-directory-aadconnectsync-implement-password-synchronization.md#trigger-a-full-sync-of-all-passwords)」を参照してください。

## ドメイン ベースのフィルター処理を構成する

このセクションでは、ドメイン フィルターの構成に必要な手順について説明します。

Azure AD Connect をインストールした後にフォレスト内のドメインを追加または削除した場合は、フィルター処理の構成も更新する必要があります。


### 既存ドメインのフィルターの変更

> [AZURE.NOTE]ドメイン フィルターを変更した場合、実行プロファイルも更新する必要があります。


**ドメイン フィルターを設定するには、次の手順を実行します。**

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているコンピューターにログインします。

2. **[スタート]** 画面の **[同期サービス]** をタップまたはクリックして、**Synchronization Service Manager** を起動します。

3. コネクタのビューを開くには、**[ツール]** メニューの **[コネクタ]** をクリックします。

4. **[コネクタ]** の一覧で、**[種類]** が **[Active Directory ドメイン サービス]** であるコネクタを選択します。

5. **[プロパティ]** ダイアログ ボックスを開くには、**[アクション]** メニューの **[プロパティ]** をクリックします。

6. **[ディレクトリ パーティションの構成]** をクリックします。

7. **[ディレクトリ パーティションの選択]** の一覧で、同期するパーティションのみが選択されていることを確認します。<br> 同期プロセスからドメインを除外するには、ドメインのチェック ボックスをオフにします。

8. **[プロパティ]** ダイアログ ボックスを閉じるには、**[OK]** をクリックします。


ドメイン フィルターを更新した場合、次の実行プロファイルも更新する必要があります。

- フル インポート
- 完全同期
- 差分インポート
- 差分同期
- エクスポート


ディレクトリ パーティションの一覧からパーティションを**削除**した場合、そのパーティションを参照しているすべての実行プロファイル ステップも削除されていることを確認する必要があります。

**実行プロファイルから手順を削除するには、次の手順を実行します。**

1. **[コネクタ]** の一覧で、**[種類]** が **[Active Directory ドメイン サービス]** であるコネクタを選択します。

2. **[アクション]** メニューの **[実行プロファイルの構成]** をクリックして、**[実行プロファイルの構成]** ダイアログ ボックスを開きます。

3. **[コネクタ実行プロファイル]** の一覧で、構成する実行プロファイルを選択します。

4. 手順の詳細リストの手順ごとに、次の手順を実行します。

     4\.1.必要に応じて、手順をクリックして手順の詳細を展開します。

     4\.2.**[パーティション]** 属性の **[値]** が GUID である場合は、[ステップの削除] をクリックします。

5. **[実行プロファイルの構成]** ダイアログ ボックスを閉じるには、**[OK]** をクリックします。

パーティションをディレクトリ パーティションの一覧に**追加**した場合、そのパーティションの実行プロファイル ステップが上記の一覧にある各実行プロファイルで使用可能であることを確認する必要があります。

**実行プロファイルに手順を追加するには、次の手順を実行します。**

1. **[コネクタ]** の一覧で、**[種類]** が **[Active Directory ドメイン サービス]** であるコネクタを選択します。

2. **[アクション]** メニューの **[実行プロファイルの構成]** をクリックして、**[実行プロファイルの構成]** ダイアログ ボックスを開きます。

3. **[コネクタ実行プロファイル]** の一覧で、構成する実行プロファイルを選択します。

4. **[実行プロファイルの構成]** ダイアログ ボックスを開くには、**[新しいステップ]** をクリックします。

5. **[ステップの構成]** ページで、ステップの種類の一覧からステップの種類を選択し、**[次へ]** をクリックします。

6. **[コネクタの構成]** ページで、**[パーティション]** の一覧から、ドメイン フィルターに追加したパーティション名を選択します。

7. **[実行プロファイルの構成]** ダイアログ ボックスを閉じるには、**[完了]** をクリックします。

8. **[実行プロファイルの構成]** ダイアログ ボックスを閉じるには、**[OK]** をクリックします。

### 新規ドメインまたは削除されたドメインのフィルターの変更
フォレストに新しいドメインを追加した場合またはフォレストからドメインを削除した場合は、ドメインのフィルター処理構成を更新する必要があります。

**ドメインを追加した場合の手順**

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているコンピューターにログインします。

2. **[スタート]** 画面の **[同期サービス]** をタップまたはクリックして、**Synchronization Service Manager** を起動します。

3. コネクタのビューを開くには、**[ツール]** メニューの **[コネクタ]** をクリックします。

4. **[コネクタ]** の一覧で、**[種類]** が **[Active Directory ドメイン サービス]** であるコネクタを選択します。

5. **[プロパティ]** ダイアログ ボックスを開くには、**[アクション]** メニューの **[プロパティ]** をクリックします。

6. **[ディレクトリ パーティションの構成]** をクリックします。

7. ページの上部にある **[更新]** ボタンをクリックします。

8. **[ディレクトリ パーティションの選択]** の一覧で、新しいドメインを選択します。

9. **[プロパティ]** ダイアログ ボックスを閉じるには、[OK] をクリックします。

同じコネクタが選択されたままであることを確認します。ここでコネクタの実行プロファイルを構成する必要があります。


- フル インポート
- 完全同期
- 差分インポート
- 差分同期
- エクスポート


10. **[アクション]** メニューの **[実行プロファイルの構成]** をクリックして、**[実行プロファイルの構成]** ダイアログ ボックスを開きます。

11. **[コネクタ実行プロファイル]** の一覧で、構成する実行プロファイルを選択します。

12. **[実行プロファイルの構成]** ダイアログ ボックスを開くには、**[新しいステップ]** をクリックします。

13. **[ステップの構成]** ページで、ステップの種類の一覧からステップの種類を選択し、**[次へ]** をクリックします。

14. **[コネクタの構成]** ページで、**[パーティション]** の一覧から、ドメイン フィルターに追加したパーティション名を選択します。

15. **[実行プロファイルの構成]** ダイアログ ボックスを閉じるには、**[完了]** をクリックします。

16. **[実行プロファイルの構成]** ダイアログ ボックスを閉じるには、**[OK]** をクリックします。

17. すべての実行プロファイルに対して、これらの手順を繰り返します。

**ドメインを削除した場合の手順**

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているコンピューターにログインします。

2. **[スタート]** 画面の **[同期サービス]** をタップまたはクリックして、**Synchronization Service Manager** を起動します。

3. コネクタのビューを開くには、**[ツール]** メニューの **[コネクタ]** をクリックします。

4. **[コネクタ]** の一覧で、**[種類]** が **[Active Directory ドメイン サービス]** であるコネクタを選択します。

5. **[プロパティ]** ダイアログ ボックスを開くには、**[アクション]** メニューの **[プロパティ]** をクリックします。

6. **[ディレクトリ パーティションの構成]** をクリックします。

7. ページの上部にある **[更新]** ボタンをクリックします。

8. **[プロパティ]** ダイアログ ボックスを閉じるには、[OK] をクリックします。ドメインが削除されたことを示すメッセージが表示され、その構成がクリーンアップされます。

## 組織単位ベースのフィルター処理を構成する

**組織単位ベースのフィルター処理を構成するには、次の手順を実行します。**

1. **ADSyncAdmins** セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているコンピューターにログインします。

2. **[スタート]** 画面の **[同期サービス]** をタップまたはクリックして、**Synchronization Service Manager** を起動します。<br>

3. **Synchronization Service Manager** で、**[コネクタ]** をクリックし、**[SourceAD]** をダブルクリックします。

4. **[ディレクトリ パーティションの構成]** をクリックし、構成するドメインを選択して、**[コンテナー]** をクリックします。

5. プロンプトが表示されたら、オンプレミス Active Directory フォレストのドメイン資格情報を入力します。<br> >[AZURE.NOTE]資格情報のダイアログ ボックスが表示された場合、AD DS のインポートとエクスポートに使用されるアカウントが表示されます。アカウントのパスワードがわからない場合は、別のアカウントを入力して使用できます。使用するアカウントには、現在構成しているドメインに対する読み取りアクセス許可が必要です。

6. **[コンテナーの選択]** ダイアログ ボックスで、クラウド ディレクトリと同期しない OU の選択を解除し、**[OK]** をクリックします。

7. **[SourceAD プロパティ]** ページの **[OK]** をクリックします。

8. フル インポートと差分同期を実行するには、次の手順を実行します。

     8\.1.コネクタの一覧で、**[SourceAD]** を選択します。

     8\.2.**[アクション]** メニューの **[実行]** を選択して、**[コネクタの実行]** ダイアログ ボックスを開きます。

     8\.3.**[実行プロファイル]** の一覧で、**[フル インポート]** を選択し、実行プロファイルが完了するまで待ちます。

     8\.4.**[アクション]** メニューの **[実行]** を選択して、**[コネクタの実行]** ダイアログ ボックスを開きます。

     8\.5.**[実行プロファイル]** の一覧で、**[差分同期]** を選択し、実行プロファイルが完了するまで待ちます。




## 属性ベースのフィルター処理を構成する

属性に基づくフィルター処理を構成する方法は複数あります。AD からの受信の構成が推奨されます。この構成設定は、新しいバージョンにアップグレードしても維持されるためです。AAD への送信の構成もサポートされていますが、この設定は新しいバージョンへのアップグレード後に維持されません。そのため、メタバース内の組み合わせられたオブジェクトを確認してフィルター処理を決定する必要がある場合にのみ使用してください。

### 受信のフィルター処理

受信ベースのフィルター処理は既定の構成を利用します。既定の構成では、AAD に送信されるオブジェクトに、値の設定されていないメタバース属性 cloudFiltered と、"User" または "Contact" に設定されたメタバース属性 sourceObjectType が必要です。

オブジェクトを Azure AD と同期せず、その他の場合に空のままにする必要があるときは、属性 cloudFiltered を True に設定してください。この方法は、オブジェクトを確認し、オブジェクトを同期しないと判断する (ネガティブ フィルター処理) 場合に使用します。

次の例では、extensionAttribute15 の値が NoSync の場合、すべてのユーザーがフィルターで除外されます。

1. ADSyncAdmins セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているコンピューターにログインします。
2. **[スタート] メニュー**から、**同期規則エディター**を開きます。
3. **[受信]** が選択されていることを確認し、**[新しい規則の追加]** をクリックします。
4. ルールにわかりやすい名前 ("*In from AD – User DoNotSyncFilter*" など) を付け、適切なフォレストを選択し、**CS オブジェクトの種類**としては **[User]**、**MV オブジェクトの種類**としては **[Person]** という正しいフォレストを選択します。**[リンクの種類]** で **[参加]** を選択し、[優先順位] に、別の同期規則で現在使用さていない値 (50 など) を入力して、**[次へ]** をクリックします。
5. **[スコープ フィルター]** で、**[グループの追加]** をクリックし、**[句の追加]** をクリックして、属性で **[ExtensionAttribute15]** を選択します。演算子を **EQUAL** に設定し、[値] ボックスに NoSync という値を**入力**します。**[次へ]** をクリックします。
6. **[参加]** 規則は空のままにして、**[次へ]** をクリックします。
7. **[変換の追加]** をクリックし、**[FlowType]** を **[Constant]** に設定し、[ターゲット属性] で cloudFiltered を選択して、[ソース] ボックスに「True」と入力します。[追加] をクリックしてルールを保存します。
8. 完全同期の実行: **[コネクタ]** タブで **[SourceAD]** を右クリックし、**[実行]**、**[完全同期]**、**[OK]** の順にクリックします。


属性 **sourceObjectType** を設定すると、この属性の値が **User** または **Contact** の場合に、それぞれ **User** または **Contact** が Azure AD にプロビジョニングされます。既定のルールよりも高い優先度の同期ルールを作成することで、既定の動作をオーバーライドできます。この方法で、ポジティブ ルールとネガティブ ルールの両方を表現できます。

次の例では、部門の属性が "Sales" か空の場合にのみ、ユーザーを同期します。

1. ADSyncAdmins セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているコンピューターにログインします。
2. **[スタート] メニュー**から、**同期規則エディター**を開きます。
3. **[受信]** が選択されていることを確認し、**[新しい規則の追加]** をクリックします。
4. ルールにわかりやすい名前 ("*In from AD – User DoNotSyncFilter*" など) を付け、適切なフォレストを選択し、**CS オブジェクトの種類**には **[User]**、**MV オブジェクトの種類**には **[Person]** を選択します。**[リンクの種類]** で **[参加]** を選択し、**[優先順位]** に、別の同期規則で現在使用さていない値 (60 など) を入力します。**[次へ]** をクリックします。
5. **スコープ フィルター**と**参加規則**を空のままにして、**[次へ]** を 2 回クリックします。
6. **[変換の追加]** をクリックし、**[FlowType]** を **[Expression]** に設定して、**[ターゲット属性]** を **[sourceObjectType]** に設定します。**[ソース]** に次の式を入力します。<br>`IIF(IsNullOrEmpty([department]),NULL,IIF([department]<>”Sales”,”DoNotSync”,NULL))`
7. [追加] をクリックしてルールを保存します。
8. 完全同期の実行: **[コネクタ]** タブで **[SourceAD]** を右クリックし、**[実行]**、**[完全同期]**、**[OK]** の順にクリックします。結果は次のようになります。<br>

> [AZURE.NOTE]ここでは cloudFiltered と sourceObjectType を併せて使用し、AAD と同期するオブジェクトを決定しています。

式を使用することで、強力なフィルター処理を実行できます。上記の式では、部門が指定されておらず、部門が Sales だった場合にリテラルの NULL を指定しました。これは、この属性で値を設定されず、既定のルールが評価されることを示します。Azure AD に **User** と **Contact** のいずれを作成するかを決定するために、この情報が必要です。


## 送信ベースのフィルター処理

場合によっては、オブジェクトがメタバースに参加した後にのみ、フィルター処理を実行する必要があります。たとえば、オブジェクトを同期する必要があるかどうかを確認するには、リソース フォレストの mail 属性と、アカウント フォレストの userPrincipalName 属性を確認する必要があります。このような場合、送信ルールに関するフィルター処理を作成します。

> [AZURE.NOTE]この方法では、既定の同期ルールを変更する必要があります。同期ルールのスコープの変更はサポートされていませんが、新しいバージョンの Azure AD Connect にアップグレードした後、変更は保存されない可能性があります。送信ベースのフィルター処理を使用する場合、変更内容を書き留め、アップグレード後にフィルター処理があることを確認し、必要に応じて再適用します。


この例では、フィルター処理を変更するので、mail と userPrincipalName の両方の末尾が @contoso.com であるユーザーのみが同期されます。

1. ADSyncAdmins セキュリティ グループに属するアカウントを使用して、Azure AD Connect Sync を実行しているコンピューターにログインします。
2. [スタート] メニューから、Synchronization Rules Editor を開きます。
3. [ルールの種類] の [送信] をクリックします。
4. [AAD への送信 - ユーザーの参加] というルールを検索します。[編集] をクリックします。
5. 左側のナビゲーションの [スコープ フィルター] をクリックします。[句の追加] をクリックし、[属性] で [mail] を選択し、[演算子] で [ENDSWITH] を選択し、[値] に「@contoso.com」と入力します。[句の追加] をクリックし、[属性] で [userPrincipalName] を選択し、[演算子] で [ENDSWITH] を選択し、[値] に「@contoso.com」と入力します。
6. [保存] をクリックします。
7. 完全同期の実行: [コネクタ] タブで [SourceAD] を右クリックし、[実行]、[完全同期]、[OK] の順にクリックします。


## 次のステップ
[Azure AD Connect Sync](active-directory-aadconnectsync-whatis.md) の構成に関するページをご覧ください。

「[オンプレミス ID と Azure Active Directory の統合](active-directory-aadconnect.md)」をご覧ください。

<!---HONumber=Oct15_HO3-->