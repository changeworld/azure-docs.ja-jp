---
title: "Azure AD SSPR とパスワード ライトバック | Microsoft Docs"
description: "Azure AD と Azure AD Connect を使用してオンプレミスのディレクトリにパスワードを書き戻します。"
services: active-directory
keywords: "Active Directory パスワード管理, パスワード管理, Azure AD セルフサービスによるパスワードのリセット"
documentationcenter: 
author: MicrosoftGuyJFlo
manager: femila
ms.reviewer: gahug
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/28/2017
ms.author: joflore
ms.custom: it-pro
ms.openlocfilehash: e460e734973622fb0d5745adfc4c1aa0178dd22e
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/11/2017
---
# <a name="password-writeback-overview"></a>パスワード ライトバックの概要

パスワード ライトバックを使用すると、オンプレミスの Active Directory にパスワードを書き戻すように Azure AD を構成できます。 これにより、複雑なオンプレミスのセルフサービス パスワード リセット ソリューションを設定して管理する必要がなくなります。ユーザーはどこにいても、便利なクラウドベースの方法で自分のオンプレミスのパスワードをリセットできます。 パスワード ライトバックは [Azure Active Directory Connect](./connect/active-directory-aadconnect.md) のコンポーネントです。Premium の [Azure Active Directory のエディション](active-directory-editions.md)の現在のサブスクライバーによって有効にされ、使用されます。

パスワード ライトバックには、次の機能が用意されています。

* **ゼロ遅延フィードバック** - パスワード ライトバックは同期操作です。 ユーザーのパスワードがポリシーに合わなかった場合や、何らかの理由でリセットまたは変更できなかった場合は、すぐにユーザーに通知します。
* **AD FS または他のフェデレーション技術によるユーザーのパスワードのリセット** - パスワード ライトバック使うと、フェデレーション ユーザー アカウントと Azure AD テナントが同期している限り、クラウドからオンプレミスの AD パスワードを管理できます。
* **[パスワード ハッシュ同期](./connect/active-directory-aadconnectsync-implement-password-synchronization.md)によるユーザーのパスワードのリセット** - パスワード リセット サービスは、同期されているユーザー アカウントでパスワード ハッシュ同期が有効になっていることを検出すると、このアカウントのオンプレミスのパスワードとクラウドのパスワードの両方を同時にリセットします。
* **アクセス パネルと Office 365 からのパスワード変更のサポート** - フェデレーション ユーザーかパスワード同期されたユーザーが有効期限切れまたは有効期限切れでないパスワードを変更すると、これらのパスワードはローカル AD 環境に書き戻されます。
* **管理者が Azure Portal でパスワードをリセットする際のパスワードのライトバックのサポート** - 管理者が [Azure Portal](https://portal.azure.com)でユーザーのパスワードをリセットするときに、そのユーザーがフェデレーションまたはパスワード同期されている場合は、ローカル AD で管理者が選択するパスワードも設定されます。 現時点で、これは Office の管理ポータルではサポートされていません。
* **オンプレミスの AD パスワード ポリシーの強制** - ユーザーが自分のパスワードをリセットする場合、パスワードがオンプレミスの AD ポリシーに準拠していることを確認してから、そのディレクトリにコミットします。 このポリシーには、履歴、複雑さ、年齢、パスワード フィルター、ローカル AD で定義された他のパスワード制限が含まれます。
* **受信のファイアウォール規則を要求しない** - パスワード ライトバックは、基礎となる通信チャネルとして Azure Service Bus Relay を使用します。つまり、この機能を使用するためにファイアウォールで受信ポートを開く必要はありません。
* **オンプレミスの Active Directory の保護されたグループ内に存在するユーザー アカウントはサポート対象外** - 保護されたグループについて詳しくは、「[保護されたアカウントと Active Directory のグループ](https://technet.microsoft.com/library/dn535499.aspx)」をご覧ください。

## <a name="how-password-writeback-works"></a>パスワード ライトバックのしくみ

フェデレーション ユーザーまたはパスワード ハッシュ同期されたユーザーがクラウドで自分のパスワードをリセットまたは変更する場合は、次の処理が行われます。

1. ユーザーのパスワードの種類が確認されます。
    * パスワードがオンプレミスで管理されていることが確認された場合
        * ライトバック サービスが稼働しているかどうかをチェックし、稼働している場合は先に進めるようユーザーを促します。
        * ライトバック サービスが稼働していない場合は、パスワードを今すぐリセットすることはできないことをユーザーに伝えます。
2. 次に、ユーザーが適切な認証ゲートを通過すると、パスワードのリセット画面が表示されます。
3. ユーザーは新しいパスワードを選択して確認します。
4. 送信をクリックすると、プレーンテキスト パスワードがライトバックのセットアップ プロセス時に作成された対称キーを使用して暗号化されます。
5. パスワードは暗号化された後、ペイロードに含められ、HTTPS チャネル経由でテナント固有の Service Bus Relay (ライトバックのセットアップ中にも設定される) に送信されます。 このリレーは、オンプレミスのインストールのみを認識するランダムに生成されたパスワードによって保護されます。
6. メッセージが Service Bus に到達すると、パスワード リセット エンドポイントが自動的にアクティブになり、保留中のリセット要求があるかどうかを確認します。
7. サービスは、クラウドのアンカー属性を使用して該当するユーザーを探します。 この検索が成功するには:

    * AD コネクタ スペースにユーザー オブジェクトが存在している必要がある。
    * ユーザー オブジェクトが対応する MV オブジェクトにリンクされている必要がある。
    * ユーザー オブジェクトが対応する AAD コネクタ オブジェクトにリンクされている必要がある。
    * AD コネクタ オブジェクトから MC へのリンクには、リンク上に同期ルール `Microsoft.InfromADUserAccountEnabled.xxx` がある必要がある。 <br> <br>
    クラウドから呼び出されるときに、同期エンジンは cloudAnchor 属性を使用して AAD コネクタ スペース オブジェクトを検索し、MV オブジェクトのリンクに戻り、次に AD オブジェクトのリンクに戻ります。 同じユーザーに対して複数の AD オブジェクト (マルチ フォレスト) がある可能性があるため、同期エンジンは `Microsoft.InfromADUserAccountEnabled.xxx` のリンクに依存して正しいユーザー アカウントを選択します。

    > [!Note]
    > このロジックの結果、Azure AD Connect は PDC エミュレーターと通信し、パスワード ライトバックが機能するように設定します。 これを手動で有効にする必要がある場合は、Active Directory 同期コネクタの**プロパティ**を右クリックして **[configure directory partitions (ディレクトリ パーティションの構成)]** を選択し、Azure AD Connect を PDC エミュレーターに接続できます。 そこで **[domain controller connection settings (ドメイン コントローラーの接続の設定)]** セクションを探して、**[only use preferred domain controllers (優先ドメイン コントローラーのみを使用する)]** というチェック ボックスをオンにします。 優先 DC が PDC エミュレーターではない場合、Azure AD Connect はパスワード ライトバックのために PDC へのアクセスを試行します。

8. ユーザー アカウントが見つかると、適切な AD フォレスト内で直接パスワードのリセットを試みます。
9. パスワードの設定操作に成功すると、ユーザーにパスワードが変更されたことが通知されます。
    > [!NOTE]
    > パスワード同期を使用してユーザーのパスワードが Azure AD に同期される場合、オンプレミスのパスワード ポリシーが、クラウドのパスワード ポリシーと比べて緩い可能性があります。 その場合、オンプレミスのポリシーは、どのようなものであれ適用されます。その代わりに、そのパスワードのハッシュを同期することが、パスワード ハッシュ同期に許可されます。 これにより、パスワード同期やフェデレーションによるシングル サインオンを提供していたとしても、クラウドでオンプレミスのポリシーが確実に適用されます。

10. パスワードの設定操作に失敗した場合は、エラーが返され、やり直す必要があります。
    * 次の理由により、操作が失敗することがあります。
        * サービスがダウンしていた
        * 選択したパスワードが組織のポリシーを満たしていなかった
        * ローカル AD でユーザーが見つからなかった

    多くの場合、特定のメッセージが表示され、問題解決の手段がユーザーに通知されます。

## <a name="configuring-password-writeback"></a>パスワード ライトバックの構成

パスワード ライトバックを使用する場合、マイクロソフトでは [Azure AD Connect](./connect/active-directory-aadconnect-get-started-express.md) の自動更新機能を使用することをお勧めしています。

DirSync と Azure AD Sync は、パスワード ライトバックを有効にする方法としてはサポートされなくなりました。[DirSync と Azure AD Sync からのアップグレード](connect/active-directory-aadconnect-dirsync-deprecated.md)に関する記事に、切り替えに役立つ情報が記載されています。

以下の手順は、お使いの環境で[簡単](./connect/active-directory-aadconnect-get-started-express.md)または[カスタム](./connect/active-directory-aadconnect-get-started-custom.md)設定を使用して、Azure AD Connect を既に構成済みであることが前提になっています。

1. パスワード ライトバックを構成および有効化するには、Azure AD Connect サーバーにログインして **Azure AD Connect** 構成ウィザードを開始します。
2. [ようこそ] 画面で **[構成]** をクリックします。
3. [追加のタスク] 画面で **[同期オプションのカスタマイズ]** をクリックし、**[次へ]** をクリックします。
4. [Azure AD に接続] 画面で全体管理者の資格情報を入力し、**[次へ]** を選択します。
5. [ディレクトリの接続] 画面と [ドメインと OU のフィルタリング] 画面で、**[次へ]** を選択します。
6. [オプション機能] 画面で **[パスワード ライトバック]** の横にあるチェック ボックスをオンにし、**[次へ]** をクリックします。
   ![Azure AD Connect でパスワード ライトバックを有効にする][Writeback]
7. [構成の準備完了] 画面で **[構成]** をクリックし、処理が完了するまで待ちます。
8. [構成が完了しました] と表示されたら、**[終了]** をクリックします。

## <a name="licensing-requirements-for-password-writeback"></a>パスワード ライトバックに必要なライセンス

ライセンスについて詳しくは、「[Licenses required for password writeback](active-directory-passwords-licensing.md#licenses-required-for-password-writeback)」(パスワード ライトバックで必要なライセンス) または、次のサイトをご覧ください。

* [Azure Active Directory の料金サイト](https://azure.microsoft.com/pricing/details/active-directory/)
* [Enterprise Mobility + Security](https://www.microsoft.com/cloud-platform/enterprise-mobility-security)
* [Secure Productive Enterprise](https://www.microsoft.com/secure-productive-enterprise/default.aspx)

### <a name="on-premises-authentication-modes-supported-for-password-writeback"></a>パスワード ライトバックでサポートされるオンプレミスの認証モード

パスワード ライトバックは、次のユーザー パスワードの種類に対して機能します。

* **クラウド専用ユーザー**: オンプレミスのパスワードがないため、この状況ではパスワード ライトバックは適用されません。
* **パスワード同期ユーザー**: パスワード ライトバックがサポートされます。
* **フェデレーション ユーザー**: パスワード ライトバックがサポートされます。
* **パススルー認証ユーザー**: パスワード ライトバックがサポートされます。

### <a name="user-and-admin-operations-supported-for-password-writeback"></a>パスワード ライトバックでサポートされるユーザーと管理者の操作

パスワードは次の状況で書き戻されます。

* **サポートされるエンドユーザーの操作**
  * エンド ユーザーによる自発的なパスワード変更
  * エンドユーザーによる強制的なパスワード変更 (パスワードの期限切れなど)
  * [パスワード リセット ポータル](https://passwordreset.microsoftonline.com)から実行されたエンド ユーザーによるパスワードのリセット
* **サポートされる管理者の操作**
  * 管理者による自発的なパスワード変更
  * 管理者による強制的なパスワード変更 (パスワードの期限切れなど)
  * [パスワード リセット ポータル](https://passwordreset.microsoftonline.com)から実行された管理者によるパスワードのリセット
  * [Azure クラシック ポータル](https://manage.windowsazure.com)から管理者が開始したエンドユーザーのパスワードのリセット
  * [Azure Portal](https://portal.azure.com) から管理者が開始したエンドユーザーのパスワードのリセット

### <a name="user-and-admin-operations-not-supported-for-password-writeback"></a>パスワード ライトバックでサポートされないユーザーと管理者の操作

パスワードの書き戻しは、次の状況では**実行されません**。

* **サポートされないエンドユーザーの操作**
  * PowerShell v1、v2、または Azure AD Graph API を使用した、エンドユーザーによるパスワードのリセット
* **サポートされない管理者の操作**
  * [Office 管理ポータル](https://portal.office.com)から管理者が開始したエンドユーザーのパスワードのリセット
  * PowerShell v1、v2、または Azure AD Graph API から管理者が開始したエンド ユーザーのパスワードのリセット

マイクロソフトでは、これらの制限を取り除くための作業を続けていますが、共有できる予定はまだありません。

## <a name="password-writeback-security-model"></a>パスワード ライトバックのセキュリティ モデル

パスワード ライトバックは、安全性の高いサービスです。  ユーザーの情報を確実に保護するために、次の 4 層のセキュリティ モデルを実現しています。

* **テナント固有の Service Bus Relay**
  * サービスを設定すると、マイクロソフトでもアクセスできない、ランダムに生成された強力なパスワードで保護されたテナント固有の Service Bus Relay が設定されます。
* **ロックダウンされ、暗号強度の高いパスワード暗号化キー**
  * Service Bus Relay が作成されると、強力な非対称キー ペアが作成され、ネットワーク経由でパスワードが渡されるときに暗号化に使用されます。 このキーは、クラウド内の会社のシークレット ストアのみに存在し、厳重にロックダウンされ、ディレクトリ内のパスワードと同様に監査されます。
* **業界標準の TLS**
  1. クラウド内でパスワードのリセットや変更操作が行われる場合は、プレーン テキスト パスワードが取得され、公開キーを使用して暗号化されます。
  2. 次に、これを HTTPS メッセージに配置して、マイクロソフトの SSL 証明書を使用して暗号化されたチャネルを介して Service Bus Relay に送信されます。
  3. Service Bus にメッセージが到着すると、オンプレミスのエージェントが起動され、以前に生成された強力なパスワードを使用して Service Bus に認証します。
  4. オンプレミスのエージェントは、暗号化されたメッセージを取得し、マイクロソフトが生成した秘密キーを使用して復号化します。
  5. オンプレミスのエージェントは、AD DS SetPassword API を使用して、パスワードの設定を試行します。
     * この手順に従うと、クラウドで AD オンプレミスのパスワード ポリシー (複雑さ、年齢、履歴、フィルターなど) を適用できます。
* **メッセージの有効期限ポリシー** 
  * オンプレミスのサービスがダウンしているためメッセージが Service Bus に残っている場合はタイムアウトになり、数分後に削除されてセキュリティがさらに強化されます。

### <a name="password-writeback-encryption-details"></a>パスワード ライトバックの暗号化の詳細

ユーザーがパスワード リセット要求を送信した後、その要求がオンプレミス環境に到着するまでに実行される暗号化の手順を以下に示します。これらの手順によって、最大限のサービスの信頼性とセキュリティが確保されます。

* **手順 1 - 2048 ビット RSA キーによるパスワードの暗号化**: ユーザーがオンプレミスにライトバックするためにパスワードを送信すると、送信されたパスワードそのものが 2048 ビット RSA キーを使用して暗号化されます。
* **手順 2 - AES-GCM によるパッケージ レベルの暗号化**: 次に、AES-GCM を使用して、パッケージ全体 (パスワード + 必要なメタデータ) が暗号化されます。 これにより、ServiceBus チャネルに直接アクセスできる人物による内容の表示/改ざんを防止します。
* **手順 3 - すべての通信は TLS / SSL 経由で行われる**: ServiceBus でのすべての通信は、SSL/TLS チャネルで実行されます。 これにより、権限がないサード パーティからの保護が保証されます。
* **半年ごとの自動キー ロールオーバー**: 半年ごとに自動的に、または Azure AD Connect でパスワード ライトバックが無効/再度有効になるたびに、すべてのキーがロールオーバーされます。これにより、最大限のサービスのセキュリティと安全性が確保されます。

### <a name="password-writeback-bandwidth-usage"></a>パスワード ライトバックの帯域幅の使用

パスワード ライトバックは帯域幅の低いサービスで、次の状況でのみ要求をオンプレミスのエージェントに戻します。

1. Azure AD Connect を通じて機能を有効または無効にしたときに 2 つのメッセージが送信されます。
2. サービスのハートビートとして 5 分おきに 1 回 1 つのメッセージが、サービスを実行している間中、送信されます。
3. 新しいパスワードが送信されるたびに 2 つのメッセージが送信されます。
    * 最初のメッセージは操作の実行を要求します。
    * 2 番目のメッセージには操作の結果が含まれ、次の状況で送信されます。
        * ユーザーのセルフサービスのパスワードのリセット時に新しいパスワードが送信された場合
        * ユーザーのパスワード変更操作時に新しいパスワードが送信された場合
        * 管理者によるユーザー パスワードのリセット時に新しいパスワードが送信された場合 (Azure 管理ポータルからのみ)

#### <a name="message-size-and-bandwidth-considerations"></a>メッセージ サイズと帯域幅に関する考慮事項

上記で説明したメッセージの各サイズは、通常 1 kb 未満で、負荷が大きい場合でも、パスワード ライトバック サービス自体で 1 秒間に数キロビットの帯域幅しか消費されないことを意味します。 各メッセージは、パスワードの更新操作で必要になった場合にのみリアルタイムで送信されるため、またメッセージのサイズが非常に小さいため、ライトバック機能の帯域幅は実質的に非常に小さく、実際に測定可能な影響を及ぼすには至りません。

## <a name="next-steps"></a>次のステップ

次のリンク先では、Azure AD を使用したパスワードのリセットに関する追加情報が得られます。

* [**クイック スタート**](active-directory-passwords-getting-started.md) - Azure AD のセルフサービスによるパスワードのリセットの管理を始めることができます。 
* [**ライセンス**](active-directory-passwords-licensing.md) - Azure AD のライセンスを構成します。
* [**データ**](active-directory-passwords-data.md) - パスワード管理に必要なデータとその使用方法がわかります
* [**展開**](active-directory-passwords-best-practices.md) - ここで見つかるガイダンスを使用してユーザーに対する SSPR を計画してデプロイできます
* [**カスタマイズ**](active-directory-passwords-customize.md) - 会社の SSPR エクスペリエンスの外観をカスタマイズします。
* [**ポリシー**](active-directory-passwords-policy.md) - Azure AD のパスワード ポリシーを把握し、設定します
* [**レポート**](active-directory-passwords-reporting.md) - ユーザーが SSPR 機能にアクセスしたかどうかや、アクセスしたタイミングと場所を検出します
* [**技術的詳細**](active-directory-passwords-how-it-works.md) - しくみを詳しく説明しています
* [**よく寄せられる質問**](active-directory-passwords-faq.md) - どのようにですか? なぜですか? 何ですか? どこですか? 誰がですか? いつですか? - ずっと確認したかった質問に対する回答
* [**トラブルシューティング**](active-directory-passwords-troubleshoot.md) - SSPR の一般的な問題を解決する方法について説明しています

[Writeback]: ./media/active-directory-passwords-writeback/enablepasswordwriteback.png "Azure AD Connect でパスワード ライトバックを有効にする"
