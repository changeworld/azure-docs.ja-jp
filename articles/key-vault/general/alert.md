---
title: Azure Key Vault の監視とアラート | Microsoft Docs
description: キー コンテナーの正常性を監視しアラートを構成するためのダッシュボードを作成します。
services: key-vault
author: ShaneBala-keyvault
manager: ravijan
tags: azure-resource-manager
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
ms.date: 04/06/2020
ms.author: sudbalas
Customer intent: As a key vault administrator, I want to learn the options available to monitor the health of my vaults
ms.openlocfilehash: cc0d969ff6eb76732768dfed2826762920ae9e62
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2020
ms.locfileid: "81725808"
---
# <a name="monitoring-and-alerting-for-azure-key-vault"></a>Azure Key Vault の監視とアラート

## <a name="overview"></a>概要

キー コンテナーを使用した運用環境のシークレットの保管を開始した後は、サービスが意図したとおりに動作しているか確認するために、キー コンテナーの正常性を監視することが重要です。 サービスのスケーリングを開始すると、キー コンテナーに送信される要求の数が増加します。 これにより要求の待機時間が長くなる可能性があり、極端な場合には要求がスロットルされてサービスのパフォーマンスに影響を与えます。 また、アクセス ポリシーやファイアウォールの構成の問題についてすぐに通知を受けられるように、キー コンテナーが異常な数のエラー コードを送信している場合にアラートを受け取る必要があります。 このドキュメントでは、次のトピックについて説明します。

+ 監視する基本的な Key Vault メトリック
+ メトリックの構成方法とダッシュボードの作成方法 
+ 指定したしきい値でアラートを作成する方法 

## <a name="basic-key-vault-metrics-to-monitor"></a>監視する基本的な Key Vault メトリック

+ コンテナーの可用性  
+ コンテナーの飽和度 
+ サービス API 待機時間 
+ サービス API ヒット数の合計 (アクティビティの種類でフィルター処理) 
+ エラー コード (状態コードでフィルター処理) 

**コンテナーの可用性** -  このメトリックは常に 100% である必要があります。これは、キー コンテナーに障害が発生したかどうかをすばやく確認できるため、監視する上で重要なメトリックです。 

**コンテナーの飽和度** - キー コンテナーが処理できる 1 秒あたりの要求の数は、実行されている操作の種類によって決まります。 一部のコンテナー操作では、1 秒あたりの要求数のしきい値が低くなります。 このメトリックは、すべての操作の種類におけるキー コンテナーの総使用量を集計し、現在のキー コンテナーの使用量を示すパーセンテージ値を取得します。 キー コンテナー サービス制限の完全な一覧については、次のドキュメントを参照してください。 [Azure Key Vault サービスの制限](service-limits.md)

**サービス API 待機時間** - このメトリックは、キー コンテナーへの呼び出しの平均待機時間を示します。 キー コンテナーがサービス制限の範囲内にある場合でも、キー コンテナーの使用率が高いと待機時間が発生し、ダウンストリームのアプリケーションに障害が発生する可能性があります。 

**Total API Hits (API ヒット数の合計)** - このメトリックは、キー コンテナーに対して行われたすべての呼び出しを表示します。 これは、どのアプリケーションがキー コンテナーを呼び出しているかを特定するのに役立ちます。 

**エラー コード** - このメトリックは、キー コンテナーで異常な数のエラーが発生しているかどうかを示します。 エラー コードとトラブルシューティング ガイダンスの完全な一覧については、次のドキュメントを参照してください。 [Azure Key Vault REST API のエラー コード](rest-error-codes.md)

## <a name="how-to-configure-metrics-and-create-a-dashboard"></a>メトリックの構成方法とダッシュボードの作成方法

1. Azure portal にログインします
2. お使いのキー コンテナーに移動します
3. **[監視]** で **[メトリック]** を選択します 

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-1.png)

4. グラフのタイトルを、ダッシュボードに表示する内容に更新します。 
5. スコープを選択します。 この例では、単一のキー コンテナーを選択します。 
6. メトリックとして **[コンテナーの全体的な可用性]** 、 集計として **[平均]** を選択します。 
7. 時間の範囲を [過去 24 時間] に更新し、時間の細分性を [1 分] に更新します。 

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-2.png)

8. [コンテナーの飽和度] と [サービス API 待機時間] メトリックについて、上記の手順を繰り返します。 **[ダッシュボードにピン留めする]** を選択し、ダッシュボードにメトリックを保存します。 

> [!IMPORTANT]
> [ダッシュボードにピン留めする] を選択し、構成するすべてのメトリックを保存します。 保存せずにこのページを離れて戻った場合、構成の変更は失われます。 

9. キー コンテナーに対するすべての種類の操作を監視するには、 **[サービス API ヒット数の合計]** メトリックを使用して、 **[Apply Splitting by Activity Type]\(アクティビティの種類ごとに分割を適用\)** を選択します。

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-3.png)

10. キー コンテナーのエラー コードを監視するには、 **[サービス API 結果数の合計]** メトリックを使用して、 **[Apply Splitting by Activity Type]\(アクティビティの種類ごとに分割を適用\)** を選択します。

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-4.png)

これで、ダッシュボードは次のようになります。 各タイルの右上にある 3 つの点をクリックすると、必要に応じてタイルの並べ替えやサイズ変更を行うことができます。 

ダッシュボードを保存して発行すると、Azure サブスクリプションに新しいリソースが作成されます。 「共有ダッシュボード」で検索すれば、これをいつでも表示できます。 

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-5.png)

## <a name="how-to-configure-alerts-on-your-key-vault"></a>Key Vault でアラートを構成する方法 

このセクションでは、キー コンテナーの状態が正常でない場合にすぐに対処するようにチームに警告できるように、キー コンテナーでアラートを構成する方法について説明します。 電子メールを (望ましくは) チーム DL に送信したり、Event Grid 通知を起動したり、電話番号に発信したりテキストを送信したりするアラートを構成できます。 固定値に基づいて静的アラートを選択することもできます。また、監視対象のメトリックが、定義された時間範囲内でキー コンテナーの平均値を一定回数超えた場合にアラートを生成する動的アラートを選択することもできます。 

> [!IMPORTANT]
> 新しく構成されたアラートが通知の送信を開始するまでに最大 10 分かかる場合があることに注意してください。 

### <a name="configure-an-action-group"></a>アクション グループを構成する 

アクション グループは、通知とプロパティの構成可能な一覧です。

1. Azure portal にログインします
2. 検索ボックスで「**アラート**」を検索します。
3. **[アクションの管理]** を選択します。

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-6.png)

4. **[+ アクション グループの追加]** を選択します。

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-7.png)

5. アクション グループの **[アクションの種類]** を選択します。 この例では、電子メール アラートを作成します。

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-8.png)

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-9.png)

6. ページの下部にある **[OK]** をクリックします。 アクション グループの作成が正常に完了しました。 

アクション グループの構成が完了したので、キー コンテナー アラートのしきい値を構成します。 

### <a name="configure-alert-thresholds"></a>アラートのしきい値を構成する 

1. Azure portal でキー コンテナー リソースを選択し、 **[監視]** の下にある **[アラート]** を選択します。

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-10.png)

2. **[新しいアラート ルール]** を選択します。

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-11.png)

3. アラート ルールのスコープを選択します。 1 つまたは複数のコンテナーを選択できます。 

> [!IMPORTANT]
> アラートのスコープに対して複数のコンテナーを選択する場合は、選択したすべてのコンテナーが同じリージョンに存在する必要があることに注意してください。 異なるリージョンのコンテナーに対して個別のアラート ルールを構成する必要があります。 

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-12.png)

4. アラートの条件を選択します。 次のいずれかのシグナルを選択して、アラートのロジックを定義できます。 Key Vault チームでは、次のアラートのしきい値を構成することをお勧めします。 

    + Key Vault の可用性が 100% を下回る (静的しきい値)
    + Key Vault の待機時間が 500 ミリ秒を超える (静的しきい値) 
    + コンテナーの全体的な飽和度が 75% を超える (静的しきい値) 
    + コンテナーの全体的な飽和度が平均を超える (動的しきい値)
    + エラー コードの総数が平均を超える (動的しきい値) 

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-13.png)

### <a name="example-1-configuring-a-static-alert-threshold-for-latency"></a>例 1:待機時間に対する静的アラートのしきい値の構成

シグナル名として **[サービス API の全体的な待機時間]** を選択します。
> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-14.png)

次の構成パラメーターを確認してください。

+ [しきい値] を **[静的]** に設定します 
+ [演算子] を **[より大きい]** に設定します
+ [集計の種類] を **[平均]** に設定します
+ [しきい値] を **[500]** に設定します
+ [Aggregation Period]\(集計期間\) を **[5 分]** に設定します
+ [評価の頻度] を **[1 分]** に設定します
+ **[完了]** を選択します  

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-15.png)

### <a name="example-2-configuring-a-dynamic-alert-threshold-for-vault-saturation"></a>例 2:コンテナーの飽和度に対する動的アラートのしきい値の構成 

動的アラートを使用すると、選択したキー コンテナーの履歴データを表示できるようになります。 青色の領域は、キー コンテナーの平均使用量を表します。 赤色の領域は、アラート構成の他の条件が満たされた場合にアラートをトリガーするスパイクを示しています。 赤色の点は、集約期間の時間枠でアラートの条件が満たされた違反のインスタンスを示します。 設定した時間内に特定の数の違反が発生した後に起動するようにアラートを設定できます。 過去のデータを含めたくない場合は、以下の詳細設定で古いデータを除外するオプションがあります。 

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-16.png)

次の構成パラメーターを確認してください。

+ [しきい値] を **[動的]** に設定します 
+ [演算子] を **[より大きい]** に設定します
+ [集計の種類] を **[平均]** に設定します
+ [しきい値の感度] を **[中]** に設定します
+ [Aggregation Period]\(集計期間\) を **[5 分]** に設定します
+ [評価の頻度] を **[1 分]** に設定します
+ **(オプション)** 詳細設定を構成します 
+ **[完了]** を選択します

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-17.png)

5. 構成したアクション グループを追加します

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-18.png)

6. アラートを有効にして重要度を割り当てます

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-19.png)

7. アラートを作成する 


## <a name="next-steps"></a>次のステップ

これで、監視ダッシュボードが正常に作成され、キー コンテナーのアラートが構成されました。 上記のすべての手順を実行すると、構成したアラート条件をキー コンテナーが満たした場合に電子メール アラートが届きます。 次に例を示します。 この記事で設定したツールを使用して、キー コンテナーの正常性をアクティブに監視します。 

### <a name="example-email-alert"></a>電子メール アラートの例 

> [!div class="mx-imgBorder"]
> ![Azure portal のスクリーンショット](../media/alert-20.png)
