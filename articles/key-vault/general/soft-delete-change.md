---
title: すべての Azure Key Vault での論理的な削除の有効化 | Microsoft Docs
description: このドキュメントを使用して、すべてのキー コンテナーに対して論理的な削除を適用します。
services: key-vault
author: ShaneBala-keyvault
manager: ravijan
tags: azure-resource-manager
ms.service: key-vault
ms.topic: conceptual
ms.date: 07/27/2020
ms.author: sudbalas
ms.openlocfilehash: 0e811cc219002c034afb968be760ce2c249b08f3
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/09/2020
ms.locfileid: "91825252"
---
# <a name="soft-delete-will-be-enabled-on-all-key-vaults"></a>すべてのキー コンテナーでの論理的な削除の有効化

> [!WARNING]
> **破壊的変更**:論理的な削除をオプトアウトする機能は、本年の終わりまでに非推奨になり、すべてのキー コンテナーに対して論理的な削除の保護が自動的に有効になります。  Azure Key Vault のユーザーと管理者は、キー コンテナーの論理的な削除を直ちに有効にする必要があります。
>
> Managed HSM の場合、論理的な削除は既定で有効になっており、無効にすることはできません。

論理的な削除の保護なしでキー コンテナーからシークレットを削除すると、シークレットは完全に削除されます。 現在、ユーザーは、キー コンテナーの作成中に論理的な削除をオプトアウトできますが、ユーザーによる偶発的または悪意のある削除からシークレットを保護するために、Microsoft は間もなく**すべての**キー コンテナーに対して論理的な削除の保護を有効にし、ユーザーは論理的な削除をオプトアウトまたはオフにするオプションを使用できなくなります。

:::image type="content" source="../media/softdeletediagram.png" alt-text="<alt text>":::

論理的な削除機能の詳細については、「[Azure Key Vault の論理的な削除の概要](soft-delete-overview.md)」を参照してください。

## <a name="how-do-i-respond-to-breaking-changes"></a>破壊的変更に対応する方法

キー コンテナー オブジェクトは、論理的に削除された状態のキー コンテナー オブジェクトと同じ名前では作成できません。  たとえば、キー コンテナー A で `test key` という名前のキーを削除した場合、論理的に削除された `test key` オブジェクトが消去されるまで、キー コンテナー A で `test key` という名前の新しいキーは作成できません。

### <a name="application-changes"></a>アプリケーションの変更

お使いのアプリケーションで論理的な削除が有効になっておらず、削除されたシークレットまたはキー コンテナーの名前を即時に再利用できることが想定されている場合、この変更を適用するには、アプリケーション ロジックで次の変更を行う必要があります。

1. 元のキー コンテナーまたはシークレットを削除します。
2. 論理的に削除された状態のキー コンテナーまたはシークレットを消去します。
3. 待機します – すぐに再作成すると、競合が発生する可能性があります。
4. 同じ名前でキー コンテナーを再作成します。
5. 作成操作で名前の競合エラーが引き続き発生する場合は再試行を行ってください。最も悪いシナリオでは、DNS レコードが更新されるまでに最大で 10 分かかることがあります。

### <a name="administration-changes"></a>管理の変更

シークレットを完全に削除するためのアクセス権が必要なセキュリティ プリンシパルには、それらのシークレットとキー コンテナーを消去するための追加のアクセス ポリシー アクセス許可を付与する必要があります。

論理的な削除の無効化を必須とする Azure Policy がキー コンテナーに適用されている場合、このポリシーを無効にする必要があります。  この問題は、ご使用の環境に適用される Azure Policy を制御する管理者にエスカレーションする必要がある場合があります。 このポリシーが無効になっていない場合、適用されるポリシーのスコープ内で新しいキー コンテナーを作成できなくなる可能性があります。

所属する組織が法的なコンプライアンス要件に従い、削除されたキー コンテナーとシークレットを回復可能な状態に長期間維持することを許容できない場合は、組織の基準を満たすために、論理的な削除の保持期間を調整する必要があります。この期間は、7 日から 90 日の範囲で構成できます。

## <a name="procedures"></a>手順

### <a name="audit-your-key-vaults-to-check-if-soft-delete-is-enabled"></a>キー コンテナーを監査して、論理的な削除が有効になっているかどうか確認する

1. Azure ポータルにログインします。
2. 「Azure Policy」を検索します。
3. [定義] を選択します。
4. [カテゴリ] で、フィルターの [キー コンテナー] を選択します。
5. [キー コンテナー オブジェクトが回復可能でなければならない] ポリシーを選択します。
6. [割り当て] をクリックします。
7. スコープをサブスクリプションに設定します。
8. [確認と作成] を選択します。
9. 環境のフル スキャンが完了するまでに最大 24 時間かかる場合があります。
10. Azure Policy ブレードで、[コンプライアンス] をクリックします。
11. 適用したポリシーを選択します。

これで、キー コンテナーのうちソフト削除が有効になっているもの (準拠しているリソース) と、ソフト削除が有効になっていないもの (非準拠のリソース) をフィルター処理して確認できるようになります。

### <a name="turn-on-soft-delete-for-an-existing-key-vault"></a>既存のキー コンテナーの論理的な削除を有効にする

1. Azure ポータルにログインします。
2. キー コンテナーを検索します。
3. [設定] で [プロパティ] を選択します。
4. [論理的な削除] で、[Enable recovery of this vault and its objects]\(このコンテナーとそのオブジェクトの回復を有効にする\) に対応するラジオ ボタンを選択します。
5. 論理的な削除の保持期間を設定します。
6. [保存] を選択します。

### <a name="grant-purge-access-policy-permissions-to-a-security-principal"></a>消去アクセス ポリシー アクセス許可をセキュリティ プリンシパルに付与する

1. Azure ポータルにログインします。
2. キー コンテナーを検索します。
3. [設定] で [アクセス ポリシー] を選択します。
4. アクセス権を付与するサービス プリンシパルを選択します。
5. [キー]、[シークレット]、[証明書のアクセス許可] の下にある各ドロップダウンで、[Privileged Operations]\(特権操作\) まで下にスクロールし、[Purge]\(消去\) アクセス許可を選択します。

## <a name="frequently-asked-questions"></a>よく寄せられる質問

### <a name="does-this-change-affect-me"></a>この変更は私に影響しますか?

既に論理的な削除が有効になっている場合、または同じ名前のキー コンテナー オブジェクトを削除して再作成しない場合は、キー コンテナーの動作の変更に気付かない可能性があります。

同じ名前付け規則を使用してキー コンテナー オブジェクトを削除して再作成するアプリケーションがある場合、期待される動作を維持するには、アプリケーション ロジックに変更を加える必要があります。 上記の「破壊的変更に対応する方法」 セクションを参照してください。

### <a name="how-do-i-benefit-from-this-change"></a>この変更にはどのような利点がありますか?

論理的な削除の保護により、組織は、偶発的または悪意のある削除に対する追加の保護層を得ることができます。 キー コンテナー管理者は、復旧アクセス許可と消去アクセス許可の両方へのアクセス権を制限できます。

ユーザーが誤ってキー コンテナーまたはシークレットを削除しても、シークレットまたはキー コンテナーが完全に削除されるリスクを生じさせずに、シークレット自体を復旧するためのアクセス許可をそのユーザーに付与できます。 このセルフサービス プロセスにより、環境のダウンタイムが最小限に抑えられ、シークレットの可用性が保証されます。

### <a name="how-do-i-find-out-if-i-need-to-take-action"></a>アクションを実行する必要があるかどうかはどのように判断しますか?

「キー コンテナーを監査して、論理的な削除が有効になっているかどうか確認する」という上記のセクションの手順に従ってください。 論理的な削除が有効になっていないすべてのキー コンテナーは、この変更の影響を受けます。 監査に役立つ追加のツールが間もなく利用可能になり、このドキュメントは更新される予定です。

### <a name="what-action-do-i-need-to-take"></a>どのようなアクションを実行する必要がありますか?

アプリケーション ロジックを変更する必要がないか確認してください。 これを確認した後、すべてのキー コンテナーで論理的な削除を有効にします。 これにより、本年の終わりにすべてのキー コンテナーに対して論理的な削除が有効化されたときに、破壊的変更の影響を受けなくなります。

### <a name="by-when-do-i-need-to-take-action"></a>いつまでにアクションを実行する必要がありますか?

すべてのキー コンテナーに対して、本年の終わりまでに論理的な削除が有効になります。 アプリケーションが影響を受けないようにするには、できるだけ早くキー コンテナーの論理的な削除を有効にしてください。

## <a name="what-will-happen-if-i-dont-take-any-action"></a>何もアクションを実行しないとどうなりますか?

何もアクションを実行しないと、本年の終わりにすべてのキー コンテナーに対して論理的な削除が自動的に有効になります。 このため、キー コンテナー オブジェクトを削除し、それを論理的に削除された状態から消去せずに同じ名前で再作成しようとすると、競合エラーが発生する可能性があります。 これにより、アプリケーションまたはオートメーションで障害が発生する可能性があります。

## <a name="next-steps"></a>次のステップ

- この変更についてご質問がある場合は、[akvsoftdelete@microsoft.com](mailto:akvsoftdelete@microsoft.com) までお問い合わせください。
- 「[論理的な削除の概要](soft-delete-overview.md)」を参照してください。
