---
title: Azure IoT Hub X.509 セキュリティの概念 | Microsoft Docs
description: 概念 - IoT デバイスの製造および認証における X.509 証明機関証明書を使用する価値を理解します。
author: eustacea
manager: arjmands
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 09/18/2017
ms.author: eustacea
ms.openlocfilehash: 3c7e1167b3326620863d35cb2d4b07235cbd5517
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/27/2020
ms.locfileid: "61320522"
---
# <a name="conceptual-understanding-of-x509-ca-certificates-in-the-iot-industry"></a>IoT 業界における X.509 CA 証明書の概念理解

この記事では、IoT デバイスの製造および IoT Hub に対する認証で X.509 証明機関 (CA) 証明書を使用する価値について説明します。 サプライ チェーンの設定に関する情報と主な利点についても記載します。

この記事では、次の内容について説明します。

* X.509 CA 証明書の概要と入手方法

* X.509 CA 証明書を IoT Hub に登録する方法

* X.509 CA ベースの認証用に製造サプライ チェーンを設定する方法

* X.509 CA で署名されたデバイスから IoT Hub に接続する方法

## <a name="overview"></a>概要

X.509 証明機関 (CA) 認証は、サプライ チェーンにおけるデバイス ID の作成とライフサイクル管理を劇的に簡素化する方法を使用して IoT Hub に対してデバイスを認証するための手法です。

X.509 CA 認証の特徴的な属性として、CA 証明書がそのダウンストリームのデバイスとの間に持つ一対多のリレーションシップがあります。 このリレーションシップにより、X.509 CA 証明書を 1 回登録するだけで多数のデバイスを IoT Hub に登録することが可能になります。このリレーションシップがなければ、デバイスごとにデバイスの一意の証明書をあらかじめ登録してから、デバイスを接続する必要があります。 また、この一対多のリレーションシップにより、デバイス証明書のライフサイクル管理操作も簡単になります。

X.509 CA 認証のもう 1 つの重要な属性として、サプライ チェーンのロジスティクスの簡略化があります。 デバイスのセキュリティで保護された認証では、各デバイスが信頼の基盤として一意のシークレット (キーなど) を保持していることが必要となります。 証明書ベースの認証では、このシークレットは秘密キーです。 一般的なデバイス製造フローには、複数のステップと管理者が含まれています。 複数の管理者間でデバイスの秘密キーを安全に管理し、信頼を維持することは難しいうえにコストも高くなります。 証明機関を使用すると、各管理者にデバイスの秘密キーを委ねるのではなく、各管理者に署名して暗号の信頼チェーンを確立するため、この問題は解決します。 次に、各管理者は、製造フローのそれぞれのプロセス ステップでデバイスに署名します。 総合的な結果として、暗号の信頼チェーンの使用によりアカウンタビリティが組み込まれた最適なサプライ チェーンになります。 注目すべきは、このプロセスでは、デバイスで一意の秘密キーが保護されている場合にセキュリティが最も強力になることです。 この目的に向けて、公開されることのない秘密キーを内部的に生成できるハードウェア セキュア モジュール (HSM) の使用を強くお勧めします。

この記事では、理解を深めるために実際の例を使用しながら、サプライ チェーンの設定からデバイス接続まで X.509 CA 認証の使用を詳しく説明します。

## <a name="introduction"></a>はじめに

X.509 CA 証明書はデジタル証明書であり、その所有者は他の証明書に署名することができます。 このデジタル証明書は、IETF の RFC 5280 標準で規定されている証明書形式の標準に準拠していることから X.509 であり、その所有者が他の証明書に署名できることから証明機関 (CA) でもあります。

X.509 CA の使用について、具体的な例との関連で理解を深めていきます。 Company-X は、専門施設向けに設計された Smart-X-Widget のメーカーです。 Company-X は、製造とインストールの両方を外部に委託しています。 これは、製造会社 Factory-Y に Smart-X-Widget の製造を委託し、サービス プロバイダー Technician-Z にインストールを委託しています。 Company-X は、Smart-X-Widget をインストールの目的で Factory-Y から Technician-Z に直接出荷し、インストール後に Company-X が介入することなく Company-X の IoT Hub のインスタンスに直接接続することを希望しています。 これを実現するには、Company-X は、Smart-X-Widget を自動接続するための準備として 1 回限りの設定操作を数回実行する必要があります。 このエンド ツー エンドのシナリオを考慮したうえで、この記事の残りの部分は次のように構成されています。

* X.509 CA 証明書を取得する

* X.509 CA 証明書を IoT Hub に登録する

* デバイスに署名して証明書の信頼チェーンに入れる

* デバイスの接続

## <a name="acquire-the-x509-ca-certificate"></a>X.509 CA 証明書を取得する

Company-X には、公的なルート証明機関から X.509 CA 証明書を購入するか、または自己署名プロセスを通じて X.509 CA 証明書を作成するかの選択肢があります。 アプリケーションのシナリオに応じて、どちらかの選択肢の方が適切かが異なります。 この選択肢に関係なく、このプロセスには、公開キーと秘密キーのペアの生成と公開キーによる証明書への署名という 2 つの基本的な手順が伴います。

![X509CA 証明書を生成するフロー](./media/iot-hub-x509ca-concept/csr-flow.png)

これらの手順を実行する方法の詳細は、それぞれのサービス プロバイダーによって異なります。

### <a name="purchasing-an-x509-ca-certificate"></a>X.509 CA 証明書の購入

CA 証明書を購入することで、既知のルート CA が IoT デバイスの接続時にデバイスの正当性を保証する信頼されたサード パーティとして機能するという利点が得られます。 Company-X は、Smart-X-Widget が IoT Hub に最初に接続した後にサード パーティ製の製品やサービスと対話することを考えている場合は、このオプションを選択します。

X.509 CA 証明書を購入するには、Company-X は、ルート証明書のサービス プロバイダーを選択する必要があります。 "ルート CA" という語句をインターネットで検索すると、良い手がかりが得られます。 ルート CA により、Company-X に対して、公開キーと秘密キーのペアの作成方法と、サービスの証明書署名要求 (CSR) の生成方法が示されます。 CSR は、証明機関からの証明書を申請する正式なプロセスです。 この購入の結果、証明機関の証明書として使用するための証明書を取得できます。 X.509 証明書の遍在性を考慮すると、この証明書は IETF の RFC 5280 標準に合わせて適切に書式設定されている可能性があります。

### <a name="creating-a-self-signed-x509-ca-certificate"></a>自己署名 X.509 CA 証明書の作成

ルート証明機関のようなサード パーティの署名者が関与する点を除けば、購入プロセスと自己署名 X.509 CA 証明書の作成プロセスは似ています。 この例では、Company-X が、ルート証明機関に代わってその証明機関の証明書に署名します。 Company-X は、証明機関の証明書を購入する準備が整うまで、テスト目的でこのオプションを選択できます。 また、Company-X は、Smart-X-Widget が IoT Hub 以外のサード パーティのサービスに接続することを目的としていない場合に運用環境で自己署名 X.509 CA 証明書を使用することもあります。

## <a name="register-the-x509-certificate-to-iot-hub"></a>X.509 証明書を IoT Hub に登録する

Company-X は、X.509 CA を IoT Hub に登録する必要があります。IoT Hub は、Smart-X-Widget を接続時に認証する役割を果たします。 これは 1 回限りのプロセスであり、任意の数の Smart-X-Widget デバイスの認証および管理が可能になります。 このプロセスは、証明機関の証明書とデバイスとの間の一対多のリレーションシップのため 1 回限りであり、X.509 CA 認証方法を使用する主な利点の 1 つになります。 また、Smart-X-Widget デバイスごとに個別の証明書拇印をアップロードする方法もありますが、その場合は運用コストが増加します。

X.509 CA 証明書の登録は、証明書のアップロードと証明書の所有証明による 2 段階のプロセスです。

![X509CA 証明書の登録](./media/iot-hub-x509ca-concept/pop-flow.png)

### <a name="x509-ca-certificate-upload"></a>X.509 CA 証明書のアップロード

X.509 CA 証明書のアップロード プロセスは、IoT Hub に CA 証明書をアップロードするだけです。 IoT Hub は、ファイル形式の証明書を必要とします。 Company-X は、証明書ファイルをアップロードするだけです。 いかなる場合においても、証明書ファイルに秘密キーを含めないでください。 公開キー基盤 (PKI) を規定する標準によるベスト プラクティスでは、この場合の Company-X の秘密の知識は Company-X 内のみに限定して存在することが求められています。

### <a name="proof-of-possession-of-the-certificate"></a>証明書の所有証明

X.509 CA 証明書は、他のデジタル証明書と同様に、傍受されやすい公開情報です。 そのため、傍受者は、証明書を傍受し、その証明書を自分のものとしてアップロードしようとする可能性があります。 この例では、IoT Hub は、Company-X がアップロードしている CA 証明書が本当に Company-X に属しているかどうかを確認します。 このためには、Company-X にチャレンジを送信して、Company-X が証明書を実際に所有していることを[所有証明 (PoP) フロー](https://tools.ietf.org/html/rfc5280#section-3.1)を通じて証明します。 所有証明フローは、Company-X が秘密キーを使用して署名する乱数を IoT Hub が生成することを伴います。 Company-X が PKI のベスト プラクティスに従い、秘密キーを保護した場合、所有証明チャレンジに正しく応答できる立場にあるのは Company-X のみです。 IoT Hub は、所有証明チャレンジの応答に成功すると、X.509 CA 証明書の登録に進みます。

IoT Hub からの所有証明チャレンジに対する応答に成功すると、X.509 CA の登録が完了します。

## <a name="sign-devices-into-a-certificate-chain-of-trust"></a>デバイスに署名して証明書の信頼チェーンに入れる

IoT では、各デバイスが一意の ID を保有する必要があります。 これらの ID は、証明書ベースの認証スキーム用の証明書の形式になっています。 つまり、この例では、各 Smart-X-Widget が一意のデバイス証明書を保有している必要があります。 Company-X はサプライ チェーンにおいてこれについてどのように設定するでしょうか。

これに着手するための 1 つの方法として、Smart-X-Widget 用の証明書を事前に生成し、対応する一意のデバイス秘密キーの情報をサプライ チェーン パートナーに委任します。 Company-X の場合、これは Factory-Y と Technician-Z に委任することを意味します。 これは有効な方法ですが、次のように、信頼を確保するために克服しなければならない課題も伴います。

1. 秘密キーを共有しないという PKI のベスト プラクティスを無視するうえに、デバイスの秘密キーをサプライ チェーン パートナーと共有しなければならないことにより、サプライ チェーンにおける信頼構築はコストが高くなります。 これは、デバイスの秘密キーを保管するための安全な部屋などの資本システムを意味します。さらに、定期的なセキュリティ監査などのプロセスの導入が必要になります。 どちらも、サプライ チェーンのコストを引き上げます。

2. サプライ チェーン内のデバイスを安全にアカウンティングした後、それらをデプロイで管理することは、デバイスに一意の証明書 (したがって秘密キー) の生成時点からデバイスの廃棄時点まで、キーとデバイスのペアごとに一対一のタスクになります。 これにより、グループの概念が何らかの形で明示的にプロセスに組み込まれていない限り、デバイスのグループ管理は除外されます。 したがって、安全なアカウンティングとデバイスのライフ サイクル管理は運用上の大きな負担になります。 この例では、Company-X がこの負担を負うことになります。

X.509 CA 証明書認証は、証明書チェーンを使用することで、前述の課題に対する洗練されたソリューションを提供します。 証明書チェーンは、中間 CA に署名する CA から始まり、その中間 CA が別の中間 CA に署名し、最終の中間 CA がデバイスに署名するまで続きます。 この例では、Company-X が Factory-Y に署名します。次に Factory-Y が Technician-Z に署名し、最後に Technician-Z が Smart-X-Widget に署名します。

![証明書チェーンの階層](./media/iot-hub-x509ca-concept/cert-chain-hierarchy.png)

上記のチェーン内の証明書の伝播は、権限の論理的な引き継ぎを示します。 多くのサプライ チェーンは、この論理的な引き継ぎに従っています。つまり、各中間 CA は、すべての上流 CA 証明書を受信し、署名されてチェーンに入れられます。最終的に、最後の中間 CA が各デバイスに署名し、チェーンからのすべての証明機関の証明書をデバイスに挿入します。 これは、工場の階層がある契約製造会社が特定の工場に製造を委託する場合に一般的です。 階層は複数レベル (たとえば、地理、製品の種類、製造ライン) で構成される場合がありますが、最後の工場だけがデバイスと対話できます。ただし、チェーンは階層の最上位から保持されます。

代替チェーンには、デバイスと対話する別の中間 CA が含まれる場合があります。その場合、デバイスと対話する CA が、その時点での証明書チェーンの内容を挿入します。 CA の一部だけがデバイスと物理的に対話するハイブリッド モデルも可能です。

この例では、Factory-Y と Technician-Z の両方が Smart-X-Widget と対話します。 Company-X は Smart-X-Widget を所有していますが、実際にはサプライ チェーン全体において物理的に Smart-X-Widget と対話しません。 そのため、Smart-X-Widget の証明書の信頼チェーンは、Company-X が Factory-Y に署名し、その後 Factory-Y が Technician-Z に署名して、最後に Technician-Z が Smart-X-Widget に署名するという構成になっています。 Smart-X-Widget の製造およびインストールは、それぞれの中間 CA 証明書を使用して各 Smart-X-Widget に署名する Factory-Y と Technician-Z から構成されます。 このプロセス全体の最終結果は、一意のデバイス証明書を保持する Smart-X-Widget と、Company-X CA 証明書までつながる証明書の信頼チェーンになります。

![1 つの会社の証明書から別の会社の証明書への信頼チェーン](./media/iot-hub-x509ca-concept/cert-mfr-chain.png)

ここで、X.509 CA 方式の価値を再検討してみましょう。 Company-X は、Smart-X-Widget ごとに証明書を事前に生成してサプライ チェーンに渡すのではなく、1 回だけ Factory-Y に対して署名するだけです。 Company-X は、デバイスのライフ サイクル全体ですべてのデバイスを追跡する必要がなくなる代わりに、サプライ チェーン プロセスから自然に出てくるグループ (ある年の 7 月以降に Technician-Z がインストールしたデバイスなど) でデバイスを追跡および管理できるようになります。

最後に大事なこととして、CA 認証方式は、デバイス製造サプライ チェーンに安全なアカウンタビリティを提供します。 この証明書チェーン プロセスにより、チェーン内の各メンバーのアクションは暗号化によって記録され、検証可能になります。

このプロセスは、特定の前提条件に依存しています。完全を期すために、この前提条件についても説明します。 これには、デバイスの一意の公開キーと秘密キーのペアを個別に作成し、秘密キーをデバイス内で保護する必要があります。 さいわいなことに、内部的にキーを生成して秘密キーを保護できる、ハードウェア セキュア モジュール (HSM) 形式の安全なシリコン チップが存在します。 Company-X は、Smart-X-Widget の部品表にこの種のチップを 1 つ追加するだけで済みます。

## <a name="device-connection"></a>デバイスの接続

ここまでのセクションを考慮したうえで、デバイス接続について説明します。 X.509 CA 証明書を IoT Hub に一度登録するだけで、どのように何百万台ものデバイスが接続され、初回から認証されるのでしょうか。  簡単です。既に X.509 CA 証明書の登録で出てきたのと同じ証明書のアップロードと所有証明のフローが使用されます。

X.509 CA 認証用に製造されたデバイスには、デバイスに一意の証明書と、それぞれの製造サプライ チェーンからの証明書チェーンが用意されています。 デバイスの接続は、初めての場合でも、証明書チェーンのアップロードと所有証明の 2 段階のプロセスで行われます。

証明書チェーンのアップロード中、デバイスは、デバイスに一意の証明書と共に、デバイスにインストールされている証明書チェーンを IoT Hub にアップロードします。 IoT Hub は、事前登録された X.509 CA 証明書を使用して、暗号によっていくつかの確認 (アップロードされた証明書チェーンが内部で一貫性があることと、そのチェーンが X.509 CA 証明書の有効な所有者によって発信されたこと) を行うことができます。 X.509 CA の登録プロセスと同様に、IoT Hub は、所有証明のチャレンジ/応答プロセスを開始して、チェーンを確認し、デバイス証明書がそれを実際にアップロードしたデバイスに属していることを確認します。 これを行うには、IoT Hub による検証に秘密キーを使用して、デバイスが署名するランダム チャレンジを生成します。 正常な応答により、IoT Hub はデバイスを認証済みとして受け入れ、接続を許可します。

この例では、各 Smart-X-Widget は、デバイスに一意の証明書を Factory-Y および Technician-Z の X.509 CA 証明書と共にアップロードした後、IoT Hub からの所有証明チャレンジに応答します。

![1 つの証明書から別の証明書へのフロー、ハブからのポップ チャレンジ](./media/iot-hub-x509ca-concept/device-pop-flow.png)

信頼の基盤は秘密キー (デバイスの秘密キーを含む) の保護にあることに注意してください。 したがって、デバイスの秘密キーを保護するためのハードウェア セキュア モジュール (HSM) 形式の安全なシリコン チップと、秘密キーを共有しない (たとえば、工場間では秘密キーを使用して委任しない) というベスト プラクティスはついては、その重要性をいくら強調しても足りません。