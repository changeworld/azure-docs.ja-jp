<properties
 pageTitle="IoT デバイス管理 | Microsoft Azure"
 description="IoT デバイスを管理するための IoT Hub と IoT Suite の使用の概要"
 services="iot-hub,iot-suite"
 documentationCenter=""
 authors="dominicbetts"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="01/21/2016"
 ms.author="dobett"/>

# Azure IoT Suite と Azure IoT Hub を使った IoT デバイス管理

[Azure IoT Suite][lnk-iot-suite] と Azure IoT Hub は、大規模な IoT ソリューションや、多様なデバイス、多様なデバイス トポロジを対象としたデバイス管理を実現する、基盤となる機能を備えています。この記事の中で触れている "デバイス管理" とは、厳密には "IoT デバイス管理" を指します。

## はじめに

サービス プロバイダーや大企業など、多数の IoT デバイスを運用している組織では、デバイス管理機能を使用して次のようなビジネス プロセスを実行できます。

* IoT デバイスの登録と検出
* 接続性の確保
* デバイス上のソフトウェアのリモートからの構成と更新たとえば、製造工場や油田におけるデバイス管理には、リモートからデバイスの構成や更新を行う際に守るべきポリシーに加え、承認系統、法的監査要件、物理的な安全措置の存在などがあります。

IoT ソリューションに IoT デバイス管理を導入する際は、以下に列挙した機能を実際の事業目標と照らし合わせながら考慮し、それぞれの重要度を判断してください。

* **[デバイスのプロビジョニングと検出](#device-provisioning-and-discovery)**: デバイスをシステムに登録するプロセス。
* **[デバイス レジストリとデバイス モデル](#device-registry-and-device-models)**: デバイス モデルがデバイスの関係、システムにおける役割、検証手法へのメタデータの体系的活用法を表現する方法。
* **[デバイス アクセス管理](#device-access-management)**: デバイスのリソースに対するクラウド サービスからのアクセスを制御する方法。
* **[リモート制御](#remote-control)**: ユーザーが遠隔からデバイスにアクセスし、変更命令を与えるための方法。
* **[リモート管理](#remote-administration-and-monitoring)**: デバイス群の正常性を管理者が定義するプロセス。  
* **[リモート構成](#remote-configuration)**: デバイスの構成を管理者が変更する方法。
* **[ファームウェアとソフトウェアのリモート更新](#remote-firmware-and-software-update)**: デバイスのファームウェアとソフトウェアの更新に管理者が使用できるプロセス。

以降の各セクションでは、上に挙げた個々のデバイス管理機能をさらに踏み込んで説明すると共に、Azure IoT Hub でそれらの機能を導入するためのモデルを簡単に説明します。

## デバイスのプロビジョニングと検出

Azure IoT Hub を使用したデバイスのプロビジョニングは、レジストリ API を使って行います。対象デバイスを登録してキーを渡すか受け取ったら、そのキーを使ってデバイスを有効にして IoT Hub に接続することができます。Azure IoT Hub と通信できるのは、承認された資格情報を提示する登録済みのデバイスだけです。Azure IoT Hub に対するデバイスのアクセスは、管理者がデバイス管理ポータルから無効にできます。

IoT デバイスの製造、プロビジョニング、デプロイの方法によっては、ブートストラップ プロセスを使用することができます。貴社のソリューションの一環としてブートストラップ サービスを構築すると、シンプルな接続手段を確立したり、特定の IoT Hub にデバイスを割り当てる処理に時間差を設けたりすることができます。デバイスがどこで運用されるかは通常、製造時点ではわかりません。ブートストラップ プロセスを使うと、たとえば、複雑になりがちな多数のワークフローで、デバイスを Azure IoT Hub に認識させ、既存のビジネス プロセスにそのデバイスを統合することができます。

ブートストラップ サービスが使用されている環境では、IoT デバイスが起動して要求を発行することにより、割り当て済みの Azure IoT Hub へのアクセスが実現します。デバイスのブートストラップ資格情報など必要なデータはすべて、要求に含めて送信する必要があります。デバイスが承認された場合、ブートストラップ サービスは、割り当て済みの Azure IoT Hub にそのデバイスを登録し、ブートストラップの要求元のデバイスに接続情報を返します。IoT Hub は、ブートストラップの要求元のデバイスに接続情報を返します。

## デバイス レジストリとデバイス モデル

"*デバイス モデル*" とは、デバイス プロパティが含まれるモデルを指します。デバイス プロパティは、クラウド サービスによる読み取りまたは書き込みを行うことができます。また、デバイス上でクラウド サービスからリモートで実行できるデバイス コマンドも含みます。次のセクションで説明するサービス駆動型モデルでは、そのモデルに関する知識をデバイス側は持ちませんが、クラウド サービスはそれでも、デバイスに関するメタデータを追跡し、利用することができます。

デバイスの情報とそれに関連するメタデータを保存することは、IoT システムにおいて、また、デバイス レジストリの役割においてきわめて重要な機能となります。これは特に、変更できないレガシ デバイスやデバイス モデルを使用しないデバイスに当てはまります。サービス駆動型モデルにより、IoT サービスはデバイス群と対話できます。定義されたモデルを使用してデバイスが動作するとき、デバイス レジストリは、整合性の原則に従ってデバイスのデータを反映します (デバイスからマスターにデータが供給される)。この場合、サービスが必要な変更をデバイスに伝え、デバイスが変更を確認した後でのみそれらの変更が有効となります。

### サービス駆動型モデル

Azure IoT Hub に接続するデバイスがデバイス モデルを備えていない場合、登録デバイスとそれに関連したメタデータを追跡するデバイス レジストリを実装することが重要となります。この場合、デバイス レジストリがデバイス メタデータの唯一の保存場所となります。追跡対象となるデバイス メタデータの例として、論理的なトポロジ (フロア 4、ビルディング 109 など) やデバイスの機能 (入室センサーなど)、各種タグ情報を挙げることができます。

### デバイス駆動型モデル

IoT ソリューションで IoT デバイスの機能を活用するには、デバイスが、IoT Hub への接続後、クラウドに対して自分自身の情報を伝える必要があります。IoT ソリューションで利用できる 2 種類のデバイス モデルを以下で説明します。

#### 自己定義型デバイス モデル

デバイス エンジニア (またはデバイス シミュレーターを使用する開発者) は、デバイスを開発する過程で、試行錯誤を繰り返しながらその機能の実装に取り組む際に自己定義型のデバイス モデルを使用します。デバイス エンジニアは、最初はわずかなプロパティと対応コマンドのみを備えたデバイスを作成し、後でさらに追加することができます。同様に、それぞれ一意の機能を備えた多数のデバイスに、自己定義型モデルを使用することもできます。この場合、デバイス エンジニアがデバイス モデルの構造を登録する必要はありません。自己定義型モデルでは、デバイス間の差異が著しく大きくなると、多数のデバイスへのスケーリングで無理が生じる場合があります。

#### 事前定義型デバイス モデル

ネットワークや電力、処理能力の限られた状況下で運用される IoT デプロイメントの場合は、デバイスの処理と消費電力を軽減させるために役立つ、事前定義型のデバイス モデルが大きな利便性を発揮します。同様に、ネットワーク トラフィックがごく小さく抑えられていれば、デバイスからのデータ伝送に、異機種ネットワーク (WiFi、2G/3G/4G、BLE、衛星など) を使うことができます。衛星通信のように、制限が厳しくコストのかかるインフラストラクチャが使われているときは、なおさらです。事前定義型のデバイス モデルを実装するデバイス エンジニアは、キーとしての役割を果たす 1 ～ 2 バイトのデータにデバイス情報をエンコードし、事前定義型のデバイス モデルに適用します。このシンプルなアプローチによって、自己定義型のデバイス モデルと比べ、効率が 1 ～ 2 桁アップします。

### リモート監視の事前構成済みソリューションとそのデバイス モデル

Azure IoT Suite の[リモート監視の事前構成済みソリューション][lnk-remote-monitoring]には、自己定義型のデバイス モデルが実装されています。デバイスの機能を定義および進化させると、このモデルを使用して、すばやく繰り返し実行することができます。

[azure-iot-solution][lnk-azure-iot-solution] GitHub リポジトリで、この事前定義済みソリューションのソース コードを見つけることができます。

リモート監視の事前構成済みソリューションでデバイス オブジェクトを作成し、それをサービスに送信するコードは、**Simulator/Simulator.WorkerRole/SimulatorCore/Devices/DeviceBase.cs** ファイル内にあります。**SendDeviceInfo** メソッドと **GetDeviceInfo** メソッドで、自己記述式のデバイス モデルを作成し、Azure IoT Hub に送信する方法を参照することができます。

デバイス モデルに関連したイベントをクラウド サービスで処理するコードは、**EventProcessor/EventProcessor.WorkerRole/Processors/DeviceManagementProcessor.cs** ファイルにあります。事前構成済みソリューションのサービス側にデバイスによって送信されたデバイス モデル関連メッセージに対して行われるアクションに関係する処理の大部分は、**ProcessJToken** メソッドで行われます。

デバイス モデル関連メッセージを受信した後に、デバイス レジストリの更新を行うのは、**DeviceManagement/Infrastructure/BusinessLogic/DeviceLogic.cs** ファイルに記述されている **UpdateDeviceFromSimulatedDeviceInfoPacketAsync** メソッドと **UpdateDeviceFromRealDeviceInfoPacketAsync** メソッドです。リモート監視の事前構成済みソリューションにおけるデバイス レジストリ API は、**DeviceManagement/Web/WebApiControllers/DeviceApiController.cs** ファイルで確認できます。

### フィールド ゲートウェイ デバイス モデル

フィールド ゲートウェイは、インターネットに直接接続できないデバイスや、直接接続することが望ましくないデバイスの接続とプロトコル変換によく使用されます。開発しているデバイスがフィールド ゲートウェイである場合、そのデバイスは、Azure IoT Hub とのすべてのやりとりにおいて、フィールド ゲートウェイを通じて接続するデバイスを表します。デバイスのプロトコルと IoT サービスでサポートされるプロトコル間の変換は、フィールド ゲートウェイの製造元である貴社が実装することになります。フィールド ゲートウェイで Bluetooth Low Energy (BLE) デバイスの接続に対応するには、デバイスへの BLE インターフェイスと Azure IoT Hub へのインターフェイスを実装する必要があります。

## デバイス アクセス管理

デバイス プロパティに対する読み取り/書き込みアクセス権やデバイス コマンドの実行権限など、デバイスのさまざまな側面に対するアクセスは、IoT Suite の事前構成済みソリューションによって制御されます。事前構成済みソリューションでは、このアクセスが、デバイス管理ポータルから Azure Active Directory (AAD) を使用して制御されます。事前構成済みソリューションで AAD を応用し、ロールベースのアクセス セキュリティを有効にすることができます。

## リモート制御

Azure IoT Suite の事前構成済みソリューションのシナリオとして、リモート制御を詳しく取り上げることはしません。IoT ソリューションでリモート制御を取り入れるうえでの選択肢についてのみ簡単に取り上げます。

IT のシナリオでは、リモート ユーザーを支援したり、リモート サーバーの構成を遠隔から行ったりする目的でリモート制御が広く使われています。IoT のシナリオでは、デバイスが、特定のユーザーの使用下に置かれることはまずありません。必然的に遠隔からの構成や診断が、リモート制御の用途となります。次の 2 種類のモデルを使用して、リモート制御を実装できます。

* **直接接続** デバイスとの直接接続 (Linux での SSH、Windows でのリモート デスクトップ、リモート デバッグ ツールなど) によるリモート制御を行うには、対象デバイスとの接続を確立できる必要があります。オープンなインターネットにデバイスをさらすことにはセキュリティ面のリスクが伴うため、接続やトラフィックのルーティングを行えるように、リレー サービス (Azure [Service Bus Relay サービス][service-bus-relay]など) を使用することをお勧めします。リレー接続はデバイスからの送信接続であるため、デバイス上の開放 TCP ポートの攻撃対象領域を制限することができます。

* **デバイス コマンド** デバイスと Azure IoT Hub 間に確立された既存の接続と通信チャネルは、デバイス コマンドを介したリモート制御を行うことで活用できます。デバイス コマンド ベースのリモート制御を行うには、次の要件に従う必要があります。
  * デバイス上で動作するソフトウェアは、そのデバイスがデバイス コマンドに対応していることを IoT サービスに伝達する必要があります。これは通常、デバイス モデルの構成要素として定義されます。
  * デバイス上で動作するソフトウェアは、リモート制御コマンドを実装する必要があります。これらのデバイス コマンドは、(IoT サービスからデバイスへの) 要求と (デバイスから IoT サービスへの) 応答のパターンに従う必要があります。デバイス コマンドを実行すると、デバイスの状態に変化を与え、この新しい状態をデバイス レジストリに反映する必要があります。

デバイスがマスター ストアとしてデバイスの構成や状態を保存するとき、デバイス レジストリは結果整合性モデルを使用します。デバイスの状態に対する変更は、デバイス レジストリにプッシュする必要があります。IoT サービスからデバイスへの要求は、デバイス レジストリの状態を強制的に更新できるほか、デバイスがシステム状態の変化を認識したときに、自動的にサービスを更新することもできます。デバイス側からサービスを自動更新すると、大量のネットワーク トラフィックが生成され、デバイスのプロセッサ使用率と消費電力が上昇する可能性があります。

## リモート管理とリモート監視

ほとんどの IoT デバイスでは、運用ユーザー ロールと管理ユーザー ロールが区別されています。リモート管理とは、管理者がそのデバイスの状態を監視し、デバイスからビジネス プロセスやアプリケーション (CRM、ERP、メンテナンス システムなど) へのデータの流れを構成したり、デバイスの状態や構成をデバイス コマンドを使ってリモートから更新したりする方法です。

Azure IoT Suite の事前構成済みソリューションには、デバイス管理作業の出発点となる Azure Web サイトが用意されており、バーティカルな IoT ソリューションのシナリオに応じてサイトを拡張することができます。

デバイスの運用データ (通常は高速に移動) とデバイスのメタデータ (通常は低速に移動) を確認して、管理者はデバイスが正常であるかを判断できます。ポーリング方式とは対照的に、ストリーム処理エンジン ([Azure Stream Analytics](https://azure.microsoft.com/services/stream-analytics/) など) を使って実装されるルールを使用して、デバイスの正常性警告システムを有効にすることができます。

## リモート構成

デバイスの構成をリモートから変更することは、プロビジョニング、診断、ビジネス プロセスとの統合など、デバイスのライフ サイクルのさまざまな局面で重要です。リモートからの構成変更は、デバイス モデルと IoT サービスの機能を組み合わせ、デバイス モデルのインスタンスの状態をリモートから更新することで可能となります。

リモート監視の事前構成済みソリューションでは、以下のコマンドを使ったリモート構成に対応しているということをデバイスが示します。

* ChangeKey
* ChangeConfig
* ChangeSystemProperties

これらのデバイス コマンドは、特定の状況でポータルからリモートで実行されるため、事前定義済みソリューションのデバイス管理ポータルに、利用可能なデバイス コマンドとして表示されることはありません。デバイスがデバイス コマンドを受信すると、デバイスはサービスに受信確認応答を送信します。デバイス コマンドを処理した後、デバイスは、デバイス コマンドの実行に成功したかどうかの情報をサービスに結果応答として送信します (コマンドの実行に失敗した場合は、エラー コードも含まれます)。デバイスに対して要求された状態はこの時点で確定し、デバイス レジストリが更新されます。

## ファームウェアとソフトウェアのリモート更新

ファームウェアとソフトウェアのリモート更新は、IoT システムの重要な機能です。更新により、デバイスは最新かつ最も安全なソフトウェアを実行できるようになります。デバイス上のファームウェアとソフトウェアをリモートで更新する作業は、通常その他のビジネス プロセスの操作を含む、長時間実行される分散処理の一種です。たとえば、高性能燃料ポンプを制御するデバイスのファームウェアを更新するためには、更新処理の実行と検証が行われている間、燃料の供給経路を変更する措置が他のシステムに必要となります。

### ファームウェア更新の分析

以下の例は、ビジネス ニーズに合ったファームウェア更新機能を実装する場合に考えられる 1 つの方法です。この例の目的は、更新処理の考慮事項を大まかに説明することであって、特定の実装を強要することではありません。更新要件を設計して、業務上や技術上のさまざまな要因を考慮する方法は、この記事で取り上げる範囲を超えています。

デバイスの更新処理は IoT サービス側から開始され、デバイスへの通知は、デバイス コマンドによって特定の時刻に行われます。ファームウェアやソフトウェアのリモート更新をデバイスが明示的にサポートしているときは、決められたビジネス プロセスとポリシーに従って、IoT サービスが更新コマンドを配信する必要があります。更新するデバイス コマンドを受け取ると、デバイスでは次を行う必要があります。

1. 更新プログラム パッケージをダウンロードしてデプロイします。
2. (ファームウェアの更新プログラムの場合) 新しくデプロイされた構成で再起動するか、新しいソフトウェア パッケージを起動します。
3. 新しいファームウェアまたはソフトウェアが、期待どおりに実行していることを確認します。

この複数のステップから成るプロセスの過程で、随時、デバイスはその状態を IoT サービスに通知する必要があります。

ストレージ サービス (Azure Storage など) やコンテンツ配信ネットワーク (CDN) は、更新パッケージを配信できます。ファームウェアまたはソフトウェアの更新プログラムを適用する前に、ダウンロードしたパッケージの整合性を検証し、パッケージが適切な配信元から提供されたことを確認することが大切です。

ファームウェア更新の完了後、デバイスは正常な状態を検証によって把握できることが必要となります。デバイスが正常な状態に移行しなかった場合、デバイス上のソフトウェアは既知の正常な状態にロールバックする処理を開始する必要があります。既知の正常な状態とは、たとえば、最後に確認されている正常な状態や、ストレージ パーティションに "*ひな形*" として保存されているデバイスのファームウェア イメージです。

## 次のステップ

Azure IoT Hub の詳細については、次のリンクを参照してください。

* [IoT Hub の概要][]
* [What is Azure IoT Hub? (Azure IoT Hub とは)][]
* [デバイスの接続][]

[IoT Hub の概要]: iot-hub-csharp-csharp-getstarted.md
[What is Azure IoT Hub? (Azure IoT Hub とは)]: iot-hub-what-is-iot-hub.md
[service-bus-relay]: ../service-bus/service-bus-relay-overview.md
[デバイスの接続]: https://azure.microsoft.com/develop/iot/
[lnk-azure-iot-solution]: https://github.com/Azure/azure-iot-solution
[lnk-iot-suite]: https://azure.microsoft.com/documentation/suites/iot-suite/
[lnk-remote-monitoring]: ../iot-suite/iot-suite-remote-monitoring-sample-walkthrough.md

<!---HONumber=AcomDC_0211_2016-->