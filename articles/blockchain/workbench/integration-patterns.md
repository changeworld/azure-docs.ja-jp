---
title: スマート コントラクトの統合パターン - Azure Blockchain Workbench
description: Azure Blockchain Workbench Preview のスマート コントラクトの統合パターンについて概要を説明します。
ms.date: 11/20/2019
ms.topic: conceptual
ms.reviewer: mmercuri
ms.openlocfilehash: f9626edd5bd655e3de5d0f9648041faf832e3b84
ms.sourcegitcommit: b77e97709663c0c9f84d95c1f0578fcfcb3b2a6c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/22/2019
ms.locfileid: "74325963"
---
# <a name="smart-contract-integration-patterns"></a>スマート コントラクトの統合パターン

多くの場合、スマート コントラクトは、外部のシステムやデバイスと統合する必要があるビジネスワーク フローを表します。

このようなワークフローの要件として、外部システム、サービス、またはデバイスからのデータを含む分散型台帳に対してトランザクションを開始する必要があります。 また、分散型台帳上のスマート コントラクトから発生するイベントに外部システムを対応させる必要があります。

REST API とメッセージングの統合によって、Azure Blockchain Workbench アプリケーションに含まれるスマート コントラクトに外部システムからトランザクションが送信されます。 また、アプリケーション内で行われる変更に基づいて外部システムにイベント通知が送信されます。

データ統合シナリオの場合、Azure Blockchain Workbench には、アプリケーションおよびスマート コントラクトに関するブロックチェーンのトランザクション データとメタデータの組み合わせをマージする一連の DB ビューが含まれています。

さらに、サプライ チェーンやメディアに関連するシナリオの中には、ドキュメントの統合が必要なものもあります。 Azure Blockchain Workbench には、ドキュメントを直接処理するための API 呼び出しが用意されていませんが、ドキュメントをブロックチェーン アプリケーションに組み込むことができます。 このセクションでは、そのパターンについても説明します。

このセクションでは、エンド ツー エンドのソリューションにこのような種類の統合を実装するために特定されているパターンについて説明します。

## <a name="rest-api-based-integration"></a>REST API ベースの統合

Azure Blockchain Workbench で生成される Web アプリケーションの機能は、REST API を介して公開されています。 機能には、Azure Blockchain Workbench のアップロード、アプリケーションの構成と管理、トランザクションの分散型台帳への送信、アプリケーションのメタデータと台帳データのクエリなどが含まれます。

REST API は、主に Web、モバイル、およびボット アプリケーションなどの対話型クライアントに使用されます。

このセクションでは、分散型台帳にトランザクションを送信する REST API と、トランザクションに関するデータを Azure Blockchain Workbench の*オフ チェーン* SQL データベースに問い合わせる方法について説明します。

### <a name="sending-transactions-to-a-distributed-ledger-from-an-external-system"></a>外部システムから分散型台帳へのトランザクションの送信

Azure Blockchain Workbench REST API によって、分散型台帳に対してトランザクションを実行するための認証済み要求が送信されます。

![分散型台帳へのトランザクションの送信](./media/integration-patterns/send-transactions-ledger.png)

前述のプロセスを利用し、トランザクションが実行されます。

-   外部アプリケーションは、Azure Blockchain Workbench の展開の一部としてプロビジョニングされた Azure Active Directory に対して認証を受けます。
-   承認されたユーザーは、API に要求と共に送信できるベアラー トークンを受け取ります。
-   外部アプリケーションは、ベアラー トークンを使用して REST API を呼び出します。
-   REST API はメッセージとして要求をパッケージ化し、Service Bus に送信します。 ここから取得され、署名され、分散型台帳に送信されます。
-   REST API は Azure Blockchain Workbench SQL DB に対する要求を作成し、その要求を記録し、現在のプロビジョニング状態を確立します。
-   SQL DB はプロビジョニング状態を返し、API は呼び出し元の外部アプリケーションにその ID を返します。

### <a name="querying-blockchain-workbench-metadata-and-distributed-ledger-transactions"></a>Blockchain Workbench メタデータと分散型台帳トランザクションのクエリ

Azure Blockchain Workbench REST API によって、分散型台帳に対するスマート コントラクトの実行に関連する詳細のクエリを実行するために、認証された要求が送信されます。

![メタデータのクエリ](./media/integration-patterns/querying-metadata.png)

前述のプロセスを利用し、クエリが実行されます。

1. 外部アプリケーションは、Azure Blockchain Workbench の展開の一部としてプロビジョニングされた Azure Active Directory に対して認証を受けます。
2. 承認されたユーザーは、API に要求と共に送信できるベアラー トークンを受け取ります。
3. 外部アプリケーションは、ベアラー トークンを使用して REST API を呼び出します。
4. REST API は、SQL DB からの要求に対してデータのクエリを実行し、それをクライアントに返します。

## <a name="messaging-integration"></a>メッセージングの統合

メッセージングの統合を利用すると、対話型サインインを使用できない、または望ましくないシステム、サービス、デバイスとのやりとりが簡単になります。 メッセージングの統合は、分散型台帳に対してトランザクションを実行するように要求するメッセージと、トランザクションが発生したときにその台帳によって公開されるイベントという 2 種類のメッセージに重点を置いています。

メッセージングの統合は、ユーザーの作成、コントラクトの作成、コントラクトに対するトランザクションの実行に関連するトランザクションの実行と監視に重点を置いており、主に*ヘッドレス* バックエンド システムで使用されています。

このセクションでは、分散型台帳にトランザクションを送信するメッセージベースの API と、基礎となる分散型台帳によって公開されるイベント メッセージについて説明します。

### <a name="one-way-event-delivery-from-a-smart-contract-to-an-event-consumer"></a>スマート コントラクトからイベント コンシューマーへの一方向のイベント配信 

このシナリオでは、状態の変更や特定の種類のトランザクションの実行などのイベントがスマート コントラクト内で発生します。 このイベントは、Event Grid 経由でダウンストリームのコンシューマーにブロードキャストされ、コンシューマーはそれに応じて適切なアクションを実行します。

このシナリオの例としては、トランザクションが発生したときに、コンシューマーがアラートを受け取り、SQL DB または Common Data Service に情報を記録するなどのアクションを実行する場合などがあります。 このシナリオは Workbench が*オフチェーン* SQL DB を設定する場合と同じパターンです。

たとえば、コントラクトが *OutOfCompliance* に遷移した場合など、スマート コントラクトが特定の状態に遷移する場合があります。 このような状態の変化が起こると、管理者の携帯電話にアラートが送信されるトリガーとなる可能性があります。

![一方向のイベント配信](./media/integration-patterns/one-way-event-delivery.png)

前述のプロセスを利用し、このシナリオが発生します。

-   スマート コントラクトは新しい状態に遷移し、台帳にイベントを送信します。
-   台帳はイベントを受け取って Azure Blockchain Workbench に配信します。
-   Azure Blockchain Workbench は、台帳からのイベントにサブスクライブされ、イベントを受け取ります。
-   Azure Blockchain Workbench はイベントを Event Grid 上のサブスクライバーに発行します。
-   外部システムは Event Grid にサブスクライブされ、メッセージを利用して適切なアクションを実行します。

## <a name="one-way-event-delivery-of-a-message-from-an-external-system-to-a-smart-contract"></a>外部システムからスマート コントラクトへのメッセージの一方向イベント配信

反対方向から流れるシナリオもあります。 この場合、イベントはセンサーまたは外部システムによって生成され、そのイベントからのデータはスマート コントラクトに送信されます。

一般的な例として、商品、株式、債券の価格など、金融市場からスマート コントラクトへのデータ配信があります。

### <a name="direct-delivery-of-an-azure-blockchain-workbench-in-the-expected-format"></a>Azure Blockchain Workbench の直接配信で想定される形式

一部のアプリケーションは、Azure Blockchain Workbench と統合し、想定されている形式で直接メッセージを生成して送信するように構築されています。

![直接配信](./media/integration-patterns/direct-delivery.png)

前述のプロセスを利用し、この配信が行われます。

-   Azure Blockchain Workbench のメッセージ作成をトリガーするイベントが外部システムで発生します。
-   外部システムには、このメッセージを既知の形式で作成するためのコードが記述されており、それが直接 Service Bus に送信されます。
-   Azure Blockchain Workbench は、Service Bus からのイベントにサブスクライブされ、メッセージを取得します。
-   Azure Blockchain Workbench は、台帳への呼び出しを開始し、外部システムから特定のコントラクトにデータを送信します。
-   メッセージを受信すると、コントラクトは新しい状態に遷移します。

### <a name="delivery-of-a-message-in-a-format-unknown-to-azure-blockchain-workbench"></a>Azure Blockchain Workbench への未知の形式でのメッセージ配信

一部のシステムでは、Azure Blockchain Workbench で使用される標準の形式でメッセージを配信するように変更することができません。 多くの場合は、このようなシステムから既存のメカニズムやメッセージ形式を使用できます。 具体的には、Logic Apps、Azure Functions、または他のカスタム コードを使用して、このようなシステムのネイティブ メッセージの種類を変換し、標準のメッセージング形式のいずれかにマップすることができます。

![不明なメッセージ形式](./media/integration-patterns/unknown-message-format.png)

前述のプロセスを利用し、これが行われます。

-   メッセージの作成をトリガーするイベントが外部システムで発生します。
-   Logic App またはカスタムコードを使用して、そのメッセージを受信し、標準の Azure Blockchain Workbench 形式のメッセージに変換します。
-   Logic App は変換されたメッセージを直接 Service Bus に送信します。
-   Azure Blockchain Workbench は、Service Bus からのイベントにサブスクライブされ、メッセージを取得します。
-   Azure Blockchain Workbench は、台帳への呼び出しを開始し、外部システムからコントラクト上の特定の機能にデータを送信します。
-   機能が実行され、通常は状態が変更されます。 状態の変化によって、スマート コントラクトに反映されたビジネス ワークフローが先に進み、他の機能を適切に実行できるようになります。

### <a name="transitioning-control-to-an-external-process-and-await-completion"></a>制御を外部プロセスに遷移して完了を待機する

スマート コントラクトが内部の実行を停止し、外部プロセスに引き渡す必要があるシナリオがあります。 その外部プロセスが完了すると、スマート コントラクトにメッセージを送信し、スマート コントラクト内で実行が継続されます。

#### <a name="transition-to-the-external-process"></a>外部プロセスへの遷移

このパターンは、通常、次の方法を使用して実装されます。

-   スマート コントラクトが特定の状態に遷移します。 この状態では、外部システムが所定のアクションを実行するまで機能を実行できないか、実行できる機能の数が制限されます。
-   状態の変化は、ダウンストリームのコンシューマーにイベントとして表れます。
-   ダウンストリームのコンシューマーはイベントを受け取り、外部コードの実行をトリガーします。

![外部プロセスへの遷移の制御](./media/integration-patterns/transition-external-process.png)

#### <a name="return-of-control-from-the-smart-contract"></a>スマート コントラクトからの制御の復帰

外部システムをカスタマイズする機能によっては、Azure Blockchain Workbench で想定されている標準形式のいずれかでメッセージを配信できない場合があります。 このようなメッセージの 1 つを生成する外部システムの機能に基づいて、次の 2 つの復帰パスのどちらが実行されるかが決まります。

##### <a name="direct-delivery-of-an-azure-blockchain-workbench-in-the-expected-format"></a>Azure Blockchain Workbench の直接配信で想定される形式

![](./media/integration-patterns/direct-delivery.png)

このモデルでは、上記のプロセスに続いて、コントラクトへの通信とその後の状態変更が発生します。

-   外部コードの実行が完了するか特定のマイルストーンに達すると、Azure Blockchain Workbench に接続された Service Bus にイベントが送信されます。

-   API の想定に準拠したメッセージを直接作成できないシステムでは、メッセージが変換されます。

-   メッセージの内容はパッケージ化され、スマート コントラクトの特定の機能に送信されます。 この配信は、外部システムに関連付けられたユーザーに代わって実行されます。

-   機能が実行され、通常は状態が変更されます。 状態の変化によって、スマート コントラクトに反映されたビジネス ワークフローが先に進み、他の機能を適切に実行できるようになります。

### 

### <a name="delivery-of-a-message-in-a-format-unknown-to-azure-blockchain-workbench"></a>Azure Blockchain Workbench への未知の形式でのメッセージ配信

![不明なメッセージ形式](./media/integration-patterns/unknown-message-format.png)

このモデルでは標準形式のメッセージを直接送信できないため、コントラクトへの通信とその後の状態変更は、前述のプロセスの後に行われます。

1.  外部コードの実行が完了するか特定のマイルストーンに達すると、Azure Blockchain Workbench に接続された Service Bus にイベントが送信されます。
2.  Logic App またはカスタムコードを使用して、そのメッセージを受信し、標準の Azure Blockchain Workbench 形式のメッセージに変換します。
3.  Logic App は変換されたメッセージを直接 Service Bus に送信します。
4.  Azure Blockchain Workbench は、Service Bus からのイベントにサブスクライブされ、メッセージを取得します。
5.  Azure Blockchain Workbench は、台帳への呼び出しを開始し、外部システムから特定のコントラクトにデータを送信します。
6. メッセージの内容はパッケージ化され、スマート コントラクトの特定の機能に送信されます。 この配信は、外部システムに関連付けられたユーザーに代わって実行されます。
7.  機能が実行され、通常は状態が変更されます。 状態の変化によって、スマート コントラクトに反映されたビジネス ワークフローが先に進み、他の機能を適切に実行できるようになります。

## <a name="iot-integration"></a>IoT の統合

一般的な統合シナリオは、スマート コントラクトのセンサーから取得された利用統計情報を含めることです。 スマート コントラクトは、センサーから提供されるデータに従い、その情報に基づいたアクションを実行し、コントラクトの状態を変更する可能性があります。

たとえば、薬品を運ぶトラックの温度が 110 度に上昇した場合、薬品の有効性に影響が出る可能性があります。また、それを検出してサプライ チェーンから排除しなければ公共の安全上の問題が生じる可能性があります。 運転者が車を時速 100 マイルに加速した場合、生成されるセンサー情報によって保険会社が保険を解約する可能性があります。 車がレンタカーだった場合、GPS データで運転手がレンタル契約の対象地域外に移動したことがわかると、罰金を請求される可能性があります。

このようなセンサーが一定の基準でデータを配信できるようにすることが課題であり、すべてのデータをスマート コントラクトに送信することは適切ではありません。 一般的な方法は、すべてのメッセージをセカンダリ ストアに配信しながら、ブロックチェーンに送信するメッセージの数を制限することです。 たとえば、スマート コントラクトについて合意された範囲から外れる値を含む場合、1 時間に 1 回などの一定間隔でのみ、受信したメッセージを配信します。 許容範囲から外れる値を確認することで、コントラクトのビジネス ロジックに関連するデータが確実に受信され、実行されます。 この間隔で値を確認すると、センサーで報告処理が実行されていることを確認できます。 すべてのデータをセカンダリ レポート ストアに送信して、より広範なレポート、分析、および機械学習に利用できます。 たとえば、スマート コントラクトのために GPS のセンサー読み取り値を毎分取得する必要はないかもしれませんが、レポートやマップ ルートで使用できる興味深いデータが提供される可能性があります。

Azure プラットフォームでは、通常、デバイスとの統合は IoT Hub で行われます。 IoT Hub ではコンテンツに基づいてメッセージがルーティングされ、前述のような種類の機能を実現できます。

![IoT メッセージ](./media/integration-patterns/iot.png)

このプロセスでは 1 つのパターンが表現されます。

-   デバイスは IoT Hub と直接通信するかフィールド ゲートウェイ経由で通信します。
-   IoT Hub はメッセージを受信し、確立されたルートに対してメッセージを評価して、メッセージの内容を確認します。たとえば、 *センサーから 50 度を超える温度が報告されているか*を確認します。
-   IoT Hub は、その条件に一致するメッセージを、ルートに定義された Service Bus に送信します。
-   Logic App または他のコードは、IoT Hub がルートに対して確立した Service Bus をリッスンします。
-   Logic App または他のコードは、メッセージを取得して既知の形式に変換します。
-   標準形式に変換されたメッセージは、Azure Blockchain Workbench の Service Bus に送信されます。
-   Azure Blockchain Workbench は、Service Bus からのイベントにサブスクライブされ、メッセージを取得します。
-   Azure Blockchain Workbench は、台帳への呼び出しを開始し、外部システムから特定のコントラクトにデータを送信します。
-   コントラクトはメッセージを受信するとデータを評価します。また、その評価結果に基づいて状態を変更する可能性があります。たとえば、高温の場合は状態を*コンプライアンス違反*に変更します。

## <a name="data-integration"></a>データ統合

Azure Blockchain Workbench には、REST とメッセージ ベースの API に加えて、アプリケーションとコントラクトのメタデータと分散型台帳のトランザクション データを格納した SQL DB にアクセスする機能があります。

![データ統合](./media/integration-patterns/data-integration.png)

データ統合の特徴は次のとおりです。

-   Azure Blockchain Workbench は、アプリケーション、ワークフロー、コントラクト、およびトランザクションに関するメタデータを、通常の操作の一部として格納します。
-   外部システムまたはツールには、データベース サーバー名、データベース名、認証の種類、ログインの資格情報、使用するデータベースのビューなど、データベースに関する情報の収集を容易にする 1 つ以上のダイアログが用意されています。
-   外部システム、サービス、レポート、開発者ツール、エンタープライズ生産性ツールによるダウンストリームの利用を容易にするために、SQL データベース ビューに対してクエリが作成されます。

## <a name="storage-integration"></a>ストレージの統合

多くのシナリオでは、証明可能なファイルを組み込む必要があります。 複数の理由から、ファイルをブロックチェーンに配置することは適切ではありません。 その代替となる一般的な方法は、ファイルに対して暗号化ハッシュ (SHA-256 など) を実行し、分散型台帳上でそのハッシュを共有することです。 以降、ハッシュを実行すると、常に同じ結果が返されます。 ファイルが変更された場合、画像の 1 ピクセルのみが変更された場合でも、ハッシュは異なる値を返します。

![ストレージの統合](./media/integration-patterns/storage-integration.png)

このパターンは次の場合に実装できます。

-   外部システムが Azure Storage などのストレージ メカニズムにファイルを保持している。
-   ファイル、またはファイルとそれに関連するメタデータ (所有者の識別子、ファイルが配置されている URL など) を使用してハッシュが生成されている。
-   スマート コントラクト上で、ハッシュと任意のメタデータが *FileAdded* などの関数に送信される。
-   将来的に、ファイルとメタデータが再度ハッシュされ、台帳に格納されている値と比較される可能性がある。

## <a name="prerequisites-for-implementing-integration-patterns-using-the-rest-and-message-apis"></a>REST およびメッセージ API を使用して統合パターンを実装するための前提条件

外部システムまたはデバイスが REST API またはメッセージ API のいずれかを使用してスマート コントラクトと対話する機能を容易にするには、以下の手順を実行する必要があります。

1. コンソーシアム用の Azure Active Directory で、外部システムまたはデバイスを表すアカウントを作成します。
2. Azure Blockchain Workbench アプリケーションの 1 つまたは複数の適切なスマート コントラクトに、外部システムまたはデバイスからのイベントを受け入れる関数を定義します。
3. スマート コントラクトのアプリケーション構成ファイルに、システムまたはデバイスに割り当てるロールを含めます。
4. スマート コントラクトのアプリケーション構成ファイルに、定義されたロールからこの関数を呼び出される状態を指定します。
5. アプリケーション構成ファイルとスマート コントラクトを、Azure Blockchain Workbench にアップロードします。

アプリケーションがアップロードされると、外部システムの Azure Active Directory アカウントがコントラクトと関連するロールに割り当てられます。

## <a name="testing-external-system-integration-flows-prior-to-writing-integration-code"></a>統合コードを作成する前の外部システム統合フローのテスト 

外部システムとの統合は、多くのシナリオで重要な要件となります。 外部システムと統合するコードの開発より前に、または並行して、スマート コントラクトの設計を検証できるようにすることをお勧めします。

Azure Active Directory (Azure AD) を使用すると、開発者の生産性と大幅に高め、完成までの時間を短縮することができます。 つまり、外部システムとのコード統合にかかる時間はわずかです。 Azure AD と Azure Blockchain Workbench による UX の自動生成を使用することで、開発者は外部システムとして Blockchain Workbench にサインインし、外部システムから値を UX 経由で設定することができます。 外部システムの統合コードを記述する前に、概念実証環境で、短期間でアイデアを引き出し、有効性を検証できます。
