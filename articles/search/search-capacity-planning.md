---
title: クエリとインデックス作成のためのパーティションとレプリカを割り当てる - Azure Search
description: Azure Search のパーティションとレプリカのコンピューティング リソースを調整します。各リソースは課金対象の検索単位で価格設定されます。
author: HeidiSteen
manager: cgronlun
services: search
ms.service: search
ms.topic: conceptual
ms.date: 11/09/2017
ms.author: heidist
ms.custom: seodec2018
ms.openlocfilehash: e2eff6c854dae48961700341a6db19dc7113901c
ms.sourcegitcommit: eb9dd01614b8e95ebc06139c72fa563b25dc6d13
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/12/2018
ms.locfileid: "53316116"
---
# <a name="allocate-partitions-and-replicas-for-query-and-indexing-workloads-in-azure-search"></a>Azure Search でクエリとインデックス作成のワークロードに応じてパーティションとレプリカを割り当てる
[価格レベルを選択](search-sku-tier.md)して [Search サービスをプロビジョニング](search-create-service-portal.md)したら、サービスで使用するレプリカまたはパーティションの数を必要に応じて増やします。 各レベルには固定された請求単位数が用意されています。 この記事では、こうした請求単位を、クエリの実行、インデックス作成、およびストレージの要件のバランスを考慮しながら割り当てて、最適な構成を実現する方法について説明します。

[Basic レベル](https://aka.ms/azuresearchbasic)または [Standard レベル](search-limits-quotas-capacity.md)のいずれかでサービスを設定すると、リソース構成を使用できます。 このレベルのサービスでは、容量は "*検索単位*" (SU) ごとに購入します。各パーティションとレプリカは 1 SU としてカウントします。 

使用する SU が少なければ、課金される金額もそれに応じて少なくなります。 課金は、サービスが設定されている間、有効になっています。 サービスを一時的に使用しない場合、課金を回避する唯一の方法は、サービスを削除し、必要なときに再作成することです。

> [!Note]
> サービスを削除すると、すべての機能が削除されます。 保持されている検索データをバックアップおよび復元するための機能は Azure Search 内にありません。 新しいサービスに既存のインデックスを再デプロイするには、元々その作成と読み込みに使用したプログラムを実行する必要があります。 

## <a name="terminology-partitions-and-replicas"></a>用語: パーティションとレプリカ
パーティションとレプリカは、Search サービスを支える主要なリソースです。

| リソース | 定義 |
|----------|------------|
|*パーティション* | 読み取り/書き込み操作 (たとえば、インデックスを再構築または更新する場合など) のためにインデックスのストレージと I/O を提供します。|
|"*レプリカ*" | 主にクエリ操作の負荷分散に使用される Search サービスのインスタンスです。 各レプリカが常にインデックスの 1 つのコピーをホストします。 12 個のレプリカがある場合は、サービスに各インデックスのコピーが 12 個ずつ読み込まれます。|

> [!NOTE]
> レプリカでどのインデックスが実行されるかを直接操作または管理する方法はありません。 すべてのレプリカにある各インデックスの 1 つずつのコピーが、サービスのアーキテクチャを構成します。
>

## <a name="how-to-allocate-partitions-and-replicas"></a>パーティションとレプリカの割り当て方法
Azure Search では最初に、1 つのパーティションと 1 つのレプリカで構成される最小限のリソースがサービスに割り当てられます。 該当するレベルでサポートされている場合は、コンピューティング リソースを段階的に調整できます。より多くのストレージや I/O が必要な場合には、パーティションを増やします。また、より多くのクエリを実行したり、パフォーマンスを向上させたりするには、レプリカをさらに増やします。 1 つのサービスに、すべてのワークロード (インデックスおよびクエリ) を処理するための十分なリソースが必要です。 複数のサービス間でワークロードを分割することはできません。

レプリカやパーティションの割り当てを増やしたり変更したりする場合は、Azure Portal の使用をお勧めします。 ポータルによって、上限に達しないようにするための利用可能な組み合わせに対して制限が適用されます。

1. [Azure Portal](https://portal.azure.com/) にサインインし、Search サービスを選択します。
2. **[設定]** で **[スケール]** ブレードを開き、スライダーを使用して、パーティションとレプリカの数を増減します。

スクリプト ベースまたはコード ベースでプロビジョニングする必要がある場合は、ポータルの代わりに[管理 REST API](https://docs.microsoft.com/rest/api/searchmanagement/services) を使用できます。

一般的に、検索アプリケーションでは、パーティションよりもレプリカの方が多く必要となります。特に、サービス操作でクエリ ワークロードの比重が高い場合は、その傾向が強まります。 その理由については、[高可用性](#HA)に関するセクションで説明します。

> [!NOTE]
> サービスをプロビジョニングした後は、上位の SKU にアップグレードすることはできません。 新しいレベルで Search Service を作成し、インデックスを再度読み込む必要があります。 サービス プロビジョニングについては、「 [ポータルでの Azure Search サービスの作成](search-create-service-portal.md) 」を参照してください。
>
>

<a id="HA"></a>

## <a name="high-availability"></a>高可用性
通常、簡単かつ比較的速くスケールアップできるため、1 つのパーティションと 1 ～ 2 つのレプリカで開始し、クエリ数の増加に合わせてスケールアップすることをお勧めします。 クエリのワークロードは主にレプリカ上で実行されます。 より高いスループットまたは高可用性のためには、レプリカの追加が必要となります。

高可用性のための一般的な推奨事項は次のとおりです。

* 読み取り専用ワークロード (クエリ) の高可用性を実現するには 2 つのレプリカ
* 読み取り/書き込みワークロード (クエリに加え、個々のドキュメントを追加、更新、または削除するときのインデックス作成) の高可用性を実現するには 3 つ以上のレプリカ

Azure Search のサービス レベル アグリーメント (SLA) は、クエリ操作と、ドキュメントの追加、更新、削除から成るインデックスの更新とを対象としています。

Basic レベルでは、1 つのパーティションと 3 つのレプリカが上限です。 インデックス作成とクエリのスループットに対する需要の変動にすばやく反応する柔軟性が必要な場合は、Standard レベルのいずれかを検討してください。

### <a name="index-availability-during-a-rebuild"></a>再構築中のインデックスの可用性

Azure Search の高可用性は、クエリのほか、インデックスの再構築を伴わないインデックスの更新に関連しています。 フィールドの削除、データ型の変更、フィールドの名前の変更を行う場合は、インデックスの再構築が必要になります。 インデックスを再構築するには、いったんインデックスを削除した後、インデックスを再作成し、データを再読み込みする必要があります。

> [!NOTE]
> Azure Search インデックスへの新しいフィールドの追加は、インデックスを再構築せずに行うことができます。 既にインデックス内にあるすべてのドキュメントについては、新しいフィールドの値は null になります。

再構築中にインデックスの可用性を維持するには、同じサービスに対してインデックスのコピーを別の名前で用意するか、別のサービスに対してインデックスのコピーを同じ名前で用意したうえで、コードにリダイレクトまたはフェールオーバーのロジックを記述する必要があります。

## <a name="disaster-recovery"></a>障害復旧
現時点では、障害復旧のための組み込みのメカニズムはありません。 追加のパーティションまたはレプリカは、ディザスター リカバリーの目標を達成する手段として適切ではありません。 最も一般的なアプローチでは、別のリージョンにもう 1 つの検索サービスを設定することで、そのサービス レベルに冗長性を追加します。 インデックスの再構築中の可用性の場合と同様に、リダイレクトまたはフェールオーバーのロジックをコードに用意する必要があります。

## <a name="increase-query-performance-with-replicas"></a>レプリカでクエリ パフォーマンスを向上させる
クエリの遅延は、追加のレプリカが必要かどうかの指標となります。 通常、クエリ パフォーマンスを向上させるには、まずこのリソースを追加します。 レプリカを追加すると、インデックスの追加のコピーがオンラインになって、より多くのクエリ ワークロードに対応し、複数のレプリカ全体の要求を負荷分散できるようになります。

クエリ パフォーマンスは、クエリの複雑さや競合するワークロードに左右されるため、1 秒あたりのクエリ数 (QPS) を正確に提示できません。 レプリカを追加するとパフォーマンスが向上しますが、厳密に線形に向上するわけではありません。3 つのレプリカを追加しても、スループットが 3 倍になるとは限りません。

ワークロードの QPS を見積もる際のガイダンスについては、「[Azure Search のパフォーマンスと最適化に関する考慮事項](search-performance-optimization.md)」を参照してください。

## <a name="increase-indexing-performance-with-partitions"></a>パーティションでインデックス作成のパフォーマンスを向上させる
ほぼリアルタイムのデータ更新を要求する検索アプリケーションでは、レプリカよりも多くのパーティションが比例して必要になります。 パーティションを追加すると、読み取り/書き込み操作がより多くのコンピューティング リソースに分散されます。 また、追加のインデックスとドキュメントを格納するためのディスク領域も増加します。

インデックスが大きくなると、クエリの実行に時間がかかります。 そのため、パーティションで段階的な増加が発生するたびに、レプリカでは小規模であるが比例的な増加が必要となる場合があります。 クエリの複雑さとボリュームは、クエリの実行が完了するまでの速度の要因となります。

## <a name="basic-tier-partition-and-replica-combinations"></a>Basic レベル:パーティションとレプリカの組み合わせ
Basic サービスは、3 SU の上限に対して厳密に 1 個のパーティションと最大 3 個のレプリカを持つことができます。 調整可能なリソースはレプリカだけです。 クエリの高可用性のためには、少なくとも 2 個のレプリカが必要です。

<a id="chart"></a>

## <a name="standard-tiers-partition-and-replica-combinations"></a>Standard レベル:パーティションとレプリカの組み合わせ
次の表は、すべての Standard レベルについて、36 SU の制限のもとで、レプリカとパーティションの組み合わせをサポートするために必要な SU を示しています。

|   | **1 個のパーティション** | **2 個のパーティション** | **3 個のパーティション** | **4 個のパーティション** | **6 個のパーティション** | **12 個のパーティション** |
| --- | --- | --- | --- | --- | --- | --- |
| **1 つのレプリカ** |1 SU |2 SU |3 SU |4 SU |6 SU |12 SU |
| **2 つのレプリカ** |2 SU |4 SU |6 SU |8 SU |12 SU |24 SU |
| **3 つのレプリカ** |3 SU |6 SU |9 SU |12 SU |18 SU |36 SU |
| **4 つのレプリカ** |4 SU |8 SU |12 SU |16 SU |24 SU |該当なし |
| **5 つのレプリカ** |5 SU |10 SU |15 SU |20 SU |30 SU |該当なし |
| **6 つのレプリカ** |6 SU |12 SU |18 SU |24 SU |36 SU |該当なし |
| **12 レプリカ** |12 SU |24 SU |36 SU |該当なし |該当なし |該当なし |

SU、価格、および容量の詳細については、Azure Web サイトをご覧ください。 詳細については、「[料金の詳細](https://azure.microsoft.com/pricing/details/search/)」をご覧ください。

> [!NOTE]
> レプリカとパーティションの数は、均等に 12 分割されます (具体的には、1、2、3、4、6、12)。 これは、Azure Search では各インデックスがすべてのパーティションに均等に分散されるように 12 のシャードに事前に分割されるためです。 たとえば、サービスに 3 つのパーティションがあり、インデックスを作成する場合、各パーティションにはインデックスの 4 つのシャードを含めます。 Azure Search でインデックスがどのようにシャードされるかは実装の問題であり、今後のリリースで変更される場合があります。 今日 12 個であっても、今後も必ず 12 個になるとは限りません。
>
>

## <a name="billing-formula-for-replica-and-partition-resources"></a>レプリカおよびパーティション リソース請求の計算式
特定の組み合わせに対して使用される SU 数は、レプリカ数とパーティション数の積になります (R x P = SU)。 たとえば、3 個のレプリカに 3 個のパーティションを掛けた値 = 9 SU として課金されます。

SU あたりのコストはレベルによって決まり、Basic レベルの課金単価は Standard レベルよりも低くなっています。 各レベルの価格は、「 [Search の価格](https://azure.microsoft.com/pricing/details/search/)」を参照してください。
