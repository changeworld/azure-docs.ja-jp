---
title: Azure Firewall ルール処理ロジック
description: Azure Firewall には、NAT ルール、ネットワーク ルール、およびアプリケーション ルールがあります。 これらのルールは、ルールの種類に応じて処理されます。
services: firewall
author: vhorne
ms.service: firewall
ms.topic: article
ms.date: 04/10/2020
ms.author: victorh
ms.openlocfilehash: 93677b3e473ab825665fed5590ac345a8cfcc300
ms.sourcegitcommit: fb23286d4769442631079c7ed5da1ed14afdd5fc
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/10/2020
ms.locfileid: "81113449"
---
# <a name="azure-firewall-rule-processing-logic"></a>Azure Firewall ルール処理ロジック
Azure Firewall では、NAT 規則、ネットワーク ルール、およびアプリケーション ルールを構成できます。 ルール コレクションはルールの種類と優先順位に基づいて処理されます。優先順位は 100 から 65,000 までであり、数字の低い順から高い順に処理されます。 ルール コレクションの名前に使用できるのは、文字、数字、アンダースコア、ピリオド、ハイフンのみです。 先頭は文字または数字、末尾は文字、数字、またはアンダースコアでなければなりません。 名前の最大長は 80 文字です。

ルール コレクションの優先順位数の間隔はまず、100 の増分にすることをお勧めします (100、200、300 など)。そうすることで、必要に応じてルール コレクションを追加する余地が与えられます。

> [!NOTE]
> 脅威インテリジェンスベースのフィルター処理を有効にした場合は、それらのルールの優先順位が最も高くなり、常に最初に処理されます。 構成したルールが処理される前に、脅威インテリジェンス フィルターによってトラフィックが拒否されることがあります。 詳細については、「[Azure Firewall の脅威インテリジェンスベースのフィルター処理](threat-intel.md)」を参照してください。

## <a name="outbound-connectivity"></a>送信接続

### <a name="network-rules-and-applications-rules"></a>ネットワーク ルールとアプリケーション ルール

ネットワーク ルールとアプリケーション ルールを構成すると、優先順位に従いネットワーク ルールがアプリケーション ルールよりも先に適用されます。 その後、これらのルールが終了します。 ネットワーク ルールで一致が見つかった場合は、他のルールは処理されません。  一致するネットワーク ルールが存在せず、プロトコルが HTTP、HTTPS、または MSSQL の場合は、優先順位に従いパケットはアプリケーション ルールによって評価されます。 一致が見つからない場合、パケットは[インフラストラクチャ ルール コレクション](infrastructure-fqdns.md)に照らして評価されます。 それでも一致するものがない場合、パケットは既定では拒否されます。

## <a name="inbound-connectivity"></a>受信接続

### <a name="nat-rules"></a>NAT 規則

インバウンド インターネット接続を有効にするには、宛先ネットワーク アドレス変換 (DNAT) を「[チュートリアル:Azure portal で Azure Firewall DNAT を使用して受信トラフィックをフィルター処理する](tutorial-firewall-dnat.md)」の説明に従って構成します。 NAT 規則は、ネットワーク ルールよりも優先的に適用されます。 一致が見つかると、変換されたトラフィックを許可する暗黙的な対応するネットワーク ルールが追加されます。 この動作は、変換されたトラフィックに一致する拒否ルールを使用してネットワーク ルール コレクションを明示的に追加することで、オーバーライドすることができます。

アプリケーション ルールは、受信接続には適用されません。 したがって、インバウンド HTTP/S トラフィックをフィルター処理する場合は、Web アプリケーション ファイアウォール (WAF) を使用する必要があります。 詳細については、「[Azure Web アプリケーション ファイアウォールとは](../web-application-firewall/overview.md)」を参照してください

## <a name="examples"></a>例

次の例は、これらのルールを組み合わせた結果を示しています。

### <a name="example-1"></a>例 1

ネットワーク ルールが一致しているため、google.com への接続は許可されます。

**ネットワーク ルール**

- アクション:Allow


|name  |Protocol  |送信元の種類  |source  |変換先の型  |宛先アドレス  |宛先ポート|
|---------|---------|---------|---------|----------|----------|--------|
|Allow-web     |TCP|IP アドレス|*|IP アドレス|*|80,443

**アプリケーション ルール**

- アクション:拒否

|name  |送信元の種類  |source  |プロトコル:ポート|ターゲットの FQDN|
|---------|---------|---------|---------|----------|----------|
|Deny-google     |IP アドレス|*|http: 80、https: 443|google.com

**結果**

パケットが *Allow-web* ネットワーク ルールと一致するため、google.com への接続は許可されます。 この時点で、ルールの処理が停止します。

### <a name="example-2"></a>例 2

優先順位の高い "*拒否*" ネットワーク ルール コレクションによってブロックされるため、SSH トラフィックは拒否されます。

**ネットワーク ルール コレクション 1**

- 名前:許可コレクション
- 優先順位:200
- アクション:Allow

|name  |Protocol  |送信元の種類  |source  |変換先の型  |宛先アドレス  |宛先ポート|
|---------|---------|---------|---------|----------|----------|--------|
|Allow-SSH     |TCP|IP アドレス|*|IP アドレス|*|22

**ネットワーク ルール コレクション 2**

- 名前:拒否コレクション
- 優先順位:100
- アクション:拒否

|name  |Protocol  |送信元の種類  |source  |変換先の型  |宛先アドレス  |宛先ポート|
|---------|---------|---------|---------|----------|----------|--------|
|Deny-SSH     |TCP|IP アドレス|*|IP アドレス|*|22

**結果**

優先順位の高いネットワーク ルール コレクションによってブロックされるため、SSH 接続は拒否されます。 この時点で、ルールの処理が停止します。

## <a name="rule-changes"></a>ルールの変更

以前に許可されたトラフィックを拒否するようにルールを変更すると、関連する既存のセッションがすべて削除されます。

## <a name="next-steps"></a>次のステップ

- [Azure Firewall のデプロイおよび構成](tutorial-firewall-deploy-portal.md)方法について説明します。