---
title: チュートリアル:Azure portal を使用して Azure Firewall のデプロイと構成を行う
description: このチュートリアルでは、Azure portal を使用して Azure Firewall をデプロイおよび構成する方法を学習します。
services: firewall
author: vhorne
ms.service: firewall
ms.topic: tutorial
ms.date: 10/28/2019
ms.author: victorh
ms.custom: mvc
ms.openlocfilehash: be39449c1c11acdbdc99bd96f917c51eebda44ae
ms.sourcegitcommit: 8e31a82c6da2ee8dafa58ea58ca4a7dd3ceb6132
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/19/2019
ms.locfileid: "74195789"
---
# <a name="tutorial-deploy-and-configure-azure-firewall-using-the-azure-portal"></a>チュートリアル:Azure portal を使用して Azure Firewall をデプロイして構成する

アウトバウンド ネットワーク アクセスを制御することは、ネットワーク セキュリティ プラン全体の重要な要素です。 たとえば、Web サイトへのアクセスを制限することができます。 また、アクセスできるアウトバウンドの IP アドレスとポートを制限することもできます。

Azure サブネットから外に向かうアウトバウンド ネットワーク アクセスを制御する方法の 1 つとして、Azure Firewall の使用が挙げられます。 Azure Firewall を使用して、次のルールを構成できます。

* アプリケーション ルール: サブネットからアクセスできる完全修飾ドメイン名 (FQDN) を定義します。
* ネットワーク ルール: 送信元アドレス、プロトコル、宛先ポート、送信先アドレスを定義します。

ネットワーク トラフィックは、サブネットの既定ゲートウェイとしてのファイアウォールにルーティングしたときに、構成されているファイアウォール ルールに制約されます。

このチュートリアルでは、デプロイしやすいよう単純化して、3 つのサブネットを含んだ単一の VNet を作成します。 運用環境のデプロイでは、[ハブとスポーク モデル](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/hub-spoke)を採用して、独自の VNet にファイアウォールを配置することをお勧めします。 ワークロード サーバーは、1 つ以上のサブネットを含む同じリージョンのピアリングされた VNet に配置されます。

* **AzureFirewallSubnet** - このサブネットにファイアウォールが存在します。
* **Workload-SN** - このサブネットにはワークロード サーバーがあります。 このサブネットのネットワーク トラフィックは、ファイアウォールを通過します。
* **Jump-SN** - このサブネットには "ジャンプ" サーバーがあります。 ジャンプ サーバーには、リモート デスクトップを使用して接続できるパブリック IP アドレスがあります。 そこから、(別のリモート デスクトップを使用して) ワークロード サーバーに接続できます。

![チュートリアルのネットワーク インフラストラクチャ](media/tutorial-firewall-rules-portal/Tutorial_network.png)

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * テスト ネットワーク環境を設定する
> * ファイアウォールをデプロイする
> * 既定のルートを作成する
> * www.google.com へのアクセスを許可するようにアプリケーションを構成する
> * 外部 DNS サーバーへのアクセスを許可するようにネットワーク ルールを構成する
> * ファイアウォールをテストする

必要に応じて、[Azure PowerShell](deploy-ps.md) を使ってこのチュートリアルの手順を完了できます。

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。

## <a name="set-up-the-network"></a>ネットワークのセットアップ

最初に、ファイアウォールをデプロイするために必要なリソースを含めるリソース グループを作成します。 次に、VNet、サブネット、およびテスト サーバーを作成します。

### <a name="create-a-resource-group"></a>リソース グループの作成

このリソース グループには、このチュートリアルのすべてのリソースが含まれます。

1. Azure Portal [https://portal.azure.com](https://portal.azure.com) にサインインします。
2. Azure portal メニューで **[リソース グループ]** を選択するか、または任意のページから *[リソース グループ]* を検索して選択します。 その後、 **[追加]** を選択します。
3. **[リソース グループ名]** として「*Test-FW-RG*」と入力します。
4. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
5. **[リソース グループの場所]** で、場所を選択します。 後で作成するすべてのリソースは同じ場所にある必要があります。
6. **作成** を選択します。

### <a name="create-a-vnet"></a>VNet を作成する

この VNet には 3 つのサブネットが含まれます。

> [!NOTE]
> AzureFirewallSubnet サブネットのサイズは /26 です。 サブネットのサイズの詳細については、「[Azure Firewall に関する FAQ](firewall-faq.md#why-does-azure-firewall-need-a-26-subnet-size)」を参照してください。

1. Azure portal メニューまたは **[ホーム]** ページから、 **[リソースの作成]** を選択します。
1. **[ネットワーク]**  >  **[仮想ネットワーク]** を選びます。
1. **[名前]** に「**Test-FW-VN**」と入力します。
1. **[アドレス空間]** に「**10.0.0.0/16**」と入力します。
1. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
1. **[リソース グループ]** で、 **[Test-FW-RG]** を選択します。
1. **[場所]** で、以前使用したのと同じ場所を選択します。
1. **[サブネット]** で、 **[名前]** に「**AzureFirewallSubnet**」と入力します。 ファイアウォールはこのサブネットに配置されます。サブネット名は AzureFirewallSubnet **でなければなりません**。
1. **[アドレス範囲]** に「**10.0.1.0/26**」と入力します。
1. 他の既定の設定をそのまま使用し、 **[作成]** を選択します。

### <a name="create-additional-subnets"></a>追加のサブネットを作成する

次に、ジャンプ サーバーのサブネットとワークロード サーバーのサブネットを作成します。

1. Azure portal メニューで **[リソース グループ]** を選択するか、または任意のページから *[リソース グループ]* を検索して選択します。 次に、 **[Test-FW-RG]** を選択します。
2. **[Test-FW-VN]** 仮想ネットワークを選択します。
3. **[サブネット]**  >  **[+サブネット]** の順に選択します。
4. **[名前]** に「**Workload-SN**」と入力します。
5. **[アドレス範囲]** に「**10.0.2.0/24**」と入力します。
6. **[OK]** を選択します。

名前が **Jump-SN**、アドレス範囲が **10.0.3.0/24** の別のサブネットを作成します。

### <a name="create-virtual-machines"></a>仮想マシンを作成する

次に、ジャンプおよびワークロード仮想マシンを作成し、適切なサブネットに配置します。

1. Azure portal メニューまたは **[ホーム]** ページから、 **[リソースの作成]** を選択します。
2. **[Compute]** をクリックし、おすすめのリストで **[Windows Server 2016 Datacenter]** を選択します。
3. 次の仮想マシンの値を入力します。

   |Setting  |値  |
   |---------|---------|
   |Resource group     |**Test-FW-RG**|
   |仮想マシン名     |**Srv-Jump**|
   |リージョン     |前と同じ|
   |管理者のユーザー名     |**azureuser**|
   |パスワード     |**Azure123456!**|

4. **[受信ポートの規則]** の **[パブリック受信ポート]** で、 **[選択したポートを許可する]** を選択します。
5. **[受信ポートを選択]** で、 **[RDP (3389)]** を選択します。

6. 他の既定値をそのまま使用し、 **[次へ:ディスク]** を選択します。
7. ディスクの既定値をそのまま使用し、 **[次へ:ネットワーク]** を選択します。
8. 仮想ネットワークとして **Test-FW-VN** が選択されていること、およびサブネットが **Jump-SN** であることを確認します。
9. **[パブリック IP]** で、新しいパブリック IP アドレス名 (Srv-Jump-ip) の既定値をそのまま使用します。
11. 他の既定値をそのまま使用し、 **[次へ:管理]** を選択します。
12. **[オフ]** を選択して、ブート診断を無効にします。 他の既定値をそのまま使用し、 **[確認および作成]** を選択します。
13. 概要ページの設定を確認して、 **[作成]** を選択します。

次の表の情報を使用して、**Srv-Work** という名前の別の仮想マシンを構成します。 残りの構成は、Srv-Jump 仮想マシンと同じです。

|Setting  |値  |
|---------|---------|
|Subnet|**Workload-SN**|
|パブリック IP|**なし**|
|パブリック受信ポート|**なし**|

## <a name="deploy-the-firewall"></a>ファイアウォールをデプロイする

VNet にファイアウォールをデプロイします。

1. Azure portal メニューまたは **[ホーム]** ページから、 **[リソースの作成]** を選択します。
2. 検索ボックスに「**ファイアウォール**」と入力し、**Enter** キーを押します。
3. **[ファイアウォール]** を選択し、 **[作成]** を選択します。
4. **[ファイアウォールの作成]** ページで、次の表を使用してファイアウォールを構成します。

   |Setting  |値  |
   |---------|---------|
   |Subscription     |\<該当するサブスクリプション\>|
   |Resource group     |**Test-FW-RG** |
   |名前     |**Test-FW01**|
   |Location     |以前使用したのと同じ場所を選択します|
   |仮想ネットワークの選択     |**[Use Existing]\(既存の使用\)** : **Test-FW-VN**|
   |パブリック IP アドレス     |**新規作成**。 パブリック IP アドレスは、Standard SKU タイプであることが必要です。|

5. **[Review + create]\(レビュー + 作成\)** を選択します。
6. 概要を確認し、 **[作成]** を選択してファイアウォールを作成します。

   デプロイが完了するまでに数分かかります。
7. デプロイが完了したら、**Test-FW-RG** リソース グループに移動し、**Test-FW01** ファイアウォールを選択します。
8. プライベート IP アドレスをメモします。 後で既定のルートを作成するときにこれを使用します。

## <a name="create-a-default-route"></a>既定のルートを作成する

**Workload-SN** サブネットでは、アウトバウンドの既定ルートがファイアウォールを通過するように構成します。

1. Azure portal メニューで **[すべてのサービス]** を選択するか、または任意のページから *[すべてのサービス]* を検索して選択します。
2. **[ネットワーク]** で、 **[ルート テーブル]** を選択します。
3. **[追加]** を選択します。
4. **[名前]** に「**Firewall-route**」と入力します。
5. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
6. **[リソース グループ]** で、 **[Test-FW-RG]** を選択します。
7. **[場所]** で、以前使用したのと同じ場所を選択します。
8. **作成** を選択します。
9. **[更新]** を選択し、 **[Firewall-route]** ルート テーブルを選択します。
10. **[サブネット]** を選択し、 **[関連付け]** を選択します。
11. **[仮想ネットワーク]**  >  **[Test-FW-VN]** の順に選択します。
12. **[サブネット]** で、 **[Workload-SN]** を選択します。 必ずこのルートの **Workload-SN** サブネットのみを選択してください。それ以外の場合、ファイアウォールが正常に動作しません。

13. **[OK]** を選択します。
14. **[ルート]** 、 **[追加]** の順に選択します。
15. **[ルート名]** に「**fw-dg**」と入力します。
16. **[アドレス プレフィックス]** に「**0.0.0.0/0**」と入力します。
17. **[次ホップの種類]** で、 **[仮想アプライアンス]** を選択します。

    Azure Firewall は実際はマネージド サービスですが、この状況では仮想アプライアンスが動作します。
18. **[次ホップ アドレス]** に、前にメモしておいたファイアウォールのプライベート IP アドレスを入力します。
19. **[OK]** を選択します。

## <a name="configure-an-application-rule"></a>アプリケーション ルールを構成する

これは、 www.google.com へのアウトバウンド アクセスを許可するアプリケーション ルールです。

1. **Test-FW-RG** を開き、 **[Test-FW01]** ファイアウォールを選択します。
2. **Test-FW01** ページの **[設定]** で、 **[ルール]** を選択します。
3. **[アプリケーション ルール コレクション]** タブを選択します。
4. **[アプリケーション ルール コレクションの追加]** を選択します。
5. **[名前]** に「**App-Coll01**」と入力します。
6. **[優先度]** に「**200**」と入力します。
7. **[アクション]** で、 **[許可]** を選択します。
8. **[ルール]** の **[ターゲットの FQDN]** で、 **[名前]** に「**Allow-Google**」と入力します。
9. **[ソース アドレス]** に「**10.0.2.0/24**」と入力します。
10. **[プロトコル:ポート]** に「**http, https**」と入力します。
11. **[ターゲットの FQDN]** に「 **www.google.com** 」と入力します
12. **[追加]** を選択します。

Azure Firewall には、既定で許可されるインフラストラクチャ FQDN 用の組み込みのルール コレクションが含まれています。 これらの FQDN はプラットフォームに固有であり、他の目的には使用できません。 詳細については、[インフラストラクチャ FQDN](infrastructure-fqdns.md) に関する記事を参照してください。

## <a name="configure-a-network-rule"></a>ネットワーク ルールを構成する

これは、ポート 53 (DNS) で 2 つの IP アドレスへのアウトバウンド アクセスを許可するネットワーク ルールです。

1. **[ネットワーク ルール コレクション]** タブを選択します。
2. **[ネットワーク ルール コレクションの追加]** を選択します。
3. **[名前]** に「**Net-Coll01**」と入力します。
4. **[優先度]** に「**200**」と入力します。
5. **[アクション]** で、 **[許可]** を選択します。
6. **[ルール]** の **[名前]** に「**Allow-DNS**」と入力します。
7. **[プロトコル]** で **[UDP]** を選択します。
8. **[ソース アドレス]** に「**10.0.2.0/24**」と入力します。
9. [送信先アドレス] に「**209.244.0.3,209.244.0.4**」と入力します

   これらは、CenturyLink によって運用されるパブリック DNS サーバーです。
1. **[宛先ポート]** に「**53**」と入力します。
2. **[追加]** を選択します。

### <a name="change-the-primary-and-secondary-dns-address-for-the-srv-work-network-interface"></a>**Srv-Work** ネットワーク インターフェイスのプライマリおよびセカンダリ DNS アドレスを変更する

このチュートリアルのテスト目的で、サーバーのプライマリおよびセカンダリ DNS アドレスを構成します。 これは、一般的な Azure Firewall 要件ではありません。

1. Azure portal メニューで **[リソース グループ]** を選択するか、または任意のページから *[リソース グループ]* を検索して選択します。 **[Test-FW-RG]** リソース グループを選択します。
2. **Srv-Work** 仮想マシンのネットワーク インターフェイスを選択します。
3. **[設定]** で、 **[DNS サーバー]** を選択します。
4. **[DNS サーバー]** で、 **[カスタム]** を選択します。
5. **[DNS サーバーの追加]** テキスト ボックスに「**209.244.0.3**」と入力し、次のテキスト ボックスに「**209.244.0.4**」と入力します。
6. **[保存]** を選択します。
7. **Srv-Work** 仮想マシンを再起動します。

## <a name="test-the-firewall"></a>ファイアウォールをテストする

今度は、ファイアウォールをテストして、想定したように機能することを確認します。

1. Azure portal で、**Srv-Work** 仮想マシンのネットワーク設定を確認し、プライベート IP アドレスをメモします。
2. リモート デスクトップを **Srv-Jump** 仮想マシンに接続し、サインインします。 そこから **Srv-Work** のプライベート IP アドレスへのリモート デスクトップ接続を開きます。
3. Internet Explorer を開き、 https://www.google.com を参照します。
4. Internet Explorer のセキュリティ アラートで、 **[OK]**  >  **[閉じる]** の順に選択します。

   Google のホーム ページが表示されます。

5. https://www.microsoft.com を参照します。

   ファイアウォールによってブロックされます。

これで、ファイアウォール ルールが動作していることを確認できました。

* 1 つの許可された FQDN は参照できますが、それ以外は参照できません。
* 構成された外部 DNS サーバーを使用して DNS 名を解決できます。

## <a name="clean-up-resources"></a>リソースのクリーンアップ

ファイアウォール リソースは、次のチュートリアルのために残しておいてもかまいませんが、不要であれば、**Test-FW-RG** リソース グループを削除して、ファイアウォール関連のすべてのリソースを削除してください。

## <a name="next-steps"></a>次の手順

> [!div class="nextstepaction"]
> [チュートリアル:Azure Firewall のログを監視する](./tutorial-diagnostics.md)
