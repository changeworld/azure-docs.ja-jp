---
title: Azure Application Gateway でのエンド ツー エンド TLS の有効化
description: この記事では、Application Gateway によるエンド ツー エンド TLS のサポートの概要を示します。
services: application-gateway
author: amsriva
ms.service: application-gateway
ms.topic: article
ms.date: 3/19/2019
ms.author: victorh
ms.openlocfilehash: ae80b49c3bfb40743665768622d3f4a8a6990c12
ms.sourcegitcommit: 7e04a51363de29322de08d2c5024d97506937a60
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/14/2020
ms.locfileid: "81311864"
---
# <a name="overview-of-tls-termination-and-end-to-end-tls-with-application-gateway"></a>Application Gateway での TLS 終了とエンド ツー エンド TLS の概要

トランスポート層セキュリティ (TLS) (以前の Secure Sockets Layer (SSL)) は、Web サーバーとブラウザー間に暗号化されたリンクを確立するための標準的なセキュリティ テクノロジです。 このリンクにより、Web サーバーとブラウザー間で渡されるすべてのデータがプライベートで暗号化されたままになります。 Application Gateway では、ゲートウェイでの TLS 終了とエンド ツー エンド TLS 暗号化の両方がサポートされています。

## <a name="tls-termination"></a>TLS 終了

Application Gateway では、ゲートウェイの TLS 終了がサポートされています。その後、通常、トラフィックは、暗号化されないままバックエンド サーバーに渡されます。 アプリケーション ゲートウェイでの TLS 終了には多くの利点があります。

- **パフォーマンスの向上** – TLS 解読を行っているときの最大のパフォーマンスへの影響は、初期ハンドシェイクです。 パフォーマンスを向上させるには、解読を行うサーバーで TLS セッション ID をキャッシュし、TLS セッション チケットを管理します。 これをアプリケーション ゲートウェイで行う場合は、同じクライアントからのすべての要求でキャッシュされた値を使用できます。 バックエンド サーバーで行う場合は、クライアントの要求が別のサーバーに渡されるたびに、クライアントを再認証する必要があります。 TLS チケットの使用はこの問題の軽減に役立ちますが、すべてのクライアントでサポートされているわけではなく、構成と管理は難しい場合があります。
- **バックエンド サーバーの使用率の向上** – SSL/TLS 処理では CPU に非常に多くの負荷がかかり、キー サイズが大きくなるほど多くの負荷がかかります。 バックエンド サーバーからこの作業を取り除けば、最も効率的な作業に集中してコンテンツを配信することができます。
- **インテリジェントなルーティング** – トラフィックの暗号化を解除することで、アプリケーション ゲートウェイはヘッダー、URIなど、要求のコンテンツにアクセスでき、このデータを使用して要求をルーティングすることができます。
- **証明書の管理** – 証明書は、購入して、すべてのバックエンド サーバーではなくアプリケーション ゲートウェイにインストールするだけで済みます。 これにより時間もコストも節約できます。

TLS 終了を構成するには、TLS/SSL 証明書をリスナーに追加して、アプリケーション ゲートウェイで TLS/SSL プロトコルの仕様どおりの対称キーを派生させることができるようにする必要があります。 対称キーは、ゲートウェイに送信されたトラフィックの暗号化と暗号化の解除に使用されます。 TLS/SSL 証明書は、Personal Information Exchange (PFX) 形式である必要があります。 このファイル形式により、アプリケーション ゲートウェイがトラフィックの暗号化および暗号化解除を実行する際に必要な秘密キーをエクスポートできます。

> [!NOTE] 
>
> アプリケーション ゲートウェイには、新しい証明書を作成したり証明機関に証明書要求を送信したりする機能はありません。

TLS 接続を機能させるには、TLS/SSL 証明書が次の条件を確実に満たすようにする必要があります。

- 現在の日付と時刻が、証明書の "有効期間の開始日" と"有効期間の終了日" の日付範囲内である。
- 証明書の "共通名" (CN) が、要求のホスト ヘッダーと一致する。 たとえば、クライアントが `https://www.contoso.com/` に要求を送信する場合、CN は `www.contoso.com` である必要があります。

### <a name="certificates-supported-for-tls-termination"></a>TLS 終了でサポートされる証明書

Application Gateway では、次の種類の証明書がサポートされています。

- CA (証明機関) の証明書:CA 証明書は、証明機関 (CA) によって発行されたデジタル証明書です
- EV (拡張された検証) 証明書:EV 証明書は、業界標準の証明書ガイドラインに準拠する証明書です。 これにより、ブラウザーのロケーター バーが緑色になり、会社名も公開されます。
- ワイルドカード証明書:この証明書は、*site.com に基づく任意の数のサブドメインをサポートしています。* は指定したサブドメインに置き換えられます。 ただし、ユーザーが先頭の "www" を入力せずに Web サイトにアクセスしている場合、ワイルドカード証明書はそれに対応していないため、site.com はサポートされません。
- 自己署名証明書:クライアントのブラウザーではこれらの証明書は信頼されず、仮想サービスの証明書が信頼チェーンに含まれていないことがユーザーに警告されます。 自己署名証明書は、テストや、管理者がクライアントを制御していて、ブラウザーのセキュリティの警告を安全にバイパスできる環境に適しています。 運用環境のワークロードでは、自己署名証明書を使用しないでください。

詳細については、[アプリケーション ゲートウェイでの TLS 終了の構成](https://docs.microsoft.com/azure/application-gateway/create-ssl-portal)に関するページを参照してください。

### <a name="size-of-the-certificate"></a>証明書のサイズ
サポートされる TLS/SSL 証明書の最大サイズを把握するには、「[Application Gateway の制限](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits)」セクションを確認してください。

## <a name="end-to-end-tls-encryption"></a>エンド ツー エンド TLS 暗号化

顧客によっては、バックエンド サーバーへの暗号化されていない通信を希望しない場合があります。 その理由として、セキュリティ要件、コンプライアンス要件、またはセキュリティで保護された接続以外はアプリケーションで受け入れられない場合があります。 このようなアプリケーションのために、アプリケーション ゲートウェイでは、エンド ツー エンド TLS 暗号化がサポートされています。

エンド ツー エンド TLS により、暗号化されたバックエンドに機密データを安全に送信しながら、アプリケーション ゲートウェイによって提供されるレイヤー 7 の負荷分散機能の利点を引き続き利用できます。 (レイヤー 7 の負荷分散機能には、Cookie ベースのセッション アフィニティ、URL ベースのルーティング、サイトに基づくルーティングのサポート、X-Forwarded-* ヘッダーを挿入する機能などがあります)。

エンド ツー エンド TLS 通信モードが構成されている場合、アプリケーション ゲートウェイによって TLS セッションがゲートウェイで終了され、ユーザー トラフィックの暗号化が解除されます。 次に、構成済みのルールが適用され、トラフィックのルーティング先になる適切なバックエンド プール インスタンスが選択されます。 バックエンドに要求を送信する前に、Application Gateway によってバックエンド サーバーへの新しい TLS 接続が開始され、バックエンド サーバーの公開キー証明書を使用してデータが再暗号化されます。 Web サーバーからの応答は、同じ手順でエンドユーザーに移動します。 エンド ツー エンド TLS は、[バックエンドの HTTP 設定](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings)のプロトコル設定を HTTPS に設定することによって有効になります。この設定は次にバックエンド プールに適用されます。

TLS ポリシーは、フロント エンドとバックエンドの両方のトラフィックに適用されます。 フロント エンドでは、Application Gateway はサーバーとして機能し、ポリシーを適用します。 バックエンドでは、Application Gateway はクライアントとして機能し、TLS ハンドシェイク中の優先設定としてプロトコルまたは暗号情報を送信します。

アプリケーション ゲートウェイは、証明書をアプリケーション ゲートウェイでホワイトリストに登録しているか、証明書 CN が HTTP バックエンド設定のホスト名と一致する既知の CA 機関によって証明書が署名されているバックエンドインスタンスとしか通信しません。 これには、Azure App Service の Web アプリや Azure API Management などの信頼できる Azure サービスが含まれます。

バックエンド プール内のメンバーの証明書が既知の CA 機関によって署名されていない場合、エンド ツー エンド TLS が有効になっているバックエンド プール内の各インスタンスは、セキュリティで保護された通信を許可するように証明書で構成する必要があります。 証明書を追加することにより、アプリケーション ゲートウェイは、既知のバックエンド インスタンスのみと通信するため、 エンド ツー エンド通信のセキュリティが強化されます。

> [!NOTE] 
>
> 認証証明書のセットアップは、Azure App Service の Web アプリや Azure API Management などの信頼できる Azure サービスでは必要ありません。

> [!NOTE] 
>
> バックエンド サーバーを認証するために**バックエンドの HTTP 設定**に追加する証明書は、アプリケーション ゲートウェイで TLS 終了の**リスナー**に追加する証明書と同じものにすることも、セキュリティの強化のために別のものにすることもできます。

![エンド ツー エンド TLS のシナリオ][1]

この例では、TLS1.2 を使用する要求が、エンド ツー エンド TLS を使用して Pool1 のバックエンド サーバーにルーティングされます。

## <a name="end-to-end-tls-and-whitelisting-of-certificates"></a>エンド ツー エンド TLS と証明書のホワイト リスト

Application Gateway は、既知のバックエンド インスタンスのみと通信します。これらのインスタンスでは、アプリケーション ゲートウェイに関する証明書がホワイトリスト登録されています。 証明書のホワイトリスト登録を有効にするには、(ルート証明書ではなく) バックエンド サーバーの証明書の公開キーをアプリケーション ゲートウェイにアップロードする必要があります。 ホワイトリスト登録された既知のバックエンドへの接続のみが許可され、 それ以外ではゲートウェイ エラーが発生します。 自己署名証明書はテストのみを目的とするため、運用環境のワークロードで使用することはお勧めできません。 このような証明書は、使用する前に、上記の手順で説明したとおりに、アプリケーション ゲートウェイでホワイトリスト登録する必要があります。

> [!NOTE]
> 認証証明書のセットアップは、信頼済みの Azure サービス (Azure App Service など) では必要ありません。

## <a name="end-to-end-tls-with-the-v2-sku"></a>v2 SKU を利用したエンド ツー エンド TLS

認証証明書は廃止され、Application Gateway v2 SKU の信頼されたルート証明書に置き換えられました。 これは認証証明書と同様の働きをしますが、いくつかの重要な違いがあります。

- 既知の CA 機関によって署名され、バックエンドの HTTP 設定のホスト名と一致する CN を持つ証明書は、エンド ツー エンド TLS が機能するために追加の手順は必要ありません。 

   たとえば、バックエンド証明書が既知の CA により発行されて、その CN が contoso.com であり、バックエンドの http 設定の [ホスト] フィールドも contoso.com に設定されている場合、追加の手順は必要ありません。 バックエンドの HTTP 設定のプロトコルとして HTTPS を設定すると、正常性プローブとデータ パスの両方が TLS で有効になります。 バックエンドとして Azure App Service または他の Azure の Web サービスを使用している場合は、それらも暗黙で信頼されており、エンド ツー エンド TLS にはこれ以上の手順は必要ありません。
   
> [!NOTE] 
>
> TLS/SSL 証明書を信頼するためには、バックエンド サーバーのその証明書が Application Gateway の信頼されているストアに含まれている CA によって発行されている必要があります。証明書が信頼されている CA によって発行されていない場合は、Application Gateway によって、証明書を発行している CA の証明書が信頼されている CA によって発行されているかどうかがチェックされます。信頼されている CA が見つかる (この時点で信頼できる安全な接続が確立されます) か、信頼されている CA を見つけることができなくなる (Application Gateway によってバックエンドが正常でないとマークされます) まで、この操作が続行されます。 そのため、バックエンド サーバーの証明書には、ルート CA と中間 CA の両方を含めることをお勧めします。

- 証明書が自己署名済みの場合、または不明な仲介者によって署名されている場合、v2 SKU でエンド ツー エンド TLS を有効にするには、信頼できるルート証明書を定義する必要があります。 Application Gateway は、サーバー証明書のルート証明書がプールに関連付けられたバックエンドの HTTP 設定の信頼されたルート証明書のいずれかと一致するバックエンドとのみ通信します。

> [!NOTE] 
>
> 自己署名証明書は、証明書チェーンの一部である必要があります。 チェーンがない単一の自己署名証明書は、V2 SKU ではサポートされていません。

- Application Gateway では、ルート証明書の一致に加えて、バックエンドの HTTP 設定に指定されている [ホスト] 設定が、バックエンド サーバーの TLS/SSL 証明書によって提示される共通名 (CN) のホスト設定と一致するかどうかも検証されます。 バックエンドとの TLS 接続を確立しようとする場合、Application Gateway では、Server Name Indication (SNI) 拡張機能が、バックエンドの HTTP 設定で指定されているホストに設定されます。
- バックエンドの HTTP 設定で [ホスト] フィールドではなく、 **[pick hostname from backend address]** が選択されている場合、SNI ヘッダーには常にバックエンド プールの FQDN が設定され、バックエンド サーバーの TLS/SSL 証明書の CN はその FQDN と一致している必要があります。 このシナリオでは、IP アドレスを持つバックエンド プール メンバーはサポートされません。
- このルート証明書は､バックエンド サーバーの証明書からの base64 でエンコードされたルート証明書になります｡

## <a name="next-steps"></a>次のステップ

エンド ツー エンド TLS について学習したら、「[Application Gateway での PowerShell を使用したエンド ツー エンド TLS の構成](application-gateway-end-to-end-ssl-powershell.md)」に進んで、エンド ツー エンド TLS を使用するアプリケーション ゲートウェイを作成します。

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png
