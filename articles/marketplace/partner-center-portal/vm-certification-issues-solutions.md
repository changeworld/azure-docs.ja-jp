---
title: 仮想マシンの認定 - 問題と解決策
description: この記事では、VM イメージの一般的なエラー メッセージについて説明します。 また、関連するソリューションについても説明します。
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: troubleshooting
author: iqshahmicrosoft
ms.author: iqshah
ms.date: 06/16/2020
ms.openlocfilehash: 594a47f397ca78476ed987ac0e06a3cacc79ec3b
ms.sourcegitcommit: a76ff927bd57d2fcc122fa36f7cb21eb22154cfa
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/28/2020
ms.locfileid: "87319900"
---
# <a name="issues-and-solutions-during-virtual-machine-certification"></a>仮想マシンの認定中の問題と解決策 

Azure Marketplace に仮想マシン (VM) イメージを発行する際に、Azure チームはそれを検証して、その起動可能性、セキュリティ、および Azure との互換性を確認します。 高品質テストのいずれかに不合格になると、発行が失敗し、問題を説明するエラー メッセージが表示されます。

この記事では、VM イメージの発行中に発生する一般的なエラー メッセージと、関連する解決策について説明します。

> [!NOTE]
> 改善に関するご質問またはご意見につきましては、[パートナー センターのサポート](https://partner.microsoft.com/support/v2/?stage=1)までご連絡ください。

## <a name="approved-base-image"></a>承認された基本イメージ

更新を含むイメージを再発行する要求を送信すると、パート番号の検証テスト ケースが失敗する可能性があります。 失敗した場合、イメージは承認されません。

このエラーは、別の発行元に属する基本イメージを使用しており、そのイメージを更新した場合に発生します。 この場合、イメージの発行は許可されません。

この問題を解決するには、Azure Marketplace からイメージを取得し、それに対して変更を加えます。 詳細については、次の記事を参照してください。

- [Linux イメージ](../../virtual-machines/linux/endorsed-distros.md?toc=/azure/virtual-machines/linux/toc.json)
- [Windows イメージ](create-azure-vm-technical-asset.md#create-a-vm-image-using-an-approved-base)

## <a name="vm-extension-failure"></a>VM 拡張機能のエラー

イメージによって VM 拡張機能がサポートされているかどうかを確認します。

VM 拡張機能を有効にするには、次の手順を実行します。

1. Linux VM を選択します。
1. **[診断設定]** に移動します。
1. **ストレージ アカウント**を更新して、基本マトリックスを有効にします。
1. **[保存]** を選択します。

   ![ゲスト レベルの監視を有効にする](./media/vm-certification-issues-solutions-1.png)

VM 拡張機能が正しくアクティブ化されていることを確認するには、以下を実行します。

1. VM 内で **[VM 拡張機能]** タブを選択し、 **[Linux Diagnostics 拡張機能]** の状態を確認します。
    * 状態が *[プロビジョニング成功]* であれば、拡張機能テスト ケースは合格しています。  
    * 状態が *[プロビジョニング失敗]* の場合、拡張機能テスト ケースは失敗しており、書き込まれたフラグを設定する必要があります。

      ![プロビジョニングが成功したことを示すスクリーンショット](./media/vm-certification-issues-solutions-2.png)

      VM 拡張機能が失敗した場合は、[[Linux Diagnostic Extension を使用して、メトリックとログを監視する]](../../virtual-machines/extensions/diagnostics-linux.md) を参照して有効にします。 VM 拡張機能を有効にしない場合は、サポート チームに連絡して、それを無効にするように依頼してください。

## <a name="vm-provisioning-issue"></a>VM のプロビジョニングの問題

オファーを送信する前に、VM のプロビジョニング プロセスに従っていることを確認してください。 VM をプロビジョニングするための JSON 形式を表示するには、[Azure 仮想マシンのイメージの認定](azure-vm-image-certification.md)に関する記事にアクセスします。

プロビジョニングの問題としては、次のような失敗シナリオが考えられます。

|シナリオ|エラー|理由|解決策|
|---|---|---|---|
|1|無効な仮想ハード ディスク (VHD)|VHD フッターにある指定された Cookie の値が正しくない場合、VHD は無効と見なされます。|イメージを再作成して、要求を送信します。|
|2|無効な BLOB の種類|使用されたブロックがページの種類ではなく、BLOB の種類であるため、VM のプロビジョニングが失敗しました。|イメージを再作成して、要求を送信します。|
|3|プロビジョニングのタイムアウト、または正しく一般化されていない|VM の一般化に問題があります。|一般化を使用してイメージを再作成し、要求を送信します。|

> [!NOTE]
> VM の一般化の詳細については、以下を参照してください。
> - [Linux ドキュメント](create-azure-vm-technical-asset.md#generalize-the-image)
> - [Windows ドキュメント](../../virtual-machines/windows/capture-image-resource.md#generalize-the-windows-vm-using-sysprep)

## <a name="software-compliance-for-windows"></a>Windows のソフトウェア コンプライアンス

ソフトウェア コンプライアンスの問題が原因で Windows イメージの要求が拒否された場合は、Azure Marketplace から関連する SQL バージョンの基本イメージを取得する代わりに、SQL Server インスタンスがインストールされた Windows イメージを作成した可能性があります。

SQL Server がインストールされている独自の Windows イメージを作成しないでください。 代わりに、Azure Marketplace からの承認された SQL 基本イメージ (Enterprise/Standard/web) を使用してください。

Visual Studio、または Office のライセンスされた製品をインストールしようとしている場合は、事前承認についてサポート チームにお問い合わせください。

承認されたベースの選択の詳細については、[Azure 仮想マシンの技術資産の作成](create-azure-vm-technical-asset.md#create-a-vm-image-using-an-approved-base)に関する記事を参照してください。

## <a name="tool-kit-test-case-execution-failed"></a>ツールキットのテスト ケースの実行に失敗した

Microsoft 認定ツールキットを使用すると、テスト ケースを実行し、VHD またはイメージに Azure 環境との互換性があることを確認できます。

[Microsoft 認定ツールキット](azure-vm-image-certification.md)をダウンロードします。

## <a name="linux-test-cases"></a>Linux のテスト ケース

ツールキットで実行される Linux のテスト ケースの一覧を次の表に示します。 テストの検証は、説明に記載されています。

|シナリオ|テスト ケース|説明|
|---|---|---|
|1|Bash 履歴|VM イメージを作成する前に、Bash 履歴ファイルをクリアする必要があります。|
|2|Linux エージェントのバージョン|Azure Linux エージェント 2.2.41 以降がインストールされている必要があります。|
|3|必須のカーネル パラメーター|次のカーネル パラメーターが設定されていることを確認します。 <br>console=ttyS0<br>earlyprintk=ttyS0<br>rootdelay=300|
|4|OS ディスク上のスワップ パーティション|OS ディスクにスワップ パーティションが作成されていないことを確認します。|
|5|OS ディスク上のルート パーティション|OS ディスクの単一のルート パーティションを作成します。|
|6|OpenSSL のバージョン|OpenSSL のバージョンは、0.9.8 以降である必要があります。|
|7|Python バージョン|Python バージョン 2.6 以降を強くお勧めします。|
|8|クライアント Alive 間隔|ClientAliveInterval を 180 に設定します。 アプリケーションで必要な場合は、30 から 235 の範囲で設定できます。 エンド ユーザーに対して SSH を有効にする場合は、説明に従ってこの値を設定する必要があります。|
|9|OS アーキテクチャ|64 ビットのオペレーティング システムのみがサポートされています。|
|10|自動更新|Linux エージェントの自動更新が有効になっているかどうかを特定します。|

### <a name="common-errors-found-while-executing-previous-test-cases"></a>前のテスト ケースの実行中に検出された一般的なエラー

前述のテスト ケースの実行中に検出された一般的なエラーの一覧を次の表に示します。
 
|シナリオ|テスト ケース|エラー|解決策|
|---|---|---|---|
|1|Linux エージェント バージョンのテスト ケース|Linux エージェントの最小バージョンは 2.241 以降です。 この要件は、2020 年 5 月 1 日以降必須になりました。|[要求を送信](https://support.microsoft.com/help/4049215/extensions-and-virtual-machine-agent-minimum-version-support)するには、必要なバージョンでイメージを更新する必要があります。|
|2|Bash 履歴テスト ケース|送信したイメージ内の Bash 履歴のサイズが 1 キロバイト (KB) を超えると、エラーが表示されます。 潜在的な機密情報が Bash 履歴ファイルにキャプチャされることのないように、このサイズは 1 KB に制限されています。|この問題を解決するには、動作している他の VM に VHD をマウントし、必要な変更 ( *.bash* 履歴ファイルを削除するなど) を行って、サイズを 1 KB 以下に削減します。|
|3|必要なカーネル パラメーターのテスト ケース|このエラーは、**console** の値が **ttyS0** に設定されていない場合に発生します。 次のコマンドを実行して確認します。<br>`cat /proc/cmdline`|**console** の値を **ttyS0** に設定し、要求を再送信します。|
|4|ClientAlive 間隔のテスト ケース|ツールキットの結果で、このテスト ケースに対して失敗の結果が返された場合は、**ClientAliveInterval** の値が不適切です。|**ClientAliveInterval** の値を 235 以下に設定してから、要求を再送信してください。|

### <a name="windows-test-cases"></a>Windows のテスト ケース

ツールキットで実行される Windows テスト ケースの一覧と、テストの検証の説明を次の表に示します。

|シナリオ |テスト ケース|説明|
|---|---|---|---|
|1|OS アーキテクチャ|Azure では 64 ビットのオペレーティング システムのみがサポートされています。|
|2|ユーザー アカウントの依存関係|アプリケーションの実行は、管理者アカウントに依存することはできません。|
|3|フェールオーバー クラスター|Windows Server のフェールオーバー クラスタリング機能はまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|4|IPV6|IPv6 は、Azure 環境ではまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|5|[DHCP]|動的ホスト構成プロトコルのサーバー ロールは、まだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|6|Hyper-V|Hyper-V のサーバー ロールはまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|7|リモート アクセス|リモート アクセス (直接アクセス) のサーバー ロールはまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|8|Rights Management サービス|Rights Management サービス。 このサーバー ロールはまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|9|Windows 展開サービス|Windows 展開サービス。 このサーバー ロールはまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|10|BitLocker ドライブ暗号化|BitLocker ドライブ暗号化は、オペレーティング システムのハード ディスクではサポートされていませんが、データ ディスクでは使用できます。|
|11|インターネット記憶域ネーム サーバー|インターネット記憶域ネーム サーバー機能はまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|12|マルチパス I/O|マルチパス I/O。 このサーバー機能はまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|13|ネットワーク負荷分散|ネットワーク負荷分散。 このサーバー機能はまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|14|ピア名解決プロトコル|ピア名解決プロトコル。 このサーバー機能はまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|15|SNMP サービス|簡易ネットワーク管理プロトコル (SNMP) サービス機能は、まだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|16|Windows インターネット ネーム サービス|Windows インターネット ネーム サービス。 このサーバー機能はまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|
|17|ワイヤレス LAN サービス|ワイヤレス LAN サービス。 このサーバー機能はまだサポートされていません。 アプリケーションがこの機能に依存しないようにする必要があります。|

前述のテスト ケースでエラーが発生した場合、解決策については、表の **[説明]** 列を参照してください。 詳細情報が必要な場合は、サポート チームにお問い合わせください。 

## <a name="data-disk-size-verification"></a>データ ディスク サイズの確認

データ ディスクを使用して送信された要求のサイズが 1023 ギガバイト (GB) を超える場合、その要求は承認されません。 このルールは、Linux と Windows の両方に適用されます。

1023 GB 以下のサイズで要求を再送信してください。

## <a name="os-disk-size-validation"></a>OS ディスク サイズの検証

OS ディスク サイズの制限については、次のルールを参照してください。 要求を送信するときに、OS ディスク サイズが Linux または Windows の制限内であることを確認します。

|OS|推奨される VHD サイズ|
|---|---|
|Linux|30 GB から 1023 GB|
|Windows|30 GB から 250 GB|

VM では基になるオペレーティング システムへのアクセスが許可されるため、VHD のサイズが VHD にとって十分な大きさであることを確認します。 ディスクはダウンタイムなしで展開できないため、30 GB から 50 GB のディスク サイズを使用してください。

|VHD サイズ|実際の占有サイズ|解決策|
|---|---|---|
|> 500 テビバイト (TiB)|該当なし|例外の承認については、サポート チームにお問い合わせください。|
|250-500 TiB|BLOB サイズとの差異が > 200 ギビバイト (GiB)|例外の承認については、サポート チームにお問い合わせください。|

> [!NOTE]
> ディスク サイズを大きくすると、コストが高くなり、セットアップとレプリケーションのプロセスで遅延が発生します。 この遅延とコストのために、サポート チームでは、例外の承認に対する正当な理由を求める場合があります。

## <a name="wannacry-patch-verification-test-for-windows"></a>Windows での WannaCry 修正プログラムの検証テスト

WannaCry ウイルスに関連する潜在的な攻撃を防ぐには、すべての Windows イメージ要求が最新の修正プログラムで更新されているようにします。

OS の詳細とサポートされる最小バージョンについて Windows Server の修正プログラム適用済みバージョンを確認するには、次の表を参照してください。 

イメージ ファイルのバージョンは、`C:\windows\system32\drivers\srv.sys` または `srv2.sys` から確認できます。

> [!NOTE]
> WindowsServer2019 には、必須のバージョン要件はありません。

|OS|Version|
|---|---|
|Windows Serve 2008 R2|6.1.7601.23689|
|Windows Server 2012|6.2.9200.22099|
|Windows Server 2012 R2|6.3.9600.18604|
|Windows Server 2016|10.0.14393.953|
|Windows Server 2019|NA|

## <a name="sack-vulnerability-patch-verification"></a>SACK 脆弱性修正プログラムの検証

Linux イメージを送信するときに、カーネル バージョンの問題のために要求が拒否されることがあります。

承認されたバージョンでカーネルを更新し、要求を再送信します。 次の表で、承認されたカーネルのバージョンを確認できます。 バージョン番号は、ここに示されている番号以上である必要があります。

次のいずれかのカーネル バージョンでイメージがインストールされていない場合は、適切な修正プログラムを使用してそれを更新してください。 次の必要な修正プログラムを使用してイメージを更新した後で、サポート チームに必要な承認を要求します。

- CVE-2019-11477 
- CVE-2019-11478 
- CVE-2019-11479

|OS ファミリ|Version|カーネル|
|---|---|---|
|Ubuntu|14.04 LTS|4.4.0-151| 
||14.04 LTS|4.15.0-1049-*-azure|
||16.04 LTS|4.15.0-1049|
||18.04 LTS|4.18.0-1023|
||18.04 LTS|5.0.0-1025|
||18.10|4.18.0-1023|
||19.04|5.0.0-1010|
||19.04|5.3.0-1004|
|RHEL と Cent OS|6.10|2.6.32-754.15.3|
||7.2|3.10.0-327.79.2|
||7.3|3.10.0-514.66.2|
||7.4|3.10.0-693.50.3|
||7.5|3.10.0-862.34.2|
||7.6|3.10.0-957.21.3|
||7.7|3.10.0-1062.1.1|
||8.0|4.18.0-80.4.2|
||8.1|4.18.0-147|
||"7-RAW" (7.6)||
||"7-LVM" (7.6)|3.10.0-957.21.3|
||RHEL-SAP 7.4|TBD|
||RHEL-SAP 7.5|TBD|
|SLES|SLES11SP4 (SAP を含む)|3.0.101-108.95.2|
||SLES12SP1 for SAP|3.12.74-60.64.115.1|
||SLES12SP2 for SAP|4.4.121-92.114.1|
||SLES12SP3|4.4180-4.31.1 (kernel-azure)|
||SLES12SP3 for SAP|4.4.180-94.97.1|
||SLES12SP4|4.12.14-6.15.2 (kernel-azure)|
||SLES12SP4 for SAP|4.12.14-95.19.1|
||SLES15|4.12.14-5.30.1 (kernel-azure)|
||SLES15 for SAP|4.12.14-5.30.1 (kernel-azure)|
||SLES15SP1|4.12.14-5.30.1 (kernel-azure)|
|Oracle|6.10|UEK2 2.6.39-400.312.2<br>UEK3 3.8.13-118.35.2<br>RHCK 2.6.32-754.15.3 
||7.0-7.5|UEK3 3.8.13-118.35.2<br>UEK4 4.1.12-124.28.3<br>RHCK は上記の RHEL に従う|
||7.6|RHCK 3.10.0-957.21.3<br>UEK5 4.14.35-1902.2.0|
|CoreOS Stable 2079.6.0|4.19.43*|
||Beta 2135.3.1|4.19.50*|
||Alpha 2163.2.1|4.19.50*|
|Debian|jessie (security)|3.16.68-2|
||jessie backports|4.9.168-1+deb9u3|
||stretch (security)|4.9.168-1+deb9u3|
||Debian GNU/Linux 10 (buster)|Debian 6.3.0-18+deb9u1|
||buster、sid (stretch backports)|4.19.37-5|

## <a name="image-size-should-be-in-multiples-of-megabytes"></a>イメージのサイズはメガバイトの倍数である必要がある

Azure 上のすべての VHD の仮想サイズは、1 メガバイト (MB) の倍数に調整されている必要があります。 VHD が推奨される仮想サイズに従っていない場合、要求が拒否される可能性があります。

未フォーマットのディスクから VHD に変換するときにはガイドラインに従い、未フォーマットのディスクのサイズが 1 MB の倍数であることを確認してください。 詳細については、「[動作保証外のディストリビューションに関する情報](../../virtual-machines/linux/create-upload-generic.md)」を参照してください。

## <a name="vm-access-denied"></a>VM アクセスが拒否された

VM 上でテスト ケースを実行しているときにアクセス拒否の問題が発生した場合は、テスト ケースを実行するための特権が不足していることが原因である可能性があります。

セルフテスト ケースが実行されているアカウントに対して適切なアクセスが有効になっているかどうかを確認します。 アクセスが有効になっていない場合は、テスト ケースを実行できるようにします。 アクセスを有効にしない場合は、セルフテスト ケースの結果をサポート チームと共有することができます。

## <a name="download-failure"></a>ダウンロードの失敗
    
共有アクセス署名 (SAS) URL を使用して VM イメージをダウンロードするときに発生する問題については、次の表を参照してください。

|シナリオ|エラー|理由|解決策|
|---|---|---|---|
|1|見つからない BLOB|VHD が削除されているか、指定された場所から移動されている可能性があります。|| 
|2|BLOB が使用中|VHD は別の内部プロセスによって使用されています。|SAS URL を使用してダウンロードする場合、VHD は使用済みの状態である必要があります。|
|3|無効な SAS URL|その VHD に関連付けられている SAS URL は正しくありません。|正しい SAS URL を取得してください。|
|4|無効な署名|その VHD に関連付けられている SAS URL は正しくありません。|正しい SAS URL を取得してください。|
|6|HTTP 条件ヘッダー|SASL URL が無効です。|正しい SAS URL を取得してください。|
|7|無効な VHD 名|VHD 名にパーセント記号 (%) や引用符 (") などの特殊文字が含まれているかどうかを確認します。|特殊文字を削除して VHD ファイルの名前を変更します。|

## <a name="first-1-mb-partition"></a>最初の 1 MB パーティション

VHD を送信するときに、VHD の最初の 1 MB パーティションが空であることを確認します。 そうでない場合、要求は失敗します。

## <a name="default-credentials"></a>既定の資格情報

送信された VHD と一緒に既定の資格情報が送信されていないことを必ず確認してください。 既定の資格情報を追加すると、VHD がセキュリティ上の脅威に対してより脆弱になります。 代わりに、VHD を送信するときには独自の資格情報を作成します。
  
## <a name="datadisk-mapped-incorrectly"></a>DataDisk が正しくマップされていない

複数のデータ ディスクを使用して要求が送信されるときに順序どおりになっていない場合、これはマッピングの問題と見なされます。 たとえば、3 つのデータ ディスクがある場合、番号付け順序は *0、1、2* である必要があります。 その他の順序は、マッピングの問題として扱われます。

データ ディスクの適切なシーケンス処理を使用して要求を再送信してください。

## <a name="incorrect-os-mapping"></a>正しくない OS マッピング

イメージが作成されるときに、間違った OS ラベルにマップされたり割り当てられたりすることがあります。 たとえば、イメージの作成中に OS 名の一部として **Windows** を選択した場合、その OS ディスクのインストールは、Windows を使用してのみ行う必要があります。 Linux にも同じ要件が適用されます。

## <a name="vm-not-generalized"></a>VM が一般化されていない

Azure Marketplace から取得したすべてのイメージを再利用する場合は、オペレーティング システムの VHD を一般化する必要があります。

* **Linux** の場合、次のプロセスでは、Linux VM を一般化して別の VM として再デプロイします。

  SSH ウィンドウで、コマンド `sudo waagent -deprovision+user` を入力します。

* **Windows** の場合、`sysreptool` を使用して Windows イメージを一般化します。

このツールについて詳しくは、[システムの準備 (Sysprep) の概要]( https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview)に関する記事をご覧ください。

## <a name="datadisk-errors"></a>DataDisk エラー

データ ディスクに関連するエラーの解決策については、次の表を参照してください。

|エラー|理由|解決策|
|---|---|---|
|`DataDisk- InvalidUrl:`|このエラーは、オファーが送信されたときに、論理ユニット番号 (LUN) に無効な番号が指定されていることが原因で発生する可能性があります。|データ ディスクの LUN 番号シーケンスがパートナー センターにあることを確認します。|
|`DataDisk- NotFound:`|このエラーは、指定された SAS URL にデータ ディスクがないことが原因で発生する可能性があります。|データ ディスクが、要求に指定されている SAS URL にあることを確認します。|

## <a name="remote-access-issue"></a>リモート アクセスの問題

リモート デスクトップ プロトコル (RDP) オプションが Windows イメージに対して有効になっていない場合は、このエラーを受け取ります。 

送信する前に、Windows イメージに対して RDP アクセスを有効にします。

## <a name="next-steps"></a>次のステップ

改善に関するご質問またはご意見につきましては、[パートナー センターのサポート](https://partner.microsoft.com/support/v2/?stage=1)までご連絡ください。
