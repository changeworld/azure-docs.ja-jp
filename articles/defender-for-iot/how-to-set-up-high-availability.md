---
title: 高可用性のセットアップ
description: オンプレミス管理コンソールに高可用性アプライアンスをインストールすることによって、Defender for IoT デプロイの回復性を高めます。 高可用性デプロイでは、マネージド センサーによってアクティブなオンプレミス管理コンソールに継続的に報告されます。
ms.date: 12/07/2020
ms.topic: how-to
ms.openlocfilehash: d0e09cd37fbae91d1903ca8f175c0592b567da6e
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/30/2021
ms.locfileid: "104781655"
---
# <a name="about-high-availability"></a>高可用性について

オンプレミス管理コンソールに高可用性アプライアンスをインストールすることによって、Defender for IoT デプロイの回復性を高めます。 高可用性デプロイでは、マネージド センサーによってアクティブなオンプレミス管理コンソールに継続的に報告されます。

このデプロイは、プライマリとセカンダリのアプライアンスを含むオンプレミス管理コンソールのペアにより実装されます。

## <a name="about-primary-and-secondary-communication"></a>プライマリとセカンダリの通信について

プライマリとセカンダリのオンプレミス管理コンソールがペアリングされている場合:

- プライマリとセカンダリのアプライアンス間にセキュリティで保護された接続を作成するために、オンプレミス管理コンソール SLL 証明書が適用されます。 SLL は、既定でインストールされる自己署名証明書、または顧客によってインストールされる証明書である場合があります。

- プライマリ オンプレミス管理コンソール データは、10 分ごとにセカンダリ オンプレミス管理コンソールに自動的にバックアップされます。 オンプレミス管理コンソールの構成とデバイス データがバックアップされます。 PCAP ファイルとログはバックアップに含まれません。 PCAP とログのバックアップと復元は手動で行うことができます。

- 管理コンソールのプライマリ セットアップがセカンダリに複製されます。たとえば、システム設定などです。 これらの設定がプライマリで更新された場合は、セカンダリでも更新されます。

- セカンダリのライセンスの有効期限が切れる前に、ライセンスを更新するためにそれをプライマリとして定義する必要があります。

## <a name="about-failover-and-failback"></a>フェールオーバーとフェールバックについて

センサーがプライマリ オンプレミス管理コンソールに接続できない場合は、セカンダリに自動的に接続されます。 センサーの半分未満がセカンダリと通信している場合、システムはプライマリとセカンダリの両方によって同時にサポートされます。 セカンダリは、半分を超えるセンサーと通信している場合に引き継ぎます。 プライマリからセカンダリへのフェールオーバーには約 3 分かかります。 フェールオーバーが発生すると、プライマリ オンプレミス管理コンソールがフリーズします。 このような場合は、同じサインイン資格情報を使用してセカンダリにサインインできます。

フェールオーバー中、センサーは引き続きプライマリ アプライアンスとの通信を試みます。 マネージド センサーの半分より多くがプライマリとの通信に成功すると、プライマリが復元されます。 プライマリが復元されると、セカンダリ コンソールに次のメッセージが表示されます。

:::image type="content" source="media/how-to-set-up-high-availability/secondary-console-message.png" alt-text="プライマリが復元されたときにセカンダリ コンソールに表示されるメッセージのスクリーンショット。":::

リダイレクト後にプライマリ アプライアンスにもう一度サインインします。

## <a name="high-availability-setup-overview"></a>高可用性セットアップの概要

インストールと構成の手順は、4 つの主段階で実行されます。

1. オンプレミス管理コンソール プライマリ アプライアンスをインストールします。 

2. オンプレミス管理コンソール プライマリ アプライアンスを構成します。 たとえば、スケジュールされたバックアップの設定、VLAN の設定などです。 詳細については、オンプレミス管理コンソールのユーザー ガイドを参照してください。 ペアリング後、すべての設定がセカンダリ アプライアンスに自動的に適用されます。

3. オンプレミス管理コンソール セカンダリ アプライアンスをインストールします。 詳細については、[Defender for IoT のインストールに関する記事](how-to-install-software.md)を参照してください。

4. [ここ](https://infrascale.secure.force.com/pkb/articles/Support_Article/How-to-access-your-Appliance-Management-Console)で説明されているように、プライマリとセカンダリのオンプレミス管理コンソール アプライアンスをペアリングします。 プライマリ オンプレミス管理コンソールでは、セットアップを実行するために、少なくとも 2 つのセンサーを管理する必要があります。

## <a name="high-availability-requirements"></a>高可用性の要件

次の高可用性の要件を満たしていることを確認します。

- 証明書の要件

- ソフトウェアおよびハードウェアの要件

- ネットワーク アクセスの要件

### <a name="software-and-hardware-requirements"></a>ソフトウェアおよびハードウェアの要件

- プライマリとセカンダリのオンプレミス管理コンソール アプライアンスは両方とも、同一のハードウェア モデルとソフトウェア バージョンを実行している必要があります。

- 高可用性システムは、CLI ツールを使用して、Defender for IoT ユーザーのみが設定できます。

### <a name="network-access-requirements"></a>ネットワーク アクセスの要件

プライマリおよびセカンダリのオンプレミス管理コンソール上の次のサービスへのアクセスが組織のセキュリティ ポリシーによって許可されていることを確認する必要があります。 これらのサービスにより、センサーとセカンダリ オンプレミス管理コンソールの間の接続も許可されます。

|Port|サービス|説明|
|----|-------|-----------|
|**443 または TCP**|HTTPS|オンプレミス管理コンソール Web コンソールへのアクセスを許可します。|
|**22 または TCP**|SSH|プライマリとセカンダリのオンプレミス管理コンソール アプライアンス間でデータを同期します|
|**123 または UDP**|NTP| オンプレミス管理コンソールの NTP 時刻同期。アクティブとパッシブのアプライアンスが同じタイムゾーンで定義されていることを確認します。|

## <a name="create-the-primary-and-secondary-pair"></a>プライマリとセカンダリのペアの作成

手順を開始する前に、プライマリとセカンダリの両方のオンプレミス管理コンソール アプライアンスの電源がオンになっていることを確認します。  

### <a name="on-the-primary"></a>プライマリ上

1. Defender for IoT ユーザーとして CLI にサインインします。

2. プライマリ上で次のコマンドを実行します。

```azurecli-interactive
sudo cyberx-management-trusted-hosts-add -ip <Secondary IP>
```

>[!NOTE]
>このドキュメントでは、プリンシパル オンプレミス管理コンソールをプライマリと呼び、エージェントをセカンダリと呼びます。

3. [```<Secondary ip>```] フィールドにセカンダリ アプライアンスの IP アドレスを入力し、Enter キーを押します。 次に、IP アドレスが検証され、SSL 証明書がプライマリにダウンロードされます。 IP アドレスを入力すると、センサーもセカンダリ アプライアンスに関連付けられます。

4. プライマリ上で次のコマンドを実行して、証明書が正しくインストールされていることを確認します。

```azurecli-interactive
sudo cyberx-management-trusted-hosts-apply
```

5. プライマリ上で次のコマンドを実行します。 **sudo では実行しないでください。**

```azurecli-interactive
cyberx-management-deploy-ssh-key <Secondary IP>
```

これにより、プライマリとセカンダリのアプライアンス間の接続が可能になり、それらの間でバックアップと復元を行えるようになります。

6. セカンダリの IP アドレスを入力し、Enter キーを押します。

### <a name="on-the-secondary"></a>セカンダリ上

1. Defender for IoT ユーザーとして CLI にサインインします。

2. セカンダリ上で次のコマンドを実行します。 **sudo では実行しないでください**。

```azurecli-interactive
cyberx-management-deploy-ssh-key <Primary ip>
```

これにより、プライマリとセカンダリのアプライアンス間の接続が可能になり、それらの間でバックアップと復元を行えるようになります。

3. プライマリの IP アドレスを入力し、Enter キーを押します。

### <a name="track-high-availability-activity"></a>高可用性アクティビティの追跡

コア アプリケーション ログを Defender for IoT サポート チームにエクスポートすると、高可用性の問題に対処できます。  

コア ログにアクセスするには:

1. **[システム設定]** ウィンドウで **[エクスポート]** を選択します。

## <a name="update-the-on-premises-management-console-with-high-availability"></a>高可用性を利用したオンプレミス管理コンソールの更新

高可用性更新を次の順序で実行します。 新しい手順を開始する前に、各手順が完了していることを確認してください。

高可用性を利用して更新するには:

1. プライマリ オンプレミス管理コンソールを更新します。

2. セカンダリ オンプレミス管理コンソールを更新します。

3. センサーを更新します。

## <a name="see-also"></a>関連項目

[オンプレミス管理コンソールをアクティブにしてセットアップする](how-to-activate-and-set-up-your-on-premises-management-console.md)