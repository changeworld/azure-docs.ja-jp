---
title: Azure portal での大規模なモジュールの展開 - Azure IoT Edge
description: Azure portal を使用して、一連の IoT Edge デバイスの自動展開を作成します
keywords: ''
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 4/21/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: e55d3f704c76d2783c3e442a90c829448129a4d0
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2020
ms.locfileid: "82134055"
---
# <a name="deploy-iot-edge-modules-at-scale-using-the-azure-portal"></a>Azure portal を使用した大規模な IoT Edge モジュールの展開

Azure portal で **IoT Edge の自動展開**を作成して、多数のデバイスの進行中のデプロイを一度に管理します。 IoT Edge の自動展開は、IoT Hub の[自動デバイス管理](/azure/iot-hub/iot-hub-automatic-device-management)機能の一部です。 デプロイは、複数のモジュールを複数のデバイスにデプロイし、モジュールの状態と正常性を追跡し、必要に応じて変更できる動的プロセスです。

詳細については、「[1 台のデバイスまたは多数のデバイスを対象とした IoT Edge 自動展開について](module-deployment-monitoring.md)」を参照してください。

## <a name="identify-devices-using-tags"></a>タグを使用したデバイスの識別

デプロイを作成する前に、影響を与えるデバイスを指定できる必要があります。 Azure IoT Edge では、デバイス ツイン内の**タグ**を使用してデバイスを識別します。 各デバイスには、対象のソリューションにとって意味のある方法で定義した複数のタグを設定することができます。

たとえば、スマート ビルディングのキャンパスを管理する場合は、デバイスに場所、部屋の種類、および環境タグを追加することがあります。

```json
"tags":{
  "location":{
    "building": "20",
    "floor": "2"
  },
  "roomtype": "conference",
  "environment": "prod"
}
```

デバイス ツインとタグの詳細については、「[IoT Hub のデバイス ツインの理解と使用](../iot-hub/iot-hub-devguide-device-twins.md)」を参照してください。

## <a name="create-a-deployment"></a>デプロイの作成

IoT Edge には、シナリオをカスタマイズするために使用できる 2 種類の自動デプロイが用意されています。 システム ランタイム モジュールと任意の追加のモジュールおよびルートが含まれている標準*デプロイ*を作成できます。 各デバイスには 1 つのデプロイしか適用できません。 または、カスタム モジュールおよびルートのみが含まれている (システム ランタイムはなし) *多層デプロイ*を作成できます。 デバイスで、標準デプロイの上に多数の多層デプロイを結合できます。 2 種類の自動デプロイが連携して動作するようすの詳細については、「[1 台のデバイスまたは多数のデバイスを対象とした IoT Edge 自動デプロイについて](module-deployment-monitoring.md)」を参照してください。

デプロイと多層デプロイを作成するための手順は非常によく似ています。 違いがある場合は、以降の手順で説明されています。

1. [Azure portal](https://portal.azure.com) で、IoT Hub に移動します。
1. 左側のウィンドウにあるメニューで、 **[自動デバイス管理]** の下の **[IoT Edge]** を選択します。
1. 上部のバーで、 **[デプロイの作成]** または **[Create Layered Deployment] (多層デプロイの作成)** を選択します。

デプロイを作成するには、5 つの手順があります。 次のセクションで、手順ごとに説明します。

### <a name="step-1-name-and-label"></a>手順 1:名前とラベル

1. デプロイに一意の名前を付けます。名前は最大 128 文字の英小文字で指定します。 スペースや、無効な文字は使用しないでください。`& ^ [ ] { } \ | " < > /`
1. デプロイの追跡に役立つよう、キーと値のペアとしてラベルを追加できます。 たとえば、**HostPlatform** と **Linux**、**Version** と **3.0.1** などです。
1. **[Next: Modules] (次へ: モジュール)** を選択して手順 2 に移動します。

### <a name="step-2-modules"></a>手順 2:モジュール

デプロイには、最大 20 個のモジュールを追加できます。 モジュールを含まないデプロイを作成すると、ターゲット デバイスから現在のモジュールが削除されます。

デプロイでは、IoT Edge エージェント モジュールと IoT Edge ハブ モジュールの設定を管理できます。 これらの 2 つのランタイム モジュールを構成するには、 **[ランタイムの設定]** を選択します。 多層デプロイでは、これらのランタイム モジュールは含まれていないため、構成できません。

追加できるモジュールは、次の 3 種類です。

* IoT Edge モジュール
* Marketplace モジュール
* Azure Stream Analytics モジュール

#### <a name="add-an-iot-edge-module"></a>IoT Edge モジュールを追加する

モジュールとしてカスタム コードを追加する、または Azure のサービス モジュールを手動で追加するには、次の手順を実行します。

1. ページの **[コンテナー レジストリの資格情報]** セクションで、このデプロイのモジュール イメージを含むすべてのプライベート コンテナー レジストリの名前と資格情報を指定します。 Docker イメージのコンテナー レジストリ資格情報が見つからないと、IoT Edge エージェントは、エラー 500 をレポートします。
1. ページの **[IoT Edge モジュール]** セクションで、 **[追加]** をクリックします。
1. ドロップダウン メニューから **[IoT Edge モジュール]** を選択します。
1. そのモジュールに **[IoT Edge モジュール名]** を付けます。
1. **[イメージの URI]** フィールドに、モジュールのコンテナー イメージを入力します。
1. ドロップダウン メニューを使用して、 **[再起動ポリシー]** を選択します。 次のオプションから選択します。
   * **[常時]** - 何らかの理由でシャットダウンした場合、モジュールは常に再起動します。
   * **[never]\(再起動しない\)** - なんらかの理由でシャット ダウンした場合でも、モジュールは再起動されません。
   * **[on-failure]\(失敗時\)** - モジュールがクラッシュした場合にモジュールを再起動し、正常にシャットダウンした場合は再起動しません。
   * **[正常でない場合]** - モジュールがクラッシュまたは異常な状態を返したときに再起動します。 正常性ステータス関数を実装するかどうかは、各モジュールによって異なります。
1. ドロップダウン メニューを使用してモジュールの **[Desired Status]\(目的の状態\)** を選択します。 次のオプションから選択します。
   * **[実行中]** - [実行中] は既定のオプションです。 モジュールは、展開された後すぐに実行が開始されます。
   * **[停止]** - デプロイされた後、ユーザーまたは別のモジュールによって開始されるまで、モジュールはアイドル状態になります。
1. コンテナーに渡す **[Container Create Options]\(コンテナー作成オプション\)** を指定します。 詳細については、[Docker の作成](https://docs.docker.com/engine/reference/commandline/create/)に関するページを参照してください。
1. モジュール ツインにタグまたはその他のプロパティを追加する場合は、 **[モジュール ツインの設定]** を選択します。
1. このモジュールの **[環境変数]** を入力します。 環境変数は、構成情報をモジュールに提供します。
1. **[追加]** を選択して、そのモジュールをデプロイに追加します。

#### <a name="add-a-module-from-the-marketplace"></a>Marketplace からモジュールを追加する

Azure Marketplace からモジュールを追加するには、次の手順に従います。

1. ページの **[IoT Edge モジュール]** セクションで、 **[追加]** をクリックします。
1. ドロップダウン メニューから **[Marketplace モジュール]** を選択します。
1. **[IoT Edge モジュールの Marketplace]** ページからモジュールを選択します。 選択したモジュールは、サブスクリプション、リソース グループ、およびデバイスに対して自動的に構成されます。 その後、それは IoT Edge モジュールの一覧に表示されます。 一部のモジュールでは、追加の構成が必要になることがあります。 詳細については、「[Azure Marketplace からモジュールをデプロイする](how-to-deploy-modules-portal.md#deploy-modules-from-azure-marketplace)」を参照してください。

#### <a name="add-a-stream-analytics-module"></a>Stream Analytics モジュールを追加する

Azure Stream Analytics からモジュールを追加するには、次の手順を実行します。

1. ページの **[IoT Edge モジュール]** セクションで、 **[追加]** をクリックします。
1. ドロップダウン メニューから **[Azure Stream Analytics モジュール]** を選択します。
1. 右側のウィンドウで、 **[サブスクリプション]** を選択します。
1. IoT の **[エッジ ジョブ]** を選択します。
1. **[保存]** を選択してデプロイにモジュールを追加します。

#### <a name="configure-module-settings"></a>モジュール設定を構成する

モジュールをデプロイに追加したら、その名前を選択して **[IoT Edge モジュールの更新]** ページを開くことができます。 このページでは、モジュール設定、環境変数、作成オプション、およびモジュール ツインを編集できます。 Marketplace からモジュールを追加した場合は、これらのパラメーターの一部が既に入力されている可能性があります。

多層デプロイを作成している場合は、同じデバイスを対象とする他のデプロイに存在するモジュールを構成する可能性があります。 他のバージョンを上書きせずにモジュール ツインを更新するには、 **[モジュール ツインの設定]** タブを開きます。モジュール ツインの必要なプロパティ内のサブセクションの一意の名前を持つ新しい **[モジュール ツイン プロパティ]** (`properties.desired.settings` など) を作成します。 `properties.desired` フィールド内だけでプロパティを定義した場合は、それによって、優先順位の低いすべてのデプロイで定義されたモジュールの必要なプロパティが上書きされます。

![多層デプロイのモジュール ツイン プロパティを設定する](./media/how-to-deploy-monitor/module-twin-property.png)

多層デプロイでのモジュール ツインの構成の詳細については、[多層デプロイ](module-deployment-monitoring.md#layered-deployment)に関するページを参照してください。

デプロイのすべてのモジュールが構成されたら、 **[Next: Routes] (次へ: ルート)** を選択して手順 3 に移動します。

### <a name="step-3-routes"></a>手順 3:ルート

ルートは、デプロイ内のモジュール間の通信方法を定義します。 既定では、ウィザードでは **FROM /messages/\* INTO $upstream** として定義された **upstream** という名前のルートが割り当てられます。つまり、すべてのモジュールによって出力されたメッセージはすべて IoT ハブに送信されます。  

[ルートの宣言](module-composition.md#declare-routes)の情報を使用してルートを追加または更新し、 **[次へ]** を選択して確認のセクションに進みます。

**[Next: Metrics] (次へ: メトリック)** を選択します。

### <a name="step-4-metrics"></a>手順 4:メトリック

メトリックは、構成のコンテンツを適用した結果としてデバイスから報告される、各種の状態の集計カウントを示すものです。

1. **[メトリック名]** に名前を入力します

1. **[メトリックの条件]** にクエリを入力します。 そのクエリは、IoT Edge ハブ モジュール ツインで[報告されるプロパティ](module-edgeagent-edgehub.md#edgehub-reported-properties)に基づいています。 メトリックは、クエリによって返された行の数を表します。

   次に例を示します。

   ```sql
   SELECT deviceId FROM devices
     WHERE properties.reported.lastDesiredStatus.code = 200
   ```

**[Next: Target Devices] (次へ: ターゲット デバイス)** を選択します。

### <a name="step-5-target-devices"></a>手順 5:ターゲット デバイス

このデプロイの対象となるデバイスを、デバイスからのタグ プロパティを使用して指定します。

同じデバイスが複数のデプロイの対象となっている場合があるため、各デプロイに優先順位番号を付ける必要があります。 競合した場合は、最も優先度が高いデプロイが優先されます (値が大きい方が優先度が高いことを示します)。 2 つのデプロイの優先度が同じ場合は、作成された時期が最近のデプロイが優先されます。

複数のデプロイが同じデバイスをターゲットにしている場合は、優先順位の高いものだけが適用されます。 複数の多層デプロイが同じデバイスをターゲットにしている場合、それらはすべて適用されます。 ただし、いずれかのプロパティが複製されている場合 (同じ名前のルートが 2 つ存在する場合など) は、優先順位の高い多層デプロイのもので残りが上書きされます。

デバイスをターゲットにする多層デプロイが適用されるようにするには、そのデプロイの優先順位を基本デプロイより高くする必要があります。

1. デプロイの **[優先度]** を正の整数で入力します。
1. どのデバイスがこのデプロイの対象となるかを指定する **[Target condition]\(対象の条件\)** を入力します。 条件は、デバイス ツイン タグか、デバイス ツインから報告されるプロパティに基づいて指定し、式の形式に一致させる必要があります。 たとえば、`tags.environment='test'` または `properties.reported.devicemodel='4000x'` です。

**[次へ: レビューと作成]** を選択して最後の手順に移動します。

### <a name="step-6-review-and-create"></a>手順 6:[Review and create] (確認および作成)

デプロイ情報を確認してから、 **[作成]** を選択します。

デプロイを監視するには、「[IoT Edge デプロイの監視](how-to-monitor-iot-edge-deployments.md)」を参照してください。

## <a name="modify-a-deployment"></a>デプロイの変更

デプロイを変更すると、変更はすべての対象デバイスにただちにレプリケートされます。 既存のデプロイに対して次の設定および機能を変更できます。

* ターゲットの条件
* カスタム メトリック
* ラベル
* Tags
* 必要なプロパティ

### <a name="modify-target-conditions-custom-metrics-and-labels"></a>ターゲットの条件、カスタム メトリック、およびラベルを変更する

1. IoT ハブで、左ペインのメニューの **[IoT Edge]** を選択します。
1. **[IoT Edge デプロイ]** タブを選択し、構成するデプロイを選択します。
1. **[ターゲットの条件]** タブを選択します。目的のデバイスをターゲットとするように **[ターゲットの条件]** を変更します。 **[優先順位]** を調整することもできます。  **[保存]** を選択します。

    対象の条件を更新すると、次の更新が実行されます。

    * デバイスが古い対象条件を満たさないが、新しい対象条件を満たしており、このデプロイのそのデバイスに対する優先度が最も高い場合は、このデプロイは、このデバイスに適用されます。
    * このデプロイを現在実行しているデバイスが対象条件を満たさなくなった場合、このデプロイはアンインストールされ、次に優先度の高いデプロイが適用されます。
    * このデプロイを現在実行しているデバイスが対象条件を満たさなくなり、他のデプロイの対象条件を満たさない場合は、デバイスではなにも変更されません。 デバイスは現在の状態で現在のモジュールを実行し続けますが、このデプロイの一部としては管理されなくなります。 デバイスが他のデプロイの対象の条件を満たすと、このデプロイはアンインストールされ、新しいデプロイが適用されます。

1. **[メトリック]** タブを選択し、 **[メトリックの編集]** ボタンをクリックします。 構文の例をガイドとして使用して、カスタム メトリックを追加または変更します。 **[保存]** を選択します。

    ![デプロイ内のカスタム メトリックを編集する](./media/how-to-deploy-monitor/metric-list.png)

1. **[ラベル]** タブを選択して必要な変更を行い、 **[保存]** を選択します。

## <a name="delete-a-deployment"></a>デプロイの削除

デプロイを削除すると、デプロイされたデバイスは、次に優先順位の高いデプロイを受け入れます。 デバイスが他のいずれのデプロイの対象条件も満たさない場合、デプロイが削除されても、モジュールは削除されません。

1. [Azure portal](https://portal.azure.com) にサインインし、IoT Hub に移動します。
1. **[IoT Edge]** を選択します。
1. **[IoT Edge デプロイ]** タブを選択します。

   ![IoT Edge デプロイの表示](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. チェックボックスを使用して、削除するデプロイを選択します。
1. **[削除]** を選択します。
1. この操作によりこのデプロイが削除され、すべてのデバイスが以前の状態に戻されることを警告する、プロンプトが表示されます。 優先度の低いデプロイが適用されます。 対象となっているデプロイがない場合は、モジュールは削除されません。 デバイスからすべてのモジュールを削除するには、モジュールがまったく指定されてないデプロイを作成し、それを同じデバイスにデプロイします。  **[はい]** を選択して続行します。

## <a name="next-steps"></a>次のステップ

[IoT Edge デバイスへのモジュールのデプロイ](module-deployment-monitoring.md)の詳細について学習します。
