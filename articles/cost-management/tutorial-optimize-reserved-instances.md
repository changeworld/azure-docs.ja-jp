---
title: チュートリアル - Azure で Cloudyn を使って予約インスタンスのコストを最適化する | Microsoft Docs
description: このチュートリアルでは、Azure およびアマゾン ウェブ サービス (AWS) の予約インスタンスのコストを最適化する方法について説明します。
services: cost-management
keywords: ''
author: bandersmsft
ms.author: banders
ms.date: 12/07/2018
ms.topic: tutorial
ms.service: cost-management
ms.custom: seodec18
manager: benshy
ms.openlocfilehash: a5376aed3e9cdb12be58cb07d7eb00303a03a963
ms.sourcegitcommit: 9fb6f44dbdaf9002ac4f411781bf1bd25c191e26
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/08/2018
ms.locfileid: "53074879"
---
<!-- Intent: As a cloud-consuming administrator, I need to ensure that my reserved instances are optimized for cost and usage
-->

# <a name="tutorial-optimize-reserved-instances"></a>チュートリアル:予約インスタンスを最適化する

このチュートリアルでは、Azure およびアマゾン ウェブ サービス (AWS) の予約インスタンスのコストと稼働率を Cloudyn を使って最適化する方法について説明します。 どちらのクラウド サービス プロバイダーも、予約インスタンスとは、将来における VM の使用を前もって約束する長期的な契約へのコミットメントをいいます。 そして標準的な従量課金制の VM 価格モデルと比べて、大幅なコスト削減効果を見込むことができます。 コスト削減効果は、ご利用の予約インスタンスのキャパシティを最大限に活用したときに初めて実現されます。

このチュートリアルでは、Azure と AWS の予約インスタンス (RI: Reserved Instance) が Cloudyn でどのようにサポートされるのかについて説明します。 また、予約インスタンスのコストを最適化する方法についても取り上げます。 その主な手段は、予約をフルに活用することです。 このチュートリアルでは、次のことについて説明します。

> [!div class="checklist"]
> * Azure RI のコストを理解する
> * RI の利点について知る
> * Azure RI のコストを最適化する
> * RI のコストを確認する
> * Azure RI の費用対効果を評価する
> * AWS RI のコストを最適化する
> * 推奨される RI を購入する
> * 未使用の予約に変更を加える

Azure サブスクリプションをお持ちでない場合は、開始する前に[無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F)を作成してください。

## <a name="prerequisites"></a>前提条件

- Azure アカウントが必要です。
- Cloudyn を使用するには評価版の登録または有料サブスクリプションが必要です。
- Azure または AWS の RI を購入済みであることが必要です。

## <a name="understand-azure-ri-costs"></a>Azure RI のコストを理解する

Azure Reserved VM Instances を購入するときは、将来的な使用の対価を前もって支払うことになります。 将来使用する VM のコストが、次の条件の範囲内で前払い分から充当されます。

- 特定の種類
- 特定のリージョン
- 特定の期間 (1 年間または 3 年間)
- 適用範囲 (購入済み VM 数まで)

購入済み Azure Reserved VM Instances は、Azure Portal の [[予約]](https://portal.azure.com/#blade/Microsoft_Azure_Reservations/ReservationsBrowseBlade) で確認できます。

"_Azure Reserved VM Instances_" は、あくまで価格モデルを対象とする言葉です。 実行中の VM を変更するものではありません。 Azure に固有の言葉であり、一般的には、"_予約インスタンス_" や "_予約_" と呼ばれています。 購入した予約インスタンスは、特定の VM に適用されるのではなく、該当するすべての VM に適用されます。 たとえば選択したリージョンで実行される特定の種類の VM が、購入する予約の対象となります。

予約インスタンスの購入は、基本的なハードウェアにのみ適用されます。 VM のソフトウェア ライセンスは含まれません。 たとえば、予約したインスタンスに該当する VM で Windows が実行されていたとします。 予約インスタンスで充当されるのは、VM の基本料金だけです。 この例では、必要な Windows のライセンスの価格を全額支払うことになります。 オペレーティング システムなど、VM 上で実行されるソフトウェアに対しての割引を受けるためには、[Azure ハイブリッド特典](https://azure.microsoft.com/pricing/hybrid-benefit)の利用を検討する必要があります。 ハイブリッド特典では、予約インスタンスでベース VM に適用されるような割引を、ソフトウェア ライセンスについても受けることができます。

予約インスタンスの稼働率がコストに直接影響することはありません。 つまり、実行する VM の CPU 使用率が 100% であろうと 0% であろうと、効果は同じです。前払いの対象になるのは VM の割り当てであって、その実際の稼働率ではありません。

次の図で、オンデマンドでの標準的な VM の使用と予約インスタンスに関連したコストとの関係を見てみましょう。

![オンデマンドと予約インスタンスのコスト比較](./media/tutorial-optimize-reserved-instances/azure01.png)



赤色のバーは、予約インスタンス購入の累積費用を示しています。 料金の支払いは 1 回限りです。 VM の使用は無料です。 青色のバーは、同じ VM を従量課金制のモデルまたはオンデマンド価格モデルで実行した場合の累積費用です。 7 か月から 8 か月までのどこかに、VM の使用に対する "*損益分岐点*" が存在します。 この例では、8 か月目からコスト削減効果が現れています。

## <a name="benefits-of-ris"></a>RI の利点

予約インスタンスの購入対象は常に、特定のサイズと場所の VM です。 たとえば、次の図に示した D2s\_v3 は米国西部で実行されています。

![Azure 予約インスタンスの詳細](./media/tutorial-optimize-reserved-instances/azure02.png)

予約インスタンスの購入によって利益がもたらされるのは、予約の損益分岐点に到達するほどの時間、VM が実行されたときです。 VM は、予約インスタンスのサイズおよび場所と一致している必要があります。 たとえば、前出のグラフにおける損益分岐点は 7 か月半の付近にあります。 したがって、購入によるメリットが生まれるのは、その予約に該当する VM が 5,400 時間 (= 7.5 か月 \* 30 日 \* 24 時間) 以上実行されたときです。 該当する VM の実行時間が 5,400 時間未満である場合、従量課金制よりも予約の方が割高になってしまいます。

損益分岐点は、VM のサイズや場所ごとに異なることが考えられます。 また、VM に関する交渉後の従量課金制の価格によっても異なります。 購入の判断をする前に、実際のケースに該当する損益分岐点をチェックしてください。

予約を購入する際に検討すべきもう 1 つのポイントは、予約インスタンスの範囲です。 予約の利点が共有されるのか、特定のサブスクリプションに適用されるのかは、範囲によって決まります。 共有される予約インスタンスは、最初に見つかった該当 VM に対し、すべてのサブスクリプションにまたがってランダムに適用されます。

最も柔軟性が高いのは共有購入範囲で、可能な限りこちらを選ぶことをお勧めします。 共有範囲によって、すべての予約インスタンスを活用する機会が大幅にアップします。 ただし、予約インスタンスの支払いをサブスクリプションの所有者が行う場合は、単一サブスクリプション範囲で購入する以外に選択肢はありません。

## <a name="optimize-azure-ri-costs"></a>Azure RI のコストを最適化する

Cloudyn は、予約インスタンスとハイブリッド特典に関して、次の機能をサポートします。

- 価格モデルに関連付けられているコストを表示する
- RI の使用を追跡する
- RI の影響について評価を行う
- 指定したポリシーに従って RI のコストを配分する

予約インスタンスを購入するにあたっては、あらかじめ RI の購入に伴う影響について評価を行う必要があります。

- コストはどれぐらいか
- どれぐらいコストを削減できるのか
- 損益分岐点はどこか

こうした疑問点に対する答えは、Reserved Instance Purchase Impact (予約インスタンス購入の影響) レポートから得ることができます。

## <a name="assess-azure-ri-cost-effectiveness"></a>Azure RI の費用対効果を評価する

Cloudyn ポータルで **[Optimizer]\(オプティマイザー\)** > **[RI 比較]\(RI 比較\)** に移動し、**[Reserved Instance Purchase Impact]\(予約インスタンス購入の影響\)** を選択します。

Reserved Instance Purchase Impact (予約インスタンス購入の影響) レポートで、VM サイズ (インスタンスの種類)、場所 (リージョン)、予約期間、数量、予想される実行時間を選択します。 これで、購入によるコスト削減効果の有無について評価を行うことができます。

たとえば、種類が DS1\_v2、リージョンが米国東部、実行時間が 24 時間 365 日である VM を予約購入する場合、年間 369.48 ドルのコスト削減効果が得られます。 損益分岐点は 5 か月目です。 次の図を参照してください。

![Azure 予約インスタンスの損益分岐点](./media/tutorial-optimize-reserved-instances/azure03.png)

一方、実行時間がその 50% にすぎない場合、損益分岐点は 10 か月目となり、コスト削減効果は年間わずか 49.74 ドルとなります。 この例に示した種類のインスタンスについては、予約購入のメリットはないと考えられます。 次の図を参照してください。

![Azure VM の損益分岐点の例](./media/tutorial-optimize-reserved-instances/azure04.png)

## <a name="view-ri-costs"></a>RI のコストを確認する

予約の支払いは、その購入時に 1 回限り行います。 Cloudyn では、次の 2 とおりの方法で支払いを表示できます。

- 実績コスト
- 償却コスト

### <a name="actual-reserved-instance-cost"></a>予約インスタンスの実績コスト

Actual Cost Analysis (実績コスト分析) レポートと Analysis Over Time (時系列分析) レポートには、予約にあたって支払った全額が、購入月を起点として表示されます。 これにより、特定の期間における実際の支出を確認することができます。

Cloudyn ポータルで **[コスト]** > **[コスト分析]** の順に移動し、**[Actual Cost Analysis]\(実績コスト分析\)** または **[Actual Cost Over Time]\(時系列実績コスト\)** を選択します。 次に、フィルターを設定します。 たとえば、Azure/VM サービスだけをフィルターで抽出し、リソースの種類や価格モデルでグループ化することができます。 次の図を参照してください。

![予約インスタンスの実績コストの例](./media/tutorial-optimize-reserved-instances/azure05.png)

次の図に示したように、サービス (この例では **Azure/VM**) でフィルタリングしたり、**[価格モデル]** や **[リソースの種類]** でグループ化したりすることができます。

![価格モデルやリソースの種類でグループ化された実績コスト レポートのグループとフィルターの例](./media/tutorial-optimize-reserved-instances/azure06.png)

1 回限りの料金、使用料、ライセンス料など、支払いの種類を分析することもできます。

### <a name="amortized-reserved-instance-cost"></a>予約インスタンスの償却コスト

前払いした料金は、RI の購入月に表示されます。 それ以降の請求書には表示されません。 したがって、毎月の使用に注目すると正確な情報が得られない可能性があります。 月ごとの実際のコストは、毎月の使用料と、過去に一括で支払った料金を比例配分 (償却) した額との合計になります。 その実態は、Amortized Cost (償却コスト) レポートで把握することができます。

予約インスタンスの償却コストは、予約の 1 回限りの料金を予約期間にわたって償却することで計算されます。 実績コスト レポートでは、1 回限りの料金が予約の購入月に表示されます。 日単位や月単位の支出は、デプロイの実績コストには表示されません。 時間経過に伴うデプロイの実績コストは、Amortized Cost (償却コスト) レポートに表示されます。  償却コスト レポートが、実際のコストの傾向を確認する唯一の手段となります。 また、将来の支出を予測する唯一の手段でもあります。

Actual Cost (実績コスト) レポートを見ると、11 月 16 日にコストの急増が見られます。これは、RI の購入に費やされた 747 ドルに対応するものです。 償却コスト レポート (次の図を参照) を見ると、11 月 16 日に、その日の端数分のコストが発生しています。 11 月 17 日からは、償却後の RI コスト 2.05 ドル (= 747/365) が確認できます。 ちなみに、購入済みの予約が未使用になっていることから、別の VM サイズに切り替えることで最適化できることがわかります。

このレポートを表示するには、**[コスト]** > **[コスト分析]** に移動し、**[Amortized Cost Analysis]\(償却コスト分析\)** または **[Amortized Cost Over Time]\(時系列償却コスト\)** を選択します。

![償却された予約インスタンス コストを示すレポートの例](./media/tutorial-optimize-reserved-instances/azure07.png)

## <a name="optimize-aws-ri-costs"></a>AWS RI のコストを最適化する

予約インスタンスは、自由に利用できるコミットメントです。 長期にわたって継続的に VM を使用する場合、予約インスタンスは、オンデマンドのインスタンスに比べて費用が安く抑えられるため、その有益性が発揮されます。 ただし、その使用が一定の水準を満たしていなければなりません。 ここでいうコミットメントとは、所定の期間 (1 年または 3 年)、リソース (通常は VM) を使用することをいいます。 購入すると確約するとき、予約によってリソースの対価を前払いすることになります。 しかし、予約の中で確約した水準まで常に使用するとは限りません。

たとえば、環境の評価を行った結果、過去 1 年間にわたって Standard D2 インスタンスを 20 個、絶えず実行していたことが判明したとします。 その分を予約購入していれば、大幅なコスト削減効果が得られた可能性があります。 また別の例として、MA4 インスタンスを年間 10 個使用すると確約したとします。 しかし、これまで使用したのは、たった 5 つ、ということも考えられます。 どちらも、RI の使用不足のよい例です。 Cloudyn 最適化レポートでは、次の 2 とおりの方法で予約インスタンスのコストを最適化することができます。

- 購入すべき内容に関して、使用履歴に基づいて提案される推奨情報を確認する
- 未使用の予約に変更を加える

"_EC2 RI Buying Recommendations (EC2 RI 購入の推奨情報)_" レポートおよび "_EC2 Currently Unused Reservations (EC2 の現在未使用の予約)_" レポートを利用すると、占有インスタンス使用量とコストを改善することができます。

## <a name="buy-recommended-ris"></a>推奨される RI を購入する

Cloudyn では、オンデマンド インスタンスの使用量が比較され、予約インスタンスを使用した場合の効果と対比されます。 コスト削減効果が見込めると判断された場合、EC2 Buying Recommendations (EC2 購入推奨情報) レポートに推奨情報が表示されます。

ポータルの上部にあるレポート メニューで、**[オプティマイザー]** > **[Pricing Optimization]\(価格の最適化\)** > **[EC2 RI Buying Recommendations]\(EC2 RI 購入の推奨情報\)** の順にクリックします。

次の図は、レポートから提示された購入の推奨情報を示しています。

![EC2 購入推奨情報レポートの購入推奨情報を示す例](./media/tutorial-optimize-reserved-instances/aws01.png)

この例では、Cloudyn\_A アカウントに関して、予約インスタンスの購入推奨情報が 32 件表示されています。 購入の推奨情報にすべて従った場合、年間 137,770 ドルのコスト削減効果を見込むことができます。 Cloudyn から提示される購入の推奨情報は、実行中のワークロードの使用量が今後も変わらないことを前提としています。

それぞれの購入が推奨される理由について詳細な情報を確認するには、**[Justifications]\(理由\)** の正符号 ( **+** ) をクリックします。 次に示したのは、一覧に表示される最初の推奨情報の例です。

![購入理由詳細を示す例](./media/tutorial-optimize-reserved-instances/aws02.png)

この例では、ワークロードをオンデマンドで実行した場合、年間 90,456 ドルかかることが示されています。 一方、事前に予約購入した場合、同じワークロードでもコストは 56,592 ドルと、年間 33,864 ドルのコスト削減効果が得られます。

**[EC2 RI Purchase Impact]\(EC2 RI 購入の影響\)** の横の正符号をクリックすると、1 年間にわたる損益分岐点が表示され、購入の投資効果が得られるおおよその時期を把握できます。 次の例では、購入から約 8 か月間が経過すると、オンデマンドの累積コストが、RI の累積コストを上回り始めます。

![購入の影響詳細を示す例](./media/tutorial-optimize-reserved-instances/aws03.png)

コスト削減効果が現れるのは、その時点からになります。

提示された購入の推奨情報の正確性は、**[Instances over Time]\(時系列インスタンス数\)** を見て確認できます。 この例では、過去 30 日間、平均で 6 つのインスタンスがワークロードに使用されていることを確認できます。

![時系列のインスタンス使用履歴を示す例](./media/tutorial-optimize-reserved-instances/aws04.png)

## <a name="modify-unused-reservations"></a>未使用の予約に変更を加える

予約が未使用になることは、多くのクラウド リソース コンシューマーのコンピューティング環境でよくあることです。 現在の要件を満たすように予約に変更を加え、未使用の予約を完全に使い切ることができれば、コストを節約することができます。 たとえば所有するサブスクリプションに、Linux 上で実行される Standard D3 インスタンスが含まれているとします。 予約をフルに活用する見込みがないのであれば、インスタンスの種類を変更することができます。 または、未使用のリソースを別の予約や別のアカウントに移動することもできます。

AWS は、特定の可用性ゾーンおよびリージョンを対象に予約インスタンスを販売しています。 特定の可用性ゾーンを対象とした予約インスタンスを購入した場合、ゾーン間で予約を移動することはできません。 ただし、リージョンの予約インスタンスについては、**EC2 Currently Unused Reservations (EC2 の現在未使用の予約)** レポートを使用してゾーン間で簡単に移動することができます。 または、範囲をリージョンに変更する方法もあります。その場合、該当するインスタンスがすべての可用性ゾーンにわたって適用されます。

ポータル上部のレポート メニューで、**[Optimizer]\(オプティマイザー\)** > **[Inefficiencies]\(非効率\)** > **[EC2 Currently Unused Reservations]\(EC2 の現在未使用の予約\)** をクリックします。

次の図は、未使用の予約インスタンスを含んだレポートを示しています。

![未使用予約に関するまとめ情報を示す例](./media/tutorial-optimize-reserved-instances/unused-ri01.png)

**[詳細]** の正符号をクリックすると、特定の予約の詳細が表示されます。

![未使用予約の詳細を示す例](./media/tutorial-optimize-reserved-instances/unused-ri02.png)

この例では、未使用の予約が、さまざまな可用性ゾーンに合計 77 個存在します。 1 つ目の予約には、未使用のインスタンスが 51 個あります。 この一覧の下の方を見てみると、**us-east-1c** 可用性ゾーンの **m3.2xlarge** タイプのインスタンスを使って行うことができる予約インスタンスの変更案が表示されています。

一覧の 1 つ目の予約について **[変更]** をクリックすると、**[Modify RI]\(RI の変更\)** ページが開いて、予約についてのデータが表示されます。

![変更可能予約を示す例](./media/tutorial-optimize-reserved-instances/unused-ri03.png)

変更可能な予約インスタンスが一覧表示されます。 次の例に示す図では、変更可能な未使用の予約は 51 個ですが、2 つの予約で 54 個必要です。 未使用の予約をすべて使い切るように変更した場合、4 つのインスタンスは引き続きオンデマンドで実行されます。 この例では、未使用の予約を 2 分割し、1 つ目の予約で 30 個、2 つ目の予約で 21 個使用するようにします。

1 つ目の予約のエントリに表示されている正符号をクリックして、**[Reservation quantity]\(予約数量\)** を「**30**」に設定します。 2 つ目のエントリについては、予約数量を「**21**」に設定し、**[適用]** をクリックします。

![予約数量変更を示す例](./media/tutorial-optimize-reserved-instances/unused-ri04.png)

この予約に関して未使用になっていたインスタンスをすべて使い切ることができました。今後、51 インスタンスがオンデマンドで実行されることはありません。 この例では、オンデマンドの使用を大幅に削減し、支払い済みの予約を使用することで、所属する組織のコストを削減することができました。

## <a name="next-steps"></a>次の手順

このチュートリアルでは、以下のタスクを完了しました。

> [!div class="checklist"]
> * Azure RI のコストを理解する
> * RI の利点について知る
> * Azure RI のコストを最適化する
> * RI のコストを確認する
> * Azure RI の費用対効果を評価する
> * AWS RI のコストを最適化する
> * 推奨される RI を購入する
> * 未使用の予約に変更を加える


次のチュートリアルに進み、データへのアクセスの制御について学習してください。

> [!div class="nextstepaction"]
> [データへのアクセスを制御する](tutorial-user-access.md)
