---
title: メッセージをグループとしてバッチ処理する
description: Azure Logic Apps でバッチ処理を使用して、ワークフローの間でグループ内のメッセージを送受信します
services: logic-apps
ms.suite: integration
author: divyaswarnkar
ms.author: divswa
ms.reviewer: estfan, jonfan, logicappspm
ms.topic: article
ms.date: 01/16/2019
ms.openlocfilehash: e48d2bb2ffce0dd4f9293417534165165d426784
ms.sourcegitcommit: ff9688050000593146b509a5da18fbf64e24fbeb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/06/2020
ms.locfileid: "75666756"
---
# <a name="send-receive-and-batch-process-messages-in-azure-logic-apps"></a>Azure Logic Apps でのメッセージの送信、受信、バッチ処理

一連のメッセージを特定の方法でまとめて送信、処理するためには、バッチ処理ソリューションを作成します。メッセージは "*バッチ*" として収集され、指定した条件が満たされた時点で、1 つにまとめられたメッセージがリリースされて処理されます。 バッチ処理を使うことで、ロジック アプリによるメッセージ処理の頻度を下げることができます。 この記事では、バッチ処理ソリューションの構築方法について説明します。同じ Azure サブスクリプション、同じ Azure リージョン内に、次の順序で 2 つのロジック アプリを作成します。 

* ["バッチ受信"](#batch-receiver) ロジック アプリ。メッセージをリリースして処理する条件を指定しておくと、その条件が満たされるまでメッセージを受け取り、バッチとして収集します。

  バッチ送信アプリを作成するときにバッチの送信先を選ぶことができるよう、必ずバッチ受信アプリを先に作成してください。

* ["バッチ送信"](#batch-sender) ロジック アプリ (1 つまたは複数)。先に作成しておいたバッチ受信アプリにメッセージを送信します。 

   また、顧客番号など一意のキーを指定して、そのキーに基づいてターゲット バッチを論理上のサブセットに "*パーティション*" (分割) することもできます。 こうすることで受信アプリは、同じキーのアイテムをすべて収集し、まとめて処理することができます。

バッチ受信アプリとバッチ送信アプリは、同じ Azure サブスクリプションを共有し、"*なおかつ*" 同じ Azure リージョンを共有している必要があります。 異なる場合は互いを認識できず、バッチ送信アプリを作成するときにバッチ受信アプリを選択できません。

## <a name="prerequisites"></a>前提条件

この例に従うには、次の項目が必要です。

* Azure サブスクリプション。 Azure サブスクリプションがない場合は、[無料の Azure アカウントで作業を開始](https://azure.microsoft.com/free/)できます。 また、[従量課金制サブスクリプション](https://azure.microsoft.com/pricing/purchase-options/)にサインアップすることもできます。

* 任意の [Azure Logic Apps でサポートされる電子メール プロバイダー](../connectors/apis-list.md)の電子メール アカウント

* [ロジック アプリの作成方法](../logic-apps/quickstart-create-first-logic-app-workflow.md)に関する基本的な知識 

* Azure portal ではなく Visual Studio を使う場合は、[Logic Apps と連携するように Visual Studio を設定](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md)してください。

<a name="batch-receiver"></a>

## <a name="create-batch-receiver"></a>バッチ受信アプリの作成

バッチにメッセージを送信するには、その送信先となるバッチがあらかじめ存在していなければなりません。 そのためまず、**Batch** トリガーを開始する "バッチ受信" ロジック アプリを作成する必要があります。 そうすることで、"バッチ送信" ロジック アプリを作成するときに、そのバッチ受信ロジック アプリを選択することができます。 メッセージをリリースして処理する条件を指定しておくと、バッチ受信アプリは、その条件が満たされるまでメッセージを収集し続けます。 バッチ受信アプリは、バッチ送信アプリについての情報を一切必要としませんが、バッチ送信アプリには、どこにメッセージを送信すべきかの情報が必要です。 

1. [Azure portal](https://portal.azure.com) または Visual Studio で、"BatchReceiver" という名前のロジック アプリを作成します。 

2. Logic Apps デザイナーで、ロジック アプリのワークフローを開始する**バッチ** トリガーを追加します。 検索ボックスに、フィルターとして「batch」と入力します。 トリガーとして、**メッセージのバッチ処理**

   !["メッセージのバッチ処理" トリガーの追加](./media/logic-apps-batch-process-send-receive-messages/add-batch-receiver-trigger.png)

3. バッチ受信アプリに以下のプロパティを設定します。 

   | プロパティ | [説明] | 
   |----------|-------------|
   | **バッチ モード** | - **インライン**:リリース条件をバッチ トリガー内に定義する場合に使用します。 <br>- **統合アカウント**:[統合アカウント](../logic-apps/logic-apps-enterprise-integration-create-integration-account.md)を通じてリリース条件の構成を複数定義する場合に使用します。 統合アカウントであれば、これらの構成をすべて 1 か所で保持することができ、別個のロジック アプリに分ける必要はありません。 | 
   | **バッチ名** | バッチの名前 (この例では "TestBatch")。**インライン** バッチ モードにのみ適用されます。 |  
   | **リリース条件** | **インライン** バッチ モードにのみ適用されます。個々のバッチを処理する前に満たすべき条件を選択します。 <p>- **メッセージ数ベース**:バッチによって収集されたメッセージの数に基づいてバッチをリリースします。 <br>- **サイズ ベース**:そのバッチによって収集されたすべてのメッセージの合計サイズ (バイト) に基づいてバッチをリリースします。 <br>- **スケジュール**:間隔と頻度を指定する定期的なスケジュールに基づいてバッチをリリースします。 詳細オプションでは、タイム ゾーンを選択し、開始日時を指定することもできます。 <br>- **すべて選択**:指定した条件をすべて使用します。 | 
   | **メッセージ数** | バッチとして収集するメッセージの数 (10 件など)。 バッチの制限は、8,000 メッセージです。 | 
   | **バッチ サイズ** | バッチで収集する合計サイズ (10 MB など)。 バッチ サイズの上限は 80 MB です。 | 
   | **[スケジュール]** | バッチをリリースする間隔と頻度 (10 分など)。 最小間隔は 60 秒 (1 分) です。 分の小数値は 1 分単位に切り上げられます。 タイム ゾーンまたは開始日時を指定するには、 **[詳細オプションを表示する]** を選択します。 | 
   ||| 

   > [!NOTE]
   > 
   > バッチ処理はしたが未送信のメッセージがトリガーにまだある間に、リリース条件を変更すると、そのトリガーでは、未送信のメッセージを処理するために、更新されたリリース条件が使用されます。 

   この例では、すべての条件を示していますが、ご自分のテストを行う場合は、条件を 1 つだけ試してください。

   ![バッチ トリガーの詳細を指定する](./media/logic-apps-batch-process-send-receive-messages/batch-receiver-criteria.png)

4. それぞれのバッチを処理するアクションを少なくとも 1 つ追加します。 

   この例では、バッチ トリガーが起動したときにメールを送信するアクションを追加します。 
   バッチのメッセージが 10 件に達するか、10 MB に達するか、または 10 分が経過すると、トリガーが作動してメールが送信されます。

   1. バッチ トリガーで、 **[新しいステップ]** を選択します。

   2. 検索ボックスに、フィルターとして「send email」と入力します。
   電子メール プロバイダーに基づいて、電子メール コネクタを選択します。

      たとえば個人用アカウント (@outlook.com、@hotmail.com など) がある場合、Outlook.com コネクタを選択します。 
      Gmail アカウントがある場合は、Gmail コネクタを選択します。 
      この例では Office 365 Outlook を使います。 

   3. このアクションを選択: **[電子メールの送信 - <*電子メール プロバイダー*>]**

      次に例を示します。

      ![電子メール プロバイダーの "電子メールの送信" アクションを選択する](./media/logic-apps-batch-process-send-receive-messages/batch-receiver-send-email-action.png)

5. メッセージに従ってメール アカウントにサインインします。 

6. 追加したアクションのプロパティを設定します。

   * **[宛先]** ボックスに、受信者の電子メール アドレスを入力します。 
   テスト目的で自分の電子メール アドレスを使用できます。

   * **[件名]** ボックスで、動的なコンテンツの一覧が表示されたら、 **[パーティション名]** フィールドを選択します。

     ![動的なコンテンツの一覧で [パーティション名] を選択する](./media/logic-apps-batch-process-send-receive-messages/send-email-action-details.png)

     後のバッチ送信アプリで、ターゲット バッチを分割する一意のパーティション キーを指定し、分割された論理上のサブセットにメッセージを送信することができます。 
     各セットにはバッチ送信ロジック アプリで生成された固有の番号があります。 
     この機能により複数のサブセットを持つ単一のバッチを使用できるようになり、各サブセットを指定した名前で定義できます。

     > [!IMPORTANT]
     > パーティションには 5,000 メッセージまたは 80 MB という制限があります。 どちらかの条件が満たされた場合、ユーザーによって定義されたリリース条件が満たされていなくても、Logic Apps はバッチをリリースします。

   * **[本文]** ボックスで、動的なコンテンツの一覧が表示されたら、 **[メッセージ ID]** フィールドを選択します。 

     Logic Apps デザイナーでは、電子メール送信アクションを囲む "For each" ループが自動的に追加されます。これは、そのアクションで、前のアクションの出力をバッチではなくコレクションとして処理するためです。 

     ![[本文] で [メッセージ ID] を選択する](./media/logic-apps-batch-process-send-receive-messages/send-email-action-details-for-each.png)

7.  ロジック アプリを保存します。 バッチ受信アプリの作成は以上です。

    ![ロジック アプリを保存する](./media/logic-apps-batch-process-send-receive-messages/save-batch-receiver-logic-app.png)

8. Visual Studio を使用している場合、[バッチ受信ロジック アプリを Azure にデプロイ](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md#deploy-logic-app-to-azure)する必要があります。 そうしないと、バッチ送信アプリを作成するときにバッチ受信アプリを選択できません。

<a name="batch-sender"></a>

## <a name="create-batch-sender"></a>バッチ送信アプリの作成

次に、バッチ受信ロジック アプリにメッセージを送信するバッチ送信ロジック アプリを作成します。 バッチ送信アプリにはそれぞれ、バッチ受信アプリ、バッチ名、メッセージ コンテンツなど各種の設定を指定します。 一意のパーティション キーを指定してバッチを論理上のサブセットに分割し、そのキーを持つメッセージを収集するように設定することもできます。 

* バッチ送信アプリを作成するときに、その送信先バッチとして既存のバッチ受信アプリを選択できるよう、必ず[バッチ受信アプリ](#batch-receiver)を先に作成してください。 バッチ受信アプリは、バッチ送信アプリについての情報を一切必要としませんが、バッチ送信アプリには、どこにメッセージを送信すべきかの情報が必要です。 

* バッチ受信アプリとバッチ送信アプリは、同じ Azure リージョンを共有し、"*なおかつ*" 同じ Azure サブスクリプションを共有している必要があります。 異なる場合は互いを認識できず、バッチ送信アプリを作成するときにバッチ受信アプリを選択できません。

1. 次の名前の別のロジック アプリを作成します:"BatchSender"

   1. 検索ボックスに、フィルターとして「recurrence」と入力します。 
   トリガーとして、 **[定期的なスケジュール]** を選択します。

      !["定期的なスケジュール" トリガーの追加](./media/logic-apps-batch-process-send-receive-messages/add-schedule-trigger-batch-sender.png)

   2. 送信ロジック アプリの実行頻度と間隔を毎分に設定します。

      ![繰り返しトリガーの頻度と間隔を設定する](./media/logic-apps-batch-process-send-receive-messages/recurrence-trigger-batch-sender-details.png)

2. メッセージをバッチに送信する新しいアクションを追加します。

   1. 繰り返しトリガーで、 **[新しいステップ]** を選択します。

   2. 検索ボックスに、フィルターとして「batch」と入力します。 
   **[アクション]** リストを選択し、 **[バッチ トリガーを含む Logic Apps ワークフローを選択します - バッチ処理するメッセージの送信]** アクションを選択します。

      ![[バッチ トリガーを含む Logic Apps ワークフローを選択します] を選択します](./media/logic-apps-batch-process-send-receive-messages/send-messages-batch-action.png)

   3. あらかじめ作成しておいたバッチ受信ロジック アプリを選択します。

      !["バッチ受信" ロジック アプリを選択する](./media/logic-apps-batch-process-send-receive-messages/batch-sender-select-batch-receiver.png)

      > [!NOTE]
      > 一覧にはバッチ トリガーがあるその他のロジック アプリも表示されます。 
      > 
      > Visual Studio を使用している場合、選択するバッチ受信アプリが表示されないときは、バッチ受信アプリが Azure にデプロイ済みであることを確認してください。 まだ済んでいない場合は、[バッチ受信ロジック アプリを Azure にデプロイ](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md#deploy-logic-app-to-azure)する方法を確認してください。 

   4. このアクションを選択: **[メッセージのバッチ処理 - <*your-batch-receiver*>]**

      ![このアクションを選択: [メッセージのバッチ処理 - <your-logic-app>]](./media/logic-apps-batch-process-send-receive-messages/batch-sender-select-batch.png)

3. バッチ送信アプリのプロパティを設定します。

   | プロパティ | [説明] | 
   |----------|-------------| 
   | **バッチ名** | 受信ロジック アプリによって定義されたバッチ名 (この例では "TestBatch") <p>**重要**:バッチ名は実行時に検証されます。また、受信ロジック アプリによって指定された名前と一致している必要があります。 バッチ名を変更すると、バッチ送信アプリが失敗します。 | 
   | **メッセージのコンテンツ** | 送信するメッセージのコンテンツ。 | 
   ||| 

   この例では、次の式を追加します。この場合、バッチに送信するメッセージのコンテンツには、現在の日付と時刻が挿入されます。

   1. **[メッセージのコンテンツ]** ボックス内をクリックします。 

   2. 動的コンテンツ リストが表示されたら **[式]** を選択します。 

   3. `utcnow()` という式を入力し、 **[OK]** を選択します。 

      ![[メッセージのコンテンツ] で [式] を選択し、「utcnow()」と入力して [OK] を選択します。](./media/logic-apps-batch-process-send-receive-messages/batch-sender-details.png)

4. ここでバッチのパーティションを設定します。 "BatchReceiver" アクションで、 **[詳細オプションの表示]** を選択し、次のプロパティを設定します。

   | プロパティ | [説明] | 
   |----------|-------------| 
   | **パーティション名** | (省略可能) 一意のパーティション キー。ターゲット バッチを論理上のサブセットに分割し、対応するキーに基づいてメッセージを収集する目的で使用されます。 | 
   | **メッセージ ID** | (省略可能) メッセージ ID。空のときは、生成されたグローバル一意識別子 (GUID) になります。 | 
   ||| 

   この例では、1 から 5 の範囲の乱数を生成する式を **[パーティション名]** ボックスに追加しています。 **[メッセージ ID]** ボックスは空のままにしてください。
   
   1. **[パーティション名]** ボックス内をクリックして、動的コンテンツ リストを表示します。 

   2. 動的コンテンツ リストの **[式]** を選択します。
   
   3. `rand(1,6)` という式を入力し、 **[OK]** を選択します。

      ![ターゲット バッチのパーティションをセットアップする](./media/logic-apps-batch-process-send-receive-messages/batch-sender-partition-advanced-options.png)

      この **rand** 関数は 1 から 5 の間の数字を生成します。 
      これにより、この式が動的に設定した 5 つの番号のパーティションにこのバッチが分割されます。

5. ロジック アプリを保存します。 送信ロジック アプリは次の例のようになります。

   ![送信ロジック アプリを保存する](./media/logic-apps-batch-process-send-receive-messages/batch-sender-finished.png)

## <a name="test-your-logic-apps"></a>ロジック アプリをテストする

バッチ ソリューションをテストするには、数分間ロジック アプリを実行したままにします。 間もなく、同じパーティション キーを持つ電子メールを 5 個ずつ取得し始めます。

バッチ送信ロジック アプリは毎分実行され、1 から 5 の間の数字をランダムに生成し、この生成された番号をメッセージが送信されるターゲット バッチのパーティション キーとして使用します。 バッチに同じパーティション キーの項目が 5 つ入るたびにバッチ受信ロジック アプリが作動し、各メッセージについてメールを送信します。

> [!IMPORTANT]
> テストが完了したら、BatchSender ロジック アプリを無効にしてメッセージの送信を停止し、受信トレイのオーバーロードを防止します。

## <a name="next-steps"></a>次のステップ

* [EDI メッセージのバッチ処理と送信](../logic-apps/logic-apps-scenario-edi-send-batch-messages.md)
* [JSON を使用してロジック アプリの定義に基づいて構築する](../logic-apps/logic-apps-author-definitions.md)
* [Azure Logic Apps と関数を使用して Visual Studio でサーバーレス アプリを構築する](../logic-apps/logic-apps-serverless-get-started-vs.md)
* [ロジック アプリの例外処理とエラーのログ記録](../logic-apps/logic-apps-scenario-error-and-exception-handling.md)
