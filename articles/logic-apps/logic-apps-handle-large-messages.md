---
title: チャンクを使用して大きいサイズのメッセージを処理する
description: Azure Logic Apps で作成する自動化されたタスクとワークフローで、チャンクを使用して大きいサイズのメッセージを処理する方法について説明します
services: logic-apps
ms.suite: integration
author: DavidCBerry13
ms.author: daberry
ms.topic: article
ms.date: 12/03/2019
ms.openlocfilehash: 54828dded5196c86946d99a9cd8cec7a42533661
ms.sourcegitcommit: a8ee9717531050115916dfe427f84bd531a92341
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/12/2020
ms.locfileid: "83117565"
---
# <a name="handle-large-messages-with-chunking-in-azure-logic-apps"></a>Azure Logic Apps でチャンクを使用して大きいサイズのメッセージを処理する

メッセージを処理する場合、Logic Apps では、メッセージのコンテンツの最大サイズを制限しています。 この制限によって、大きいサイズのメッセージの格納と処理によって発生するオーバーヘッドを削減できます。 この制限を超えるメッセージを処理するため、Logic Apps では、大きいサイズのメッセージを小さいサイズのメッセージに*チャンク*できます。 これにより、特定の条件下で Logic Apps を使用して大きいサイズのファイルを転送できます。 コネクタまたは HTTP 経由で他のサービスと通信する場合、Logic Apps は、サイズの大きいメッセージを使用できますが、チャンク単位で*のみ*使用できます。 この条件は、コネクタもチャンクをサポートしている必要があること、または Logic Apps とこれらのサービス間の HTTP メッセージ交換でチャンクを使用する必要があることを意味します。

この記事では、制限を超えるサイズのメッセージを処理するアクションのチャンクを設定する方法を示します。 複数のメッセージの交換によってオーバーヘッドが増加するため、Logic App の トリガーではチャンクはサポートされません。 

## <a name="what-makes-messages-large"></a>"大きいサイズ" のメッセージとは何か

メッセージは、それらのメッセージを処理するサービスに基づいて "大きいサイズ" になります。 大きいサイズのメッセージの正確なサイズ制限は、Logic Apps とコネクタによって異なります。 Logic Apps とコネクタは、どちらも大きいサイズのメッセージを直接使用できないため、メッセージのチャンクが必要になります。 Logic Apps のメッセージ サイズ制限については、「[Logic Apps の制限と構成](../logic-apps/logic-apps-limits-and-config.md)」を参照してください。
各コネクタのメッセージ サイズの制限については、[コネクタの特定の技術的な詳細](../connectors/apis-list.md)を参照してください。

### <a name="chunked-message-handling-for-logic-apps"></a>Logic Apps でのチャンクされたメッセージの処理

Logic Apps は、メッセージ サイズの制限を超えているチャンクされたメッセージの出力を直接使用できません。 これらの出力に含まれるメッセージのコンテンツは、チャンクをサポートするアクションのみがアクセスできます。 そのため、大きいサイズのメッセージを処理するアクションは、次の条件の "*いずれか*" を満たす必要があります。

* そのアクションがコネクタに属している場合は、チャンクをネイティブにサポートしている。 
* そのアクションの実行時構成で、チャンクのサポートが有効になっている。 

それ以外の場合、大きいサイズのコンテンツの出力にアクセスしようとすると、ランタイム エラーが発生します。 チャンクを有効にするには、[チャンクのサポートの設定](#set-up-chunking)を参照してください。

### <a name="chunked-message-handling-for-connectors"></a>コネクタでのチャンクされたメッセージの処理

Logic Apps と通信するサービスが、独自のメッセージ サイズの制限を持っている可能性があります。 多くの場合、これらの制限は、Logic Apps の制限よりも小さくなります。 たとえば、コネクタがチャンクをサポートしていることを前提として、コネクタは、30 MB のメッセージを大きいサイズのメッセージとみなす場合がありますが、Logic Apps では、これは大きいサイズのメッセージではありません。 このコネクタの制限を守るために、Logic Apps は、30 MB を超えるメッセージ を小さいチャンクに分割します。

チャンクをサポートするコネクタでは、エンドユーザーがチャンク プロトコルを認識することはありません。 ただし、すべてのコネクタがチャンクをサポートしているわけではないため、これらのコネクタでは、受信したメッセージがコネクタのサイズ制限を超えた場合は実行時エラーが生成されます。

> [!NOTE]
> チャンクを使用するアクションでは、トリガー本体を渡すことはできず、またそれらのアクションで `@triggerBody()?['Content']` などの式を使用することもできません。 代わりに、テキストまたは JSON ファイルのコンテンツに対して、[**作成**アクション](../logic-apps/logic-apps-perform-data-operations.md#compose-action)を使用したり、または[変数を作成](../logic-apps/logic-apps-create-variables-store-values.md)してそのコンテンツを処理したりすることができます。 トリガー本体にメディア ファイルなどの他のコンテンツの種類が含まれている場合は、そのコンテンツを処理するために他の手順を実行する必要があります。

<a name="set-up-chunking"></a>

## <a name="set-up-chunking-over-http"></a>HTTP 経由でのチャンクの設定

一般的な HTTP シナリオでは、大きいサイズのコンテンツのダウンロードとアップロードを HTTP 経由で分割できるため、ロジック アプリとエンドポイントで大きいサイズのメッセージを交換できます。 ただし、Logic Apps が想定するようにメッセージをチャンクする必要があります。 

エンドポイントでダウンロードまたはアップロード時のチャンクが有効になっている場合、ロジック アプリ内の HTTP アクションは、大きいサイズのメッセージを自動的にチャンクします。 それ以外の場合は、エンドポイントにチャンクのサポートを設定する必要があります。 エンドポイントまたはコネクタを所有も管理もしていない場合は、チャンクを設定するオプションがないことがあります。

また、HTTP アクションがチャンクを既に有効にしていない場合は、アクションの `runTimeConfiguration` プロパティにチャンクを設定する必要があります。 このプロパティは、後述するようにコード ビュー エディターでアクション内に直接設定するか、次の説明に従って Logic Apps デザイナーで設定できます。

1. HTTP アクションの右上隅の省略記号ボタン ( **.** ) を選択し、 **［設定］** を選択します。

   ![アクションの [設定] メニューを開く](./media/logic-apps-handle-large-messages/http-settings.png)

2. **[コンテンツ転送]** で、 **[チャンクの許可]** を **[On]** に設定します。

   ![チャンクをオンにする](./media/logic-apps-handle-large-messages/set-up-chunking.png)

3. ダウンロードまたはアップロードでのチャンクの設定を続行するには、次のセクションに進みます。

<a name="download-chunks"></a>

## <a name="download-content-in-chunks"></a>コンテンツをチャンクでダウンロードする

多くのエンドポイントは、HTTP GET 要求に応じてダウンロードを行うときに、大きいサイズのメッセージを自動的にチャンクで送信します。 チャンクされたメッセージをエンドポイントから HTTP 経由でダウンロードするには、エンドポイントがコンテンツの部分要求 ("*チャンク ダウンロード*") をサポートしている必要があります。 ロジック アプリが、コンテンツをダウンロードするためにエンドポイントに HTTP GET 要求を送信すると、エンドポイントは状態コード "206" を返して、応答にチャンクされたコンテンツが含まれていることを示します。 Logic Apps は、エンドポイントが部分要求をサポートするかどうかを制御することはできません。 ただし、ロジック アプリは、最初の "206" 応答を取得した場合は、複数の要求を自動的に送信して、すべてのコンテンツをダウンロードします。

エンドポイントが部分コンテンツをサポートできるかどうかを確認するには、HEAD 要求を送信します。 この要求によって、応答に `Accept-Ranges` ヘッダーが含まれているかどうかを確認できます。 この方法により、エンドポイントがチャンクされたダウンロードをサポートしているが、チャンクされたコンテンツを送信しない場合は、HTTP GET 要求の中に  *ヘッダーを設定することで、このオプションを "* 推奨`Range`" できます。 

次の手順は、チャンクされたコンテンツをエンドポイントからロジック アプリにダウンロードするために Logic Apps が使用する詳細なプロセスを示しています。

1. ロジック アプリがエンドポイントに HTTP GET 要求を送信します。

   必要に応じて、コンテンツのチャンクを要求するバイト範囲を記述する `Range` フィールドを要求ヘッダーを含めることができます。

2. エンドポイントは、状態コード "206" と HTTP メッセージの本文を返します。

    このチャンクのコンテンツの詳細が、応答の `Content-Range` ヘッダーに含まれます。この中には、Logic Apps がチャンクを開始して終了する範囲に加え、チャンクを行う前にコンテンツ全体の合計サイズを判別するために役立つ情報が含まれます。

3. ロジック アプリは、フォローアップ HTTP GET 要求を自動的に送信します。

    ロジック アプリは、コンテンツ全体が取得されるまで、フォローアップ GET 要求を送信します。

たとえば、次のアクション定義は、`Range` ヘッダーを設定する HTTP GET 要求を示しています。 このヘッダーは、エンドポイントがチャンクされたコンテンツで応答することを "*推奨*" します。

```json
"getAction": {
    "inputs": {
        "headers": {
            "Range": "bytes=0-1023"
        },
       "method": "GET",
       "uri": "http://myAPIendpoint/api/downloadContent"
    },
    "runAfter": {},
    "type": "Http"
}
```

GET 要求は、"Range" ヘッダーを、バイト範囲である "bytes=0-1023" に設定しています。 エンドポイントが部分コンテンツ要求をサポートしている場合、エンドポイントは、要求された範囲のコンテンツのチャンクで応答します。 "Range" ヘッダー フィールドの正確な形式は、エンドポイントによって異なる可能性があります。

<a name="upload-chunks"></a>

## <a name="upload-content-in-chunks"></a>コンテンツをチャンクでアップロードする

HTTP アクションからチャンクされたコンテンツをアップロードするには、アクションの `runtimeConfiguration` プロパティによって、そのアクションでのチャンクのサポートを有効にする必要があります。 この設定は、アクションがチャンク プロトコルを開始することを許可します。 その後、ロジック アプリは、最初の POST または PUT メッセージをターゲット エンドポイントに送信できます。 エンドポイントが推奨されたチャンク サイズで応答した後、ロジック アプリは、コンテンツのチャンクを含む HTTP PATCH 要求を送信することでフォローアップを行います。

次の手順は、チャンクされたコンテンツをロジック アプリからエンドポイントにアップロードするために Logic Apps が使用する詳細なプロセスを示しています。

1. ロジック アプリは、最初の HTTP POST または PUT 要求をメッセージ本文を空にして送信します。 要求ヘッダーには、ロジック アプリがチャンクでアップロードするコンテンツに関する情報が含まれます。

   | Logic Apps の要求ヘッダー フィールド | 値 | 種類 | 説明 |
   |---------------------------------|-------|------|-------------|
   | **x-ms-transfer-mode** | chunked | String | コンテンツがチャンクでアップロードされることを示します |
   | **x-ms-content-length** | <*content-length*> | 整数 | チャンクする前のコンテンツ全体のサイズ (バイト単位) |
   ||||

2. エンドポイントは、成功を示す状態コード "200" と次の省略可能な情報を返します。

   | エンドポイントの応答ヘッダー フィールド | 種類 | 必須 | 説明 |
   |--------------------------------|------|----------|-------------|
   | **x-ms-chunk-size** | 整数 | いいえ | 推奨されたチャンク サイズ (バイト単位) |
   | **Location** | String | はい | HTTP PATCH メッセージを送信する URL の場所 |
   ||||

3. ロジック アプリは、それぞれが次の情報を含む フォローアップ HTTP PATCH メッセージを作成して送信します。

   * **x-ms-content-length** の長さのコンテンツがすべてアップロードされるまでの **x-ms-chunk-size** または内部的に計算されたサイズに基づくコンテンツのチャンク

   * これらのヘッダーには、それぞれの PATCH メッセージで送信されるコンテンツのチャンクの詳細が記述されます。

     | Logic Apps の要求ヘッダー フィールド | 値 | 種類 | 説明 |
     |---------------------------------|-------|------|-------------|
     | **Content-Range** | <*range*> | String | 現在のコンテンツのチャンクのバイト範囲。開始値、終了値、および合計コンテンツ サイズ合計が含まれます。例: "bytes=0-1023/10100" |
     | **Content-Type** | <*content-type*> | String | チャンクされたコンテンツの種類 |
     | **Content-Length** | <*content-length*> | String | 現在のチャンクのサイズ (バイト単位) |
     |||||

4. 各 PATCH 要求の後、エンドポイントでは、"200" 状態コードと次の応答ヘッダーで応答することによって、各チャンクの受信を確認します。

   | エンドポイントの応答ヘッダー フィールド | 種類 | 必須 | 説明 |
   |--------------------------------|------|----------|-------------|
   | **Range** | String | はい | エンドポイントで受信されたコンテンツのバイト範囲。例: "bytes=0-1023" |   
   | **x-ms-chunk-size** | 整数 | いいえ | 推奨されたチャンク サイズ (バイト単位) |
   ||||

たとえば、次のアクション定義は、チャンクされたコンテンツをエンドポイントにアップロードするための HTTP POST 要求を示しています。 アクションの `runTimeConfiguration` プロパティの中で、`contentTransfer` プロパティが `transferMode` を `chunked` に設定しています。

```json
"postAction": {
    "runtimeConfiguration": {
        "contentTransfer": {
            "transferMode": "chunked"
        }
    },
    "inputs": {
        "method": "POST",
        "uri": "http://myAPIendpoint/api/action",
        "body": "@body('getAction')"
    },
    "runAfter": {
    "getAction": ["Succeeded"]
    },
    "type": "Http"
}
```
