---
title: ブロック BLOB のポイントインタイム リストア
titleSuffix: Azure Storage
description: ブロック BLOB のポイントインタイム リストアでは、特定の時点でストレージ アカウントを以前の状態に復元できるようにすることで、誤った削除や破損を防ぐことができます。
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 03/03/2021
ms.author: tamram
ms.subservice: blobs
ms.custom: devx-track-azurepowershell
ms.openlocfilehash: 4e6dac1ab7350caeb29e23b21eace433568b38ea
ms.sourcegitcommit: f3ec73fb5f8de72fe483995bd4bbad9b74a9cc9f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/04/2021
ms.locfileid: "102031635"
---
# <a name="point-in-time-restore-for-block-blobs"></a>ブロック BLOB のポイントインタイム リストア

ポイントインタイム リストアでは、ブロック BLOB データを以前の状態に復元できるようにすることで、誤った削除や破損を防ぐことができます。 ポイントインタイム リストアは、ユーザーまたはアプリケーションによって誤ってデータが削除された場合や、アプリケーション エラーによってデータが破損した場合に役立ちます。 また、ポイントインタイム リストアでは、さらにテストを実行する前にデータセットを既知の状態に戻す必要があるテスト シナリオも有効になります。

ポイントインタイム リストアは、標準パフォーマンス レベルでのみ、汎用 v2 ストレージ アカウントに対してサポートされています。 ポイントインタイム リストアでは、ホットおよびクール アクセス層のデータのみを復元できます。

ストレージ アカウントのポイントインタイム リストアを有効にする方法については、「[ブロック BLOB データに対してポイントインタイム リストアを実行する](point-in-time-restore-manage.md)」を参照してください。

## <a name="how-point-in-time-restore-works"></a>ポイントインタイム リストアのしくみ

ポイントインタイム リストアを有効にするには、ストレージ アカウントの管理ポリシーを作成し、保有期間を指定します。 保有期間中は、ブロック BLOB を現在の状態から前の時点の状態に復元できます。

ポイントインタイム リストアを開始するには、[Restore Blob Ranges](/rest/api/storagerp/storageaccounts/restoreblobranges) 操作を呼び出し、復元ポイントを UTC 時刻で指定します。 復元するコンテナーおよび BLOB の名前の辞書式範囲を指定することも、範囲を省略して、ストレージ アカウントのすべてのコンテナーを復元することもできます。 復元操作ごとに最大 10 個の辞書式範囲がサポートされます。

Azure Storage では、要求された復元ポイント (UTC 時刻で指定) から現在の時点までの間で、指定された BLOB に対して行われたすべての変更が分析されます。 復元操作はアトミックであるため、すべての変更を完全に復元できるか、または失敗します。 復元できない BLOB がある場合、操作は失敗し、影響を受けるコンテナーに対する読み取りと書き込み操作が再開されます。

次の図は、ポイントインタイム リストアがどのように機能するかを示しています。 1 つ以上のコンテナーまたは BLOB 範囲が *n* 日前のその状態に復元されます。ここでは、*n* はポイントインタイム リストアに定義された保有期間の範囲以下になります。 この効果は、保有期間中に発生した書き込みと削除の操作を元に戻すことです。

:::image type="content" source="media/point-in-time-restore-overview/point-in-time-restore-diagram.png" alt-text="ポイントインタイム リストアによってコンテナーを前の状態に復元する方法を示す図":::

ストレージ アカウントで一度に実行できる復元操作は 1 つだけです。 実行中に復元操作を取り消すことはできませんが、最初の操作を元に戻すために 2 番目の復元操作を実行できます。

**Restore Blob Ranges** 操作では、操作を一意に識別する復元 ID が返されます。 ポイントインタイム リストアの状態を確認するには、**Restore Blob Ranges** 操作から返された復元 ID を使用して **Get Restore Status** 操作を呼び出します。

> [!IMPORTANT]
> 復元操作を実行すると、Azure Storage では操作中、復元される範囲内の BLOB に対するデータ操作がブロックされます。 読み取り、書き込み、および削除の各操作がプライマリ ロケーションでブロックされます。 このため、Azure portal でのコンテナーの一覧表示などの操作は、復元操作の実行中に予期したとおりに実行されない場合があります。
>
> ストレージ アカウントが geo レプリケートされている場合は、復元操作中にセカンダリ ロケーションからの読み取り操作を続行できます。

> [!CAUTION]
> ポイントインタイム リストアでは、ブロック BLOB に対する復元操作のみがサポートされます。 コンテナーに対する操作は復元できません。 [Delete Container](/rest/api/storageservices/delete-container) 操作を呼び出してストレージ アカウントからコンテナーを削除した場合、そのコンテナーは復元操作を使って復元できません。 後で復元が必要になる可能性がある場合は、コンテナー全体を削除するのではなく、個々の BLOB を削除してください。

### <a name="prerequisites-for-point-in-time-restore"></a>ポイントインタイム リストアの前提条件

ポイントインタイム リストアを有効にするには、ポイントインタイム リストアで次の Azure Storage 機能が有効になっている必要があります。

- [論理的な削除](./soft-delete-blob-overview.md)
- [変更フィード](storage-blob-change-feed.md)
- [BLOB のバージョン管理](versioning-overview.md)

### <a name="retention-period-for-point-in-time-restore"></a>ポイントインタイム リストアの保有期間

ストレージ アカウントのポイントインタイム リストアを有効にする場合は、保有期間を指定します。 ストレージ アカウントのブロック BLOB は、保有期間中に復元できます。

保有期間は、ポイントインタイム リストアを有効にした数分後に開始されます。 保有期間の開始前に BLOB を状態に復元することはできません。 たとえば、5 月 1 日に保有期間を 30 日に設定してポイントインタイム リストアを有効にした場合、5 月 15 日に最大 15 日間まで復元することができます。 6 月 1 日には、1 - 30 日間のデータを復元できます。

ポイントインタイム リストアの保有期間は、論理的な削除に指定された保有期間よりも 1 日以上短くする必要があります。 たとえば、論理的な削除の保有期間が 7 日間に設定されている場合、ポイントインタイム リストアの保有期間は 1 - 6 日間の範囲で指定できます。

> [!IMPORTANT]
> 一連のデータの復元にかかる時間は、復元期間中に行われた書き込み操作と削除操作の数に基づきます。 たとえば、100 万オブジェクトを持つアカウントで毎日 3,000 オブジェクトが追加され、毎日 1,000 オブジェクトが削除される場合、過去 30 日間のポイントまで復元するのに約 2 時間必要になります。 過去 90 日間の保有期間と復元は、この変更率のアカウントには推奨されません。

### <a name="permissions-for-point-in-time-restore"></a>ポイントインタイム リストアのアクセス許可

復元操作を開始するには、クライアントはストレージ アカウントのすべてのコンテナーに対する書き込みアクセス許可を持っている必要があります。 Azure Active Directory (Azure AD) で復元操作を承認するアクセス許可を付与するには、ストレージ アカウント、リソースグループ、またはサブスクリプションのレベルでセキュリティ プリンシパルに **ストレージ アカウント共同作成者** ロールを割り当てます。

## <a name="limitations-and-known-issues"></a>制限事項と既知の問題

ブロック BLOB のポイントインタイム リストアには、次の制限事項と既知の問題があります。

- ポイントインタイム リストア操作の一部として復元できるのは、標準の汎用 v2 ストレージ アカウントのブロック BLOB のみです。 追加 BLOB、ページ BLOB、Premium ブロック BLOB は復元されません。 
- 保持期間中にコンテナーを削除した場合、そのコンテナーは、ポイントインタイム リストア操作では復元されません。 復元しようとしている BLOB 範囲に、削除されたコンテナー内の BLOB が含まれている場合、ポイントインタイム リストア操作は失敗します。 コンテナーの削除からの保護の詳細については、「[コンテナーの論理的な削除 (プレビュー)](soft-delete-container-overview.md)」を参照してください。
- 現在の時点から復元ポイントまでの間にホット層とクール層の間で BLOB が移動した場合、BLOB は以前の層に復元されます。 アーカイブ層でのブロック BLOB の復元はサポートされていません。 たとえば、ホット層の BLOB が 2 日前にアーカイブ層に移動し、復元操作によって 3 日前の時点に復元された場合、BLOB はホット層に復元されません。 アーカイブされた BLOB を復元するには、最初にアーカイブ層の外に移動します。 詳細については、「[アーカイブ層から BLOB データをリハイドレートする](storage-blob-rehydration.md)」を参照してください。
- [Put Block](/rest/api/storageservices/put-block) または [Put Block from URL](/rest/api/storageservices/put-block-from-url) を使用してアップロードされたが、[Put Block List](/rest/api/storageservices/put-block-list) を使用してコミットされていないブロックは、BLOB の一部ではないため、復元操作の一部としては復元されません。
- アクティブなリースを持つ BLOB は復元できません。 アクティブなリースを持つ BLOB が、復元する BLOB の範囲に含まれている場合、復元操作はアトミックに失敗します。 復元操作を開始する前に、アクティブなリースをすべて中断します。
- スナップショットは、復元操作の一環として作成または削除されません。 ベース BLOB のみが以前の状態に復元されます。
- Azure Data Lake Storage Gen2 のフラット名前空間と階層名前空間の復元はサポートされていません。

> [!IMPORTANT]
> ブロック BLOB を 2020 年 9 月 22 日より前の時点に復元すると、ポイントインタイム リストアのプレビュー制限が有効になります。 一般公開されているポイントインタイム リストア機能を利用するには、2020 年 9 月 22 日以降の復元ポイントを選択することをお勧めします。

## <a name="pricing-and-billing"></a>価格と課金

ポイントインタイム リストアの課金は、復元操作を実行するために処理されるデータの量によって異なります。 処理されるデータの量は、復元ポイントから現在の時点までの間に発生した変更の数に基づいています。 たとえば、ストレージ アカウントのブロック BLOB データの変更数が比較的一定であると仮定した場合、1 日前に戻す復元操作のコストは、10 日前に戻す復元の 1/10 になります。

復元操作のコストを見積もるには、変更フィード ログを確認して、復元期間中に変更されたデータの量を見積もります。 たとえば、変更フィードの保有期間が 30 日間で、変更フィードのサイズが 10 MB の場合、10 日前の時点に復元すると、そのリージョンの LRS アカウントに対して記載されている価格の約 1/3 になります。 27 日前の時点に復元すると、記載されている価格の約 9 分の 1 になります。

ポイントインタイム リストアの価格の詳細については、「[ブロック BLOB の価格](https://azure.microsoft.com/pricing/details/storage/blobs/)」を参照してください。

## <a name="next-steps"></a>次のステップ

- [ブロック BLOB データに対してポイントインタイム リストアを実行する](point-in-time-restore-manage.md)
- [Azure Blob Storage の変更フィードのサポート](storage-blob-change-feed.md)
- [BLOB の論理的な削除を有効にする](./soft-delete-blob-enable.md)
- [BLOB のバージョン管理を有効にして管理する](versioning-enable.md)
