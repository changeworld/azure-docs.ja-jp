---
title: Azure File Sync のクラウドを使った階層化について | Microsoft Docs
description: Azure File Sync のオプション機能であるクラウドを使った階層化について説明します。 頻繁にアクセスするファイルはサーバー上にローカルにキャッシュされ、その他は Azure Files に階層化されます。
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 04/13/2021
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 1f58aa4e2aa4637dfb9fc8b29c52209975e3e367
ms.sourcegitcommit: 4b0e424f5aa8a11daf0eec32456854542a2f5df0
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/20/2021
ms.locfileid: "107796536"
---
# <a name="cloud-tiering-overview"></a>クラウドの階層化の概要
Azure File Sync のオプション機能であるクラウドを使った階層化により、オンプレミスのファイル サーバーのパフォーマンスを維持しながら、必要なローカル ストレージの量を減らすことができます。

この機能を有効にすると、アクセス頻度の高い (ホット) ファイルのみがローカル サーバーに格納されます。 アクセス頻度の低い (クール) ファイルは、名前空間 (ファイルとフォルダーの構造) とファイル コンテンツに分割されます。 名前空間はローカルに保存され、ファイル コンテンツはクラウド内の Azure ファイル共有に格納されます。 

ユーザーが階層化されたファイルを開くと、Azure File Sync によって Azure Files のファイル共有からのファイル データがシームレスに呼び戻されます。

## <a name="how-cloud-tiering-works"></a>クラウドを使った階層化のしくみ

### <a name="cloud-tiering-policies"></a>クラウドを使った階層化のポリシー
クラウドを使った階層化を有効にする場合は、クール ファイルを階層化するタイミングを Azure File Sync に知らせるために設定するポリシーとして、**ボリュームの空き領域ポリシー** および **日付ポリシー** の 2 つのポリシーがあります。 

#### <a name="volume-free-space-policy"></a>ボリュームの空き領域ポリシー
**ボリュームの空き領域ポリシー** は、ローカル ディスク上で一定の容量が使用されている場合に、クール ファイルをクラウドに階層化するように Azure File Sync に指示します。 

たとえば、ローカル ディスク容量が 200 GB であり、少なくとも 40 GB のローカル ディスク容量を常に空けておきたい場合は、ボリュームの空き領域ポリシーを 20% に設定する必要があります。 ボリュームの空き領域は、個々のディレクトリまたはサーバー エンドポイントのレベルではなく、ボリューム レベルで適用されます。 

新しいサーバー エンドポイントが追加されたときに、ボリュームの空き領域ポリシーが、最初にダウンロードしたファイルに与える影響については、「[クラウドを使った階層化に影響する同期ポリシー](#sync-policies-that-affect-cloud-tiering)」セクションを参照してください。

#### <a name="date-policy"></a>日付ポリシー
**日付ポリシー** を使用すると、x 日間アクセスされていない (読み書きされていない) クール ファイルがクラウドに階層化されます。 たとえば、アクセスされずに 15 日以上経過したファイルが通常はアーカイブ ファイルであることがわかった場合は、日付ポリシーを 15 日に設定します。 

日付ポリシーとボリュームの空き領域のポリシーを連携させる方法の例については、[Azure File Sync のクラウドを使った階層化ポリシーの選択](file-sync-choose-cloud-tiering-policies.md)に関するページを参照してください。

### <a name="windows-server-data-deduplication"></a>Windows Server のデータ重複除去
データ重複除去は、Windows Server 2016 以降でクラウドを使った階層化が有効になっているボリュームでサポートされています。 詳細については、「[Azure Files のデプロイの計画](file-sync-planning.md#data-deduplication)」を参照してください。

### <a name="cloud-tiering-heatmap"></a>クラウドを使った階層化のヒートマップ
Azure File Sync は、ファイル アクセス (読み書き操作) を一定期間監視し、アクセス頻度や最近のアクセス状況に応じて、すべてのファイルにヒート スコアを割り当てます。 これらのスコアを使用して、各サーバー エンドポイントで、名前空間の "ヒートマップ" が作成されます。 このヒートマップには、クラウドを使った階層化が有効になっている場所にあるすべての同期ファイルがヒート スコア順に一覧表示されています。 最近開いた頻繁にアクセスされるファイルはホットと見なされます。ほとんど開かれず、しばらくアクセスされていないファイルはクールと見なされます。 

このヒートマップ内の個々のファイルの相対位置を決めるため、システムでは、最終アクセス時刻、最終変更時刻、作成時刻の順に、これらのタイムスタンプの最大値が使用されます。 

通常、最終アクセス時刻が追跡され、使用できます。 ただし、クラウドを使った階層化が有効の状態で新しいサーバー エンドポイントが作成された場合は、ファイル アクセスを監視するのに十分な時間が経過していません。 有効な最終アクセス時刻がない場合は、ヒートマップ内の相対位置を評価するために最終変更時刻が使用されます。  

日付ポリシーも同じように動作します。 最終アクセス時刻がない場合、日付ポリシーは最終更新時刻に基づいて動作します。 この時刻がない場合は、ファイルの作成時刻にフォールバックします。 時間の経過と共に、システムが認識するファイル アクセス要求が増加すると、自己追跡した最終アクセス時刻が自動的に使用されるようになります。

> [!Note]
> クラウドの階層化では、最終アクセス時刻の追跡は NTFS 機能に依存せずに行われます。 この NTFS 機能は既定ではオフになっており、パフォーマンスに関する考慮事項により、この機能を手動で有効にすることはお勧めしません。 クラウドを使った階層化では、最終アクセス時刻が個別に追跡されます。

### <a name="sync-policies-that-affect-cloud-tiering"></a>クラウドを使った階層化に影響する同期ポリシー

Azure File Sync エージェント バージョン 11 では、クラウドを使った階層化に影響する 2 つの追加の Azure File Sync ポリシーとして、**初期ダウンロード** および **事前呼び戻し** を設定できます。

#### <a name="initial-download"></a>初期ダウンロード

サーバーがファイルを含む Azure ファイル共有に接続しているときに、サーバーがファイル共有データをどのように最初にダウンロードするかを決定できるようになりました。 クラウドを使った階層化が有効になっている場合は、オプションが 2 つあります。 

![クラウドを使った階層化が有効になっているときの初期ダウンロードのスクリーンショット](media/storage-sync-cloud-tiering-overview/cloud-tiering-overview-3.png)  

1 つ目のオプションは、最初に名前空間を呼び戻した後、ローカル ディスク容量に達するまで、最終変更時刻のタイムスタンプに基づいてファイル コンテンツを呼び戻すことです。 十分なディスク領域があり、最後に変更されたファイルがローカルにキャッシュされることがわかっている場合は、このオプションを選択することをお勧めします。 ディスク領域が不足しているためにローカルに保存できないファイルは階層化されます。        

2 つ目のオプションは、最初に名前空間のみを呼び戻し、アクセスされた場合にのみファイル コンテンツを呼び戻す方法です。 このオプションは、ローカル ディスクで使用される容量を最小限に抑え、ローカルにキャッシュするファイルをユーザーが決定できるようにする場合に最適です。 このオプションを使用すると、すべてのファイルは階層化されたファイルとして開始します。

![クラウドを使った階層化が無効になっているときの初期ダウンロードのスクリーンショット](media/storage-sync-cloud-tiering-overview/cloud-tiering-overview-4.png)

クラウドを使った階層化が無効になっている場合は、3 つ目のオプションがあります。これは、階層化されたファイルができないようにすることを目的としています。 この場合、ファイルは、完全にダウンロードされると、サーバーにのみ表示されます。 全ファイルを必要とするアプリケーションがあり、その名前空間で、階層化されたファイルが許可されない場合は、この方法が理想的です。      

#### <a name="proactive-recalling"></a>事前呼び戻し

ファイルが作成または変更される際、指定したサーバーにファイルを事前に呼び戻すことができます。 これにより、指定した各サーバーで、新しいファイルや変更したファイルをすぐに使用できるようになります。 

たとえば、世界各地に分散しているある企業が、米国とインドにブランチ オフィスを構えているとします。 朝 (米国時間)、インフォメーション ワーカーが新しいプロジェクト用の新しいフォルダーと新しいファイルを作成し、それらを使用して一日作業しました。 Azure File Sync によって、フォルダーとファイルが Azure ファイル共有 (クラウド エンドポイント) に同期されます。 インドにいるインフォメーション ワーカーは、インドのタイムゾーンでプロジェクトの作業を続行します。 彼らが朝に作業に取り掛かる際、インドにあるローカルの Azure File Sync 対応サーバーでは、インド チームが効率的にローカル キャッシュで作業できるように、これらの新しいファイルがローカルで利用できるようになっている必要があります。 このモードを有効にすることで、オンデマンドの呼び戻しによる最初のファイル アクセスが遅くなることを回避し、Azure ファイル共有でファイルが変更または作成されるとすぐにサーバーによって事前にファイルが呼び戻されるようになります。

サーバーに呼び戻されたファイルが実際にローカルで必要でない場合に、不要な呼び戻しを行うと、送信トラフィックとコストが増加する可能性があります。 そのため、事前呼び戻しの有効化は、クラウドの最近の変更をサーバー上のキャッシュに事前に保存しておくことが、そのサーバー上のファイルを使用しているユーザーやアプリケーションに有益であることがわかっている場合に行ってください。 

事前呼び戻しを有効にすると、サーバーの帯域幅の使用量が増加し、ローカル サーバー上の他の比較的新しいコンテンツが、呼び戻されたファイルの増加によって大幅に階層化される可能性もあります。 その結果、階層化されたファイルがサーバーによってホットと見なされ、より多くの呼び戻しが発生する可能性があります。 

:::image type="content" source="media/storage-sync-files-deployment-guide/proactive-download.png" alt-text="現在有効になっているサーバー エンドポイントにおける Azure ファイル共有のダウンロード動作と、それを変更するためのメニューを開くボタンを示す画像。":::

事前呼び戻しの詳細については、「[Azure File Sync のデプロイ](file-sync-deployment-guide.md#proactively-recall-new-and-changed-files-from-an-azure-file-share)」を参照してください。

## <a name="tiered-vs-locally-cached-file-behavior"></a>階層化されたファイルおよびローカルにキャッシュされたファイルの動作

クラウドを使った階層化とは、名前空間 (ファイルとフォルダーの階層、およびファイルのプロパティ) とファイル コンテンツを分離することです。 

#### <a name="tiered-file"></a>階層化されたファイル

階層化されたファイルでは、ファイルのコンテンツ自体がローカルに保存されていないため、ディスク上のサイズはゼロになります。 ファイルを階層化すると、Azure File Sync ファイル システム フィルター (StorageSync.sys) がローカルでファイルをポインター (再解析ポイント) と置き換えます。 再解析ポイントは Azure ファイル共有内のファイルへの URL を表します。 階層化されたファイルをサード パーティ アプリケーションで安全に識別できるように、階層化されたファイルには "オフライン" 属性と FILE_ATTRIBUTE_RECALL_ON_DATA_ACCESS 属性の両方が NTFS 内で設定されます。   

![階層化されたファイルのプロパティのスクリーンショット (名前空間のみ)。](media/storage-sync-cloud-tiering-overview/cloud-tiering-overview-2.png)    

#### <a name="locally-cached-file"></a>ローカルにキャッシュされたファイル

一方、オンプレミスのファイル サーバーに格納されているファイルの場合、ファイル全体 (ファイル属性とファイル コンテンツ) はローカルに保存されるため、ディスク上のサイズはファイルの論理サイズとほぼ同じになります。     

![階層化されていないファイルのプロパティのスクリーンショット (名前空間とファイル コンテンツ)。](media/storage-sync-cloud-tiering-overview/cloud-tiering-overview-1.png) 

また、ファイルが部分的に階層化される (または、部分的に再現される) 場合もあります。 部分的に階層化されたファイルでは、ファイルの一部がディスク上に存在します。 これは、ファイルへのストリーミング アクセスをサポートするマルチメディア プレーヤーや圧縮ユーティリティなどのアプリケーションによってファイルが部分的に読み取られた場合に発生する可能性があります。 Azure File Sync は、接続されている Azure ファイル共有からの要求された情報のみを呼び戻すスマートな機能です。

> [!NOTE]
> サイズは、ファイルの論理サイズを表します。 ディスク上のサイズは、ディスクに格納されているファイル ストリームの物理サイズを表します。

## <a name="next-steps"></a>次のステップ

* [Azure File Sync のクラウドを使った階層化ポリシーの選択](file-sync-choose-cloud-tiering-policies.md)
* [Azure File Sync のデプロイの計画](file-sync-planning.md)