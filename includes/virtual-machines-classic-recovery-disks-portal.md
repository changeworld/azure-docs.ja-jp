Azure の仮想マシン (VM) で起動エラーまたはディスク エラーが発生した場合、仮想ハード ディスク自体でのトラブルシューティング手順の実行が必要な場合があります。 一般的な例として、VM の正常な起動を妨げる失敗したアプリケーション更新が挙げられます。 この記事では、Azure Portal で仮想ハード ディスクを別の VM に接続してエラーを修正し、元の VM を再作成する方法について説明します。


## <a name="recovery-process-overview"></a>回復プロセスの概要
トラブルシューティングのプロセスは次のとおりです。

1. 問題が発生している VM を削除しますが、仮想ハード ディスクは保持します。
2. トラブルシューティングのために、仮想ハード ディスクを別の VM に接続してマウントします。
3. トラブルシューティング用 VM に接続します。 元の仮想ハード ディスクで、ファイルを編集するか、ツールを実行してエラーを解決します。
4. 仮想ハード ディスクのマウントを解除し、トラブルシューティング用 VM から切断します。
5. 元の仮想ハード ディスクを使用して VM を作成します。

## <a name="delete-the-original-vm"></a>元の VM を削除する
Azure では、仮想ハード ディスクと VM は 2 つの異なるリソースです。 仮想ハード ディスクには、オペレーティング システム、アプリケーション、構成が格納されています。 VM は、サイズや場所を定義し、仮想ハード ディスクや仮想ネットワーク インターフェイス カード (NIC) などのリソースを参照するメタデータにすぎません。 各仮想ハード ディスクには、そのディスクが VM に接続されるときにリースが割り当てられます。 データ ディスクは、VM の実行中でも接続および切断できますが、OS ディスクは、VM リソースを削除しない限り、切断することはできません。 VM が停止され、割り当てが解除された状態であっても、リースによって OS ディスクは引き続きその VM に関連付けられています。

VM を回復するには、まず VM リソース自体を削除します。 VM を削除しても、仮想ハード ディスクはストレージ アカウントに残されます。 VM を削除したら、仮想ハード ディスクを別の VM に接続してトラブルシューティングを行い、エラーを解決することができます。 

1. [Azure Portal](https://portal.azure.com) にサインインします。 
2. 左側のメニューで、**[仮想マシン (クラシック)]** をクリックします。
3. 問題のある VM を選択して、**[ディスク]** をクリックし、仮想ハード ディスクの名前を指定します。 
4. OS の仮想ハード ディスクを選択して、**[場所]** を確認し、その仮想ハード ディスクを含むストレージ アカウントを指定します。 次の例では、".blob.core.windows.net" の直前の文字列がストレージ アカウント名です。

    ```
    https://portalvhds73fmhrw5xkp43.blob.core.windows.net/vhds/SCCM2012-2015-08-28.vhd
    ```

    ![VM の場所に関するイメージ](./media/virtual-machines-classic-recovery-disks-portal/vm-location.png)

5. VM を右クリックしてから、**[削除]** を選択します。 VM を削除するときにディスクが選択されていないことをご確認ください。
6. 新しい復旧 VM を作成します。 この VM は、問題の VM と同じリージョンおよびリソース グループ (クラウド サービス) 内になければなりません。
7. 復旧 VM を選択してから、**[ディスク]** > **[既存のディスクの接続]** を選択します。
8. 既存の仮想ハード ディスクを選択するには、**[VHD ファイル]** をクリックします。

    ![既存の VHD を参照する](./media/virtual-machines-classic-recovery-disks-portal/select-vhd-location.png)

9. ストレージ アカウント、VHD コンテナー、仮想ハード ディスクの順に選択し、**[選択]** ボタンをクリックして選択内容を確認します。

    ![既存の VHD を選択する](./media/virtual-machines-classic-recovery-disks-portal/select-vhd.png)

10. VHD を選択したら、**[OK]** を選択して既存の仮想ハード ディスクを接続します。
11. 数秒後、VM の **[ディスク]** ウィンドウに、データ ディスクとして接続された既存の仮想ハード ディスクが表示されます。

    ![データ ディスクとして接続された既存の仮想ハード ディスク](./media/virtual-machines-classic-recovery-disks-portal/attached-disk.png)

## <a name="fix-issues-on-the-original-virtual-hard-disk"></a>元の仮想ハード ディスクで問題を修正する
既存の仮想ハード ディスクをマウントすると、必要に応じてメンテナンスやトラブルシューティングの手順を実行できるようになります。 問題に対処したら、次の手順に進みます。

## <a name="unmount-and-detach-the-original-virtual-hard-disk"></a>元の仮想ハード ディスクのマウントを解除して切断する
エラーが解決したら、トラブルシューティング用 VM から既存の仮想ハード ディスクのマウントを解除して切断します。 仮想ハード ディスクをトラブルシューティング用 VM に接続するリースを解放するまで、仮想ハード ディスクを他の VM と一緒に使用することはできません。  

1. [Azure Portal](https://portal.azure.com) にサインインします。 
2. 左側のメニューで、**[仮想マシン (クラシック)]** を選択します。
3. 復旧 VM を見つけます。 ディスクを選択して右クリックし、**[デタッチ]** を選択します。

## <a name="create-a-vm-from-the-original-hard-disk"></a>元のハード ディスクから VM を作成する

元の仮想ハード ディスクから VM を作成するには、[Azure Portal](https://portal.azure.com) を使用します。

1. [Azure ポータル](https://portal.azure.com)にサインインします。
2. ポータルの左上で、**[リソースの作成]** > **[Compute]** > **[仮想マシン]** > **[ギャラリーから]** を選択します。
3. **[イメージの選択]** セクションで、**[マイ ディスク]** を選択してから、元の仮想ハード ディスクを選択します。 場所の情報を確認します。 これは、VM をデプロイする必要があるリージョンです。 [次へ] ボタンを選択します。
4. **[仮想マシンの構成]** セクションで、VM 名を入力し、VM のサイズを選択します。
