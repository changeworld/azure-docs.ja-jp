---
author: ccompy
ms.service: app-service-web
ms.topic: include
ms.date: 10/21/2020
ms.author: ccompy
ms.openlocfilehash: a4eb22320a15cc76a7543c25583003d57ea4e538
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/20/2021
ms.locfileid: "102473867"
---
リージョン VNet 統合を使用すると、アプリは次のものにアクセスできるようになります。

* アプリと同じリージョンにある VNet 内のリソース。
* VNet 内のリソースは、アプリが統合されている VNet とピアリングされます。
* サービス エンドポイントでセキュリティ保護されたサービス。
* Azure ExpressRoute 接続にまたがるリソース。
* 統合されている VNet 内のリソース。
* Azure ExpressRoute 接続を含む、ピアリングされた接続にまたがるリソース。
* プライベート エンドポイント 

同じリージョンの VNet との VNet 統合を使用する場合は、次の Azure ネットワーク機能を使用できます。

* **ネットワーク セキュリティ グループ (NSG)** :統合サブネットに配置された NSG を使って送信トラフィックをブロックできます。 VNet 統合を使ってアプリへの受信アクセスを提供できないため、受信規則は適用されません。
* **ルート テーブル (UDR)** :統合サブネット上にルート テーブルを配置して、必要な場所に送信トラフィックを送信できます。

既定では、アプリでは RFC1918 トラフィックのみが VNet にルーティングされます。 すべての送信トラフィックを VNet にルーティングする場合は、アプリの設定 WEBSITE_VNET_ROUTE_ALL をアプリに適用します。 アプリ設定を構成するには、次のようにします。

1. アプリ ポータルの **[構成]** UI にアクセスします。 **[新しいアプリケーション設定]** を選択します。
1. **[名前]** ボックスに「**WEBSITE_VNET_ROUTE_ALL**」、 **[値]** ボックスに「**1**」と入力します。

   ![アプリケーション設定を指定する][4]

1. **[OK]** を選択します。
1. **[保存]** を選択します。

> [!NOTE]
> すべての送信トラフィックを VNet にルーティングする場合は、統合サブネットに適用されている NSG と UDR に従います。 すべての送信トラフィックを VNet にルーティングすると、トラフィックを他の場所に送信するためのルートを指定しない限り、送信アドレスは引き続きアプリのプロパティに一覧表示される送信アドレスになります。
> 
> リージョン VNet 統合では、ポート 25 を使用できません。

同じリージョンの VNet との VNet 統合を使用する場合、いくつかの制限があります。

* グローバル ピアリング接続にまたがるリソースには到達できません。
* この機能は、Premium V2 と Premium V3 のすべての App Service スケール ユニットから使用できます。 また、Standard でも使用できますが、新しい App Service のスケール ユニットからのみ利用できます。 以前のスケール ユニットを使用している場合は、Premium V2 App Service プランの機能のみを使用できます。 Standard App Service プランでこの機能を使用できるようにするには、Premium V3 App Service プランでアプリを作成します。 それらのプランは、最新のスケール ユニットでのみサポートされます。 その後、必要に応じてスケールダウンできます。  
* 統合サブネットは、1 つの App Service プランでしか使用できません。
* この機能は、App Service Environment にある Isolated プランのアプリでは使用できません。
* この機能には、Azure Resource Manager VNet 内に /28 以上の未使用のサブネットが必要です。
* アプリと VNet は同じリージョンに存在する必要があります。
* 統合アプリで VNet を削除することはできません。 VNet を削除する前に、統合を削除してください。
* App Service プランごとに 1 リージョンの VNet 統合のみを持つことができます。 同じ App Service プラン内の複数のアプリが同じ VNet を使用できます。
* リージョン VNet 統合を使用しているアプリがあるときに、アプリまたはプランのサブスクリプションを変更することはできません。
* アプリでは、構成を変更せずに Azure DNS Private Zones のアドレスを解決することはできません

VNet 統合は、専用サブネットの使用に依存します。  サブネットをプロビジョニングすると、Azure サブネットは先頭から 5 つの IP を失います。 プラン インスタンスごとに、統合サブネットから 1 つのアドレスが使用されます。 アプリを 4 つのインスタンスにスケールする場合は、4 つのアドレスが使用されます。 サブネット サイズからの 5 つのアドレスを借用するため、CIDR ブロックあたりの使用可能な最大アドレス数は次のようになります。

- /28 には 11 個のアドレスがあります
- /27 には 27 個のアドレスがあります
- /26 には 59 個のアドレスがあります

サイズをスケールアップまたはダウンする場合は、短時間の間アドレスのニーズを倍増させる必要があります。 サイズの制限は、サブネットが次のような場合に、サブネットのサイズごとにサポートされている実際に利用可能なインスタンスが次のようになることを意味します。

- /28: 水平方向の最大スケールは 5 インスタンス
- /27: 水平方向の最大スケールは 13 インスタンス
- /26 水平方向の最大スケールは 29 インスタンス

水平方向の最大スケールに関する制限は、ある時点でサイズまたは SKU のいずれかでスケールアップまたはスケールダウンする必要があることを前提としています。 

割り当てた後はサブネット サイズを変更できないため、アプリが到達する可能性のあるスケールに対応できるだけの十分な大きさを持つサブネットを使用してください。 サブネット容量に関する問題を回避するには、64 個のアドレスを持つ /26 が推奨されるサイズです。  

別のプラン内のご自身のアプリが、別のプラン内のアプリから既に接続されている VNet にアクセスできるようにしたい場合は、既存の VNet 統合によって使用されているものとは異なるサブネットを選択します。

この機能は、[カスタム コンテナー](../articles/app-service/quickstart-custom-container.md)を含め、Windows と Linux の両方のアプリで完全にサポートされています。 すべての動作は、Windows アプリと Linux アプリ間で同じです。

### <a name="service-endpoints"></a>サービス エンドポイント

リージョン VNet 統合では、サービス エンドポイントを使用できます。 アプリでサービス エンドポイントを使用するには、リージョン VNet 統合を使用し、選択した VNet に接続します。その後、統合に使用したサブネット上の対象のサービスを使用して、サービス エンドポイントを構成します。 さらに、サービス エンドポイント経由でサービスにアクセスする必要がある場合は、次のようにします。

1. Web アプリとのリージョン VNet 統合を構成する
1. 対象のサービスに移動し、統合に使用したサブネットに対してサービス エンドポイントを構成する

### <a name="network-security-groups"></a>ネットワーク セキュリティ グループ

ネットワーク セキュリティ グループを使用して、VNet 内のリソースへの受信および送信トラフィックをブロックできます。 リージョン VNet 統合を使用するアプリでは、[ネットワーク セキュリティ グループ][VNETnsg]を使用して、VNet またはインターネット内のリソースへの送信トラフィックをブロックできます。 パブリック アドレスへのトラフィックをブロックするには、WEBSITE_VNET_ROUTE_ALL アプリケーション設定を 1 に設定する必要があります。 VNet 統合はアプリからの送信トラフィックのみに影響を与えるため、NSG での受信規則はアプリに適用されません。

アプリへの受信トラフィックを制御するには、アクセス制限機能を使用します。 統合サブネットに適用される NSG は、統合サブネットに適用されているルートに関係なく有効になります。 WEBSITE_VNET_ROUTE_ALL が 1 に設定されていて、統合サブネット上でパブリック アドレス トラフィックに影響を与えるルートがない場合、すべての送信トラフィックは引き続き、統合サブネットに割り当てられた NSG に従います。 WEBSITE_VNET_ROUTE_ALL が設定されていない場合、NSG は RFC1918 トラフィックにのみ適用されます。

### <a name="routes"></a>ルート

ルート テーブルを使用して、アプリからの送信トラフィックを任意の場所にルーティングすることができます。 既定では、ルート テーブルは、RFC1918 の送信先トラフィックのみに影響を与えます。 WEBSITE_VNET_ROUTE_ALL を 1 に設定すると、すべての送信呼び出しが影響を受けます。 統合サブネット上に設定されているルートは、受信アプリ要求への応答には影響を与えません。 一般的な宛先には、ファイアウォール デバイスまたはゲートウェイを含めることができます。

オンプレミスのすべての送信トラフィックをルーティングする場合は、ルート テーブルを使用して、すべての送信トラフィックを ExpressRoute ゲートウェイに送信できます。 ゲートウェイにトラフィックをルーティングする場合は、外部ネットワークのルートを設定して、応答を返信するようにしてください。

また、Border Gateway Protocol (BGP) ルートも、アプリのトラフィックに影響を与えます。 ExpressRoute ゲートウェイのようなものから BGP ルートを使用している場合は、アプリの送信トラフィックが影響を受けます。 既定では、BGP ルートは、RFC1918 の送信先トラフィックにのみ影響を与えます。 WEBSITE_VNET_ROUTE_ALL が 1 に設定されている場合、すべての送信トラフィックは、BGP ルートの影響を受ける可能性があります。

### <a name="azure-dns-private-zones"></a>Azure DNS Private Zones 

アプリでは、VNet に統合された後、VNet が構成されているのと同じ DNS サーバーが使用されます。 既定では、アプリは Azure DNS Private Zones で動作しません。 Azure DNS Private Zones で動作させるには、次のアプリ設定を追加する必要があります。


1. 値が 168.63.129.16 の WEBSITE_DNS_SERVER
1. 値が 1 の WEBSITE_VNET_ROUTE_ALL


これらの設定では、アプリで Azure DNS Private Zones を使用できるようにするだけでなく、アプリからのすべての送信呼び出しを VNet に送信します。   これらの設定は、アプリから VNet へのすべての送信呼び出しを送信します。 さらに、ワーカー レベルでプライベート DNS ゾーンをクエリすることによって、アプリが Azure DNS を使用できるようにします。 この機能は、実行中のアプリがプライベート DNS ゾーンにアクセスしているときに使用されます。

> [!NOTE]
>プライベート DNS ゾーンを使用して Web アプリにカスタム ドメインを追加しようとしても、VNET 統合では実行できません。 カスタム ドメインの検証は、ワーカー レベルではなく、コントローラー レベルで実行されます。これにより、DNS レコードが表示されなくなります。 プライベート DNS ゾーンからカスタム ドメインを使用するには、Application Gateway または ILB App Service Environment を使用して検証をバイパスする必要があります。

### <a name="private-endpoints"></a>プライベート エンドポイント

[プライベート エンドポイント][privateendpoints]を呼び出す場合は、DNS 参照がプライベート エンドポイントに解決されるようにする必要があります。 アプリからの DNS 参照がプライベート エンドポイントを参照するようにするために、次の選択肢があります。

* Azure DNS Private Zones と統合する。 VNet にカスタム DNS サーバーがない場合、これは自動的に行われます
* アプリで使用される DNS サーバーでプライベート エンドポイントを管理する。 これを行うには、プライベート エンドポイント アドレスを把握し、到達しようとしているエンドポイントが A レコードでそのアドレスにポイントされるようにします。
* Azure DNS プライベート ゾーンに転送する独自の DNS サーバーを構成する

<!--Image references-->
[4]: ../includes/media/web-sites-integrate-with-vnet/vnetint-appsetting.png

<!--Links-->
[VNETnsg]: /azure/virtual-network/security-overview/
[privateendpoints]: ../articles/app-service/networking/private-endpoint.md
