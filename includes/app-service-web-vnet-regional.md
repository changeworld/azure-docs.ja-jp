---
author: ccompy
ms.service: app-service-web
ms.topic: include
ms.date: 04/15/2020
ms.author: ccompy
ms.openlocfilehash: f7208307df51ecefb76f9adaedea59b327cdc19e
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2020
ms.locfileid: "81604870"
---
リージョン VNet 統合を使用すると、アプリは次のものにアクセスできるようになります。

* アプリと同じリージョンにある VNet 内のリソース。
* VNet 内のリソースは、アプリが統合されている VNet とピアリングされます。
* サービス エンドポイントでセキュリティ保護されたサービス。
* Azure ExpressRoute 接続にまたがるリソース。
* 統合されている VNet 内のリソース。
* Azure ExpressRoute 接続を含む、ピアリングされた接続にまたがるリソース。
* プライベート エンドポイント 

同じリージョンの VNet との VNet 統合を使用する場合は、次の Azure ネットワーク機能を使用できます。

* **ネットワーク セキュリティ グループ (NSG)** :統合サブネットに配置された NSG を使って送信トラフィックをブロックできます。 VNet 統合を使ってアプリへの受信アクセスを提供できないため、受信規則は適用されません。
* **ルート テーブル (UDR)** :統合サブネット上にルート テーブルを配置して、必要な場所に送信トラフィックを送信できます。

既定では、アプリでは RFC1918 トラフィックのみが VNet にルーティングされます。 すべての送信トラフィックを VNet にルーティングする場合は、アプリの設定 WEBSITE_VNET_ROUTE_ALL をアプリに適用します。 アプリ設定を構成するには、次のようにします。

1. アプリ ポータルの **[構成]** UI にアクセスします。 **[新しいアプリケーション設定]** を選択します。
1. **[名前]** ボックスに「**WEBSITE_VNET_ROUTE_ALL**」、 **[値]** ボックスに「**1**」と入力します。

   ![アプリケーション設定を指定する][4]

1. **[OK]** を選択します。
1. **[保存]** を選択します。

すべての送信トラフィックを VNet にルーティングする場合は、統合サブネットに適用されている NSG と UDR に従います。 すべての送信トラフィックを VNet にルーティングすると、トラフィックを他の場所に送信するためのルートを指定しない限り、送信アドレスは引き続きアプリのプロパティに一覧表示される送信アドレスになります。

同じリージョンの VNet との VNet 統合を使用する場合、いくつかの制限があります。

* グローバル ピアリング接続にまたがるリソースには到達できません。
* この機能は、PremiumV2 の App Service プランをサポートするより新しい Azure App Service スケール ユニットからのみ使用できます。
* 統合サブネットは、1 つの App Service プランでしか使用できません。
* この機能は、App Service Environment にある Isolated プランのアプリでは使用できません。
* この機能には、Azure Resource Manager VNet 内に 32 個以上のアドレスを含む /27 である未使用のサブネットが必要です。
* アプリと VNet は同じリージョンに存在する必要があります。
* 統合アプリで VNet を削除することはできません。 VNet を削除する前に、統合を削除してください。
* アプリと同じサブスクリプション内の VNet とのみ統合できます。
* App Service プランごとに 1 リージョンの VNet 統合のみを持つことができます。 同じ App Service プラン内の複数のアプリが同じ VNet を使用できます。
* リージョン VNet 統合を使用しているアプリがあるときに、アプリまたはプランのサブスクリプションを変更することはできません。
* アプリでは、構成を変更せずに Azure DNS Private Zones のアドレスを解決することはできません

プランのインスタンスごとに 1 つのアドレスが使用されます。 アプリを 5 つのインスタンスにスケールする場合は、5 つのアドレスが使用されます。 割り当てた後はサブネット サイズを変更できないため、アプリが到達する可能性のあるスケールに対応できるだけの十分な大きさを持つサブネットを使用する必要があります。 推奨されるサイズは、64 のアドレスを持つ /26 です。 64 個のアドレスを持つ /26 では、Premium プランの 30 のインスタンスに対応できます。 プランをスケールアップまたはスケールダウンする場合は、短時間に 2 倍の数のアドレスが必要になります。

別のプラン内のご自身のアプリが、別のプラン内のアプリから既に接続されている VNet にアクセスできるようにしたい場合は、既存の VNet 統合によって使用されているものとは異なるサブネットを選択します。

この機能は、Linux ではプレビュー段階にあります。 Linux 形式の機能では、RFC 1918 アドレス (10.0.0.0/8、172.16.0.0/12、192.168.0.0/16) への呼び出しのみがサポートされます。

### <a name="web-or-function-app-for-containers"></a>Web App for Containers または Function App for Containers

Linux 上のアプリを組み込みイメージでホストする場合、リージョン VNet 統合は追加の変更なしで機能します。 Web App for Containers または Function App for Containers を使用している場合は、VNet 統合を使用するために docker イメージを変更する必要があります。 docker イメージでは、ハードコーディングされたポート番号を使用するのではなく、メイン Web サーバーのリスニング ポートとして PORT 環境変数を使用します。 PORT 環境変数は、コンテナーの起動時にプラットフォームによって自動的に設定されます。 SSH を使用する場合は、リージョン VNet 統合を使用するときに SSH_PORT 環境変数で指定されたポート番号でリッスンするように SSH デーモンを構成する必要があります。 Linux 上では、ゲートウェイが必要な VNet 統合はサポートされていません。

### <a name="service-endpoints"></a>サービス エンドポイント

リージョン VNet 統合では、サービス エンドポイントを使用できます。 アプリでサービス エンドポイントを使用するには、リージョン VNet 統合を使用し、選択した VNet に接続します。その後、統合に使用したサブネット上の対象のサービスを使用して、サービス エンドポイントを構成します。 さらに、サービス エンドポイント経由でサービスにアクセスする必要がある場合は、次のようにします。

1. Web アプリとのリージョン VNet 統合を構成する
1. 対象のサービスに移動し、統合に使用したサブネットに対してサービス エンドポイントを構成する

### <a name="network-security-groups"></a>ネットワーク セキュリティ グループ

ネットワーク セキュリティ グループを使用して、VNet 内のリソースへの受信および送信トラフィックをブロックできます。 リージョン VNet 統合を使用するアプリでは、[ネットワーク セキュリティ グループ][VNETnsg]を使用して、VNet またはインターネット内のリソースへの送信トラフィックをブロックできます。 パブリック アドレスへのトラフィックをブロックするには、WEBSITE_VNET_ROUTE_ALL アプリケーション設定を 1 に設定する必要があります。 VNet 統合はアプリからの送信トラフィックのみに影響を与えるため、NSG での受信規則はアプリに適用されません。

アプリへの受信トラフィックを制御するには、アクセス制限機能を使用します。 統合サブネットに適用される NSG は、統合サブネットに適用されているルートに関係なく有効になります。 WEBSITE_VNET_ROUTE_ALL が 1 に設定されていて、統合サブネット上でパブリック アドレス トラフィックに影響を与えるルートがない場合、すべての送信トラフィックは引き続き、統合サブネットに割り当てられた NSG に従います。 WEBSITE_VNET_ROUTE_ALL が設定されていない場合、NSG は RFC1918 トラフィックにのみ適用されます。

### <a name="routes"></a>ルート

ルート テーブルを使用して、アプリからの送信トラフィックを任意の場所にルーティングすることができます。 既定では、ルート テーブルは、RFC1918 の送信先トラフィックのみに影響を与えます。 WEBSITE_VNET_ROUTE_ALL を 1 に設定すると、すべての送信呼び出しが影響を受けます。 統合サブネット上に設定されているルートは、受信アプリ要求への応答には影響を与えません。 一般的な宛先には、ファイアウォール デバイスまたはゲートウェイを含めることができます。

オンプレミスのすべての送信トラフィックをルーティングする場合は、ルート テーブルを使用して、すべての送信トラフィックを ExpressRoute ゲートウェイに送信できます。 ゲートウェイにトラフィックをルーティングする場合は、外部ネットワークのルートを設定して、応答を返信するようにしてください。

また、Border Gateway Protocol (BGP) ルートも、アプリのトラフィックに影響を与えます。 ExpressRoute ゲートウェイのようなものから BGP ルートを使用している場合は、アプリの送信トラフィックが影響を受けます。 既定では、BGP ルートは、RFC1918 の送信先トラフィックにのみ影響を与えます。 WEBSITE_VNET_ROUTE_ALL が 1 に設定されている場合、すべての送信トラフィックは、BGP ルートの影響を受ける可能性があります。

### <a name="azure-dns-private-zones"></a>Azure DNS Private Zones 

アプリでは、VNet に統合された後、VNet が構成されているのと同じ DNS サーバーが使用されます。 既定では、アプリは Azure DNS Private Zones で動作しません。 Azure DNS Private Zones で動作させるには、次のアプリ設定を追加する必要があります。

1. 値が 168.63.129.16 の WEBSITE_DNS_SERVER 
1. 値が 1 の WEBSITE_VNET_ROUTE_ALL

これらの設定では、アプリで Azure DNS Private Zones を使用できるようにするだけでなく、アプリからのすべての送信呼び出しを VNet に送信します。

### <a name="private-endpoints"></a>プライベート エンドポイント

[プライベート エンドポイント][privateendpoints]を呼び出す場合は、Azure DNS Private Zones と統合するか、アプリで使用される DNS サーバーでプライベート エンドポイントを管理する必要があります。 

<!--Image references-->
[4]: ../includes/media/web-sites-integrate-with-vnet/vnetint-appsetting.png

<!--Links-->
[VNETnsg]: https://docs.microsoft.com/azure/virtual-network/security-overview/
[privateendpoints]: https://docs.microsoft.com/azure/app-service/networking/private-endpoint
